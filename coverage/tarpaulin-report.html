<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","aws.rs"],"content":"//! AWS S3/CloudFront deployment implementation\n\nuse anyhow::Result;\n\nuse super::{\n    config::DeployConfig,\n    environment::Environment,\n    status::{DeploymentLog, DeploymentStatus, ProgressTracker},\n    DeployOptions, DeployResult,\n};\n\n/// Deploy to AWS S3/CloudFront\npub async fn deploy(\n    _options: \u0026DeployOptions,\n    _config: \u0026DeployConfig,\n    _environment: \u0026Environment,\n) -\u003e Result\u003cDeployResult\u003e {\n    let mut tracker = ProgressTracker::new();\n    tracker.set_status(DeploymentStatus::Building);\n    \n    // TODO: Implement AWS deployment\n    // 1. Create/verify S3 bucket\n    // 2. Upload files to S3\n    // 3. Create/update CloudFront distribution\n    // 4. Invalidate CloudFront cache\n    \n    tracker.log(DeploymentLog::warning(\n        \"AWS deployment is not yet implemented. Coming soon!\"\n    ));\n    \n    Err(anyhow::anyhow!(\n        \"AWS deployment is not yet implemented. Use Vercel or Netlify for now.\"\n    ))\n}\n\n/// Get deployment status\npub async fn get_status(_deployment_id: \u0026str) -\u003e Result\u003cDeploymentStatus\u003e {\n    // TODO: Implement AWS deployment status check\n    Err(anyhow::anyhow!(\"AWS deployment status not implemented\"))\n}\n\n/// List recent deployments\npub async fn list_deployments(_limit: usize) -\u003e Result\u003cVec\u003cDeployResult\u003e\u003e {\n    // TODO: Implement AWS deployment listing\n    Ok(Vec::new())\n}\n\n/// Rollback deployment\npub async fn rollback(_deployment_id: \u0026str) -\u003e Result\u003c()\u003e {\n    // TODO: Implement AWS deployment rollback\n    Err(anyhow::anyhow!(\"AWS deployment rollback not implemented\"))\n}\n\n// AWS deployment implementation will include:\n// - S3 bucket creation and configuration\n// - Static website hosting setup\n// - CloudFront distribution management\n// - Route53 DNS integration (optional)\n// - CloudFormation or CDK support\n// - Cost estimation before deployment","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","cloudflare.rs"],"content":"//! Cloudflare Pages deployment implementation\n\nuse anyhow::Result;\n\nuse super::{\n    config::DeployConfig,\n    environment::Environment,\n    status::{DeploymentLog, DeploymentStatus, ProgressTracker},\n    DeployOptions, DeployResult,\n};\n\n/// Deploy to Cloudflare Pages\npub async fn deploy(\n    _options: \u0026DeployOptions,\n    _config: \u0026DeployConfig,\n    _environment: \u0026Environment,\n) -\u003e Result\u003cDeployResult\u003e {\n    let mut tracker = ProgressTracker::new();\n    tracker.set_status(DeploymentStatus::Building);\n    \n    // TODO: Implement Cloudflare Pages deployment\n    // 1. Create/verify Pages project\n    // 2. Upload files via Direct Upload API\n    // 3. Create deployment\n    // 4. Wait for deployment to complete\n    \n    tracker.log(DeploymentLog::warning(\n        \"Cloudflare Pages deployment is not yet implemented. Coming soon!\"\n    ));\n    \n    Err(anyhow::anyhow!(\n        \"Cloudflare Pages deployment is not yet implemented. Use Vercel or Netlify for now.\"\n    ))\n}\n\n/// Get deployment status\npub async fn get_status(_deployment_id: \u0026str) -\u003e Result\u003cDeploymentStatus\u003e {\n    // TODO: Implement Cloudflare deployment status check\n    Err(anyhow::anyhow!(\"Cloudflare deployment status not implemented\"))\n}\n\n/// List recent deployments\npub async fn list_deployments(_limit: usize) -\u003e Result\u003cVec\u003cDeployResult\u003e\u003e {\n    // TODO: Implement Cloudflare deployment listing\n    Ok(Vec::new())\n}\n\n/// Rollback deployment\npub async fn rollback(_deployment_id: \u0026str) -\u003e Result\u003c()\u003e {\n    // TODO: Implement Cloudflare deployment rollback\n    Err(anyhow::anyhow!(\"Cloudflare deployment rollback not implemented\"))\n}\n\n// Cloudflare Pages deployment implementation will include:\n// - Direct Upload API integration\n// - Build configuration management\n// - Custom domains and certificates\n// - Workers integration\n// - Analytics and Web Analytics\n// - Preview deployments","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","config.rs"],"content":"//! Deployment configuration\n\nuse anyhow::{Context, Result};\nuse serde::{Deserialize, Serialize};\nuse std::{collections::HashMap, fmt, path::{Path, PathBuf}};\n\n/// Supported deployment platforms\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum Platform {\n    Vercel,\n    Netlify,\n    #[serde(rename = \"aws\")]\n    AWS,\n    Cloudflare,\n}\n\nimpl fmt::Display for Platform {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        match self {\n            Platform::Vercel =\u003e write!(f, \"Vercel\"),\n            Platform::Netlify =\u003e write!(f, \"Netlify\"),\n            Platform::AWS =\u003e write!(f, \"AWS S3/CloudFront\"),\n            Platform::Cloudflare =\u003e write!(f, \"Cloudflare Pages\"),\n        }\n    }\n}\n\nimpl std::str::FromStr for Platform {\n    type Err = anyhow::Error;\n    \n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match s.to_lowercase().as_str() {\n            \"vercel\" =\u003e Ok(Platform::Vercel),\n            \"netlify\" =\u003e Ok(Platform::Netlify),\n            \"aws\" =\u003e Ok(Platform::AWS),\n            \"cloudflare\" =\u003e Ok(Platform::Cloudflare),\n            _ =\u003e Err(anyhow::anyhow!(\"Unknown platform: {}\", s)),\n        }\n    }\n}\n\n/// Deployment configuration\n#[derive(Debug, Deserialize, Serialize)]\npub struct DeployConfig {\n    /// Default deployment settings\n    pub deploy: DeploySettings,\n    \n    /// Platform-specific configurations\n    #[serde(default)]\n    pub platforms: HashMap\u003cString, PlatformConfig\u003e,\n    \n    /// Environment-specific settings\n    #[serde(default)]\n    pub environments: HashMap\u003cString, EnvironmentConfig\u003e,\n}\n\n/// General deployment settings\n#[derive(Debug, Deserialize, Serialize)]\npub struct DeploySettings {\n    /// Default platform\n    pub platform: Platform,\n    \n    /// Build output directory\n    #[serde(default = \"default_build_dir\")]\n    pub build_dir: String,\n    \n    /// Default environment\n    #[serde(default = \"default_environment\")]\n    pub environment: String,\n    \n    /// Project name (used for deployment naming)\n    pub project_name: Option\u003cString\u003e,\n    \n    /// Custom domain (if configured)\n    pub domain: Option\u003cString\u003e,\n    \n    /// Enable deployment notifications\n    #[serde(default)]\n    pub notifications: bool,\n}\n\n/// Platform-specific configuration\n#[derive(Debug, Deserialize, Serialize)]\npub struct PlatformConfig {\n    /// API token/key (usually from environment variable)\n    pub token: Option\u003cString\u003e,\n    \n    /// Team/Organization ID\n    pub team_id: Option\u003cString\u003e,\n    \n    /// Project ID (for existing projects)\n    pub project_id: Option\u003cString\u003e,\n    \n    /// Region (for AWS/Cloudflare)\n    pub region: Option\u003cString\u003e,\n    \n    /// Custom build command\n    pub build_command: Option\u003cString\u003e,\n    \n    /// Output directory override\n    pub output_directory: Option\u003cString\u003e,\n    \n    /// Framework preset\n    pub framework: Option\u003cString\u003e,\n    \n    /// Node.js version\n    pub node_version: Option\u003cString\u003e,\n    \n    /// Additional platform-specific settings\n    #[serde(flatten)]\n    pub extra: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Environment-specific configuration\n#[derive(Debug, Deserialize, Serialize)]\npub struct EnvironmentConfig {\n    /// Environment variables\n    #[serde(default)]\n    pub variables: HashMap\u003cString, String\u003e,\n    \n    /// Secret references (actual values from .env or external)\n    #[serde(default)]\n    pub secrets: Vec\u003cString\u003e,\n    \n    /// Custom domain for this environment\n    pub domain: Option\u003cString\u003e,\n    \n    /// Build command override\n    pub build_command: Option\u003cString\u003e,\n    \n    /// Deployment hooks\n    #[serde(default)]\n    pub hooks: DeploymentHooks,\n}\n\n/// Deployment lifecycle hooks\n#[derive(Debug, Default, Deserialize, Serialize)]\npub struct DeploymentHooks {\n    /// Command to run before build\n    pub pre_build: Option\u003cString\u003e,\n    \n    /// Command to run after build\n    pub post_build: Option\u003cString\u003e,\n    \n    /// Command to run after successful deployment\n    pub post_deploy: Option\u003cString\u003e,\n}\n\nimpl DeployConfig {\n    /// Load configuration from file\n    pub fn from_file(path: \u0026Path) -\u003e Result\u003cSelf\u003e {\n        let content = std::fs::read_to_string(path)\n            .with_context(|| format!(\"Failed to read config file: {:?}\", path))?;\n        \n        let config: Self = toml::from_str(\u0026content)\n            .with_context(|| format!(\"Failed to parse config file: {:?}\", path))?;\n        \n        Ok(config)\n    }\n    \n    /// Load configuration from project root\n    pub fn from_project_root() -\u003e Result\u003cSelf\u003e {\n        let paths = [\n            PathBuf::from(\"layer9.deploy.toml\"),\n            PathBuf::from(\".layer9/deploy.toml\"),\n            PathBuf::from(\"deploy.toml\"),\n        ];\n        \n        for path in \u0026paths {\n            if path.exists() {\n                return Self::from_file(path);\n            }\n        }\n        \n        // Return default configuration if no file found\n        Ok(Self::default())\n    }\n    \n    /// Get platform-specific configuration\n    pub fn platform_config(\u0026self, platform: Platform) -\u003e Option\u003c\u0026PlatformConfig\u003e {\n        let key = match platform {\n            Platform::Vercel =\u003e \"vercel\",\n            Platform::Netlify =\u003e \"netlify\",\n            Platform::AWS =\u003e \"aws\",\n            Platform::Cloudflare =\u003e \"cloudflare\",\n        };\n        self.platforms.get(key)\n    }\n    \n    /// Get environment-specific configuration\n    pub fn environment_config(\u0026self, env: \u0026str) -\u003e Option\u003c\u0026EnvironmentConfig\u003e {\n        self.environments.get(env)\n    }\n}\n\nimpl Default for DeployConfig {\n    fn default() -\u003e Self {\n        Self {\n            deploy: DeploySettings {\n                platform: Platform::Vercel,\n                build_dir: default_build_dir(),\n                environment: default_environment(),\n                project_name: None,\n                domain: None,\n                notifications: false,\n            },\n            platforms: HashMap::new(),\n            environments: HashMap::new(),\n        }\n    }\n}\n\nfn default_build_dir() -\u003e String {\n    \"dist\".to_string()\n}\n\nfn default_environment() -\u003e String {\n    \"production\".to_string()\n}\n\n/// Example configuration file content\npub const EXAMPLE_CONFIG: \u0026str = r#\"# Layer9 Deployment Configuration\n\n[deploy]\nplatform = \"vercel\"          # Default platform: vercel, netlify, aws, cloudflare\nbuild_dir = \"dist\"           # Build output directory\nenvironment = \"production\"   # Default environment\nproject_name = \"my-layer9-app\"\ndomain = \"example.com\"\n\n# Platform configurations\n[platforms.vercel]\ntoken = \"$VERCEL_TOKEN\"      # API token from environment variable\nteam_id = \"team_xxx\"         # Optional: Vercel team ID\nframework = \"vanilla\"        # Framework preset\nnode_version = \"18.x\"\n\n[platforms.netlify]\ntoken = \"$NETLIFY_TOKEN\"\nteam_id = \"netlify-team\"\n\n[platforms.aws]\ntoken = \"$AWS_ACCESS_KEY_ID\"\nregion = \"us-east-1\"\n# S3 bucket will be created as: {project_name}-{environment}\n\n[platforms.cloudflare]\ntoken = \"$CLOUDFLARE_API_TOKEN\"\naccount_id = \"your-account-id\"\n\n# Environment configurations\n[environments.production]\ndomain = \"app.example.com\"\n\n[environments.production.variables]\nAPI_URL = \"https://api.example.com\"\nPUBLIC_URL = \"https://app.example.com\"\n\n[environments.production.secrets]\nsecrets = [\"DATABASE_URL\", \"JWT_SECRET\", \"API_KEY\"]\n\n[environments.staging]\ndomain = \"staging.example.com\"\nbuild_command = \"layer9 build --mode staging\"\n\n[environments.staging.variables]\nAPI_URL = \"https://staging-api.example.com\"\nPUBLIC_URL = \"https://staging.example.com\"\nDEBUG = \"true\"\n\n[environments.preview]\n# Preview deployments get automatic URLs\n[environments.preview.variables]\nAPI_URL = \"https://preview-api.example.com\"\nDEBUG = \"true\"\n\n# Deployment hooks\n[environments.production.hooks]\npre_build = \"npm test\"\npost_deploy = \"curl -X POST https://api.example.com/deploy-webhook\"\n\"#;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","environment.rs"],"content":"//! Environment and secrets management\n\nuse anyhow::{Context, Result};\nuse std::{collections::HashMap, env, fs, path::Path};\n\nuse super::config::DeployConfig;\n\n/// Environment configuration for deployment\n#[derive(Debug, Clone)]\npub struct Environment {\n    /// Environment name (production, staging, etc.)\n    pub name: String,\n    \n    /// Environment variables\n    pub variables: HashMap\u003cString, String\u003e,\n    \n    /// Secrets (sensitive values)\n    pub secrets: Vec\u003cSecret\u003e,\n}\n\n/// Secret value\n#[derive(Debug, Clone)]\npub struct Secret {\n    /// Secret name/key\n    pub name: String,\n    \n    /// Secret value (encrypted in memory)\n    pub value: SecureString,\n}\n\n/// Secure string that doesn't expose value in debug output\n#[derive(Clone)]\npub struct SecureString(String);\n\nimpl std::fmt::Debug for SecureString {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(f, \"SecureString(***)\")\n    }\n}\n\nimpl SecureString {\n    pub fn new(value: String) -\u003e Self {\n        Self(value)\n    }\n    \n    pub fn expose(\u0026self) -\u003e \u0026str {\n        \u0026self.0\n    }\n}\n\nimpl Environment {\n    /// Load environment configuration\n    pub fn load(env_name: \u0026str, config: \u0026DeployConfig) -\u003e Result\u003cSelf\u003e {\n        let mut variables = HashMap::new();\n        let mut secrets = Vec::new();\n        \n        // Load from .env file if exists\n        let env_files = [\n            format!(\".env.{}\", env_name),\n            format!(\".env.{}.local\", env_name),\n            \".env\".to_string(),\n            \".env.local\".to_string(),\n        ];\n        \n        for env_file in \u0026env_files {\n            if Path::new(env_file).exists() {\n                load_env_file(env_file, \u0026mut variables)?;\n            }\n        }\n        \n        // Override with environment-specific config\n        if let Some(env_config) = config.environment_config(env_name) {\n            // Add configured variables\n            for (key, value) in \u0026env_config.variables {\n                variables.insert(key.clone(), value.clone());\n            }\n            \n            // Load secrets from environment or prompt\n            for secret_name in \u0026env_config.secrets {\n                let value = load_secret(secret_name)?;\n                secrets.push(Secret {\n                    name: secret_name.clone(),\n                    value: SecureString::new(value),\n                });\n            }\n        }\n        \n        // Add Layer9-specific variables\n        variables.insert(\"LAYER9_ENV\".to_string(), env_name.to_string());\n        variables.insert(\"NODE_ENV\".to_string(), \n            if env_name == \"production\" { \"production\" } else { \"development\" }.to_string()\n        );\n        \n        Ok(Self {\n            name: env_name.to_string(),\n            variables,\n            secrets,\n        })\n    }\n    \n    /// Get all environment variables as a map\n    pub fn to_env_map(\u0026self) -\u003e HashMap\u003cString, String\u003e {\n        let mut map = self.variables.clone();\n        \n        // Add secrets to the map\n        for secret in \u0026self.secrets {\n            map.insert(secret.name.clone(), secret.value.expose().to_string());\n        }\n        \n        map\n    }\n    \n    /// Validate that all required variables are set\n    pub fn validate(\u0026self, required: \u0026[\u0026str]) -\u003e Result\u003c()\u003e {\n        let env_map = self.to_env_map();\n        let mut missing = Vec::new();\n        \n        for var in required {\n            if !env_map.contains_key(*var) {\n                missing.push(*var);\n            }\n        }\n        \n        if !missing.is_empty() {\n            return Err(anyhow::anyhow!(\n                \"Missing required environment variables: {}\",\n                missing.join(\", \")\n            ));\n        }\n        \n        Ok(())\n    }\n}\n\n/// Load environment variables from a file\nfn load_env_file(path: \u0026str, variables: \u0026mut HashMap\u003cString, String\u003e) -\u003e Result\u003c()\u003e {\n    let content = fs::read_to_string(path)\n        .with_context(|| format!(\"Failed to read env file: {}\", path))?;\n    \n    for line in content.lines() {\n        let line = line.trim();\n        \n        // Skip empty lines and comments\n        if line.is_empty() || line.starts_with('#') {\n            continue;\n        }\n        \n        // Parse KEY=VALUE format\n        if let Some((key, value)) = line.split_once('=') {\n            let key = key.trim();\n            let value = value.trim();\n            \n            // Remove quotes if present\n            let value = if (value.starts_with('\"') \u0026\u0026 value.ends_with('\"'))\n                || (value.starts_with('\\'') \u0026\u0026 value.ends_with('\\'')) {\n                \u0026value[1..value.len()-1]\n            } else {\n                value\n            };\n            \n            // Expand environment variables in value\n            let expanded = expand_env_vars(value);\n            variables.insert(key.to_string(), expanded);\n        }\n    }\n    \n    Ok(())\n}\n\n/// Load a secret value from environment or prompt user\nfn load_secret(name: \u0026str) -\u003e Result\u003cString\u003e {\n    // First try environment variable\n    if let Ok(value) = env::var(name) {\n        return Ok(value);\n    }\n    \n    // Try with common prefixes\n    for prefix in \u0026[\"LAYER9_\", \"DEPLOY_\", \"\"] {\n        let var_name = format!(\"{}{}\", prefix, name);\n        if let Ok(value) = env::var(\u0026var_name) {\n            return Ok(value);\n        }\n    }\n    \n    // If not found, prompt user (only in interactive mode)\n    if atty::is(atty::Stream::Stdin) {\n        use dialoguer::Password;\n        \n        let value = Password::new()\n            .with_prompt(format!(\"Enter value for {} (hidden)\", name))\n            .interact()?;\n        \n        Ok(value)\n    } else {\n        Err(anyhow::anyhow!(\n            \"Secret '{}' not found in environment. Set {} or run in interactive mode.\",\n            name, name\n        ))\n    }\n}\n\n/// Expand environment variables in a string\nfn expand_env_vars(value: \u0026str) -\u003e String {\n    let mut result = value.to_string();\n    \n    // Find all ${VAR} or $VAR patterns\n    let re = regex::Regex::new(r\"\\$\\{([^}]+)\\}|\\$([A-Za-z_][A-Za-z0-9_]*)\").unwrap();\n    \n    for cap in re.captures_iter(value) {\n        let var_name = cap.get(1).or(cap.get(2)).unwrap().as_str();\n        if let Ok(var_value) = env::var(var_name) {\n            let pattern = cap.get(0).unwrap().as_str();\n            result = result.replace(pattern, \u0026var_value);\n        }\n    }\n    \n    result\n}\n\n/// Generate .env.example file from current configuration\npub fn generate_env_example(config: \u0026DeployConfig) -\u003e Result\u003cString\u003e {\n    let mut lines = vec![\n        \"# Layer9 Environment Variables\".to_string(),\n        \"# Copy this file to .env and fill in the values\".to_string(),\n        \"\".to_string(),\n    ];\n    \n    // Platform tokens\n    lines.push(\"# Platform API Tokens\".to_string());\n    if config.platforms.contains_key(\"vercel\") {\n        lines.push(\"VERCEL_TOKEN=\".to_string());\n    }\n    if config.platforms.contains_key(\"netlify\") {\n        lines.push(\"NETLIFY_TOKEN=\".to_string());\n    }\n    if config.platforms.contains_key(\"aws\") {\n        lines.push(\"AWS_ACCESS_KEY_ID=\".to_string());\n        lines.push(\"AWS_SECRET_ACCESS_KEY=\".to_string());\n    }\n    if config.platforms.contains_key(\"cloudflare\") {\n        lines.push(\"CLOUDFLARE_API_TOKEN=\".to_string());\n    }\n    lines.push(\"\".to_string());\n    \n    // Environment-specific variables\n    for (env_name, env_config) in \u0026config.environments {\n        lines.push(format!(\"# {} Environment\", env_name));\n        \n        // Variables\n        for key in env_config.variables.keys() {\n            lines.push(format!(\"{}=\", key));\n        }\n        \n        // Secrets\n        for secret in \u0026env_config.secrets {\n            lines.push(format!(\"{}=\", secret));\n        }\n        \n        lines.push(\"\".to_string());\n    }\n    \n    Ok(lines.join(\"\\n\"))\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","mod.rs"],"content":"//! Layer9 Deployment System\n//! \n//! Provides a unified deployment interface for multiple platforms without\n//! requiring external CLI tools. Uses platform APIs directly for deployment.\n\npub mod config;\npub mod vercel;\npub mod netlify;\npub mod aws;\npub mod cloudflare;\npub mod environment;\npub mod status;\n\nuse anyhow::Result;\nuse colored::*;\nuse std::path::PathBuf;\n\npub use config::{DeployConfig, Platform};\npub use environment::Environment;\npub use status::{DeploymentStatus, DeploymentLog};\n\n/// Deployment options\npub struct DeployOptions {\n    /// Target platform\n    pub platform: Platform,\n    /// Build output directory\n    pub build_dir: PathBuf,\n    /// Environment (production, staging, preview)\n    pub environment: String,\n    /// Configuration file path\n    pub config_path: Option\u003cPathBuf\u003e,\n    /// Force deployment without confirmation\n    pub force: bool,\n    /// Show deployment logs\n    pub verbose: bool,\n}\n\n/// Deployment result\npub struct DeployResult {\n    /// Deployment ID\n    pub deployment_id: String,\n    /// Deployment URL\n    pub url: String,\n    /// Preview URL (if available)\n    pub preview_url: Option\u003cString\u003e,\n    /// Deployment status\n    pub status: DeploymentStatus,\n    /// Build logs\n    pub logs: Vec\u003cDeploymentLog\u003e,\n}\n\n/// Deploy to the specified platform\npub async fn deploy(options: DeployOptions) -\u003e Result\u003cDeployResult\u003e {\n    println!(\"{}\", \"🚀 Starting deployment...\".bright_blue().bold());\n    \n    // Load deployment configuration\n    let config = if let Some(path) = \u0026options.config_path {\n        DeployConfig::from_file(path)?\n    } else {\n        DeployConfig::from_project_root()?\n    };\n    \n    // Validate build directory\n    if !options.build_dir.exists() {\n        return Err(anyhow::anyhow!(\n            \"Build directory not found: {:?}. Run 'layer9 build' first.\",\n            options.build_dir\n        ));\n    }\n    \n    // Load environment variables and secrets\n    let env = Environment::load(\u0026options.environment, \u0026config)?;\n    \n    // Confirm deployment (unless forced)\n    if !options.force {\n        println!(\"\\n{}\", \"📋 Deployment Summary:\".yellow().bold());\n        println!(\"  Platform:    {}\", options.platform);\n        println!(\"  Environment: {}\", options.environment);\n        println!(\"  Build dir:   {:?}\", options.build_dir);\n        println!(\"  Variables:   {} defined\", env.variables.len());\n        println!(\"  Secrets:     {} configured\", env.secrets.len());\n        \n        if !confirm_deployment()? {\n            println!(\"{}\", \"❌ Deployment cancelled\".red());\n            return Err(anyhow::anyhow!(\"Deployment cancelled by user\"));\n        }\n    }\n    \n    // Deploy to the selected platform\n    let result = match options.platform {\n        Platform::Vercel =\u003e vercel::deploy(\u0026options, \u0026config, \u0026env).await?,\n        Platform::Netlify =\u003e netlify::deploy(\u0026options, \u0026config, \u0026env).await?,\n        Platform::AWS =\u003e aws::deploy(\u0026options, \u0026config, \u0026env).await?,\n        Platform::Cloudflare =\u003e cloudflare::deploy(\u0026options, \u0026config, \u0026env).await?,\n    };\n    \n    // Show deployment result\n    println!(\"\\n{}\", \"✅ Deployment successful!\".green().bold());\n    println!(\"  URL:         {}\", result.url.bright_cyan());\n    if let Some(preview) = \u0026result.preview_url {\n        println!(\"  Preview:     {}\", preview.bright_cyan());\n    }\n    println!(\"  ID:          {}\", result.deployment_id.bright_black());\n    \n    Ok(result)\n}\n\n/// Get deployment status\npub async fn get_status(platform: Platform, deployment_id: \u0026str) -\u003e Result\u003cDeploymentStatus\u003e {\n    match platform {\n        Platform::Vercel =\u003e vercel::get_status(deployment_id).await,\n        Platform::Netlify =\u003e netlify::get_status(deployment_id).await,\n        Platform::AWS =\u003e aws::get_status(deployment_id).await,\n        Platform::Cloudflare =\u003e cloudflare::get_status(deployment_id).await,\n    }\n}\n\n/// List recent deployments\npub async fn list_deployments(platform: Platform, limit: usize) -\u003e Result\u003cVec\u003cDeployResult\u003e\u003e {\n    match platform {\n        Platform::Vercel =\u003e vercel::list_deployments(limit).await,\n        Platform::Netlify =\u003e netlify::list_deployments(limit).await,\n        Platform::AWS =\u003e aws::list_deployments(limit).await,\n        Platform::Cloudflare =\u003e cloudflare::list_deployments(limit).await,\n    }\n}\n\n/// Rollback to a previous deployment\npub async fn rollback(platform: Platform, deployment_id: \u0026str) -\u003e Result\u003c()\u003e {\n    println!(\"{}\", \"⏪ Rolling back deployment...\".yellow().bold());\n    \n    match platform {\n        Platform::Vercel =\u003e vercel::rollback(deployment_id).await?,\n        Platform::Netlify =\u003e netlify::rollback(deployment_id).await?,\n        Platform::AWS =\u003e aws::rollback(deployment_id).await?,\n        Platform::Cloudflare =\u003e cloudflare::rollback(deployment_id).await?,\n    }\n    \n    println!(\"{}\", \"✅ Rollback complete!\".green().bold());\n    Ok(())\n}\n\n/// Confirm deployment with user\nfn confirm_deployment() -\u003e Result\u003cbool\u003e {\n    use dialoguer::Confirm;\n    \n    Ok(Confirm::new()\n        .with_prompt(\"Continue with deployment?\")\n        .default(true)\n        .interact()?)\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","netlify.rs"],"content":"//! Netlify deployment implementation\n\nuse anyhow::{Context, Result};\nuse reqwest::Client;\nuse serde::{Deserialize, Serialize};\nuse std::{collections::HashMap, path::Path};\nuse tokio::fs;\n\nuse super::{\n    config::{DeployConfig, PlatformConfig},\n    environment::Environment,\n    status::{DeploymentLog, DeploymentStatus, ProgressTracker},\n    DeployOptions, DeployResult,\n};\n\nconst NETLIFY_API_URL: \u0026str = \"https://api.netlify.com/api/v1\";\n\n/// Netlify deployment configuration\nstruct NetlifyDeployment\u003c'a\u003e {\n    client: Client,\n    token: String,\n    options: \u0026'a DeployOptions,\n    config: \u0026'a DeployConfig,\n    platform_config: Option\u003c\u0026'a PlatformConfig\u003e,\n    environment: \u0026'a Environment,\n    tracker: ProgressTracker,\n}\n\n/// Deploy to Netlify\npub async fn deploy(\n    options: \u0026DeployOptions,\n    config: \u0026DeployConfig,\n    environment: \u0026Environment,\n) -\u003e Result\u003cDeployResult\u003e {\n    let mut deployment = NetlifyDeployment::new(options, config, environment)?;\n    deployment.execute().await\n}\n\n/// Get deployment status\npub async fn get_status(deployment_id: \u0026str) -\u003e Result\u003cDeploymentStatus\u003e {\n    let token = std::env::var(\"NETLIFY_TOKEN\")\n        .context(\"NETLIFY_TOKEN environment variable not set\")?;\n    \n    let client = Client::new();\n    let url = format!(\"{}/deploys/{}\", NETLIFY_API_URL, deployment_id);\n    \n    let response = client\n        .get(\u0026url)\n        .bearer_auth(\u0026token)\n        .send()\n        .await?;\n    \n    if !response.status().is_success() {\n        return Err(anyhow::anyhow!(\"Failed to get deployment status\"));\n    }\n    \n    let deploy: NetlifyDeploy = response.json().await?;\n    Ok(deploy.state.into())\n}\n\n/// List recent deployments\npub async fn list_deployments(limit: usize) -\u003e Result\u003cVec\u003cDeployResult\u003e\u003e {\n    let token = std::env::var(\"NETLIFY_TOKEN\")\n        .context(\"NETLIFY_TOKEN environment variable not set\")?;\n    \n    let client = Client::new();\n    let url = format!(\"{}/sites?per_page={}\", NETLIFY_API_URL, limit);\n    \n    let response = client\n        .get(\u0026url)\n        .bearer_auth(\u0026token)\n        .send()\n        .await?;\n    \n    if !response.status().is_success() {\n        return Err(anyhow::anyhow!(\"Failed to list sites\"));\n    }\n    \n    let sites: Vec\u003cNetlifySite\u003e = response.json().await?;\n    let mut results = Vec::new();\n    \n    // Get latest deploy for each site\n    for site in sites {\n        if let Some(deploy_url) = site.deploy_url {\n            results.push(DeployResult {\n                deployment_id: site.id,\n                url: site.url,\n                preview_url: Some(deploy_url),\n                status: DeploymentStatus::Ready,\n                logs: vec![],\n            });\n        }\n    }\n    \n    Ok(results)\n}\n\n/// Rollback deployment\npub async fn rollback(deployment_id: \u0026str) -\u003e Result\u003c()\u003e {\n    let token = std::env::var(\"NETLIFY_TOKEN\")\n        .context(\"NETLIFY_TOKEN environment variable not set\")?;\n    \n    let client = Client::new();\n    let url = format!(\"{}/deploys/{}/restore\", NETLIFY_API_URL, deployment_id);\n    \n    let response = client\n        .post(\u0026url)\n        .bearer_auth(\u0026token)\n        .send()\n        .await?;\n    \n    if !response.status().is_success() {\n        return Err(anyhow::anyhow!(\"Failed to rollback deployment\"));\n    }\n    \n    Ok(())\n}\n\nimpl\u003c'a\u003e NetlifyDeployment\u003c'a\u003e {\n    fn new(\n        options: \u0026'a DeployOptions,\n        config: \u0026'a DeployConfig,\n        environment: \u0026'a Environment,\n    ) -\u003e Result\u003cSelf\u003e {\n        // Get API token\n        let platform_config = config.platform_config(super::Platform::Netlify);\n        let token = if let Some(pc) = platform_config {\n            if let Some(token) = \u0026pc.token {\n                if token.starts_with('$') {\n                    std::env::var(\u0026token[1..])\n                        .with_context(|| format!(\"Environment variable {} not set\", \u0026token[1..]))?\n                } else {\n                    token.clone()\n                }\n            } else {\n                std::env::var(\"NETLIFY_TOKEN\")\n                    .context(\"NETLIFY_TOKEN environment variable not set\")?\n            }\n        } else {\n            std::env::var(\"NETLIFY_TOKEN\")\n                .context(\"NETLIFY_TOKEN environment variable not set\")?\n        };\n        \n        let client = Client::new();\n        \n        Ok(Self {\n            client,\n            token,\n            options,\n            config,\n            platform_config,\n            environment,\n            tracker: ProgressTracker::new(),\n        })\n    }\n    \n    async fn execute(\u0026mut self) -\u003e Result\u003cDeployResult\u003e {\n        self.tracker.set_status(DeploymentStatus::Building);\n        \n        // Create or get site\n        let site = self.get_or_create_site().await?;\n        \n        // Create deployment\n        let deploy = self.create_deployment(\u0026site).await?;\n        \n        // Upload files\n        self.tracker.log(DeploymentLog::info(\"Uploading files...\"));\n        self.upload_files(\u0026deploy).await?;\n        \n        // Finalize deployment\n        self.tracker.set_status(DeploymentStatus::Deploying);\n        let final_deploy = self.finalize_deployment(\u0026deploy).await?;\n        \n        Ok(DeployResult {\n            deployment_id: final_deploy.id,\n            url: final_deploy.ssl_url.unwrap_or(final_deploy.url),\n            preview_url: final_deploy.deploy_ssl_url.or(final_deploy.deploy_url),\n            status: final_deploy.state.into(),\n            logs: self.tracker.logs().to_vec(),\n        })\n    }\n    \n    async fn get_or_create_site(\u0026mut self) -\u003e Result\u003cNetlifySite\u003e {\n        let site_name = self.config.deploy.project_name.clone()\n            .unwrap_or_else(|| \"layer9-app\".to_string());\n        \n        // Try to get existing site\n        let url = format!(\"{}/sites\", NETLIFY_API_URL);\n        let response = self.client\n            .get(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .send()\n            .await?;\n        \n        if response.status().is_success() {\n            let sites: Vec\u003cNetlifySite\u003e = response.json().await?;\n            if let Some(site) = sites.into_iter().find(|s| s.name == site_name) {\n                self.tracker.log(DeploymentLog::info(format!(\n                    \"Using existing site: {}\",\n                    site.name\n                )));\n                return Ok(site);\n            }\n        }\n        \n        // Create new site\n        self.tracker.log(DeploymentLog::info(\"Creating new Netlify site...\"));\n        \n        let create_request = NetlifySiteCreate {\n            name: site_name.clone(),\n            custom_domain: self.config.deploy.domain.clone(),\n            env: self.build_env_vars(),\n        };\n        \n        let response = self.client\n            .post(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .json(\u0026create_request)\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            let error_text = response.text().await?;\n            return Err(anyhow::anyhow!(\"Failed to create site: {}\", error_text));\n        }\n        \n        let site: NetlifySite = response.json().await?;\n        self.tracker.log(DeploymentLog::info(format!(\n            \"Created site: {}\",\n            site.name\n        )));\n        \n        Ok(site)\n    }\n    \n    async fn create_deployment(\u0026mut self, site: \u0026NetlifySite) -\u003e Result\u003cNetlifyDeploy\u003e {\n        self.tracker.log(DeploymentLog::info(\"Creating deployment...\"));\n        \n        let url = format!(\"{}/sites/{}/deploys\", NETLIFY_API_URL, site.id);\n        \n        let create_request = NetlifyDeployCreate {\n            draft: true, // We'll upload files then finalize\n            title: format!(\"Layer9 deployment - {}\", self.environment.name),\n        };\n        \n        let response = self.client\n            .post(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .json(\u0026create_request)\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            let error_text = response.text().await?;\n            return Err(anyhow::anyhow!(\"Failed to create deployment: {}\", error_text));\n        }\n        \n        let deploy: NetlifyDeploy = response.json().await?;\n        self.tracker.log(DeploymentLog::info(format!(\n            \"Created deployment: {}\",\n            deploy.id\n        )));\n        \n        Ok(deploy)\n    }\n    \n    async fn upload_files(\u0026mut self, deploy: \u0026NetlifyDeploy) -\u003e Result\u003c()\u003e {\n        // Get list of files to upload\n        let files = self.collect_files().await?;\n        self.tracker.log(DeploymentLog::info(format!(\n            \"Found {} files to upload\",\n            files.len()\n        )));\n        \n        // Create file manifest\n        let mut file_manifest = HashMap::new();\n        for file in \u0026files {\n            let hash = sha256_hash(\u0026file.content);\n            file_manifest.insert(file.path.clone(), hash);\n        }\n        \n        // Submit file manifest\n        let url = format!(\"{}/deploys/{}/files\", NETLIFY_API_URL, deploy.id);\n        let response = self.client\n            .put(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .json(\u0026NetlifyFileManifest {\n                files: file_manifest.clone(),\n            })\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            let error_text = response.text().await?;\n            return Err(anyhow::anyhow!(\"Failed to submit file manifest: {}\", error_text));\n        }\n        \n        let required: NetlifyRequiredFiles = response.json().await?;\n        \n        // Upload required files\n        for hash in required.required {\n            if let Some(file) = files.iter().find(|f| sha256_hash(\u0026f.content) == hash) {\n                self.upload_file(\u0026deploy.id, \u0026file.path, \u0026file.content).await?;\n            }\n        }\n        \n        Ok(())\n    }\n    \n    async fn upload_file(\u0026self, deploy_id: \u0026str, path: \u0026str, content: \u0026[u8]) -\u003e Result\u003c()\u003e {\n        let url = format!(\"{}/deploys/{}/files/{}\", NETLIFY_API_URL, deploy_id, path);\n        \n        let response = self.client\n            .put(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .header(\"Content-Type\", \"application/octet-stream\")\n            .body(content.to_vec())\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            return Err(anyhow::anyhow!(\"Failed to upload file: {}\", path));\n        }\n        \n        Ok(())\n    }\n    \n    async fn collect_files(\u0026self) -\u003e Result\u003cVec\u003cFileInfo\u003e\u003e {\n        let mut files = Vec::new();\n        let build_dir = \u0026self.options.build_dir;\n        \n        // Walk directory and collect files\n        self.collect_files_recursive(build_dir, build_dir, \u0026mut files).await?;\n        \n        Ok(files)\n    }\n    \n    async fn collect_files_recursive(\n        \u0026self,\n        base_dir: \u0026Path,\n        dir: \u0026Path,\n        files: \u0026mut Vec\u003cFileInfo\u003e,\n    ) -\u003e Result\u003c()\u003e {\n        let mut entries = fs::read_dir(dir).await?;\n        \n        while let Some(entry) = entries.next_entry().await? {\n            let path = entry.path();\n            let metadata = entry.metadata().await?;\n            \n            if metadata.is_file() {\n                let relative_path = path.strip_prefix(base_dir)?;\n                let content = fs::read(\u0026path).await?;\n                \n                files.push(FileInfo {\n                    path: relative_path.to_string_lossy().to_string(),\n                    content,\n                });\n            } else if metadata.is_dir() {\n                Box::pin(self.collect_files_recursive(base_dir, \u0026path, files)).await?;\n            }\n        }\n        \n        Ok(())\n    }\n    \n    async fn finalize_deployment(\u0026mut self, deploy: \u0026NetlifyDeploy) -\u003e Result\u003cNetlifyDeploy\u003e {\n        self.tracker.log(DeploymentLog::info(\"Finalizing deployment...\"));\n        \n        // Update deploy to publish\n        let url = format!(\"{}/sites/{}/deploys/{}\", NETLIFY_API_URL, deploy.site_id, deploy.id);\n        \n        let response = self.client\n            .post(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            let error_text = response.text().await?;\n            return Err(anyhow::anyhow!(\"Failed to finalize deployment: {}\", error_text));\n        }\n        \n        // Wait for deployment to be ready\n        self.wait_for_ready(\u0026deploy.id).await\n    }\n    \n    async fn wait_for_ready(\u0026mut self, deploy_id: \u0026str) -\u003e Result\u003cNetlifyDeploy\u003e {\n        let mut attempt = 0;\n        let max_attempts = 300; // 5 minutes with 1 second intervals\n        \n        loop {\n            attempt += 1;\n            if attempt \u003e max_attempts {\n                return Err(anyhow::anyhow!(\"Deployment timeout\"));\n            }\n            \n            // Get deployment status\n            let url = format!(\"{}/deploys/{}\", NETLIFY_API_URL, deploy_id);\n            let response = self.client\n                .get(\u0026url)\n                .bearer_auth(\u0026self.token)\n                .send()\n                .await?;\n            \n            if !response.status().is_success() {\n                return Err(anyhow::anyhow!(\"Failed to get deployment status\"));\n            }\n            \n            let deploy: NetlifyDeploy = response.json().await?;\n            let status: DeploymentStatus = deploy.state.clone().into();\n            \n            if status != self.tracker.status().clone() {\n                self.tracker.set_status(status.clone());\n            }\n            \n            if status.is_complete() {\n                return Ok(deploy);\n            }\n            \n            // Wait before next check\n            tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;\n        }\n    }\n    \n    fn build_env_vars(\u0026self) -\u003e HashMap\u003cString, String\u003e {\n        self.environment.to_env_map()\n    }\n}\n\n/// File information\nstruct FileInfo {\n    path: String,\n    content: Vec\u003cu8\u003e,\n}\n\n/// Netlify API types\n#[derive(Debug, Serialize)]\nstruct NetlifySiteCreate {\n    name: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    custom_domain: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"HashMap::is_empty\")]\n    env: HashMap\u003cString, String\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct NetlifySite {\n    id: String,\n    name: String,\n    url: String,\n    #[serde(default)]\n    deploy_url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\nstruct NetlifyDeployCreate {\n    draft: bool,\n    title: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct NetlifyDeploy {\n    id: String,\n    site_id: String,\n    state: NetlifyDeployState,\n    url: String,\n    #[serde(default)]\n    ssl_url: Option\u003cString\u003e,\n    #[serde(default)]\n    deploy_url: Option\u003cString\u003e,\n    #[serde(default)]\n    deploy_ssl_url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\nenum NetlifyDeployState {\n    New,\n    Building,\n    Processing,\n    Ready,\n    Error,\n}\n\nimpl From\u003cNetlifyDeployState\u003e for DeploymentStatus {\n    fn from(state: NetlifyDeployState) -\u003e Self {\n        match state {\n            NetlifyDeployState::New =\u003e DeploymentStatus::Queued,\n            NetlifyDeployState::Building =\u003e DeploymentStatus::Building,\n            NetlifyDeployState::Processing =\u003e DeploymentStatus::Deploying,\n            NetlifyDeployState::Ready =\u003e DeploymentStatus::Ready,\n            NetlifyDeployState::Error =\u003e DeploymentStatus::Failed,\n        }\n    }\n}\n\n#[derive(Debug, Serialize)]\nstruct NetlifyFileManifest {\n    files: HashMap\u003cString, String\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct NetlifyRequiredFiles {\n    required: Vec\u003cString\u003e,\n}\n\n/// Calculate SHA-256 hash of content\nfn sha256_hash(content: \u0026[u8]) -\u003e String {\n    use sha2::{Sha256, Digest};\n    let mut hasher = Sha256::new();\n    hasher.update(content);\n    format!(\"{:x}\", hasher.finalize())\n}","traces":[{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":166},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","status.rs"],"content":"//! Deployment status tracking\n\nuse chrono::{DateTime, Utc};\nuse colored::*;\nuse serde::{Deserialize, Serialize};\nuse std::fmt;\n\n/// Deployment status\n#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum DeploymentStatus {\n    /// Deployment is queued\n    Queued,\n    /// Build is in progress\n    Building,\n    /// Deployment is in progress\n    Deploying,\n    /// Deployment completed successfully\n    Ready,\n    /// Deployment failed\n    Failed,\n    /// Deployment was cancelled\n    Cancelled,\n}\n\nimpl DeploymentStatus {\n    /// Check if deployment is complete (success or failure)\n    pub fn is_complete(\u0026self) -\u003e bool {\n        matches!(self, Self::Ready | Self::Failed | Self::Cancelled)\n    }\n    \n    /// Check if deployment was successful\n    pub fn is_success(\u0026self) -\u003e bool {\n        matches!(self, Self::Ready)\n    }\n    \n    /// Get color for status display\n    pub fn color(\u0026self) -\u003e colored::Color {\n        match self {\n            Self::Queued =\u003e Color::Yellow,\n            Self::Building =\u003e Color::Blue,\n            Self::Deploying =\u003e Color::Cyan,\n            Self::Ready =\u003e Color::Green,\n            Self::Failed =\u003e Color::Red,\n            Self::Cancelled =\u003e Color::BrightBlack,\n        }\n    }\n}\n\nimpl fmt::Display for DeploymentStatus {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        let status = match self {\n            Self::Queued =\u003e \"Queued\",\n            Self::Building =\u003e \"Building\",\n            Self::Deploying =\u003e \"Deploying\",\n            Self::Ready =\u003e \"Ready\",\n            Self::Failed =\u003e \"Failed\",\n            Self::Cancelled =\u003e \"Cancelled\",\n        };\n        write!(f, \"{}\", status.color(self.color()))\n    }\n}\n\n/// Deployment log entry\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DeploymentLog {\n    /// Timestamp\n    pub timestamp: DateTime\u003cUtc\u003e,\n    \n    /// Log level\n    pub level: LogLevel,\n    \n    /// Log message\n    pub message: String,\n    \n    /// Optional metadata\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub metadata: Option\u003cserde_json::Value\u003e,\n}\n\n/// Log level\n#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum LogLevel {\n    Debug,\n    Info,\n    Warning,\n    Error,\n}\n\nimpl LogLevel {\n    pub fn color(\u0026self) -\u003e Color {\n        match self {\n            Self::Debug =\u003e Color::BrightBlack,\n            Self::Info =\u003e Color::White,\n            Self::Warning =\u003e Color::Yellow,\n            Self::Error =\u003e Color::Red,\n        }\n    }\n}\n\nimpl fmt::Display for LogLevel {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        let level = match self {\n            Self::Debug =\u003e \"DEBUG\",\n            Self::Info =\u003e \"INFO\",\n            Self::Warning =\u003e \"WARN\",\n            Self::Error =\u003e \"ERROR\",\n        };\n        write!(f, \"{}\", level.color(self.color()))\n    }\n}\n\nimpl DeploymentLog {\n    /// Create a new log entry\n    pub fn new(level: LogLevel, message: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            timestamp: Utc::now(),\n            level,\n            message: message.into(),\n            metadata: None,\n        }\n    }\n    \n    /// Create debug log\n    pub fn debug(message: impl Into\u003cString\u003e) -\u003e Self {\n        Self::new(LogLevel::Debug, message)\n    }\n    \n    /// Create info log\n    pub fn info(message: impl Into\u003cString\u003e) -\u003e Self {\n        Self::new(LogLevel::Info, message)\n    }\n    \n    /// Create warning log\n    pub fn warning(message: impl Into\u003cString\u003e) -\u003e Self {\n        Self::new(LogLevel::Warning, message)\n    }\n    \n    /// Create error log\n    pub fn error(message: impl Into\u003cString\u003e) -\u003e Self {\n        Self::new(LogLevel::Error, message)\n    }\n    \n    /// Add metadata to the log\n    pub fn with_metadata(mut self, metadata: serde_json::Value) -\u003e Self {\n        self.metadata = Some(metadata);\n        self\n    }\n    \n    /// Format log for display\n    pub fn format(\u0026self) -\u003e String {\n        format!(\n            \"{} {} {}\",\n            self.timestamp.format(\"%H:%M:%S\").to_string().bright_black(),\n            self.level,\n            self.message\n        )\n    }\n}\n\n/// Deployment progress tracker\npub struct ProgressTracker {\n    logs: Vec\u003cDeploymentLog\u003e,\n    status: DeploymentStatus,\n    start_time: DateTime\u003cUtc\u003e,\n}\n\nimpl ProgressTracker {\n    /// Create new progress tracker\n    pub fn new() -\u003e Self {\n        Self {\n            logs: Vec::new(),\n            status: DeploymentStatus::Queued,\n            start_time: Utc::now(),\n        }\n    }\n    \n    /// Update status\n    pub fn set_status(\u0026mut self, status: DeploymentStatus) {\n        let status_msg = format!(\"Status: {}\", status);\n        self.status = status;\n        self.logs.push(DeploymentLog::info(status_msg));\n    }\n    \n    /// Add log entry\n    pub fn log(\u0026mut self, log: DeploymentLog) {\n        if log.level != LogLevel::Debug {\n            println!(\"{}\", log.format());\n        }\n        self.logs.push(log);\n    }\n    \n    /// Get elapsed time\n    pub fn elapsed(\u0026self) -\u003e chrono::Duration {\n        Utc::now() - self.start_time\n    }\n    \n    /// Get all logs\n    pub fn logs(\u0026self) -\u003e \u0026[DeploymentLog] {\n        \u0026self.logs\n    }\n    \n    /// Get current status\n    pub fn status(\u0026self) -\u003e \u0026DeploymentStatus {\n        \u0026self.status\n    }\n}","traces":[{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","deploy","vercel.rs"],"content":"//! Vercel deployment implementation\n\nuse anyhow::{Context, Result};\nuse reqwest::{Client, StatusCode};\nuse serde::{Deserialize, Serialize};\nuse std::{collections::HashMap, path::Path};\nuse tokio::fs;\n\nuse super::{\n    config::{DeployConfig, PlatformConfig},\n    environment::Environment,\n    status::{DeploymentLog, DeploymentStatus, ProgressTracker},\n    DeployOptions, DeployResult,\n};\n\nconst VERCEL_API_URL: \u0026str = \"https://api.vercel.com\";\nconst VERCEL_API_VERSION: \u0026str = \"v13\";\n\n/// Vercel deployment configuration\nstruct VercelDeployment\u003c'a\u003e {\n    client: Client,\n    token: String,\n    options: \u0026'a DeployOptions,\n    config: \u0026'a DeployConfig,\n    platform_config: Option\u003c\u0026'a PlatformConfig\u003e,\n    environment: \u0026'a Environment,\n    tracker: ProgressTracker,\n}\n\n/// Deploy to Vercel\npub async fn deploy(\n    options: \u0026DeployOptions,\n    config: \u0026DeployConfig,\n    environment: \u0026Environment,\n) -\u003e Result\u003cDeployResult\u003e {\n    let mut deployment = VercelDeployment::new(options, config, environment)?;\n    deployment.execute().await\n}\n\n/// Get deployment status\npub async fn get_status(deployment_id: \u0026str) -\u003e Result\u003cDeploymentStatus\u003e {\n    let token = std::env::var(\"VERCEL_TOKEN\")\n        .context(\"VERCEL_TOKEN environment variable not set\")?;\n    \n    let client = Client::new();\n    let url = format!(\"{}/v13/deployments/{}\", VERCEL_API_URL, deployment_id);\n    \n    let response = client\n        .get(\u0026url)\n        .bearer_auth(\u0026token)\n        .send()\n        .await?;\n    \n    if !response.status().is_success() {\n        return Err(anyhow::anyhow!(\"Failed to get deployment status\"));\n    }\n    \n    let deployment: VercelDeploymentResponse = response.json().await?;\n    Ok(deployment.ready_state.into())\n}\n\n/// List recent deployments\npub async fn list_deployments(limit: usize) -\u003e Result\u003cVec\u003cDeployResult\u003e\u003e {\n    let token = std::env::var(\"VERCEL_TOKEN\")\n        .context(\"VERCEL_TOKEN environment variable not set\")?;\n    \n    let client = Client::new();\n    let url = format!(\"{}/v6/deployments?limit={}\", VERCEL_API_URL, limit);\n    \n    let response = client\n        .get(\u0026url)\n        .bearer_auth(\u0026token)\n        .send()\n        .await?;\n    \n    if !response.status().is_success() {\n        return Err(anyhow::anyhow!(\"Failed to list deployments\"));\n    }\n    \n    let list: VercelDeploymentList = response.json().await?;\n    \n    Ok(list.deployments.into_iter().map(|d| DeployResult {\n        deployment_id: d.uid,\n        url: d.url.unwrap_or_default(),\n        preview_url: None,\n        status: d.ready_state.into(),\n        logs: vec![],\n    }).collect())\n}\n\n/// Rollback deployment (promote previous deployment)\npub async fn rollback(deployment_id: \u0026str) -\u003e Result\u003c()\u003e {\n    // Vercel doesn't have direct rollback, but we can promote a previous deployment\n    // This would typically be done through the Vercel dashboard\n    Err(anyhow::anyhow!(\n        \"Vercel rollback must be done through the dashboard. Visit: https://vercel.com/deployments/{}\",\n        deployment_id\n    ))\n}\n\nimpl\u003c'a\u003e VercelDeployment\u003c'a\u003e {\n    fn new(\n        options: \u0026'a DeployOptions,\n        config: \u0026'a DeployConfig,\n        environment: \u0026'a Environment,\n    ) -\u003e Result\u003cSelf\u003e {\n        // Get API token\n        let platform_config = config.platform_config(super::Platform::Vercel);\n        let token = if let Some(pc) = platform_config {\n            if let Some(token) = \u0026pc.token {\n                if token.starts_with('$') {\n                    std::env::var(\u0026token[1..])\n                        .with_context(|| format!(\"Environment variable {} not set\", \u0026token[1..]))?\n                } else {\n                    token.clone()\n                }\n            } else {\n                std::env::var(\"VERCEL_TOKEN\")\n                    .context(\"VERCEL_TOKEN environment variable not set\")?\n            }\n        } else {\n            std::env::var(\"VERCEL_TOKEN\")\n                .context(\"VERCEL_TOKEN environment variable not set\")?\n        };\n        \n        let client = Client::new();\n        \n        Ok(Self {\n            client,\n            token,\n            options,\n            config,\n            platform_config,\n            environment,\n            tracker: ProgressTracker::new(),\n        })\n    }\n    \n    async fn execute(\u0026mut self) -\u003e Result\u003cDeployResult\u003e {\n        self.tracker.set_status(DeploymentStatus::Building);\n        \n        // Create deployment\n        let deployment = self.create_deployment().await?;\n        \n        // Upload files\n        self.tracker.log(DeploymentLog::info(\"Uploading files...\"));\n        self.upload_files(\u0026deployment).await?;\n        \n        // Wait for deployment to be ready\n        self.tracker.set_status(DeploymentStatus::Deploying);\n        let final_deployment = self.wait_for_ready(\u0026deployment.id).await?;\n        \n        Ok(DeployResult {\n            deployment_id: final_deployment.uid,\n            url: final_deployment.url.unwrap_or_default(),\n            preview_url: final_deployment.alias.first().cloned(),\n            status: final_deployment.ready_state.into(),\n            logs: self.tracker.logs().to_vec(),\n        })\n    }\n    \n    async fn create_deployment(\u0026mut self) -\u003e Result\u003cVercelDeploymentResponse\u003e {\n        self.tracker.log(DeploymentLog::info(\"Creating Vercel deployment...\"));\n        \n        // Build deployment request\n        let mut request = VercelDeploymentRequest {\n            name: self.config.deploy.project_name.clone()\n                .unwrap_or_else(|| \"layer9-app\".to_string()),\n            project_id: self.platform_config.and_then(|c| c.project_id.clone()),\n            target: Some(match self.environment.name.as_str() {\n                \"production\" =\u003e \"production\",\n                _ =\u003e \"preview\",\n            }.to_string()),\n            git_source: None,\n            functions: None,\n            routes: None,\n            regions: vec![\"sfo1\".to_string()], // Default to San Francisco\n            env: self.build_env_vars(),\n            build_env: self.build_env_vars(),\n            framework: self.platform_config\n                .and_then(|c| c.framework.clone())\n                .or_else(|| Some(\"vanilla\".to_string())),\n        };\n        \n        // Set custom domain if configured\n        if let Some(domain) = \u0026self.config.deploy.domain {\n            request.env.insert(\"CUSTOM_DOMAIN\".to_string(), domain.clone());\n        }\n        \n        let url = format!(\"{}/v13/deployments\", VERCEL_API_URL);\n        let response = self.client\n            .post(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .json(\u0026request)\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            let error_text = response.text().await?;\n            return Err(anyhow::anyhow!(\"Failed to create deployment: {}\", error_text));\n        }\n        \n        let deployment: VercelDeploymentResponse = response.json().await?;\n        self.tracker.log(DeploymentLog::info(format!(\n            \"Created deployment: {}\",\n            deployment.id\n        )));\n        \n        Ok(deployment)\n    }\n    \n    async fn upload_files(\u0026mut self, deployment: \u0026VercelDeploymentResponse) -\u003e Result\u003c()\u003e {\n        // Get list of files to upload\n        let files = self.collect_files().await?;\n        self.tracker.log(DeploymentLog::info(format!(\n            \"Found {} files to upload\",\n            files.len()\n        )));\n        \n        // Create file tree\n        let file_tree = self.create_file_tree(\u0026files).await?;\n        \n        // Upload file tree\n        let url = format!(\"{}/v2/deployments/{}/files\", VERCEL_API_URL, deployment.id);\n        let response = self.client\n            .post(\u0026url)\n            .bearer_auth(\u0026self.token)\n            .json(\u0026file_tree)\n            .send()\n            .await?;\n        \n        if !response.status().is_success() {\n            let error_text = response.text().await?;\n            return Err(anyhow::anyhow!(\"Failed to upload files: {}\", error_text));\n        }\n        \n        Ok(())\n    }\n    \n    async fn collect_files(\u0026self) -\u003e Result\u003cVec\u003cFileInfo\u003e\u003e {\n        let mut files = Vec::new();\n        let build_dir = \u0026self.options.build_dir;\n        \n        // Walk directory and collect files\n        self.collect_files_recursive(build_dir, build_dir, \u0026mut files).await?;\n        \n        Ok(files)\n    }\n    \n    async fn collect_files_recursive(\n        \u0026self,\n        base_dir: \u0026Path,\n        dir: \u0026Path,\n        files: \u0026mut Vec\u003cFileInfo\u003e,\n    ) -\u003e Result\u003c()\u003e {\n        let mut entries = fs::read_dir(dir).await?;\n        \n        while let Some(entry) = entries.next_entry().await? {\n            let path = entry.path();\n            let metadata = entry.metadata().await?;\n            \n            if metadata.is_file() {\n                let relative_path = path.strip_prefix(base_dir)?;\n                let content = fs::read(\u0026path).await?;\n                \n                files.push(FileInfo {\n                    path: relative_path.to_string_lossy().to_string(),\n                    content,\n                    mode: if is_executable(\u0026metadata) { 0o755 } else { 0o644 },\n                });\n            } else if metadata.is_dir() {\n                Box::pin(self.collect_files_recursive(base_dir, \u0026path, files)).await?;\n            }\n        }\n        \n        Ok(())\n    }\n    \n    async fn create_file_tree(\u0026self, files: \u0026[FileInfo]) -\u003e Result\u003cVec\u003cVercelFile\u003e\u003e {\n        let mut tree = Vec::new();\n        \n        for file in files {\n            // Calculate SHA-1 hash\n            let hash = sha1_hash(\u0026file.content);\n            \n            // Upload file content\n            let upload_url = format!(\"{}/v2/files/{}\", VERCEL_API_URL, hash);\n            let response = self.client\n                .post(\u0026upload_url)\n                .bearer_auth(\u0026self.token)\n                .header(\"x-vercel-digest\", \u0026hash)\n                .body(file.content.clone())\n                .send()\n                .await?;\n            \n            if !response.status().is_success() \u0026\u0026 response.status() != StatusCode::CONFLICT {\n                return Err(anyhow::anyhow!(\"Failed to upload file: {}\", file.path));\n            }\n            \n            tree.push(VercelFile {\n                file: file.path.clone(),\n                sha: hash,\n                size: file.content.len(),\n            });\n        }\n        \n        Ok(tree)\n    }\n    \n    async fn wait_for_ready(\u0026mut self, deployment_id: \u0026str) -\u003e Result\u003cVercelDeploymentResponse\u003e {\n        let mut attempt = 0;\n        let max_attempts = 300; // 5 minutes with 1 second intervals\n        \n        loop {\n            attempt += 1;\n            if attempt \u003e max_attempts {\n                return Err(anyhow::anyhow!(\"Deployment timeout\"));\n            }\n            \n            // Get deployment status\n            let url = format!(\"{}/v13/deployments/{}\", VERCEL_API_URL, deployment_id);\n            let response = self.client\n                .get(\u0026url)\n                .bearer_auth(\u0026self.token)\n                .send()\n                .await?;\n            \n            if !response.status().is_success() {\n                return Err(anyhow::anyhow!(\"Failed to get deployment status\"));\n            }\n            \n            let deployment: VercelDeploymentResponse = response.json().await?;\n            let status: DeploymentStatus = deployment.ready_state.clone().into();\n            \n            if status != self.tracker.status().clone() {\n                self.tracker.set_status(status.clone());\n            }\n            \n            if status.is_complete() {\n                return Ok(deployment);\n            }\n            \n            // Wait before next check\n            tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;\n        }\n    }\n    \n    fn build_env_vars(\u0026self) -\u003e HashMap\u003cString, String\u003e {\n        self.environment.to_env_map()\n    }\n}\n\n/// File information\nstruct FileInfo {\n    path: String,\n    content: Vec\u003cu8\u003e,\n    mode: u32,\n}\n\n/// Vercel API types\n#[derive(Debug, Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct VercelDeploymentRequest {\n    name: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    project_id: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    target: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    git_source: Option\u003cserde_json::Value\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    functions: Option\u003cserde_json::Value\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    routes: Option\u003cVec\u003cserde_json::Value\u003e\u003e,\n    regions: Vec\u003cString\u003e,\n    env: HashMap\u003cString, String\u003e,\n    build_env: HashMap\u003cString, String\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    framework: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct VercelDeploymentResponse {\n    id: String,\n    uid: String,\n    name: String,\n    url: Option\u003cString\u003e,\n    created: i64,\n    ready_state: VercelReadyState,\n    #[serde(default)]\n    alias: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\n#[serde(rename_all = \"SCREAMING_SNAKE_CASE\")]\nenum VercelReadyState {\n    Queued,\n    Building,\n    Initializing,\n    Deploying,\n    Ready,\n    Error,\n    Canceled,\n}\n\nimpl From\u003cVercelReadyState\u003e for DeploymentStatus {\n    fn from(state: VercelReadyState) -\u003e Self {\n        match state {\n            VercelReadyState::Queued =\u003e DeploymentStatus::Queued,\n            VercelReadyState::Building | VercelReadyState::Initializing =\u003e DeploymentStatus::Building,\n            VercelReadyState::Deploying =\u003e DeploymentStatus::Deploying,\n            VercelReadyState::Ready =\u003e DeploymentStatus::Ready,\n            VercelReadyState::Error =\u003e DeploymentStatus::Failed,\n            VercelReadyState::Canceled =\u003e DeploymentStatus::Cancelled,\n        }\n    }\n}\n\n#[derive(Debug, Serialize)]\nstruct VercelFile {\n    file: String,\n    sha: String,\n    size: usize,\n}\n\n#[derive(Debug, Deserialize)]\nstruct VercelDeploymentList {\n    deployments: Vec\u003cVercelDeploymentResponse\u003e,\n}\n\n/// Calculate SHA-256 hash of content\nfn sha1_hash(content: \u0026[u8]) -\u003e String {\n    use sha2::{Sha256, Digest};\n    let mut hasher = Sha256::new();\n    hasher.update(content);\n    format!(\"{:x}\", hasher.finalize())\n}\n\n/// Check if file is executable\nfn is_executable(metadata: \u0026std::fs::Metadata) -\u003e bool {\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::MetadataExt;\n        metadata.mode() \u0026 0o111 != 0\n    }\n    #[cfg(not(unix))]\n    {\n        false\n    }\n}","traces":[{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":130},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","haf_gen.rs"],"content":"//! HAF Project Structure Generator\n//! \n//! Generates proper HAF-compliant project structure with layer separation\n\nuse std::path::{Path, PathBuf};\nuse std::fs;\nuse anyhow::Result;\nuse colored::*;\n\n/// HAF project structure\npub struct HafProject {\n    pub name: String,\n    pub root: PathBuf,\n}\n\nimpl HafProject {\n    pub fn new(name: String, root: PathBuf) -\u003e Self {\n        Self { name, root }\n    }\n    \n    /// Generate HAF project structure\n    pub fn generate(\u0026self) -\u003e Result\u003c()\u003e {\n        println!(\"{}\", \"🏗️  Generating HAF project structure...\".cyan());\n        \n        // Create directory structure\n        self.create_directories()?;\n        \n        // Generate layer modules\n        self.generate_l1_core()?;\n        self.generate_l2_runtime()?;\n        self.generate_l3_framework()?;\n        \n        // Generate main lib.rs\n        self.generate_lib_rs()?;\n        \n        // Generate contracts\n        self.generate_contracts()?;\n        \n        // Generate HAF config\n        self.generate_haf_config()?;\n        \n        // Generate example components\n        self.generate_examples()?;\n        \n        println!(\"{}\", \"✅ HAF project structure created!\".green());\n        Ok(())\n    }\n    \n    fn create_directories(\u0026self) -\u003e Result\u003c()\u003e {\n        let dirs = vec![\n            \"src/l1_core\",\n            \"src/l1_core/components\",\n            \"src/l1_core/models\",\n            \"src/l1_core/logic\",\n            \"src/l2_runtime\",\n            \"src/l2_runtime/services\",\n            \"src/l2_runtime/effects\",\n            \"src/l3_framework\",\n            \"src/l3_framework/api\",\n            \"src/l3_framework/dom\",\n            \"src/contracts\",\n            \"tests/haf\",\n        ];\n        \n        for dir in dirs {\n            fs::create_dir_all(self.root.join(dir))?;\n        }\n        \n        Ok(())\n    }\n    \n    fn generate_l1_core(\u0026self) -\u003e Result\u003c()\u003e {\n        // L1 module\n        let l1_mod = r#\"//! L1: Core - Pure Business Logic\n//! \n//! This layer contains only pure functions and data structures.\n//! No side effects, no I/O, no dependencies on external systems.\n\npub mod components;\npub mod models;\npub mod logic;\n\nuse layer9::haf::{layers::L1, Layer};\n\n/// Example of L1 pure function\npub fn pure_computation(a: i32, b: i32) -\u003e i32 {\n    a + b\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_pure_computation() {\n        assert_eq!(pure_computation(2, 3), 5);\n    }\n}\n\"#;\n        fs::write(self.root.join(\"src/l1_core/mod.rs\"), l1_mod)?;\n        \n        // Models\n        let models = r#\"//! Pure data models\n\n#[derive(Clone, Debug, PartialEq)]\npub struct User {\n    pub id: u32,\n    pub name: String,\n    pub email: String,\n}\n\n#[derive(Clone, Debug, PartialEq)]\npub struct AppState {\n    pub users: Vec\u003cUser\u003e,\n    pub selected_user: Option\u003cu32\u003e,\n}\n\"#;\n        fs::write(self.root.join(\"src/l1_core/models.rs\"), models)?;\n        \n        // Logic\n        let logic = r#\"//! Pure business logic\n\nuse super::models::*;\n\n/// Add a new user (pure function)\npub fn add_user(state: \u0026AppState, user: User) -\u003e AppState {\n    let mut new_state = state.clone();\n    new_state.users.push(user);\n    new_state\n}\n\n/// Select a user (pure function)\npub fn select_user(state: \u0026AppState, user_id: u32) -\u003e AppState {\n    let mut new_state = state.clone();\n    new_state.selected_user = Some(user_id);\n    new_state\n}\n\"#;\n        fs::write(self.root.join(\"src/l1_core/logic.rs\"), logic)?;\n        \n        // Components module\n        let components_mod = r#\"//! Pure components\n\npub mod counter;\n\npub use counter::Counter;\n\"#;\n        fs::write(self.root.join(\"src/l1_core/components/mod.rs\"), components_mod)?;\n        \n        Ok(())\n    }\n    \n    fn generate_l2_runtime(\u0026self) -\u003e Result\u003c()\u003e {\n        // L2 module\n        let l2_mod = r#\"//! L2: Runtime - Execution Environment\n//! \n//! This layer manages side effects, lifecycle, and orchestration.\n//! Can depend on L1 but not L3.\n\npub mod services;\npub mod effects;\n\nuse layer9::haf::{layers::L2, Layer};\nuse crate::l1_core;\n\n/// Runtime state manager\npub struct RuntimeState {\n    // Runtime-specific state\n}\n\nimpl RuntimeState {\n    pub fn new() -\u003e Self {\n        Self {}\n    }\n    \n    /// Execute an effect\n    pub fn execute_effect\u003cF\u003e(\u0026mut self, effect: F) \n    where\n        F: FnOnce() -\u003e ()\n    {\n        // Schedule and execute effect\n        effect();\n    }\n}\n\"#;\n        fs::write(self.root.join(\"src/l2_runtime/mod.rs\"), l2_mod)?;\n        \n        // Services\n        let services = r#\"//! Runtime services\n\nuse layer9::haf::{layers::L2, Service};\nuse crate::l1_core::models::*;\n\n// State management service\npub mod state_service {\n    use super::*;\n    \n    pub fn get_current_state() -\u003e AppState {\n        // In real app, would manage state persistence\n        AppState {\n            users: vec![],\n            selected_user: None,\n        }\n    }\n    \n    pub fn update_state(new_state: AppState) {\n        // Update state in runtime\n    }\n}\n\n// Event handling service\npub mod event_service {\n    pub fn dispatch_event(event_id: u64) {\n        // Handle event dispatching\n    }\n}\n\"#;\n        fs::write(self.root.join(\"src/l2_runtime/services.rs\"), services)?;\n        \n        // Effects\n        let effects = r#\"//! Effect management\n\nuse std::future::Future;\n\n/// Effect handle\npub struct EffectHandle {\n    id: u64,\n}\n\n/// Schedule an effect\npub fn schedule_effect\u003cF\u003e(f: F) -\u003e EffectHandle\nwhere\n    F: FnOnce() + 'static\n{\n    // In real implementation, would queue effect\n    EffectHandle { id: 0 }\n}\n\n/// Cancel an effect\npub fn cancel_effect(handle: EffectHandle) {\n    // Cancel queued effect\n}\n\"#;\n        fs::write(self.root.join(\"src/l2_runtime/effects.rs\"), effects)?;\n        \n        Ok(())\n    }\n    \n    fn generate_l3_framework(\u0026self) -\u003e Result\u003c()\u003e {\n        // L3 module\n        let l3_mod = r#\"//! L3: Framework - External Interfaces\n//! \n//! This layer handles all I/O, external APIs, and user-facing interfaces.\n//! Can depend on both L1 and L2.\n\npub mod api;\npub mod dom;\n\nuse layer9::haf::{layers::L3, Layer};\nuse crate::{l1_core, l2_runtime};\n\n/// Application entry point\npub fn mount_app(selector: \u0026str) {\n    // Initialize app and mount to DOM\n    println!(\"Mounting HAF app to {}\", selector);\n}\n\"#;\n        fs::write(self.root.join(\"src/l3_framework/mod.rs\"), l3_mod)?;\n        \n        // API\n        let api = r#\"//! External API interactions\n\nuse layer9::haf::{layers::L3, Service};\n\n// API service module\npub mod api_service {\n    pub async fn fetch_users() -\u003e Result\u003cString, String\u003e {\n        // Make HTTP request\n        Ok(\"[]\".to_string())\n    }\n    \n    pub async fn save_user(user_json: String) -\u003e Result\u003c(), String\u003e {\n        // POST to API\n        Ok(())\n    }\n}\n\"#;\n        fs::write(self.root.join(\"src/l3_framework/api.rs\"), api)?;\n        \n        // DOM\n        let dom = r#\"//! DOM manipulation\n\nuse web_sys::{window, Document, Element};\n\n/// Get document\npub fn document() -\u003e Document {\n    window().unwrap().document().unwrap()\n}\n\n/// Query selector\npub fn query_selector(selector: \u0026str) -\u003e Option\u003cElement\u003e {\n    document().query_selector(selector).ok().flatten()\n}\n\n/// Create element\npub fn create_element(tag: \u0026str) -\u003e Element {\n    document().create_element(tag).unwrap()\n}\n\"#;\n        fs::write(self.root.join(\"src/l3_framework/dom.rs\"), dom)?;\n        \n        Ok(())\n    }\n    \n    fn generate_lib_rs(\u0026self) -\u003e Result\u003c()\u003e {\n        let lib_rs = format!(r#\"//! {} - HAF Layer9 Application\n//! \n//! This application follows the Hierarchical Architecture First (HAF) principles\n//! with strict layer separation and compile-time enforcement.\n\n#![warn(clippy::all)]\n\n// Layer modules\npub mod l1_core;\npub mod l2_runtime;\npub mod l3_framework;\npub mod contracts;\n\n// Re-exports\npub use l1_core::models::*;\npub use l3_framework::mount_app;\n\nuse wasm_bindgen::prelude::*;\n\n/// Application entry point\n#[wasm_bindgen(start)]\npub fn main() {{\n    // Set panic hook\n    console_error_panic_hook::set_once();\n    \n    // Mount application\n    mount_app(\"#app\");\n}}\n\"#, self.name);\n        \n        fs::write(self.root.join(\"src/lib.rs\"), lib_rs)?;\n        Ok(())\n    }\n    \n    fn generate_contracts(\u0026self) -\u003e Result\u003c()\u003e {\n        let contracts_mod = r#\"//! Layer translation contracts\n\nuse layer9::haf::*;\nuse crate::l1_core::models::*;\n\n/// Contract for state updates (L1 → L2)\npub struct StateUpdateContract;\n\nimpl L1ToL2Contract for StateUpdateContract {\n    type L1Type = AppState;\n    type L2Type = StateUpdateCommand;\n    \n    fn translate(state: Self::L1Type) -\u003e Self::L2Type {\n        StateUpdateCommand {\n            new_state: state,\n            timestamp: 0, // Would use actual timestamp\n        }\n    }\n}\n\npub struct StateUpdateCommand {\n    pub new_state: AppState,\n    pub timestamp: u64,\n}\n\n/// Contract for API calls (L2 → L3)\npub struct ApiCallContract;\n\nimpl L2ToL3Contract for ApiCallContract {\n    type L2Type = ApiRequest;\n    type L3Type = HttpRequest;\n    \n    fn translate(req: Self::L2Type) -\u003e Self::L3Type {\n        HttpRequest {\n            url: req.endpoint,\n            method: \"POST\".to_string(),\n            body: req.payload,\n        }\n    }\n}\n\npub struct ApiRequest {\n    pub endpoint: String,\n    pub payload: String,\n}\n\npub struct HttpRequest {\n    pub url: String,\n    pub method: String,\n    pub body: String,\n}\n\"#;\n        \n        fs::write(self.root.join(\"src/contracts/mod.rs\"), contracts_mod)?;\n        Ok(())\n    }\n    \n    fn generate_haf_config(\u0026self) -\u003e Result\u003c()\u003e {\n        let haf_toml = r#\"# HAF Configuration\n\n[haf]\n# Enable strict mode - fail compilation on violations\nstrict = true\n\n# Layer annotations are required\nrequire_annotations = true\n\n[layers.l1]\n# L1 can only depend on itself\nallowed_dependencies = []\nforbidden_imports = [\"std::io\", \"tokio\", \"web_sys\", \"reqwest\"]\n\n[layers.l2]\n# L2 can depend on L1\nallowed_dependencies = [\"l1\"]\nforbidden_imports = [\"web_sys\", \"reqwest\"]\n\n[layers.l3]\n# L3 can depend on L1 and L2\nallowed_dependencies = [\"l1\", \"l2\"]\n\n[linting]\n# Run HAF linter on build\nlint_on_build = true\n\n# Treat warnings as errors\nwarnings_as_errors = true\n\"#;\n        \n        fs::write(self.root.join(\"haf.toml\"), haf_toml)?;\n        Ok(())\n    }\n    \n    fn generate_examples(\u0026self) -\u003e Result\u003c()\u003e {\n        let example = r#\"//! Example HAF component\n\nuse layer9::haf::{layers::L1, component::*};\n\npub struct Counter;\n\nimpl Default for Counter {\n    fn default() -\u003e Self {\n        Self\n    }\n}\n\nimpl PureComponent\u003cL1\u003e for Counter {\n    type Props = CounterProps;\n    \n    fn render(\u0026self, props: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n        VNode::Element {\n            tag: \"div\".to_string(),\n            props: VProps::default(),\n            children: vec![\n                VNode::Text(format!(\"Count: {}\", props.count))\n            ],\n        }\n    }\n}\n\n#[derive(Clone)]\npub struct CounterProps {\n    pub count: i32,\n}\n\"#;\n        \n        fs::write(self.root.join(\"src/l1_core/components/counter.rs\"), example)?;\n        Ok(())\n    }\n}\n\n/// Generate HAF project from CLI\npub fn generate_haf_project(name: \u0026str) -\u003e Result\u003c()\u003e {\n    let root = PathBuf::from(name);\n    \n    if root.exists() {\n        return Err(anyhow::anyhow!(\"Directory {} already exists\", name));\n    }\n    \n    fs::create_dir_all(\u0026root)?;\n    \n    let project = HafProject::new(name.to_string(), root.clone());\n    project.generate()?;\n    \n    // Generate Cargo.toml\n    let cargo_toml = format!(r#\"[package]\nname = \"{}\"\nversion = \"0.1.0\"\nedition = \"2021\"\n\n[lib]\ncrate-type = [\"cdylib\", \"rlib\"]\n\n[dependencies]\nlayer9 = {{ version = \"0.1\", features = [\"haf\"] }}\nwasm-bindgen = \"0.2\"\nweb-sys = \"0.3\"\nconsole_error_panic_hook = \"0.1\"\n\n[features]\ndefault = [\"haf-strict\"]\nhaf-strict = [] # Enable strict HAF enforcement\n\n[profile.release]\nopt-level = \"z\"\nlto = true\n\"#, name.replace('-', \"_\"));\n    \n    fs::write(root.join(\"Cargo.toml\"), cargo_toml)?;\n    \n    // Generate README\n    let readme = format!(r#\"# {}\n\nA HAF-compliant Layer9 application with strict architectural enforcement.\n\n## Architecture\n\nThis project follows the Hierarchical Architecture First (HAF) principles:\n\n- **L1 (Core)**: Pure business logic, no side effects\n- **L2 (Runtime)**: Effect management and orchestration  \n- **L3 (Framework)**: External interfaces and I/O\n\n## Development\n\n```bash\n# Run HAF linter\nlayer9 haf-lint\n\n# Start development server\nlayer9 dev\n\n# Build for production\nlayer9 build --mode production\n```\n\n## Layer Guidelines\n\n### L1: Core\n- Pure functions only\n- No I/O or side effects\n- Immutable data structures\n- Business logic and algorithms\n\n### L2: Runtime\n- Effect scheduling\n- State management\n- Service orchestration\n- Can use L1, but not L3\n\n### L3: Framework\n- DOM manipulation\n- HTTP requests\n- Browser APIs\n- Can use both L1 and L2\n\"#, name);\n    \n    fs::write(root.join(\"README.md\"), readme)?;\n    \n    println!(\"\\n{}\", \"📁 Generated files:\".green().bold());\n    println!(\"  {} Cargo.toml\", \"✓\".green());\n    println!(\"  {} src/lib.rs\", \"✓\".green());\n    println!(\"  {} src/l1_core/\", \"✓\".green());\n    println!(\"  {} src/l2_runtime/\", \"✓\".green());\n    println!(\"  {} src/l3_framework/\", \"✓\".green());\n    println!(\"  {} src/contracts/\", \"✓\".green());\n    println!(\"  {} haf.toml\", \"✓\".green());\n    println!(\"  {} README.md\", \"✓\".green());\n    \n    Ok(())\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","haf_lint.rs"],"content":"//! HAF Linting Tool\n//! \n//! Static analysis tool to detect HAF architectural violations in Layer9 code.\n//! This helps enforce HAF principles even before compilation.\n\nuse std::path::{Path, PathBuf};\nuse std::fs;\nuse std::collections::{HashMap, HashSet};\nuse syn::{parse_file, Item, ItemMod, ItemUse, UseTree, Type, Expr, visit::Visit};\nuse colored::*;\n\n/// HAF violation types\n#[derive(Debug, Clone)]\npub enum Violation {\n    /// L1 code importing L2/L3 modules\n    LayerDependencyViolation {\n        from_layer: String,\n        to_layer: String,\n        file: PathBuf,\n        line: usize,\n    },\n    /// Side effects in L1 code\n    SideEffectInPureLayer {\n        file: PathBuf,\n        line: usize,\n        description: String,\n    },\n    /// Direct I/O operations outside L3\n    IoOutsideFrameworkLayer {\n        file: PathBuf,\n        line: usize,\n        operation: String,\n    },\n    /// Missing layer annotation\n    MissingLayerAnnotation {\n        file: PathBuf,\n        module: String,\n    },\n    /// Mixed layer concerns in single module\n    MixedLayerConcerns {\n        file: PathBuf,\n        layers: Vec\u003cString\u003e,\n    },\n}\n\n/// Layer detection from module path or annotations\n#[derive(Debug, Clone, PartialEq)]\nenum Layer {\n    L1,\n    L2,\n    L3,\n    Unknown,\n}\n\nimpl Layer {\n    fn from_path(path: \u0026Path) -\u003e Self {\n        let path_str = path.to_string_lossy();\n        \n        if path_str.contains(\"/l1_\") || path_str.contains(\"/core/\") || path_str.contains(\"_pure\") {\n            Layer::L1\n        } else if path_str.contains(\"/l2_\") || path_str.contains(\"/runtime/\") {\n            Layer::L2\n        } else if path_str.contains(\"/l3_\") || path_str.contains(\"/framework/\") || path_str.contains(\"/api/\") {\n            Layer::L3\n        } else {\n            Layer::Unknown\n        }\n    }\n    \n    fn from_annotation(content: \u0026str) -\u003e Option\u003cSelf\u003e {\n        if content.contains(\"//! L1\") || content.contains(\"/// L1\") {\n            Some(Layer::L1)\n        } else if content.contains(\"//! L2\") || content.contains(\"/// L2\") {\n            Some(Layer::L2)\n        } else if content.contains(\"//! L3\") || content.contains(\"/// L3\") {\n            Some(Layer::L3)\n        } else {\n            None\n        }\n    }\n    \n    fn can_depend_on(\u0026self, other: \u0026Layer) -\u003e bool {\n        match (self, other) {\n            // L1 can only depend on L1\n            (Layer::L1, Layer::L1) =\u003e true,\n            (Layer::L1, _) =\u003e false,\n            \n            // L2 can depend on L1 and L2\n            (Layer::L2, Layer::L1) =\u003e true,\n            (Layer::L2, Layer::L2) =\u003e true,\n            (Layer::L2, _) =\u003e false,\n            \n            // L3 can depend on anything\n            (Layer::L3, _) =\u003e true,\n            \n            // Unknown layers are ignored for now\n            (Layer::Unknown, _) =\u003e true,\n            (_, Layer::Unknown) =\u003e true,\n        }\n    }\n}\n\n/// HAF Linter\npub struct HafLinter {\n    violations: Vec\u003cViolation\u003e,\n    layer_map: HashMap\u003cPathBuf, Layer\u003e,\n}\n\nimpl HafLinter {\n    pub fn new() -\u003e Self {\n        Self {\n            violations: Vec::new(),\n            layer_map: HashMap::new(),\n        }\n    }\n    \n    /// Lint a directory recursively\n    pub fn lint_directory(\u0026mut self, dir: \u0026Path) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n        self.scan_directory(dir)?;\n        self.analyze_files()?;\n        Ok(())\n    }\n    \n    /// Scan directory to build layer map\n    fn scan_directory(\u0026mut self, dir: \u0026Path) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n        for entry in fs::read_dir(dir)? {\n            let entry = entry?;\n            let path = entry.path();\n            \n            if path.is_dir() {\n                self.scan_directory(\u0026path)?;\n            } else if path.extension().and_then(|s| s.to_str()) == Some(\"rs\") {\n                let content = fs::read_to_string(\u0026path)?;\n                \n                // Determine layer from annotation or path\n                let layer = Layer::from_annotation(\u0026content)\n                    .unwrap_or_else(|| Layer::from_path(\u0026path));\n                \n                self.layer_map.insert(path, layer);\n            }\n        }\n        Ok(())\n    }\n    \n    /// Analyze all files for violations\n    fn analyze_files(\u0026mut self) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n        let files: Vec\u003c_\u003e = self.layer_map.keys().cloned().collect();\n        \n        for file_path in files {\n            let content = fs::read_to_string(\u0026file_path)?;\n            let file_layer = self.layer_map[\u0026file_path].clone();\n            \n            // Parse the file\n            if let Ok(syntax_tree) = parse_file(\u0026content) {\n                let mut visitor = HafVisitor {\n                    file_path: file_path.clone(),\n                    file_layer,\n                    violations: Vec::new(),\n                    layer_map: \u0026self.layer_map,\n                };\n                \n                visitor.visit_file(\u0026syntax_tree);\n                self.violations.extend(visitor.violations);\n            }\n            \n            // Check for missing layer annotation\n            if file_layer == Layer::Unknown {\n                self.violations.push(Violation::MissingLayerAnnotation {\n                    file: file_path,\n                    module: String::from(\"unknown\"),\n                });\n            }\n        }\n        \n        Ok(())\n    }\n    \n    /// Print violations report\n    pub fn report(\u0026self) {\n        if self.violations.is_empty() {\n            println!(\"{}\", \"✓ No HAF violations found!\".green());\n            return;\n        }\n        \n        println!(\"{}\", format!(\"Found {} HAF violations:\", self.violations.len()).red());\n        println!();\n        \n        for violation in \u0026self.violations {\n            match violation {\n                Violation::LayerDependencyViolation { from_layer, to_layer, file, line } =\u003e {\n                    println!(\"{} {} → {} dependency violation\", \"✗\".red(), from_layer, to_layer);\n                    println!(\"  {} {}:{}\", \"at\".dimmed(), file.display(), line);\n                    println!(\"  {} {} cannot depend on {}\", \"fix:\".yellow(), from_layer, to_layer);\n                    println!();\n                }\n                \n                Violation::SideEffectInPureLayer { file, line, description } =\u003e {\n                    println!(\"{} Side effect in L1 (pure) layer\", \"✗\".red());\n                    println!(\"  {} {}:{}\", \"at\".dimmed(), file.display(), line);\n                    println!(\"  {} {}\", \"found:\".dimmed(), description);\n                    println!(\"  {} Move side effects to L2 or L3\", \"fix:\".yellow());\n                    println!();\n                }\n                \n                Violation::IoOutsideFrameworkLayer { file, line, operation } =\u003e {\n                    println!(\"{} I/O operation outside L3 layer\", \"✗\".red());\n                    println!(\"  {} {}:{}\", \"at\".dimmed(), file.display(), line);\n                    println!(\"  {} {}\", \"operation:\".dimmed(), operation);\n                    println!(\"  {} Move I/O operations to L3\", \"fix:\".yellow());\n                    println!();\n                }\n                \n                Violation::MissingLayerAnnotation { file, module } =\u003e {\n                    println!(\"{} Missing layer annotation\", \"✗\".red());\n                    println!(\"  {} {}\", \"at\".dimmed(), file.display());\n                    println!(\"  {} Add //! L1, //! L2, or //! L3 comment\", \"fix:\".yellow());\n                    println!();\n                }\n                \n                Violation::MixedLayerConcerns { file, layers } =\u003e {\n                    println!(\"{} Mixed layer concerns in single module\", \"✗\".red());\n                    println!(\"  {} {}\", \"at\".dimmed(), file.display());\n                    println!(\"  {} {:?}\", \"found layers:\".dimmed(), layers);\n                    println!(\"  {} Separate concerns into different modules\", \"fix:\".yellow());\n                    println!();\n                }\n            }\n        }\n        \n        println!(\"{}\", format!(\"Total violations: {}\", self.violations.len()).red().bold());\n    }\n    \n    /// Check if any violations were found\n    pub fn has_violations(\u0026self) -\u003e bool {\n        !self.violations.is_empty()\n    }\n}\n\n/// AST visitor to detect violations\nstruct HafVisitor\u003c'a\u003e {\n    file_path: PathBuf,\n    file_layer: Layer,\n    violations: Vec\u003cViolation\u003e,\n    layer_map: \u0026'a HashMap\u003cPathBuf, Layer\u003e,\n}\n\nimpl\u003c'ast\u003e Visit\u003c'ast\u003e for HafVisitor\u003c'_\u003e {\n    fn visit_item_use(\u0026mut self, node: \u0026'ast ItemUse) {\n        // Check import violations\n        self.check_use_tree(\u0026node.tree, 0);\n    }\n    \n    fn visit_expr(\u0026mut self, node: \u0026'ast Expr) {\n        // Check for side effects in L1\n        if self.file_layer == Layer::L1 {\n            match node {\n                // I/O operations\n                Expr::Call(call) =\u003e {\n                    if let Expr::Path(path) = \u0026*call.func {\n                        let path_str = quote::quote!(#path).to_string();\n                        \n                        // Check for known I/O operations\n                        if path_str.contains(\"println\") || \n                           path_str.contains(\"print\") ||\n                           path_str.contains(\"eprintln\") ||\n                           path_str.contains(\"fs::\") ||\n                           path_str.contains(\"std::io\") ||\n                           path_str.contains(\"tokio::\") {\n                            self.violations.push(Violation::SideEffectInPureLayer {\n                                file: self.file_path.clone(),\n                                line: 0, // Would need span info for accurate line\n                                description: format!(\"I/O operation: {}\", path_str),\n                            });\n                        }\n                    }\n                }\n                \n                // Mutable state\n                Expr::AssignOp(assign) =\u003e {\n                    self.violations.push(Violation::SideEffectInPureLayer {\n                        file: self.file_path.clone(),\n                        line: 0,\n                        description: \"Mutable state modification\".to_string(),\n                    });\n                }\n                \n                _ =\u003e {}\n            }\n        }\n        \n        // Check for I/O outside L3\n        if self.file_layer != Layer::L3 \u0026\u0026 self.file_layer != Layer::Unknown {\n            if let Expr::Call(call) = node {\n                if let Expr::Path(path) = \u0026*call.func {\n                    let path_str = quote::quote!(#path).to_string();\n                    \n                    if path_str.contains(\"web_sys::\") ||\n                       path_str.contains(\"window()\") ||\n                       path_str.contains(\"document()\") ||\n                       path_str.contains(\"fetch\") ||\n                       path_str.contains(\"WebSocket\") {\n                        self.violations.push(Violation::IoOutsideFrameworkLayer {\n                            file: self.file_path.clone(),\n                            line: 0,\n                            operation: path_str,\n                        });\n                    }\n                }\n            }\n        }\n        \n        // Continue visiting\n        syn::visit::visit_expr(self, node);\n    }\n}\n\nimpl HafVisitor\u003c'_\u003e {\n    fn check_use_tree(\u0026mut self, tree: \u0026UseTree, depth: usize) {\n        match tree {\n            UseTree::Path(path) =\u003e {\n                // Check if this import violates layer dependencies\n                let import_path = path.ident.to_string();\n                \n                // Map common imports to layers\n                let import_layer = if import_path.contains(\"l1_\") || import_path == \"core\" {\n                    Layer::L1\n                } else if import_path.contains(\"l2_\") || import_path == \"runtime\" {\n                    Layer::L2\n                } else if import_path.contains(\"l3_\") || import_path == \"framework\" || import_path == \"web_sys\" {\n                    Layer::L3\n                } else {\n                    Layer::Unknown\n                };\n                \n                if !self.file_layer.can_depend_on(\u0026import_layer) {\n                    self.violations.push(Violation::LayerDependencyViolation {\n                        from_layer: format!(\"{:?}\", self.file_layer),\n                        to_layer: format!(\"{:?}\", import_layer),\n                        file: self.file_path.clone(),\n                        line: 0,\n                    });\n                }\n                \n                self.check_use_tree(\u0026path.tree, depth + 1);\n            }\n            UseTree::Group(group) =\u003e {\n                for item in \u0026group.items {\n                    self.check_use_tree(item, depth);\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n}\n\n/// CLI integration\npub fn run_linter(path: \u0026Path) -\u003e Result\u003cbool, Box\u003cdyn std::error::Error\u003e\u003e {\n    let mut linter = HafLinter::new();\n    \n    println!(\"{}\", \"Running HAF architectural linter...\".cyan());\n    println!();\n    \n    linter.lint_directory(path)?;\n    linter.report();\n    \n    Ok(!linter.has_violations())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::TempDir;\n    use std::fs::write;\n    \n    #[test]\n    fn test_layer_detection() {\n        assert_eq!(Layer::from_path(Path::new(\"src/l1_core.rs\")), Layer::L1);\n        assert_eq!(Layer::from_path(Path::new(\"src/l2_runtime.rs\")), Layer::L2);\n        assert_eq!(Layer::from_path(Path::new(\"src/l3_framework.rs\")), Layer::L3);\n        assert_eq!(Layer::from_path(Path::new(\"src/utils.rs\")), Layer::Unknown);\n    }\n    \n    #[test]\n    fn test_layer_dependencies() {\n        assert!(Layer::L1.can_depend_on(\u0026Layer::L1));\n        assert!(!Layer::L1.can_depend_on(\u0026Layer::L2));\n        assert!(!Layer::L1.can_depend_on(\u0026Layer::L3));\n        \n        assert!(Layer::L2.can_depend_on(\u0026Layer::L1));\n        assert!(Layer::L2.can_depend_on(\u0026Layer::L2));\n        assert!(!Layer::L2.can_depend_on(\u0026Layer::L3));\n        \n        assert!(Layer::L3.can_depend_on(\u0026Layer::L1));\n        assert!(Layer::L3.can_depend_on(\u0026Layer::L2));\n        assert!(Layer::L3.can_depend_on(\u0026Layer::L3));\n    }\n    \n    #[test]\n    fn test_violation_detection() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n        let temp_dir = TempDir::new()?;\n        \n        // Create test file with violations\n        let l1_file = temp_dir.path().join(\"l1_core.rs\");\n        write(\u0026l1_file, r#\"\n//! L1\nuse crate::l2_runtime::Effect; // Violation!\nuse std::io::println; // Side effect!\n\nfn pure_function() {\n    println!(\"This is a side effect!\"); // Violation!\n}\n        \"#)?;\n        \n        let mut linter = HafLinter::new();\n        linter.lint_directory(temp_dir.path())?;\n        \n        assert!(linter.has_violations());\n        assert!(linter.violations.len() \u003e= 2);\n        \n        Ok(())\n    }\n}","traces":[{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","haf_lint_simple.rs"],"content":"//! Simplified HAF Linter for Layer9\n//! \n//! Basic architectural violation detection\n\nuse std::path::{Path, PathBuf};\nuse std::fs;\nuse colored::*;\nuse anyhow::Result;\n\n/// Simple HAF violation\n#[derive(Debug)]\npub enum Violation {\n    MissingLayerAnnotation { file: PathBuf },\n    SuspectedLayerViolation { file: PathBuf, line: usize, reason: String },\n}\n\n/// Simple HAF Linter\npub struct SimpleLinter {\n    violations: Vec\u003cViolation\u003e,\n}\n\nimpl SimpleLinter {\n    pub fn new() -\u003e Self {\n        Self {\n            violations: Vec::new(),\n        }\n    }\n    \n    pub fn lint_directory(\u0026mut self, dir: \u0026Path) -\u003e Result\u003c()\u003e {\n        println!(\"Scanning directory: {}\", dir.display());\n        self.scan_directory(dir)?;\n        Ok(())\n    }\n    \n    fn scan_directory(\u0026mut self, dir: \u0026Path) -\u003e Result\u003c()\u003e {\n        for entry in fs::read_dir(dir)? {\n            let entry = entry?;\n            let path = entry.path();\n            \n            if path.is_dir() \u0026\u0026 !path.ends_with(\"target\") {\n                self.scan_directory(\u0026path)?;\n            } else if path.extension().and_then(|s| s.to_str()) == Some(\"rs\") {\n                self.lint_file(\u0026path)?;\n            }\n        }\n        Ok(())\n    }\n    \n    fn lint_file(\u0026mut self, path: \u0026Path) -\u003e Result\u003c()\u003e {\n        let content = fs::read_to_string(path)?;\n        let mut violations = Vec::new();\n        \n        // Check for layer annotation\n        let has_annotation = content.lines().take(10).any(|line| \n            line.contains(\"//! L1\") || \n            line.contains(\"//! L2\") || \n            line.contains(\"//! L3\")\n        );\n        \n        if !has_annotation \u0026\u0026 path.to_string_lossy().contains(\"/haf/\") {\n            violations.push(Violation::MissingLayerAnnotation { \n                file: path.to_owned() \n            });\n        }\n        \n        // Simple pattern matching for violations\n        for (line_num, line) in content.lines().enumerate() {\n            // Check for I/O in files that might be L1\n            if path.to_string_lossy().contains(\"core\") || path.to_string_lossy().contains(\"pure\") {\n                if line.contains(\"println!\") || line.contains(\"fs::\") || line.contains(\".await\") {\n                    violations.push(Violation::SuspectedLayerViolation {\n                        file: path.to_owned(),\n                        line: line_num + 1,\n                        reason: \"Possible side effect in pure layer\".to_string(),\n                    });\n                }\n            }\n        }\n        \n        // Add violations to the linter\n        self.violations.extend(violations);\n        \n        Ok(())\n    }\n    \n    pub fn report(\u0026self) {\n        if self.violations.is_empty() {\n            println!(\"{}\", \"✓ No HAF violations found!\".green());\n            return;\n        }\n        \n        println!(\"{}\", format!(\"Found {} potential HAF violations:\", self.violations.len()).yellow());\n        println!();\n        \n        for violation in \u0026self.violations {\n            match violation {\n                Violation::MissingLayerAnnotation { file } =\u003e {\n                    println!(\"{} Missing layer annotation\", \"⚠\".yellow());\n                    println!(\"  {} {}\", \"file:\".dimmed(), file.display());\n                    println!(\"  {} Add //! L1, //! L2, or //! L3 annotation\", \"fix:\".green());\n                    println!();\n                }\n                \n                Violation::SuspectedLayerViolation { file, line, reason } =\u003e {\n                    println!(\"{} Suspected layer violation\", \"⚠\".yellow());\n                    println!(\"  {} {}:{}\", \"at:\".dimmed(), file.display(), line);\n                    println!(\"  {} {}\", \"reason:\".dimmed(), reason);\n                    println!();\n                }\n            }\n        }\n    }\n    \n    pub fn has_violations(\u0026self) -\u003e bool {\n        !self.violations.is_empty()\n    }\n}\n\n/// Run the simple linter\npub fn run_simple_linter(path: \u0026Path) -\u003e Result\u003cbool\u003e {\n    let mut linter = SimpleLinter::new();\n    \n    println!(\"{}\", \"Running simplified HAF linter...\".cyan());\n    println!();\n    \n    linter.lint_directory(path)?;\n    linter.report();\n    \n    Ok(!linter.has_violations())\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","haf_refactor.rs"],"content":"//! HAF Automated Refactoring Tool\n//! \n//! Automatically refactors existing Layer9 code to follow HAF principles\n\nuse std::path::{Path, PathBuf};\nuse std::fs;\nuse syn::{parse_file, File, Item, ItemFn, ItemStruct, ItemImpl, ItemUse, visit_mut::{self, VisitMut}};\nuse quote::quote;\nuse anyhow::{Result, Context};\nuse colored::*;\n\n/// Refactoring operation\n#[derive(Debug)]\npub enum RefactorOp {\n    /// Move function to appropriate layer\n    MoveFunction {\n        name: String,\n        from: PathBuf,\n        to_layer: Layer,\n        reason: String,\n    },\n    /// Extract side effects from function\n    ExtractSideEffects {\n        function: String,\n        file: PathBuf,\n        effects: Vec\u003cString\u003e,\n    },\n    /// Split mixed-concern struct\n    SplitStruct {\n        name: String,\n        file: PathBuf,\n        l1_fields: Vec\u003cString\u003e,\n        l2_fields: Vec\u003cString\u003e,\n        l3_fields: Vec\u003cString\u003e,\n    },\n    /// Add layer annotation\n    AddLayerAnnotation {\n        file: PathBuf,\n        layer: Layer,\n    },\n    /// Create contract for cross-layer communication\n    CreateContract {\n        from_type: String,\n        to_type: String,\n        from_layer: Layer,\n        to_layer: Layer,\n    },\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum Layer {\n    L1,\n    L2,\n    L3,\n}\n\n/// HAF Refactorer\npub struct HafRefactorer {\n    operations: Vec\u003cRefactorOp\u003e,\n    dry_run: bool,\n}\n\nimpl HafRefactorer {\n    pub fn new(dry_run: bool) -\u003e Self {\n        Self {\n            operations: Vec::new(),\n            dry_run,\n        }\n    }\n    \n    /// Analyze and refactor a directory\n    pub fn refactor_directory(\u0026mut self, dir: \u0026Path) -\u003e Result\u003c()\u003e {\n        println!(\"{}\", \"🔧 Analyzing code for HAF refactoring...\".cyan());\n        \n        self.analyze_directory(dir)?;\n        \n        if self.operations.is_empty() {\n            println!(\"{}\", \"✨ No refactoring needed - code is HAF compliant!\".green());\n            return Ok(());\n        }\n        \n        self.print_refactor_plan();\n        \n        if !self.dry_run {\n            if self.confirm_refactor()? {\n                self.execute_refactoring()?;\n            }\n        }\n        \n        Ok(())\n    }\n    \n    fn analyze_directory(\u0026mut self, dir: \u0026Path) -\u003e Result\u003c()\u003e {\n        for entry in fs::read_dir(dir)? {\n            let entry = entry?;\n            let path = entry.path();\n            \n            if path.is_dir() \u0026\u0026 !path.ends_with(\"target\") {\n                self.analyze_directory(\u0026path)?;\n            } else if path.extension().and_then(|s| s.to_str()) == Some(\"rs\") {\n                self.analyze_file(\u0026path)?;\n            }\n        }\n        Ok(())\n    }\n    \n    fn analyze_file(\u0026mut self, path: \u0026Path) -\u003e Result\u003c()\u003e {\n        let content = fs::read_to_string(path)?;\n        let syntax = parse_file(\u0026content)?;\n        \n        // Check for layer annotation\n        if !self.has_layer_annotation(\u0026content) {\n            self.operations.push(RefactorOp::AddLayerAnnotation {\n                file: path.to_owned(),\n                layer: self.infer_layer(path, \u0026syntax),\n            });\n        }\n        \n        // Analyze items\n        for item in \u0026syntax.items {\n            match item {\n                Item::Fn(func) =\u003e self.analyze_function(func, path)?,\n                Item::Struct(s) =\u003e self.analyze_struct(s, path)?,\n                Item::Impl(imp) =\u003e self.analyze_impl(imp, path)?,\n                _ =\u003e {}\n            }\n        }\n        \n        Ok(())\n    }\n    \n    fn has_layer_annotation(\u0026self, content: \u0026str) -\u003e bool {\n        content.lines().take(5).any(|line| \n            line.contains(\"//! L1\") || \n            line.contains(\"//! L2\") || \n            line.contains(\"//! L3\")\n        )\n    }\n    \n    fn infer_layer(\u0026self, path: \u0026Path, syntax: \u0026File) -\u003e Layer {\n        let path_str = path.to_string_lossy();\n        \n        // Infer from path\n        if path_str.contains(\"core\") || path_str.contains(\"model\") || path_str.contains(\"logic\") {\n            return Layer::L1;\n        }\n        if path_str.contains(\"runtime\") || path_str.contains(\"service\") {\n            return Layer::L2;\n        }\n        if path_str.contains(\"api\") || path_str.contains(\"web\") || path_str.contains(\"handler\") {\n            return Layer::L3;\n        }\n        \n        // Infer from imports\n        let mut has_io = false;\n        let mut has_web = false;\n        \n        for item in \u0026syntax.items {\n            if let Item::Use(u) = item {\n                let use_str = quote!(#u).to_string();\n                if use_str.contains(\"std::io\") || use_str.contains(\"tokio\") {\n                    has_io = true;\n                }\n                if use_str.contains(\"web_sys\") || use_str.contains(\"reqwest\") {\n                    has_web = true;\n                }\n            }\n        }\n        \n        if has_web {\n            Layer::L3\n        } else if has_io {\n            Layer::L2\n        } else {\n            Layer::L1\n        }\n    }\n    \n    fn analyze_function(\u0026mut self, func: \u0026ItemFn, path: \u0026Path) -\u003e Result\u003c()\u003e {\n        let func_str = quote!(#func).to_string();\n        let mut side_effects = Vec::new();\n        \n        // Check for I/O operations\n        if func_str.contains(\"println!\") || func_str.contains(\"eprintln!\") {\n            side_effects.push(\"Console I/O\".to_string());\n        }\n        if func_str.contains(\"fs::\") || func_str.contains(\"File::\") {\n            side_effects.push(\"File I/O\".to_string());\n        }\n        if func_str.contains(\".await\") {\n            side_effects.push(\"Async operation\".to_string());\n        }\n        if func_str.contains(\"window()\") || func_str.contains(\"document()\") {\n            side_effects.push(\"DOM manipulation\".to_string());\n        }\n        \n        // Check if function is in wrong layer\n        let current_layer = self.infer_layer(path, \u0026parse_file(\u0026fs::read_to_string(path)?)?);\n        let required_layer = if !side_effects.is_empty() {\n            if side_effects.iter().any(|s| s.contains(\"DOM\")) {\n                Layer::L3\n            } else {\n                Layer::L2\n            }\n        } else {\n            Layer::L1\n        };\n        \n        if current_layer != required_layer \u0026\u0026 current_layer == Layer::L1 {\n            self.operations.push(RefactorOp::MoveFunction {\n                name: func.sig.ident.to_string(),\n                from: path.to_owned(),\n                to_layer: required_layer,\n                reason: format!(\"Contains side effects: {:?}\", side_effects),\n            });\n        } else if !side_effects.is_empty() \u0026\u0026 current_layer == Layer::L1 {\n            self.operations.push(RefactorOp::ExtractSideEffects {\n                function: func.sig.ident.to_string(),\n                file: path.to_owned(),\n                effects: side_effects,\n            });\n        }\n        \n        Ok(())\n    }\n    \n    fn analyze_struct(\u0026mut self, s: \u0026ItemStruct, path: \u0026Path) -\u003e Result\u003c()\u003e {\n        let mut l1_fields = Vec::new();\n        let mut l2_fields = Vec::new();\n        let mut l3_fields = Vec::new();\n        \n        if let syn::Fields::Named(fields) = \u0026s.fields {\n            for field in \u0026fields.named {\n                let field_name = field.ident.as_ref().unwrap().to_string();\n                let field_type = quote!(#field.ty).to_string();\n                \n                // Categorize fields by type\n                if field_type.contains(\"Rc\u003cRefCell\") || field_type.contains(\"Arc\u003cMutex\") {\n                    l2_fields.push(field_name);\n                } else if field_type.contains(\"web_sys::\") || field_type.contains(\"JsValue\") {\n                    l3_fields.push(field_name);\n                } else {\n                    l1_fields.push(field_name);\n                }\n            }\n        }\n        \n        // If struct has mixed concerns, suggest splitting\n        let concerns = [!l1_fields.is_empty(), !l2_fields.is_empty(), !l3_fields.is_empty()]\n            .iter()\n            .filter(|\u0026\u0026x| x)\n            .count();\n            \n        if concerns \u003e 1 {\n            self.operations.push(RefactorOp::SplitStruct {\n                name: s.ident.to_string(),\n                file: path.to_owned(),\n                l1_fields,\n                l2_fields,\n                l3_fields,\n            });\n        }\n        \n        Ok(())\n    }\n    \n    fn analyze_impl(\u0026mut self, imp: \u0026ItemImpl, path: \u0026Path) -\u003e Result\u003c()\u003e {\n        // Analyze methods in impl block\n        for item in \u0026imp.items {\n            if let syn::ImplItem::Method(method) = item {\n                // Create a standalone function for analysis\n                let func = syn::ItemFn {\n                    attrs: method.attrs.clone(),\n                    vis: method.vis.clone(),\n                    sig: method.sig.clone(),\n                    block: Box::new(method.block.clone()),\n                };\n                self.analyze_function(\u0026func, path)?;\n            }\n        }\n        Ok(())\n    }\n    \n    fn print_refactor_plan(\u0026self) {\n        println!(\"\\n{}\", \"📋 Refactoring Plan:\".yellow().bold());\n        println!(\"{}\", \"=\".repeat(50).dimmed());\n        \n        for (i, op) in self.operations.iter().enumerate() {\n            println!(\"\\n{}. {}\", i + 1, self.format_operation(op));\n        }\n        \n        println!(\"\\n{}\", \"=\".repeat(50).dimmed());\n        println!(\"{}\", format!(\"Total operations: {}\", self.operations.len()).cyan());\n    }\n    \n    fn format_operation(\u0026self, op: \u0026RefactorOp) -\u003e String {\n        match op {\n            RefactorOp::MoveFunction { name, from, to_layer, reason } =\u003e {\n                format!(\n                    \"{} Move function '{}'\\n   {} {} → {:?}\\n   {} {}\",\n                    \"📦\".cyan(),\n                    name.yellow(),\n                    \"from:\".dimmed(),\n                    from.display(),\n                    to_layer,\n                    \"reason:\".dimmed(),\n                    reason\n                )\n            }\n            RefactorOp::ExtractSideEffects { function, file, effects } =\u003e {\n                format!(\n                    \"{} Extract side effects from '{}'\\n   {} {}\\n   {} {:?}\",\n                    \"🔧\".cyan(),\n                    function.yellow(),\n                    \"in:\".dimmed(),\n                    file.display(),\n                    \"effects:\".dimmed(),\n                    effects\n                )\n            }\n            RefactorOp::SplitStruct { name, file, l1_fields, l2_fields, l3_fields } =\u003e {\n                format!(\n                    \"{} Split struct '{}'\\n   {} {}\\n   {} L1: {:?}\\n   {} L2: {:?}\\n   {} L3: {:?}\",\n                    \"✂️\".cyan(),\n                    name.yellow(),\n                    \"in:\".dimmed(),\n                    file.display(),\n                    \" \".dimmed(),\n                    l1_fields,\n                    \" \".dimmed(),\n                    l2_fields,\n                    \" \".dimmed(),\n                    l3_fields\n                )\n            }\n            RefactorOp::AddLayerAnnotation { file, layer } =\u003e {\n                format!(\n                    \"{} Add layer annotation\\n   {} {}\\n   {} {:?}\",\n                    \"🏷️\".cyan(),\n                    \"to:\".dimmed(),\n                    file.display(),\n                    \"layer:\".dimmed(),\n                    layer\n                )\n            }\n            RefactorOp::CreateContract { from_type, to_type, from_layer, to_layer } =\u003e {\n                format!(\n                    \"{} Create contract\\n   {} {} ({:?}) → {} ({:?})\",\n                    \"📄\".cyan(),\n                    \"for:\".dimmed(),\n                    from_type,\n                    from_layer,\n                    to_type,\n                    to_layer\n                )\n            }\n        }\n    }\n    \n    fn confirm_refactor(\u0026self) -\u003e Result\u003cbool\u003e {\n        use dialoguer::Confirm;\n        \n        Ok(Confirm::new()\n            .with_prompt(\"Apply these refactoring operations?\")\n            .default(false)\n            .interact()?)\n    }\n    \n    fn execute_refactoring(\u0026mut self) -\u003e Result\u003c()\u003e {\n        use indicatif::{ProgressBar, ProgressStyle};\n        \n        let pb = ProgressBar::new(self.operations.len() as u64);\n        pb.set_style(\n            ProgressStyle::default_bar()\n                .template(\"[{elapsed_precise}] {bar:40.cyan/blue} {pos:\u003e7}/{len:7} {msg}\")\n                .unwrap()\n                .progress_chars(\"##-\"),\n        );\n        \n        for op in \u0026self.operations {\n            pb.set_message(format!(\"Applying: {}\", self.short_op_description(op)));\n            \n            match op {\n                RefactorOp::AddLayerAnnotation { file, layer } =\u003e {\n                    self.add_layer_annotation(file, *layer)?;\n                }\n                RefactorOp::ExtractSideEffects { function, file, effects } =\u003e {\n                    self.extract_side_effects(function, file, effects)?;\n                }\n                // Other operations would be implemented similarly\n                _ =\u003e {\n                    // For now, just log what would be done\n                    println!(\"\\n{} {}\", \"Would:\".yellow(), self.format_operation(op));\n                }\n            }\n            \n            pb.inc(1);\n        }\n        \n        pb.finish_with_message(\"Refactoring complete!\");\n        Ok(())\n    }\n    \n    fn short_op_description(\u0026self, op: \u0026RefactorOp) -\u003e String {\n        match op {\n            RefactorOp::MoveFunction { name, .. } =\u003e format!(\"Moving {}\", name),\n            RefactorOp::ExtractSideEffects { function, .. } =\u003e format!(\"Extracting from {}\", function),\n            RefactorOp::SplitStruct { name, .. } =\u003e format!(\"Splitting {}\", name),\n            RefactorOp::AddLayerAnnotation { .. } =\u003e \"Adding annotation\".to_string(),\n            RefactorOp::CreateContract { .. } =\u003e \"Creating contract\".to_string(),\n        }\n    }\n    \n    fn add_layer_annotation(\u0026self, file: \u0026Path, layer: Layer) -\u003e Result\u003c()\u003e {\n        let content = fs::read_to_string(file)?;\n        let annotation = match layer {\n            Layer::L1 =\u003e \"//! L1: Core - Pure business logic\\n\",\n            Layer::L2 =\u003e \"//! L2: Runtime - Execution environment\\n\",\n            Layer::L3 =\u003e \"//! L3: Framework - External interfaces\\n\",\n        };\n        \n        let new_content = format!(\"{}\\n{}\", annotation, content);\n        fs::write(file, new_content)?;\n        \n        Ok(())\n    }\n    \n    fn extract_side_effects(\u0026self, function: \u0026str, file: \u0026Path, effects: \u0026[String]) -\u003e Result\u003c()\u003e {\n        let content = fs::read_to_string(file)?;\n        let mut syntax = parse_file(\u0026content)?;\n        \n        let mut extractor = SideEffectExtractor {\n            function_name: function.to_string(),\n            effects: effects.to_vec(),\n        };\n        \n        extractor.visit_file_mut(\u0026mut syntax);\n        \n        let new_content = quote!(#syntax).to_string();\n        fs::write(file, new_content)?;\n        \n        Ok(())\n    }\n}\n\n/// AST visitor for extracting side effects\nstruct SideEffectExtractor {\n    function_name: String,\n    effects: Vec\u003cString\u003e,\n}\n\nimpl VisitMut for SideEffectExtractor {\n    fn visit_item_fn_mut(\u0026mut self, func: \u0026mut ItemFn) {\n        if func.sig.ident == self.function_name {\n            // Create pure version and effect version\n            let pure_name = format!(\"{}_pure\", self.function_name);\n            let effect_name = format!(\"{}_effects\", self.function_name);\n            \n            // This is a simplified version - real implementation would\n            // properly extract side effects into separate functions\n            \n            // Add comment explaining the refactoring\n            func.attrs.push(syn::parse_quote! {\n                #[doc = \"TODO: This function has been marked for side effect extraction\"]\n            });\n        }\n        \n        visit_mut::visit_item_fn_mut(self, func);\n    }\n}\n\n/// Run the HAF refactorer\npub fn run_refactorer(path: \u0026Path, dry_run: bool) -\u003e Result\u003c()\u003e {\n    let mut refactorer = HafRefactorer::new(dry_run);\n    refactorer.refactor_directory(path)?;\n    Ok(())\n}\n\n/// Generate refactoring suggestions for a specific file\npub fn suggest_refactoring(file: \u0026Path) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n    let mut refactorer = HafRefactorer::new(true);\n    refactorer.analyze_file(file)?;\n    \n    let suggestions = refactorer.operations.iter()\n        .map(|op| refactorer.format_operation(op))\n        .collect();\n    \n    Ok(suggestions)\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","src","main.rs"],"content":"//! Layer9 CLI - Development tools\n\nmod deploy;\n// mod haf_lint;\n// mod haf_gen;\n// mod haf_refactor;\nmod haf_lint_simple;\n\nuse anyhow::{Context, Result};\nuse clap::{Parser, Subcommand};\nuse colored::*;\nuse std::path::PathBuf;\n\n#[derive(Parser)]\n#[command(name = \"layer9\")]\n#[command(about = \"Layer9 - Web Architecture Rust Platform\", long_about = None)]\nstruct Cli {\n    #[command(subcommand)]\n    command: Commands,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    /// Create a new Layer9 project\n    New {\n        /// Project name\n        name: String,\n\n        /// Template to use\n        #[arg(short, long, default_value = \"default\")]\n        template: String,\n    },\n\n    /// Start development server\n    Dev {\n        /// Port to run on\n        #[arg(short, long, default_value = \"3000\")]\n        port: u16,\n\n        /// Enable hot reload\n        #[arg(short, long, default_value = \"true\")]\n        hot: bool,\n\n        /// Open browser automatically\n        #[arg(short, long)]\n        open: bool,\n    },\n\n    /// Build for production\n    Build {\n        /// Build mode\n        #[arg(short, long, default_value = \"production\")]\n        mode: String,\n\n        /// Output directory\n        #[arg(short, long, default_value = \"dist\")]\n        output: PathBuf,\n\n        /// Enable SSG\n        #[arg(long)]\n        ssg: bool,\n    },\n\n    /// Deploy to production\n    Deploy {\n        /// Target platform (vercel, netlify, aws, cloudflare)\n        #[arg(short, long, default_value = \"vercel\")]\n        target: String,\n        \n        /// Environment to deploy to\n        #[arg(short, long, default_value = \"production\")]\n        env: String,\n        \n        /// Build directory\n        #[arg(short, long, default_value = \"dist\")]\n        build_dir: PathBuf,\n        \n        /// Configuration file\n        #[arg(short, long)]\n        config: Option\u003cPathBuf\u003e,\n        \n        /// Force deployment without confirmation\n        #[arg(short, long)]\n        force: bool,\n        \n        /// Show deployment logs\n        #[arg(short = 'v', long)]\n        verbose: bool,\n    },\n    \n    /// Check deployment status\n    DeployStatus {\n        /// Deployment ID\n        deployment_id: String,\n        \n        /// Platform\n        #[arg(short, long, default_value = \"vercel\")]\n        platform: String,\n    },\n    \n    /// List recent deployments\n    DeployList {\n        /// Platform\n        #[arg(short, long, default_value = \"vercel\")]\n        platform: String,\n        \n        /// Number of deployments to show\n        #[arg(short, long, default_value = \"10\")]\n        limit: usize,\n    },\n    \n    /// Rollback to previous deployment\n    DeployRollback {\n        /// Deployment ID to rollback to\n        deployment_id: String,\n        \n        /// Platform\n        #[arg(short, long, default_value = \"vercel\")]\n        platform: String,\n    },\n    \n    /// Generate deployment configuration\n    DeployInit {\n        /// Generate example environment file\n        #[arg(long)]\n        env_example: bool,\n    },\n\n    /// Run type checking\n    Check,\n\n    /// Format code\n    Fmt,\n\n    /// Run HAF architectural linter\n    HafLint {\n        /// Path to lint (defaults to current directory)\n        #[arg(default_value = \".\")]\n        path: PathBuf,\n        \n        /// Fail with exit code 1 if violations found\n        #[arg(long)]\n        strict: bool,\n    },\n    \n    /// Generate HAF-compliant project structure\n    HafNew {\n        /// Project name\n        name: String,\n    },\n    \n    /// Automatically refactor code to follow HAF principles\n    HafRefactor {\n        /// Path to refactor (defaults to current directory)\n        #[arg(default_value = \".\")]\n        path: PathBuf,\n        \n        /// Show what would be done without making changes\n        #[arg(long)]\n        dry_run: bool,\n    },\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    let cli = Cli::parse();\n\n    match cli.command {\n        Commands::New { name, template } =\u003e {\n            new_project(\u0026name, \u0026template).await?;\n        }\n        Commands::Dev { port, hot, open } =\u003e {\n            dev_server(port, hot, open).await?;\n        }\n        Commands::Build { mode, output, ssg } =\u003e {\n            build_project(\u0026mode, \u0026output, ssg).await?;\n        }\n        Commands::Deploy { target, env, build_dir, config, force, verbose } =\u003e {\n            let platform = target.parse()?;\n            let options = deploy::DeployOptions {\n                platform,\n                build_dir,\n                environment: env,\n                config_path: config,\n                force,\n                verbose,\n            };\n            deploy::deploy(options).await?;\n        }\n        Commands::DeployStatus { deployment_id, platform } =\u003e {\n            let platform = platform.parse()?;\n            let status = deploy::get_status(platform, \u0026deployment_id).await?;\n            println!(\"Deployment Status: {}\", status);\n        }\n        Commands::DeployList { platform, limit } =\u003e {\n            let platform = platform.parse()?;\n            let deployments = deploy::list_deployments(platform, limit).await?;\n            \n            println!(\"{}\", \"Recent Deployments:\".bright_blue().bold());\n            for (i, deploy) in deployments.iter().enumerate() {\n                println!(\n                    \"{}. {} - {} - {}\",\n                    i + 1,\n                    deploy.deployment_id.bright_black(),\n                    deploy.status,\n                    deploy.url.cyan()\n                );\n            }\n        }\n        Commands::DeployRollback { deployment_id, platform } =\u003e {\n            let platform = platform.parse()?;\n            deploy::rollback(platform, \u0026deployment_id).await?;\n        }\n        Commands::DeployInit { env_example } =\u003e {\n            if env_example {\n                generate_env_example().await?;\n            } else {\n                generate_deploy_config().await?;\n            }\n        }\n        Commands::Check =\u003e {\n            check_project().await?;\n        }\n        Commands::Fmt =\u003e {\n            format_project().await?;\n        }\n        Commands::HafLint { path, strict } =\u003e {\n            // Use simple linter for now due to syn version issues\n            let success = haf_lint_simple::run_simple_linter(\u0026path)?;\n            if strict \u0026\u0026 !success {\n                std::process::exit(1);\n            }\n        }\n        Commands::HafNew { name } =\u003e {\n            // haf_gen::generate_haf_project(\u0026name)?;\n            \n            println!(\"{}\", \"HAF project generator temporarily disabled\".yellow());\n            println!(\"Project name: {}\", name);\n        }\n        Commands::HafRefactor { path, dry_run } =\u003e {\n            // haf_refactor::run_refactorer(\u0026path, dry_run)?;\n            println!(\"{}\", \"HAF refactorer temporarily disabled\".yellow());\n            println!(\"Path: {}, dry-run: {}\", path.display(), dry_run);\n        }\n    }\n\n    Ok(())\n}\n\n/// Create new project\nasync fn new_project(name: \u0026str, template: \u0026str) -\u003e Result\u003c()\u003e {\n    use dialoguer::{theme::ColorfulTheme, Select};\n    use indicatif::{ProgressBar, ProgressStyle};\n\n    println!(\n        \"{}\",\n        \"🚀 Creating new Layer9 project...\".bright_blue().bold()\n    );\n\n    // Select template if not specified\n    let template = if template == \"default\" {\n        let templates = vec![\n            \"minimal\", \n            \"dashboard\", \n            \"full-stack\", \n            \"static-site\",\n            \"haf-minimal\",\n            \"haf-full\"\n        ];\n        let selection = Select::with_theme(\u0026ColorfulTheme::default())\n            .with_prompt(\"Select a template\")\n            .items(\u0026templates)\n            .default(0)\n            .interact()?;\n        templates[selection]\n    } else {\n        template\n    };\n\n    let pb = ProgressBar::new(5);\n    pb.set_style(\n        ProgressStyle::default_bar()\n            .template(\"[{elapsed_precise}] {bar:40.cyan/blue} {pos:\u003e7}/{len:7} {msg}\")\n            .unwrap()\n            .progress_chars(\"##-\"),\n    );\n\n    // Create project directory\n    pb.set_message(\"Creating directory\");\n    std::fs::create_dir_all(name)?;\n    pb.inc(1);\n\n    // Generate Cargo.toml\n    pb.set_message(\"Generating Cargo.toml\");\n    let cargo_toml = format!(\n        r#\"[package]\nname = \"{}\"\nversion = \"0.1.0\"\nedition = \"2021\"\n\n[lib]\ncrate-type = [\"cdylib\", \"rlib\"]\n\n[dependencies]\nlayer9-framework = \"0.1\"\nwasm-bindgen = \"0.2\"\nweb-sys = \"0.3\"\nconsole_error_panic_hook = \"0.1\"\n\n[profile.release]\nopt-level = \"z\"\nlto = true\n\"#,\n        name.replace('-', \"_\")\n    );\n    std::fs::write(format!(\"{}/Cargo.toml\", name), cargo_toml)?;\n    pb.inc(1);\n\n    // Create src directory\n    pb.set_message(\"Creating source files\");\n    std::fs::create_dir_all(format!(\"{}/src\", name))?;\n\n    // Generate main.rs based on template\n    let main_rs = match template {\n        \"minimal\" =\u003e include_str!(\"../templates/minimal.rs\"),\n        \"dashboard\" =\u003e include_str!(\"../templates/dashboard.rs\"),\n        \"full-stack\" =\u003e include_str!(\"../templates/fullstack.rs\"),\n        \"haf-minimal\" =\u003e include_str!(\"../templates/haf-minimal.rs\"),\n        \"haf-full\" =\u003e include_str!(\"../templates/haf-full.rs\"),\n        _ =\u003e include_str!(\"../templates/minimal.rs\"),\n    };\n    std::fs::write(format!(\"{}/src/lib.rs\", name), main_rs)?;\n    pb.inc(1);\n\n    // Create layer9.toml config\n    pb.set_message(\"Creating configuration\");\n    let layer9_toml = r#\"[project]\nname = \"{name}\"\nversion = \"0.1.0\"\n\n[build]\ntarget = \"web\"\noutput = \"dist\"\n\n[dev]\nport = 3000\nhot_reload = true\n\n[deploy]\nplatform = \"vercel\"\n\"#;\n    std::fs::write(format!(\"{}/layer9.toml\", name), layer9_toml)?;\n    pb.inc(1);\n\n    // Create .gitignore\n    pb.set_message(\"Setting up git\");\n    let gitignore = r#\"/target\n/dist\n/pkg\nCargo.lock\n.DS_Store\n*.wasm\n\"#;\n    std::fs::write(format!(\"{}/.gitignore\", name), gitignore)?;\n    pb.inc(1);\n\n    pb.finish_with_message(\"Done!\");\n\n    println!(\"\\n{}\", \"✨ Project created successfully!\".green().bold());\n    println!(\"\\nTo get started:\");\n    println!(\"  {}\", format!(\"cd {}\", name).bright_black());\n    println!(\"  {}\", \"layer9 dev\".bright_black());\n\n    Ok(())\n}\n\n/// Start development server\nasync fn dev_server(port: u16, hot: bool, open: bool) -\u003e Result\u003c()\u003e {\n    use axum::{routing::get, Router};\n    use notify::{Event, RecursiveMode, Watcher};\n    use std::sync::mpsc;\n    use tower_http::services::ServeDir;\n    use tower_livereload::LiveReloadLayer;\n\n    println!(\n        \"{}\",\n        \"🔧 Starting Layer9 development server...\"\n            .bright_blue()\n            .bold()\n    );\n\n    // Check if wasm-pack is installed\n    if which::which(\"wasm-pack\").is_err() {\n        println!(\"{}\", \"⚠️  wasm-pack not found. Installing...\".yellow());\n        std::process::Command::new(\"curl\")\n            .args([\n                \"https://rustwasm.github.io/wasm-pack/installer/init.sh\",\n                \"-sSf\",\n            ])\n            .stdout(std::process::Stdio::piped())\n            .spawn()?\n            .wait()?;\n    }\n\n    // Initial build\n    println!(\"{}\", \"📦 Building WASM bundle...\".cyan());\n    build_wasm()?;\n\n    // Setup file watcher for hot reload\n    let (tx, rx) = mpsc::channel();\n    let mut watcher = notify::recommended_watcher(move |res: Result\u003cEvent, _\u003e| {\n        if let Ok(event) = res {\n            if event.paths.iter().any(|p| {\n                p.extension()\n                    .is_some_and(|ext| ext == \"rs\" || ext == \"toml\")\n            }) {\n                let _ = tx.send(());\n            }\n        }\n    })?;\n    watcher.watch(std::path::Path::new(\"src\"), RecursiveMode::Recursive)?;\n\n    // Spawn rebuild task\n    if hot {\n        tokio::spawn(async move {\n            while rx.recv().is_ok() {\n                println!(\"{}\", \"🔄 Detected changes, rebuilding...\".yellow());\n                if let Err(e) = build_wasm() {\n                    eprintln!(\"{}\", format!(\"❌ Build error: {}\", e).red());\n                } else {\n                    println!(\"{}\", \"✅ Rebuild complete!\".green());\n                }\n            }\n        });\n    }\n\n    // Create router\n    let app = if hot {\n        Router::new()\n            .route(\"/\", get(serve_index))\n            .nest_service(\"/pkg\", ServeDir::new(\"pkg\"))\n            .layer(LiveReloadLayer::new())\n    } else {\n        Router::new()\n            .route(\"/\", get(serve_index))\n            .nest_service(\"/pkg\", ServeDir::new(\"pkg\"))\n    };\n\n    // Start server\n    let addr = format!(\"0.0.0.0:{}\", port);\n    println!(\n        \"{}\",\n        format!(\"🌐 Server running at http://localhost:{}\", port)\n            .green()\n            .bold()\n    );\n\n    if open {\n        if let Err(e) = webbrowser::open(\u0026format!(\"http://localhost:{}\", port)) {\n            eprintln!(\"Failed to open browser: {}\", e);\n        }\n    }\n\n    println!(\"\\n{}\", \"Press Ctrl+C to stop\".bright_black());\n\n    let listener = tokio::net::TcpListener::bind(\u0026addr).await?;\n    axum::serve(listener, app).await?;\n\n    Ok(())\n}\n\n/// Build WASM bundle\nfn build_wasm() -\u003e Result\u003c()\u003e {\n    let output = std::process::Command::new(\"wasm-pack\")\n        .args([\"build\", \"--target\", \"web\", \"--out-dir\", \"pkg\"])\n        .output()\n        .context(\"Failed to run wasm-pack\")?;\n\n    if !output.status.success() {\n        return Err(anyhow::anyhow!(\n            \"Build failed:\\n{}\",\n            String::from_utf8_lossy(\u0026output.stderr)\n        ));\n    }\n\n    Ok(())\n}\n\n/// Serve index.html\nasync fn serve_index() -\u003e axum::response::Html\u003cString\u003e {\n    let html = r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n    \u003ctitle\u003eLayer9 Dev Server\u003c/title\u003e\n    \u003cstyle\u003e\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background: #000;\n            color: #fff;\n            margin: 0;\n            padding: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            min-height: 100vh;\n        }\n        #layer9-root { width: 100%; }\n        .loading {\n            text-align: center;\n            padding: 2rem;\n        }\n        .error {\n            background: rgba(239, 68, 68, 0.1);\n            border: 1px solid rgba(239, 68, 68, 0.3);\n            padding: 2rem;\n            border-radius: 0.5rem;\n            margin: 2rem;\n        }\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv id=\"layer9-root\"\u003e\n        \u003cdiv class=\"loading\"\u003e\n            \u003ch1\u003eLoading Layer9...\u003c/h1\u003e\n            \u003cp\u003eInitializing application...\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n    \u003cscript type=\"module\"\u003e\n        import init from './pkg/layer9_app.js';\n        \n        init().catch(err =\u003e {\n            document.getElementById('layer9-root').innerHTML = `\n                \u003cdiv class=\"error\"\u003e\n                    \u003ch2\u003eFailed to load application\u003c/h2\u003e\n                    \u003cpre\u003e${err.message}\u003c/pre\u003e\n                \u003c/div\u003e\n            `;\n        });\n    \u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\"#;\n\n    axum::response::Html(html.to_string())\n}\n\n/// Build for production\nasync fn build_project(mode: \u0026str, output: \u0026PathBuf, ssg: bool) -\u003e Result\u003c()\u003e {\n    use indicatif::{ProgressBar, ProgressStyle};\n\n    println!(\"{}\", \"📦 Building for production...\".bright_blue().bold());\n\n    let pb = ProgressBar::new(4);\n    pb.set_style(\n        ProgressStyle::default_bar()\n            .template(\"[{elapsed_precise}] {bar:40.cyan/blue} {pos:\u003e7}/{len:7} {msg}\")\n            .unwrap()\n            .progress_chars(\"##-\"),\n    );\n\n    // Clean output directory\n    pb.set_message(\"Cleaning output directory\");\n    if output.exists() {\n        std::fs::remove_dir_all(output)?;\n    }\n    std::fs::create_dir_all(output)?;\n    pb.inc(1);\n\n    // Build WASM with optimizations\n    pb.set_message(\"Building optimized WASM\");\n    let args = if mode == \"production\" {\n        vec![\n            \"build\",\n            \"--target\",\n            \"web\",\n            \"--out-dir\",\n            output.to_str().unwrap(),\n            \"--release\",\n        ]\n    } else {\n        vec![\n            \"build\",\n            \"--target\",\n            \"web\",\n            \"--out-dir\",\n            output.to_str().unwrap(),\n        ]\n    };\n\n    let output_cmd = std::process::Command::new(\"wasm-pack\")\n        .args(args)\n        .output()?;\n\n    if !output_cmd.status.success() {\n        return Err(anyhow::anyhow!(\n            \"Build failed:\\n{}\",\n            String::from_utf8_lossy(\u0026output_cmd.stderr)\n        ));\n    }\n    pb.inc(1);\n\n    // Optimize WASM size\n    pb.set_message(\"Optimizing bundle size\");\n    if mode == \"production\" \u0026\u0026 which::which(\"wasm-opt\").is_ok() {\n        let wasm_file = output.join(\"layer9_app_bg.wasm\");\n        std::process::Command::new(\"wasm-opt\")\n            .args([\n                \"-Oz\",\n                \"-o\",\n                wasm_file.to_str().unwrap(),\n                wasm_file.to_str().unwrap(),\n            ])\n            .output()?;\n    }\n    pb.inc(1);\n\n    // Generate static pages if SSG enabled\n    if ssg {\n        pb.set_message(\"Generating static pages\");\n        // TODO: Implement SSG generation\n        pb.inc(1);\n    } else {\n        pb.inc(1);\n    }\n\n    pb.finish_with_message(\"Build complete!\");\n\n    // Print bundle size\n    let wasm_size = std::fs::metadata(output.join(\"layer9_app_bg.wasm\"))?.len();\n    let js_size = std::fs::metadata(output.join(\"layer9_app.js\"))?.len();\n\n    println!(\"\\n{}\", \"📊 Bundle Analysis:\".green().bold());\n    println!(\"  WASM: {}\", format_size(wasm_size));\n    println!(\"  JS:   {}\", format_size(js_size));\n    println!(\"  Total: {}\", format_size(wasm_size + js_size));\n\n    Ok(())\n}\n\n/// Generate deployment configuration file\nasync fn generate_deploy_config() -\u003e Result\u003c()\u003e {\n    use dialoguer::Confirm;\n    \n    println!(\"{}\", \"🔧 Generating deployment configuration...\".bright_blue().bold());\n    \n    let config_path = PathBuf::from(\"layer9.deploy.toml\");\n    \n    if config_path.exists() {\n        if !Confirm::new()\n            .with_prompt(\"layer9.deploy.toml already exists. Overwrite?\")\n            .default(false)\n            .interact()?\n        {\n            println!(\"{}\", \"Cancelled\".yellow());\n            return Ok(());\n        }\n    }\n    \n    std::fs::write(\u0026config_path, deploy::config::EXAMPLE_CONFIG)?;\n    \n    println!(\"{}\", \"✅ Created layer9.deploy.toml\".green().bold());\n    println!(\"Edit this file to configure your deployment settings.\");\n    println!(\"Don't forget to set up your API tokens in .env!\");\n    \n    Ok(())\n}\n\n/// Generate .env.example file\nasync fn generate_env_example() -\u003e Result\u003c()\u003e {\n    println!(\"{}\", \"📝 Generating .env.example...\".bright_blue().bold());\n    \n    let config = deploy::config::DeployConfig::from_project_root()\n        .unwrap_or_default();\n    \n    let example = deploy::environment::generate_env_example(\u0026config)?;\n    std::fs::write(\".env.example\", example)?;\n    \n    println!(\"{}\", \"✅ Created .env.example\".green().bold());\n    println!(\"Copy this file to .env and fill in your secrets.\");\n    \n    Ok(())\n}\n\n/// Check project\nasync fn check_project() -\u003e Result\u003c()\u003e {\n    println!(\"{}\", \"🔍 Running type check...\".bright_blue().bold());\n\n    let output = std::process::Command::new(\"cargo\")\n        .args([\"check\"])\n        .output()?;\n\n    if !output.status.success() {\n        eprintln!(\"{}\", String::from_utf8_lossy(\u0026output.stderr));\n        return Err(anyhow::anyhow!(\"Type check failed\"));\n    }\n\n    println!(\"{}\", \"✅ All checks passed!\".green().bold());\n    Ok(())\n}\n\n/// Format project\nasync fn format_project() -\u003e Result\u003c()\u003e {\n    println!(\"{}\", \"🎨 Formatting code...\".bright_blue().bold());\n\n    let output = std::process::Command::new(\"cargo\")\n        .args([\"fmt\"])\n        .output()?;\n\n    if !output.status.success() {\n        return Err(anyhow::anyhow!(\"Format failed\"));\n    }\n\n    println!(\"{}\", \"✅ Code formatted!\".green().bold());\n    Ok(())\n}\n\n/// Format file size\nfn format_size(bytes: u64) -\u003e String {\n    const UNITS: \u0026[\u0026str] = \u0026[\"B\", \"KB\", \"MB\", \"GB\"];\n    let mut size = bytes as f64;\n    let mut unit_index = 0;\n\n    while size \u003e= 1024.0 \u0026\u0026 unit_index \u003c UNITS.len() - 1 {\n        size /= 1024.0;\n        unit_index += 1;\n    }\n\n    format!(\"{:.2} {}\", size, UNITS[unit_index])\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","templates","dashboard.rs"],"content":"//! Dashboard Layer9 Application\n\nuse layer9_framework::prelude::*;\nuse wasm_bindgen::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n// Global state\nstatic APP_STORE: Lazy\u003cReducerStore\u003cAppState, AppAction\u003e\u003e = Lazy::new(|| {\n    create_app_store()\n});\n\n// Define your app\n#[wasm_bindgen]\npub struct App;\n\nimpl WarpApp for App {\n    fn routes(\u0026self) -\u003e Vec\u003cRoute\u003e {\n        vec![\n            Route {\n                path: \"/\".to_string(),\n                handler: RouteHandler::Page(|| {\n                    Page::new()\n                        .title(\"Dashboard\")\n                        .component(DashboardPage)\n                }),\n            },\n            Route {\n                path: \"/settings\".to_string(),\n                handler: RouteHandler::Page(|| {\n                    Page::new()\n                        .title(\"Settings\")\n                        .component(SettingsPage)\n                }),\n            },\n        ]\n    }\n    \n    fn initialize(\u0026self) {\n        inject_global_styles();\n        \n        // Initialize router\n        let config = RouterConfig {\n            routes: vec![\n                route(\"/\", |_| Box::new(DashboardPage)),\n                route(\"/settings\", |_| Box::new(SettingsPage)),\n                route(\"/profile/:id\", |params| Box::new(ProfilePage { \n                    id: params.params.get(\"id\").cloned().unwrap_or_default() \n                })),\n            ],\n            not_found: Box::new(NotFoundPage),\n        };\n        \n        init_router(config).expect(\"Failed to initialize router\");\n    }\n}\n\nimpl L8::Architecture for App {\n    type App = DashboardApp;\n    \n    fn design() -\u003e L8::ArchitectureDesign {\n        L8::ArchitectureDesign {\n            layers: vec![\n                Layer::L1Infrastructure,\n                Layer::L4Services,\n                Layer::L5Components,\n                Layer::L6Features,\n                Layer::L7Application,\n            ],\n            boundaries: vec![],\n        }\n    }\n}\n\n// Dashboard page\nstruct DashboardPage;\n\nimpl Component for DashboardPage {\n    fn render(\u0026self) -\u003e Element {\n        let (state, dispatch) = use_reducer(\u0026APP_STORE);\n        let stats = use_swr::\u003cDashboardStats\u003e(\"/api/stats\");\n        \n        view! {\n            \u003cdiv class=\"dashboard\"\u003e\n                \u003cHeader /\u003e\n                \n                \u003cdiv class=\"stats-grid\"\u003e\n                    {if stats.is_loading() {\n                        view! { \u003cdiv\u003e\"Loading stats...\"\u003c/div\u003e }\n                    } else if let Some(data) = stats.data() {\n                        view! {\n                            \u003cdiv\u003e\n                                {StatCard::new(\"Total Users\", \u0026data.users.to_string()).render()}\n                                {StatCard::new(\"Revenue\", \u0026format!(\"${}\", data.revenue)).render()}\n                                {StatCard::new(\"Active Sessions\", \u0026data.sessions.to_string()).render()}\n                            \u003c/div\u003e\n                        }\n                    } else {\n                        view! { \u003cdiv\u003e\"Failed to load stats\"\u003c/div\u003e }\n                    }}\n                \u003c/div\u003e\n                \n                \u003cdiv class=\"content\"\u003e\n                    \u003cCard::new()\n                        .children(vec![\n                            view! { \u003ch2\u003e\"Recent Activity\"\u003c/h2\u003e },\n                            view! { \u003cActivityList /\u003e },\n                        ])\n                        .render()\n                \u003c/div\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Header component\nstruct Header;\n\nimpl Component for Header {\n    fn render(\u0026self) -\u003e Element {\n        let auth = use_auth();\n        \n        let header_style = style![\n            flex,\n            justify_between,\n            items_center,\n            p(4),\n            border,\n            border_gray_200,\n            mb(6),\n        ];\n        \n        view! {\n            \u003cheader style={header_style.build()}\u003e\n                \u003ch1\u003e\"Layer9 Dashboard\"\u003c/h1\u003e\n                \n                \u003cnav\u003e\n                    {Link::new(\"/\")\n                        .children(vec![view! { \"Dashboard\" }])\n                        .render()}\n                    {Link::new(\"/settings\")\n                        .children(vec![view! { \"Settings\" }])\n                        .render()}\n                \u003c/nav\u003e\n                \n                \u003cdiv class=\"user-menu\"\u003e\n                    {if let Some(user) = auth.user {\n                        view! {\n                            \u003cdiv\u003e\n                                {Avatar::new()\n                                    .src(user.image.as_deref().unwrap_or_default())\n                                    .fallback(\u0026user.name[0..1])\n                                    .render()}\n                                \u003cspan\u003e{user.name}\u003c/span\u003e\n                            \u003c/div\u003e\n                        }\n                    } else {\n                        Button::new(\"Login\")\n                            .variant(ButtonVariant::Primary)\n                            .render()\n                    }}\n                \u003c/div\u003e\n            \u003c/header\u003e\n        }\n    }\n}\n\n// Settings page\nstruct SettingsPage;\n\nimpl Component for SettingsPage {\n    fn render(\u0026self) -\u003e Element {\n        let (state, dispatch) = use_reducer(\u0026APP_STORE);\n        \n        view! {\n            \u003cdiv class=\"settings\"\u003e\n                \u003cHeader /\u003e\n                \n                \u003cCard::new()\n                    .children(vec![\n                        view! { \u003ch2\u003e\"Settings\"\u003c/h2\u003e },\n                        \n                        view! {\n                            \u003cdiv class=\"setting-item\"\u003e\n                                \u003clabel\u003e\"Theme\"\u003c/label\u003e\n                                {Button::new(\"Toggle Theme\")\n                                    .on_click(move || dispatch(AppAction::ToggleTheme))\n                                    .render()}\n                            \u003c/div\u003e\n                        },\n                    ])\n                    .render()\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Profile page with params\nstruct ProfilePage {\n    id: String,\n}\n\nimpl Component for ProfilePage {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cdiv\u003e\n                \u003cHeader /\u003e\n                \u003ch1\u003e\"Profile: \"{\u0026self.id}\u003c/h1\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Not found page\nstruct NotFoundPage;\n\nimpl Component for NotFoundPage {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cdiv class=\"not-found\"\u003e\n                \u003ch1\u003e\"404\"\u003c/h1\u003e\n                \u003cp\u003e\"Page not found\"\u003c/p\u003e\n                {Link::new(\"/\")\n                    .children(vec![view! { \"Go home\" }])\n                    .render()}\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Activity list component\nstruct ActivityList;\n\nimpl Component for ActivityList {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cul class=\"activity-list\"\u003e\n                \u003cli\u003e\"User signed up\"\u003c/li\u003e\n                \u003cli\u003e\"Payment received\"\u003c/li\u003e\n                \u003cli\u003e\"New feature deployed\"\u003c/li\u003e\n            \u003c/ul\u003e\n        }\n    }\n}\n\n// Stat card component\nstruct StatCard {\n    title: String,\n    value: String,\n}\n\nimpl StatCard {\n    fn new(title: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) -\u003e Self {\n        StatCard {\n            title: title.into(),\n            value: value.into(),\n        }\n    }\n}\n\nimpl Component for StatCard {\n    fn render(\u0026self) -\u003e Element {\n        Card::new()\n            .children(vec![\n                view! { \u003ch3\u003e{\u0026self.title}\u003c/h3\u003e },\n                view! { \u003cdiv class=\"stat-value\"\u003e{\u0026self.value}\u003c/div\u003e },\n            ])\n            .render()\n    }\n}\n\n// Data structures\n#[derive(Serialize, Deserialize)]\nstruct DashboardStats {\n    users: u32,\n    revenue: u32,\n    sessions: u32,\n}\n\n// Dashboard app type\nstruct DashboardApp;\nimpl L7::Application for DashboardApp {\n    type State = AppState;\n    type Action = AppAction;\n    \n    fn reduce(state: \u0026Self::State, action: Self::Action) -\u003e Self::State {\n        APP_STORE.dispatch(action);\n        state.clone()\n    }\n}\n\n// Hooks\nfn use_swr\u003cT: Clone + for\u003c'de\u003e Deserialize\u003c'de\u003e + 'static\u003e(url: \u0026str) -\u003e SWR\u003cT\u003e {\n    SWR::new(url)\n}\n\n// Re-exports\nuse once_cell::sync::Lazy;\n\n// Entry point\n#[wasm_bindgen(start)]\npub fn main() {\n    run_app(App);\n}","traces":[{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":5},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","templates","fullstack.rs"],"content":"//! Full-Stack Layer9 Application with SSR\n\nuse layer9_framework::prelude::*;\nuse wasm_bindgen::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n// Define your app\n#[wasm_bindgen]\npub struct App;\n\nimpl WarpApp for App {\n    fn routes(\u0026self) -\u003e Vec\u003cRoute\u003e {\n        vec![\n            Route {\n                path: \"/\".to_string(),\n                handler: RouteHandler::Page(|| {\n                    Page::new()\n                        .title(\"Full-Stack Layer9\")\n                        .component(HomePage)\n                }),\n            },\n            Route {\n                path: \"/api/todos\".to_string(),\n                handler: RouteHandler::Api(|| {\n                    // This would be handled server-side\n                    JsValue::from_str(r#\"{\"todos\": []}\"#)\n                }),\n            },\n        ]\n    }\n    \n    fn initialize(\u0026self) {\n        inject_global_styles();\n        \n        // Initialize router with SSR support\n        let config = RouterConfig {\n            routes: vec![\n                route(\"/\", |_| Box::new(HomePage)),\n                route(\"/todos\", |_| Box::new(TodosPage)),\n                route(\"/about\", |_| Box::new(AboutPage)),\n            ],\n            not_found: Box::new(NotFoundPage),\n        };\n        \n        init_router(config).expect(\"Failed to initialize router\");\n    }\n}\n\nimpl L8::Architecture for App {\n    type App = FullStackApp;\n    \n    fn design() -\u003e L8::ArchitectureDesign {\n        L8::ArchitectureDesign {\n            layers: vec![\n                Layer::L1Infrastructure,\n                Layer::L2Platform,\n                Layer::L3Runtime,\n                Layer::L4Services,\n                Layer::L5Components,\n                Layer::L6Features,\n                Layer::L7Application,\n                Layer::L8Architecture,\n            ],\n            boundaries: vec![],\n        }\n    }\n}\n\n// SSR support\nimpl SSRApp for App {\n    fn html_template(\u0026self) -\u003e \u0026'static str {\n        r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n    \u003ctitle\u003e{title}\u003c/title\u003e\n    \u003cmeta name=\"description\" content=\"Full-Stack Layer9 Application\"\u003e\n    \u003cstyle\u003e{styles}\u003c/style\u003e\n    \u003cscript\u003ewindow.__Layer9_PROPS__ = {props};\u003c/script\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv id=\"layer9-root\"\u003e{content}\u003c/div\u003e\n    \u003cscript type=\"module\"\u003e\n        import init, { hydrate_app } from '/layer9_bundle.js';\n        init().then(() =\u003e {\n            hydrate_app();\n        });\n    \u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\"#\n    }\n}\n\n// Home page with server data\nstruct HomePage;\n\nimpl Component for HomePage {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cdiv class=\"home\"\u003e\n                \u003cNavigation /\u003e\n                \n                \u003cmain\u003e\n                    \u003cHero /\u003e\n                    \u003cFeatures /\u003e\n                    \u003cTodoSection /\u003e\n                \u003c/main\u003e\n                \n                \u003cFooter /\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\nimpl SSRComponent for HomePage {\n    async fn get_server_props(ctx: \u0026SSRContext) -\u003e Result\u003cserde_json::Value, String\u003e {\n        // Fetch data on server\n        Ok(serde_json::json!({\n            \"featured_todos\": [\n                {\"id\": 1, \"text\": \"Build with Layer9\", \"done\": false},\n                {\"id\": 2, \"text\": \"Deploy to production\", \"done\": false},\n            ]\n        }))\n    }\n}\n\n// Navigation component\nstruct Navigation;\n\nimpl Component for Navigation {\n    fn render(\u0026self) -\u003e Element {\n        let nav_style = style![\n            flex,\n            justify_between,\n            items_center,\n            px(6),\n            py(4),\n            bg_black,\n            text_white,\n        ];\n        \n        view! {\n            \u003cnav style={nav_style.build()}\u003e\n                \u003cdiv class=\"logo\"\u003e\n                    \u003ch1\u003e\"Layer9\"\u003c/h1\u003e\n                \u003c/div\u003e\n                \n                \u003cdiv class=\"nav-links\"\u003e\n                    {Link::new(\"/\").children(vec![view! { \"Home\" }]).render()}\n                    {Link::new(\"/todos\").children(vec![view! { \"Todos\" }]).render()}\n                    {Link::new(\"/about\").children(vec![view! { \"About\" }]).render()}\n                \u003c/div\u003e\n                \n                \u003cdiv class=\"auth\"\u003e\n                    {Protected::new(UserMenu)\n                        .fallback(LoginButton)\n                        .render()}\n                \u003c/div\u003e\n            \u003c/nav\u003e\n        }\n    }\n}\n\n// Hero section\nstruct Hero;\n\nimpl Component for Hero {\n    fn render(\u0026self) -\u003e Element {\n        let hero_style = style![\n            text_center,\n            py(20),\n            px(4),\n        ];\n        \n        view! {\n            \u003csection style={hero_style.build()}\u003e\n                \u003ch1 class=\"hero-title\"\u003e\"Build Full-Stack Apps with Rust\"\u003c/h1\u003e\n                \u003cp class=\"hero-subtitle\"\u003e\n                    \"Server-side rendering, authentication, and real-time updates\"\n                \u003c/p\u003e\n                {Button::new(\"Get Started\")\n                    .variant(ButtonVariant::Primary)\n                    .on_click(|| navigate(\"/todos\").unwrap())\n                    .render()}\n            \u003c/section\u003e\n        }\n    }\n}\n\n// Features section\nstruct Features;\n\nimpl Component for Features {\n    fn render(\u0026self) -\u003e Element {\n        let features = vec![\n            (\"🚀\", \"Blazing Fast\", \"WASM performance with Rust safety\"),\n            (\"🔒\", \"Type Safe\", \"End-to-end type safety from server to client\"),\n            (\"📦\", \"SSR Ready\", \"Server-side rendering out of the box\"),\n            (\"🎨\", \"Styled\", \"CSS-in-Rust with zero runtime\"),\n        ];\n        \n        let grid_style = style![\n            grid,\n            lg_grid_cols(4),\n            gap(6),\n            px(6),\n            py(12),\n        ];\n        \n        view! {\n            \u003csection style={grid_style.build()}\u003e\n                {features.into_iter().map(|(icon, title, desc)| {\n                    Card::new()\n                        .children(vec![\n                            view! { \u003cdiv class=\"feature-icon\"\u003e{icon}\u003c/div\u003e },\n                            view! { \u003ch3\u003e{title}\u003c/h3\u003e },\n                            view! { \u003cp\u003e{desc}\u003c/p\u003e },\n                        ])\n                        .render()\n                }).collect::\u003cVec\u003c_\u003e\u003e()}\n            \u003c/section\u003e\n        }\n    }\n}\n\n// Todo section with API integration\nstruct TodoSection;\n\nimpl Component for TodoSection {\n    fn render(\u0026self) -\u003e Element {\n        let todos = use_swr::\u003cTodosResponse\u003e(\"/api/todos\");\n        \n        view! {\n            \u003csection class=\"todos\"\u003e\n                \u003ch2\u003e\"Recent Todos\"\u003c/h2\u003e\n                \n                {if todos.is_loading() {\n                    view! { \u003cdiv\u003e\"Loading todos...\"\u003c/div\u003e }\n                } else if let Some(data) = todos.data() {\n                    view! {\n                        \u003cul\u003e\n                            {data.todos.iter().map(|todo| {\n                                view! {\n                                    \u003cli\u003e\n                                        \u003cinput type=\"checkbox\" checked={todo.done} /\u003e\n                                        \u003cspan\u003e{\u0026todo.text}\u003c/span\u003e\n                                    \u003c/li\u003e\n                                }\n                            }).collect::\u003cVec\u003c_\u003e\u003e()}\n                        \u003c/ul\u003e\n                    }\n                } else {\n                    view! { \u003cdiv\u003e\"Failed to load todos\"\u003c/div\u003e }\n                }}\n            \u003c/section\u003e\n        }\n    }\n}\n\n// Todos page\nstruct TodosPage;\n\nimpl Component for TodosPage {\n    fn render(\u0026self) -\u003e Element {\n        let new_todo = use_state(|| String::new());\n        let todos = use_atom(\u0026TODOS_ATOM);\n        \n        view! {\n            \u003cdiv class=\"todos-page\"\u003e\n                \u003cNavigation /\u003e\n                \n                \u003cmain\u003e\n                    \u003ch1\u003e\"Todo List\"\u003c/h1\u003e\n                    \n                    \u003cdiv class=\"todo-input\"\u003e\n                        {Input::new()\n                            .placeholder(\"What needs to be done?\")\n                            .value(new_todo.get())\n                            .on_change(move |v| new_todo.set(v))\n                            .render()}\n                        {Button::new(\"Add\")\n                            .on_click(move || {\n                                if !new_todo.get().is_empty() {\n                                    add_todo(new_todo.get());\n                                    new_todo.set(String::new());\n                                }\n                            })\n                            .render()}\n                    \u003c/div\u003e\n                    \n                    \u003cTodoList /\u003e\n                \u003c/main\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Todo list component\nstruct TodoList;\n\nimpl Component for TodoList {\n    fn render(\u0026self) -\u003e Element {\n        let todos = use_atom(\u0026TODOS_ATOM);\n        \n        view! {\n            \u003cul class=\"todo-list\"\u003e\n                {todos.get().unwrap_or_default().iter().map(|todo| {\n                    view! {\n                        \u003cli\u003e\n                            \u003cinput \n                                type=\"checkbox\" \n                                checked={todo.done}\n                                onchange={move || toggle_todo(todo.id)}\n                            /\u003e\n                            \u003cspan class={if todo.done { \"done\" } else { \"\" }}\u003e\n                                {\u0026todo.text}\n                            \u003c/span\u003e\n                            {Button::new(\"Delete\")\n                                .variant(ButtonVariant::Destructive)\n                                .on_click(move || delete_todo(todo.id))\n                                .render()}\n                        \u003c/li\u003e\n                    }\n                }).collect::\u003cVec\u003c_\u003e\u003e()}\n            \u003c/ul\u003e\n        }\n    }\n}\n\n// About page\nstruct AboutPage;\n\nimpl Component for AboutPage {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cdiv\u003e\n                \u003cNavigation /\u003e\n                \u003cmain\u003e\n                    \u003ch1\u003e\"About Layer9\"\u003c/h1\u003e\n                    \u003cp\u003e\"Web Architecture Rust Platform\"\u003c/p\u003e\n                \u003c/main\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\n// User menu\nstruct UserMenu;\n\nimpl Component for UserMenu {\n    fn render(\u0026self) -\u003e Element {\n        let auth = use_auth();\n        \n        view! {\n            \u003cdiv class=\"user-menu\"\u003e\n                {if let Some(user) = auth.user {\n                    view! {\n                        \u003cdiv\u003e\n                            \u003cspan\u003e{user.name}\u003c/span\u003e\n                            {Button::new(\"Logout\")\n                                .variant(ButtonVariant::Ghost)\n                                .render()}\n                        \u003c/div\u003e\n                    }\n                } else {\n                    view! { \u003cdiv /\u003e }\n                }}\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Login button\nstruct LoginButton;\n\nimpl Component for LoginButton {\n    fn render(\u0026self) -\u003e Element {\n        Button::new(\"Login\")\n            .variant(ButtonVariant::Primary)\n            .render()\n    }\n}\n\n// Footer\nstruct Footer;\n\nimpl Component for Footer {\n    fn render(\u0026self) -\u003e Element {\n        let footer_style = style![\n            text_center,\n            py(8),\n            text_gray_500,\n        ];\n        \n        view! {\n            \u003cfooter style={footer_style.build()}\u003e\n                \u003cp\u003e\"Built with Layer9 - Web Architecture Rust Platform\"\u003c/p\u003e\n            \u003c/footer\u003e\n        }\n    }\n}\n\n// Not found page\nstruct NotFoundPage;\n\nimpl Component for NotFoundPage {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cdiv\u003e\n                \u003cNavigation /\u003e\n                \u003cmain\u003e\n                    \u003ch1\u003e\"404 - Page Not Found\"\u003c/h1\u003e\n                    {Link::new(\"/\").children(vec![view! { \"Go Home\" }]).render()}\n                \u003c/main\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Data structures\n#[derive(Clone, Serialize, Deserialize)]\nstruct Todo {\n    id: u32,\n    text: String,\n    done: bool,\n}\n\n#[derive(Serialize, Deserialize)]\nstruct TodosResponse {\n    todos: Vec\u003cTodo\u003e,\n}\n\n// Global state\nstatic TODOS_ATOM: Lazy\u003cAtom\u003cVec\u003cTodo\u003e\u003e\u003e = Lazy::new(|| {\n    create_atom(vec![\n        Todo { id: 1, text: \"Learn Layer9\".to_string(), done: false },\n        Todo { id: 2, text: \"Build something awesome\".to_string(), done: false },\n    ])\n});\n\n// Todo actions\nfn add_todo(text: String) {\n    TODOS_ATOM.update(|todos| {\n        let id = todos.iter().map(|t| t.id).max().unwrap_or(0) + 1;\n        todos.push(Todo { id, text, done: false });\n    });\n}\n\nfn toggle_todo(id: u32) {\n    TODOS_ATOM.update(|todos| {\n        if let Some(todo) = todos.iter_mut().find(|t| t.id == id) {\n            todo.done = !todo.done;\n        }\n    });\n}\n\nfn delete_todo(id: u32) {\n    TODOS_ATOM.update(|todos| {\n        todos.retain(|t| t.id != id);\n    });\n}\n\n// App type\nstruct FullStackApp;\nimpl L7::Application for FullStackApp {\n    type State = ();\n    type Action = ();\n    \n    fn reduce(_: \u0026Self::State, _: Self::Action) -\u003e Self::State {\n        ()\n    }\n}\n\n// Hooks\nfn use_swr\u003cT: Clone + for\u003c'de\u003e Deserialize\u003c'de\u003e + 'static\u003e(url: \u0026str) -\u003e SWR\u003cT\u003e {\n    SWR::new(url)\n}\n\n// Re-exports\nuse once_cell::sync::Lazy;\n\n// Entry point for client\n#[wasm_bindgen(start)]\npub fn main() {\n    // Check if we're hydrating SSR content\n    if let Some(window) = web_sys::window() {\n        if js_sys::Reflect::has(\u0026window, \u0026\"__Layer9_PROPS__\".into()).unwrap_or(false) {\n            hydrate_app(App);\n        } else {\n            run_app(App);\n        }\n    }\n}\n\n// Entry point for server (would be in separate file)\n#[cfg(not(target_arch = \"wasm32\"))]\npub fn create_server() -\u003e axum::Router {\n    create_ssr_server(App)\n}","traces":[{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","templates","haf-full.rs"],"content":"//! Full HAF Layer9 Application Template\n//! \n//! Complete example with routing, state management, and services following HAF principles.\n\nuse layer9::prelude::*;\nuse layer9::haf::{layers::*, component::*, vdom::*, Contract, Service};\nuse std::collections::HashMap;\n\n// ==================== L1: Pure Business Logic ====================\n\n/// Application routes - pure data\n#[derive(Clone, Debug, PartialEq)]\npub enum Route {\n    Home,\n    About,\n    Todo,\n    NotFound,\n}\n\nimpl Route {\n    /// Parse route from path string\n    pub fn from_path(path: \u0026str) -\u003e Self {\n        match path {\n            \"/\" | \"/home\" =\u003e Route::Home,\n            \"/about\" =\u003e Route::About,\n            \"/todo\" =\u003e Route::Todo,\n            _ =\u003e Route::NotFound,\n        }\n    }\n    \n    /// Get path string for route\n    pub fn to_path(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Route::Home =\u003e \"/\",\n            Route::About =\u003e \"/about\",\n            Route::Todo =\u003e \"/todo\",\n            Route::NotFound =\u003e \"/404\",\n        }\n    }\n}\n\n/// Todo item - pure data\n#[derive(Clone, Debug, PartialEq)]\npub struct Todo {\n    pub id: u32,\n    pub text: String,\n    pub completed: bool,\n}\n\n/// Application state - pure data\n#[derive(Clone, Debug)]\npub struct AppState {\n    pub route: Route,\n    pub todos: Vec\u003cTodo\u003e,\n    pub next_todo_id: u32,\n    pub theme: Theme,\n}\n\n#[derive(Clone, Debug, PartialEq)]\npub enum Theme {\n    Light,\n    Dark,\n}\n\nimpl Default for AppState {\n    fn default() -\u003e Self {\n        Self {\n            route: Route::Home,\n            todos: vec![\n                Todo { id: 1, text: \"Learn HAF architecture\".to_string(), completed: true },\n                Todo { id: 2, text: \"Build with Layer9\".to_string(), completed: false },\n            ],\n            next_todo_id: 3,\n            theme: Theme::Dark,\n        }\n    }\n}\n\n/// Pure state transitions\npub mod transitions {\n    use super::*;\n    \n    pub fn navigate(state: \u0026AppState, route: Route) -\u003e AppState {\n        AppState {\n            route,\n            ..state.clone()\n        }\n    }\n    \n    pub fn add_todo(state: \u0026AppState, text: String) -\u003e AppState {\n        let mut todos = state.todos.clone();\n        todos.push(Todo {\n            id: state.next_todo_id,\n            text,\n            completed: false,\n        });\n        \n        AppState {\n            todos,\n            next_todo_id: state.next_todo_id + 1,\n            ..state.clone()\n        }\n    }\n    \n    pub fn toggle_todo(state: \u0026AppState, id: u32) -\u003e AppState {\n        let todos = state.todos.iter().map(|todo| {\n            if todo.id == id {\n                Todo {\n                    completed: !todo.completed,\n                    ..todo.clone()\n                }\n            } else {\n                todo.clone()\n            }\n        }).collect();\n        \n        AppState {\n            todos,\n            ..state.clone()\n        }\n    }\n    \n    pub fn delete_todo(state: \u0026AppState, id: u32) -\u003e AppState {\n        let todos = state.todos.iter()\n            .filter(|todo| todo.id != id)\n            .cloned()\n            .collect();\n        \n        AppState {\n            todos,\n            ..state.clone()\n        }\n    }\n    \n    pub fn toggle_theme(state: \u0026AppState) -\u003e AppState {\n        AppState {\n            theme: match state.theme {\n                Theme::Light =\u003e Theme::Dark,\n                Theme::Dark =\u003e Theme::Light,\n            },\n            ..state.clone()\n        }\n    }\n}\n\n/// Pure components\npub mod components {\n    use super::*;\n    \n    /// Navigation component\n    pub struct Nav;\n    \n    impl Default for Nav {\n        fn default() -\u003e Self { Self }\n    }\n    \n    impl PureComponent\u003cL1\u003e for Nav {\n        type Props = Route;\n        \n        fn render(\u0026self, current_route: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n            VNode::Element {\n                tag: \"nav\".to_string(),\n                props: VProps {\n                    class: Some(\"nav\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    nav_link(\"Home\", Route::Home, current_route),\n                    nav_link(\"About\", Route::About, current_route),\n                    nav_link(\"Todo\", Route::Todo, current_route),\n                ],\n            }\n        }\n    }\n    \n    fn nav_link(text: \u0026str, route: Route, current: \u0026Route) -\u003e VNode\u003cL1\u003e {\n        VNode::Element {\n            tag: \"a\".to_string(),\n            props: VProps {\n                class: Some(if \u0026route == current { \"active\" } else { \"\" }.to_string()),\n                attributes: vec![(\"href\".to_string(), route.to_path().to_string())],\n                events: vec![(\"click\".to_string(), EventId(100 + route as u64))],\n                ..Default::default()\n            },\n            children: vec![VNode::Text(text.to_string())],\n        }\n    }\n    \n    /// Home page component\n    pub struct HomePage;\n    \n    impl Default for HomePage {\n        fn default() -\u003e Self { Self }\n    }\n    \n    impl PureComponent\u003cL1\u003e for HomePage {\n        type Props = Theme;\n        \n        fn render(\u0026self, theme: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n            VNode::Element {\n                tag: \"div\".to_string(),\n                props: VProps {\n                    class: Some(\"page home\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    VNode::Element {\n                        tag: \"h1\".to_string(),\n                        props: VProps::default(),\n                        children: vec![VNode::Text(\"Welcome to HAF Layer9\".to_string())],\n                    },\n                    VNode::Element {\n                        tag: \"p\".to_string(),\n                        props: VProps::default(),\n                        children: vec![VNode::Text(\n                            \"A hierarchical architecture framework for building robust web applications.\".to_string()\n                        )],\n                    },\n                    VNode::Element {\n                        tag: \"button\".to_string(),\n                        props: VProps {\n                            events: vec![(\"click\".to_string(), EventId(200))],\n                            ..Default::default()\n                        },\n                        children: vec![VNode::Text(\n                            format!(\"Switch to {} theme\", \n                                match theme {\n                                    Theme::Light =\u003e \"dark\",\n                                    Theme::Dark =\u003e \"light\",\n                                }\n                            )\n                        )],\n                    },\n                ],\n            }\n        }\n    }\n    \n    /// Todo page component\n    pub struct TodoPage;\n    \n    impl Default for TodoPage {\n        fn default() -\u003e Self { Self }\n    }\n    \n    impl PureComponent\u003cL1\u003e for TodoPage {\n        type Props = Vec\u003cTodo\u003e;\n        \n        fn render(\u0026self, todos: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n            VNode::Element {\n                tag: \"div\".to_string(),\n                props: VProps {\n                    class: Some(\"page todo\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    VNode::Element {\n                        tag: \"h1\".to_string(),\n                        props: VProps::default(),\n                        children: vec![VNode::Text(\"Todo List\".to_string())],\n                    },\n                    VNode::Element {\n                        tag: \"form\".to_string(),\n                        props: VProps {\n                            events: vec![(\"submit\".to_string(), EventId(300))],\n                            ..Default::default()\n                        },\n                        children: vec![\n                            VNode::Element {\n                                tag: \"input\".to_string(),\n                                props: VProps {\n                                    attributes: vec![\n                                        (\"type\".to_string(), \"text\".to_string()),\n                                        (\"placeholder\".to_string(), \"Add a new todo...\".to_string()),\n                                    ],\n                                    ..Default::default()\n                                },\n                                children: vec![],\n                            },\n                            VNode::Element {\n                                tag: \"button\".to_string(),\n                                props: VProps {\n                                    attributes: vec![(\"type\".to_string(), \"submit\".to_string())],\n                                    ..Default::default()\n                                },\n                                children: vec![VNode::Text(\"Add\".to_string())],\n                            },\n                        ],\n                    },\n                    VNode::Element {\n                        tag: \"ul\".to_string(),\n                        props: VProps {\n                            class: Some(\"todo-list\".to_string()),\n                            ..Default::default()\n                        },\n                        children: todos.iter().map(|todo| {\n                            VNode::Element {\n                                tag: \"li\".to_string(),\n                                props: VProps {\n                                    class: Some(if todo.completed { \"completed\" } else { \"\" }.to_string()),\n                                    ..Default::default()\n                                },\n                                children: vec![\n                                    VNode::Element {\n                                        tag: \"input\".to_string(),\n                                        props: VProps {\n                                            attributes: vec![\n                                                (\"type\".to_string(), \"checkbox\".to_string()),\n                                                (\"checked\".to_string(), todo.completed.to_string()),\n                                            ],\n                                            events: vec![(\"change\".to_string(), EventId(400 + todo.id as u64))],\n                                            ..Default::default()\n                                        },\n                                        children: vec![],\n                                    },\n                                    VNode::Element {\n                                        tag: \"span\".to_string(),\n                                        props: VProps::default(),\n                                        children: vec![VNode::Text(todo.text.clone())],\n                                    },\n                                    VNode::Element {\n                                        tag: \"button\".to_string(),\n                                        props: VProps {\n                                            events: vec![(\"click\".to_string(), EventId(500 + todo.id as u64))],\n                                            ..Default::default()\n                                        },\n                                        children: vec![VNode::Text(\"Delete\".to_string())],\n                                    },\n                                ],\n                            }\n                        }).collect(),\n                    },\n                ],\n            }\n        }\n    }\n}\n\n// ==================== L2: Runtime Layer ====================\n\n/// Application runtime\npub struct AppRuntime {\n    state: AppState,\n    component_runtime: ComponentRuntime\u003cL2\u003e,\n    patch_runtime: PatchRuntime\u003cL2\u003e,\n    event_handlers: HashMap\u003cEventId, Box\u003cdyn Fn() -\u003e Action\u003e\u003e,\n}\n\n/// Actions that can modify state\n#[derive(Clone, Debug)]\npub enum Action {\n    Navigate(Route),\n    AddTodo(String),\n    ToggleTodo(u32),\n    DeleteTodo(u32),\n    ToggleTheme,\n}\n\nimpl AppRuntime {\n    pub fn new() -\u003e Self {\n        let mut runtime = Self {\n            state: AppState::default(),\n            component_runtime: ComponentRuntime::new(),\n            patch_runtime: PatchRuntime::new(),\n            event_handlers: HashMap::new(),\n        };\n        \n        runtime.setup_event_handlers();\n        runtime\n    }\n    \n    /// Handle actions\n    pub fn dispatch(\u0026mut self, action: Action) -\u003e Vec\u003cContract\u003cPatch\u003cL1\u003e, DomOperation\u003e\u003e {\n        use transitions::*;\n        \n        // Calculate new state\n        let new_state = match action {\n            Action::Navigate(route) =\u003e navigate(\u0026self.state, route),\n            Action::AddTodo(text) =\u003e add_todo(\u0026self.state, text),\n            Action::ToggleTodo(id) =\u003e toggle_todo(\u0026self.state, id),\n            Action::DeleteTodo(id) =\u003e delete_todo(\u0026self.state, id),\n            Action::ToggleTheme =\u003e toggle_theme(\u0026self.state),\n        };\n        \n        // Generate diff\n        let old_vnode = self.render_app(\u0026self.state);\n        let new_vnode = self.render_app(\u0026new_state);\n        \n        let diff = VDomDiff::\u003cL1\u003e::new();\n        let patches = diff.diff(\u0026old_vnode, \u0026new_vnode);\n        \n        // Update state\n        self.state = new_state;\n        \n        // Convert patches to DOM operations\n        self.patch_runtime.apply_patches(patches, DomHandle { node_id: 0 })\n    }\n    \n    fn render_app(\u0026self, state: \u0026AppState) -\u003e VNode\u003cL1\u003e {\n        use components::*;\n        \n        VNode::Element {\n            tag: \"div\".to_string(),\n            props: VProps {\n                class: Some(format!(\"app theme-{}\", \n                    match state.theme {\n                        Theme::Light =\u003e \"light\",\n                        Theme::Dark =\u003e \"dark\",\n                    }\n                )),\n                ..Default::default()\n            },\n            children: vec![\n                Nav::default().render(\u0026state.route),\n                match \u0026state.route {\n                    Route::Home =\u003e HomePage::default().render(\u0026state.theme),\n                    Route::About =\u003e VNode::Element {\n                        tag: \"div\".to_string(),\n                        props: VProps {\n                            class: Some(\"page about\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            VNode::Element {\n                                tag: \"h1\".to_string(),\n                                props: VProps::default(),\n                                children: vec![VNode::Text(\"About HAF\".to_string())],\n                            },\n                            VNode::Element {\n                                tag: \"p\".to_string(),\n                                props: VProps::default(),\n                                children: vec![VNode::Text(\n                                    \"HAF enforces clean architecture through compile-time guarantees.\".to_string()\n                                )],\n                            },\n                        ],\n                    },\n                    Route::Todo =\u003e TodoPage::default().render(\u0026state.todos),\n                    Route::NotFound =\u003e VNode::Element {\n                        tag: \"div\".to_string(),\n                        props: VProps {\n                            class: Some(\"page not-found\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            VNode::Element {\n                                tag: \"h1\".to_string(),\n                                props: VProps::default(),\n                                children: vec![VNode::Text(\"404 - Page Not Found\".to_string())],\n                            },\n                        ],\n                    },\n                },\n            ],\n        }\n    }\n    \n    fn setup_event_handlers(\u0026mut self) {\n        // Navigation handlers\n        self.event_handlers.insert(EventId(100), Box::new(|| Action::Navigate(Route::Home)));\n        self.event_handlers.insert(EventId(101), Box::new(|| Action::Navigate(Route::About)));\n        self.event_handlers.insert(EventId(102), Box::new(|| Action::Navigate(Route::Todo)));\n        \n        // Theme toggle\n        self.event_handlers.insert(EventId(200), Box::new(|| Action::ToggleTheme));\n        \n        // Todo handlers would be dynamic based on todo IDs\n    }\n}\n\n// ==================== L3: Framework Layer ====================\n\n/// Browser router service\ncrate::haf_service!(L3, router_service, {\n    pub fn init() -\u003e () {\n        // Set up popstate listener\n        // In real implementation, would integrate with runtime\n    }\n    \n    pub fn navigate(path: \u0026str) -\u003e Result\u003c(), String\u003e {\n        // Use browser history API\n        Ok(())\n    }\n});\n\n/// Local storage service\ncrate::haf_service!(L3, storage_service, {\n    pub fn save_state(state: \u0026AppState) -\u003e Result\u003c(), String\u003e {\n        // Serialize and save to localStorage\n        Ok(())\n    }\n    \n    pub fn load_state() -\u003e Result\u003cOption\u003cAppState\u003e, String\u003e {\n        // Load and deserialize from localStorage\n        Ok(None)\n    }\n});\n\n/// Application entry point\n#[wasm_bindgen(start)]\npub fn main() {\n    console_error_panic_hook::set_once();\n    \n    // Initialize services\n    router_service::init();\n    \n    // Load persisted state\n    let initial_state = storage_service::load_state()\n        .ok()\n        .flatten()\n        .unwrap_or_default();\n    \n    // Create and mount app\n    let mut app = ComponentApp::\u003cL3\u003e::new();\n    \n    // Render initial state\n    let runtime = AppRuntime::new();\n    let initial_vnode = runtime.render_app(\u0026initial_state);\n    \n    app.mount(\"#app\", initial_vnode);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","templates","haf-minimal.rs"],"content":"//! Minimal HAF Layer9 Application Template\n//! \n//! This template demonstrates the hierarchical architecture with proper layer separation.\n\nuse layer9::prelude::*;\nuse layer9::haf::{layers::*, component::*, vdom::*, Contract};\n\n// ==================== L1: Pure Business Logic ====================\n\n/// Application state - pure data\n#[derive(Clone, Debug)]\nstruct AppState {\n    count: i32,\n    message: String,\n}\n\nimpl Default for AppState {\n    fn default() -\u003e Self {\n        Self {\n            count: 0,\n            message: \"Welcome to HAF Layer9!\".to_string(),\n        }\n    }\n}\n\n/// Pure state transitions\nfn increment_count(state: \u0026AppState) -\u003e AppState {\n    AppState {\n        count: state.count + 1,\n        ..state.clone()\n    }\n}\n\nfn decrement_count(state: \u0026AppState) -\u003e AppState {\n    AppState {\n        count: state.count - 1,\n        ..state.clone()\n    }\n}\n\n/// Counter component - pure render function\nstruct Counter;\n\nimpl Default for Counter {\n    fn default() -\u003e Self {\n        Self\n    }\n}\n\nimpl PureComponent\u003cL1\u003e for Counter {\n    type Props = AppState;\n    \n    fn render(\u0026self, props: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n        VNode::Element {\n            tag: \"div\".to_string(),\n            props: VProps {\n                class: Some(\"counter\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                VNode::Element {\n                    tag: \"h1\".to_string(),\n                    props: VProps::default(),\n                    children: vec![VNode::Text(props.message.clone())],\n                },\n                VNode::Element {\n                    tag: \"div\".to_string(),\n                    props: VProps {\n                        class: Some(\"count-display\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        VNode::Text(format!(\"Count: {}\", props.count))\n                    ],\n                },\n                VNode::Element {\n                    tag: \"div\".to_string(),\n                    props: VProps {\n                        class: Some(\"buttons\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        VNode::Element {\n                            tag: \"button\".to_string(),\n                            props: VProps {\n                                events: vec![(\"click\".to_string(), EventId(1))],\n                                ..Default::default()\n                            },\n                            children: vec![VNode::Text(\"Increment\".to_string())],\n                        },\n                        VNode::Element {\n                            tag: \"button\".to_string(),\n                            props: VProps {\n                                events: vec![(\"click\".to_string(), EventId(2))],\n                                ..Default::default()\n                            },\n                            children: vec![VNode::Text(\"Decrement\".to_string())],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\n// ==================== L2: Runtime Layer ====================\n\n/// Application runtime managing state and effects\npub struct AppRuntime {\n    state: AppState,\n    component_runtime: ComponentRuntime\u003cL2\u003e,\n    patch_runtime: PatchRuntime\u003cL2\u003e,\n}\n\nimpl AppRuntime {\n    pub fn new() -\u003e Self {\n        Self {\n            state: AppState::default(),\n            component_runtime: ComponentRuntime::new(),\n            patch_runtime: PatchRuntime::new(),\n        }\n    }\n    \n    /// Handle state updates\n    pub fn dispatch(\u0026mut self, action: Action) -\u003e Vec\u003cContract\u003cPatch\u003cL1\u003e, DomOperation\u003e\u003e {\n        // Update state based on action\n        let new_state = match action {\n            Action::Increment =\u003e increment_count(\u0026self.state),\n            Action::Decrement =\u003e decrement_count(\u0026self.state),\n        };\n        \n        // Generate diff\n        let old_vnode = self.render_app(\u0026self.state);\n        let new_vnode = self.render_app(\u0026new_state);\n        \n        let diff = VDomDiff::\u003cL1\u003e::new();\n        let patches = diff.diff(\u0026old_vnode, \u0026new_vnode);\n        \n        // Update state\n        self.state = new_state;\n        \n        // Convert patches to DOM operations\n        self.patch_runtime.apply_patches(patches, DomHandle { node_id: 0 })\n    }\n    \n    fn render_app(\u0026self, state: \u0026AppState) -\u003e VNode\u003cL1\u003e {\n        let counter = Counter::default();\n        counter.render(state)\n    }\n    \n    /// Register event handlers\n    pub fn setup_event_handlers(\u0026mut self) {\n        // Register increment handler\n        self.patch_runtime.register_event(EventId(1), Box::new(|| {\n            // In real app, would send Action::Increment to dispatcher\n            println!(\"Increment clicked\");\n        }));\n        \n        // Register decrement handler\n        self.patch_runtime.register_event(EventId(2), Box::new(|| {\n            // In real app, would send Action::Decrement to dispatcher\n            println!(\"Decrement clicked\");\n        }));\n    }\n}\n\n/// Actions that can modify state\n#[derive(Clone, Debug)]\npub enum Action {\n    Increment,\n    Decrement,\n}\n\n// ==================== L3: Framework Layer ====================\n\n/// Application entry point\n#[wasm_bindgen(start)]\npub fn main() {\n    // Set up panic hook for better error messages\n    console_error_panic_hook::set_once();\n    \n    // Create app instance\n    let mut app = ComponentApp::\u003cL3\u003e::new();\n    \n    // Create initial app state\n    let initial_state = AppState::default();\n    let counter = Counter::default();\n    let initial_vnode = counter.render(\u0026initial_state);\n    \n    // Mount to DOM\n    app.mount(\"#app\", initial_vnode);\n}\n\n// ==================== Styles ====================\n\n/// CSS for the application\npub fn styles() -\u003e \u0026'static str {\n    r#\"\n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        background: #0a0a0a;\n        color: #ffffff;\n        margin: 0;\n        padding: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        min-height: 100vh;\n    }\n    \n    .counter {\n        text-align: center;\n        padding: 2rem;\n        background: rgba(255, 255, 255, 0.05);\n        border-radius: 1rem;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n    }\n    \n    h1 {\n        margin: 0 0 2rem 0;\n        font-size: 2rem;\n        background: linear-gradient(to right, #60a5fa, #a78bfa);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n    }\n    \n    .count-display {\n        font-size: 3rem;\n        font-weight: bold;\n        margin: 2rem 0;\n    }\n    \n    .buttons {\n        display: flex;\n        gap: 1rem;\n        justify-content: center;\n    }\n    \n    button {\n        background: rgba(99, 102, 241, 0.2);\n        border: 1px solid rgb(99, 102, 241);\n        color: rgb(199, 210, 254);\n        padding: 0.75rem 1.5rem;\n        border-radius: 0.5rem;\n        font-size: 1rem;\n        cursor: pointer;\n        transition: all 0.2s;\n    }\n    \n    button:hover {\n        background: rgba(99, 102, 241, 0.3);\n        transform: translateY(-2px);\n    }\n    \n    button:active {\n        transform: translateY(0);\n    }\n    \"#\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","cli","templates","minimal.rs"],"content":"//! Minimal Layer9 Application\n\nuse layer9_framework::prelude::*;\nuse wasm_bindgen::prelude::*;\n\n// Define your app\n#[wasm_bindgen]\npub struct App;\n\nimpl WarpApp for App {\n    fn routes(\u0026self) -\u003e Vec\u003cRoute\u003e {\n        vec![\n            Route {\n                path: \"/\".to_string(),\n                handler: RouteHandler::Page(|| {\n                    Page::new()\n                        .title(\"Layer9 App\")\n                        .component(HomePage)\n                }),\n            },\n        ]\n    }\n    \n    fn initialize(\u0026self) {\n        inject_global_styles();\n        web_sys::console::log_1(\u0026\"Layer9 App initialized!\".into());\n    }\n}\n\nimpl L8::Architecture for App {\n    type App = MinimalApp;\n    \n    fn design() -\u003e L8::ArchitectureDesign {\n        L8::ArchitectureDesign {\n            layers: vec![\n                Layer::L1Infrastructure,\n                Layer::L5Components,\n                Layer::L7Application,\n            ],\n            boundaries: vec![],\n        }\n    }\n}\n\n// Home page component\nstruct HomePage;\n\nimpl Component for HomePage {\n    fn render(\u0026self) -\u003e Element {\n        view! {\n            \u003cdiv class=\"container\"\u003e\n                \u003ch1\u003e\"Welcome to Layer9\"\u003c/h1\u003e\n                \u003cp\u003e\"Web Architecture Rust Platform\"\u003c/p\u003e\n                {Button::new(\"Get Started\")\n                    .variant(ButtonVariant::Primary)\n                    .render()}\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Minimal app type\nstruct MinimalApp;\nimpl L7::Application for MinimalApp {\n    type State = ();\n    type Action = ();\n    \n    fn reduce(_: \u0026Self::State, _: Self::Action) -\u003e Self::State {\n        ()\n    }\n}\n\n// Entry point\n#[wasm_bindgen(start)]\npub fn main() {\n    run_app(App);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","examples","haf-todo","src","lib.rs"],"content":"//! L1: Core - Pure business logic for TODO app\n\nuse layer9_core::haf::{\n    layers::L1,\n    component::{VNode, VProps, PureComponent},\n};\n\n#[derive(Clone, Debug, PartialEq)]\npub struct Todo {\n    pub id: u32,\n    pub text: String,\n    pub completed: bool,\n}\n\n#[derive(Clone, Debug, PartialEq)]\npub struct TodoListState {\n    pub todos: Vec\u003cTodo\u003e,\n    pub filter: Filter,\n}\n\n#[derive(Clone, Debug, PartialEq)]\npub enum Filter {\n    All,\n    Active,\n    Completed,\n}\n\nimpl TodoListState {\n    pub fn new() -\u003e Self {\n        Self {\n            todos: vec![],\n            filter: Filter::All,\n        }\n    }\n    \n    pub fn add_todo(\u0026self, text: String) -\u003e Self {\n        let mut todos = self.todos.clone();\n        todos.push(Todo {\n            id: self.todos.len() as u32 + 1,\n            text,\n            completed: false,\n        });\n        \n        Self {\n            todos,\n            filter: self.filter.clone(),\n        }\n    }\n    \n    pub fn toggle_todo(\u0026self, id: u32) -\u003e Self {\n        let todos = self.todos.iter()\n            .map(|todo| {\n                if todo.id == id {\n                    Todo {\n                        id: todo.id,\n                        text: todo.text.clone(),\n                        completed: !todo.completed,\n                    }\n                } else {\n                    todo.clone()\n                }\n            })\n            .collect();\n            \n        Self {\n            todos,\n            filter: self.filter.clone(),\n        }\n    }\n    \n    pub fn visible_todos(\u0026self) -\u003e Vec\u003c\u0026Todo\u003e {\n        self.todos.iter()\n            .filter(|todo| match self.filter {\n                Filter::All =\u003e true,\n                Filter::Active =\u003e !todo.completed,\n                Filter::Completed =\u003e todo.completed,\n            })\n            .collect()\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","api_docs.rs"],"content":"//! API Documentation System - L5/L6\n//! OpenAPI/Swagger and GraphQL schema documentation\n\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\nuse std::collections::HashMap;\n\n/// OpenAPI 3.0 specification\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct OpenApiSpec {\n    pub openapi: String,\n    pub info: ApiInfo,\n    pub servers: Vec\u003cApiServer\u003e,\n    pub paths: HashMap\u003cString, PathItem\u003e,\n    pub components: Option\u003cComponents\u003e,\n    pub security: Option\u003cVec\u003cSecurityRequirement\u003e\u003e,\n    pub tags: Option\u003cVec\u003cTag\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApiInfo {\n    pub title: String,\n    pub version: String,\n    pub description: Option\u003cString\u003e,\n    pub terms_of_service: Option\u003cString\u003e,\n    pub contact: Option\u003cContact\u003e,\n    pub license: Option\u003cLicense\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Contact {\n    pub name: Option\u003cString\u003e,\n    pub url: Option\u003cString\u003e,\n    pub email: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct License {\n    pub name: String,\n    pub url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApiServer {\n    pub url: String,\n    pub description: Option\u003cString\u003e,\n    pub variables: Option\u003cHashMap\u003cString, ServerVariable\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ServerVariable {\n    pub default: String,\n    pub description: Option\u003cString\u003e,\n    #[serde(rename = \"enum\")]\n    pub enum_values: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PathItem {\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub get: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub put: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub post: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub delete: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub options: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub head: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub patch: Option\u003cOperation\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub trace: Option\u003cOperation\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Operation {\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n    pub summary: Option\u003cString\u003e,\n    pub description: Option\u003cString\u003e,\n    pub operation_id: Option\u003cString\u003e,\n    pub parameters: Option\u003cVec\u003cParameter\u003e\u003e,\n    pub request_body: Option\u003cRequestBody\u003e,\n    pub responses: HashMap\u003cString, Response\u003e,\n    pub security: Option\u003cVec\u003cSecurityRequirement\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Parameter {\n    pub name: String,\n    #[serde(rename = \"in\")]\n    pub location: String,\n    pub description: Option\u003cString\u003e,\n    pub required: Option\u003cbool\u003e,\n    pub schema: Schema,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RequestBody {\n    pub description: Option\u003cString\u003e,\n    pub content: HashMap\u003cString, MediaType\u003e,\n    pub required: Option\u003cbool\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Response {\n    pub description: String,\n    pub content: Option\u003cHashMap\u003cString, MediaType\u003e\u003e,\n    pub headers: Option\u003cHashMap\u003cString, Header\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MediaType {\n    pub schema: Schema,\n    pub example: Option\u003cValue\u003e,\n    pub examples: Option\u003cHashMap\u003cString, Example\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Schema {\n    #[serde(rename = \"type\")]\n    pub schema_type: Option\u003cString\u003e,\n    pub format: Option\u003cString\u003e,\n    pub description: Option\u003cString\u003e,\n    pub properties: Option\u003cHashMap\u003cString, Schema\u003e\u003e,\n    pub required: Option\u003cVec\u003cString\u003e\u003e,\n    pub items: Option\u003cBox\u003cSchema\u003e\u003e,\n    #[serde(rename = \"enum\")]\n    pub enum_values: Option\u003cVec\u003cValue\u003e\u003e,\n    pub minimum: Option\u003cf64\u003e,\n    pub maximum: Option\u003cf64\u003e,\n    pub pattern: Option\u003cString\u003e,\n    #[serde(rename = \"$ref\")]\n    pub reference: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Example {\n    pub summary: Option\u003cString\u003e,\n    pub description: Option\u003cString\u003e,\n    pub value: Value,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Header {\n    pub description: Option\u003cString\u003e,\n    pub schema: Schema,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Components {\n    pub schemas: Option\u003cHashMap\u003cString, Schema\u003e\u003e,\n    pub responses: Option\u003cHashMap\u003cString, Response\u003e\u003e,\n    pub parameters: Option\u003cHashMap\u003cString, Parameter\u003e\u003e,\n    pub security_schemes: Option\u003cHashMap\u003cString, SecurityScheme\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SecurityScheme {\n    #[serde(rename = \"type\")]\n    pub scheme_type: String,\n    pub description: Option\u003cString\u003e,\n    pub name: Option\u003cString\u003e,\n    #[serde(rename = \"in\")]\n    pub location: Option\u003cString\u003e,\n    pub scheme: Option\u003cString\u003e,\n    pub bearer_format: Option\u003cString\u003e,\n    pub flows: Option\u003cOAuthFlows\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct OAuthFlows {\n    pub implicit: Option\u003cOAuthFlow\u003e,\n    pub password: Option\u003cOAuthFlow\u003e,\n    pub client_credentials: Option\u003cOAuthFlow\u003e,\n    pub authorization_code: Option\u003cOAuthFlow\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct OAuthFlow {\n    pub authorization_url: Option\u003cString\u003e,\n    pub token_url: Option\u003cString\u003e,\n    pub refresh_url: Option\u003cString\u003e,\n    pub scopes: HashMap\u003cString, String\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SecurityRequirement {\n    #[serde(flatten)]\n    pub requirements: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Tag {\n    pub name: String,\n    pub description: Option\u003cString\u003e,\n}\n\n/// OpenAPI builder\npub struct OpenApiBuilder {\n    spec: OpenApiSpec,\n}\n\nimpl OpenApiBuilder {\n    pub fn new(title: impl Into\u003cString\u003e, version: impl Into\u003cString\u003e) -\u003e Self {\n        OpenApiBuilder {\n            spec: OpenApiSpec {\n                openapi: \"3.0.0\".to_string(),\n                info: ApiInfo {\n                    title: title.into(),\n                    version: version.into(),\n                    description: None,\n                    terms_of_service: None,\n                    contact: None,\n                    license: None,\n                },\n                servers: vec![],\n                paths: HashMap::new(),\n                components: None,\n                security: None,\n                tags: None,\n            },\n        }\n    }\n\n    pub fn description(mut self, description: impl Into\u003cString\u003e) -\u003e Self {\n        self.spec.info.description = Some(description.into());\n        self\n    }\n\n    pub fn server(mut self, url: impl Into\u003cString\u003e, description: Option\u003cString\u003e) -\u003e Self {\n        self.spec.servers.push(ApiServer {\n            url: url.into(),\n            description,\n            variables: None,\n        });\n        self\n    }\n\n    pub fn tag(mut self, name: impl Into\u003cString\u003e, description: Option\u003cString\u003e) -\u003e Self {\n        let tags = self.spec.tags.get_or_insert_with(Vec::new);\n        tags.push(Tag {\n            name: name.into(),\n            description,\n        });\n        self\n    }\n\n    pub fn path(mut self, path: impl Into\u003cString\u003e, item: PathItem) -\u003e Self {\n        self.spec.paths.insert(path.into(), item);\n        self\n    }\n\n    pub fn security_scheme(mut self, name: impl Into\u003cString\u003e, scheme: SecurityScheme) -\u003e Self {\n        let components = self.spec.components.get_or_insert(Components {\n            schemas: None,\n            responses: None,\n            parameters: None,\n            security_schemes: None,\n        });\n\n        let schemes = components.security_schemes.get_or_insert_with(HashMap::new);\n        schemes.insert(name.into(), scheme);\n        self\n    }\n\n    pub fn build(self) -\u003e OpenApiSpec {\n        self.spec\n    }\n}\n\n/// Route documentation decorator\npub struct ApiDoc {\n    operation: Operation,\n}\n\nimpl Default for ApiDoc {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ApiDoc {\n    pub fn new() -\u003e Self {\n        ApiDoc {\n            operation: Operation {\n                tags: None,\n                summary: None,\n                description: None,\n                operation_id: None,\n                parameters: None,\n                request_body: None,\n                responses: HashMap::new(),\n                security: None,\n            },\n        }\n    }\n\n    pub fn summary(mut self, summary: impl Into\u003cString\u003e) -\u003e Self {\n        self.operation.summary = Some(summary.into());\n        self\n    }\n\n    pub fn description(mut self, description: impl Into\u003cString\u003e) -\u003e Self {\n        self.operation.description = Some(description.into());\n        self\n    }\n\n    pub fn tag(mut self, tag: impl Into\u003cString\u003e) -\u003e Self {\n        let tags = self.operation.tags.get_or_insert_with(Vec::new);\n        tags.push(tag.into());\n        self\n    }\n\n    pub fn param(\n        mut self,\n        name: impl Into\u003cString\u003e,\n        location: \u0026str,\n        schema: Schema,\n        required: bool,\n    ) -\u003e Self {\n        let params = self.operation.parameters.get_or_insert_with(Vec::new);\n        params.push(Parameter {\n            name: name.into(),\n            location: location.to_string(),\n            description: schema.description.clone(),\n            required: Some(required),\n            schema,\n        });\n        self\n    }\n\n    pub fn body(mut self, content_type: \u0026str, schema: Schema, required: bool) -\u003e Self {\n        self.operation.request_body = Some(RequestBody {\n            description: schema.description.clone(),\n            content: {\n                let mut content = HashMap::new();\n                content.insert(\n                    content_type.to_string(),\n                    MediaType {\n                        schema,\n                        example: None,\n                        examples: None,\n                    },\n                );\n                content\n            },\n            required: Some(required),\n        });\n        self\n    }\n\n    pub fn response(\n        mut self,\n        status: \u0026str,\n        description: impl Into\u003cString\u003e,\n        schema: Option\u003cSchema\u003e,\n    ) -\u003e Self {\n        let content = schema.map(|s| {\n            let mut content = HashMap::new();\n            content.insert(\n                \"application/json\".to_string(),\n                MediaType {\n                    schema: s,\n                    example: None,\n                    examples: None,\n                },\n            );\n            content\n        });\n\n        self.operation.responses.insert(\n            status.to_string(),\n            Response {\n                description: description.into(),\n                content,\n                headers: None,\n            },\n        );\n        self\n    }\n\n    pub fn build(self) -\u003e Operation {\n        self.operation\n    }\n}\n\n/// Schema builder helpers\npub struct SchemaBuilder;\n\nimpl SchemaBuilder {\n    pub fn string() -\u003e Schema {\n        Schema {\n            schema_type: Some(\"string\".to_string()),\n            format: None,\n            description: None,\n            properties: None,\n            required: None,\n            items: None,\n            enum_values: None,\n            minimum: None,\n            maximum: None,\n            pattern: None,\n            reference: None,\n        }\n    }\n\n    pub fn integer() -\u003e Schema {\n        Schema {\n            schema_type: Some(\"integer\".to_string()),\n            format: Some(\"int32\".to_string()),\n            ..Self::string()\n        }\n    }\n\n    pub fn number() -\u003e Schema {\n        Schema {\n            schema_type: Some(\"number\".to_string()),\n            format: Some(\"double\".to_string()),\n            ..Self::string()\n        }\n    }\n\n    pub fn boolean() -\u003e Schema {\n        Schema {\n            schema_type: Some(\"boolean\".to_string()),\n            ..Self::string()\n        }\n    }\n\n    pub fn array(items: Schema) -\u003e Schema {\n        Schema {\n            schema_type: Some(\"array\".to_string()),\n            items: Some(Box::new(items)),\n            ..Self::string()\n        }\n    }\n\n    pub fn object(properties: HashMap\u003cString, Schema\u003e, required: Vec\u003cString\u003e) -\u003e Schema {\n        Schema {\n            schema_type: Some(\"object\".to_string()),\n            properties: Some(properties),\n            required: Some(required),\n            ..Self::string()\n        }\n    }\n\n    pub fn reference(path: impl Into\u003cString\u003e) -\u003e Schema {\n        Schema {\n            reference: Some(path.into()),\n            ..Self::string()\n        }\n    }\n}\n\n/// GraphQL schema documentation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GraphQLSchema {\n    pub types: HashMap\u003cString, GraphQLType\u003e,\n    pub query: String,\n    pub mutation: Option\u003cString\u003e,\n    pub subscription: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GraphQLType {\n    pub kind: GraphQLTypeKind,\n    pub description: Option\u003cString\u003e,\n    pub fields: Option\u003cHashMap\u003cString, GraphQLField\u003e\u003e,\n    pub values: Option\u003cVec\u003cGraphQLEnumValue\u003e\u003e,\n    pub interfaces: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum GraphQLTypeKind {\n    Object,\n    Interface,\n    Union,\n    Enum,\n    InputObject,\n    Scalar,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GraphQLField {\n    pub field_type: String,\n    pub description: Option\u003cString\u003e,\n    pub args: Option\u003cHashMap\u003cString, GraphQLArgument\u003e\u003e,\n    pub deprecation_reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GraphQLArgument {\n    pub arg_type: String,\n    pub description: Option\u003cString\u003e,\n    pub default_value: Option\u003cValue\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GraphQLEnumValue {\n    pub name: String,\n    pub description: Option\u003cString\u003e,\n    pub deprecation_reason: Option\u003cString\u003e,\n}\n\n/// Documentation viewer component\npub struct ApiDocsViewer {\n    spec: OpenApiSpec,\n}\n\nimpl ApiDocsViewer {\n    pub fn new(spec: OpenApiSpec) -\u003e Self {\n        ApiDocsViewer { spec }\n    }\n}\n\nimpl Component for ApiDocsViewer {\n    fn render(\u0026self) -\u003e Element {\n        // Render Swagger UI or ReDoc style documentation\n        let description_element = if let Some(desc) = \u0026self.spec.info.description {\n            Element::Node {\n                tag: \"p\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(desc.clone())],\n            }\n        } else {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props::default(),\n                children: vec![],\n            }\n        };\n\n        let endpoints = self\n            .spec\n            .paths\n            .iter()\n            .map(|(path, item)| Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"endpoint\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    Element::Node {\n                        tag: \"h3\".to_string(),\n                        props: Props::default(),\n                        children: vec![Element::Text(path.clone())],\n                    },\n                    render_path_item(item),\n                ],\n            })\n            .collect();\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"api-docs\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(self.spec.info.title.clone())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(format!(\n                        \"Version: {}\",\n                        self.spec.info.version\n                    ))],\n                },\n                description_element,\n                Element::Node {\n                    tag: \"h2\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Endpoints\".to_string())],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props::default(),\n                    children: endpoints,\n                },\n            ],\n        }\n    }\n}\n\nfn render_path_item(item: \u0026PathItem) -\u003e Element {\n    let mut methods = vec![];\n\n    if let Some(op) = \u0026item.get {\n        methods.push(render_operation(\"GET\", op));\n    }\n    if let Some(op) = \u0026item.post {\n        methods.push(render_operation(\"POST\", op));\n    }\n    if let Some(op) = \u0026item.put {\n        methods.push(render_operation(\"PUT\", op));\n    }\n    if let Some(op) = \u0026item.delete {\n        methods.push(render_operation(\"DELETE\", op));\n    }\n\n    Element::Node {\n        tag: \"div\".to_string(),\n        props: Props {\n            class: Some(\"path-methods\".to_string()),\n            ..Default::default()\n        },\n        children: methods,\n    }\n}\n\nfn render_operation(method: \u0026str, op: \u0026Operation) -\u003e Element {\n    let mut children = vec![Element::Node {\n        tag: \"span\".to_string(),\n        props: Props {\n            class: Some(\"method\".to_string()),\n            ..Default::default()\n        },\n        children: vec![Element::Text(method.to_string())],\n    }];\n\n    if let Some(summary) = \u0026op.summary {\n        children.push(Element::Node {\n            tag: \"span\".to_string(),\n            props: Props {\n                class: Some(\"summary\".to_string()),\n                ..Default::default()\n            },\n            children: vec![Element::Text(summary.clone())],\n        });\n    }\n\n    if let Some(description) = \u0026op.description {\n        children.push(Element::Node {\n            tag: \"p\".to_string(),\n            props: Props {\n                class: Some(\"description\".to_string()),\n                ..Default::default()\n            },\n            children: vec![Element::Text(description.clone())],\n        });\n    }\n\n    Element::Node {\n        tag: \"div\".to_string(),\n        props: Props {\n            class: Some(\"operation\".to_string()),\n            ..Default::default()\n        },\n        children,\n    }\n}\n\n/// Export documentation\npub fn export_openapi_json(spec: \u0026OpenApiSpec) -\u003e String {\n    serde_json::to_string_pretty(spec).unwrap()\n}\n\npub fn export_openapi_yaml(spec: \u0026OpenApiSpec) -\u003e String {\n    // In real implementation, use serde_yaml\n    serde_json::to_string_pretty(spec).unwrap()\n}\n\n// Re-exports\nuse crate::component::{Component, Element, Props};\n","traces":[{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":152},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","app.rs"],"content":"//! Application Structure - L8\n\nuse crate::layers::*;\nuse crate::router::{Route, Router};\n\n/// Main application trait\npub trait Layer9App: L8::Architecture {\n    fn routes(\u0026self) -\u003e Vec\u003cRoute\u003e;\n    fn initialize(\u0026self);\n}\n\n/// Global app instance (type-erased)\n/// Initialize and run the app with reactive rendering\npub fn run_app\u003cT: Layer9App + 'static\u003e(app: T) {\n    // Set panic hook for better error messages\n    console_error_panic_hook::set_once();\n\n    // Initialize app\n    app.initialize();\n\n    // Setup router\n    let mut router = Router::new();\n    for route in app.routes() {\n        router.add_route(route);\n    }\n\n    // Navigate to current path\n    let window = web_sys::window().unwrap();\n    let location = window.location();\n    let pathname = location.pathname().unwrap();\n    router.navigate(\u0026pathname);\n}\n\n/// App builder\npub struct AppBuilder {\n    name: String,\n    routes: Vec\u003cRoute\u003e,\n}\n\nimpl AppBuilder {\n    pub fn new(name: impl Into\u003cString\u003e) -\u003e Self {\n        AppBuilder {\n            name: name.into(),\n            routes: vec![],\n        }\n    }\n\n    pub fn route(mut self, route: Route) -\u003e Self {\n        self.routes.push(route);\n        self\n    }\n\n    pub fn build(self) -\u003e impl Layer9App {\n        struct BuiltApp {\n            name: String,\n            routes: Vec\u003cRoute\u003e,\n        }\n\n        impl LayerBound for BuiltApp {\n            const LAYER: Layer = Layer::L8Architecture;\n        }\n\n        impl L8::Architecture for BuiltApp {\n            type App = DummyApp;\n\n            fn design() -\u003e L8::ArchitectureDesign {\n                L8::ArchitectureDesign {\n                    layers: vec![\n                        Layer::L1Infrastructure,\n                        Layer::L2Platform,\n                        Layer::L3Runtime,\n                        Layer::L4Services,\n                        Layer::L5Components,\n                        Layer::L6Features,\n                        Layer::L7Application,\n                        Layer::L8Architecture,\n                        Layer::L9Philosophy,\n                    ],\n                    boundaries: vec![],\n                }\n            }\n        }\n\n        impl Layer9App for BuiltApp {\n            fn routes(\u0026self) -\u003e Vec\u003cRoute\u003e {\n                self.routes.clone()\n            }\n\n            fn initialize(\u0026self) {\n                web_sys::console::log_1(\u0026format!(\"Layer9 App '{}' initialized\", self.name).into());\n            }\n        }\n\n        // Dummy app type for now\n        struct DummyApp;\n\n        impl LayerBound for DummyApp {\n            const LAYER: Layer = Layer::L7Application;\n        }\n\n        impl L7::Application for DummyApp {\n            type State = ();\n            type Action = ();\n\n            fn reduce(_state: \u0026Self::State, _action: Self::Action) -\u003e Self::State {}\n        }\n\n        BuiltApp {\n            name: self.name,\n            routes: self.routes,\n        }\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":27},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","async_component.rs"],"content":"//! Async Components with Suspense Support - L5\n//! \n//! This module provides async component loading with Suspense boundaries\n//! for handling loading states and error boundaries for error handling.\n\nuse std::cell::RefCell;\nuse std::future::Future;\nuse std::pin::Pin;\nuse std::rc::Rc;\n\nuse wasm_bindgen_futures::spawn_local;\n\nuse crate::component::{Component, Element, Props};\nuse crate::error::ErrorBoundary;\nuse crate::hooks::{use_state, use_effect};\nuse crate::reactive::queue_current_render;\n\n/// Loading state for async components\n#[derive(Clone, Debug)]\npub enum AsyncState\u003cT\u003e {\n    Loading,\n    Success(T),\n    Error(String),\n}\n\n/// Suspense boundary component\npub struct Suspense {\n    children: Box\u003cdyn Component\u003e,\n    fallback: Box\u003cdyn Component\u003e,\n}\n\nimpl Suspense {\n    pub fn new(children: impl Component + 'static) -\u003e Self {\n        Suspense {\n            children: Box::new(children),\n            fallback: Box::new(DefaultLoadingComponent),\n        }\n    }\n\n    pub fn fallback(mut self, fallback: impl Component + 'static) -\u003e Self {\n        self.fallback = Box::new(fallback);\n        self\n    }\n}\n\nimpl Component for Suspense {\n    fn render(\u0026self) -\u003e Element {\n        // Check if any child component is in loading state\n        let is_loading = SUSPENSE_CONTEXT.with(|ctx| {\n            ctx.borrow().is_loading\n        });\n\n        if is_loading {\n            self.fallback.render()\n        } else {\n            // Render children within suspense context\n            with_suspense_context(|| {\n                self.children.render()\n            })\n        }\n    }\n}\n\n/// Default loading component\nstruct DefaultLoadingComponent;\n\nimpl Component for DefaultLoadingComponent {\n    fn render(\u0026self) -\u003e Element {\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"layer9-loading\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Text(\"Loading...\".to_string())\n            ],\n        }\n    }\n}\n\n/// Suspense context for tracking loading states\n#[derive(Clone)]\nstruct SuspenseContext {\n    is_loading: bool,\n    pending_count: u32,\n}\n\nthread_local! {\n    static SUSPENSE_CONTEXT: RefCell\u003cSuspenseContext\u003e = RefCell::new(SuspenseContext {\n        is_loading: false,\n        pending_count: 0,\n    });\n}\n\n/// Run a closure within a suspense context\nfn with_suspense_context\u003cT\u003e(f: impl FnOnce() -\u003e T) -\u003e T {\n    SUSPENSE_CONTEXT.with(|ctx| {\n        let prev_state = ctx.borrow().clone();\n        ctx.borrow_mut().is_loading = false;\n        ctx.borrow_mut().pending_count = 0;\n        \n        let result = f();\n        \n        // Restore previous state\n        *ctx.borrow_mut() = prev_state;\n        \n        result\n    })\n}\n\n/// Mark current suspense boundary as loading\nfn mark_suspense_loading() {\n    SUSPENSE_CONTEXT.with(|ctx| {\n        ctx.borrow_mut().is_loading = true;\n        ctx.borrow_mut().pending_count += 1;\n    });\n}\n\n/// Mark async operation as complete\nfn mark_suspense_complete() {\n    SUSPENSE_CONTEXT.with(|ctx| {\n        let mut context = ctx.borrow_mut();\n        if context.pending_count \u003e 0 {\n            context.pending_count -= 1;\n        }\n        if context.pending_count == 0 {\n            context.is_loading = false;\n        }\n    });\n}\n\n/// Async component trait\npub trait AsyncComponent: Component {\n    type Data: Clone + 'static;\n    \n    /// Load async data\n    fn load(\u0026self) -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cSelf::Data, String\u003e\u003e\u003e\u003e;\n    \n    /// Render with loaded data\n    fn render_with_data(\u0026self, data: \u0026Self::Data) -\u003e Element;\n}\n\n/// Wrapper to make async components work with the Component trait\npub struct AsyncComponentWrapper\u003cC: AsyncComponent\u003e {\n    inner: C,\n    state: Rc\u003cRefCell\u003cAsyncState\u003cC::Data\u003e\u003e\u003e,\n}\n\nimpl\u003cC: AsyncComponent\u003e AsyncComponentWrapper\u003cC\u003e {\n    pub fn new(component: C) -\u003e Self {\n        AsyncComponentWrapper {\n            inner: component,\n            state: Rc::new(RefCell::new(AsyncState::Loading)),\n        }\n    }\n}\n\nimpl\u003cC: AsyncComponent + 'static\u003e Component for AsyncComponentWrapper\u003cC\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let state = self.state.clone();\n        let inner = \u0026self.inner;\n        \n        // Use effect to load data on mount\n        use_effect((), {\n            let state = state.clone();\n            let future = inner.load();\n            \n            move || {\n                // Mark suspense as loading\n                mark_suspense_loading();\n                \n                // Spawn async task\n                spawn_local(async move {\n                    match future.await {\n                        Ok(data) =\u003e {\n                            *state.borrow_mut() = AsyncState::Success(data);\n                        }\n                        Err(err) =\u003e {\n                            *state.borrow_mut() = AsyncState::Error(err);\n                        }\n                    }\n                    \n                    // Mark as complete and trigger re-render\n                    mark_suspense_complete();\n                    queue_current_render();\n                });\n                \n                // Cleanup function\n                || {}\n            }\n        });\n        \n        // Render based on current state\n        match \u0026*self.state.borrow() {\n            AsyncState::Loading =\u003e {\n                // Suspense will handle this\n                Element::Text(\"\".to_string())\n            }\n            AsyncState::Success(data) =\u003e {\n                self.inner.render_with_data(data)\n            }\n            AsyncState::Error(err) =\u003e {\n                // Error boundary will catch this\n                panic!(\"Async component error: {}\", err);\n            }\n        }\n    }\n}\n\n/// Hook for async data loading\npub fn use_async\u003cT, F\u003e(loader: F) -\u003e AsyncState\u003cT\u003e\nwhere\n    T: Clone + 'static,\n    F: FnOnce() -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cT, String\u003e\u003e\u003e\u003e + Clone + 'static,\n{\n    let (state, set_state) = use_state(|| AsyncState::\u003cT\u003e::Loading);\n    \n    use_effect((), move || {\n        // Mark suspense as loading\n        mark_suspense_loading();\n        \n        let future = loader();\n        \n        // Spawn async task\n        spawn_local(async move {\n            match future.await {\n                Ok(data) =\u003e {\n                    set_state(AsyncState::Success(data));\n                }\n                Err(err) =\u003e {\n                    set_state(AsyncState::Error(err));\n                }\n            }\n            \n            // Mark as complete\n            mark_suspense_complete();\n        });\n        \n        // Cleanup\n        || {}\n    });\n    \n    state\n}\n\n/// Create an async component\npub fn async_component\u003cC: AsyncComponent + 'static\u003e(component: C) -\u003e impl Component {\n    AsyncComponentWrapper::new(component)\n}\n\n/// Example async component\npub struct AsyncDataComponent {\n    url: String,\n}\n\nimpl AsyncDataComponent {\n    pub fn new(url: impl Into\u003cString\u003e) -\u003e Self {\n        AsyncDataComponent {\n            url: url.into(),\n        }\n    }\n}\n\nimpl Component for AsyncDataComponent {\n    fn render(\u0026self) -\u003e Element {\n        // Use async hook\n        let data = use_async({\n            let url = self.url.clone();\n            move || {\n                Box::pin(async move {\n                    // Simulate async data fetching - for now just return dummy data\n                    // TODO: Implement proper fetch when async runtime is ready\n                    Ok(format!(\"Data from {}\", url))\n                })\n            }\n        });\n        \n        match data {\n            AsyncState::Loading =\u003e Element::Text(\"Loading data...\".to_string()),\n            AsyncState::Success(text) =\u003e {\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props::default(),\n                    children: vec![\n                        Element::Text(format!(\"Data: {}\", text))\n                    ],\n                }\n            }\n            AsyncState::Error(err) =\u003e {\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"error\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Text(format!(\"Error: {}\", err))\n                    ],\n                }\n            }\n        }\n    }\n}\n\n/// Helper to create a Suspense boundary with error handling\npub fn with_async_boundary(\n    children: impl Component + 'static,\n    loading: impl Component + 'static,\n    error_fallback: impl Fn(\u0026crate::error::ErrorInfo) -\u003e Element + 'static,\n) -\u003e impl Component {\n    ErrorBoundary::new(\n        Suspense::new(children).fallback(loading)\n    ).fallback(error_fallback)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_async_state() {\n        let loading: AsyncState\u003cString\u003e = AsyncState::Loading;\n        assert!(matches!(loading, AsyncState::Loading));\n        \n        let success = AsyncState::Success(\"data\".to_string());\n        assert!(matches!(success, AsyncState::Success(_)));\n        \n        let error: AsyncState\u003cString\u003e = AsyncState::Error(\"error\".to_string());\n        assert!(matches!(error, AsyncState::Error(_)));\n    }\n}","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":58},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","async_component_v2.rs"],"content":"//! Simplified Async Components with Suspense Support - L5\n//! \n//! This module provides a simpler async component implementation\n//! that works within current WASM and lifetime constraints.\n\nuse std::cell::RefCell;\nuse std::rc::Rc;\n\nuse wasm_bindgen_futures::spawn_local;\n\nuse crate::component::{Component, Element, Props, use_state};\nuse crate::error::ErrorBoundary;\nuse crate::hooks::use_effect;\nuse crate::reactive_v2::queue_current_render;\n\n/// Loading state for async components\n#[derive(Clone, Debug)]\npub enum AsyncState\u003cT\u003e {\n    Loading,\n    Success(T),\n    Error(String),\n}\n\n/// Suspense boundary component\npub struct Suspense {\n    children: Box\u003cdyn Component\u003e,\n    fallback: Box\u003cdyn Component\u003e,\n}\n\nimpl Suspense {\n    pub fn new(children: impl Component + 'static) -\u003e Self {\n        Suspense {\n            children: Box::new(children),\n            fallback: Box::new(DefaultLoadingComponent),\n        }\n    }\n\n    pub fn fallback(mut self, fallback: impl Component + 'static) -\u003e Self {\n        self.fallback = Box::new(fallback);\n        self\n    }\n}\n\nimpl Component for Suspense {\n    fn render(\u0026self) -\u003e Element {\n        // For now, just render children directly\n        // In a full implementation, we'd track loading state\n        self.children.render()\n    }\n}\n\n/// Default loading component\nstruct DefaultLoadingComponent;\n\nimpl Component for DefaultLoadingComponent {\n    fn render(\u0026self) -\u003e Element {\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"layer9-loading\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Text(\"Loading...\".to_string())\n            ],\n        }\n    }\n}\n\n/// Async data container\npub struct AsyncData\u003cT: Clone + 'static\u003e {\n    state: Rc\u003cRefCell\u003cAsyncState\u003cT\u003e\u003e\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e AsyncData\u003cT\u003e {\n    pub fn new() -\u003e Self {\n        AsyncData {\n            state: Rc::new(RefCell::new(AsyncState::Loading)),\n        }\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e Default for AsyncData\u003cT\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e AsyncData\u003cT\u003e {\n    pub fn load\u003cF\u003e(\u0026self, f: F)\n    where\n        F: FnOnce() + 'static,\n    {\n        f();\n    }\n    \n    pub fn set_loading(\u0026self) {\n        *self.state.borrow_mut() = AsyncState::Loading;\n        queue_current_render();\n    }\n    \n    pub fn set_success(\u0026self, data: T) {\n        *self.state.borrow_mut() = AsyncState::Success(data);\n        queue_current_render();\n    }\n    \n    pub fn set_error(\u0026self, error: String) {\n        *self.state.borrow_mut() = AsyncState::Error(error);\n        queue_current_render();\n    }\n    \n    pub fn get(\u0026self) -\u003e AsyncState\u003cT\u003e {\n        self.state.borrow().clone()\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e Clone for AsyncData\u003cT\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        AsyncData {\n            state: self.state.clone(),\n        }\n    }\n}\n\n/// Hook for async data loading with manual control\npub fn use_async_data\u003cT: Clone + 'static\u003e() -\u003e AsyncData\u003cT\u003e {\n    let state = use_state(|| AsyncData::new());\n    state.get()\n}\n\n/// Example component that loads data asynchronously\npub struct AsyncExample;\n\nimpl Component for AsyncExample {\n    fn render(\u0026self) -\u003e Element {\n        let data = use_async_data::\u003cString\u003e();\n        \n        // Load data on mount\n        use_effect((), {\n            let data = data.clone();\n            move || {\n                // Start loading\n                data.set_loading();\n                \n                // Spawn async task\n                spawn_local(async move {\n                    // Simulate delay\n                    gloo_timers::future::TimeoutFuture::new(1000).await;\n                    \n                    // Set success\n                    data.set_success(\"Hello from async!\".to_string());\n                });\n                \n                // Cleanup\n                || {}\n            }\n        });\n        \n        match data.get() {\n            AsyncState::Loading =\u003e Element::Text(\"Loading...\".to_string()),\n            AsyncState::Success(text) =\u003e Element::Text(text),\n            AsyncState::Error(err) =\u003e Element::Text(format!(\"Error: {}\", err)),\n        }\n    }\n}\n\n/// Helper to create a component with error boundary\npub fn with_error_boundary(\n    children: impl Component + 'static,\n    error_fallback: impl Fn(\u0026crate::error::ErrorInfo) -\u003e Element + 'static,\n) -\u003e impl Component {\n    ErrorBoundary::new(children).fallback(error_fallback)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_async_state() {\n        let loading: AsyncState\u003cString\u003e = AsyncState::Loading;\n        assert!(matches!(loading, AsyncState::Loading));\n        \n        let success = AsyncState::Success(\"data\".to_string());\n        assert!(matches!(success, AsyncState::Success(_)));\n        \n        let error: AsyncState\u003cString\u003e = AsyncState::Error(\"error\".to_string());\n        assert!(matches!(error, AsyncState::Error(_)));\n    }\n    \n    #[test]\n    fn test_async_data() {\n        let data = AsyncData::\u003cString\u003e::new();\n        assert!(matches!(data.get(), AsyncState::Loading));\n        \n        data.set_success(\"test\".to_string());\n        assert!(matches!(data.get(), AsyncState::Success(s) if s == \"test\"));\n        \n        data.set_error(\"error\".to_string());\n        assert!(matches!(data.get(), AsyncState::Error(e) if e == \"error\"));\n    }\n}","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":103,"address":[],"length":0,"stats":{"Line":1}},{"line":104,"address":[],"length":0,"stats":{"Line":1}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":112,"address":[],"length":0,"stats":{"Line":3}},{"line":113,"address":[],"length":0,"stats":{"Line":3}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}}],"covered":10,"coverable":50},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","auth.rs"],"content":"//! Authentication support for Layer9\n\nuse crate::config::Config;\nuse crate::jwt::{Jwt, JwtClaims};\nuse sha2::{Digest, Sha256};\nuse base64::{engine::general_purpose::STANDARD, Engine};\nuse web_sys::Storage;\n\n#[derive(Debug, Clone)]\npub struct AuthContext {\n    pub user: Option\u003cUser\u003e,\n    pub token: Option\u003cString\u003e,\n    pub permissions: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct User {\n    pub id: String,\n    pub username: String,\n    pub email: String,\n    pub roles: Vec\u003cString\u003e,\n}\n\nimpl AuthContext {\n    pub fn new() -\u003e Self {\n        Self {\n            user: None,\n            token: None,\n            permissions: Vec::new(),\n        }\n    }\n    \n    pub fn is_authenticated(\u0026self) -\u003e bool {\n        self.user.is_some()\n    }\n    \n    pub fn has_permission(\u0026self, permission: \u0026str) -\u003e bool {\n        self.permissions.contains(\u0026permission.to_string())\n    }\n    \n    pub fn login(\u0026mut self, user: User, token: String) {\n        self.user = Some(user);\n        self.token = Some(token);\n    }\n    \n    pub fn logout(\u0026mut self) {\n        self.user = None;\n        self.token = None;\n        self.permissions.clear();\n    }\n}\n\npub trait AuthProvider: AuthProviderClone {\n    fn authenticate(\u0026self, username: \u0026str, password: \u0026str) -\u003e Result\u003c(User, String), String\u003e;\n    fn validate_token(\u0026self, token: \u0026str) -\u003e Result\u003cUser, String\u003e;\n    fn refresh_token(\u0026self, token: \u0026str) -\u003e Result\u003cString, String\u003e;\n}\n\n// Helper trait to make AuthProvider object-safe and cloneable\npub trait AuthProviderClone {\n    fn clone_box(\u0026self) -\u003e Box\u003cdyn AuthProvider\u003e;\n}\n\nimpl\u003cT\u003e AuthProviderClone for T\nwhere\n    T: AuthProvider + Clone + 'static,\n{\n    fn clone_box(\u0026self) -\u003e Box\u003cdyn AuthProvider\u003e {\n        Box::new(self.clone())\n    }\n}\n\nimpl Clone for Box\u003cdyn AuthProvider\u003e {\n    fn clone(\u0026self) -\u003e Box\u003cdyn AuthProvider\u003e {\n        self.clone_box()\n    }\n}\n\n/// Mock auth provider for testing\n#[derive(Clone)]\npub struct MockAuthProvider;\n\nimpl AuthProvider for MockAuthProvider {\n    fn authenticate(\u0026self, username: \u0026str, _password: \u0026str) -\u003e Result\u003c(User, String), String\u003e {\n        let user = User {\n            id: \"123\".to_string(),\n            username: username.to_string(),\n            email: format!(\"{}@example.com\", username),\n            roles: vec![\"user\".to_string()],\n        };\n        let token = \"mock-token-123\".to_string();\n        Ok((user, token))\n    }\n    \n    fn validate_token(\u0026self, _token: \u0026str) -\u003e Result\u003cUser, String\u003e {\n        Ok(User {\n            id: \"123\".to_string(),\n            username: \"testuser\".to_string(),\n            email: \"testuser@example.com\".to_string(),\n            roles: vec![\"user\".to_string()],\n        })\n    }\n    \n    fn refresh_token(\u0026self, _token: \u0026str) -\u003e Result\u003cString, String\u003e {\n        Ok(\"refreshed-token-456\".to_string())\n    }\n}\n\n/// JWT-based authentication provider\n#[derive(Clone)]\npub struct JwtAuthProvider {\n    jwt: Jwt,\n    users: Vec\u003c(String, String, User)\u003e, // (username, password_hash, user)\n}\n\nimpl JwtAuthProvider {\n    pub fn new(secret: String) -\u003e Self {\n        Self {\n            jwt: Jwt::new(secret),\n            users: Vec::new(),\n        }\n    }\n\n    pub fn add_user(\u0026mut self, username: String, password: String, email: String, roles: Vec\u003cString\u003e) -\u003e String {\n        let id = format!(\"user-{}\", self.users.len() + 1);\n        let password_hash = self.hash_password(\u0026password);\n        let user = User {\n            id: id.clone(),\n            username: username.clone(),\n            email,\n            roles,\n        };\n        self.users.push((username, password_hash, user));\n        id\n    }\n\n    fn hash_password(\u0026self, password: \u0026str) -\u003e String {\n        let mut hasher = Sha256::new();\n        hasher.update(password.as_bytes());\n        hasher.update(b\"layer9-salt\"); // In production, use a random salt per user\n        let result = hasher.finalize();\n        STANDARD.encode(result)\n    }\n\n    fn verify_password(\u0026self, password: \u0026str, hash: \u0026str) -\u003e bool {\n        let computed_hash = self.hash_password(password);\n        computed_hash == hash\n    }\n\n    fn get_local_storage() -\u003e Option\u003cStorage\u003e {\n        web_sys::window()?.local_storage().ok()?\n    }\n\n    pub fn store_token(token: \u0026str) -\u003e Result\u003c(), String\u003e {\n        let storage = Self::get_local_storage()\n            .ok_or_else(|| \"Local storage not available\".to_string())?;\n        storage.set_item(\"auth_token\", token)\n            .map_err(|_| \"Failed to store token\".to_string())\n    }\n\n    pub fn get_stored_token() -\u003e Option\u003cString\u003e {\n        let storage = Self::get_local_storage()?;\n        storage.get_item(\"auth_token\").ok()?\n    }\n\n    pub fn clear_stored_token() -\u003e Result\u003c(), String\u003e {\n        let storage = Self::get_local_storage()\n            .ok_or_else(|| \"Local storage not available\".to_string())?;\n        storage.remove_item(\"auth_token\")\n            .map_err(|_| \"Failed to clear token\".to_string())\n    }\n}\n\nimpl AuthProvider for JwtAuthProvider {\n    fn authenticate(\u0026self, username: \u0026str, password: \u0026str) -\u003e Result\u003c(User, String), String\u003e {\n        // Find user\n        let (_, stored_hash, user) = self.users.iter()\n            .find(|(u, _, _)| u == username)\n            .ok_or_else(|| \"Invalid username or password\".to_string())?;\n\n        // Verify password\n        if !self.verify_password(password, stored_hash) {\n            return Err(\"Invalid username or password\".to_string());\n        }\n\n        // Create JWT token\n        let now = js_sys::Date::now() as u64 / 1000;\n        let claims = JwtClaims {\n            sub: user.id.clone(),\n            username: user.username.clone(),\n            email: user.email.clone(),\n            roles: user.roles.clone(),\n            exp: now + 86400, // 24 hours\n            iat: now,\n            permissions: self.get_permissions_for_roles(\u0026user.roles),\n        };\n\n        let token = self.jwt.create_token(\u0026claims)?;\n        \n        // Store token in local storage\n        let _ = Self::store_token(\u0026token);\n\n        Ok((user.clone(), token))\n    }\n\n    fn validate_token(\u0026self, token: \u0026str) -\u003e Result\u003cUser, String\u003e {\n        let claims = self.jwt.verify_token(token)?;\n        \n        Ok(User {\n            id: claims.sub,\n            username: claims.username,\n            email: claims.email,\n            roles: claims.roles,\n        })\n    }\n\n    fn refresh_token(\u0026self, token: \u0026str) -\u003e Result\u003cString, String\u003e {\n        let claims = self.jwt.verify_token(token)?;\n        \n        // Create new token with extended expiration\n        let now = js_sys::Date::now() as u64 / 1000;\n        let new_claims = JwtClaims {\n            sub: claims.sub,\n            username: claims.username,\n            email: claims.email,\n            roles: claims.roles,\n            exp: now + 86400, // Another 24 hours\n            iat: now,\n            permissions: claims.permissions,\n        };\n\n        let new_token = self.jwt.create_token(\u0026new_claims)?;\n        \n        // Store new token\n        let _ = Self::store_token(\u0026new_token);\n\n        Ok(new_token)\n    }\n}\n\nimpl JwtAuthProvider {\n    pub fn get_permissions_for_roles(\u0026self, roles: \u0026[String]) -\u003e Vec\u003cString\u003e {\n        let mut permissions = Vec::new();\n        \n        for role in roles {\n            match role.as_str() {\n                \"admin\" =\u003e {\n                    permissions.extend_from_slice(\u0026[\n                        \"read\".to_string(),\n                        \"write\".to_string(),\n                        \"delete\".to_string(),\n                        \"admin\".to_string(),\n                    ]);\n                }\n                \"user\" =\u003e {\n                    permissions.extend_from_slice(\u0026[\n                        \"read\".to_string(),\n                        \"write\".to_string(),\n                    ]);\n                }\n                \"guest\" =\u003e {\n                    permissions.push(\"read\".to_string());\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        permissions.sort();\n        permissions.dedup();\n        permissions\n    }\n}\n\n// Hook function for authentication\npub fn use_auth() -\u003e AuthContext {\n    AuthContext::new()\n}\n\n// Auth service for managing authentication state\n#[derive(Clone)]\npub struct AuthService {\n    context: AuthContext,\n    provider: Box\u003cdyn AuthProvider\u003e,\n}\n\nimpl AuthService {\n    pub fn new(provider: Box\u003cdyn AuthProvider\u003e) -\u003e Self {\n        let mut service = Self {\n            context: AuthContext::new(),\n            provider,\n        };\n        \n        // Try to restore session from stored token\n        service.restore_session();\n        service\n    }\n\n    pub fn with_jwt_provider(secret: String) -\u003e Self {\n        Self::new(Box::new(JwtAuthProvider::new(secret)))\n    }\n\n    pub fn with_mock_provider() -\u003e Self {\n        Self::new(Box::new(MockAuthProvider))\n    }\n    \n    /// Create an AuthService with configuration\n    pub fn with_config(config: \u0026Config) -\u003e Self {\n        if config.should_use_mock_auth() {\n            Self::with_mock_provider()\n        } else {\n            let secret = config.get_jwt_secret();\n            Self::with_jwt_provider(secret)\n        }\n    }\n\n    pub async fn login(\u0026mut self, username: \u0026str, password: \u0026str) -\u003e Result\u003c(), String\u003e {\n        let (user, token) = self.provider.authenticate(username, password)?;\n        \n        // Update permissions based on user roles\n        let permissions = self.get_permissions_for_user(\u0026user);\n        \n        self.context.user = Some(user);\n        self.context.token = Some(token);\n        self.context.permissions = permissions;\n        \n        Ok(())\n    }\n\n    pub fn logout(\u0026mut self) {\n        self.context.logout();\n        // Clear stored token\n        let _ = JwtAuthProvider::clear_stored_token();\n    }\n\n    pub fn is_authenticated(\u0026self) -\u003e bool {\n        self.context.is_authenticated()\n    }\n\n    pub fn get_context(\u0026self) -\u003e \u0026AuthContext {\n        \u0026self.context\n    }\n\n    pub fn get_current_user(\u0026self) -\u003e Option\u003c\u0026User\u003e {\n        self.context.user.as_ref()\n    }\n\n    pub async fn refresh_session(\u0026mut self) -\u003e Result\u003c(), String\u003e {\n        if let Some(token) = \u0026self.context.token {\n            let new_token = self.provider.refresh_token(token)?;\n            self.context.token = Some(new_token);\n            Ok(())\n        } else {\n            Err(\"No active session to refresh\".to_string())\n        }\n    }\n\n    pub fn validate_token(\u0026self, token: \u0026str) -\u003e Result\u003cUser, String\u003e {\n        self.provider.validate_token(token)\n    }\n\n    fn restore_session(\u0026mut self) {\n        if let Some(token) = JwtAuthProvider::get_stored_token() {\n            if let Ok(user) = self.provider.validate_token(\u0026token) {\n                let permissions = self.get_permissions_for_user(\u0026user);\n                self.context.user = Some(user);\n                self.context.token = Some(token);\n                self.context.permissions = permissions;\n            }\n        }\n    }\n\n    fn get_permissions_for_user(\u0026self, user: \u0026User) -\u003e Vec\u003cString\u003e {\n        let mut permissions = Vec::new();\n        \n        for role in \u0026user.roles {\n            match role.as_str() {\n                \"admin\" =\u003e {\n                    permissions.extend_from_slice(\u0026[\n                        \"read\".to_string(),\n                        \"write\".to_string(),\n                        \"delete\".to_string(),\n                        \"admin\".to_string(),\n                    ]);\n                }\n                \"user\" =\u003e {\n                    permissions.extend_from_slice(\u0026[\n                        \"read\".to_string(),\n                        \"write\".to_string(),\n                    ]);\n                }\n                \"guest\" =\u003e {\n                    permissions.push(\"read\".to_string());\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        permissions.sort();\n        permissions.dedup();\n        permissions\n    }\n}\n\n// Implement Debug manually since AuthProvider doesn't implement Debug\nimpl std::fmt::Debug for AuthService {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.debug_struct(\"AuthService\")\n            .field(\"context\", \u0026self.context)\n            .field(\"provider\", \u0026\"\u003cAuthProvider\u003e\")\n            .finish()\n    }\n}\n\nimpl Default for AuthService {\n    fn default() -\u003e Self {\n        let config = Config::get_or_init();\n        \n        if config.should_use_mock_auth() {\n            // Use mock provider for testing\n            Self::with_mock_provider()\n        } else {\n            // Use JWT provider with configured or default secret\n            let secret = config.get_jwt_secret();\n            Self::with_jwt_provider(secret)\n        }\n    }\n}\n\n// Protected component wrapper\n#[derive(Debug, Clone)]\npub struct Protected {\n    pub required_permission: Option\u003cString\u003e,\n    pub redirect_to: String,\n}\n\nimpl Protected {\n    pub fn new() -\u003e Self {\n        Self {\n            required_permission: None,\n            redirect_to: \"/login\".to_string(),\n        }\n    }\n\n    pub fn with_permission(mut self, permission: String) -\u003e Self {\n        self.required_permission = Some(permission);\n        self\n    }\n\n    pub fn with_redirect(mut self, redirect: String) -\u003e Self {\n        self.redirect_to = redirect;\n        self\n    }\n\n    pub fn check_access(\u0026self, auth_context: \u0026AuthContext) -\u003e bool {\n        if !auth_context.is_authenticated() {\n            return false;\n        }\n\n        if let Some(permission) = \u0026self.required_permission {\n            return auth_context.has_permission(permission);\n        }\n\n        true\n    }\n}\n\nimpl Default for Protected {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Default for AuthContext {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":182},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","auth_config_tests.rs"],"content":"//! Tests for authentication configuration\n\n#[cfg(test)]\nmod tests {\n    use crate::auth::*;\n    use crate::config::{Config, ConfigBuilder};\n    use wasm_bindgen_test::*;\n    \n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn test_auth_service_default_uses_jwt() {\n        // Clear any existing config\n        let _ = Config::get_or_init();\n        \n        // Create default auth service\n        let auth_service = AuthService::default();\n        \n        // The service should be created successfully\n        assert!(!auth_service.is_authenticated());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_auth_service_with_config_mock() {\n        let config = ConfigBuilder::new()\n            .use_mock_auth(true)\n            .build();\n        \n        let auth_service = AuthService::with_config(\u0026config);\n        \n        // Mock provider should allow easy authentication\n        let mut auth_service_mut = auth_service;\n        let result = auth_service_mut.login(\"testuser\", \"anypassword\").await;\n        assert!(result.is_ok());\n        assert!(auth_service_mut.is_authenticated());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_auth_service_with_config_jwt() {\n        let config = ConfigBuilder::new()\n            .jwt_secret(\"test-secret-for-testing-purposes-only\".to_string())\n            .use_mock_auth(false)\n            .build();\n        \n        let auth_service = AuthService::with_config(\u0026config);\n        \n        // JWT provider requires valid credentials\n        let mut auth_service_mut = auth_service;\n        let result = auth_service_mut.login(\"nonexistent\", \"wrongpassword\").await;\n        assert!(result.is_err());\n        assert!(!auth_service_mut.is_authenticated());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_jwt_provider_with_custom_secret() {\n        let custom_secret = \"my-custom-jwt-secret-for-testing\";\n        let mut auth_service = AuthService::with_jwt_provider(custom_secret.to_string());\n        \n        // Service should be created but not authenticated\n        assert!(!auth_service.is_authenticated());\n        \n        // Try to login with non-existent user\n        let result = auth_service.login(\"testuser\", \"password\").await;\n        assert!(result.is_err());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_config_jwt_secret_fallback() {\n        let config = Config::new();\n        \n        // Should return default secret with warning\n        let secret = config.get_jwt_secret();\n        assert!(!secret.is_empty());\n        assert_eq!(secret, config.default_jwt_secret);\n    }\n\n    #[wasm_bindgen_test]\n    fn test_config_with_jwt_secret() {\n        let config = ConfigBuilder::new()\n            .jwt_secret(\"my-production-secret\".to_string())\n            .build();\n        \n        let secret = config.get_jwt_secret();\n        assert_eq!(secret, \"my-production-secret\");\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","auth_tests.rs"],"content":"//! Comprehensive tests for authentication module\n\n#[cfg(test)]\nmod tests {\n    use crate::auth::*;\n    use wasm_bindgen_test::*;\n    \n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn test_auth_context_creation() {\n        let context = AuthContext::new();\n        assert!(!context.is_authenticated());\n        assert!(context.user.is_none());\n        assert!(context.token.is_none());\n        assert!(context.permissions.is_empty());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_auth_context_login_logout() {\n        let mut context = AuthContext::new();\n        \n        let user = User {\n            id: \"1\".to_string(),\n            username: \"testuser\".to_string(),\n            email: \"test@example.com\".to_string(),\n            roles: vec![\"user\".to_string()],\n        };\n        \n        context.login(user.clone(), \"test-token\".to_string());\n        assert!(context.is_authenticated());\n        assert_eq!(context.user.as_ref().unwrap().username, \"testuser\");\n        assert_eq!(context.token.as_ref().unwrap(), \"test-token\");\n        \n        context.logout();\n        assert!(!context.is_authenticated());\n        assert!(context.user.is_none());\n        assert!(context.token.is_none());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_auth_context_permissions() {\n        let mut context = AuthContext::new();\n        context.permissions = vec![\"read\".to_string(), \"write\".to_string()];\n        \n        assert!(context.has_permission(\"read\"));\n        assert!(context.has_permission(\"write\"));\n        assert!(!context.has_permission(\"delete\"));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_mock_auth_provider() {\n        let provider = MockAuthProvider;\n        \n        // Test authentication\n        let result = provider.authenticate(\"testuser\", \"password\");\n        assert!(result.is_ok());\n        let (user, token) = result.unwrap();\n        assert_eq!(user.username, \"testuser\");\n        assert_eq!(user.email, \"testuser@example.com\");\n        assert_eq!(token, \"mock-token-123\");\n        \n        // Test token validation\n        let result = provider.validate_token(\"any-token\");\n        assert!(result.is_ok());\n        let user = result.unwrap();\n        assert_eq!(user.username, \"testuser\");\n        \n        // Test token refresh\n        let result = provider.refresh_token(\"old-token\");\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"refreshed-token-456\");\n    }\n\n    #[wasm_bindgen_test]\n    fn test_jwt_auth_provider_user_management() {\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        \n        // Add users\n        let id1 = provider.add_user(\n            \"alice\".to_string(),\n            \"password123\".to_string(),\n            \"alice@example.com\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        let id2 = provider.add_user(\n            \"bob\".to_string(),\n            \"secret456\".to_string(),\n            \"bob@example.com\".to_string(),\n            vec![\"admin\".to_string()],\n        );\n        \n        assert_eq!(id1, \"user-1\");\n        assert_eq!(id2, \"user-2\");\n        \n        // Test authentication with correct password\n        let result = provider.authenticate(\"alice\", \"password123\");\n        assert!(result.is_ok());\n        let (user, token) = result.unwrap();\n        assert_eq!(user.username, \"alice\");\n        assert_eq!(user.email, \"alice@example.com\");\n        assert!(!token.is_empty());\n        \n        // Test authentication with wrong password\n        let result = provider.authenticate(\"alice\", \"wrongpassword\");\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Invalid username or password\");\n        \n        // Test authentication with non-existent user\n        let result = provider.authenticate(\"charlie\", \"password\");\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Invalid username or password\");\n    }\n\n    #[wasm_bindgen_test]\n    fn test_jwt_auth_provider_token_validation() {\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        \n        provider.add_user(\n            \"testuser\".to_string(),\n            \"password\".to_string(),\n            \"test@example.com\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        // Get a valid token\n        let (_, token) = provider.authenticate(\"testuser\", \"password\").unwrap();\n        \n        // Validate the token\n        let result = provider.validate_token(\u0026token);\n        assert!(result.is_ok());\n        let user = result.unwrap();\n        assert_eq!(user.username, \"testuser\");\n        assert_eq!(user.email, \"test@example.com\");\n        \n        // Test with invalid token\n        let result = provider.validate_token(\"invalid-token\");\n        assert!(result.is_err());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_jwt_auth_provider_token_refresh() {\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        \n        provider.add_user(\n            \"testuser\".to_string(),\n            \"password\".to_string(),\n            \"test@example.com\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        // Get a valid token\n        let (_, token) = provider.authenticate(\"testuser\", \"password\").unwrap();\n        \n        // Refresh the token\n        let result = provider.refresh_token(\u0026token);\n        assert!(result.is_ok());\n        let new_token = result.unwrap();\n        assert!(!new_token.is_empty());\n        assert_ne!(new_token, token); // Should be different\n        \n        // Validate the new token\n        let result = provider.validate_token(\u0026new_token);\n        assert!(result.is_ok());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_jwt_auth_provider_permissions() {\n        let provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        \n        // Test admin permissions\n        let admin_perms = provider.get_permissions_for_roles(\u0026vec![\"admin\".to_string()]);\n        assert!(admin_perms.contains(\u0026\"read\".to_string()));\n        assert!(admin_perms.contains(\u0026\"write\".to_string()));\n        assert!(admin_perms.contains(\u0026\"delete\".to_string()));\n        assert!(admin_perms.contains(\u0026\"admin\".to_string()));\n        \n        // Test user permissions\n        let user_perms = provider.get_permissions_for_roles(\u0026vec![\"user\".to_string()]);\n        assert!(user_perms.contains(\u0026\"read\".to_string()));\n        assert!(user_perms.contains(\u0026\"write\".to_string()));\n        assert!(!user_perms.contains(\u0026\"delete\".to_string()));\n        assert!(!user_perms.contains(\u0026\"admin\".to_string()));\n        \n        // Test guest permissions\n        let guest_perms = provider.get_permissions_for_roles(\u0026vec![\"guest\".to_string()]);\n        assert!(guest_perms.contains(\u0026\"read\".to_string()));\n        assert!(!guest_perms.contains(\u0026\"write\".to_string()));\n        \n        // Test multiple roles\n        let multi_perms = provider.get_permissions_for_roles(\u0026vec![\"user\".to_string(), \"guest\".to_string()]);\n        assert!(multi_perms.contains(\u0026\"read\".to_string()));\n        assert!(multi_perms.contains(\u0026\"write\".to_string()));\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_auth_service_with_mock_provider() {\n        let mut service = AuthService::with_mock_provider();\n        \n        assert!(!service.is_authenticated());\n        \n        // Test login\n        let result = service.login(\"testuser\", \"password\").await;\n        assert!(result.is_ok());\n        assert!(service.is_authenticated());\n        \n        let user = service.get_current_user().unwrap();\n        assert_eq!(user.username, \"testuser\");\n        \n        // Test logout\n        service.logout();\n        assert!(!service.is_authenticated());\n        assert!(service.get_current_user().is_none());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_auth_service_with_jwt_provider() {\n        // Create provider with user first\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        provider.add_user(\n            \"alice\".to_string(),\n            \"password123\".to_string(),\n            \"alice@example.com\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        let mut service = AuthService::new(Box::new(provider));\n        \n        // Test login with correct credentials\n        let result = service.login(\"alice\", \"password123\").await;\n        assert!(result.is_ok());\n        assert!(service.is_authenticated());\n        \n        let context = service.get_context();\n        assert!(context.has_permission(\"read\"));\n        assert!(context.has_permission(\"write\"));\n        assert!(!context.has_permission(\"admin\"));\n        \n        // Test session refresh\n        let result = service.refresh_session().await;\n        assert!(result.is_ok());\n        \n        // Test logout\n        service.logout();\n        assert!(!service.is_authenticated());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_protected_component() {\n        let protected = Protected::new()\n            .with_permission(\"admin\".to_string())\n            .with_redirect(\"/login\".to_string());\n        \n        // Test with unauthenticated context\n        let context = AuthContext::new();\n        assert!(!protected.check_access(\u0026context));\n        \n        // Test with authenticated user without permission\n        let mut context = AuthContext::new();\n        let user = User {\n            id: \"1\".to_string(),\n            username: \"user\".to_string(),\n            email: \"user@example.com\".to_string(),\n            roles: vec![\"user\".to_string()],\n        };\n        context.login(user, \"token\".to_string());\n        context.permissions = vec![\"read\".to_string(), \"write\".to_string()];\n        assert!(!protected.check_access(\u0026context));\n        \n        // Test with authenticated user with permission\n        context.permissions.push(\"admin\".to_string());\n        assert!(protected.check_access(\u0026context));\n        \n        // Test without required permission (any authenticated user)\n        let protected_any = Protected::new();\n        assert!(protected_any.check_access(\u0026context));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_use_auth_hook() {\n        let context = use_auth();\n        assert!(!context.is_authenticated());\n        assert!(context.user.is_none());\n        assert!(context.token.is_none());\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","auth_upload_integration_tests.rs"],"content":"//! Integration tests for authentication and file upload working together\n\n#[cfg(test)]\nmod tests {\n    use crate::auth::{AuthService, JwtAuthProvider};\n    use crate::upload::{FileUploadManager, FileUploadComponent};\n    use wasm_bindgen_test::*;\n    use web_sys::File;\n    use js_sys::{Uint8Array, Array};\n    \n    wasm_bindgen_test_configure!(run_in_browser);\n\n    /// Helper to create a test file\n    fn create_test_file(name: \u0026str, content: \u0026str) -\u003e File {\n        let bytes = content.as_bytes();\n        let array = Uint8Array::new_with_length(bytes.len() as u32);\n        array.copy_from(bytes);\n        \n        let file_parts = Array::new();\n        file_parts.push(\u0026array.buffer());\n        \n        File::new_with_blob_sequence(\u0026file_parts.into(), name).unwrap()\n    }\n\n    /// Helper to create an authenticated auth service\n    async fn create_authenticated_service() -\u003e AuthService {\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        provider.add_user(\n            \"testuser\".to_string(),\n            \"password123\".to_string(),\n            \"test@example.com\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        let mut service = AuthService::new(Box::new(provider));\n        service.login(\"testuser\", \"password123\").await.unwrap();\n        service\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_upload_with_authentication() {\n        // Create authenticated service\n        let auth_service = create_authenticated_service().await;\n        let auth_context = auth_service.get_context();\n        \n        // Verify we're authenticated\n        assert!(auth_context.is_authenticated());\n        assert!(auth_context.token.is_some());\n        \n        // Create file upload manager\n        let mut upload_manager = FileUploadManager::new();\n        let file = create_test_file(\"test.txt\", \"Hello, authenticated upload!\");\n        \n        // Simulate upload with authentication token\n        // The upload_file method should automatically include the auth token\n        let result = upload_manager.upload_file(file, \"/api/upload\").await;\n        \n        // Even though we can't actually make the HTTP request in tests,\n        // we verify the upload attempt was made\n        assert!(result.is_err()); // Will fail due to no actual server\n        \n        // Verify the auth token is available for the upload\n        let stored_token = crate::auth::JwtAuthProvider::get_stored_token();\n        assert!(stored_token.is_some());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_upload_without_authentication() {\n        // Clear any existing auth tokens\n        let _ = crate::auth::JwtAuthProvider::clear_stored_token();\n        \n        // Create upload manager without authentication\n        let mut upload_manager = FileUploadManager::new();\n        let file = create_test_file(\"test.txt\", \"Unauthenticated upload attempt\");\n        \n        // Attempt upload without auth token\n        let result = upload_manager.upload_file(file, \"/api/upload\").await;\n        \n        // Upload should still attempt (server would reject if auth required)\n        assert!(result.is_err()); // Will fail due to no actual server\n        \n        // Verify no auth token was available\n        let stored_token = crate::auth::JwtAuthProvider::get_stored_token();\n        assert!(stored_token.is_none());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_permission_based_upload() {\n        // Create auth service with different user roles\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        \n        // Admin user with upload permissions\n        provider.add_user(\n            \"admin\".to_string(),\n            \"admin123\".to_string(),\n            \"admin@example.com\".to_string(),\n            vec![\"admin\".to_string()],\n        );\n        \n        // Guest user without upload permissions\n        provider.add_user(\n            \"guest\".to_string(),\n            \"guest123\".to_string(),\n            \"guest@example.com\".to_string(),\n            vec![\"guest\".to_string()],\n        );\n        \n        let mut auth_service = AuthService::new(Box::new(provider));\n        \n        // Test admin upload\n        auth_service.login(\"admin\", \"admin123\").await.unwrap();\n        let admin_context = auth_service.get_context();\n        assert!(admin_context.has_permission(\"write\"));\n        assert!(admin_context.has_permission(\"admin\"));\n        \n        // Admin should be able to upload\n        let mut upload_manager = FileUploadManager::new();\n        let file = create_test_file(\"admin-file.txt\", \"Admin upload\");\n        let result = upload_manager.upload_file(file, \"/api/upload\").await;\n        assert!(result.is_err()); // Fails due to no server, but attempt was made\n        \n        // Logout and login as guest\n        auth_service.logout();\n        auth_service.login(\"guest\", \"guest123\").await.unwrap();\n        let guest_context = auth_service.get_context();\n        assert!(guest_context.has_permission(\"read\"));\n        assert!(!guest_context.has_permission(\"write\"));\n        \n        // Guest upload attempt - application logic should prevent this\n        // In a real app, the UI would check permissions before allowing upload\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_upload_component_with_auth() {\n        // Create authenticated service\n        let _auth_service = create_authenticated_service().await;\n        \n        // Create upload component\n        let upload_component = FileUploadComponent::new()\n            .with_url(\"/api/upload\".to_string())\n            .with_max_size(1024 * 1024); // 1MB\n        \n        // Render component (should work with auth)\n        let html = upload_component.render();\n        assert!(html.contains(\"file-upload-component\"));\n        assert!(html.contains(\"upload-area\"));\n        \n        // Verify auth token is available for component to use\n        let stored_token = crate::auth::JwtAuthProvider::get_stored_token();\n        assert!(stored_token.is_some());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_auth_token_in_upload_headers() {\n        // Create authenticated service with known token\n        let mut provider = JwtAuthProvider::new(\"test-secret\".to_string());\n        provider.add_user(\n            \"user\".to_string(),\n            \"pass\".to_string(),\n            \"user@test.com\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        let mut auth_service = AuthService::new(Box::new(provider));\n        auth_service.login(\"user\", \"pass\").await.unwrap();\n        \n        // Get the token\n        let token = crate::auth::JwtAuthProvider::get_stored_token().unwrap();\n        assert!(!token.is_empty());\n        \n        // Create upload manager\n        let mut upload_manager = FileUploadManager::new();\n        let file = create_test_file(\"auth-test.txt\", \"Testing auth headers\");\n        \n        // The upload_file method should automatically include Bearer token\n        let _result = upload_manager.upload_file(file, \"/api/upload\").await;\n        \n        // In a real scenario, we would verify the Authorization header\n        // contains \"Bearer {token}\" in the request\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_upload_after_logout() {\n        // Create authenticated service\n        let mut auth_service = create_authenticated_service().await;\n        \n        // Verify authenticated\n        assert!(auth_service.is_authenticated());\n        assert!(crate::auth::JwtAuthProvider::get_stored_token().is_some());\n        \n        // Logout\n        auth_service.logout();\n        \n        // Verify logged out\n        assert!(!auth_service.is_authenticated());\n        assert!(crate::auth::JwtAuthProvider::get_stored_token().is_none());\n        \n        // Attempt upload after logout\n        let mut upload_manager = FileUploadManager::new();\n        let file = create_test_file(\"after-logout.txt\", \"Should not have auth\");\n        \n        let _result = upload_manager.upload_file(file, \"/api/upload\").await;\n        \n        // No auth token should be included in the request\n        assert!(crate::auth::JwtAuthProvider::get_stored_token().is_none());\n    }\n\n    #[wasm_bindgen_test]\n    async fn test_token_refresh_during_upload() {\n        // Create auth service\n        let mut auth_service = create_authenticated_service().await;\n        \n        // Get initial token\n        let initial_token = crate::auth::JwtAuthProvider::get_stored_token().unwrap();\n        \n        // Refresh token\n        auth_service.refresh_session().await.unwrap();\n        \n        // Get refreshed token\n        let refreshed_token = crate::auth::JwtAuthProvider::get_stored_token().unwrap();\n        \n        // Tokens should be different\n        assert_ne!(initial_token, refreshed_token);\n        \n        // Upload should use the new token\n        let mut upload_manager = FileUploadManager::new();\n        let file = create_test_file(\"refresh-test.txt\", \"Using refreshed token\");\n        \n        let _result = upload_manager.upload_file(file, \"/api/upload\").await;\n        \n        // The refreshed token should still be stored\n        assert_eq!(\n            crate::auth::JwtAuthProvider::get_stored_token().unwrap(),\n            refreshed_token\n        );\n    }\n\n    #[wasm_bindgen_test]\n    fn test_upload_file_validation_with_permissions() {\n        // Test that file validation works independently of auth\n        let upload_manager = FileUploadManager::new()\n            .with_max_size(1024) // 1KB\n            .with_allowed_types(vec![\"text/plain\".to_string()]);\n        \n        // Create files for testing\n        let small_file = create_test_file(\"small.txt\", \"OK\");\n        let large_file = create_test_file(\"large.txt\", \u0026\"X\".repeat(2000));\n        \n        // Validation should work regardless of auth status\n        assert!(upload_manager.validate_file(\u0026small_file).is_ok());\n        assert!(upload_manager.validate_file(\u0026large_file).is_err());\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","cache.rs"],"content":"//! Advanced Caching Strategies - L3/L4\n//! Multi-layer caching with various invalidation strategies\n\nuse serde::{Deserialize, Serialize};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\nuse std::time::Duration;\n\n/// Cache entry with metadata\n#[derive(Clone, Serialize, Deserialize)]\npub struct CacheEntry\u003cT\u003e {\n    pub value: T,\n    pub created_at: u64,\n    pub expires_at: Option\u003cu64\u003e,\n    pub access_count: u32,\n    pub last_accessed: u64,\n    pub tags: Vec\u003cString\u003e,\n    pub etag: Option\u003cString\u003e,\n}\n\nimpl\u003cT\u003e CacheEntry\u003cT\u003e {\n    pub fn new(value: T, ttl: Option\u003cDuration\u003e) -\u003e Self {\n        let now = current_timestamp();\n        CacheEntry {\n            value,\n            created_at: now,\n            expires_at: ttl.map(|d| now + d.as_secs()),\n            access_count: 0,\n            last_accessed: now,\n            tags: vec![],\n            etag: None,\n        }\n    }\n\n    pub fn is_expired(\u0026self) -\u003e bool {\n        if let Some(expires_at) = self.expires_at {\n            current_timestamp() \u003e expires_at\n        } else {\n            false\n        }\n    }\n\n    pub fn with_tags(mut self, tags: Vec\u003cString\u003e) -\u003e Self {\n        self.tags = tags;\n        self\n    }\n\n    pub fn with_etag(mut self, etag: String) -\u003e Self {\n        self.etag = Some(etag);\n        self\n    }\n}\n\n/// Cache storage trait\npub trait CacheStorage\u003cT: Clone\u003e: 'static {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cCacheEntry\u003cT\u003e\u003e;\n    fn set(\u0026self, key: String, entry: CacheEntry\u003cT\u003e);\n    fn remove(\u0026self, key: \u0026str) -\u003e Option\u003cCacheEntry\u003cT\u003e\u003e;\n    fn clear(\u0026self);\n    fn keys(\u0026self) -\u003e Vec\u003cString\u003e;\n    fn size(\u0026self) -\u003e usize;\n}\n\n/// In-memory cache storage\n#[derive(Clone)]\npub struct MemoryStorage\u003cT: Clone\u003e {\n    data: Rc\u003cRefCell\u003cHashMap\u003cString, CacheEntry\u003cT\u003e\u003e\u003e\u003e,\n    max_size: Option\u003cusize\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e MemoryStorage\u003cT\u003e {\n    pub fn new(max_size: Option\u003cusize\u003e) -\u003e Self {\n        MemoryStorage {\n            data: Rc::new(RefCell::new(HashMap::new())),\n            max_size,\n        }\n    }\n\n    fn evict_if_needed(\u0026self) {\n        if let Some(max_size) = self.max_size {\n            let mut data = self.data.borrow_mut();\n            while data.len() \u003e= max_size {\n                // LRU eviction\n                if let Some(key) = data\n                    .iter()\n                    .min_by_key(|(_, entry)| entry.last_accessed)\n                    .map(|(k, _)| k.clone())\n                {\n                    data.remove(\u0026key);\n                }\n            }\n        }\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e CacheStorage\u003cT\u003e for MemoryStorage\u003cT\u003e {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cCacheEntry\u003cT\u003e\u003e {\n        let mut data = self.data.borrow_mut();\n        if let Some(entry) = data.get_mut(key) {\n            if !entry.is_expired() {\n                entry.access_count += 1;\n                entry.last_accessed = current_timestamp();\n                Some(entry.clone())\n            } else {\n                data.remove(key);\n                None\n            }\n        } else {\n            None\n        }\n    }\n\n    fn set(\u0026self, key: String, entry: CacheEntry\u003cT\u003e) {\n        self.evict_if_needed();\n        self.data.borrow_mut().insert(key, entry);\n    }\n\n    fn remove(\u0026self, key: \u0026str) -\u003e Option\u003cCacheEntry\u003cT\u003e\u003e {\n        self.data.borrow_mut().remove(key)\n    }\n\n    fn clear(\u0026self) {\n        self.data.borrow_mut().clear();\n    }\n\n    fn keys(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.data.borrow().keys().cloned().collect()\n    }\n\n    fn size(\u0026self) -\u003e usize {\n        self.data.borrow().len()\n    }\n}\n\n/// LocalStorage cache storage\n#[derive(Clone)]\npub struct LocalStorageCache {\n    prefix: String,\n}\n\nimpl LocalStorageCache {\n    pub fn new(prefix: impl Into\u003cString\u003e) -\u003e Self {\n        LocalStorageCache {\n            prefix: prefix.into(),\n        }\n    }\n\n    fn full_key(\u0026self, key: \u0026str) -\u003e String {\n        format!(\"{}:{}\", self.prefix, key)\n    }\n\n    fn get_storage(\u0026self) -\u003e Option\u003cweb_sys::Storage\u003e {\n        web_sys::window()?.local_storage().ok()?\n    }\n}\n\nimpl CacheStorage\u003cString\u003e for LocalStorageCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cCacheEntry\u003cString\u003e\u003e {\n        let storage = self.get_storage()?;\n        let full_key = self.full_key(key);\n        let json = storage.get_item(\u0026full_key).ok()??;\n\n        serde_json::from_str(\u0026json).ok()\n    }\n\n    fn set(\u0026self, key: String, entry: CacheEntry\u003cString\u003e) {\n        if let Some(storage) = self.get_storage() {\n            let full_key = self.full_key(\u0026key);\n            if let Ok(json) = serde_json::to_string(\u0026entry) {\n                let _ = storage.set_item(\u0026full_key, \u0026json);\n            }\n        }\n    }\n\n    fn remove(\u0026self, key: \u0026str) -\u003e Option\u003cCacheEntry\u003cString\u003e\u003e {\n        let storage = self.get_storage()?;\n        let full_key = self.full_key(key);\n        let entry = self.get(key);\n        let _ = storage.remove_item(\u0026full_key);\n        entry\n    }\n\n    fn clear(\u0026self) {\n        if let Some(storage) = self.get_storage() {\n            // Clear only our prefixed keys\n            let mut keys_to_remove = vec![];\n            for i in 0..storage.length().unwrap_or(0) {\n                if let Ok(Some(key)) = storage.key(i) {\n                    if key.starts_with(\u0026self.prefix) {\n                        keys_to_remove.push(key);\n                    }\n                }\n            }\n\n            for key in keys_to_remove {\n                let _ = storage.remove_item(\u0026key);\n            }\n        }\n    }\n\n    fn keys(\u0026self) -\u003e Vec\u003cString\u003e {\n        let mut keys = vec![];\n        if let Some(storage) = self.get_storage() {\n            for i in 0..storage.length().unwrap_or(0) {\n                if let Ok(Some(key)) = storage.key(i) {\n                    if key.starts_with(\u0026self.prefix) {\n                        keys.push(\n                            key.trim_start_matches(\u0026format!(\"{}:\", self.prefix))\n                                .to_string(),\n                        );\n                    }\n                }\n            }\n        }\n        keys\n    }\n\n    fn size(\u0026self) -\u003e usize {\n        self.keys().len()\n    }\n}\n\n/// Cache invalidation strategies\n#[derive(Debug, Clone)]\npub enum InvalidationStrategy {\n    TTL(Duration),\n    TagBased(Vec\u003cString\u003e),\n    Manual,\n    Stale(Duration), // Serve stale while revalidating\n}\n\n/// Cache warming strategy\npub trait CacheWarmer\u003cT: Clone\u003e: 'static {\n    fn warm(\u0026self, cache: \u0026Cache\u003cT\u003e);\n}\n\n/// Main cache implementation\npub struct Cache\u003cT: Clone\u003e {\n    storage: Box\u003cdyn CacheStorage\u003cT\u003e\u003e,\n    invalidation: InvalidationStrategy,\n    warmers: Vec\u003cBox\u003cdyn CacheWarmer\u003cT\u003e\u003e\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e Cache\u003cT\u003e {\n    pub fn new(\n        storage: impl CacheStorage\u003cT\u003e + 'static,\n        invalidation: InvalidationStrategy,\n    ) -\u003e Self {\n        Cache {\n            storage: Box::new(storage),\n            invalidation,\n            warmers: vec![],\n        }\n    }\n\n    pub fn get(\u0026self, key: \u0026str) -\u003e Option\u003cT\u003e {\n        self.storage.get(key).map(|entry| entry.value)\n    }\n\n    pub fn get_or_compute\u003cF\u003e(\u0026self, key: \u0026str, compute: F) -\u003e T\n    where\n        F: FnOnce() -\u003e T,\n    {\n        if let Some(value) = self.get(key) {\n            value\n        } else {\n            let value = compute();\n            self.set(key.to_string(), value.clone());\n            value\n        }\n    }\n\n    pub async fn get_or_compute_async\u003cF, Fut\u003e(\u0026self, key: \u0026str, compute: F) -\u003e T\n    where\n        F: FnOnce() -\u003e Fut,\n        Fut: Future\u003cOutput = T\u003e,\n    {\n        if let Some(value) = self.get(key) {\n            value\n        } else {\n            let value = compute().await;\n            self.set(key.to_string(), value.clone());\n            value\n        }\n    }\n\n    pub fn set(\u0026self, key: String, value: T) {\n        let ttl = match \u0026self.invalidation {\n            InvalidationStrategy::TTL(duration) =\u003e Some(*duration),\n            InvalidationStrategy::Stale(duration) =\u003e Some(*duration),\n            _ =\u003e None,\n        };\n\n        let entry = CacheEntry::new(value, ttl);\n        self.storage.set(key, entry);\n    }\n\n    pub fn set_with_tags(\u0026self, key: String, value: T, tags: Vec\u003cString\u003e) {\n        let ttl = match \u0026self.invalidation {\n            InvalidationStrategy::TTL(duration) =\u003e Some(*duration),\n            InvalidationStrategy::Stale(duration) =\u003e Some(*duration),\n            _ =\u003e None,\n        };\n\n        let entry = CacheEntry::new(value, ttl).with_tags(tags);\n        self.storage.set(key, entry);\n    }\n\n    pub fn invalidate(\u0026self, key: \u0026str) {\n        self.storage.remove(key);\n    }\n\n    pub fn invalidate_by_tags(\u0026self, tags: \u0026[String]) {\n        let keys = self.storage.keys();\n        for key in keys {\n            if let Some(entry) = self.storage.get(\u0026key) {\n                if tags.iter().any(|tag| entry.tags.contains(tag)) {\n                    self.storage.remove(\u0026key);\n                }\n            }\n        }\n    }\n\n    pub fn clear(\u0026self) {\n        self.storage.clear();\n    }\n\n    pub fn warm(\u0026self) {\n        for warmer in \u0026self.warmers {\n            warmer.warm(self);\n        }\n    }\n\n    pub fn add_warmer(mut self, warmer: impl CacheWarmer\u003cT\u003e + 'static) -\u003e Self {\n        self.warmers.push(Box::new(warmer));\n        self\n    }\n}\n\n/// Multi-layer cache\npub struct MultiLayerCache\u003cT: Clone\u003e {\n    layers: Vec\u003cCache\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e Default for MultiLayerCache\u003cT\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e MultiLayerCache\u003cT\u003e {\n    pub fn new() -\u003e Self {\n        MultiLayerCache { layers: vec![] }\n    }\n\n    pub fn add_layer(mut self, cache: Cache\u003cT\u003e) -\u003e Self {\n        self.layers.push(cache);\n        self\n    }\n\n    pub fn get(\u0026self, key: \u0026str) -\u003e Option\u003cT\u003e {\n        for (i, layer) in self.layers.iter().enumerate() {\n            if let Some(value) = layer.get(key) {\n                // Promote to higher layers\n                for j in 0..i {\n                    self.layers[j].set(key.to_string(), value.clone());\n                }\n                return Some(value);\n            }\n        }\n        None\n    }\n\n    pub fn set(\u0026self, key: String, value: T) {\n        // Set in all layers\n        for layer in \u0026self.layers {\n            layer.set(key.clone(), value.clone());\n        }\n    }\n\n    pub fn invalidate(\u0026self, key: \u0026str) {\n        for layer in \u0026self.layers {\n            layer.invalidate(key);\n        }\n    }\n}\n\n/// HTTP cache with ETag support\npub struct HttpCache {\n    storage: MemoryStorage\u003cHttpCacheEntry\u003e,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\npub struct HttpCacheEntry {\n    pub data: String,\n    pub headers: HashMap\u003cString, String\u003e,\n    pub status: u16,\n}\n\n/// Cached response wrapper\npub struct CachedResponse {\n    pub data: String,\n    pub headers: Vec\u003c(String, String)\u003e,\n    pub status: u16,\n}\n\nimpl Default for HttpCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl HttpCache {\n    pub fn new() -\u003e Self {\n        HttpCache {\n            storage: MemoryStorage::new(Some(100)),\n        }\n    }\n\n    pub async fn fetch(\n        \u0026self,\n        url: \u0026str,\n        options: FetchOptions,\n    ) -\u003e Result\u003cCachedResponse, FetchError\u003e {\n        let key = format!(\"{}:{:?}\", url, options);\n\n        // Check cache\n        if let Some(entry) = self.storage.get(\u0026key) {\n            // Check if we have an ETag\n            if let Some(etag) = \u0026entry.etag {\n                // Make conditional request\n                let mut headers = options.headers.clone();\n                headers.insert(\"If-None-Match\".to_string(), etag.clone());\n\n                let mut conditional_options = options.clone();\n                conditional_options.headers = headers;\n\n                match crate::fetch::fetch(url, Some(conditional_options)).await {\n                    Ok(response) if response.status() == 304 =\u003e {\n                        // Not modified, use cached version\n                        Ok(CachedResponse {\n                            data: entry.value.data.clone(),\n                            headers: entry.value.headers.clone().into_iter().collect(),\n                            status: 200,\n                        })\n                    }\n                    Ok(response) =\u003e {\n                        // Updated, cache new version\n                        let status = response.status();\n                        let text = response.text().await?;\n                        let cached = CachedResponse {\n                            data: text,\n                            headers: vec![], // TODO: extract headers from response\n                            status,\n                        };\n                        self.cache_response_data(\u0026key, \u0026cached);\n                        Ok(cached)\n                    }\n                    Err(_e) =\u003e {\n                        // Error, use stale cache if available\n                        Ok(CachedResponse {\n                            data: entry.value.data.clone(),\n                            headers: entry.value.headers.clone().into_iter().collect(),\n                            status: 200,\n                        })\n                    }\n                }\n            } else {\n                // No ETag, check if expired\n                if !entry.is_expired() {\n                    Ok(CachedResponse {\n                        data: entry.value.data.clone(),\n                        headers: entry.value.headers.clone().into_iter().collect(),\n                        status: 200,\n                    })\n                } else {\n                    // Expired, fetch fresh\n                    let response = crate::fetch::fetch(url, Some(options)).await?;\n                    let status = response.status();\n                    let text = response.text().await?;\n                    let cached = CachedResponse {\n                        data: text,\n                        headers: vec![], // TODO: extract headers from response\n                        status,\n                    };\n                    self.cache_response_data(\u0026key, \u0026cached);\n                    Ok(cached)\n                }\n            }\n        } else {\n            // Not in cache, fetch\n            let response = crate::fetch::fetch(url, Some(options)).await?;\n            let status = response.status();\n            let text = response.text().await?;\n            let cached = CachedResponse {\n                data: text,\n                headers: vec![], // TODO: extract headers from response\n                status,\n            };\n            self.cache_response_data(\u0026key, \u0026cached);\n            Ok(cached)\n        }\n    }\n\n    fn cache_response_data(\u0026self, key: \u0026str, response: \u0026CachedResponse) {\n        let cache_entry = HttpCacheEntry {\n            data: response.data.clone(),\n            headers: response.headers.iter().cloned().collect(),\n            status: response.status,\n        };\n\n        // Determine TTL from cache headers\n        let ttl = if let Some((_, cache_control)) =\n            response.headers.iter().find(|(k, _)| k == \"cache-control\")\n        {\n            parse_cache_control_ttl(cache_control)\n        } else {\n            Some(Duration::from_secs(300)) // Default 5 minutes\n        };\n\n        let mut entry = CacheEntry::new(cache_entry, ttl);\n\n        // Store ETag if present\n        if let Some((_, etag)) = response.headers.iter().find(|(k, _)| k == \"etag\") {\n            entry = entry.with_etag(etag.clone());\n        }\n\n        self.storage.set(key.to_string(), entry);\n    }\n}\n\n/// Parse cache control header for TTL\nfn parse_cache_control_ttl(header: \u0026str) -\u003e Option\u003cDuration\u003e {\n    for directive in header.split(',') {\n        let directive = directive.trim();\n        if let Some(max_age) = directive.strip_prefix(\"max-age=\") {\n            if let Ok(seconds) = max_age.parse::\u003cu64\u003e() {\n                return Some(Duration::from_secs(seconds));\n            }\n        }\n    }\n    None\n}\n\n/// Get current timestamp in seconds\nfn current_timestamp() -\u003e u64 {\n    js_sys::Date::now() as u64 / 1000\n}\n\n/// Cache hooks\npub fn use_cache\u003cT: Clone + 'static\u003e() -\u003e Cache\u003cT\u003e {\n    Cache::new(\n        MemoryStorage::new(Some(100)),\n        InvalidationStrategy::TTL(Duration::from_secs(300)),\n    )\n}\n\npub fn use_local_cache() -\u003e Cache\u003cString\u003e {\n    Cache::new(\n        LocalStorageCache::new(\"layer9-cache\"),\n        InvalidationStrategy::Manual,\n    )\n}\n\npub fn use_http_cache() -\u003e HttpCache {\n    HttpCache::new()\n}\n\n// Re-exports\nuse crate::fetch::{FetchError, FetchOptions};\nuse std::future::Future;\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":201},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","component.rs"],"content":"//! Component System - L5\n\nuse std::cell::RefCell;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen::JsCast;\nuse web_sys::{Element as DomElement, Event, HtmlElement, HtmlInputElement, MouseEvent, Node};\n\n/// Virtual DOM Element\n#[derive(Clone)]\npub enum Element {\n    Text(String),\n    Node {\n        tag: String,\n        props: Props,\n        children: Vec\u003cElement\u003e,\n    },\n    Component(Box\u003cdyn Component\u003e),\n}\n\nimpl std::fmt::Debug for Element {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            Element::Text(text) =\u003e f.debug_tuple(\"Text\").field(text).finish(),\n            Element::Node { tag, props, children } =\u003e {\n                f.debug_struct(\"Node\")\n                    .field(\"tag\", tag)\n                    .field(\"props\", props)\n                    .field(\"children\", children)\n                    .finish()\n            }\n            Element::Component(_) =\u003e f.debug_tuple(\"Component\").field(\u0026\"dyn Component\").finish(),\n        }\n    }\n}\n\n/// Component properties\n#[derive(Default, Clone)]\npub struct Props {\n    pub class: Option\u003cString\u003e,\n    pub id: Option\u003cString\u003e,\n    pub on_click: Option\u003cRc\u003cdyn Fn()\u003e\u003e,\n    pub on_submit: Option\u003cRc\u003cdyn Fn(Event)\u003e\u003e,\n    pub on_change: Option\u003cRc\u003cdyn Fn(String)\u003e\u003e,\n    pub on_input: Option\u003cRc\u003cdyn Fn(String)\u003e\u003e,\n    pub attributes: Vec\u003c(String, String)\u003e,\n}\n\nimpl std::fmt::Debug for Props {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.debug_struct(\"Props\")\n            .field(\"class\", \u0026self.class)\n            .field(\"id\", \u0026self.id)\n            .field(\"on_click\", \u0026self.on_click.as_ref().map(|_| \"Fn()\"))\n            .field(\"on_submit\", \u0026self.on_submit.as_ref().map(|_| \"Fn(Event)\"))\n            .field(\"on_change\", \u0026self.on_change.as_ref().map(|_| \"Fn(String)\"))\n            .field(\"on_input\", \u0026self.on_input.as_ref().map(|_| \"Fn(String)\"))\n            .field(\"attributes\", \u0026self.attributes)\n            .finish()\n    }\n}\n\n// Make Component cloneable\nimpl Clone for Box\u003cdyn Component\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        // This is a simplified clone - in production you'd want proper cloning\n        Box::new(EmptyComponent)\n    }\n}\n\nstruct EmptyComponent;\nimpl Component for EmptyComponent {\n    fn render(\u0026self) -\u003e Element {\n        Element::Text(String::new())\n    }\n}\n\n/// Base component trait\npub trait Component: 'static {\n    fn render(\u0026self) -\u003e Element;\n\n    fn mount(\u0026self, parent: \u0026DomElement) {\n        let element = self.render();\n        let dom_node = element.to_dom();\n        parent.append_child(\u0026dom_node).unwrap();\n    }\n}\n\nimpl Element {\n    pub fn to_dom(\u0026self) -\u003e Node {\n        match self {\n            Element::Text(text) =\u003e web_sys::window()\n                .unwrap()\n                .document()\n                .unwrap()\n                .create_text_node(text)\n                .into(),\n            Element::Node {\n                tag,\n                props,\n                children,\n            } =\u003e {\n                let document = web_sys::window().unwrap().document().unwrap();\n                let element = document.create_element(tag).unwrap();\n\n                // Apply props\n                if let Some(class) = \u0026props.class {\n                    element.set_class_name(class);\n                }\n                if let Some(id) = \u0026props.id {\n                    element.set_id(id);\n                }\n\n                // Apply attributes\n                for (key, value) in \u0026props.attributes {\n                    element.set_attribute(key, value).unwrap();\n                }\n\n                // Handle click event\n                if let Some(on_click) = \u0026props.on_click {\n                    if let Some(html_element) = element.dyn_ref::\u003cHtmlElement\u003e() {\n                        let handler = on_click.clone();\n                        let closure = Closure::wrap(Box::new(move |_event: MouseEvent| {\n                            handler();\n                        })\n                            as Box\u003cdyn FnMut(_)\u003e);\n\n                        html_element.set_onclick(Some(closure.as_ref().unchecked_ref()));\n                        closure.forget();\n                    }\n                }\n\n                // Handle submit event for forms\n                if let Some(on_submit) = \u0026props.on_submit {\n                    if tag == \"form\" {\n                        if let Some(form_element) = element.dyn_ref::\u003cHtmlElement\u003e() {\n                            let handler = on_submit.clone();\n                            let closure = Closure::wrap(Box::new(move |event: Event| {\n                                event.prevent_default(); // Prevent form submission\n                                handler(event);\n                            })\n                                as Box\u003cdyn FnMut(_)\u003e);\n\n                            form_element.set_onsubmit(Some(closure.as_ref().unchecked_ref()));\n                            closure.forget();\n                        }\n                    }\n                }\n\n                // Handle change event for inputs\n                if let Some(on_change) = \u0026props.on_change {\n                    if tag == \"input\" || tag == \"select\" || tag == \"textarea\" {\n                        if let Some(input_element) = element.dyn_ref::\u003cHtmlInputElement\u003e() {\n                            let handler = on_change.clone();\n                            let closure = Closure::wrap(Box::new(move |_event: Event| {\n                                if let Some(target) = _event.target() {\n                                    if let Some(input) = target.dyn_ref::\u003cHtmlInputElement\u003e() {\n                                        handler(input.value());\n                                    }\n                                }\n                            })\n                                as Box\u003cdyn FnMut(_)\u003e);\n\n                            input_element.set_onchange(Some(closure.as_ref().unchecked_ref()));\n                            closure.forget();\n                        }\n                    }\n                }\n\n                // Handle input event for real-time updates\n                if let Some(on_input) = \u0026props.on_input {\n                    if tag == \"input\" || tag == \"textarea\" {\n                        if let Some(input_element) = element.dyn_ref::\u003cHtmlInputElement\u003e() {\n                            let handler = on_input.clone();\n                            let closure = Closure::wrap(Box::new(move |_event: Event| {\n                                if let Some(target) = _event.target() {\n                                    if let Some(input) = target.dyn_ref::\u003cHtmlInputElement\u003e() {\n                                        handler(input.value());\n                                    }\n                                }\n                            })\n                                as Box\u003cdyn FnMut(_)\u003e);\n\n                            input_element.set_oninput(Some(closure.as_ref().unchecked_ref()));\n                            closure.forget();\n                        }\n                    }\n                }\n\n                // Add children\n                for child in children {\n                    element.append_child(\u0026child.to_dom()).unwrap();\n                }\n\n                element.into()\n            }\n            Element::Component(component) =\u003e component.render().to_dom(),\n        }\n    }\n}\n\n/// Reactive state hook\n#[derive(Clone)]\npub struct State\u003cT\u003e {\n    value: Rc\u003cRefCell\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Clone\u003e State\u003cT\u003e {\n    pub fn new(initial: T) -\u003e Self {\n        State {\n            value: Rc::new(RefCell::new(initial)),\n        }\n    }\n\n    pub fn get(\u0026self) -\u003e T {\n        self.value.borrow().clone()\n    }\n\n    pub fn set(\u0026self, new_value: T) {\n        *self.value.borrow_mut() = new_value;\n        // Trigger automatic re-render through the reactive system\n        crate::reactive_v2::queue_current_render();\n    }\n}\n\n/// Hook for creating state\npub fn use_state\u003cT: Clone + 'static\u003e(initial: impl FnOnce() -\u003e T) -\u003e State\u003cT\u003e {\n    State::new(initial())\n}\n\n/// View macro for JSX-like syntax\n#[macro_export]\nmacro_rules! view {\n    // Text node\n    ($text:expr) =\u003e {\n        $crate::component::Element::Text($text.to_string())\n    };\n\n    // Simple element without attributes\n    (\u003c$tag:ident\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props: $crate::component::Props::default(),\n            children,\n        }\n    }};\n\n    // Self-closing element\n    (\u003c$tag:ident /\u003e) =\u003e {{\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props: $crate::component::Props::default(),\n            children: vec![],\n        }\n    }};\n\n    // Element with class\n    (\u003c$tag:ident class=$class:literal\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.class = Some($class.to_string());\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with onclick\n    (\u003c$tag:ident onclick={$handler:expr}\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.on_click = Some(std::rc::Rc::new($handler));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with class and onclick\n    (\u003c$tag:ident class=$class:literal onclick={$handler:expr}\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.class = Some($class.to_string());\n        props.on_click = Some(std::rc::Rc::new($handler));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with onsubmit\n    (\u003c$tag:ident onsubmit={$handler:expr}\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.on_submit = Some(std::rc::Rc::new($handler));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with onchange\n    (\u003c$tag:ident onchange={$handler:expr}\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.on_change = Some(std::rc::Rc::new($handler));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with oninput\n    (\u003c$tag:ident oninput={$handler:expr}\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.on_input = Some(std::rc::Rc::new($handler));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with value attribute (for controlled inputs)\n    (\u003c$tag:ident value={$value:expr}\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.attributes.push((\"value\".to_string(), $value.to_string()));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Element with type attribute  \n    (\u003c$tag:ident type=$type:literal\u003e $($children:tt)* \u003c/$end_tag:ident\u003e) =\u003e {{\n        assert_eq!(stringify!($tag), stringify!($end_tag), \"Mismatched tags\");\n\n        let mut props = $crate::component::Props::default();\n        props.attributes.push((\"type\".to_string(), $type.to_string()));\n\n        let children = vec![$($crate::view!($children)),*];\n\n        $crate::component::Element::Node {\n            tag: stringify!($tag).to_string(),\n            props,\n            children,\n        }\n    }};\n\n    // Block expression\n    ({ $expr:expr }) =\u003e {\n        $crate::component::Element::Text($expr.to_string())\n    };\n}\n\npub use view;\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":72},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","config.rs"],"content":"//! Configuration module for Layer9\n//! \n//! Provides centralized configuration management with support for\n//! environment variables and defaults.\n\nuse std::sync::OnceLock;\n\n#[cfg(target_arch = \"wasm32\")]\nuse wasm_bindgen::JsCast;\n\n/// Global configuration instance\nstatic CONFIG: OnceLock\u003cConfig\u003e = OnceLock::new();\n\n/// Main configuration structure\n#[derive(Debug, Clone)]\npub struct Config {\n    /// JWT secret for authentication\n    /// Can be set via LAYER9_JWT_SECRET environment variable\n    pub jwt_secret: Option\u003cString\u003e,\n    \n    /// Whether to use mock authentication (for testing)\n    /// Can be set via LAYER9_USE_MOCK_AUTH environment variable\n    pub use_mock_auth: bool,\n    \n    /// Default JWT secret if none is provided\n    /// WARNING: This should only be used in development\n    pub default_jwt_secret: String,\n}\n\nimpl Config {\n    /// Create a new configuration instance\n    pub fn new() -\u003e Self {\n        Self {\n            jwt_secret: None,\n            use_mock_auth: false,\n            default_jwt_secret: \"layer9-development-secret-change-in-production\".to_string(),\n        }\n    }\n    \n    /// Load configuration from environment variables\n    pub fn from_env() -\u003e Self {\n        let mut config = Self::new();\n        \n        // In WASM environment, we can't access process env vars directly\n        // Instead, we'll use a different approach for browser environments\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            // In browser, we might get config from:\n            // 1. Global window object\n            // 2. Meta tags\n            // 3. Config endpoint\n            // For now, we'll use defaults or injected values\n            if let Some(window) = web_sys::window() {\n                if let Ok(layer9_config) = js_sys::Reflect::get(\u0026window, \u0026\"LAYER9_CONFIG\".into()) {\n                    if let Some(config_obj) = layer9_config.dyn_ref::\u003cjs_sys::Object\u003e() {\n                        // Try to get JWT secret\n                        if let Ok(jwt_secret) = js_sys::Reflect::get(config_obj, \u0026\"jwtSecret\".into()) {\n                            if let Some(secret) = jwt_secret.as_string() {\n                                if !secret.is_empty() {\n                                    config.jwt_secret = Some(secret);\n                                }\n                            }\n                        }\n                        \n                        // Try to get mock auth flag\n                        if let Ok(use_mock) = js_sys::Reflect::get(config_obj, \u0026\"useMockAuth\".into()) {\n                            if let Some(mock_bool) = use_mock.as_bool() {\n                                config.use_mock_auth = mock_bool;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        \n        // For non-WASM targets (like server-side), we could read from env vars\n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            if let Ok(secret) = std::env::var(\"LAYER9_JWT_SECRET\") {\n                if !secret.is_empty() {\n                    config.jwt_secret = Some(secret);\n                }\n            }\n            \n            if let Ok(use_mock) = std::env::var(\"LAYER9_USE_MOCK_AUTH\") {\n                config.use_mock_auth = use_mock.to_lowercase() == \"true\" || use_mock == \"1\";\n            }\n        }\n        \n        config\n    }\n    \n    /// Get the JWT secret to use\n    /// Returns the configured secret or the default if none is set\n    pub fn get_jwt_secret(\u0026self) -\u003e String {\n        self.jwt_secret.as_ref()\n            .cloned()\n            .unwrap_or_else(|| {\n                #[cfg(target_arch = \"wasm32\")]\n                web_sys::console::warn_1(\u0026\"Using default JWT secret. This should only be used in development!\".into());\n                \n                #[cfg(not(target_arch = \"wasm32\"))]\n                eprintln!(\"WARNING: Using default JWT secret. This should only be used in development!\");\n                \n                self.default_jwt_secret.clone()\n            })\n    }\n    \n    /// Check if we should use mock authentication\n    pub fn should_use_mock_auth(\u0026self) -\u003e bool {\n        self.use_mock_auth\n    }\n    \n    /// Initialize the global configuration\n    /// This should be called once at application startup\n    pub fn init() -\u003e \u0026'static Config {\n        CONFIG.get_or_init(Self::from_env)\n    }\n    \n    /// Get the global configuration instance\n    /// Panics if init() hasn't been called\n    pub fn get() -\u003e \u0026'static Config {\n        CONFIG.get().expect(\"Config not initialized. Call Config::init() first.\")\n    }\n    \n    /// Get the global configuration instance, initializing if needed\n    pub fn get_or_init() -\u003e \u0026'static Config {\n        CONFIG.get_or_init(Self::from_env)\n    }\n}\n\nimpl Default for Config {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Builder pattern for configuration\npub struct ConfigBuilder {\n    config: Config,\n}\n\nimpl Default for ConfigBuilder {\n    fn default() -\u003e Self {\n        Self {\n            config: Config::new(),\n        }\n    }\n}\n\nimpl ConfigBuilder {\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n    \n    pub fn jwt_secret(mut self, secret: String) -\u003e Self {\n        self.config.jwt_secret = Some(secret);\n        self\n    }\n    \n    pub fn use_mock_auth(mut self, use_mock: bool) -\u003e Self {\n        self.config.use_mock_auth = use_mock;\n        self\n    }\n    \n    pub fn build(self) -\u003e Config {\n        self.config\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_config_defaults() {\n        let config = Config::new();\n        assert!(config.jwt_secret.is_none());\n        assert!(!config.use_mock_auth);\n        assert!(!config.default_jwt_secret.is_empty());\n    }\n    \n    #[test]\n    fn test_config_builder() {\n        let config = ConfigBuilder::new()\n            .jwt_secret(\"test-secret\".to_string())\n            .use_mock_auth(true)\n            .build();\n            \n        assert_eq!(config.jwt_secret, Some(\"test-secret\".to_string()));\n        assert!(config.use_mock_auth);\n    }\n    \n    #[test]\n    fn test_get_jwt_secret() {\n        let config = Config::new();\n        assert_eq!(config.get_jwt_secret(), config.default_jwt_secret);\n        \n        let config_with_secret = ConfigBuilder::new()\n            .jwt_secret(\"custom-secret\".to_string())\n            .build();\n        assert_eq!(config_with_secret.get_jwt_secret(), \"custom-secret\");\n    }\n}","traces":[{"line":32,"address":[],"length":0,"stats":{"Line":4}},{"line":36,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":2}},{"line":96,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":3}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":103,"address":[],"length":0,"stats":{"Line":1}},{"line":105,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":2}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":152,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":2}},{"line":156,"address":[],"length":0,"stats":{"Line":2}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":158,"address":[],"length":0,"stats":{"Line":2}},{"line":161,"address":[],"length":0,"stats":{"Line":1}},{"line":162,"address":[],"length":0,"stats":{"Line":1}},{"line":163,"address":[],"length":0,"stats":{"Line":1}},{"line":166,"address":[],"length":0,"stats":{"Line":2}},{"line":167,"address":[],"length":0,"stats":{"Line":2}}],"covered":22,"coverable":40},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","css_runtime.rs"],"content":"//! CSS Runtime System - Dynamic CSS generation and injection\n//!\n//! This module provides a comprehensive CSS-in-Rust system with:\n//! - Runtime CSS generation and injection\n//! - Pseudo-class support (:hover, :focus, :active, etc.)\n//! - Media query support with responsive breakpoints\n//! - CSS variables for dynamic theming\n//! - Scoped styles and CSS modules\n//! - Animation and transition utilities\n\nuse once_cell::sync::Lazy;\nuse parking_lot::Mutex;\nuse std::collections::HashMap;\nuse wasm_bindgen::prelude::*;\nuse web_sys::HtmlStyleElement;\n\n/// Global stylesheet manager\npub(crate) static STYLESHEET_MANAGER: Lazy\u003cMutex\u003cStyleSheetManager\u003e\u003e = Lazy::new(|| {\n    Mutex::new(StyleSheetManager::new())\n});\n\n/// Manages all CSS rules and their injection into the DOM\npub struct StyleSheetManager {\n    /// Map of class names to their CSS rules\n    rules: HashMap\u003cString, String\u003e,\n    /// Whether the style element has been initialized\n    initialized: bool,\n    /// Counter for generating unique class names\n    class_counter: u32,\n}\n\nimpl StyleSheetManager {\n    fn new() -\u003e Self {\n        Self {\n            rules: HashMap::new(),\n            initialized: false,\n            class_counter: 0,\n        }\n    }\n\n    /// Initialize the style element in the DOM\n    pub fn init(\u0026mut self) {\n        if self.initialized {\n            return;\n        }\n\n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        let head = document.head().unwrap();\n\n        let style = document.create_element(\"style\").unwrap();\n        let style_element = style.dyn_into::\u003cHtmlStyleElement\u003e().unwrap();\n        style_element.set_type(\"text/css\");\n        style_element.set_id(\"layer9-runtime-styles\");\n\n        head.append_child(\u0026style_element).unwrap();\n        self.initialized = true;\n    }\n\n    /// Generate a unique class name\n    fn generate_class_name(\u0026mut self, prefix: Option\u003c\u0026str\u003e) -\u003e String {\n        self.class_counter += 1;\n        match prefix {\n            Some(p) =\u003e format!(\"l9-{}-{}\", p, self.class_counter),\n            None =\u003e format!(\"l9-{}\", self.class_counter),\n        }\n    }\n\n    /// Add a CSS rule and return the generated class name\n    pub fn add_rule(\u0026mut self, css_rule: \u0026CssRule) -\u003e String {\n        self.init();\n\n        let class_name = self.generate_class_name(css_rule.prefix.as_deref());\n        let css_text = css_rule.to_css(\u0026class_name);\n\n        self.rules.insert(class_name.clone(), css_text);\n        self.update_styles();\n\n        class_name\n    }\n\n    /// Update the style element with all current rules\n    fn update_styles(\u0026self) {\n        if self.initialized {\n            let window = web_sys::window().unwrap();\n            let document = window.document().unwrap();\n            \n            if let Some(element) = document.get_element_by_id(\"layer9-runtime-styles\") {\n                if let Ok(style_element) = element.dyn_into::\u003cHtmlStyleElement\u003e() {\n                    let css_content = self\n                        .rules\n                        .values()\n                        .cloned()\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"\\n\");\n\n                    style_element.set_inner_html(\u0026css_content);\n                }\n            }\n        }\n    }\n\n    /// Remove a CSS rule by class name\n    pub fn remove_rule(\u0026mut self, class_name: \u0026str) {\n        self.rules.remove(class_name);\n        self.update_styles();\n    }\n\n    /// Clear all rules\n    pub fn clear(\u0026mut self) {\n        self.rules.clear();\n        self.update_styles();\n    }\n}\n\n/// Represents a CSS rule with all its properties\n#[derive(Clone, Debug, Default)]\npub struct CssRule {\n    /// Optional prefix for the generated class name\n    pub prefix: Option\u003cString\u003e,\n    /// Base CSS properties\n    pub properties: HashMap\u003cString, String\u003e,\n    /// Pseudo-class styles (e.g., :hover, :focus)\n    pub pseudo_classes: HashMap\u003cString, HashMap\u003cString, String\u003e\u003e,\n    /// Media query styles\n    pub media_queries: HashMap\u003cString, HashMap\u003cString, String\u003e\u003e,\n    /// CSS variables used in this rule\n    pub variables: HashMap\u003cString, String\u003e,\n    /// Keyframe animations\n    pub animations: Vec\u003cAnimation\u003e,\n}\n\nimpl CssRule {\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    /// Convert the rule to CSS text\n    fn to_css(\u0026self, class_name: \u0026str) -\u003e String {\n        let mut css_parts = Vec::new();\n\n        // Base rule\n        if !self.properties.is_empty() {\n            let props = self\n                .properties\n                .iter()\n                .map(|(k, v)| format!(\"  {}: {};\", k, v))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n                .join(\"\\n\");\n            css_parts.push(format!(\".{} {{\\n{}\\n}}\", class_name, props));\n        }\n\n        // Pseudo-classes\n        for (pseudo, props) in \u0026self.pseudo_classes {\n            if !props.is_empty() {\n                let prop_text = props\n                    .iter()\n                    .map(|(k, v)| format!(\"  {}: {};\", k, v))\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\"\\n\");\n                css_parts.push(format!(\".{}:{} {{\\n{}\\n}}\", class_name, pseudo, prop_text));\n            }\n        }\n\n        // Media queries\n        for (query, props) in \u0026self.media_queries {\n            if !props.is_empty() {\n                let prop_text = props\n                    .iter()\n                    .map(|(k, v)| format!(\"    {}: {};\", k, v))\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\"\\n\");\n                css_parts.push(format!(\n                    \"@media {} {{\\n  .{} {{\\n{}\\n  }}\\n}}\",\n                    query, class_name, prop_text\n                ));\n            }\n        }\n\n        // Animations\n        for animation in \u0026self.animations {\n            css_parts.push(animation.to_css());\n        }\n\n        css_parts.join(\"\\n\\n\")\n    }\n}\n\n/// CSS animation definition\n#[derive(Clone, Debug)]\npub struct Animation {\n    pub name: String,\n    pub keyframes: Vec\u003c(String, HashMap\u003cString, String\u003e)\u003e,\n}\n\nimpl Animation {\n    pub fn new(name: String) -\u003e Self {\n        Self {\n            name,\n            keyframes: Vec::new(),\n        }\n    }\n\n    pub fn keyframe(mut self, percentage: \u0026str, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.keyframes.push((percentage.to_string(), props));\n        self\n    }\n\n    fn to_css(\u0026self) -\u003e String {\n        let keyframes = self\n            .keyframes\n            .iter()\n            .map(|(pct, props)| {\n                let prop_text = props\n                    .iter()\n                    .map(|(k, v)| format!(\"    {}: {};\", k, v))\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\"\\n\");\n                format!(\"  {} {{\\n{}\\n  }}\", pct, prop_text)\n            })\n            .collect::\u003cVec\u003c_\u003e\u003e()\n            .join(\"\\n\");\n\n        format!(\"@keyframes {} {{\\n{}\\n}}\", self.name, keyframes)\n    }\n}\n\n/// Fluent API for building CSS rules\npub struct CssBuilder {\n    rule: CssRule,\n}\n\nimpl Default for CssBuilder {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl CssBuilder {\n    pub fn new() -\u003e Self {\n        Self {\n            rule: CssRule::new(),\n        }\n    }\n\n    /// Set a prefix for the generated class name\n    pub fn prefix(mut self, prefix: \u0026str) -\u003e Self {\n        self.rule.prefix = Some(prefix.to_string());\n        self\n    }\n\n    /// Add a CSS property\n    pub fn property(mut self, key: \u0026str, value: \u0026str) -\u003e Self {\n        self.rule.properties.insert(key.to_string(), value.to_string());\n        self\n    }\n\n    /// Add multiple CSS properties\n    pub fn properties\u003cI\u003e(mut self, props: I) -\u003e Self\n    where\n        I: IntoIterator\u003cItem = (String, String)\u003e,\n    {\n        self.rule.properties.extend(props);\n        self\n    }\n\n    /// Add hover state styles\n    pub fn hover(mut self, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.rule.pseudo_classes.insert(\"hover\".to_string(), props);\n        self\n    }\n\n    /// Add focus state styles\n    pub fn focus(mut self, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.rule.pseudo_classes.insert(\"focus\".to_string(), props);\n        self\n    }\n\n    /// Add active state styles\n    pub fn active(mut self, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.rule.pseudo_classes.insert(\"active\".to_string(), props);\n        self\n    }\n\n    /// Add disabled state styles\n    pub fn disabled(mut self, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.rule.pseudo_classes.insert(\"disabled\".to_string(), props);\n        self\n    }\n\n    /// Add custom pseudo-class styles\n    pub fn pseudo(mut self, pseudo: \u0026str, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.rule.pseudo_classes.insert(pseudo.to_string(), props);\n        self\n    }\n\n    /// Add media query styles\n    pub fn media(mut self, query: \u0026str, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.rule.media_queries.insert(query.to_string(), props);\n        self\n    }\n\n    /// Add responsive breakpoint styles\n    pub fn breakpoint(mut self, breakpoint: Breakpoint, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        let query = breakpoint.to_media_query();\n        self.rule.media_queries.insert(query, props);\n        self\n    }\n\n    /// Add CSS variable\n    pub fn variable(mut self, name: \u0026str, value: \u0026str) -\u003e Self {\n        self.rule.variables.insert(name.to_string(), value.to_string());\n        self\n    }\n\n    /// Add animation\n    pub fn animation(mut self, animation: Animation) -\u003e Self {\n        self.rule.animations.push(animation);\n        self\n    }\n\n    /// Build and inject the CSS rule, returning the class name\n    pub fn build(self) -\u003e String {\n        let mut manager = STYLESHEET_MANAGER.lock();\n        manager.add_rule(\u0026self.rule)\n    }\n}\n\n/// Predefined responsive breakpoints\n#[derive(Clone, Copy, Debug)]\npub enum Breakpoint {\n    /// 640px\n    Sm,\n    /// 768px\n    Md,\n    /// 1024px\n    Lg,\n    /// 1280px\n    Xl,\n    /// 1536px\n    Xxl,\n    /// Custom breakpoint\n    Custom(u32),\n}\n\nimpl Breakpoint {\n    fn to_media_query(self) -\u003e String {\n        match self {\n            Self::Sm =\u003e \"(min-width: 640px)\".to_string(),\n            Self::Md =\u003e \"(min-width: 768px)\".to_string(),\n            Self::Lg =\u003e \"(min-width: 1024px)\".to_string(),\n            Self::Xl =\u003e \"(min-width: 1280px)\".to_string(),\n            Self::Xxl =\u003e \"(min-width: 1536px)\".to_string(),\n            Self::Custom(px) =\u003e format!(\"(min-width: {}px)\", px),\n        }\n    }\n}\n\n/// CSS variable system for dynamic theming\npub struct CssVariables {\n    variables: HashMap\u003cString, String\u003e,\n}\n\nimpl Default for CssVariables {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl CssVariables {\n    pub fn new() -\u003e Self {\n        Self {\n            variables: HashMap::new(),\n        }\n    }\n\n    /// Set a CSS variable\n    pub fn set(\u0026mut self, name: \u0026str, value: \u0026str) {\n        self.variables.insert(\n            format!(\"--{}\", name),\n            value.to_string(),\n        );\n        self.apply();\n    }\n\n    /// Get a CSS variable value\n    pub fn get(\u0026self, name: \u0026str) -\u003e Option\u003c\u0026String\u003e {\n        self.variables.get(\u0026format!(\"--{}\", name))\n    }\n\n    /// Apply all variables to the document root\n    fn apply(\u0026self) {\n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        if let Some(root) = document.document_element() {\n            if let Ok(html_element) = root.dyn_into::\u003cweb_sys::HtmlElement\u003e() {\n                let style = html_element.style();\n                for (name, value) in \u0026self.variables {\n                    style.set_property(name, value).ok();\n                }\n            }\n        }\n    }\n\n    /// Create a theme with predefined variables\n    pub fn theme() -\u003e Self {\n        let mut vars = Self::new();\n        \n        // Colors\n        vars.set(\"primary\", \"#667eea\");\n        vars.set(\"primary-dark\", \"#5a67d8\");\n        vars.set(\"secondary\", \"#48bb78\");\n        vars.set(\"background\", \"#ffffff\");\n        vars.set(\"background-dark\", \"#1a202c\");\n        vars.set(\"text\", \"#2d3748\");\n        vars.set(\"text-dark\", \"#e2e8f0\");\n        vars.set(\"border\", \"#e2e8f0\");\n        vars.set(\"border-dark\", \"#2d3748\");\n        \n        // Spacing\n        vars.set(\"spacing-xs\", \"0.25rem\");\n        vars.set(\"spacing-sm\", \"0.5rem\");\n        vars.set(\"spacing-md\", \"1rem\");\n        vars.set(\"spacing-lg\", \"1.5rem\");\n        vars.set(\"spacing-xl\", \"2rem\");\n        \n        // Typography\n        vars.set(\"font-sans\", \"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif\");\n        vars.set(\"font-mono\", \"Consolas, Monaco, 'Andale Mono', monospace\");\n        \n        // Shadows\n        vars.set(\"shadow-sm\", \"0 1px 2px 0 rgba(0, 0, 0, 0.05)\");\n        vars.set(\"shadow-md\", \"0 4px 6px -1px rgba(0, 0, 0, 0.1)\");\n        vars.set(\"shadow-lg\", \"0 10px 15px -3px rgba(0, 0, 0, 0.1)\");\n        \n        // Transitions\n        vars.set(\"transition-fast\", \"150ms ease-in-out\");\n        vars.set(\"transition-normal\", \"250ms ease-in-out\");\n        vars.set(\"transition-slow\", \"350ms ease-in-out\");\n        \n        vars\n    }\n}\n\n/// Inject global CSS variables and base styles\npub fn inject_global_styles() {\n    // Initialize the stylesheet manager\n    let mut manager = STYLESHEET_MANAGER.lock();\n    manager.init();\n\n    // Apply theme variables\n    let theme = CssVariables::theme();\n    drop(theme); // Variables are applied automatically\n\n    // Add global reset and base styles\n    let window = web_sys::window().unwrap();\n    let document = window.document().unwrap();\n    let head = document.head().unwrap();\n\n    let style = document.create_element(\"style\").unwrap();\n    style.set_id(\"layer9-global-styles\");\n    style.set_inner_html(\n        r#\"\n        /* CSS Reset */\n        *, *::before, *::after {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n\n        /* Base styles */\n        body {\n            font-family: var(--font-sans);\n            background-color: var(--background);\n            color: var(--text);\n            line-height: 1.5;\n            transition: background-color var(--transition-normal), color var(--transition-normal);\n        }\n\n        /* Dark mode support */\n        @media (prefers-color-scheme: dark) {\n            body {\n                background-color: var(--background-dark);\n                color: var(--text-dark);\n            }\n        }\n\n        /* Focus visible for accessibility */\n        :focus-visible {\n            outline: 2px solid var(--primary);\n            outline-offset: 2px;\n        }\n\n        /* Smooth scrolling */\n        html {\n            scroll-behavior: smooth;\n        }\n\n        /* Common utility classes */\n        .l9-transition {\n            transition: all var(--transition-normal);\n        }\n\n        .l9-shadow {\n            box-shadow: var(--shadow-md);\n        }\n\n        .l9-rounded {\n            border-radius: 0.375rem;\n        }\n\n        /* Animation utilities */\n        @keyframes l9-fade-in {\n            from { opacity: 0; }\n            to { opacity: 1; }\n        }\n\n        @keyframes l9-slide-in {\n            from { transform: translateY(1rem); opacity: 0; }\n            to { transform: translateY(0); opacity: 1; }\n        }\n\n        @keyframes l9-scale-in {\n            from { transform: scale(0.95); opacity: 0; }\n            to { transform: scale(1); opacity: 1; }\n        }\n\n        .l9-animate-fade-in {\n            animation: l9-fade-in var(--transition-normal) ease-out;\n        }\n\n        .l9-animate-slide-in {\n            animation: l9-slide-in var(--transition-normal) ease-out;\n        }\n\n        .l9-animate-scale-in {\n            animation: l9-scale-in var(--transition-normal) ease-out;\n        }\n        \"#,\n    );\n\n    head.append_child(\u0026style).unwrap();\n}\n\n/// Helper macro for creating CSS property maps\n#[macro_export]\nmacro_rules! css_props {\n    ($($key:expr =\u003e $value:expr),* $(,)?) =\u003e {{\n        let mut map = std::collections::HashMap::new();\n        $(\n            map.insert($key.to_string(), $value.to_string());\n        )*\n        map\n    }};\n}\n\npub use css_props;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_css_rule_generation() {\n        let rule = CssRule {\n            prefix: Some(\"test\".to_string()),\n            properties: css_props! {\n                \"display\" =\u003e \"flex\",\n                \"color\" =\u003e \"red\"\n            },\n            pseudo_classes: HashMap::new(),\n            media_queries: HashMap::new(),\n            variables: HashMap::new(),\n            animations: Vec::new(),\n        };\n\n        let css = rule.to_css(\"test-class\");\n        assert!(css.contains(\".test-class\"));\n        assert!(css.contains(\"display: flex\"));\n        assert!(css.contains(\"color: red\"));\n    }\n\n    #[test]\n    fn test_css_builder() {\n        let builder = CssBuilder::new()\n            .property(\"display\", \"block\")\n            .property(\"padding\", \"1rem\")\n            .hover(css_props! {\n                \"background-color\" =\u003e \"#f0f0f0\"\n            });\n\n        assert_eq!(builder.rule.properties.get(\"display\").unwrap(), \"block\");\n        assert_eq!(builder.rule.properties.get(\"padding\").unwrap(), \"1rem\");\n        assert!(builder.rule.pseudo_classes.contains_key(\"hover\"));\n    }\n\n    #[test]\n    fn test_breakpoint_media_queries() {\n        assert_eq!(Breakpoint::Sm.to_media_query(), \"(min-width: 640px)\");\n        assert_eq!(Breakpoint::Md.to_media_query(), \"(min-width: 768px)\");\n        assert_eq!(Breakpoint::Custom(500).to_media_query(), \"(min-width: 500px)\");\n    }\n\n    #[test]\n    fn test_animation_generation() {\n        let animation = Animation::new(\"test-anim\".to_string())\n            .keyframe(\"0%\", css_props! { \"opacity\" =\u003e \"0\" })\n            .keyframe(\"100%\", css_props! { \"opacity\" =\u003e \"1\" });\n\n        let css = animation.to_css();\n        assert!(css.contains(\"@keyframes test-anim\"));\n        assert!(css.contains(\"0%\"));\n        assert!(css.contains(\"100%\"));\n        assert!(css.contains(\"opacity: 0\"));\n        assert!(css.contains(\"opacity: 1\"));\n    }\n}","traces":[{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":1}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":1}},{"line":143,"address":[],"length":0,"stats":{"Line":2}},{"line":144,"address":[],"length":0,"stats":{"Line":1}},{"line":145,"address":[],"length":0,"stats":{"Line":1}},{"line":147,"address":[],"length":0,"stats":{"Line":3}},{"line":154,"address":[],"length":0,"stats":{"Line":1}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":1}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":1}},{"line":204,"address":[],"length":0,"stats":{"Line":2}},{"line":205,"address":[],"length":0,"stats":{"Line":2}},{"line":206,"address":[],"length":0,"stats":{"Line":2}},{"line":209,"address":[],"length":0,"stats":{"Line":1}},{"line":210,"address":[],"length":0,"stats":{"Line":1}},{"line":211,"address":[],"length":0,"stats":{"Line":1}},{"line":213,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[],"length":0,"stats":{"Line":2}},{"line":216,"address":[],"length":0,"stats":{"Line":6}},{"line":217,"address":[],"length":0,"stats":{"Line":2}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":2}},{"line":224,"address":[],"length":0,"stats":{"Line":1}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":1}},{"line":242,"address":[],"length":0,"stats":{"Line":1}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":2}},{"line":254,"address":[],"length":0,"stats":{"Line":2}},{"line":255,"address":[],"length":0,"stats":{"Line":2}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":1}},{"line":269,"address":[],"length":0,"stats":{"Line":1}},{"line":270,"address":[],"length":0,"stats":{"Line":1}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":3}},{"line":348,"address":[],"length":0,"stats":{"Line":3}},{"line":349,"address":[],"length":0,"stats":{"Line":1}},{"line":350,"address":[],"length":0,"stats":{"Line":1}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":1}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}}],"covered":41,"coverable":180},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","db.rs"],"content":"//! Database/ORM Layer - L2/L3\n//! Layer9 Database abstraction with support for multiple backends\n\nuse async_trait::async_trait;\nuse serde::de::DeserializeOwned;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\nuse std::collections::HashMap;\nuse std::marker::PhantomData;\n\n/// Database connection trait\n#[cfg(target_arch = \"wasm32\")]\n#[async_trait(?Send)]\npub trait DatabaseConnection: 'static {\n    async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e;\n    async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e;\n    async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e;\n    async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e;\n    async fn commit_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e;\n    async fn rollback_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e;\n}\n\n/// Database connection trait (server-side with Send)\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\npub trait DatabaseConnection: Send + Sync + 'static {\n    async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e;\n    async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e;\n    async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e;\n    async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e;\n    async fn commit_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e;\n    async fn rollback_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e;\n}\n\n/// Implement DatabaseConnection for Box\u003cdyn DatabaseConnection\u003e (WASM)\n#[cfg(target_arch = \"wasm32\")]\n#[async_trait(?Send)]\nimpl DatabaseConnection for Box\u003cdyn DatabaseConnection\u003e {\n    async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n        self.as_ref().execute(query, params).await\n    }\n    \n    async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e {\n        self.as_ref().query_one(query, params).await\n    }\n    \n    async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e {\n        self.as_ref().query_many(query, params).await\n    }\n    \n    async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e {\n        self.as_ref().begin_transaction().await\n    }\n    \n    async fn commit_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        self.as_ref().commit_transaction(tx_id).await\n    }\n    \n    async fn rollback_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        self.as_ref().rollback_transaction(tx_id).await\n    }\n}\n\n/// Implement DatabaseConnection for Box\u003cdyn DatabaseConnection\u003e (Server)\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl DatabaseConnection for Box\u003cdyn DatabaseConnection\u003e {\n    async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n        self.as_ref().execute(query, params).await\n    }\n    \n    async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e {\n        self.as_ref().query_one(query, params).await\n    }\n    \n    async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e {\n        self.as_ref().query_many(query, params).await\n    }\n    \n    async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e {\n        self.as_ref().begin_transaction().await\n    }\n    \n    async fn commit_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        self.as_ref().commit_transaction(tx_id).await\n    }\n    \n    async fn rollback_transaction(\u0026self, tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        self.as_ref().rollback_transaction(tx_id).await\n    }\n}\n\n/// Query result\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct QueryResult {\n    pub rows_affected: u64,\n    pub last_insert_id: Option\u003ci64\u003e,\n}\n\n/// Database error\n#[derive(Debug, Clone)]\npub struct DbError {\n    pub kind: DbErrorKind,\n    pub message: String,\n}\n\n#[derive(Debug, Clone)]\npub enum DbErrorKind {\n    Connection,\n    Query,\n    Transaction,\n    NotFound,\n    UniqueViolation,\n    ForeignKeyViolation,\n    Timeout,\n}\n\n/// Transaction handle\npub struct Transaction {\n    conn: Box\u003cdyn DatabaseConnection\u003e,\n    _id: String,\n}\n\nimpl Transaction {\n    pub async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n        self.conn.execute(query, params).await\n    }\n\n    pub async fn commit(self) -\u003e Result\u003c(), DbError\u003e {\n        self.conn.execute(\"COMMIT\", vec![]).await?;\n        Ok(())\n    }\n\n    pub async fn rollback(self) -\u003e Result\u003c(), DbError\u003e {\n        self.conn.execute(\"ROLLBACK\", vec![]).await?;\n        Ok(())\n    }\n}\n\n/// ORM Model trait\npub trait Model: Sized + Serialize + DeserializeOwned {\n    const TABLE_NAME: \u0026'static str;\n    const PRIMARY_KEY: \u0026'static str = \"id\";\n\n    fn table_name() -\u003e \u0026'static str {\n        Self::TABLE_NAME\n    }\n\n    fn primary_key() -\u003e \u0026'static str {\n        Self::PRIMARY_KEY\n    }\n}\n\n/// Query builder\npub struct QueryBuilder\u003cM: Model\u003e {\n    table: String,\n    select: Vec\u003cString\u003e,\n    joins: Vec\u003cString\u003e,\n    where_clause: Vec\u003cString\u003e,\n    order_by: Vec\u003cString\u003e,\n    limit: Option\u003cu32\u003e,\n    offset: Option\u003cu32\u003e,\n    params: Vec\u003cValue\u003e,\n    _phantom: PhantomData\u003cM\u003e,\n}\n\nimpl\u003cM: Model\u003e Default for QueryBuilder\u003cM\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl\u003cM: Model\u003e QueryBuilder\u003cM\u003e {\n    pub fn new() -\u003e Self {\n        QueryBuilder {\n            table: M::table_name().to_string(),\n            select: vec![\"*\".to_string()],\n            joins: vec![],\n            where_clause: vec![],\n            order_by: vec![],\n            limit: None,\n            offset: None,\n            params: vec![],\n            _phantom: PhantomData,\n        }\n    }\n\n    pub fn select(mut self, columns: \u0026[\u0026str]) -\u003e Self {\n        self.select = columns.iter().map(|s| s.to_string()).collect();\n        self\n    }\n\n    pub fn join(mut self, join_type: \u0026str, table: \u0026str, on: \u0026str) -\u003e Self {\n        self.joins\n            .push(format!(\"{} JOIN {} ON {}\", join_type, table, on));\n        self\n    }\n\n    pub fn where_eq(mut self, column: \u0026str, value: impl Into\u003cValue\u003e) -\u003e Self {\n        self.where_clause\n            .push(format!(\"{} = ${}\", column, self.params.len() + 1));\n        self.params.push(value.into());\n        self\n    }\n\n    pub fn where_in(mut self, column: \u0026str, values: Vec\u003cimpl Into\u003cValue\u003e\u003e) -\u003e Self {\n        let placeholders: Vec\u003cString\u003e = values\n            .iter()\n            .enumerate()\n            .map(|(i, _)| format!(\"${}\", self.params.len() + i + 1))\n            .collect();\n\n        self.where_clause\n            .push(format!(\"{} IN ({})\", column, placeholders.join(\", \")));\n        self.params.extend(values.into_iter().map(|v| v.into()));\n        self\n    }\n\n    pub fn where_like(mut self, column: \u0026str, pattern: \u0026str) -\u003e Self {\n        self.where_clause\n            .push(format!(\"{} LIKE ${}\", column, self.params.len() + 1));\n        self.params.push(Value::String(pattern.to_string()));\n        self\n    }\n\n    pub fn order_by(mut self, column: \u0026str, direction: \u0026str) -\u003e Self {\n        self.order_by.push(format!(\"{} {}\", column, direction));\n        self\n    }\n\n    pub fn limit(mut self, limit: u32) -\u003e Self {\n        self.limit = Some(limit);\n        self\n    }\n\n    pub fn offset(mut self, offset: u32) -\u003e Self {\n        self.offset = Some(offset);\n        self\n    }\n\n    pub fn build(\u0026self) -\u003e (String, Vec\u003cValue\u003e) {\n        let mut query = format!(\"SELECT {} FROM {}\", self.select.join(\", \"), self.table);\n\n        // Add joins\n        for join in \u0026self.joins {\n            query.push_str(\u0026format!(\" {}\", join));\n        }\n\n        // Add where clause\n        if !self.where_clause.is_empty() {\n            query.push_str(\u0026format!(\" WHERE {}\", self.where_clause.join(\" AND \")));\n        }\n\n        // Add order by\n        if !self.order_by.is_empty() {\n            query.push_str(\u0026format!(\" ORDER BY {}\", self.order_by.join(\", \")));\n        }\n\n        // Add limit/offset\n        if let Some(limit) = self.limit {\n            query.push_str(\u0026format!(\" LIMIT {}\", limit));\n        }\n\n        if let Some(offset) = self.offset {\n            query.push_str(\u0026format!(\" OFFSET {}\", offset));\n        }\n\n        (query, self.params.clone())\n    }\n\n    pub async fn execute\u003cC: DatabaseConnection\u003e(\u0026self, conn: \u0026C) -\u003e Result\u003cVec\u003cM\u003e, DbError\u003e {\n        let (query, params) = self.build();\n        let values = conn.query_many(\u0026query, params).await?;\n        values\n            .into_iter()\n            .map(|v| {\n                serde_json::from_value(v).map_err(|e| DbError {\n                    kind: DbErrorKind::Query,\n                    message: e.to_string(),\n                })\n            })\n            .collect()\n    }\n\n    pub async fn first\u003cC: DatabaseConnection\u003e(\u0026self, conn: \u0026C) -\u003e Result\u003cM, DbError\u003e {\n        let (query, params) = self.build();\n        let value = conn.query_one(\u0026query, params).await?;\n        serde_json::from_value(value).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })\n    }\n}\n\n/// Repository pattern\npub struct Repository\u003cM: Model, C: DatabaseConnection\u003e {\n    conn: C,\n    _phantom: PhantomData\u003cM\u003e,\n}\n\nimpl\u003cM: Model, C: DatabaseConnection\u003e Repository\u003cM, C\u003e {\n    pub fn new(conn: C) -\u003e Self {\n        Repository {\n            conn,\n            _phantom: PhantomData,\n        }\n    }\n\n    pub async fn find_by_id(\u0026self, id: impl Into\u003cValue\u003e) -\u003e Result\u003cM, DbError\u003e {\n        let query = format!(\n            \"SELECT * FROM {} WHERE {} = $1\",\n            M::table_name(),\n            M::primary_key()\n        );\n        let value = self.conn.query_one(\u0026query, vec![id.into()]).await?;\n        serde_json::from_value(value).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })\n    }\n\n    pub async fn find_all(\u0026self) -\u003e Result\u003cVec\u003cM\u003e, DbError\u003e {\n        let query = format!(\"SELECT * FROM {}\", M::table_name());\n        let values = self.conn.query_many(\u0026query, vec![]).await?;\n        values\n            .into_iter()\n            .map(|v| {\n                serde_json::from_value(v).map_err(|e| DbError {\n                    kind: DbErrorKind::Query,\n                    message: e.to_string(),\n                })\n            })\n            .collect()\n    }\n\n    pub async fn insert(\u0026self, model: \u0026M) -\u003e Result\u003cM, DbError\u003e {\n        let json = serde_json::to_value(model).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })?;\n\n        if let Value::Object(map) = json {\n            let columns: Vec\u003cString\u003e = map.keys().cloned().collect();\n            let values: Vec\u003cValue\u003e = map.values().cloned().collect();\n            let placeholders: Vec\u003cString\u003e = (1..=values.len()).map(|i| format!(\"${}\", i)).collect();\n\n            let query = format!(\n                \"INSERT INTO {} ({}) VALUES ({}) RETURNING *\",\n                M::table_name(),\n                columns.join(\", \"),\n                placeholders.join(\", \")\n            );\n\n            let value = self.conn.query_one(\u0026query, values).await?;\n            serde_json::from_value(value).map_err(|e| DbError {\n                kind: DbErrorKind::Query,\n                message: e.to_string(),\n            })\n        } else {\n            Err(DbError {\n                kind: DbErrorKind::Query,\n                message: \"Model must serialize to object\".to_string(),\n            })\n        }\n    }\n\n    pub async fn update(\n        \u0026self,\n        id: impl Into\u003cValue\u003e,\n        updates: HashMap\u003cString, Value\u003e,\n    ) -\u003e Result\u003cM, DbError\u003e {\n        let mut set_clauses = vec![];\n        let mut params = vec![];\n\n        for (i, (column, value)) in updates.iter().enumerate() {\n            set_clauses.push(format!(\"{} = ${}\", column, i + 1));\n            params.push(value.clone());\n        }\n\n        params.push(id.into());\n\n        let query = format!(\n            \"UPDATE {} SET {} WHERE {} = ${} RETURNING *\",\n            M::table_name(),\n            set_clauses.join(\", \"),\n            M::primary_key(),\n            params.len()\n        );\n\n        let value = self.conn.query_one(\u0026query, params).await?;\n        serde_json::from_value(value).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })\n    }\n\n    pub async fn delete(\u0026self, id: impl Into\u003cValue\u003e) -\u003e Result\u003c(), DbError\u003e {\n        let query = format!(\n            \"DELETE FROM {} WHERE {} = $1\",\n            M::table_name(),\n            M::primary_key()\n        );\n        self.conn.execute(\u0026query, vec![id.into()]).await?;\n        Ok(())\n    }\n\n    pub fn query(\u0026self) -\u003e QueryBuilder\u003cM\u003e {\n        QueryBuilder::new()\n    }\n}\n\n/// Database migrations\npub struct Migration {\n    pub version: i32,\n    pub name: String,\n    pub up: String,\n    pub down: String,\n}\n\npub struct Migrator\u003cC: DatabaseConnection\u003e {\n    conn: C,\n    migrations: Vec\u003cMigration\u003e,\n}\n\nimpl\u003cC: DatabaseConnection\u003e Migrator\u003cC\u003e {\n    pub fn new(conn: C) -\u003e Self {\n        Migrator {\n            conn,\n            migrations: vec![],\n        }\n    }\n\n    pub fn add_migration(mut self, migration: Migration) -\u003e Self {\n        self.migrations.push(migration);\n        self.migrations.sort_by_key(|m| m.version);\n        self\n    }\n\n    pub async fn migrate(\u0026self) -\u003e Result\u003c(), DbError\u003e {\n        // Create migrations table if not exists\n        self.conn\n            .execute(\n                \"CREATE TABLE IF NOT EXISTS _migrations (\n                version INTEGER PRIMARY KEY,\n                name TEXT NOT NULL,\n                applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\",\n                vec![],\n            )\n            .await?;\n\n        // Get applied migrations\n        let applied_values = self\n            .conn\n            .query_many(\"SELECT version FROM _migrations ORDER BY version\", vec![])\n            .await?;\n\n        let applied: Vec\u003ci32\u003e = applied_values\n            .into_iter()\n            .filter_map(|v| {\n                if let Value::Object(map) = v {\n                    map.get(\"version\")\n                        .and_then(|v| v.as_i64())\n                        .map(|v| v as i32)\n                } else {\n                    None\n                }\n            })\n            .collect();\n\n        // Apply pending migrations\n        for migration in \u0026self.migrations {\n            if !applied.contains(\u0026migration.version) {\n                // Run migration\n                self.conn.execute(\u0026migration.up, vec![]).await?;\n\n                // Record migration\n                self.conn\n                    .execute(\n                        \"INSERT INTO _migrations (version, name) VALUES ($1, $2)\",\n                        vec![\n                            Value::Number(migration.version.into()),\n                            Value::String(migration.name.clone()),\n                        ],\n                    )\n                    .await?;\n\n                web_sys::console::log_1(\u0026format!(\"Applied migration: {}\", migration.name).into());\n            }\n        }\n\n        Ok(())\n    }\n}\n\n/// Connection pool\npub struct ConnectionPool\u003cC: DatabaseConnection\u003e {\n    connections: Vec\u003cC\u003e,\n    _max_size: usize,\n}\n\nimpl\u003cC: DatabaseConnection\u003e ConnectionPool\u003cC\u003e {\n    pub fn new(max_size: usize) -\u003e Self {\n        ConnectionPool {\n            connections: vec![],\n            _max_size: max_size,\n        }\n    }\n\n    pub async fn get(\u0026self) -\u003e Result\u003c\u0026C, DbError\u003e {\n        if let Some(conn) = self.connections.first() {\n            Ok(conn)\n        } else {\n            Err(DbError {\n                kind: DbErrorKind::Connection,\n                message: \"No connections available\".to_string(),\n            })\n        }\n    }\n}\n\n/// PostgreSQL connection implementation (client-side via HTTP)\n#[derive(Clone)]\npub struct PostgresConnection {\n    #[cfg_attr(not(target_arch = \"wasm32\"), allow(dead_code))]\n    api_url: String,\n    auth_token: Option\u003cString\u003e,\n}\n\nimpl PostgresConnection {\n    pub fn new(api_url: impl Into\u003cString\u003e) -\u003e Self {\n        PostgresConnection {\n            api_url: api_url.into(),\n            auth_token: None,\n        }\n    }\n\n    pub fn with_auth(mut self, token: impl Into\u003cString\u003e) -\u003e Self {\n        self.auth_token = Some(token.into());\n        self\n    }\n}\n\n#[cfg(target_arch = \"wasm32\")]\n#[async_trait(?Send)]\nimpl DatabaseConnection for PostgresConnection {\n    async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n        let body = serde_json::json!({\n            \"query\": query,\n            \"params\": params,\n        });\n\n        let mut headers = HashMap::new();\n        headers.insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n\n        if let Some(token) = \u0026self.auth_token {\n            headers.insert(\"Authorization\".to_string(), format!(\"Bearer {}\", token));\n        }\n\n        let mut fetch_builder =\n            crate::fetch::FetchBuilder::new(format!(\"{}/execute\", self.api_url))\n                .method(crate::fetch::Method::POST);\n\n        for (key, value) in headers {\n            fetch_builder = fetch_builder.header(key, value);\n        }\n\n        fetch_builder = fetch_builder.json(\u0026body).map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: format!(\"{:?}\", e),\n        })?;\n\n        let response = fetch_builder.send().await.map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: e.to_string(),\n        })?;\n\n        let text = response.text().await.map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: e.to_string(),\n        })?;\n\n        serde_json::from_str(\u0026text).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })\n    }\n\n    async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e {\n        let body = serde_json::json!({\n            \"query\": query,\n            \"params\": params,\n        });\n\n        let mut headers = HashMap::new();\n        headers.insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n\n        if let Some(token) = \u0026self.auth_token {\n            headers.insert(\"Authorization\".to_string(), format!(\"Bearer {}\", token));\n        }\n\n        let mut fetch_builder =\n            crate::fetch::FetchBuilder::new(format!(\"{}/query_one\", self.api_url))\n                .method(crate::fetch::Method::POST);\n\n        for (key, value) in headers {\n            fetch_builder = fetch_builder.header(key, value);\n        }\n\n        fetch_builder = fetch_builder.json(\u0026body).map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: format!(\"{:?}\", e),\n        })?;\n\n        let response = fetch_builder.send().await.map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: e.to_string(),\n        })?;\n\n        let text = response.text().await.map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: e.to_string(),\n        })?;\n\n        serde_json::from_str(\u0026text).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })\n    }\n\n    async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e {\n        let body = serde_json::json!({\n            \"query\": query,\n            \"params\": params,\n        });\n\n        let mut headers = HashMap::new();\n        headers.insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n\n        if let Some(token) = \u0026self.auth_token {\n            headers.insert(\"Authorization\".to_string(), format!(\"Bearer {}\", token));\n        }\n\n        let mut fetch_builder =\n            crate::fetch::FetchBuilder::new(format!(\"{}/query_many\", self.api_url))\n                .method(crate::fetch::Method::POST);\n\n        for (key, value) in headers {\n            fetch_builder = fetch_builder.header(key, value);\n        }\n\n        fetch_builder = fetch_builder.json(\u0026body).map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: format!(\"{:?}\", e),\n        })?;\n\n        let response = fetch_builder.send().await.map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: e.to_string(),\n        })?;\n\n        let text = response.text().await.map_err(|e| DbError {\n            kind: DbErrorKind::Connection,\n            message: e.to_string(),\n        })?;\n\n        serde_json::from_str(\u0026text).map_err(|e| DbError {\n            kind: DbErrorKind::Query,\n            message: e.to_string(),\n        })\n    }\n\n    async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e {\n        self.execute(\"BEGIN\", vec![]).await?;\n        Ok(format!(\"tx_{}\", js_sys::Math::random()))\n    }\n\n    async fn commit_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        self.execute(\"COMMIT\", vec![]).await?;\n        Ok(())\n    }\n\n    async fn rollback_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        self.execute(\"ROLLBACK\", vec![]).await?;\n        Ok(())\n    }\n}\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl DatabaseConnection for PostgresConnection {\n    async fn execute(\u0026self, _query: \u0026str, _params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n        Err(DbError {\n            kind: DbErrorKind::Connection,\n            message: \"PostgresConnection not implemented for server-side. Use SqlxConnection instead.\".to_string(),\n        })\n    }\n\n    async fn query_one(\u0026self, _query: \u0026str, _params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e {\n        Err(DbError {\n            kind: DbErrorKind::Connection,\n            message: \"PostgresConnection not implemented for server-side. Use SqlxConnection instead.\".to_string(),\n        })\n    }\n\n    async fn query_many(\u0026self, _query: \u0026str, _params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e {\n        Err(DbError {\n            kind: DbErrorKind::Connection,\n            message: \"PostgresConnection not implemented for server-side. Use SqlxConnection instead.\".to_string(),\n        })\n    }\n\n    async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e {\n        Err(DbError {\n            kind: DbErrorKind::Connection,\n            message: \"PostgresConnection not implemented for server-side. Use SqlxConnection instead.\".to_string(),\n        })\n    }\n\n    async fn commit_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        Err(DbError {\n            kind: DbErrorKind::Connection,\n            message: \"PostgresConnection not implemented for server-side. Use SqlxConnection instead.\".to_string(),\n        })\n    }\n\n    async fn rollback_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        Err(DbError {\n            kind: DbErrorKind::Connection,\n            message: \"PostgresConnection not implemented for server-side. Use SqlxConnection instead.\".to_string(),\n        })\n    }\n}\n\n/// Database backend type\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum DatabaseBackend {\n    Postgres,\n    Sqlite,\n    InMemory,\n}\n\n/// Hook for database operations\n#[cfg(not(target_arch = \"wasm32\"))]\npub fn use_db() -\u003e Box\u003cdyn DatabaseConnection\u003e {\n    #[cfg(feature = \"ssr\")]\n    {\n        // Check environment variable for database type\n        let db_type = crate::env::env_or(\"DATABASE_TYPE\", \"sqlite\");\n        let db_url = crate::env::env_or(\"DATABASE_URL\", \"sqlite::memory:\");\n        \n        match db_type.as_str() {\n            \"postgres\" | \"postgresql\" =\u003e {\n                match crate::db_sqlx::use_db_server() {\n                    Ok(conn) =\u003e Box::new(conn),\n                    Err(_) =\u003e {\n                        // Fallback to creating new connection\n                        match futures::executor::block_on(crate::db_sqlx::SqlxConnection::new(\u0026db_url)) {\n                            Ok(conn) =\u003e Box::new(conn),\n                            Err(_) =\u003e {\n                                // Final fallback to HTTP connection\n                                let api_url = crate::env::env_or(\"DATABASE_API_URL\", \"http://localhost:3001/db\");\n                                let auth_token = crate::env::env_or(\"DATABASE_API_TOKEN\", \"dummy-token\");\n                                Box::new(PostgresConnection::new(api_url).with_auth(auth_token))\n                            }\n                        }\n                    }\n                }\n            }\n            \"sqlite\" =\u003e {\n                match futures::executor::block_on(crate::db_sqlite::SqliteConnection::new(\u0026db_url)) {\n                    Ok(conn) =\u003e {\n                        // Initialize default schema for new databases\n                        if db_url.contains(\":memory:\") || !std::path::Path::new(\u0026db_url.replace(\"sqlite:\", \"\")).exists() {\n                            let _ = futures::executor::block_on(crate::db_sqlite::create_default_schema(\u0026conn));\n                        }\n                        Box::new(conn)\n                    }\n                    Err(_) =\u003e {\n                        // Fallback to HTTP connection\n                        let api_url = crate::env::env_or(\"DATABASE_API_URL\", \"http://localhost:3001/db\");\n                        let auth_token = crate::env::env_or(\"DATABASE_API_TOKEN\", \"dummy-token\");\n                        Box::new(PostgresConnection::new(api_url).with_auth(auth_token))\n                    }\n                }\n            }\n            \"memory\" =\u003e {\n                // Use SQLite in-memory as the memory backend\n                match futures::executor::block_on(crate::db_sqlite::SqliteConnection::in_memory()) {\n                    Ok(conn) =\u003e {\n                        let _ = futures::executor::block_on(crate::db_sqlite::create_default_schema(\u0026conn));\n                        Box::new(conn)\n                    }\n                    Err(_) =\u003e {\n                        let api_url = crate::env::env_or(\"DATABASE_API_URL\", \"http://localhost:3001/db\");\n                        Box::new(PostgresConnection::new(api_url).with_auth(\"dummy-token\"))\n                    }\n                }\n            }\n            _ =\u003e {\n                // Default to SQLite\n                match futures::executor::block_on(crate::db_sqlite::SqliteConnection::in_memory()) {\n                    Ok(conn) =\u003e {\n                        let _ = futures::executor::block_on(crate::db_sqlite::create_default_schema(\u0026conn));\n                        Box::new(conn)\n                    }\n                    Err(_) =\u003e {\n                        let api_url = crate::env::env_or(\"DATABASE_API_URL\", \"http://localhost:3001/db\");\n                        Box::new(PostgresConnection::new(api_url).with_auth(\"dummy-token\"))\n                    }\n                }\n            }\n        }\n    }\n    #[cfg(not(feature = \"ssr\"))]\n    {\n        let api_url = crate::env::env_or(\"DATABASE_API_URL\", \"http://localhost:3001/db\");\n        let auth_token = crate::env::env_or(\"DATABASE_API_TOKEN\", \"dummy-token\");\n        Box::new(PostgresConnection::new(api_url).with_auth(auth_token))\n    }\n}\n\n/// Hook for database operations (WASM/client-side)\n#[cfg(target_arch = \"wasm32\")]\npub fn use_db() -\u003e PostgresConnection {\n    let api_url = crate::env::env_or(\"DATABASE_API_URL\", \"/api/db\");\n    let auth_token = crate::env::env_or(\"DATABASE_API_TOKEN\", \"dummy-token\");\n    PostgresConnection::new(api_url).with_auth(auth_token)\n}\n\n/// Hook for repository (client-side WASM)\n#[cfg(target_arch = \"wasm32\")]\npub fn use_repository\u003cM: Model\u003e() -\u003e Repository\u003cM, PostgresConnection\u003e {\n    let conn = use_db();\n    Repository::new(conn)\n}\n\n/// Hook for repository (server-side)\n#[cfg(not(target_arch = \"wasm32\"))]\npub fn use_repository\u003cM: Model\u003e() -\u003e Repository\u003cM, Box\u003cdyn DatabaseConnection\u003e\u003e {\n    let conn = use_db();\n    Repository::new(conn)\n}\n","traces":[{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":708,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":716,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":762,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":791,"address":[],"length":0,"stats":{"Line":0}},{"line":792,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":800,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":808,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":270},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","db_api.rs"],"content":"//! Database API endpoints for client-side database access\n//! This module provides HTTP endpoints that proxy database operations for WASM clients\n\n#[cfg(feature = \"ssr\")]\npub use api_impl::*;\n\n#[cfg(feature = \"ssr\")]\nmod api_impl {\n    use crate::db::{DatabaseConnection, DbError, DbErrorKind, QueryResult};\n    use axum::{\n        extract::{Json, State},\n        http::StatusCode,\n        response::{IntoResponse, Response},\n        routing::post,\n        Router,\n    };\n    use serde::{Deserialize, Serialize};\n    use serde_json::Value;\n    use std::sync::Arc;\n\n    #[derive(Debug, Serialize, Deserialize)]\n    pub struct QueryRequest {\n        pub query: String,\n        pub params: Vec\u003cValue\u003e,\n    }\n\n    #[derive(Debug, Serialize, Deserialize)]\n    pub struct QueryResponse {\n        pub data: Value,\n    }\n\n    #[derive(Debug, Serialize, Deserialize)]\n    pub struct ErrorResponse {\n        pub error: String,\n        pub kind: String,\n    }\n\n    impl IntoResponse for DbError {\n        fn into_response(self) -\u003e Response {\n            let error_response = ErrorResponse {\n                error: self.message,\n                kind: format!(\"{:?}\", self.kind),\n            };\n\n            let status = match self.kind {\n                DbErrorKind::NotFound =\u003e StatusCode::NOT_FOUND,\n                DbErrorKind::UniqueViolation =\u003e StatusCode::CONFLICT,\n                DbErrorKind::ForeignKeyViolation =\u003e StatusCode::BAD_REQUEST,\n                DbErrorKind::Timeout =\u003e StatusCode::REQUEST_TIMEOUT,\n                _ =\u003e StatusCode::INTERNAL_SERVER_ERROR,\n            };\n\n            (status, Json(error_response)).into_response()\n        }\n    }\n\n    /// Create database API router\n    pub fn create_db_api_router\u003cC: DatabaseConnection + Send + Sync + 'static\u003e(\n        connection: C,\n    ) -\u003e Router {\n        let shared_conn = Arc::new(connection);\n\n        Router::new()\n            .route(\"/execute\", post(execute_handler::\u003cC\u003e))\n            .route(\"/query_one\", post(query_one_handler::\u003cC\u003e))\n            .route(\"/query_many\", post(query_many_handler::\u003cC\u003e))\n            .with_state(shared_conn)\n    }\n\n    async fn execute_handler\u003cC: DatabaseConnection\u003e(\n        State(conn): State\u003cArc\u003cC\u003e\u003e,\n        Json(req): Json\u003cQueryRequest\u003e,\n    ) -\u003e Result\u003cJson\u003cQueryResult\u003e, DbError\u003e {\n        let result = conn.execute(\u0026req.query, req.params).await?;\n        Ok(Json(result))\n    }\n\n    async fn query_one_handler\u003cC: DatabaseConnection\u003e(\n        State(conn): State\u003cArc\u003cC\u003e\u003e,\n        Json(req): Json\u003cQueryRequest\u003e,\n    ) -\u003e Result\u003cJson\u003cValue\u003e, DbError\u003e {\n        let result = conn.query_one(\u0026req.query, req.params).await?;\n        Ok(Json(result))\n    }\n\n    async fn query_many_handler\u003cC: DatabaseConnection\u003e(\n        State(conn): State\u003cArc\u003cC\u003e\u003e,\n        Json(req): Json\u003cQueryRequest\u003e,\n    ) -\u003e Result\u003cJson\u003cVec\u003cValue\u003e\u003e, DbError\u003e {\n        let result = conn.query_many(\u0026req.query, req.params).await?;\n        Ok(Json(result))\n    }\n\n    use axum::extract::FromRequestParts;\n    use axum::http::header::AUTHORIZATION;\n    use axum::http::request::Parts;\n    use async_trait::async_trait;\n    \n    /// Database API authentication token\n    #[derive(Debug, Clone)]\n    pub struct DbAuthToken(pub String);\n    \n    #[async_trait]\n    impl\u003cS\u003e FromRequestParts\u003cS\u003e for DbAuthToken\n    where\n        S: Send + Sync,\n    {\n        type Rejection = StatusCode;\n        \n        async fn from_request_parts(parts: \u0026mut Parts, _state: \u0026S) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n            let auth_header = parts\n                .headers\n                .get(AUTHORIZATION)\n                .and_then(|value| value.to_str().ok());\n                \n            match auth_header {\n                Some(auth) if auth.starts_with(\"Bearer \") =\u003e {\n                    let token = auth.trim_start_matches(\"Bearer \");\n                    Ok(DbAuthToken(token.to_string()))\n                }\n                _ =\u003e Err(StatusCode::UNAUTHORIZED),\n            }\n        }\n    }\n    \n    /// Middleware for database API authentication\n    pub async fn auth_middleware(\n        req: axum::http::Request\u003caxum::body::Body\u003e,\n        next: axum::middleware::Next,\n    ) -\u003e Result\u003cResponse, StatusCode\u003e {\n        let headers = req.headers();\n        let auth_header = headers\n            .get(AUTHORIZATION)\n            .and_then(|value| value.to_str().ok());\n            \n        match auth_header {\n            Some(auth) if auth.starts_with(\"Bearer \") =\u003e {\n                let token = auth.trim_start_matches(\"Bearer \");\n                \n                // Validate token\n                if validate_db_token(token) {\n                    Ok(next.run(req).await)\n                } else {\n                    Err(StatusCode::UNAUTHORIZED)\n                }\n            }\n            _ =\u003e {\n                // Allow requests from localhost without auth in development\n                let is_localhost = req\n                    .headers()\n                    .get(\"host\")\n                    .and_then(|h| h.to_str().ok())\n                    .map(|h| h.starts_with(\"localhost\") || h.starts_with(\"127.0.0.1\"))\n                    .unwrap_or(false);\n                    \n                if is_localhost \u0026\u0026 cfg!(debug_assertions) {\n                    Ok(next.run(req).await)\n                } else {\n                    Err(StatusCode::UNAUTHORIZED)\n                }\n            }\n        }\n    }\n    \n    /// Validate database access token\n    fn validate_db_token(token: \u0026str) -\u003e bool {\n        // Get expected token from environment\n        let expected_token = std::env::var(\"DATABASE_API_TOKEN\")\n            .unwrap_or_else(|_| \"dummy-token\".to_string());\n            \n        // In production, you would validate against a real auth service\n        // For now, just check against environment variable\n        token == expected_token\n    }\n    \n    /// Create database API router with authentication\n    pub fn create_db_api_router_with_auth\u003cC: DatabaseConnection + Send + Sync + 'static\u003e(\n        connection: C,\n    ) -\u003e Router {\n        let shared_conn = Arc::new(connection);\n        \n        Router::new()\n            .route(\"/execute\", post(execute_handler::\u003cC\u003e))\n            .route(\"/query_one\", post(query_one_handler::\u003cC\u003e))\n            .route(\"/query_many\", post(query_many_handler::\u003cC\u003e))\n            .layer(axum::middleware::from_fn(auth_middleware))\n            .with_state(shared_conn)\n    }\n}","traces":[{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":29},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","db_sqlite.rs"],"content":"//! SQLite Database Implementation\n//! Provides a lightweight database option for development and small-scale deployments\n\n#[cfg(feature = \"ssr\")]\npub use sqlite_impl::*;\n\n#[cfg(feature = \"ssr\")]\nmod sqlite_impl {\n    use crate::db::{DatabaseConnection, DbError, DbErrorKind, QueryResult};\n    use async_trait::async_trait;\n    use serde_json::Value;\n    use sqlx::{sqlite::SqlitePoolOptions, Column, Pool, Row, Sqlite};\n    use std::sync::Arc;\n\n    /// SQLite-based connection for lightweight database needs\n    #[derive(Clone)]\n    pub struct SqliteConnection {\n        pool: Arc\u003cPool\u003cSqlite\u003e\u003e,\n    }\n\n    impl SqliteConnection {\n        /// Create a new SQLite connection\n        /// Use \":memory:\" for in-memory database\n        pub async fn new(database_url: \u0026str) -\u003e Result\u003cSelf, DbError\u003e {\n            let pool = SqlitePoolOptions::new()\n                .max_connections(5)\n                .connect(database_url)\n                .await\n                .map_err(|e| DbError {\n                    kind: DbErrorKind::Connection,\n                    message: format!(\"Failed to connect to SQLite database: {}\", e),\n                })?;\n\n            Ok(SqliteConnection {\n                pool: Arc::new(pool),\n            })\n        }\n\n        /// Create an in-memory SQLite database (useful for testing)\n        pub async fn in_memory() -\u003e Result\u003cSelf, DbError\u003e {\n            Self::new(\":memory:\").await\n        }\n\n        /// Get the underlying SQLx pool\n        pub fn pool(\u0026self) -\u003e \u0026Pool\u003cSqlite\u003e {\n            \u0026self.pool\n        }\n\n        /// Convert SQLx Row to JSON Value\n        fn row_to_json(row: \u0026sqlx::sqlite::SqliteRow) -\u003e Result\u003cValue, DbError\u003e {\n            let mut map = serde_json::Map::new();\n            \n            for column in row.columns() {\n                let name = column.name();\n                let value = if let Ok(val) = row.try_get::\u003cOption\u003cString\u003e, _\u003e(name) {\n                    match val {\n                        Some(s) =\u003e Value::String(s),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003ci32\u003e, _\u003e(name) {\n                    match val {\n                        Some(i) =\u003e Value::Number(i.into()),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003ci64\u003e, _\u003e(name) {\n                    match val {\n                        Some(i) =\u003e Value::Number(i.into()),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003cf64\u003e, _\u003e(name) {\n                    match val {\n                        Some(f) =\u003e serde_json::Number::from_f64(f)\n                            .map(Value::Number)\n                            .unwrap_or(Value::Null),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003cbool\u003e, _\u003e(name) {\n                    match val {\n                        Some(b) =\u003e Value::Bool(b),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003cVec\u003cu8\u003e\u003e, _\u003e(name) {\n                    // Handle BLOB data as base64\n                    match val {\n                        Some(bytes) =\u003e {\n                            use base64::{Engine as _, engine::general_purpose};\n                            Value::String(general_purpose::STANDARD.encode(bytes))\n                        }\n                        None =\u003e Value::Null,\n                    }\n                } else {\n                    Value::Null\n                };\n                \n                map.insert(name.to_string(), value);\n            }\n            \n            Ok(Value::Object(map))\n        }\n\n        /// Convert query parameters from JSON to SQLite format\n        fn convert_params(params: Vec\u003cValue\u003e) -\u003e Vec\u003cOption\u003cString\u003e\u003e {\n            params\n                .into_iter()\n                .map(|v| match v {\n                    Value::String(s) =\u003e Some(s),\n                    Value::Number(n) =\u003e Some(n.to_string()),\n                    Value::Bool(b) =\u003e Some(if b { \"1\" } else { \"0\" }.to_string()),\n                    Value::Null =\u003e None,\n                    _ =\u003e Some(v.to_string()),\n                })\n                .collect()\n        }\n    }\n\n    #[async_trait]\n    impl DatabaseConnection for SqliteConnection {\n        async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n            let mut sqlx_query = sqlx::query(query);\n            \n            // Bind parameters\n            for param in Self::convert_params(params) {\n                sqlx_query = sqlx_query.bind(param);\n            }\n\n            let result = sqlx_query\n                .execute(\u0026*self.pool)\n                .await\n                .map_err(|e| DbError {\n                    kind: match \u0026e {\n                        sqlx::Error::Database(db_err) if db_err.message().contains(\"UNIQUE\") =\u003e {\n                            DbErrorKind::UniqueViolation\n                        }\n                        sqlx::Error::Database(db_err) if db_err.message().contains(\"FOREIGN KEY\") =\u003e {\n                            DbErrorKind::ForeignKeyViolation\n                        }\n                        _ =\u003e DbErrorKind::Query,\n                    },\n                    message: format!(\"Query execution failed: {}\", e),\n                })?;\n\n            Ok(QueryResult {\n                rows_affected: result.rows_affected(),\n                last_insert_id: Some(result.last_insert_rowid()),\n            })\n        }\n\n        async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e {\n            let mut sqlx_query = sqlx::query(query);\n            \n            // Bind parameters\n            for param in Self::convert_params(params) {\n                sqlx_query = sqlx_query.bind(param);\n            }\n\n            let row = sqlx_query\n                .fetch_one(\u0026*self.pool)\n                .await\n                .map_err(|e| match e {\n                    sqlx::Error::RowNotFound =\u003e DbError {\n                        kind: DbErrorKind::NotFound,\n                        message: \"No rows found\".to_string(),\n                    },\n                    _ =\u003e DbError {\n                        kind: DbErrorKind::Query,\n                        message: format!(\"Query failed: {}\", e),\n                    },\n                })?;\n\n            Self::row_to_json(\u0026row)\n        }\n\n        async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e {\n            let mut sqlx_query = sqlx::query(query);\n            \n            // Bind parameters\n            for param in Self::convert_params(params) {\n                sqlx_query = sqlx_query.bind(param);\n            }\n\n            let rows = sqlx_query\n                .fetch_all(\u0026*self.pool)\n                .await\n                .map_err(|e| DbError {\n                    kind: DbErrorKind::Query,\n                    message: format!(\"Query failed: {}\", e),\n                })?;\n\n            rows.iter()\n                .map(Self::row_to_json)\n                .collect::\u003cResult\u003cVec\u003c_\u003e, _\u003e\u003e()\n        }\n\n        async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e {\n            // SQLite uses a different transaction syntax\n            self.execute(\"BEGIN TRANSACTION\", vec![]).await?;\n            Ok(format!(\"tx_{}\", uuid::Uuid::new_v4()))\n        }\n\n        async fn commit_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n            self.execute(\"COMMIT\", vec![]).await?;\n            Ok(())\n        }\n\n        async fn rollback_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n            self.execute(\"ROLLBACK\", vec![]).await?;\n            Ok(())\n        }\n    }\n\n    /// Create default tables for a new SQLite database\n    pub async fn create_default_schema(conn: \u0026SqliteConnection) -\u003e Result\u003c(), DbError\u003e {\n        // Enable foreign keys (disabled by default in SQLite)\n        conn.execute(\"PRAGMA foreign_keys = ON\", vec![]).await?;\n        \n        // Create users table\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS users (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                username TEXT NOT NULL UNIQUE,\n                email TEXT NOT NULL UNIQUE,\n                password_hash TEXT NOT NULL,\n                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n            )\",\n            vec![],\n        ).await?;\n\n        // Create posts table (example)\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS posts (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                user_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                content TEXT,\n                published BOOLEAN DEFAULT FALSE,\n                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\n            )\",\n            vec![],\n        ).await?;\n\n        // Create sessions table\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS sessions (\n                id TEXT PRIMARY KEY,\n                user_id INTEGER NOT NULL,\n                expires_at DATETIME NOT NULL,\n                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\n            )\",\n            vec![],\n        ).await?;\n\n        Ok(())\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","db_sqlx.rs"],"content":"//! SQLx Database Implementation for Server-Side Rendering\n//! This module provides real database connectivity using SQLx for server-side operations\n\n#[cfg(feature = \"ssr\")]\npub use sqlx_impl::*;\n\n#[cfg(feature = \"ssr\")]\nmod sqlx_impl {\n    use crate::db::{DatabaseConnection, DbError, DbErrorKind, QueryResult};\n    use async_trait::async_trait;\n    use serde_json::Value;\n    use sqlx::{postgres::PgPoolOptions, Column, Pool, Postgres, Row};\n    use std::sync::Arc;\n\n    /// SQLx-based PostgreSQL connection for server-side use\n    #[derive(Clone)]\n    pub struct SqlxConnection {\n        pool: Arc\u003cPool\u003cPostgres\u003e\u003e,\n    }\n\n    impl SqlxConnection {\n        /// Create a new SQLx connection from a database URL\n        pub async fn new(database_url: \u0026str) -\u003e Result\u003cSelf, DbError\u003e {\n            let pool = PgPoolOptions::new()\n                .max_connections(5)\n                .connect(database_url)\n                .await\n                .map_err(|e| DbError {\n                    kind: DbErrorKind::Connection,\n                    message: format!(\"Failed to connect to database: {}\", e),\n                })?;\n\n            Ok(SqlxConnection {\n                pool: Arc::new(pool),\n            })\n        }\n\n        /// Get the underlying SQLx pool\n        pub fn pool(\u0026self) -\u003e \u0026Pool\u003cPostgres\u003e {\n            \u0026self.pool\n        }\n\n        /// Convert SQLx Row to JSON Value\n        fn row_to_json(row: \u0026sqlx::postgres::PgRow) -\u003e Result\u003cValue, DbError\u003e {\n            let mut map = serde_json::Map::new();\n            \n            for column in row.columns() {\n                let name = column.name();\n                let value = if let Ok(val) = row.try_get::\u003cOption\u003cString\u003e, _\u003e(name) {\n                    match val {\n                        Some(s) =\u003e Value::String(s),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003ci32\u003e, _\u003e(name) {\n                    match val {\n                        Some(i) =\u003e Value::Number(i.into()),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003ci64\u003e, _\u003e(name) {\n                    match val {\n                        Some(i) =\u003e Value::Number(i.into()),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003cf64\u003e, _\u003e(name) {\n                    match val {\n                        Some(f) =\u003e serde_json::Number::from_f64(f)\n                            .map(Value::Number)\n                            .unwrap_or(Value::Null),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003cbool\u003e, _\u003e(name) {\n                    match val {\n                        Some(b) =\u003e Value::Bool(b),\n                        None =\u003e Value::Null,\n                    }\n                } else if let Ok(val) = row.try_get::\u003cOption\u003cserde_json::Value\u003e, _\u003e(name) {\n                    val.unwrap_or(Value::Null)\n                } else {\n                    Value::Null\n                };\n                \n                map.insert(name.to_string(), value);\n            }\n            \n            Ok(Value::Object(map))\n        }\n\n        /// Convert query parameters from JSON to SQLx format\n        fn convert_params(params: Vec\u003cValue\u003e) -\u003e Vec\u003cOption\u003cString\u003e\u003e {\n            params\n                .into_iter()\n                .map(|v| match v {\n                    Value::String(s) =\u003e Some(s),\n                    Value::Number(n) =\u003e Some(n.to_string()),\n                    Value::Bool(b) =\u003e Some(b.to_string()),\n                    Value::Null =\u003e None,\n                    _ =\u003e Some(v.to_string()),\n                })\n                .collect()\n        }\n    }\n\n    #[async_trait]\n    impl DatabaseConnection for SqlxConnection {\n        async fn execute(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cQueryResult, DbError\u003e {\n            let mut sqlx_query = sqlx::query(query);\n            \n            // Bind parameters\n            for param in Self::convert_params(params) {\n                sqlx_query = sqlx_query.bind(param);\n            }\n\n            let result = sqlx_query\n                .execute(\u0026*self.pool)\n                .await\n                .map_err(|e| DbError {\n                    kind: DbErrorKind::Query,\n                    message: format!(\"Query execution failed: {}\", e),\n                })?;\n\n            Ok(QueryResult {\n                rows_affected: result.rows_affected(),\n                last_insert_id: None, // PostgreSQL doesn't have LAST_INSERT_ID\n            })\n        }\n\n        async fn query_one(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cValue, DbError\u003e {\n            let mut sqlx_query = sqlx::query(query);\n            \n            // Bind parameters\n            for param in Self::convert_params(params) {\n                sqlx_query = sqlx_query.bind(param);\n            }\n\n            let row = sqlx_query\n                .fetch_one(\u0026*self.pool)\n                .await\n                .map_err(|e| match e {\n                    sqlx::Error::RowNotFound =\u003e DbError {\n                        kind: DbErrorKind::NotFound,\n                        message: \"No rows found\".to_string(),\n                    },\n                    _ =\u003e DbError {\n                        kind: DbErrorKind::Query,\n                        message: format!(\"Query failed: {}\", e),\n                    },\n                })?;\n\n            Self::row_to_json(\u0026row)\n        }\n\n        async fn query_many(\u0026self, query: \u0026str, params: Vec\u003cValue\u003e) -\u003e Result\u003cVec\u003cValue\u003e, DbError\u003e {\n            let mut sqlx_query = sqlx::query(query);\n            \n            // Bind parameters\n            for param in Self::convert_params(params) {\n                sqlx_query = sqlx_query.bind(param);\n            }\n\n            let rows = sqlx_query\n                .fetch_all(\u0026*self.pool)\n                .await\n                .map_err(|e| DbError {\n                    kind: DbErrorKind::Query,\n                    message: format!(\"Query failed: {}\", e),\n                })?;\n\n            rows.iter()\n                .map(Self::row_to_json)\n                .collect::\u003cResult\u003cVec\u003c_\u003e, _\u003e\u003e()\n        }\n\n        async fn begin_transaction(\u0026self) -\u003e Result\u003cString, DbError\u003e {\n            // In a real implementation, we'd need to manage transaction state\n            // For now, we'll use the connection directly\n            self.execute(\"BEGIN\", vec![]).await?;\n            Ok(format!(\"tx_{}\", uuid::Uuid::new_v4()))\n        }\n\n        async fn commit_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n            self.execute(\"COMMIT\", vec![]).await?;\n            Ok(())\n        }\n\n        async fn rollback_transaction(\u0026self, _tx_id: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n            self.execute(\"ROLLBACK\", vec![]).await?;\n            Ok(())\n        }\n    }\n\n    use once_cell::sync::OnceCell;\n    \n    /// Database pool for server-side use\n    static DB_POOL: OnceCell\u003cSqlxConnection\u003e = OnceCell::new();\n\n    /// Initialize the database pool\n    pub async fn init_db_pool(database_url: \u0026str) -\u003e Result\u003c(), DbError\u003e {\n        let conn = SqlxConnection::new(database_url).await?;\n        DB_POOL.set(conn).map_err(|_| DbError {\n            kind: DbErrorKind::Connection,\n            message: \"Database pool already initialized\".to_string(),\n        })?;\n        Ok(())\n    }\n\n    /// Get the database connection from the pool\n    pub fn get_db_connection() -\u003e Result\u003cSqlxConnection, DbError\u003e {\n        DB_POOL.get().cloned().ok_or_else(|| DbError {\n            kind: DbErrorKind::Connection,\n            message: \"Database pool not initialized. Call init_db_pool first.\".to_string(),\n        })\n    }\n\n    /// Server-side database hook\n    pub fn use_db_server() -\u003e Result\u003cSqlxConnection, DbError\u003e {\n        get_db_connection()\n    }\n}\n\n// Re-export for conditional compilation\n#[cfg(not(feature = \"ssr\"))]\npub use crate::db::PostgresConnection as SqlxConnection;","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","env.rs"],"content":"//! Environment Variables Support - L2/L3\n\nuse once_cell::sync::Lazy;\nuse std::collections::HashMap;\nuse wasm_bindgen::prelude::*;\n\n/// Environment variables store\nstatic ENV_VARS: Lazy\u003cHashMap\u003cString, String\u003e\u003e = Lazy::new(|| {\n    let mut vars = HashMap::new();\n\n    // In production, these would be injected at build time\n    #[cfg(debug_assertions)]\n    {\n        // Development defaults\n        vars.insert(\"APP_ENV\".to_string(), \"development\".to_string());\n        vars.insert(\"API_URL\".to_string(), \"http://localhost:3001\".to_string());\n        vars.insert(\"LOG_LEVEL\".to_string(), \"debug\".to_string());\n    }\n\n    // Try to load from window.__ENV__ if available\n    if let Some(window) = web_sys::window() {\n        if let Ok(env_obj) = js_sys::Reflect::get(\u0026window, \u0026\"__ENV__\".into()) {\n            let entries = js_sys::Object::entries(\u0026env_obj.into());\n            for i in 0..entries.length() {\n                let entry = entries.get(i);\n                if !entry.is_undefined() \u0026\u0026 !entry.is_null() \u0026\u0026 entry.is_array() {\n                    let entry_array = js_sys::Array::from(\u0026entry);\n                    if entry_array.length() \u003e= 2 {\n                        if let (Some(key), Some(value)) = (\n                            entry_array.get(0).as_string(),\n                            entry_array.get(1).as_string(),\n                        ) {\n                            vars.insert(key, value);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    vars\n});\n\n/// Get environment variable\npub fn env(key: \u0026str) -\u003e Option\u003cString\u003e {\n    ENV_VARS.get(key).cloned()\n}\n\n/// Get environment variable or default\npub fn env_or(key: \u0026str, default: \u0026str) -\u003e String {\n    ENV_VARS\n        .get(key)\n        .cloned()\n        .unwrap_or_else(|| default.to_string())\n}\n\n/// Get required environment variable\npub fn env_required(key: \u0026str) -\u003e Result\u003cString, String\u003e {\n    ENV_VARS\n        .get(key)\n        .cloned()\n        .ok_or_else(|| format!(\"Required environment variable {} not found\", key))\n}\n\n/// Check if running in production\npub fn is_production() -\u003e bool {\n    env(\"APP_ENV\").map(|e| e == \"production\").unwrap_or(false)\n}\n\n/// Check if running in development\npub fn is_development() -\u003e bool {\n    env(\"APP_ENV\").map(|e| e == \"development\").unwrap_or(true)\n}\n\n/// Environment configuration\n#[derive(Clone)]\npub struct Config {\n    pub app_env: String,\n    pub api_url: String,\n    pub log_level: String,\n    pub features: Features,\n    pub auth: AuthConfig,\n    pub analytics: AnalyticsConfig,\n}\n\n#[derive(Clone)]\npub struct Features {\n    pub maintenance_mode: bool,\n    pub new_feature_flag: bool,\n    pub experimental: bool,\n}\n\n#[derive(Clone)]\npub struct AuthConfig {\n    pub oauth_providers: Vec\u003cString\u003e,\n    pub session_timeout: u64,\n    pub jwt_secret: Option\u003cString\u003e,\n}\n\n#[derive(Clone)]\npub struct AnalyticsConfig {\n    pub enabled: bool,\n    pub tracking_id: Option\u003cString\u003e,\n    pub sample_rate: f32,\n}\n\nimpl Config {\n    pub fn from_env() -\u003e Result\u003cSelf, String\u003e {\n        Ok(Config {\n            app_env: env_or(\"APP_ENV\", \"development\"),\n            api_url: env_required(\"API_URL\")?,\n            log_level: env_or(\"LOG_LEVEL\", \"info\"),\n            features: Features {\n                maintenance_mode: env(\"MAINTENANCE_MODE\")\n                    .map(|v| v == \"true\")\n                    .unwrap_or(false),\n                new_feature_flag: env(\"FEATURE_NEW_UI\").map(|v| v == \"true\").unwrap_or(false),\n                experimental: env(\"EXPERIMENTAL\").map(|v| v == \"true\").unwrap_or(false),\n            },\n            auth: AuthConfig {\n                oauth_providers: env(\"OAUTH_PROVIDERS\")\n                    .map(|v| v.split(',').map(|s| s.to_string()).collect())\n                    .unwrap_or_else(|| vec![\"github\".to_string()]),\n                session_timeout: env(\"SESSION_TIMEOUT\")\n                    .and_then(|v| v.parse().ok())\n                    .unwrap_or(3600),\n                jwt_secret: env(\"JWT_SECRET\"),\n            },\n            analytics: AnalyticsConfig {\n                enabled: env(\"ANALYTICS_ENABLED\")\n                    .map(|v| v == \"true\")\n                    .unwrap_or(true),\n                tracking_id: env(\"ANALYTICS_TRACKING_ID\"),\n                sample_rate: env(\"ANALYTICS_SAMPLE_RATE\")\n                    .and_then(|v| v.parse().ok())\n                    .unwrap_or(1.0),\n            },\n        })\n    }\n}\n\n/// Global config instance\nstatic CONFIG: Lazy\u003cResult\u003cConfig, String\u003e\u003e = Lazy::new(Config::from_env);\n\n/// Get global config\npub fn config() -\u003e Result\u003c\u0026'static Config, \u0026'static String\u003e {\n    CONFIG.as_ref()\n}\n\n/// Environment variable injection for build time\n#[wasm_bindgen]\npub fn inject_env(key: String, value: String) {\n    // This would be called during build to inject variables\n    // In practice, we'd use a build script or webpack plugin\n    web_sys::console::log_1(\u0026format!(\"Injecting env var: {} = {}\", key, value).into());\n}\n\n/// Feature flags\npub struct FeatureFlags;\n\nimpl FeatureFlags {\n    pub fn is_enabled(feature: \u0026str) -\u003e bool {\n        match feature {\n            \"maintenance_mode\" =\u003e config()\n                .map(|c| c.features.maintenance_mode)\n                .unwrap_or(false),\n            \"new_ui\" =\u003e config()\n                .map(|c| c.features.new_feature_flag)\n                .unwrap_or(false),\n            \"experimental\" =\u003e config().map(|c| c.features.experimental).unwrap_or(false),\n            _ =\u003e false,\n        }\n    }\n\n    pub fn require(feature: \u0026str) -\u003e Result\u003c(), String\u003e {\n        if Self::is_enabled(feature) {\n            Ok(())\n        } else {\n            Err(format!(\"Feature {} is not enabled\", feature))\n        }\n    }\n}\n\n/// Environment-specific behavior\npub fn with_env\u003cT\u003e(production: impl FnOnce() -\u003e T, development: impl FnOnce() -\u003e T) -\u003e T {\n    if is_production() {\n        production()\n    } else {\n        development()\n    }\n}\n\n/// Macro for compile-time environment variables\n#[macro_export]\nmacro_rules! env_at_compile_time {\n    ($key:expr) =\u003e {\n        option_env!($key).unwrap_or(\"\")\n    };\n    ($key:expr, $default:expr) =\u003e {\n        option_env!($key).unwrap_or($default)\n    };\n}\n\n/// Build information\npub struct BuildInfo;\n\nimpl BuildInfo {\n    pub fn version() -\u003e \u0026'static str {\n        env_at_compile_time!(\"CARGO_PKG_VERSION\")\n    }\n\n    pub fn commit_hash() -\u003e \u0026'static str {\n        env_at_compile_time!(\"GIT_COMMIT\", \"unknown\")\n    }\n\n    pub fn build_date() -\u003e \u0026'static str {\n        env_at_compile_time!(\"BUILD_DATE\", \"unknown\")\n    }\n\n    pub fn target() -\u003e \u0026'static str {\n        env_at_compile_time!(\"TARGET\", \"wasm32-unknown-unknown\")\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","error.rs"],"content":"//! Error Boundaries - L5/L6\n\nuse crate::prelude::*;\nuse std::cell::RefCell;\nuse std::panic;\nuse std::rc::Rc;\n\n// Type aliases to simplify complex types\ntype ErrorHandler = Box\u003cdyn Fn(\u0026ErrorInfo)\u003e;\ntype FallbackRender = Box\u003cdyn Fn(\u0026ErrorInfo) -\u003e Element\u003e;\n\n/// Error boundary state\n#[derive(Clone)]\npub struct ErrorBoundaryState {\n    pub error: Option\u003cErrorInfo\u003e,\n    pub error_count: u32,\n}\n\n#[derive(Clone)]\npub struct ErrorInfo {\n    pub message: String,\n    pub stack: Option\u003cString\u003e,\n    pub component_stack: Vec\u003cString\u003e,\n}\n\n/// Error boundary component\npub struct ErrorBoundary {\n    children: Box\u003cdyn Component\u003e,\n    fallback: FallbackRender,\n    on_error: Option\u003cErrorHandler\u003e,\n    state: Rc\u003cRefCell\u003cErrorBoundaryState\u003e\u003e,\n}\n\nimpl ErrorBoundary {\n    pub fn new(children: impl Component + 'static) -\u003e Self {\n        ErrorBoundary {\n            children: Box::new(children),\n            fallback: Box::new(default_error_fallback),\n            on_error: None,\n            state: Rc::new(RefCell::new(ErrorBoundaryState {\n                error: None,\n                error_count: 0,\n            })),\n        }\n    }\n\n    pub fn fallback(mut self, fallback: impl Fn(\u0026ErrorInfo) -\u003e Element + 'static) -\u003e Self {\n        self.fallback = Box::new(fallback);\n        self\n    }\n\n    pub fn on_error(mut self, handler: impl Fn(\u0026ErrorInfo) + 'static) -\u003e Self {\n        self.on_error = Some(Box::new(handler));\n        self\n    }\n\n    fn catch_error(\u0026self) -\u003e Element {\n        // Try to render children\n        let result = panic::catch_unwind(panic::AssertUnwindSafe(|| self.children.render()));\n\n        match result {\n            Ok(element) =\u003e element,\n            Err(err) =\u003e {\n                // Extract error message\n                let message = if let Some(s) = err.downcast_ref::\u003c\u0026str\u003e() {\n                    s.to_string()\n                } else if let Some(s) = err.downcast_ref::\u003cString\u003e() {\n                    s.clone()\n                } else {\n                    \"Unknown error\".to_string()\n                };\n\n                let error_info = ErrorInfo {\n                    message,\n                    stack: None,\n                    component_stack: vec![], // TODO: Implement component stack tracking\n                };\n\n                self.state.borrow_mut().error = Some(error_info.clone());\n                self.state.borrow_mut().error_count += 1;\n\n                if let Some(handler) = \u0026self.on_error {\n                    handler(\u0026error_info);\n                }\n\n                (self.fallback)(\u0026error_info)\n            }\n        }\n    }\n}\n\nimpl Component for ErrorBoundary {\n    fn render(\u0026self) -\u003e Element {\n        // Check if we already have an error\n        if let Some(error_info) = \u0026self.state.borrow().error {\n            return (self.fallback)(error_info);\n        }\n\n        // Try to render children with error catching\n        self.catch_error()\n    }\n}\n\n/// Default error fallback UI\nfn default_error_fallback(error: \u0026ErrorInfo) -\u003e Element {\n    use crate::component::{Element, Props};\n\n    let props = Props {\n        class: Some(\"error-boundary-fallback\".to_string()),\n        ..Default::default()\n    };\n\n    Element::Node {\n        tag: \"div\".to_string(),\n        props,\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Something went wrong\".to_string())],\n            },\n            Element::Node {\n                tag: \"p\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(error.message.clone())],\n            },\n        ],\n    }\n}\n\n/// Error logger service\npub struct ErrorLogger {\n    endpoint: String,\n    api_key: String,\n}\n\nimpl ErrorLogger {\n    pub fn new(endpoint: impl Into\u003cString\u003e, api_key: impl Into\u003cString\u003e) -\u003e Self {\n        ErrorLogger {\n            endpoint: endpoint.into(),\n            api_key: api_key.into(),\n        }\n    }\n\n    pub async fn log_error(\u0026self, error: \u0026ErrorInfo) -\u003e Result\u003c(), FetchError\u003e {\n        let payload = serde_json::json!({\n            \"message\": error.message,\n            \"stack\": error.stack,\n            \"component_stack\": error.component_stack,\n            \"timestamp\": js_sys::Date::now(),\n            \"user_agent\": window().unwrap().navigator().user_agent().unwrap(),\n            \"url\": window().unwrap().location().href().unwrap(),\n        });\n\n        FetchBuilder::new(\u0026self.endpoint)\n            .method(Method::POST)\n            .header(\"X-API-Key\", \u0026self.api_key)\n            .json(\u0026payload)?\n            .send()\n            .await?;\n\n        Ok(())\n    }\n}\n\n/// Global error handler\nstatic ERROR_LOGGER: once_cell::sync::Lazy\u003cOption\u003cErrorLogger\u003e\u003e =\n    once_cell::sync::Lazy::new(|| None);\n\npub fn init_error_logging(_endpoint: impl Into\u003cString\u003e, _api_key: impl Into\u003cString\u003e) {\n    // This is a simplification - in real code you'd use a Mutex\n    // ERROR_LOGGER = Some(ErrorLogger::new(endpoint, api_key));\n}\n\n/// Catch async errors\npub async fn catch_async\u003cT, E\u003e(\n    future: impl std::future::Future\u003cOutput = Result\u003cT, E\u003e\u003e,\n) -\u003e Result\u003cT, String\u003e\nwhere\n    E: std::fmt::Display,\n{\n    match future.await {\n        Ok(value) =\u003e Ok(value),\n        Err(e) =\u003e {\n            let error_msg = e.to_string();\n\n            // Log error if logger is configured\n            if let Some(logger) = ERROR_LOGGER.as_ref() {\n                let error_info = ErrorInfo {\n                    message: error_msg.clone(),\n                    stack: None,\n                    component_stack: vec![],\n                };\n\n                let _ = logger.log_error(\u0026error_info).await;\n            }\n\n            Err(error_msg)\n        }\n    }\n}\n\n/// Hook to handle errors in components\npub fn use_error_handler() -\u003e impl Fn(String) {\n    move |error: String| {\n        web_sys::console::error_1(\u0026format!(\"Error: {}\", error).into());\n    }\n}\n\n// Re-exports\nuse crate::fetch::{FetchBuilder, FetchError, Method};\nuse web_sys::window;\n","traces":[{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":62},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","fetch.rs"],"content":"//! Fetch API - L4 (Real HTTP calls)\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen_futures::JsFuture;\nuse web_sys::{Request, RequestInit, Response};\n\n/// HTTP methods\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum Method {\n    GET,\n    POST,\n    PUT,\n    DELETE,\n    PATCH,\n    OPTIONS,\n}\n\nimpl Method {\n    fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Method::GET =\u003e \"GET\",\n            Method::POST =\u003e \"POST\",\n            Method::PUT =\u003e \"PUT\",\n            Method::DELETE =\u003e \"DELETE\",\n            Method::PATCH =\u003e \"PATCH\",\n            Method::OPTIONS =\u003e \"OPTIONS\",\n        }\n    }\n}\n\n/// Fetch options (alias for FetchBuilder)\npub type FetchOptions = FetchBuilder;\n\n/// Fetch builder\n#[derive(Debug, Clone)]\npub struct FetchBuilder {\n    pub url: String,\n    pub method: Method,\n    pub headers: HashMap\u003cString, String\u003e,\n    pub body: Option\u003cString\u003e,\n    pub credentials: Option\u003cweb_sys::RequestCredentials\u003e,\n}\n\nimpl FetchBuilder {\n    pub fn new(url: impl Into\u003cString\u003e) -\u003e Self {\n        FetchBuilder {\n            url: url.into(),\n            method: Method::GET,\n            headers: HashMap::new(),\n            body: None,\n            credentials: None,\n        }\n    }\n\n    pub fn method(mut self, method: Method) -\u003e Self {\n        self.method = method;\n        self\n    }\n\n    pub fn header(mut self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) -\u003e Self {\n        self.headers.insert(key.into(), value.into());\n        self\n    }\n\n    pub fn json\u003cT: Serialize\u003e(mut self, data: \u0026T) -\u003e Result\u003cSelf, JsValue\u003e {\n        self.headers\n            .insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n        self.body =\n            Some(serde_json::to_string(data).map_err(|e| JsValue::from_str(\u0026e.to_string()))?);\n        Ok(self)\n    }\n\n    pub fn bearer_token(mut self, token: impl Into\u003cString\u003e) -\u003e Self {\n        self.headers.insert(\n            \"Authorization\".to_string(),\n            format!(\"Bearer {}\", token.into()),\n        );\n        self\n    }\n\n    pub fn credentials(mut self, creds: web_sys::RequestCredentials) -\u003e Self {\n        self.credentials = Some(creds);\n        self\n    }\n\n    pub async fn send(self) -\u003e Result\u003cFetchResponse, FetchError\u003e {\n        let opts = RequestInit::new();\n        opts.set_method(self.method.as_str());\n\n        // Set headers\n        let headers = web_sys::Headers::new()?;\n        for (key, value) in self.headers {\n            headers.set(\u0026key, \u0026value)?;\n        }\n        opts.set_headers(\u0026headers.into());\n\n        // Set body\n        if let Some(body) = self.body {\n            opts.set_body(\u0026JsValue::from_str(\u0026body));\n        }\n\n        // Set credentials\n        if let Some(creds) = self.credentials {\n            opts.set_credentials(creds);\n        }\n\n        // Create request\n        let request = Request::new_with_str_and_init(\u0026self.url, \u0026opts)?;\n\n        // Perform fetch\n        let window = web_sys::window().ok_or_else(|| JsValue::from_str(\"No window\"))?;\n        let response_value = JsFuture::from(window.fetch_with_request(\u0026request)).await?;\n        let response: Response = response_value.dyn_into()?;\n\n        Ok(FetchResponse::new(response))\n    }\n}\n\n/// Fetch response wrapper\npub struct FetchResponse {\n    response: Response,\n}\n\nimpl FetchResponse {\n    fn new(response: Response) -\u003e Self {\n        FetchResponse { response }\n    }\n\n    pub fn from_web_sys(response: Response) -\u003e Self {\n        FetchResponse { response }\n    }\n\n    pub fn ok(\u0026self) -\u003e bool {\n        self.response.ok()\n    }\n\n    pub fn status(\u0026self) -\u003e u16 {\n        self.response.status()\n    }\n\n    pub fn status_text(\u0026self) -\u003e String {\n        self.response.status_text()\n    }\n\n    pub async fn text(self) -\u003e Result\u003cString, FetchError\u003e {\n        let text = JsFuture::from(self.response.text()?)\n            .await?\n            .as_string()\n            .ok_or_else(|| JsValue::from_str(\"Failed to get text\"))?;\n        Ok(text)\n    }\n\n    pub async fn json\u003cT: for\u003c'de\u003e Deserialize\u003c'de\u003e\u003e(self) -\u003e Result\u003cT, FetchError\u003e {\n        let json = JsFuture::from(self.response.json()?).await?;\n        let data = serde_wasm_bindgen::from_value(json)?;\n        Ok(data)\n    }\n\n    pub async fn blob(self) -\u003e Result\u003cweb_sys::Blob, FetchError\u003e {\n        let blob = JsFuture::from(self.response.blob()?).await?.dyn_into()?;\n        Ok(blob)\n    }\n}\n\n/// Fetch error type\n#[derive(Debug)]\npub struct FetchError {\n    message: String,\n}\n\nimpl std::fmt::Display for FetchError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(f, \"{}\", self.message)\n    }\n}\n\nimpl std::error::Error for FetchError {}\n\nimpl From\u003cJsValue\u003e for FetchError {\n    fn from(value: JsValue) -\u003e Self {\n        FetchError {\n            message: format!(\"{:?}\", value),\n        }\n    }\n}\n\nimpl From\u003cserde_wasm_bindgen::Error\u003e for FetchError {\n    fn from(err: serde_wasm_bindgen::Error) -\u003e Self {\n        FetchError {\n            message: err.to_string(),\n        }\n    }\n}\n\n/// Convenience function for GET requests\npub async fn get(url: impl Into\u003cString\u003e) -\u003e Result\u003cFetchResponse, FetchError\u003e {\n    FetchBuilder::new(url).send().await\n}\n\n/// Convenience function for POST requests\npub async fn post\u003cT: Serialize\u003e(\n    url: impl Into\u003cString\u003e,\n    data: \u0026T,\n) -\u003e Result\u003cFetchResponse, FetchError\u003e {\n    FetchBuilder::new(url)\n        .method(Method::POST)\n        .json(data)?\n        .send()\n        .await\n}\n\n/// Generic fetch function\npub async fn fetch(\n    url: impl Into\u003cString\u003e,\n    options: Option\u003cFetchOptions\u003e,\n) -\u003e Result\u003cFetchResponse, FetchError\u003e {\n    match options {\n        Some(opts) =\u003e opts.send().await,\n        None =\u003e FetchBuilder::new(url).send().await,\n    }\n}\n\n/// SWR-like data fetching hook\npub struct SWR\u003cT\u003e {\n    data: Option\u003cT\u003e,\n    error: Option\u003cString\u003e,\n    loading: bool,\n    mutate: Box\u003cdyn Fn()\u003e,\n}\n\nimpl\u003cT: Clone + for\u003c'de\u003e Deserialize\u003c'de\u003e + 'static\u003e SWR\u003cT\u003e {\n    pub fn new(url: impl Into\u003cString\u003e) -\u003e Self {\n        let url = url.into();\n        let data = use_state(|| None::\u003cT\u003e);\n        let error = use_state(|| None::\u003cString\u003e);\n        let loading = use_state(|| true);\n\n        // Fetch on mount\n        let url_clone = url.clone();\n        let data_clone = data.clone();\n        let error_clone = error.clone();\n        let loading_clone = loading.clone();\n\n        spawn_local(async move {\n            loading_clone.set(true);\n            match get(\u0026url_clone).await {\n                Ok(response) =\u003e {\n                    if response.ok() {\n                        match response.json::\u003cT\u003e().await {\n                            Ok(json_data) =\u003e {\n                                data_clone.set(Some(json_data));\n                                error_clone.set(None);\n                            }\n                            Err(e) =\u003e {\n                                error_clone.set(Some(e.message));\n                            }\n                        }\n                    } else {\n                        error_clone.set(Some(format!(\"HTTP {}\", response.status())));\n                    }\n                }\n                Err(e) =\u003e {\n                    error_clone.set(Some(e.message));\n                }\n            }\n            loading_clone.set(false);\n        });\n\n        // Mutate function\n        let mutate = {\n            let url = url.clone();\n            let data = data.clone();\n            let error = error.clone();\n            let loading = loading.clone();\n\n            Box::new(move || {\n                let url = url.clone();\n                let data = data.clone();\n                let error = error.clone();\n                let loading = loading.clone();\n\n                spawn_local(async move {\n                    loading.set(true);\n                    match get(\u0026url).await {\n                        Ok(response) =\u003e {\n                            if response.ok() {\n                                match response.json::\u003cT\u003e().await {\n                                    Ok(json_data) =\u003e {\n                                        data.set(Some(json_data));\n                                        error.set(None);\n                                    }\n                                    Err(e) =\u003e {\n                                        error.set(Some(e.message));\n                                    }\n                                }\n                            } else {\n                                error.set(Some(format!(\"HTTP {}\", response.status())));\n                            }\n                        }\n                        Err(e) =\u003e {\n                            error.set(Some(e.message));\n                        }\n                    }\n                    loading.set(false);\n                });\n            })\n        };\n\n        SWR {\n            data: data.get(),\n            error: error.get(),\n            loading: loading.get(),\n            mutate,\n        }\n    }\n\n    pub fn data(\u0026self) -\u003e Option\u003c\u0026T\u003e {\n        self.data.as_ref()\n    }\n\n    pub fn error(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        self.error.as_deref()\n    }\n\n    pub fn is_loading(\u0026self) -\u003e bool {\n        self.loading\n    }\n\n    pub fn mutate(\u0026self) {\n        (self.mutate)();\n    }\n}\n\n// Re-exports\nuse crate::component::use_state;\nuse wasm_bindgen_futures::spawn_local;\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":139},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","form.rs"],"content":"//! Form Handling with Validation - L5/L6\n\nuse crate::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::future::Future;\nuse std::pin::Pin;\nuse std::rc::Rc;\n\n// Re-export form traits\npub use crate::form_traits::{FormFields, StringFormFields};\n\n// Type aliases to simplify complex types\ntype ValidationFn\u003cT\u003e = Box\u003cdyn Fn(\u0026T) -\u003e HashMap\u003cString, Vec\u003cString\u003e\u003e\u003e;\ntype SubmitFn\u003cT\u003e = Box\u003cdyn Fn(\u0026T) -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003c(), String\u003e\u003e + 'static\u003e\u003e\u003e;\ntype ValidatorFn = Box\u003cdyn Fn(\u0026str) -\u003e Option\u003cString\u003e\u003e;\n\n/// Form state\n#[derive(Clone)]\npub struct FormState\u003cT\u003e {\n    pub values: T,\n    pub errors: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n    pub touched: HashMap\u003cString, bool\u003e,\n    pub submitting: bool,\n    pub submitted: bool,\n}\n\n/// Form configuration\npub struct FormConfig\u003cT\u003e {\n    pub initial_values: T,\n    pub validate: Option\u003cValidationFn\u003cT\u003e\u003e,\n    pub on_submit: SubmitFn\u003cT\u003e,\n}\n\n/// Form hook\npub fn use_form\u003cT: Clone + Default + 'static\u003e(config: FormConfig\u003cT\u003e) -\u003e Form\u003cT\u003e {\n    let initial_values = config.initial_values.clone();\n    let state = Rc::new(RefCell::new(FormState {\n        values: initial_values,\n        errors: HashMap::new(),\n        touched: HashMap::new(),\n        submitting: false,\n        submitted: false,\n    }));\n\n    Form {\n        state: state.clone(),\n        config: Rc::new(config),\n    }\n}\n\n/// Form handle\n#[derive(Clone)]\npub struct Form\u003cT\u003e {\n    state: Rc\u003cRefCell\u003cFormState\u003cT\u003e\u003e\u003e,\n    config: Rc\u003cFormConfig\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e Form\u003cT\u003e {\n    pub fn values(\u0026self) -\u003e T {\n        self.state.borrow().values.clone()\n    }\n\n    pub fn errors(\u0026self) -\u003e HashMap\u003cString, Vec\u003cString\u003e\u003e {\n        self.state.borrow().errors.clone()\n    }\n\n    pub fn is_valid(\u0026self) -\u003e bool {\n        self.state.borrow().errors.is_empty()\n    }\n\n    pub fn is_submitting(\u0026self) -\u003e bool {\n        self.state.borrow().submitting\n    }\n\n    pub fn set_field_value(\u0026self, field: \u0026str, value: impl Into\u003cString\u003e) \n    where \n        T: FormFields\n    {\n        let value_string = value.into();\n        let mut state = self.state.borrow_mut();\n        \n        // Update the field value\n        if let Err(e) = state.values.set_field(field, value_string) {\n            // If setting fails, add to errors\n            state.errors.entry(field.to_string())\n                .or_default()\n                .push(e);\n        } else {\n            // Clear any previous errors for this field\n            state.errors.remove(field);\n            \n            // Run validation if configured\n            drop(state); // Release borrow before validate\n            self.validate();\n        }\n    }\n\n    pub fn set_field_touched(\u0026self, field: \u0026str, touched: bool) {\n        self.state\n            .borrow_mut()\n            .touched\n            .insert(field.to_string(), touched);\n    }\n\n    pub fn validate(\u0026self) {\n        if let Some(validate_fn) = \u0026self.config.validate {\n            let errors = validate_fn(\u0026self.state.borrow().values);\n            self.state.borrow_mut().errors = errors;\n        }\n    }\n\n    pub fn handle_submit(\u0026self) -\u003e impl Fn() {\n        let state = self.state.clone();\n        let config = self.config.clone();\n\n        move || {\n            let mut state_mut = state.borrow_mut();\n            state_mut.submitting = true;\n            state_mut.submitted = true;\n\n            // Validate all fields\n            if let Some(validate_fn) = \u0026config.validate {\n                state_mut.errors = validate_fn(\u0026state_mut.values);\n            }\n\n            if state_mut.errors.is_empty() {\n                // Submit form\n                let values = state_mut.values.clone();\n                let state_clone = state.clone();\n                let config = config.clone();\n\n                spawn_local(async move {\n                    match (config.on_submit)(\u0026values).await {\n                        Ok(_) =\u003e {\n                            state_clone.borrow_mut().submitting = false;\n                        }\n                        Err(error) =\u003e {\n                            state_clone.borrow_mut().submitting = false;\n                            state_clone\n                                .borrow_mut()\n                                .errors\n                                .insert(\"_form\".to_string(), vec![error]);\n                        }\n                    }\n                });\n            } else {\n                state_mut.submitting = false;\n            }\n        }\n    }\n\n    pub fn reset(\u0026self) {\n        *self.state.borrow_mut() = FormState {\n            values: self.config.initial_values.clone(),\n            errors: HashMap::new(),\n            touched: HashMap::new(),\n            submitting: false,\n            submitted: false,\n        };\n    }\n}\n\n/// Validation rules\npub mod validators {\n    use super::ValidatorFn;\n\n    pub fn required(value: \u0026str) -\u003e Option\u003cString\u003e {\n        if value.trim().is_empty() {\n            Some(\"This field is required\".to_string())\n        } else {\n            None\n        }\n    }\n\n    pub fn email(value: \u0026str) -\u003e Option\u003cString\u003e {\n        let email_regex = regex::Regex::new(r\"^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$\").unwrap();\n        if !email_regex.is_match(value) {\n            Some(\"Invalid email address\".to_string())\n        } else {\n            None\n        }\n    }\n\n    pub fn min_length(min: usize) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        move |value: \u0026str| {\n            if value.len() \u003c min {\n                Some(format!(\"Must be at least {} characters\", min))\n            } else {\n                None\n            }\n        }\n    }\n\n    pub fn max_length(max: usize) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        move |value: \u0026str| {\n            if value.len() \u003e max {\n                Some(format!(\"Must be at most {} characters\", max))\n            } else {\n                None\n            }\n        }\n    }\n\n    pub fn pattern(regex: \u0026'static str, message: \u0026'static str) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        move |value: \u0026str| {\n            let re = regex::Regex::new(regex).unwrap();\n            if !re.is_match(value) {\n                Some(message.to_string())\n            } else {\n                None\n            }\n        }\n    }\n\n    pub fn compose(validators: Vec\u003cValidatorFn\u003e) -\u003e impl Fn(\u0026str) -\u003e Vec\u003cString\u003e {\n        move |value: \u0026str| {\n            validators\n                .iter()\n                .filter_map(|validator| validator(value))\n                .collect()\n        }\n    }\n}\n\n/// Form field components\npub struct TextField\u003cT\u003e {\n    name: String,\n    label: String,\n    placeholder: Option\u003cString\u003e,\n    form: Option\u003cForm\u003cT\u003e\u003e,\n    value: String,\n    error: Option\u003cString\u003e,\n}\n\nimpl\u003cT: Clone + FormFields + 'static\u003e TextField\u003cT\u003e {\n    pub fn new(name: impl Into\u003cString\u003e, label: impl Into\u003cString\u003e) -\u003e Self {\n        TextField {\n            name: name.into(),\n            label: label.into(),\n            placeholder: None,\n            form: None,\n            value: String::new(),\n            error: None,\n        }\n    }\n\n    pub fn placeholder(mut self, placeholder: impl Into\u003cString\u003e) -\u003e Self {\n        self.placeholder = Some(placeholder.into());\n        self\n    }\n\n    pub fn bind(mut self, form: \u0026Form\u003cT\u003e) -\u003e Self {\n        self.form = Some(form.clone());\n        // Get initial value from form\n        if let Some(value) = form.values().get_field(\u0026self.name) {\n            self.value = value;\n        }\n        // Get any errors\n        if let Some(errors) = form.errors().get(\u0026self.name) {\n            self.error = errors.first().cloned();\n        }\n        self\n    }\n}\n\nimpl\u003cT: Clone + FormFields + 'static\u003e Component for TextField\u003cT\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let form_clone = self.form.clone();\n        let field_name = self.name.clone();\n        \n        let on_change = form_clone.map(|form| Rc::new(move |value: String| {\n            form.set_field_value(\u0026field_name, value);\n            form.set_field_touched(\u0026field_name, true);\n        }) as Rc\u003cdyn Fn(String)\u003e);\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"form-field\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"label\".to_string(),\n                    props: Props {\n                        attributes: vec![(\"for\".to_string(), self.name.clone())],\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(self.label.clone())],\n                },\n                Element::Node {\n                    tag: \"input\".to_string(),\n                    props: Props {\n                        class: Some(\"form-input\".to_string()),\n                        attributes: vec![\n                            (\"type\".to_string(), \"text\".to_string()),\n                            (\"id\".to_string(), self.name.clone()),\n                            (\"name\".to_string(), self.name.clone()),\n                            (\"value\".to_string(), self.value.clone()),\n                            (\n                                \"placeholder\".to_string(),\n                                self.placeholder.as_deref().unwrap_or(\"\").to_string(),\n                            ),\n                        ],\n                        on_change,\n                        ..Default::default()\n                    },\n                    children: vec![],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"form-error\".to_string()),\n                        ..Default::default()\n                    },\n                    children: if let Some(error) = \u0026self.error {\n                        vec![Element::Text(error.clone())]\n                    } else {\n                        vec![]\n                    },\n                },\n            ],\n        }\n    }\n}\n\n/// Form field trait\n#[allow(dead_code)]\ntrait FormField {\n    fn get_value(\u0026self) -\u003e String;\n    fn set_value(\u0026mut self, value: String);\n    fn get_errors(\u0026self) -\u003e Vec\u003cString\u003e;\n}\n\n#[allow(dead_code)]\nstruct EmptyFormField;\nimpl FormField for EmptyFormField {\n    fn get_value(\u0026self) -\u003e String {\n        String::new()\n    }\n    fn set_value(\u0026mut self, _value: String) {}\n    fn get_errors(\u0026self) -\u003e Vec\u003cString\u003e {\n        vec![]\n    }\n}\n\n/// Server actions\n#[derive(Serialize, Deserialize)]\npub struct ServerAction\u003cT, R\u003e {\n    pub action: String,\n    pub data: T,\n    _phantom: std::marker::PhantomData\u003cR\u003e,\n}\n\nimpl\u003cT: Serialize, R: for\u003c'de\u003e Deserialize\u003c'de\u003e\u003e ServerAction\u003cT, R\u003e {\n    pub fn new(action: impl Into\u003cString\u003e, data: T) -\u003e Self {\n        ServerAction {\n            action: action.into(),\n            data,\n            _phantom: std::marker::PhantomData,\n        }\n    }\n\n    pub async fn execute(\u0026self) -\u003e Result\u003cR, String\u003e {\n        let response = post(\"/api/actions\", \u0026self)\n            .await\n            .map_err(|e| format!(\"Network error: {:?}\", e))?;\n\n        if response.ok() {\n            response\n                .json()\n                .await\n                .map_err(|e| format!(\"Parse error: {:?}\", e))\n        } else {\n            Err(format!(\"Server error: {}\", response.status()))\n        }\n    }\n}\n\n/// Form component with all fields\npub struct FormComponent\u003cT\u003e {\n    form: Form\u003cT\u003e,\n    children: Vec\u003cElement\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e FormComponent\u003cT\u003e {\n    pub fn new(form: Form\u003cT\u003e) -\u003e Self {\n        FormComponent {\n            form,\n            children: vec![],\n        }\n    }\n\n    pub fn children(mut self, children: Vec\u003cElement\u003e) -\u003e Self {\n        self.children = children;\n        self\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e Component for FormComponent\u003cT\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let on_submit = self.form.handle_submit();\n\n        Element::Node {\n            tag: \"form\".to_string(),\n            props: Props {\n                on_submit: Some(Rc::new(move |_event| {\n                    on_submit();\n                })),\n                ..Default::default()\n            },\n            children: self.children.clone(),\n        }\n    }\n}\n\n// Re-exports\nuse crate::fetch::post;\nuse wasm_bindgen_futures::spawn_local;\n","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":146},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","form_builder.rs"],"content":"//! Form builder utilities for easier form creation\n\nuse crate::form::{Form, FormConfig, FormFields};\nuse std::collections::HashMap;\n\ntype ValidatorFn = Box\u003cdyn Fn(\u0026str) -\u003e Option\u003cString\u003e\u003e;\ntype ValidatorsMap = HashMap\u003cString, Vec\u003cValidatorFn\u003e\u003e;\n\n/// Fluent form builder\npub struct FormBuilder\u003cT\u003e {\n    initial_values: T,\n    validators: ValidatorsMap,\n}\n\nimpl\u003cT: Clone + Default + 'static\u003e Default for FormBuilder\u003cT\u003e {\n    fn default() -\u003e Self {\n        Self {\n            initial_values: T::default(),\n            validators: HashMap::new(),\n        }\n    }\n}\n\nimpl\u003cT: Clone + Default + 'static\u003e FormBuilder\u003cT\u003e {\n    /// Create a new form builder\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n    \n    /// Set initial values\n    pub fn with_initial_values(mut self, values: T) -\u003e Self {\n        self.initial_values = values;\n        self\n    }\n    \n    /// Add a field validator\n    pub fn add_validator\u003cF\u003e(mut self, field: \u0026str, validator: F) -\u003e Self \n    where \n        F: Fn(\u0026str) -\u003e Option\u003cString\u003e + 'static\n    {\n        self.validators.entry(field.to_string())\n            .or_default()\n            .push(Box::new(validator));\n        self\n    }\n    \n    /// Build the form\n    pub fn build\u003cF\u003e(self, on_submit: F) -\u003e Form\u003cT\u003e\n    where\n        F: Fn(\u0026T) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c(), String\u003e\u003e + 'static\u003e\u003e + 'static,\n        T: FormFields,\n    {\n        let validators = self.validators;\n        \n        let validate = move |values: \u0026T| -\u003e HashMap\u003cString, Vec\u003cString\u003e\u003e {\n            let mut errors = HashMap::new();\n            \n            for (field, field_validators) in \u0026validators {\n                if let Some(value) = values.get_field(field) {\n                    let field_errors: Vec\u003cString\u003e = field_validators\n                        .iter()\n                        .filter_map(|validator| validator(\u0026value))\n                        .collect();\n                    \n                    if !field_errors.is_empty() {\n                        errors.insert(field.clone(), field_errors);\n                    }\n                }\n            }\n            \n            errors\n        };\n        \n        crate::form::use_form(FormConfig {\n            initial_values: self.initial_values,\n            validate: Some(Box::new(validate)),\n            on_submit: Box::new(on_submit),\n        })\n    }\n}\n\n/// Common validators\npub mod validators {\n    /// Required field validator\n    pub fn required(message: \u0026str) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        let msg = message.to_string();\n        move |value: \u0026str| {\n            if value.trim().is_empty() {\n                Some(msg.clone())\n            } else {\n                None\n            }\n        }\n    }\n    \n    /// Email validator\n    pub fn email(message: \u0026str) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        let msg = message.to_string();\n        move |value: \u0026str| {\n            if value.contains('@') \u0026\u0026 value.contains('.') {\n                None\n            } else {\n                Some(msg.clone())\n            }\n        }\n    }\n    \n    /// Min length validator\n    pub fn min_length(length: usize, message: \u0026str) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        let msg = message.to_string();\n        move |value: \u0026str| {\n            if value.len() \u003e= length {\n                None\n            } else {\n                Some(msg.clone())\n            }\n        }\n    }\n    \n    /// Max length validator\n    pub fn max_length(length: usize, message: \u0026str) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        let msg = message.to_string();\n        move |value: \u0026str| {\n            if value.len() \u003c= length {\n                None\n            } else {\n                Some(msg.clone())\n            }\n        }\n    }\n    \n    /// Pattern validator\n    pub fn pattern(regex: \u0026str, message: \u0026str) -\u003e impl Fn(\u0026str) -\u003e Option\u003cString\u003e {\n        let msg = message.to_string();\n        let pattern = regex.to_string();\n        move |value: \u0026str| {\n            // Simplified pattern matching - in production use regex crate\n            if value.contains(\u0026pattern) {\n                None\n            } else {\n                Some(msg.clone())\n            }\n        }\n    }\n}","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":58},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","form_traits.rs"],"content":"//! Form field setter trait for dynamic field updates\n\n\n/// Trait for types that can have their fields updated dynamically\npub trait FormFields {\n    /// Set a field value by name\n    fn set_field(\u0026mut self, field: \u0026str, value: String) -\u003e Result\u003c(), String\u003e;\n    \n    /// Get a field value by name\n    fn get_field(\u0026self, field: \u0026str) -\u003e Option\u003cString\u003e;\n    \n    /// Get all field names\n    fn field_names(\u0026self) -\u003e Vec\u003c\u0026'static str\u003e;\n}\n\n/// Macro to implement FormFields for a struct\n#[macro_export]\nmacro_rules! impl_form_fields {\n    ($struct_name:ident { $($field:ident: $field_type:ty),* }) =\u003e {\n        impl FormFields for $struct_name {\n            fn set_field(\u0026mut self, field: \u0026str, value: String) -\u003e Result\u003c(), String\u003e {\n                match field {\n                    $(\n                        stringify!($field) =\u003e {\n                            self.$field = value.parse::\u003c$field_type\u003e()\n                                .map_err(|_| format!(\"Invalid value for field {}\", field))?;\n                            Ok(())\n                        }\n                    )*\n                    _ =\u003e Err(format!(\"Unknown field: {}\", field))\n                }\n            }\n            \n            fn get_field(\u0026self, field: \u0026str) -\u003e Option\u003cString\u003e {\n                match field {\n                    $(\n                        stringify!($field) =\u003e Some(self.$field.to_string()),\n                    )*\n                    _ =\u003e None\n                }\n            }\n            \n            fn field_names(\u0026self) -\u003e Vec\u003c\u0026'static str\u003e {\n                vec![$(stringify!($field)),*]\n            }\n        }\n    };\n}\n\n/// Helper for string fields that don't need parsing\npub trait StringFormFields {\n    fn set_string_field(\u0026mut self, field: \u0026str, value: String) -\u003e Result\u003c(), String\u003e;\n}\n\n#[macro_export]\nmacro_rules! impl_string_form_fields {\n    ($struct_name:ident { $($field:ident),* }) =\u003e {\n        impl StringFormFields for $struct_name {\n            fn set_string_field(\u0026mut self, field: \u0026str, value: String) -\u003e Result\u003c(), String\u003e {\n                match field {\n                    $(\n                        stringify!($field) =\u003e {\n                            self.$field = value;\n                            Ok(())\n                        }\n                    )*\n                    _ =\u003e Err(format!(\"Unknown field: {}\", field))\n                }\n            }\n        }\n    };\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","compat.rs"],"content":"//! Compatibility layer for migrating from old component system to HAF\n//! \n//! This module provides adapters and utilities to help migrate existing\n//! Layer9 components to the HAF architecture gradually.\n\nuse crate::component as old;\nuse crate::haf::component::*;\nuse crate::haf::layers::L1;\nuse crate::haf::Layer;\n\n/// Adapter to convert old Element to HAF VNode\npub fn element_to_vnode(element: \u0026old::Element) -\u003e VNode\u003cL1\u003e {\n    match element {\n        old::Element::Text(text) =\u003e VNode::Text(text.clone()),\n        old::Element::Node { tag, props, children } =\u003e {\n            VNode::Element {\n                tag: tag.clone(),\n                props: props_to_vprops(props),\n                children: children.iter().map(element_to_vnode).collect(),\n            }\n        }\n        old::Element::Component(_) =\u003e {\n            // For now, wrap old components as text\n            // In production, we'd need a proper adapter\n            VNode::Text(\"[Legacy Component]\".to_string())\n        }\n    }\n}\n\n/// Convert old Props to HAF VProps\nfn props_to_vprops(props: \u0026old::Props) -\u003e VProps {\n    let mut vprops = VProps {\n        class: props.class.clone(),\n        id: props.id.clone(),\n        attributes: props.attributes.clone(),\n        ..Default::default()\n    };\n    \n    // Events need to be registered separately in HAF\n    // This is just a placeholder\n    if props.on_click.is_some() {\n        vprops.events.push((\"click\".to_string(), EventId(1)));\n    }\n    if props.on_submit.is_some() {\n        vprops.events.push((\"submit\".to_string(), EventId(2)));\n    }\n    if props.on_change.is_some() {\n        vprops.events.push((\"change\".to_string(), EventId(3)));\n    }\n    if props.on_input.is_some() {\n        vprops.events.push((\"input\".to_string(), EventId(4)));\n    }\n    \n    vprops\n}\n\n/// Wrapper to use old components in HAF system\npub struct LegacyComponentWrapper\u003cC: old::Component\u003e {\n    component: C,\n}\n\nimpl\u003cC: old::Component\u003e PureComponent\u003cL1\u003e for LegacyComponentWrapper\u003cC\u003e {\n    type Props = ();\n    \n    fn render(\u0026self, _props: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n        let old_element = self.component.render();\n        element_to_vnode(\u0026old_element)\n    }\n}\n\n/// Bridge for using HAF components in old system\npub struct HafComponentBridge\u003cL: Layer\u003e {\n    vnode: VNode\u003cL\u003e,\n}\n\nimpl\u003cL: Layer\u003e HafComponentBridge\u003cL\u003e {\n    pub fn new(vnode: VNode\u003cL\u003e) -\u003e Self {\n        Self { vnode }\n    }\n}\n\nimpl\u003cL: Layer\u003e old::Component for HafComponentBridge\u003cL\u003e {\n    fn render(\u0026self) -\u003e old::Element {\n        vnode_to_element(\u0026self.vnode)\n    }\n}\n\n/// Convert HAF VNode to old Element\nfn vnode_to_element\u003cL: Layer\u003e(vnode: \u0026VNode\u003cL\u003e) -\u003e old::Element {\n    match vnode {\n        VNode::Text(text) =\u003e old::Element::Text(text.clone()),\n        VNode::Element { tag, props, children } =\u003e {\n            old::Element::Node {\n                tag: tag.clone(),\n                props: vprops_to_props(props),\n                children: children.iter().map(vnode_to_element).collect(),\n            }\n        }\n        VNode::Component { .. } =\u003e {\n            // Placeholder for component conversion\n            old::Element::Text(\"[HAF Component]\".to_string())\n        }\n        VNode::Fragment(children) =\u003e {\n            // Old system doesn't have fragments, wrap in div\n            old::Element::Node {\n                tag: \"div\".to_string(),\n                props: old::Props::default(),\n                children: children.iter().map(vnode_to_element).collect(),\n            }\n        }\n        _ =\u003e old::Element::Text(\"\".to_string()),\n    }\n}\n\n/// Convert HAF VProps to old Props\nfn vprops_to_props(vprops: \u0026VProps) -\u003e old::Props {\n    old::Props {\n        class: vprops.class.clone(),\n        id: vprops.id.clone(),\n        attributes: vprops.attributes.clone(),\n        // Events would need proper handling with closures\n        on_click: None,\n        on_submit: None,\n        on_change: None,\n        on_input: None,\n    }\n}\n\n/// Migration helper macros\n#[macro_export]\nmacro_rules! migrate_component {\n    ($old_component:ty) =\u003e {\n        impl $crate::haf::component::PureComponent\u003c$crate::haf::L1\u003e for $old_component {\n            type Props = ();\n            \n            fn render(\u0026self, _props: \u0026Self::Props) -\u003e $crate::haf::component::VNode\u003c$crate::haf::L1\u003e {\n                let old_element = \u003cSelf as $crate::component::Component\u003e::render(self);\n                $crate::haf::compat::element_to_vnode(\u0026old_element)\n            }\n        }\n    };\n}\n\n/// Feature flag for HAF components\n#[cfg(feature = \"haf\")]\npub use crate::haf::component as component;\n\n#[cfg(not(feature = \"haf\"))]\npub use crate::component;\n\n/// Example migration path\n#[cfg(test)]\n#[allow(dead_code)]\nmod compat_tests {\n    use super::*;\n    use crate::component::Component;\n    \n    struct OldButton {\n        label: String,\n    }\n    \n    impl old::Component for OldButton {\n        fn render(\u0026self) -\u003e old::Element {\n            old::Element::Node {\n                tag: \"button\".to_string(),\n                props: old::Props {\n                    class: Some(\"btn\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![old::Element::Text(self.label.clone())],\n            }\n        }\n    }\n    \n    #[test]\n    fn test_old_to_haf_migration() {\n        let old_button = OldButton {\n            label: \"Click me\".to_string(),\n        };\n        \n        let old_element = old_button.render();\n        let haf_vnode = element_to_vnode(\u0026old_element);\n        \n        match haf_vnode {\n            VNode::Element { tag, .. } =\u003e {\n                assert_eq!(tag, \"button\");\n            }\n            _ =\u003e panic!(\"Expected Element VNode\"),\n        }\n    }\n}\n\n// Migration guide documentation\n// \n// # Migrating from Old Component System to HAF\n// \n// ## Step 1: Understand the Layers\n// - L1 (Core): Pure components with no side effects\n// - L2 (Runtime): Component lifecycle and state management\n// - L3 (Framework): DOM operations and event handling\n// \n// ## Step 2: Migrate Components\n// \n// ### Option A: Quick Migration with Wrapper\n// ```rust\n// migrate_component!(MyOldComponent);\n// ```\n// \n// ### Option B: Full HAF Rewrite\n// ```rust\n// haf_component! {\n//     pub struct MyComponent {\n//         props: MyProps,\n//     }\n//     \n//     impl render {\n//         VNode::Element {\n//             tag: \"div\".to_string(),\n//             props: VProps::default(),\n//             children: vec![],\n//         }\n//     }\n// }\n// ```\n// \n// ## Step 3: Enable HAF Features\n// Add to Cargo.toml:\n// ```toml\n// [features]\n// haf-components = []\n// ```\n// \n// ## Step 4: Gradual Migration\n// 1. Start with leaf components (no children)\n// 2. Move up the component tree\n// 3. Migrate state management last\n// 4. Finally switch feature flag","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":2}},{"line":13,"address":[],"length":0,"stats":{"Line":2}},{"line":14,"address":[],"length":0,"stats":{"Line":1}},{"line":15,"address":[],"length":0,"stats":{"Line":1}},{"line":17,"address":[],"length":0,"stats":{"Line":1}},{"line":18,"address":[],"length":0,"stats":{"Line":1}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}}],"covered":16,"coverable":45},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","component.rs"],"content":"//! HAF-compliant Component System\n//! \n//! This module provides a layered component architecture following HAF principles:\n//! - L1: Pure component definitions and virtual DOM\n//! - L2: Component runtime and lifecycle management\n//! - L3: Framework API and DOM bindings\n\nuse crate::haf::{layers::{L1, L2, L3}, Layer, Contract};\nuse std::any::Any;\nuse std::marker::PhantomData;\n\n// ==================== L1: Pure Component Layer ====================\n\n/// Pure virtual DOM element (L1)\n#[derive(Debug)]\npub enum VNode\u003cL: Layer\u003e {\n    Text(String),\n    Element {\n        tag: String,\n        props: VProps,\n        children: Vec\u003cVNode\u003cL\u003e\u003e,\n    },\n    Component {\n        key: Option\u003cString\u003e,\n        props: Box\u003cdyn Any\u003e,\n        render: fn(\u0026dyn Any) -\u003e VNode\u003cL\u003e,\n    },\n    Fragment(Vec\u003cVNode\u003cL\u003e\u003e),\n    _Layer(PhantomData\u003cL\u003e),\n}\n\nimpl\u003cL: Layer\u003e Clone for VNode\u003cL\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        match self {\n            VNode::Text(s) =\u003e VNode::Text(s.clone()),\n            VNode::Element { tag, props, children } =\u003e VNode::Element {\n                tag: tag.clone(),\n                props: props.clone(),\n                children: children.clone(),\n            },\n            VNode::Component { key, props: _, render } =\u003e {\n                // Can't clone Box\u003cdyn Any\u003e, so we just create a placeholder\n                // In real usage, components should be handled differently\n                VNode::Component {\n                    key: key.clone(),\n                    props: Box::new(()),\n                    render: *render,\n                }\n            }\n            VNode::Fragment(children) =\u003e VNode::Fragment(children.clone()),\n            VNode::_Layer(p) =\u003e VNode::_Layer(*p),\n        }\n    }\n}\n\nimpl\u003cL: Layer\u003e PartialEq for VNode\u003cL\u003e {\n    fn eq(\u0026self, other: \u0026Self) -\u003e bool {\n        match (self, other) {\n            (VNode::Text(a), VNode::Text(b)) =\u003e a == b,\n            (VNode::Element { tag: tag_a, props: props_a, children: children_a },\n             VNode::Element { tag: tag_b, props: props_b, children: children_b }) =\u003e {\n                tag_a == tag_b \u0026\u0026 props_a == props_b \u0026\u0026 children_a == children_b\n            }\n            (VNode::Component { key: key_a, .. }, VNode::Component { key: key_b, .. }) =\u003e {\n                key_a == key_b\n            }\n            (VNode::Fragment(a), VNode::Fragment(b)) =\u003e a == b,\n            (VNode::_Layer(_), VNode::_Layer(_)) =\u003e true,\n            _ =\u003e false,\n        }\n    }\n}\n\n/// Pure component properties (L1)\n#[derive(Debug, Clone, PartialEq, Default)]\npub struct VProps {\n    pub key: Option\u003cString\u003e,\n    pub class: Option\u003cString\u003e,\n    pub id: Option\u003cString\u003e,\n    pub style: Option\u003cString\u003e,\n    pub attributes: Vec\u003c(String, String)\u003e,\n    pub events: Vec\u003c(String, EventId)\u003e,\n}\n\n/// Event identifier for pure representation (L1)\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub struct EventId(pub u64);\n\n/// Pure component trait (L1)\npub trait PureComponent\u003cL: Layer\u003e: 'static {\n    type Props: Clone + 'static;\n    \n    fn render(\u0026self, props: \u0026Self::Props) -\u003e VNode\u003cL\u003e;\n}\n\n/// Component definition (L1)\npub struct ComponentDef\u003cL: Layer, C: PureComponent\u003cL\u003e\u003e {\n    _layer: PhantomData\u003cL\u003e,\n    _component: PhantomData\u003cC\u003e,\n}\n\nimpl\u003cC: PureComponent\u003cL1\u003e + Default\u003e Default for ComponentDef\u003cL1, C\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl\u003cC: PureComponent\u003cL1\u003e + Default\u003e ComponentDef\u003cL1, C\u003e {\n    pub fn new() -\u003e Self {\n        Self {\n            _layer: PhantomData,\n            _component: PhantomData,\n        }\n    }\n    \n    pub fn create(\u0026self, props: C::Props) -\u003e VNode\u003cL1\u003e {\n        VNode::Component {\n            key: None,\n            props: Box::new(props.clone()),\n            render: |any_props| {\n                let props = any_props.downcast_ref::\u003cC::Props\u003e().unwrap();\n                let component = C::default();\n                component.render(props)\n            },\n        }\n    }\n}\n\n// ==================== L2: Component Runtime Layer ====================\n\n/// Component instance with runtime state (L2)\npub struct ComponentInstance\u003cL: Layer\u003e {\n    pub vnode: VNode\u003cL\u003e,\n    pub state: ComponentState,\n    pub hooks: Vec\u003cBox\u003cdyn Any\u003e\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\n/// Runtime component state (L2)\n#[derive(Debug, Clone)]\npub struct ComponentState {\n    pub mounted: bool,\n    pub needs_update: bool,\n    pub generation: u32,\n}\n\n/// Effect hook for side effects (L2)\npub struct Effect\u003cL: Layer\u003e {\n    pub id: u64,\n    pub deps: Vec\u003cBox\u003cdyn Any\u003e\u003e,\n    pub cleanup: Option\u003cBox\u003cdyn FnOnce()\u003e\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\n/// Component lifecycle trait (L2)\npub trait ComponentLifecycle\u003cL: Layer\u003e {\n    fn mount(\u0026mut self);\n    fn update(\u0026mut self);\n    fn unmount(\u0026mut self);\n}\n\n/// Runtime for managing components (L2)\npub struct ComponentRuntime\u003cL: Layer\u003e {\n    instances: Vec\u003cComponentInstance\u003cL\u003e\u003e,\n    #[allow(dead_code)]\n    effects: Vec\u003cEffect\u003cL\u003e\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for ComponentRuntime\u003cL2\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ComponentRuntime\u003cL2\u003e {\n    pub fn new() -\u003e Self {\n        Self {\n            instances: Vec::new(),\n            effects: Vec::new(),\n            _layer: PhantomData,\n        }\n    }\n    \n    pub fn mount_component(\u0026mut self, vnode: VNode\u003cL1\u003e) -\u003e Contract\u003cVNode\u003cL1\u003e, usize\u003e {\n        let instance = ComponentInstance {\n            vnode: self.transform_vnode(vnode.clone()),\n            state: ComponentState {\n                mounted: false,\n                needs_update: false,\n                generation: 0,\n            },\n            hooks: Vec::new(),\n            _layer: PhantomData,\n        };\n        \n        self.instances.push(instance);\n        \n        // Return the index instead of cloning the instance\n        Contract::new(vnode, self.instances.len() - 1)\n    }\n    \n    fn transform_vnode(\u0026self, vnode: VNode\u003cL1\u003e) -\u003e VNode\u003cL2\u003e {\n        // Transform L1 VNode to L2 VNode with runtime capabilities\n        // Since VNode is parametrized by Layer, we need a different approach\n        // For now, we'll use a simple transformation\n        match vnode {\n            VNode::Text(text) =\u003e VNode::Text(text),\n            VNode::Element { tag, props, children: _ } =\u003e VNode::Element {\n                tag,\n                props,\n                children: vec![], // TODO: Implement proper child transformation\n            },\n            VNode::Component { key, props, .. } =\u003e VNode::Component {\n                key,\n                props,\n                render: |_| VNode::Text(\"Component\".to_string()), // Placeholder\n            },\n            VNode::Fragment(_) =\u003e VNode::Fragment(vec![]),\n            VNode::_Layer(_) =\u003e VNode::_Layer(PhantomData),\n        }\n    }\n}\n\n// ==================== L3: Framework API Layer ====================\n\n/// DOM operations contract (L3)\npub struct DomOps\u003cL: Layer\u003e {\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl DomOps\u003cL3\u003e {\n    pub fn create_element(tag: \u0026str) -\u003e web_sys::Element {\n        web_sys::window()\n            .unwrap()\n            .document()\n            .unwrap()\n            .create_element(tag)\n            .unwrap()\n    }\n    \n    pub fn set_text_content(element: \u0026web_sys::Element, text: \u0026str) {\n        element.set_text_content(Some(text));\n    }\n    \n    pub fn add_event_listener(\n        element: \u0026web_sys::Element,\n        event: \u0026str,\n        handler: Box\u003cdyn Fn(web_sys::Event)\u003e,\n    ) {\n        use wasm_bindgen::closure::Closure;\n        use wasm_bindgen::JsCast;\n        \n        let closure = Closure::wrap(handler as Box\u003cdyn Fn(_)\u003e);\n        element\n            .add_event_listener_with_callback(event, closure.as_ref().unchecked_ref())\n            .unwrap();\n        closure.forget();\n    }\n}\n\n/// Component mount point (L3)\npub struct ComponentApp\u003cL: Layer\u003e {\n    runtime: Contract\u003cComponentRuntime\u003cL2\u003e, Box\u003cdyn Any\u003e\u003e,\n    root: Option\u003cweb_sys::Element\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for ComponentApp\u003cL3\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ComponentApp\u003cL3\u003e {\n    pub fn new() -\u003e Self {\n        let runtime = ComponentRuntime::new();\n        Self {\n            runtime: Contract::new(runtime, Box::new(()) as Box\u003cdyn Any\u003e),\n            root: None,\n            _layer: PhantomData,\n        }\n    }\n    \n    pub fn mount(\u0026mut self, selector: \u0026str, vnode: VNode\u003cL1\u003e) {\n        let document = web_sys::window().unwrap().document().unwrap();\n        let root = document.query_selector(selector).unwrap().unwrap();\n        \n        // Mount component through runtime\n        let contract = self.runtime.input.mount_component(vnode.clone());\n        let _instance_index = contract.output;\n        \n        // Render to DOM\n        self.render_to_dom(\u0026root, \u0026vnode);\n        \n        self.root = Some(root);\n    }\n    \n    fn render_to_dom(\u0026self, parent: \u0026web_sys::Element, vnode: \u0026VNode\u003cL1\u003e) {\n        self.render_to_dom_impl(parent, vnode);\n    }\n    \n    #[allow(clippy::only_used_in_recursion)]\n    fn render_to_dom_impl(\u0026self, parent: \u0026web_sys::Element, vnode: \u0026VNode\u003cL1\u003e) {\n        match vnode {\n            VNode::Text(text) =\u003e {\n                let text_node = web_sys::window()\n                    .unwrap()\n                    .document()\n                    .unwrap()\n                    .create_text_node(text);\n                parent.append_child(\u0026text_node).unwrap();\n            }\n            VNode::Element { tag, props, children } =\u003e {\n                let element = DomOps::\u003cL3\u003e::create_element(tag);\n                \n                // Apply properties\n                if let Some(class) = \u0026props.class {\n                    element.set_class_name(class);\n                }\n                if let Some(id) = \u0026props.id {\n                    element.set_id(id);\n                }\n                \n                // Apply attributes\n                for (key, value) in \u0026props.attributes {\n                    element.set_attribute(key, value).unwrap();\n                }\n                \n                // Render children\n                for child in children {\n                    self.render_to_dom_impl(\u0026element, child);\n                }\n                \n                parent.append_child(\u0026element).unwrap();\n            }\n            VNode::Component { render, props, .. } =\u003e {\n                let child_vnode = render(props.as_ref());\n                self.render_to_dom_impl(parent, \u0026child_vnode);\n            }\n            VNode::Fragment(children) =\u003e {\n                for child in children {\n                    self.render_to_dom_impl(parent, child);\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n}\n\n// ==================== HAF Component Macro ====================\n\n// Macro moved to haf/mod.rs to avoid duplicate definition\n\n// ==================== Example Usage ====================\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::rc::Rc;\n    \n    #[derive(Clone)]\n    struct ButtonProps {\n        label: String,\n        onclick: Option\u003cRc\u003cdyn Fn()\u003e\u003e,\n    }\n    \n    struct Button;\n    \n    impl Default for Button {\n        fn default() -\u003e Self {\n            Self\n        }\n    }\n    \n    impl PureComponent\u003cL1\u003e for Button {\n        type Props = ButtonProps;\n        \n        fn render(\u0026self, props: \u0026Self::Props) -\u003e VNode\u003cL1\u003e {\n            VNode::Element {\n                tag: \"button\".to_string(),\n                props: VProps {\n                    class: Some(\"btn\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    VNode::Text(props.label.clone())\n                ],\n            }\n        }\n    }\n    \n    #[test]\n    fn test_component_creation() {\n        let button_def = ComponentDef::\u003cL1, Button\u003e::new();\n        let vnode = button_def.create(ButtonProps {\n            label: \"Click me\".to_string(),\n            onclick: None,\n        });\n        \n        match vnode {\n            VNode::Component { .. } =\u003e {}\n            _ =\u003e panic!(\"Expected Component VNode\"),\n        }\n    }\n}","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":1}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}}],"covered":4,"coverable":90},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","contracts.rs"],"content":"//! HAF Translation Contracts\n//! \n//! Explicit contracts for data transformation between layers.\n//! These contracts make layer boundaries clear and testable.\n\nuse super::*;\n\n/// Contract for VNode to DOM operations (L1 → L2)\npub struct VNodeToDomContract;\n\n#[derive(Clone, Debug)]\npub enum DomOp {\n    CreateElement { tag: String, id: usize },\n    CreateText { text: String, id: usize },\n    SetAttribute { id: usize, name: String, value: String },\n    RemoveAttribute { id: usize, name: String },\n    AppendChild { parent: usize, child: usize },\n    RemoveChild { parent: usize, child: usize },\n    ReplaceChild { parent: usize, old: usize, new: usize },\n    UpdateText { id: usize, text: String },\n}\n\nimpl L1ToL2Contract for VNodeToDomContract {\n    type L1Type = VNode;\n    type L2Type = Vec\u003cDomOp\u003e;\n    \n    fn translate(vnode: Self::L1Type) -\u003e Self::L2Type {\n        let mut ops = Vec::new();\n        let mut next_id = 0;\n        \n        fn build_ops(node: \u0026VNode, ops: \u0026mut Vec\u003cDomOp\u003e, id: \u0026mut usize) -\u003e usize {\n            let node_id = *id;\n            *id += 1;\n            \n            match node {\n                VNode::Text(text) =\u003e {\n                    ops.push(DomOp::CreateText {\n                        text: text.clone(),\n                        id: node_id,\n                    });\n                }\n                VNode::Element { tag, props, children } =\u003e {\n                    ops.push(DomOp::CreateElement {\n                        tag: tag.clone(),\n                        id: node_id,\n                    });\n                    \n                    for (name, value) in \u0026props.attributes {\n                        ops.push(DomOp::SetAttribute {\n                            id: node_id,\n                            name: name.clone(),\n                            value: value.clone(),\n                        });\n                    }\n                    \n                    for child in children {\n                        let child_id = build_ops(child, ops, id);\n                        ops.push(DomOp::AppendChild {\n                            parent: node_id,\n                            child: child_id,\n                        });\n                    }\n                }\n            }\n            \n            node_id\n        }\n        \n        build_ops(\u0026vnode, \u0026mut ops, \u0026mut next_id);\n        ops\n    }\n}\n\n/// Contract for DOM operations to HTTP response (L2 → L3)\npub struct DomToHttpContract;\n\n#[derive(Clone, Debug)]\npub struct HttpResponse {\n    pub status: u16,\n    pub headers: Vec\u003c(String, String)\u003e,\n    pub body: String,\n}\n\n#[cfg(feature = \"ssr\")]\nimpl axum::response::IntoResponse for HttpResponse {\n    fn into_response(self) -\u003e axum::response::Response {\n        use axum::http::StatusCode;\n        \n        let mut response = axum::response::Response::builder()\n            .status(StatusCode::from_u16(self.status).unwrap_or(StatusCode::OK));\n        \n        for (name, value) in self.headers {\n            response = response.header(name, value);\n        }\n        \n        response.body(self.body.into()).unwrap()\n    }\n}\n\nimpl L2ToL3Contract for DomToHttpContract {\n    type L2Type = String; // Rendered HTML\n    type L3Type = HttpResponse;\n    \n    fn translate(html: Self::L2Type) -\u003e Self::L3Type {\n        HttpResponse {\n            status: 200,\n            headers: vec![\n                (\"Content-Type\".to_string(), \"text/html\".to_string()),\n                (\"X-Powered-By\".to_string(), \"Layer9-HAF\".to_string()),\n            ],\n            body: format!(\n                \"\u003c!DOCTYPE html\u003e\u003chtml\u003e\u003chead\u003e\u003cmeta charset=\\\"utf-8\\\"\u003e\u003c/head\u003e\u003cbody\u003e{}\u003c/body\u003e\u003c/html\u003e\",\n                html\n            ),\n        }\n    }\n}\n\n/// Contract for Signal changes to Effects (L1 → L2)\npub struct SignalToEffectContract;\n\n#[derive(Clone, Debug)]\npub struct SignalChange {\n    pub signal_id: usize,\n    pub old_value: String,\n    pub new_value: String,\n}\n\n#[derive(Clone, Debug)]\npub struct Effect {\n    pub effect_id: usize,\n    pub dependencies: Vec\u003cusize\u003e,\n    pub action: EffectAction,\n}\n\n#[derive(Clone, Debug)]\npub enum EffectAction {\n    UpdateDom { target: usize },\n    TriggerRender { component: usize },\n    RunCallback { callback_id: usize },\n}\n\nimpl L1ToL2Contract for SignalToEffectContract {\n    type L1Type = SignalChange;\n    type L2Type = Vec\u003cEffect\u003e;\n    \n    fn translate(change: Self::L1Type) -\u003e Self::L2Type {\n        // In a real implementation, this would look up registered effects\n        vec![\n            Effect {\n                effect_id: 1,\n                dependencies: vec![change.signal_id],\n                action: EffectAction::TriggerRender { component: 0 },\n            }\n        ]\n    }\n}\n\n/// Contract for Route definitions to HTTP handlers (L1 → L3)\npub struct RouteToHandlerContract;\n\n#[derive(Clone, Debug)]\npub struct Route {\n    pub path: String,\n    pub method: String,\n    pub component: String,\n}\n\npub type Handler = Box\u003cdyn Fn(\u0026str) -\u003e HttpResponse\u003e;\n\nimpl L1ToL2Contract for RouteToHandlerContract {\n    type L1Type = Route;\n    type L2Type = Handler;\n    \n    fn translate(route: Self::L1Type) -\u003e Self::L2Type {\n        Box::new(move |_path| {\n            HttpResponse {\n                status: 200,\n                headers: vec![],\n                body: format!(\"Route: {} {}\", route.method, route.path),\n            }\n        })\n    }\n}\n\n/// Batch contract for multiple transformations\npub struct BatchContract\u003cC: L1ToL2Contract\u003e {\n    _phantom: PhantomData\u003cC\u003e,\n}\n\nimpl\u003cC: L1ToL2Contract\u003e L1ToL2Contract for BatchContract\u003cC\u003e {\n    type L1Type = Vec\u003cC::L1Type\u003e;\n    type L2Type = Vec\u003cC::L2Type\u003e;\n    \n    fn translate(items: Self::L1Type) -\u003e Self::L2Type {\n        items.into_iter().map(C::translate).collect()\n    }\n}\n\n/// Contract composition\npub struct ComposedContract\u003cC1, C2\u003e \nwhere\n    C1: L1ToL2Contract,\n    C2: L2ToL3Contract\u003cL2Type = C1::L2Type\u003e,\n{\n    _c1: PhantomData\u003cC1\u003e,\n    _c2: PhantomData\u003cC2\u003e,\n}\n\nimpl\u003cC1, C2\u003e ComposedContract\u003cC1, C2\u003e\nwhere\n    C1: L1ToL2Contract,\n    C2: L2ToL3Contract\u003cL2Type = C1::L2Type\u003e,\n{\n    pub fn translate_full(l1: C1::L1Type) -\u003e C2::L3Type {\n        let l2 = C1::translate(l1);\n        C2::translate(l2)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_vnode_to_dom_contract() {\n        let vnode = VNode::Element {\n            tag: \"div\".to_string(),\n            props: Props {\n                attributes: vec![(\"class\".to_string(), \"container\".to_string())],\n            },\n            children: vec![\n                VNode::Text(\"Hello, HAF!\".to_string()),\n            ],\n        };\n        \n        let ops = VNodeToDomContract::translate(vnode);\n        \n        assert_eq!(ops.len(), 4); // create div, set class, create text, append child\n    }\n    \n    #[test]\n    fn test_contract_composition() {\n        let vnode = VNode::Text(\"Hello\".to_string());\n        let ops = VNodeToDomContract::translate(vnode);\n        // Further transformations would happen here\n        assert!(!ops.is_empty());\n    }\n}","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":2}},{"line":28,"address":[],"length":0,"stats":{"Line":2}},{"line":29,"address":[],"length":0,"stats":{"Line":2}},{"line":31,"address":[],"length":0,"stats":{"Line":3}},{"line":32,"address":[],"length":0,"stats":{"Line":3}},{"line":33,"address":[],"length":0,"stats":{"Line":3}},{"line":35,"address":[],"length":0,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":3}},{"line":56,"address":[],"length":0,"stats":{"Line":3}},{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}}],"covered":20,"coverable":40},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","l1_core.rs"],"content":"//! Layer 1: Core - Pure business logic\n//! \n//! This layer contains only pure functions and immutable data structures.\n//! No I/O, no side effects, no external dependencies.\n\nuse super::{VNode, Props};\n\n/// Pure diff algorithm - the heart of virtual DOM\n#[derive(Clone, Debug, PartialEq)]\npub enum Patch {\n    Replace { path: Vec\u003cusize\u003e, node: VNode },\n    UpdateText { path: Vec\u003cusize\u003e, text: String },\n    SetAttribute { path: Vec\u003cusize\u003e, name: String, value: String },\n    RemoveAttribute { path: Vec\u003cusize\u003e, name: String },\n    InsertChild { path: Vec\u003cusize\u003e, index: usize, node: VNode },\n    RemoveChild { path: Vec\u003cusize\u003e, index: usize },\n}\n\n/// Pure function to diff two VNodes\npub fn diff(old: \u0026VNode, new: \u0026VNode) -\u003e Vec\u003cPatch\u003e {\n    diff_recursive(old, new, \u0026mut vec![])\n}\n\nfn diff_recursive(old: \u0026VNode, new: \u0026VNode, path: \u0026mut Vec\u003cusize\u003e) -\u003e Vec\u003cPatch\u003e {\n    match (old, new) {\n        (VNode::Text(old_text), VNode::Text(new_text)) =\u003e {\n            if old_text != new_text {\n                vec![Patch::UpdateText {\n                    path: path.to_vec(),\n                    text: new_text.clone(),\n                }]\n            } else {\n                vec![]\n            }\n        }\n        (VNode::Element { tag: old_tag, props: old_props, children: old_children },\n         VNode::Element { tag: new_tag, props: new_props, children: new_children }) =\u003e {\n            if old_tag != new_tag {\n                vec![Patch::Replace {\n                    path: path.to_vec(),\n                    node: new.clone(),\n                }]\n            } else {\n                let mut patches = vec![];\n                \n                // Diff attributes\n                patches.extend(diff_props(old_props, new_props, path));\n                \n                // Diff children\n                let max_len = old_children.len().max(new_children.len());\n                for i in 0..max_len {\n                    path.push(i);\n                    match (old_children.get(i), new_children.get(i)) {\n                        (Some(old_child), Some(new_child)) =\u003e {\n                            patches.extend(diff_recursive(old_child, new_child, path));\n                        }\n                        (Some(_), None) =\u003e {\n                            patches.push(Patch::RemoveChild {\n                                path: path[..path.len()-1].to_vec(),\n                                index: i,\n                            });\n                        }\n                        (None, Some(new_child)) =\u003e {\n                            patches.push(Patch::InsertChild {\n                                path: path[..path.len()-1].to_vec(),\n                                index: i,\n                                node: new_child.clone(),\n                            });\n                        }\n                        (None, None) =\u003e unreachable!(),\n                    }\n                    path.pop();\n                }\n                \n                patches\n            }\n        }\n        _ =\u003e vec![Patch::Replace {\n            path: path.clone(),\n            node: new.clone(),\n        }],\n    }\n}\n\nfn diff_props(old: \u0026Props, new: \u0026Props, path: \u0026[usize]) -\u003e Vec\u003cPatch\u003e {\n    let mut patches = vec![];\n    \n    // Check for changed/added attributes\n    for (name, new_value) in \u0026new.attributes {\n        match old.attributes.iter().find(|(n, _)| n == name) {\n            Some((_, old_value)) if old_value != new_value =\u003e {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: name.clone(),\n                    value: new_value.clone(),\n                });\n            }\n            None =\u003e {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: name.clone(),\n                    value: new_value.clone(),\n                });\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    // Check for removed attributes\n    for (name, _) in \u0026old.attributes {\n        if !new.attributes.iter().any(|(n, _)| n == name) {\n            patches.push(Patch::RemoveAttribute {\n                path: path.to_vec(),\n                name: name.clone(),\n            });\n        }\n    }\n    \n    patches\n}\n\n/// Pure Signal type - immutable value container\n#[derive(Clone, Debug, PartialEq)]\npub struct Signal\u003cT\u003e {\n    pub id: usize,\n    pub value: T,\n}\n\nimpl\u003cT: Clone\u003e Signal\u003cT\u003e {\n    /// Pure function to create new signal with updated value\n    pub fn with_value(\u0026self, value: T) -\u003e Signal\u003cT\u003e {\n        Signal {\n            id: self.id,\n            value,\n        }\n    }\n}\n\n/// Pure Computed type - derived value\n#[derive(Clone, Debug)]\npub struct Computed\u003cT\u003e {\n    pub id: usize,\n    pub dependencies: Vec\u003cusize\u003e,\n    pub compute: fn(\u0026[SignalValue]) -\u003e T,\n}\n\n/// Type-erased signal value for computations\n#[derive(Clone, Debug)]\npub enum SignalValue {\n    String(String),\n    Number(f64),\n    Bool(bool),\n}\n\n/// Pure router matching\n#[derive(Clone, Debug, PartialEq)]\npub struct RouteMatch {\n    pub route: String,\n    pub params: Vec\u003c(String, String)\u003e,\n}\n\n/// Pure function to match routes\npub fn match_route(pattern: \u0026str, path: \u0026str) -\u003e Option\u003cRouteMatch\u003e {\n    let pattern_parts: Vec\u003c\u0026str\u003e = pattern.split('/').filter(|s| !s.is_empty()).collect();\n    let path_parts: Vec\u003c\u0026str\u003e = path.split('/').filter(|s| !s.is_empty()).collect();\n    \n    if pattern_parts.len() != path_parts.len() {\n        return None;\n    }\n    \n    let mut params = vec![];\n    \n    for (pattern_part, path_part) in pattern_parts.iter().zip(path_parts.iter()) {\n        if let Some(stripped) = pattern_part.strip_prefix(':') {\n            params.push((\n                stripped.to_string(),\n                path_part.to_string(),\n            ));\n        } else if pattern_part != path_part {\n            return None;\n        }\n    }\n    \n    Some(RouteMatch {\n        route: pattern.to_string(),\n        params,\n    })\n}\n\n/// Pure style computation\n#[derive(Clone, Debug, PartialEq)]\npub struct Style {\n    pub properties: Vec\u003c(String, String)\u003e,\n}\n\nimpl Style {\n    /// Pure function to merge styles\n    pub fn merge(\u0026self, other: \u0026Style) -\u003e Style {\n        let mut properties = self.properties.clone();\n        \n        for (key, value) in \u0026other.properties {\n            if let Some(pos) = properties.iter().position(|(k, _)| k == key) {\n                properties[pos] = (key.clone(), value.clone());\n            } else {\n                properties.push((key.clone(), value.clone()));\n            }\n        }\n        \n        Style { properties }\n    }\n    \n    /// Pure function to compute CSS string\n    pub fn to_css(\u0026self) -\u003e String {\n        self.properties\n            .iter()\n            .map(|(k, v)| format!(\"{}: {}\", k, v))\n            .collect::\u003cVec\u003c_\u003e\u003e()\n            .join(\"; \")\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_pure_diff() {\n        let old = VNode::Element {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![VNode::Text(\"Hello\".to_string())],\n        };\n        \n        let new = VNode::Element {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![VNode::Text(\"World\".to_string())],\n        };\n        \n        let patches = diff(\u0026old, \u0026new);\n        assert_eq!(patches.len(), 1);\n        match \u0026patches[0] {\n            Patch::UpdateText { text, .. } =\u003e assert_eq!(text, \"World\"),\n            _ =\u003e panic!(\"Expected UpdateText patch\"),\n        }\n    }\n    \n    #[test]\n    fn test_pure_route_matching() {\n        let matched = match_route(\"/users/:id\", \"/users/123\").unwrap();\n        assert_eq!(matched.params, vec![(\"id\".to_string(), \"123\".to_string())]);\n        \n        assert!(match_route(\"/users/:id\", \"/posts/123\").is_none());\n    }\n    \n    #[test]\n    fn test_pure_style_merge() {\n        let style1 = Style {\n            properties: vec![\n                (\"color\".to_string(), \"red\".to_string()),\n                (\"font-size\".to_string(), \"16px\".to_string()),\n            ],\n        };\n        \n        let style2 = Style {\n            properties: vec![\n                (\"color\".to_string(), \"blue\".to_string()),\n                (\"margin\".to_string(), \"10px\".to_string()),\n            ],\n        };\n        \n        let merged = style1.merge(\u0026style2);\n        assert_eq!(merged.properties.len(), 3);\n        assert_eq!(merged.to_css(), \"color: blue; font-size: 16px; margin: 10px\");\n    }\n}","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":1}},{"line":21,"address":[],"length":0,"stats":{"Line":1}},{"line":24,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":2}},{"line":26,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":53,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":2}},{"line":164,"address":[],"length":0,"stats":{"Line":10}},{"line":165,"address":[],"length":0,"stats":{"Line":10}},{"line":167,"address":[],"length":0,"stats":{"Line":2}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":2}},{"line":173,"address":[],"length":0,"stats":{"Line":3}},{"line":174,"address":[],"length":0,"stats":{"Line":4}},{"line":179,"address":[],"length":0,"stats":{"Line":2}},{"line":180,"address":[],"length":0,"stats":{"Line":1}},{"line":184,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":1}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":1}},{"line":201,"address":[],"length":0,"stats":{"Line":5}},{"line":202,"address":[],"length":0,"stats":{"Line":4}},{"line":205,"address":[],"length":0,"stats":{"Line":1}},{"line":213,"address":[],"length":0,"stats":{"Line":1}},{"line":214,"address":[],"length":0,"stats":{"Line":1}},{"line":216,"address":[],"length":0,"stats":{"Line":5}}],"covered":47,"coverable":82},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","l2_runtime.rs"],"content":"//! Layer 2: Runtime - Execution environment\n//! \n//! This layer manages side effects and provides the runtime for L1's pure logic.\n//! It can perform I/O but only depends on L1.\n\nuse super::{\n    contracts::{DomOp, Effect, EffectAction},\n    l1_core::{Patch, SignalValue},\n};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\n\n/// Runtime context for managing application state\npub struct Runtime {\n    /// Component instances\n    components: RefCell\u003cHashMap\u003cusize, Box\u003cdyn ComponentRuntime\u003e\u003e\u003e,\n    /// Signal values\n    signals: RefCell\u003cHashMap\u003cusize, SignalValue\u003e\u003e,\n    /// Registered effects\n    effects: RefCell\u003cHashMap\u003cusize, Effect\u003e\u003e,\n    /// DOM node references (for browser runtime)\n    #[cfg(target_arch = \"wasm32\")]\n    dom_nodes: RefCell\u003cHashMap\u003cusize, web_sys::Node\u003e\u003e,\n}\n\n/// Component runtime interface\npub trait ComponentRuntime {\n    fn update(\u0026self);\n    fn get_id(\u0026self) -\u003e usize;\n}\n\nimpl Default for Runtime {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Runtime {\n    pub fn new() -\u003e Self {\n        Runtime {\n            components: RefCell::new(HashMap::new()),\n            signals: RefCell::new(HashMap::new()),\n            effects: RefCell::new(HashMap::new()),\n            #[cfg(target_arch = \"wasm32\")]\n            dom_nodes: RefCell::new(HashMap::new()),\n        }\n    }\n    \n    /// Execute DOM operations (L1 → L2 translation)\n    pub fn apply_dom_ops(\u0026self, ops: Vec\u003cDomOp\u003e) {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            use wasm_bindgen::JsCast;\n            let document = web_sys::window().unwrap().document().unwrap();\n            \n            for op in ops {\n                match op {\n                    DomOp::CreateElement { tag, id } =\u003e {\n                        let element = document.create_element(\u0026tag).unwrap();\n                        self.dom_nodes.borrow_mut().insert(id, element.into());\n                    }\n                    DomOp::CreateText { text, id } =\u003e {\n                        let text_node = document.create_text_node(\u0026text);\n                        self.dom_nodes.borrow_mut().insert(id, text_node.into());\n                    }\n                    DomOp::SetAttribute { id, name, value } =\u003e {\n                        if let Some(node) = self.dom_nodes.borrow().get(\u0026id) {\n                            if let Some(element) = node.dyn_ref::\u003cweb_sys::Element\u003e() {\n                                element.set_attribute(\u0026name, \u0026value).unwrap();\n                            }\n                        }\n                    }\n                    DomOp::AppendChild { parent, child } =\u003e {\n                        let nodes = self.dom_nodes.borrow();\n                        if let (Some(parent_node), Some(child_node)) = \n                            (nodes.get(\u0026parent), nodes.get(\u0026child)) {\n                            parent_node.append_child(child_node).unwrap();\n                        }\n                    }\n                    // ... other operations\n                    _ =\u003e {}\n                }\n            }\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            // Server-side: collect ops for SSR\n            println!(\"DOM ops (server-side): {:?}\", ops);\n        }\n    }\n    \n    /// Apply patches to update DOM\n    pub fn apply_patches(\u0026self, patches: Vec\u003cPatch\u003e) {\n        // Translate L1 patches to L2 operations\n        let ops: Vec\u003cDomOp\u003e = patches.into_iter().map(|patch| {\n            match patch {\n                Patch::UpdateText { path, text } =\u003e {\n                    DomOp::UpdateText { \n                        id: path_to_id(\u0026path), \n                        text \n                    }\n                }\n                Patch::SetAttribute { path, name, value } =\u003e {\n                    DomOp::SetAttribute {\n                        id: path_to_id(\u0026path),\n                        name,\n                        value,\n                    }\n                }\n                // ... other patch types\n                _ =\u003e todo!(\"Implement other patch translations\"),\n            }\n        }).collect();\n        \n        self.apply_dom_ops(ops);\n    }\n    \n    /// Update signal value and trigger effects\n    pub fn update_signal(\u0026self, signal_id: usize, value: SignalValue) {\n        self.signals.borrow_mut().insert(signal_id, value.clone());\n        \n        // Find and execute effects that depend on this signal\n        let effects_to_run: Vec\u003cEffect\u003e = self.effects\n            .borrow()\n            .values()\n            .filter(|effect| effect.dependencies.contains(\u0026signal_id))\n            .cloned()\n            .collect();\n            \n        for effect in effects_to_run {\n            self.execute_effect(effect);\n        }\n    }\n    \n    /// Execute an effect\n    fn execute_effect(\u0026self, effect: Effect) {\n        match effect.action {\n            EffectAction::UpdateDom { target } =\u003e {\n                // Re-render the target component\n                if let Some(component) = self.components.borrow().get(\u0026target) {\n                    component.update();\n                }\n            }\n            EffectAction::TriggerRender { component } =\u003e {\n                if let Some(comp) = self.components.borrow().get(\u0026component) {\n                    comp.update();\n                }\n            }\n            EffectAction::RunCallback { callback_id } =\u003e {\n                // Execute registered callback\n                println!(\"Running callback {}\", callback_id);\n            }\n        }\n    }\n    \n    /// Register a component with the runtime\n    pub fn register_component(\u0026self, id: usize, component: Box\u003cdyn ComponentRuntime\u003e) {\n        self.components.borrow_mut().insert(id, component);\n    }\n    \n    /// Register an effect\n    pub fn register_effect(\u0026self, effect: Effect) {\n        self.effects.borrow_mut().insert(effect.effect_id, effect);\n    }\n}\n\n/// Scheduler for batching updates\npub struct Scheduler {\n    pending_updates: RefCell\u003cVec\u003cBox\u003cdyn FnOnce()\u003e\u003e\u003e,\n    is_scheduled: RefCell\u003cbool\u003e,\n}\n\nimpl Default for Scheduler {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Scheduler {\n    pub fn new() -\u003e Self {\n        Scheduler {\n            pending_updates: RefCell::new(Vec::new()),\n            is_scheduled: RefCell::new(false),\n        }\n    }\n    \n    /// Schedule an update\n    pub fn schedule_update\u003cF: FnOnce() + 'static\u003e(\u0026self, update: F) {\n        self.pending_updates.borrow_mut().push(Box::new(update));\n        \n        if !*self.is_scheduled.borrow() {\n            *self.is_scheduled.borrow_mut() = true;\n            self.schedule_flush();\n        }\n    }\n    \n    /// Schedule flush of pending updates\n    fn schedule_flush(\u0026self) {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            // Use requestAnimationFrame for browser\n            // Implementation would use wasm-bindgen\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            // Immediate flush for server-side\n            self.flush();\n        }\n    }\n    \n    /// Flush all pending updates\n    fn flush(\u0026self) {\n        let updates = std::mem::take(\u0026mut *self.pending_updates.borrow_mut());\n        *self.is_scheduled.borrow_mut() = false;\n        \n        for update in updates {\n            update();\n        }\n    }\n}\n\n// Memory allocator service (L2)\ncrate::haf_service!(L2, memory_service, {\n    pub fn allocate_component_id() -\u003e usize {\n        // Thread-local counter for component IDs\n        thread_local! {\n            static NEXT_ID: RefCell\u003cusize\u003e = const { RefCell::new(0) };\n        }\n        \n        NEXT_ID.with(|id| {\n            let current = *id.borrow();\n            *id.borrow_mut() = current + 1;\n            current\n        })\n    }\n    \n    pub fn allocate_signal_id() -\u003e usize {\n        thread_local! {\n            static NEXT_ID: RefCell\u003cusize\u003e = const { RefCell::new(0) };\n        }\n        \n        NEXT_ID.with(|id| {\n            let current = *id.borrow();\n            *id.borrow_mut() = current + 1;\n            current\n        })\n    }\n});\n\n/// Helper to convert path to node ID\nfn path_to_id(path: \u0026[usize]) -\u003e usize {\n    // Simple implementation - in real app would maintain proper mapping\n    path.iter().fold(0, |acc, \u0026idx| acc * 100 + idx)\n}\n\n/// Server-side rendering context\n#[cfg(feature = \"ssr\")]\npub struct SsrContext {\n    _html_buffer: RefCell\u003cString\u003e,\n    _head_buffer: RefCell\u003cString\u003e,\n}\n\n#[cfg(feature = \"ssr\")]\nimpl Default for SsrContext {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(feature = \"ssr\")]\nimpl SsrContext {\n    pub fn new() -\u003e Self {\n        SsrContext {\n            _html_buffer: RefCell::new(String::new()),\n            _head_buffer: RefCell::new(String::new()),\n        }\n    }\n    \n    pub fn render_to_string(\u0026self, component: \u0026super::Component\u003csuper::layers::L1\u003e) -\u003e String {\n        // Render component to HTML string\n        let vnode = component.inner.render();\n        self.vnode_to_html(\u0026vnode)\n    }\n    \n    #[allow(clippy::only_used_in_recursion)]\n    fn vnode_to_html(\u0026self, vnode: \u0026super::VNode) -\u003e String {\n        match vnode {\n            super::VNode::Text(text) =\u003e html_escape::encode_text(text).to_string(),\n            super::VNode::Element { tag, props, children } =\u003e {\n                let mut html = format!(\"\u003c{}\", tag);\n                \n                for (name, value) in \u0026props.attributes {\n                    html.push_str(\u0026format!(\" {}=\\\"{}\\\"\", name, html_escape::encode_text(value)));\n                }\n                \n                html.push('\u003e');\n                \n                for child in children {\n                    html.push_str(\u0026self.vnode_to_html(child));\n                }\n                \n                html.push_str(\u0026format!(\"\u003c/{}\u003e\", tag));\n                html\n            }\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::rc::Rc;\n    \n    #[test]\n    fn test_runtime_creation() {\n        let runtime = Runtime::new();\n        let signal_id = memory_service::allocate_signal_id();\n        \n        runtime.update_signal(signal_id, SignalValue::String(\"Hello\".to_string()));\n        \n        assert_eq!(runtime.signals.borrow().len(), 1);\n    }\n    \n    #[test]\n    fn test_scheduler() {\n        let scheduler = Scheduler::new();\n        let counter = Rc::new(RefCell::new(0));\n        \n        let counter_clone = counter.clone();\n        scheduler.schedule_update(move || {\n            *counter_clone.borrow_mut() += 1;\n        });\n        \n        // In test environment, flush immediately\n        scheduler.flush();\n        \n        assert_eq!(*counter.borrow(), 1);\n    }\n}","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":1}},{"line":184,"address":[],"length":0,"stats":{"Line":1}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":190,"address":[],"length":0,"stats":{"Line":1}},{"line":192,"address":[],"length":0,"stats":{"Line":2}},{"line":193,"address":[],"length":0,"stats":{"Line":1}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":1}},{"line":209,"address":[],"length":0,"stats":{"Line":1}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[],"length":0,"stats":{"Line":2}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":218,"address":[],"length":0,"stats":{"Line":4}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":1}},{"line":245,"address":[],"length":0,"stats":{"Line":1}},{"line":246,"address":[],"length":0,"stats":{"Line":1}},{"line":247,"address":[],"length":0,"stats":{"Line":1}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}}],"covered":28,"coverable":86},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","l3_framework.rs"],"content":"//! Layer 3: Framework - External interfaces\n//! \n//! This layer provides user-facing APIs and handles external communication.\n//! It depends on L2 and L1 but nothing depends on it.\n\nuse super::VNode;\n\n/// Application builder - the main entry point for users\npub struct App {\n    root_component: Option\u003cBox\u003cdyn Fn() -\u003e VNode + Send + Sync\u003e\u003e,\n    routes: Vec\u003cRoute\u003e,\n}\n\npub struct Route {\n    pub path: String,\n    pub component: Box\u003cdyn Fn() -\u003e VNode + Send + Sync\u003e,\n}\n\n/// Runtime for the framework layer\npub struct Runtime {\n    #[cfg(target_arch = \"wasm32\")]\n    pub dom_nodes: std::cell::RefCell\u003cstd::collections::HashMap\u003cusize, web_sys::Node\u003e\u003e,\n}\n\nimpl Default for Runtime {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Runtime {\n    pub fn new() -\u003e Self {\n        Runtime {\n            #[cfg(target_arch = \"wasm32\")]\n            dom_nodes: std::cell::RefCell::new(std::collections::HashMap::new()),\n        }\n    }\n    \n    /// Apply DOM operations\n    pub fn apply_dom_ops(\u0026self, _ops: Vec\u003csuper::contracts::DomOp\u003e) {\n        // TODO: Implement DOM operations\n    }\n}\n\n/// Scheduler for effects\npub struct Scheduler {\n    // TODO: Implement scheduler\n}\n\nimpl Default for Scheduler {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Scheduler {\n    pub fn new() -\u003e Self {\n        Scheduler {}\n    }\n}\n\nimpl Default for App {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl App {\n    /// Create a new Layer9 application\n    pub fn new() -\u003e Self {\n        App {\n            root_component: None,\n            routes: Vec::new(),\n        }\n    }\n    \n    /// Set the root component\n    pub fn component\u003cF\u003e(mut self, component: F) -\u003e Self \n    where\n        F: Fn() -\u003e VNode + Send + Sync + 'static\n    {\n        self.root_component = Some(Box::new(component));\n        self\n    }\n    \n    /// Add a route\n    pub fn route\u003cF\u003e(mut self, path: \u0026str, component: F) -\u003e Self\n    where\n        F: Fn() -\u003e VNode + Send + Sync + 'static\n    {\n        self.routes.push(Route {\n            path: path.to_string(),\n            component: Box::new(component),\n        });\n        self\n    }\n    \n    /// Mount the application to a DOM element (browser)\n    #[cfg(target_arch = \"wasm32\")]\n    pub fn mount(self, selector: \u0026str) {\n        use wasm_bindgen::JsCast;\n        \n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        let root_element = document.query_selector(selector).unwrap().unwrap();\n        \n        // Clear existing content\n        root_element.set_inner_html(\"\");\n        \n        // Render root component\n        if let Some(root_fn) = self.root_component {\n            let vnode = root_fn();\n            let runtime = Runtime::new();\n            // For now, skip the contract translation in WASM\n            // TODO: Implement proper DOM operations\n            let _vnode = vnode;\n            // runtime.apply_dom_ops(ops);\n            \n            // TODO: Implement proper DOM mounting\n            // For now, just create a simple text node\n            let text_node = document.create_text_node(\"Layer9 App\");\n            root_element.append_child(\u0026text_node).unwrap();\n        }\n    }\n    \n    /// Run as server (SSR)\n    #[cfg(feature = \"ssr\")]\n    pub async fn serve(self, addr: \u0026str) {\n        use axum::{Router, routing::get};\n        \n        let app_state = AppState {\n            app: std::sync::Arc::new(self),\n        };\n        \n        let router = Router::new()\n            .route(\"/*path\", get(handle_request))\n            .with_state(app_state);\n        \n        println!(\"Server running at http://{}\", addr);\n        \n        let listener = tokio::net::TcpListener::bind(addr).await.unwrap();\n        axum::serve(listener, router).await.unwrap();\n    }\n}\n\n/// HTTP server state\n#[cfg(feature = \"ssr\")]\n#[derive(Clone)]\nstruct AppState {\n    app: std::sync::Arc\u003cApp\u003e,\n}\n\n/// Handle HTTP requests\n#[cfg(feature = \"ssr\")]\nasync fn handle_request(\n    axum::extract::State(state): axum::extract::State\u003cAppState\u003e,\n    axum::extract::Path(path): axum::extract::Path\u003cString\u003e,\n) -\u003e crate::haf::HttpResponse {\n    // Find matching route\n    for route in \u0026state.app.routes {\n        if route.path == path || route.path == format!(\"/{}\", path) {\n            let vnode = (route.component)();\n            \n            // Render to HTML\n            let html = format!(\"\u003cdiv\u003e{:?}\u003c/div\u003e\", vnode); // TODO: Implement proper SSR\n            \n            return crate::haf::HttpResponse {\n                status: 200,\n                headers: vec![(\"Content-Type\".to_string(), \"text/html\".to_string())],\n                body: format!(\n                    \"\u003c!DOCTYPE html\u003e\u003chtml\u003e\u003chead\u003e\u003cmeta charset=\\\"utf-8\\\"\u003e\u003cscript type=\\\"module\\\" src=\\\"/app.js\\\"\u003e\u003c/script\u003e\u003c/head\u003e\u003cbody\u003e\u003cdiv id=\\\"app\\\"\u003e{}\u003c/div\u003e\u003c/body\u003e\u003c/html\u003e\",\n                    html\n                ),\n            };\n        }\n    }\n    \n    // 404\n    crate::haf::HttpResponse {\n        status: 404,\n        headers: vec![(\"Content-Type\".to_string(), \"text/html\".to_string())],\n        body: \"Not Found\".to_string(),\n    }\n}\n\n/// Hook APIs for components\npub mod hooks {\n    use super::*;\n    use std::rc::Rc;\n    \n    /// State hook\n    pub fn use_state\u003cT: Clone + 'static\u003e(initial: T) -\u003e (T, Rc\u003cdyn Fn(T)\u003e) {\n        // Get current component context\n        // In real implementation, this would use thread-local storage\n        let signal_id = 0; // TODO: Implement proper signal ID allocation\n        let runtime = Rc::new(Runtime::new());\n        \n        let value = initial.clone();\n        \n        let setter = {\n            let _runtime = runtime.clone();\n            Rc::new(move |_new_value: T| {\n                // Update signal in runtime\n                // This would trigger re-render\n                println!(\"Updating state to: {:?}\", signal_id);\n            }) as Rc\u003cdyn Fn(T)\u003e\n        };\n        \n        (value, setter)\n    }\n    \n    /// Effect hook\n    pub fn use_effect\u003cF, D\u003e(_dependencies: D, _effect: F)\n    where\n        F: Fn() + 'static,\n        D: PartialEq + 'static,\n    {\n        // Register effect with runtime\n        println!(\"Registering effect\");\n    }\n    \n    /// Memo hook\n    pub fn use_memo\u003cT, F, D\u003e(_dependencies: D, compute: F) -\u003e T\n    where\n        T: Clone + 'static,\n        F: Fn() -\u003e T,\n        D: PartialEq + 'static,\n    {\n        compute()\n    }\n}\n\n/// Router API\npub mod router {\n    /// Navigate to a route\n    pub fn navigate(path: \u0026str) {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            let window = web_sys::window().unwrap();\n            let history = window.history().unwrap();\n            history.push_state_with_url(\u0026wasm_bindgen::JsValue::NULL, \"\", Some(path)).unwrap();\n            \n            // Trigger re-render\n            // In real implementation, would notify router\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            println!(\"Navigate to: {}\", path);\n        }\n    }\n    \n    /// Get current route\n    pub fn use_route() -\u003e String {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            let window = web_sys::window().unwrap();\n            let location = window.location();\n            location.pathname().unwrap()\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            \"/\".to_string()\n        }\n    }\n    \n    /// Get route parameters\n    pub fn use_params() -\u003e std::collections::HashMap\u003cString, String\u003e {\n        std::collections::HashMap::new()\n    }\n}\n\n/// HTTP client API\npub mod http {\n    \n    #[derive(Clone)]\n    pub struct Request {\n        pub method: String,\n        pub url: String,\n        pub headers: Vec\u003c(String, String)\u003e,\n        pub body: Option\u003cString\u003e,\n    }\n    \n    /// Fetch data from URL\n    pub async fn fetch(_url: \u0026str) -\u003e Result\u003cString, String\u003e {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            // Use browser fetch API\n            // Implementation would use wasm-bindgen-futures\n            Ok(\"Mock response\".to_string())\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            // Use reqwest or similar\n            Ok(\"Mock response\".to_string())\n        }\n    }\n    \n    /// POST JSON data\n    pub async fn post_json\u003cT: serde::Serialize\u003e(url: \u0026str, data: \u0026T) -\u003e Result\u003cString, String\u003e {\n        let _body = serde_json::to_string(data).map_err(|e| e.to_string())?;\n        \n        // Make request\n        fetch(url).await\n    }\n}\n\n/// WebSocket API\npub mod websocket {\n    \n    pub struct WebSocket {\n        #[allow(dead_code)]\n        url: String,\n        #[cfg(target_arch = \"wasm32\")]\n        ws: Option\u003cweb_sys::WebSocket\u003e,\n    }\n    \n    impl WebSocket {\n        pub fn connect(url: \u0026str) -\u003e Result\u003cSelf, String\u003e {\n            #[cfg(target_arch = \"wasm32\")]\n            {\n                let ws = web_sys::WebSocket::new(url).map_err(|_| \"Failed to create WebSocket\")?;\n                Ok(WebSocket {\n                    url: url.to_string(),\n                    ws: Some(ws),\n                })\n            }\n            \n            #[cfg(not(target_arch = \"wasm32\"))]\n            {\n                Ok(WebSocket {\n                    url: url.to_string(),\n                })\n            }\n        }\n        \n        pub fn send(\u0026self, message: \u0026str) -\u003e Result\u003c(), String\u003e {\n            #[cfg(target_arch = \"wasm32\")]\n            {\n                if let Some(ws) = \u0026self.ws {\n                    ws.send_with_str(message).map_err(|_| \"Failed to send\")?;\n                }\n            }\n            \n            #[cfg(not(target_arch = \"wasm32\"))]\n            {\n                let _ = message;\n            }\n            \n            Ok(())\n        }\n        \n        pub fn on_message\u003cF\u003e(\u0026self, _handler: F)\n        where\n            F: Fn(String) + 'static\n        {\n            #[cfg(target_arch = \"wasm32\")]\n            {\n                // Set up message handler\n                // Implementation would use Closure\n            }\n        }\n    }\n}\n\n/// Development tools\npub mod devtools {\n    /// Enable React DevTools integration\n    pub fn enable_devtools() {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            web_sys::console::log_1(\u0026\"Layer9 DevTools enabled\".into());\n        }\n    }\n    \n    /// Log component tree\n    pub fn log_component_tree() {\n        println!(\"Component tree logging\");\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_app_builder() {\n        let app = App::new()\n            .route(\"/\", || VNode::Text(\"Home\".to_string()))\n            .route(\"/about\", || VNode::Text(\"About\".to_string()));\n        \n        assert_eq!(app.routes.len(), 2);\n    }\n    \n    #[test]\n    fn test_hooks() {\n        let (value, setter) = hooks::use_state(42);\n        assert_eq!(value, 42);\n        \n        // In real implementation, setter would trigger re-render\n        setter(100);\n    }\n}","traces":[{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":2}},{"line":91,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":2}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":95,"address":[],"length":0,"stats":{"Line":2}},{"line":192,"address":[],"length":0,"stats":{"Line":1}},{"line":195,"address":[],"length":0,"stats":{"Line":1}},{"line":196,"address":[],"length":0,"stats":{"Line":1}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":1}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":205,"address":[],"length":0,"stats":{"Line":1}},{"line":206,"address":[],"length":0,"stats":{"Line":2}},{"line":209,"address":[],"length":0,"stats":{"Line":1}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}}],"covered":19,"coverable":69},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","mod.rs"],"content":"//! HAF (Hierarchical Architecture First) enforcement system\n//! \n//! This module provides compile-time guarantees that code follows HAF principles.\n//! It uses Rust's type system to prevent architectural violations.\n\nuse std::marker::PhantomData;\n\n// Sub-modules\npub mod contracts;\npub mod l1_core;\npub mod l2_runtime;\npub mod l3_framework;\npub mod component;\npub mod compat;\npub mod vdom;\npub mod reactive;\n#[cfg(test)]\npub mod tests;\n\n// Re-export commonly used items\npub use contracts::HttpResponse;\npub use l1_core::*;\n// Re-export specific items to avoid conflicts\npub use l2_runtime::{Runtime as L2Runtime, Scheduler as L2Scheduler};\npub use l3_framework::{App, Runtime as L3Runtime, Scheduler as L3Scheduler, \n                       router, hooks, http, websocket, devtools};\n\n/// Layer markers - zero-sized types representing architectural layers\npub mod layers {\n    /// Layer 1: Core - Pure business logic, no I/O, no dependencies\n    pub struct L1;\n    \n    /// Layer 2: Runtime - Execution environment, manages side effects\n    pub struct L2;\n    \n    /// Layer 3: Framework - External interfaces, user-facing APIs\n    pub struct L3;\n}\n\n/// Trait that all layer types must implement\npub trait Layer: 'static {\n    /// Layer depth - L1=1, L2=2, L3=3\n    const DEPTH: u8;\n    \n    /// Layer name for debugging\n    const NAME: \u0026'static str;\n}\n\nimpl Layer for layers::L1 {\n    const DEPTH: u8 = 1;\n    const NAME: \u0026'static str = \"Core\";\n}\n\nimpl Layer for layers::L2 {\n    const DEPTH: u8 = 2;\n    const NAME: \u0026'static str = \"Runtime\";\n}\n\nimpl Layer for layers::L3 {\n    const DEPTH: u8 = 3;\n    const NAME: \u0026'static str = \"Framework\";\n}\n\n/// Component tagged with its layer\npub struct Component\u003cL: Layer\u003e {\n    #[allow(dead_code)]\n    pub(crate) inner: Box\u003cdyn ComponentInner\u003e,\n    pub(crate) _layer: PhantomData\u003cL\u003e,\n}\n\n/// Internal component representation\npub trait ComponentInner: 'static {\n    fn render(\u0026self) -\u003e VNode;\n}\n\n/// Virtual DOM node - pure data structure (L1)\n#[derive(Clone, Debug, PartialEq)]\npub enum VNode {\n    Text(String),\n    Element {\n        tag: String,\n        props: Props,\n        children: Vec\u003cVNode\u003e,\n    },\n}\n\n/// Component properties - pure data (L1)\n#[derive(Clone, Debug, Default, PartialEq)]\npub struct Props {\n    pub attributes: Vec\u003c(String, String)\u003e,\n}\n\n/// Contract wrapper for layer translations\n#[derive(Debug, Clone)]\npub struct Contract\u003cInput, Output\u003e {\n    pub input: Input,\n    pub output: Output,\n}\n\nimpl\u003cI, O\u003e Contract\u003cI, O\u003e {\n    pub fn new(input: I, output: O) -\u003e Self {\n        Self { input, output }\n    }\n}\n\n/// Translation contract from L1 to L2\npub trait L1ToL2Contract {\n    type L1Type;\n    type L2Type;\n    \n    fn translate(l1: Self::L1Type) -\u003e Self::L2Type;\n}\n\n/// Translation contract from L2 to L3\npub trait L2ToL3Contract {\n    type L2Type;\n    type L3Type;\n    \n    fn translate(l2: Self::L2Type) -\u003e Self::L3Type;\n}\n\n/// Dependency direction enforcement\n/// This trait can only be implemented for valid layer transitions\npub trait CanDepend\u003cTarget: Layer\u003e: Layer {}\n\n// L3 can depend on L2\nimpl CanDepend\u003clayers::L2\u003e for layers::L3 {}\n\n// L3 can depend on L1\nimpl CanDepend\u003clayers::L1\u003e for layers::L3 {}\n\n// L2 can depend on L1\nimpl CanDepend\u003clayers::L1\u003e for layers::L2 {}\n\n// Self-dependencies are allowed\nimpl CanDepend\u003clayers::L1\u003e for layers::L1 {}\nimpl CanDepend\u003clayers::L2\u003e for layers::L2 {}\nimpl CanDepend\u003clayers::L3\u003e for layers::L3 {}\n\n/// Service boundary with explicit layer\npub struct Service\u003cL: Layer\u003e {\n    #[allow(dead_code)]\n    pub(crate) name: \u0026'static str,\n    pub(crate) _layer: PhantomData\u003cL\u003e,\n}\n\nimpl\u003cL: Layer\u003e Service\u003cL\u003e {\n    pub const fn new(name: \u0026'static str) -\u003e Self {\n        Service {\n            name,\n            _layer: PhantomData,\n        }\n    }\n}\n\n/// HAF-compliant function that enforces dependency rules\npub fn haf_function\u003cFrom, To: Layer, F, R\u003e(f: F) -\u003e F\nwhere\n    From: Layer + CanDepend\u003cTo\u003e,\n    F: Fn() -\u003e R,\n{\n    f\n}\n\n/// Macro to define HAF-compliant components\n#[macro_export]\nmacro_rules! haf_component {\n    // L1 component - pure, no side effects\n    (L1, $name:ident, $props:ty, $body:expr) =\u003e {\n        pub fn $name(props: $props) -\u003e $crate::haf::Component\u003c$crate::haf::layers::L1\u003e {\n            use $crate::haf::{Component, ComponentInner, VNode};\n            \n            struct Inner {\n                props: $props,\n            }\n            \n            impl ComponentInner for Inner {\n                fn render(\u0026self) -\u003e VNode {\n                    let props = \u0026self.props;\n                    $body\n                }\n            }\n            \n            Component {\n                inner: Box::new(Inner { props }),\n                _layer: std::marker::PhantomData,\n            }\n        }\n    };\n    \n    // L2 component - can use runtime features\n    (L2, $name:ident, $props:ty, $body:expr) =\u003e {\n        pub fn $name(props: $props) -\u003e $crate::haf::Component\u003c$crate::haf::layers::L2\u003e {\n            use $crate::haf::{Component, ComponentInner, VNode};\n            \n            struct Inner {\n                props: $props,\n            }\n            \n            impl ComponentInner for Inner {\n                fn render(\u0026self) -\u003e VNode {\n                    let props = \u0026self.props;\n                    // L2 can access runtime features\n                    $body\n                }\n            }\n            \n            Component {\n                inner: Box::new(Inner { props }),\n                _layer: std::marker::PhantomData,\n            }\n        }\n    };\n    \n    // L3 component - full framework features\n    (L3, $name:ident, $props:ty, $body:expr) =\u003e {\n        pub fn $name(props: $props) -\u003e $crate::haf::Component\u003c$crate::haf::layers::L3\u003e {\n            use $crate::haf::{Component, ComponentInner, VNode};\n            \n            struct Inner {\n                props: $props,\n            }\n            \n            impl ComponentInner for Inner {\n                fn render(\u0026self) -\u003e VNode {\n                    let props = \u0026self.props;\n                    // L3 can access all features\n                    $body\n                }\n            }\n            \n            Component {\n                inner: Box::new(Inner { props }),\n                _layer: std::marker::PhantomData,\n            }\n        }\n    };\n}\n\n/// Service definition macro with layer enforcement\n#[macro_export]\nmacro_rules! haf_service {\n    ($layer:ident, $name:ident, {\n        $(\n            pub fn $fn_name:ident($($arg:ident: $arg_ty:ty),*) -\u003e $ret:ty $body:block\n        )*\n    }) =\u003e {\n        pub mod $name {\n            use super::*;\n            use $crate::haf::{Service, layers::$layer};\n            \n            pub const SERVICE: Service\u003c$layer\u003e = Service::new(stringify!($name));\n            \n            $(\n                pub fn $fn_name($($arg: $arg_ty),*) -\u003e $ret {\n                    // Function is tagged with service layer\n                    $body\n                }\n            )*\n        }\n    };\n}\n\n/// Contract definition macro\n#[macro_export]\nmacro_rules! haf_contract {\n    ($name:ident: $from:ident -\u003e $to:ident {\n        $(\n            fn $method:ident($input:ty) -\u003e $output:ty;\n        )*\n    }) =\u003e {\n        pub trait $name {\n            $(\n                fn $method(input: $input) -\u003e $output;\n            )*\n        }\n        \n        // Ensure contract follows dependency rules\n        const _: () = {\n            fn _check_contract\u003cF: $crate::haf::Layer, T: $crate::haf::Layer\u003e()\n            where\n                F: $crate::haf::CanDepend\u003cT\u003e\n            {}\n            \n            fn _verify() {\n                _check_contract::\u003c$crate::haf::layers::$from, $crate::haf::layers::$to\u003e();\n            }\n        };\n    };\n}\n","traces":[{"line":101,"address":[],"length":0,"stats":{"Line":4}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":1}},{"line":257,"address":[],"length":0,"stats":{"Line":1}}],"covered":3,"coverable":6},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","reactive.rs"],"content":"//! HAF-compliant Reactive System\n//! \n//! This module provides a layered reactive system following HAF principles:\n//! - L1: Pure signal values and computations\n//! - L2: Effect scheduling and dependency tracking\n//! - L3: DOM bindings and external subscriptions\n\nuse crate::haf::{layers::{L1, L2, L3}, Layer, Contract};\nuse std::marker::PhantomData;\nuse std::collections::HashSet;\n\n// Type aliases to simplify complex types\ntype SignalCallback = Box\u003cdyn Fn(\u0026dyn std::any::Any)\u003e;\ntype ElementUpdateFn = Box\u003cdyn Fn(\u0026web_sys::Element, \u0026dyn std::any::Any)\u003e;\ntype SignalSubscriptions = std::collections::HashMap\u003cSignalId, Vec\u003cSignalCallback\u003e\u003e;\ntype ComputeFn\u003cT\u003e = Box\u003cdyn Fn(\u0026[SignalId]) -\u003e T\u003e;\n\n// ==================== L1: Pure Signal Layer ====================\n\n/// Pure signal value (L1)\n#[derive(Debug, Clone)]\npub struct Signal\u003cT, L: Layer\u003e {\n    pub value: T,\n    pub id: SignalId,\n    _layer: PhantomData\u003cL\u003e,\n}\n\n/// Signal identifier\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub struct SignalId(pub u64);\n\n/// Computed value (L1)\npub struct Computed\u003cT, L: Layer\u003e {\n    pub compute: ComputeFn\u003cT\u003e,\n    pub dependencies: Vec\u003cSignalId\u003e,\n    pub value: T,\n    pub id: SignalId,\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl\u003cT: Clone, L: Layer\u003e Signal\u003cT, L\u003e {\n    /// Create new signal (pure)\n    pub fn new(value: T, id: SignalId) -\u003e Self {\n        Self {\n            value,\n            id,\n            _layer: PhantomData,\n        }\n    }\n    \n    /// Get current value (pure)\n    pub fn get(\u0026self) -\u003e T {\n        self.value.clone()\n    }\n    \n    /// Create new signal with updated value (pure)\n    pub fn with_value(\u0026self, value: T) -\u003e Self {\n        Self {\n            value,\n            id: self.id,\n            _layer: PhantomData,\n        }\n    }\n}\n\nimpl\u003cT: Clone\u003e Computed\u003cT, L1\u003e {\n    /// Create new computed value (pure)\n    pub fn new\u003cF\u003e(id: SignalId, dependencies: Vec\u003cSignalId\u003e, compute: F, initial: T) -\u003e Self \n    where\n        F: Fn(\u0026[SignalId]) -\u003e T + 'static,\n    {\n        Self {\n            compute: Box::new(compute),\n            dependencies,\n            value: initial,\n            id,\n            _layer: PhantomData,\n        }\n    }\n    \n    /// Recompute value (pure)\n    pub fn recompute(\u0026self, _signal_values: \u0026[(SignalId, Box\u003cdyn std::any::Any\u003e)]) -\u003e T {\n        // In real implementation, would look up signal values\n        (self.compute)(\u0026self.dependencies)\n    }\n}\n\n/// Pure reactive graph operations\npub mod graph {\n    use super::*;\n    \n    /// Dependency graph (pure data structure)\n    #[derive(Debug, Default)]\n    pub struct DependencyGraph {\n        /// Signal -\u003e Dependents mapping\n        pub dependents: std::collections::HashMap\u003cSignalId, Vec\u003cSignalId\u003e\u003e,\n        /// Signal -\u003e Dependencies mapping\n        pub dependencies: std::collections::HashMap\u003cSignalId, Vec\u003cSignalId\u003e\u003e,\n    }\n    \n    impl DependencyGraph {\n        /// Add dependency relationship (pure)\n        pub fn add_dependency(\u0026self, signal: SignalId, depends_on: SignalId) -\u003e Self {\n            let mut graph = self.clone();\n            \n            graph.dependencies\n                .entry(signal)\n                .or_default()\n                .push(depends_on);\n                \n            graph.dependents\n                .entry(depends_on)\n                .or_default()\n                .push(signal);\n                \n            graph\n        }\n        \n        /// Get signals that depend on given signal (pure)\n        pub fn get_dependents(\u0026self, signal: SignalId) -\u003e Vec\u003cSignalId\u003e {\n            self.dependents\n                .get(\u0026signal)\n                .cloned()\n                .unwrap_or_default()\n        }\n        \n        /// Topological sort for update order (pure)\n        pub fn topological_sort(\u0026self, changed: SignalId) -\u003e Vec\u003cSignalId\u003e {\n            let mut visited = HashSet::new();\n            let mut stack = vec![changed];\n            let mut result = Vec::new();\n            \n            while let Some(signal) = stack.pop() {\n                if visited.insert(signal) {\n                    result.push(signal);\n                    for dependent in self.get_dependents(signal) {\n                        stack.push(dependent);\n                    }\n                }\n            }\n            \n            result\n        }\n    }\n    \n    impl Clone for DependencyGraph {\n        fn clone(\u0026self) -\u003e Self {\n            Self {\n                dependents: self.dependents.clone(),\n                dependencies: self.dependencies.clone(),\n            }\n        }\n    }\n}\n\n// ==================== L2: Reactive Runtime Layer ====================\n\n/// Effect tracking (L2)\npub struct EffectTracker\u003cL: Layer\u003e {\n    pub id: EffectId,\n    pub dependencies: Vec\u003cSignalId\u003e,\n    pub cleanup: Option\u003cBox\u003cdyn FnOnce()\u003e\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\n/// Effect identifier\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub struct EffectId(pub u64);\n\n/// Signal runtime (L2)\npub struct SignalRuntime\u003cL: Layer\u003e {\n    /// Tracked effects\n    effects: Vec\u003cEffectTracker\u003cL\u003e\u003e,\n    /// Current tracking context\n    tracking_context: Option\u003cEffectId\u003e,\n    /// Scheduled updates\n    update_queue: Vec\u003cSignalId\u003e,\n    /// Batch depth\n    batch_depth: usize,\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for SignalRuntime\u003cL2\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl SignalRuntime\u003cL2\u003e {\n    pub fn new() -\u003e Self {\n        Self {\n            effects: Vec::new(),\n            tracking_context: None,\n            update_queue: Vec::new(),\n            batch_depth: 0,\n            _layer: PhantomData,\n        }\n    }\n    \n    /// Start tracking dependencies\n    pub fn start_tracking(\u0026mut self, effect_id: EffectId) {\n        self.tracking_context = Some(effect_id);\n    }\n    \n    /// Stop tracking dependencies\n    pub fn stop_tracking(\u0026mut self) -\u003e Vec\u003cSignalId\u003e {\n        self.tracking_context = None;\n        // Return collected dependencies\n        vec![]\n    }\n    \n    /// Register signal access\n    pub fn track_signal_access(\u0026mut self, signal_id: SignalId) {\n        if let Some(effect_id) = self.tracking_context {\n            // Record dependency\n            if let Some(effect) = self.effects.iter_mut().find(|e| e.id == effect_id) {\n                if !effect.dependencies.contains(\u0026signal_id) {\n                    effect.dependencies.push(signal_id);\n                }\n            }\n        }\n    }\n    \n    /// Schedule update\n    pub fn schedule_update(\u0026mut self, signal_id: SignalId) {\n        self.update_queue.push(signal_id);\n        \n        if self.batch_depth == 0 {\n            self.flush_updates();\n        }\n    }\n    \n    /// Batch updates\n    pub fn batch\u003cF, R\u003e(\u0026mut self, f: F) -\u003e R\n    where\n        F: FnOnce() -\u003e R\n    {\n        self.batch_depth += 1;\n        let result = f();\n        self.batch_depth -= 1;\n        \n        if self.batch_depth == 0 {\n            self.flush_updates();\n        }\n        \n        result\n    }\n    \n    /// Flush pending updates\n    pub fn flush_updates(\u0026mut self) -\u003e Vec\u003cContract\u003cSignalId, EffectExecution\u003e\u003e {\n        let updates = std::mem::take(\u0026mut self.update_queue);\n        \n        updates.into_iter().map(|signal_id| {\n            Contract::new(\n                signal_id,\n                EffectExecution {\n                    effects_to_run: vec![], // Would calculate affected effects\n                }\n            )\n        }).collect()\n    }\n    \n    /// Create effect\n    pub fn create_effect(\u0026mut self, id: EffectId) -\u003e EffectHandle {\n        self.effects.push(EffectTracker {\n            id,\n            dependencies: Vec::new(),\n            cleanup: None,\n            _layer: PhantomData,\n        });\n        \n        EffectHandle { id }\n    }\n    \n    /// Dispose effect\n    pub fn dispose_effect(\u0026mut self, handle: EffectHandle) {\n        if let Some(pos) = self.effects.iter().position(|e| e.id == handle.id) {\n            let effect = self.effects.remove(pos);\n            if let Some(cleanup) = effect.cleanup {\n                cleanup();\n            }\n        }\n    }\n}\n\n/// Effect handle\npub struct EffectHandle {\n    id: EffectId,\n}\n\n/// Effect execution descriptor\npub struct EffectExecution {\n    pub effects_to_run: Vec\u003cEffectId\u003e,\n}\n\n/// Signal update contract (L1 → L2)\npub struct SignalUpdateContract;\n\nimpl SignalUpdateContract {\n    pub fn transform(signal: Signal\u003ci32, L1\u003e) -\u003e Contract\u003cSignal\u003ci32, L1\u003e, SignalRuntime\u003cL2\u003e\u003e {\n        let mut runtime = SignalRuntime::new();\n        runtime.schedule_update(signal.id);\n        Contract::new(signal, runtime)\n    }\n}\n\n// ==================== L3: Reactive Bindings Layer ====================\n\n/// DOM binding (L3)\npub struct DomBinding\u003cL: Layer\u003e {\n    pub element: web_sys::Element,\n    pub signal_id: SignalId,\n    pub update_fn: ElementUpdateFn,\n    _layer: PhantomData\u003cL\u003e,\n}\n\n/// Reactive system (L3)\npub struct ReactiveSystem\u003cL: Layer\u003e {\n    /// Signal runtime contract\n    #[allow(dead_code)]\n    runtime: Contract\u003cSignalRuntime\u003cL2\u003e, ()\u003e,\n    /// DOM bindings\n    bindings: Vec\u003cDomBinding\u003cL\u003e\u003e,\n    /// Signal subscriptions\n    subscriptions: SignalSubscriptions,\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for ReactiveSystem\u003cL3\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ReactiveSystem\u003cL3\u003e {\n    pub fn new() -\u003e Self {\n        Self {\n            runtime: Contract::new(SignalRuntime::new(), ()),\n            bindings: Vec::new(),\n            subscriptions: SignalSubscriptions::new(),\n            _layer: PhantomData,\n        }\n    }\n    \n    /// Bind signal to DOM element\n    pub fn bind_to_dom\u003cT: 'static\u003e(\n        \u0026mut self,\n        signal_id: SignalId,\n        element: web_sys::Element,\n        update_fn: impl Fn(\u0026web_sys::Element, \u0026T) + 'static,\n    ) {\n        self.bindings.push(DomBinding {\n            element,\n            signal_id,\n            update_fn: Box::new(move |el: \u0026web_sys::Element, val: \u0026dyn std::any::Any| {\n                if let Some(typed_val) = val.downcast_ref::\u003cT\u003e() {\n                    update_fn(el, typed_val);\n                }\n            }) as ElementUpdateFn,\n            _layer: PhantomData,\n        });\n    }\n    \n    /// Subscribe to signal changes\n    pub fn subscribe\u003cT: 'static\u003e(\n        \u0026mut self,\n        signal_id: SignalId,\n        callback: impl Fn(\u0026T) + 'static,\n    ) {\n        self.subscriptions\n            .entry(signal_id)\n            .or_default()\n            .push(Box::new(move |val: \u0026dyn std::any::Any| {\n                if let Some(typed_val) = val.downcast_ref::\u003cT\u003e() {\n                    callback(typed_val);\n                }\n            }) as SignalCallback);\n    }\n    \n    /// Execute effect contracts from runtime\n    pub fn execute_effects(\u0026mut self, contracts: Vec\u003cContract\u003cSignalId, EffectExecution\u003e\u003e) {\n        for contract in contracts {\n            let signal_id = contract.input;\n            \n            // Update DOM bindings\n            for binding in \u0026self.bindings {\n                if binding.signal_id == signal_id {\n                    // In real implementation, would get signal value\n                    // (binding.update_fn)(\u0026binding.element, \u0026value);\n                }\n            }\n            \n            // Call subscriptions\n            if let Some(subs) = self.subscriptions.get(\u0026signal_id) {\n                for _sub in subs {\n                    // sub(\u0026value);\n                }\n            }\n        }\n    }\n}\n\n// ==================== Example Usage ====================\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_pure_signal_operations() {\n        // L1: Pure signal operations\n        let signal = Signal::\u003ci32, L1\u003e::new(42, SignalId(1));\n        assert_eq!(signal.get(), 42);\n        \n        let updated = signal.with_value(100);\n        assert_eq!(updated.get(), 100);\n        assert_eq!(signal.get(), 42); // Original unchanged\n    }\n    \n    #[test]\n    fn test_dependency_graph() {\n        use graph::DependencyGraph;\n        \n        let graph = DependencyGraph::default();\n        let graph = graph.add_dependency(SignalId(2), SignalId(1));\n        let graph = graph.add_dependency(SignalId(3), SignalId(2));\n        \n        let deps = graph.get_dependents(SignalId(1));\n        assert_eq!(deps, vec![SignalId(2)]);\n        \n        let order = graph.topological_sort(SignalId(1));\n        assert_eq!(order, vec![SignalId(1), SignalId(2), SignalId(3)]);\n    }\n    \n    #[test]\n    fn test_runtime_effect_tracking() {\n        let mut runtime = SignalRuntime::\u003cL2\u003e::new();\n        \n        let effect_id = EffectId(1);\n        let _handle = runtime.create_effect(effect_id);\n        \n        runtime.start_tracking(effect_id);\n        runtime.track_signal_access(SignalId(1));\n        runtime.track_signal_access(SignalId(2));\n        let _deps = runtime.stop_tracking();\n        \n        // Verify dependencies were tracked\n        assert_eq!(runtime.effects[0].dependencies.len(), 2);\n    }\n}","traces":[{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":52,"address":[],"length":0,"stats":{"Line":5}},{"line":53,"address":[],"length":0,"stats":{"Line":5}},{"line":57,"address":[],"length":0,"stats":{"Line":2}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":68,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":103,"address":[],"length":0,"stats":{"Line":4}},{"line":104,"address":[],"length":0,"stats":{"Line":4}},{"line":106,"address":[],"length":0,"stats":{"Line":4}},{"line":107,"address":[],"length":0,"stats":{"Line":4}},{"line":109,"address":[],"length":0,"stats":{"Line":4}},{"line":111,"address":[],"length":0,"stats":{"Line":4}},{"line":112,"address":[],"length":0,"stats":{"Line":4}},{"line":114,"address":[],"length":0,"stats":{"Line":4}},{"line":116,"address":[],"length":0,"stats":{"Line":4}},{"line":120,"address":[],"length":0,"stats":{"Line":7}},{"line":121,"address":[],"length":0,"stats":{"Line":7}},{"line":122,"address":[],"length":0,"stats":{"Line":7}},{"line":128,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":2}},{"line":130,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":2}},{"line":133,"address":[],"length":0,"stats":{"Line":14}},{"line":135,"address":[],"length":0,"stats":{"Line":6}},{"line":136,"address":[],"length":0,"stats":{"Line":10}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":147,"address":[],"length":0,"stats":{"Line":4}},{"line":149,"address":[],"length":0,"stats":{"Line":4}},{"line":150,"address":[],"length":0,"stats":{"Line":4}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":3}},{"line":192,"address":[],"length":0,"stats":{"Line":3}},{"line":194,"address":[],"length":0,"stats":{"Line":3}},{"line":201,"address":[],"length":0,"stats":{"Line":2}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":206,"address":[],"length":0,"stats":{"Line":2}},{"line":207,"address":[],"length":0,"stats":{"Line":2}},{"line":209,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":4}},{"line":214,"address":[],"length":0,"stats":{"Line":8}},{"line":216,"address":[],"length":0,"stats":{"Line":8}},{"line":217,"address":[],"length":0,"stats":{"Line":4}},{"line":218,"address":[],"length":0,"stats":{"Line":4}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":265,"address":[],"length":0,"stats":{"Line":2}},{"line":266,"address":[],"length":0,"stats":{"Line":2}},{"line":267,"address":[],"length":0,"stats":{"Line":2}},{"line":268,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":2}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":1}},{"line":338,"address":[],"length":0,"stats":{"Line":1}},{"line":339,"address":[],"length":0,"stats":{"Line":1}},{"line":340,"address":[],"length":0,"stats":{"Line":1}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}}],"covered":55,"coverable":107},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","tests","basic_tests.rs"],"content":"//! Basic HAF Tests\n\nuse crate::haf::{\n    layers::{L1, L2, L3},\n    Layer, Contract,\n    component::{VNode, VProps},\n};\n\n#[test]\nfn test_layer_types_exist() {\n    // Verify layer types are zero-sized\n    assert_eq!(std::mem::size_of::\u003cL1\u003e(), 0);\n    assert_eq!(std::mem::size_of::\u003cL2\u003e(), 0);\n    assert_eq!(std::mem::size_of::\u003cL3\u003e(), 0);\n}\n\n#[test]\nfn test_contract_creation() {\n    let input = \"L1 data\";\n    let output = \"L2 result\";\n    let contract = Contract::new(input, output);\n    \n    assert_eq!(contract.input, \"L1 data\");\n    assert_eq!(contract.output, \"L2 result\");\n}\n\n#[test]\nfn test_vnode_creation() {\n    // Test text node\n    let text_node: VNode\u003cL1\u003e = VNode::Text(\"Hello\".to_string());\n    assert!(matches!(text_node, VNode::Text(_)));\n    \n    // Test element node\n    let element_node: VNode\u003cL1\u003e = VNode::Element {\n        tag: \"div\".to_string(),\n        props: VProps::default(),\n        children: vec![],\n    };\n    assert!(matches!(element_node, VNode::Element { .. }));\n}\n\n#[test]\nfn test_layer_depth() {\n    assert_eq!(L1::DEPTH, 1);\n    assert_eq!(L2::DEPTH, 2);\n    assert_eq!(L3::DEPTH, 3);\n}\n\n#[test]\nfn test_layer_names() {\n    assert_eq!(L1::NAME, \"Core\");\n    assert_eq!(L2::NAME, \"Runtime\");\n    assert_eq!(L3::NAME, \"Framework\");\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","tests","mod.rs"],"content":"//! HAF Test Suite\n\nmod reactive_tests;\nmod basic_tests;\n\n#[cfg(test)]\nmod contract_tests {\n    use crate::haf::Contract;\n    \n    #[test]\n    fn test_contract_transformation() {\n        // Contracts enforce type-safe layer transitions\n        let input = \"L1 Data\";\n        let output = \"L2 Processed\";\n        \n        let contract = Contract::new(input, output);\n        \n        assert_eq!(contract.input, \"L1 Data\");\n        assert_eq!(contract.output, \"L2 Processed\");\n    }\n}\n\n#[cfg(test)]\nmod compile_time_tests {\n    use crate::haf::{layers::*, Layer, CanDepend};\n    \n    // These tests verify compile-time enforcement\n    \n    fn assert_can_depend\u003cFrom: CanDepend\u003cTo\u003e, To: Layer\u003e() {}\n    \n    #[test]\n    fn test_valid_dependencies_compile() {\n        // These should compile\n        assert_can_depend::\u003cL3, L2\u003e();\n        assert_can_depend::\u003cL3, L1\u003e();\n        assert_can_depend::\u003cL2, L1\u003e();\n        assert_can_depend::\u003cL1, L1\u003e();\n        assert_can_depend::\u003cL2, L2\u003e();\n        assert_can_depend::\u003cL3, L3\u003e();\n    }\n    \n    // Uncomment to verify these fail to compile:\n    // #[test]\n    // fn test_invalid_dependencies_fail() {\n    //     assert_can_depend::\u003cL1, L2\u003e(); // ERROR: L1 cannot depend on L2\n    //     assert_can_depend::\u003cL1, L3\u003e(); // ERROR: L1 cannot depend on L3\n    //     assert_can_depend::\u003cL2, L3\u003e(); // ERROR: L2 cannot depend on L3\n    // }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","tests","reactive_tests.rs"],"content":"//! HAF Reactive System Tests\n\nuse crate::haf::{\n    layers::{L1, L2, L3},\n    reactive::*,\n    Contract,\n};\n\n#[test]\nfn test_signal_layer_separation() {\n    // L1: Pure signal operations\n    let signal = Signal::\u003ci32, L1\u003e::new(42, SignalId(1));\n    let updated = signal.with_value(100);\n    \n    // Signals are immutable at L1\n    assert_eq!(signal.get(), 42);\n    assert_eq!(updated.get(), 100);\n}\n\n#[test]\nfn test_computed_values_are_pure() {\n    // L1: Pure computed values\n    let computed = Computed::\u003ci32, L1\u003e::new(\n        SignalId(10),\n        vec![SignalId(1), SignalId(2)],\n        |deps| {\n            // Pure computation\n            deps.len() as i32 * 10\n        },\n        0\n    );\n    \n    // Computed values don't have side effects\n    let _result = computed.recompute(\u0026[]);\n    assert_eq!(computed.value, 0); // Original unchanged\n}\n\n#[test]\nfn test_runtime_effect_isolation() {\n    // L2: Effect runtime\n    let mut runtime = SignalRuntime::\u003cL2\u003e::new();\n    \n    // Effects are managed at L2\n    let effect_id = EffectId(1);\n    let _handle = runtime.create_effect(effect_id);\n    \n    // Track dependencies\n    runtime.start_tracking(effect_id);\n    runtime.track_signal_access(SignalId(1));\n    runtime.track_signal_access(SignalId(2));\n    let _deps = runtime.stop_tracking();\n    \n    // Test contract creation directly\n    let contract = Contract::new(\n        SignalId(1),\n        EffectExecution {\n            effects_to_run: vec![],\n        }\n    );\n    \n    // Contracts enforce layer boundaries\n    assert_eq!(contract.input, SignalId(1));\n    \n    // The runtime exists and can manage effects - that's the key isolation\n}\n\n#[test]\nfn test_dom_bindings_at_l3_only() {\n    // L3: DOM operations\n    let _system = ReactiveSystem::\u003cL3\u003e::new();\n    \n    // DOM bindings only exist at L3\n    // This would fail to compile at L1 or L2:\n    // let mut system = ReactiveSystem::\u003cL1\u003e::new(); // ERROR!\n}\n\n#[test]\nfn test_dependency_graph_is_pure() {\n    use crate::haf::reactive::graph::DependencyGraph;\n    \n    // L1: Pure dependency tracking\n    let graph = DependencyGraph::default();\n    \n    // All operations are pure and return new graphs\n    let graph2 = graph.add_dependency(SignalId(2), SignalId(1));\n    let graph3 = graph2.add_dependency(SignalId(3), SignalId(2));\n    \n    // Original graph unchanged\n    assert!(graph.dependents.is_empty());\n    assert!(!graph3.dependents.is_empty());\n    \n    // Topological sort is pure\n    let order = graph3.topological_sort(SignalId(1));\n    assert_eq!(order.len(), 3);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","haf","vdom.rs"],"content":"//! HAF-compliant Virtual DOM System\n//! \n//! This module separates VDOM concerns across layers:\n//! - L1: Pure diff algorithm and patch generation\n//! - L2: Patch application runtime\n//! - L3: DOM API bindings\n\nuse crate::haf::{layers::{L1, L2, L3}, Layer, Contract};\nuse crate::haf::component::{VNode, VProps, EventId};\nuse std::marker::PhantomData;\n#[cfg(target_arch = \"wasm32\")]\nuse wasm_bindgen::JsCast;\n\n// ==================== L1: Pure Diff Algorithm ====================\n\n/// Pure patch representation (L1)\n#[derive(Debug, PartialEq)]\npub enum Patch\u003cL: Layer\u003e {\n    Replace(VNode\u003cL\u003e),\n    UpdateText(String),\n    UpdateElement(Vec\u003cPropPatch\u003e),\n    InsertChild(usize, VNode\u003cL\u003e),\n    RemoveChild(usize),\n    MoveChild(usize, usize),\n    _Layer(PhantomData\u003cL\u003e),\n}\n\nimpl\u003cL: Layer\u003e Clone for Patch\u003cL\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        match self {\n            Patch::Replace(vnode) =\u003e Patch::Replace(vnode.clone()),\n            Patch::UpdateText(text) =\u003e Patch::UpdateText(text.clone()),\n            Patch::UpdateElement(patches) =\u003e Patch::UpdateElement(patches.clone()),\n            Patch::InsertChild(index, vnode) =\u003e Patch::InsertChild(*index, vnode.clone()),\n            Patch::RemoveChild(index) =\u003e Patch::RemoveChild(*index),\n            Patch::MoveChild(from, to) =\u003e Patch::MoveChild(*from, *to),\n            Patch::_Layer(p) =\u003e Patch::_Layer(*p),\n        }\n    }\n}\n\n/// Property patch (L1)\n#[derive(Debug, Clone, PartialEq)]\npub enum PropPatch {\n    SetClass(Option\u003cString\u003e),\n    SetId(Option\u003cString\u003e),\n    SetStyle(Option\u003cString\u003e),\n    SetAttribute(String, Option\u003cString\u003e),\n    AddEvent(String, EventId),\n    RemoveEvent(String),\n}\n\n/// Pure VDOM diff algorithm (L1)\npub struct VDomDiff\u003cL: Layer\u003e {\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for VDomDiff\u003cL1\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl VDomDiff\u003cL1\u003e {\n    pub fn new() -\u003e Self {\n        Self { _layer: PhantomData }\n    }\n    \n    /// Diff two VNodes and generate patches\n    pub fn diff(\u0026self, old: \u0026VNode\u003cL1\u003e, new: \u0026VNode\u003cL1\u003e) -\u003e Vec\u003cPatch\u003cL1\u003e\u003e {\n        let mut patches = Vec::new();\n        self.diff_nodes(old, new, \u0026mut patches);\n        patches\n    }\n    \n    fn diff_nodes(\u0026self, old: \u0026VNode\u003cL1\u003e, new: \u0026VNode\u003cL1\u003e, patches: \u0026mut Vec\u003cPatch\u003cL1\u003e\u003e) {\n        match (old, new) {\n            (VNode::Text(old_text), VNode::Text(new_text)) =\u003e {\n                if old_text != new_text {\n                    patches.push(Patch::UpdateText(new_text.clone()));\n                }\n            }\n            \n            (VNode::Element { tag: old_tag, props: old_props, children: old_children },\n             VNode::Element { tag: new_tag, props: new_props, children: new_children }) =\u003e {\n                if old_tag != new_tag {\n                    patches.push(Patch::Replace(new.clone()));\n                } else {\n                    // Diff properties\n                    let prop_patches = self.diff_props(old_props, new_props);\n                    if !prop_patches.is_empty() {\n                        patches.push(Patch::UpdateElement(prop_patches));\n                    }\n                    \n                    // Diff children\n                    self.diff_children(old_children, new_children, patches);\n                }\n            }\n            \n            _ =\u003e {\n                // Different node types - replace\n                patches.push(Patch::Replace(new.clone()));\n            }\n        }\n    }\n    \n    fn diff_props(\u0026self, old: \u0026VProps, new: \u0026VProps) -\u003e Vec\u003cPropPatch\u003e {\n        let mut patches = Vec::new();\n        \n        if old.class != new.class {\n            patches.push(PropPatch::SetClass(new.class.clone()));\n        }\n        \n        if old.id != new.id {\n            patches.push(PropPatch::SetId(new.id.clone()));\n        }\n        \n        if old.style != new.style {\n            patches.push(PropPatch::SetStyle(new.style.clone()));\n        }\n        \n        // Diff attributes\n        for (key, new_value) in \u0026new.attributes {\n            if old.attributes.iter().find(|(k, _)| k == key).map(|(_, v)| v) != Some(new_value) {\n                patches.push(PropPatch::SetAttribute(key.clone(), Some(new_value.clone())));\n            }\n        }\n        \n        // Remove old attributes not in new\n        for (key, _) in \u0026old.attributes {\n            if !new.attributes.iter().any(|(k, _)| k == key) {\n                patches.push(PropPatch::SetAttribute(key.clone(), None));\n            }\n        }\n        \n        // Diff events\n        for (event, id) in \u0026new.events {\n            if !old.events.iter().any(|(e, _)| e == event) {\n                patches.push(PropPatch::AddEvent(event.clone(), *id));\n            }\n        }\n        \n        for (event, _) in \u0026old.events {\n            if !new.events.iter().any(|(e, _)| e == event) {\n                patches.push(PropPatch::RemoveEvent(event.clone()));\n            }\n        }\n        \n        patches\n    }\n    \n    fn diff_children(\u0026self, old: \u0026[VNode\u003cL1\u003e], new: \u0026[VNode\u003cL1\u003e], patches: \u0026mut Vec\u003cPatch\u003cL1\u003e\u003e) {\n        // Simple algorithm - can be optimized with keyed diffing\n        let mut i = 0;\n        \n        while i \u003c old.len() \u0026\u0026 i \u003c new.len() {\n            self.diff_nodes(\u0026old[i], \u0026new[i], patches);\n            i += 1;\n        }\n        \n        // Remove extra old children\n        while i \u003c old.len() {\n            patches.push(Patch::RemoveChild(i));\n            i += 1;\n        }\n        \n        // Add new children\n        while i \u003c new.len() {\n            patches.push(Patch::InsertChild(i, new[i].clone()));\n            i += 1;\n        }\n    }\n}\n\n// ==================== L2: Patch Runtime ====================\n\n/// Patch application runtime (L2)\npub struct PatchRuntime\u003cL: Layer\u003e {\n    patches: Vec\u003cPatch\u003cL1\u003e\u003e,\n    operations: Vec\u003cDomOperation\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for PatchRuntime\u003cL2\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl PatchRuntime\u003cL2\u003e {\n    pub fn new() -\u003e Self {\n        Self {\n            patches: Vec::new(),\n            operations: Vec::new(),\n            _layer: PhantomData,\n        }\n    }\n    \n    /// Apply patches and generate DOM operations\n    pub fn apply_patches(\u0026mut self, patches: Vec\u003cPatch\u003cL1\u003e\u003e) -\u003e Vec\u003cContract\u003cPatch\u003cL1\u003e, DomOperation\u003e\u003e {\n        self.patches = patches;\n        let mut contracts = Vec::new();\n        \n        for patch in self.patches.clone() {\n            let operation = self.patch_to_operation(\u0026patch);\n            contracts.push(Contract::new(patch, operation));\n        }\n        \n        contracts\n    }\n    \n    fn patch_to_operation(\u0026self, patch: \u0026Patch\u003cL1\u003e) -\u003e DomOperation {\n        match patch {\n            Patch::Replace(vnode) =\u003e DomOperation::ReplaceNode {\n                handle: DomHandle { node_id: 0 }, // TODO: Proper handle management\n                new_vnode: vnode.clone(),\n            },\n            \n            Patch::UpdateText(text) =\u003e DomOperation::SetTextContent {\n                handle: DomHandle { node_id: 0 },\n                text: text.clone(),\n            },\n            \n            Patch::UpdateElement(prop_patches) =\u003e DomOperation::UpdateProperties {\n                handle: DomHandle { node_id: 0 },\n                patches: prop_patches.clone(),\n            },\n            \n            Patch::InsertChild(index, vnode) =\u003e DomOperation::InsertChild {\n                parent: DomHandle { node_id: 0 },\n                index: *index,\n                child: vnode.clone(),\n            },\n            \n            Patch::RemoveChild(index) =\u003e DomOperation::RemoveChild {\n                parent: DomHandle { node_id: 0 },\n                index: *index,\n            },\n            \n            Patch::MoveChild(from, to) =\u003e DomOperation::MoveChild {\n                parent: DomHandle { node_id: 0 },\n                from: *from,\n                to: *to,\n            },\n            \n            _ =\u003e DomOperation::NoOp,\n        }\n    }\n    \n    /// Handle events (L2)\n    pub fn handle_event(\u0026self, event_id: EventId) -\u003e Option\u003cBox\u003cdyn Fn()\u003e\u003e {\n        // Look up event handler\n        // In real implementation, would maintain event handler registry\n        self.operations\n            .iter()\n            .find_map(|op| match op {\n                DomOperation::UpdateProperties { patches, .. } =\u003e {\n                    patches.iter().find_map(|patch| match patch {\n                        PropPatch::AddEvent(_, id) if *id == event_id =\u003e {\n                            Some(Box::new(|| println!(\"Event handled!\")) as Box\u003cdyn Fn()\u003e)\n                        }\n                        _ =\u003e None,\n                    })\n                }\n                _ =\u003e None,\n            })\n            .or_else(|| None)\n    }\n}\n\n/// DOM operation descriptor (L2/L3 boundary)\npub enum DomOperation {\n    ReplaceNode { handle: DomHandle, new_vnode: VNode\u003cL1\u003e },\n    SetTextContent { handle: DomHandle, text: String },\n    UpdateProperties { handle: DomHandle, patches: Vec\u003cPropPatch\u003e },\n    InsertChild { parent: DomHandle, index: usize, child: VNode\u003cL1\u003e },\n    RemoveChild { parent: DomHandle, index: usize },\n    MoveChild { parent: DomHandle, from: usize, to: usize },\n    NoOp,\n}\n\n/// DOM node handle (L2/L3 boundary)\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub struct DomHandle {\n    node_id: u64,\n}\n\n// ==================== L3: DOM Bindings ====================\n\n/// DOM renderer (L3)\n#[cfg(target_arch = \"wasm32\")]\npub struct DomRenderer\u003cL: Layer\u003e {\n    document: web_sys::Document,\n    nodes: Vec\u003c(u64, web_sys::Node)\u003e,\n    _layer: PhantomData\u003cL\u003e,\n}\n\n#[cfg(not(target_arch = \"wasm32\"))]\npub struct DomRenderer\u003cL: Layer\u003e {\n    _layer: PhantomData\u003cL\u003e,\n}\n\nimpl Default for DomRenderer\u003cL3\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl DomRenderer\u003cL3\u003e {\n    pub fn new() -\u003e Self {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            Self {\n                document: web_sys::window().unwrap().document().unwrap(),\n                nodes: Vec::new(),\n                _layer: PhantomData,\n            }\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            Self {\n                _layer: PhantomData,\n            }\n        }\n    }\n    \n    /// Execute DOM operations\n    pub fn execute_operations(\u0026mut self, operations: Vec\u003cContract\u003cPatch\u003cL1\u003e, DomOperation\u003e\u003e) {\n        for contract in operations {\n            self.execute_operation(\u0026contract.output);\n        }\n    }\n    \n    #[cfg(target_arch = \"wasm32\")]\n    fn execute_operation(\u0026mut self, operation: \u0026DomOperation) {\n        match operation {\n            DomOperation::ReplaceNode { handle, new_vnode } =\u003e {\n                if let Some(node) = self.get_node(handle) {\n                    let new_node = self.create_dom_node(new_vnode);\n                    if let Some(parent) = node.parent_node() {\n                        parent.replace_child(\u0026new_node, \u0026node).unwrap();\n                        self.update_node(handle, new_node);\n                    }\n                }\n            }\n            \n            DomOperation::SetTextContent { handle, text } =\u003e {\n                if let Some(node) = self.get_node(handle) {\n                    node.set_text_content(Some(text));\n                }\n            }\n            \n            DomOperation::UpdateProperties { handle, patches } =\u003e {\n                if let Some(node) = self.get_node(handle) {\n                    if let Some(element) = node.dyn_ref::\u003cweb_sys::Element\u003e() {\n                        for patch in patches {\n                            self.apply_prop_patch(element, patch);\n                        }\n                    }\n                }\n            }\n            \n            DomOperation::InsertChild { parent, index, child } =\u003e {\n                if let Some(parent_node) = self.get_node(parent) {\n                    let child_node = self.create_dom_node(child);\n                    let children = parent_node.child_nodes();\n                    if (*index as u32) \u003c children.length() {\n                        let before = children.get(*index as u32).unwrap();\n                        parent_node.insert_before(\u0026child_node, Some(\u0026before)).unwrap();\n                    } else {\n                        parent_node.append_child(\u0026child_node).unwrap();\n                    }\n                }\n            }\n            \n            DomOperation::RemoveChild { parent, index } =\u003e {\n                if let Some(parent_node) = self.get_node(parent) {\n                    let children = parent_node.child_nodes();\n                    if let Some(child) = children.get(*index as u32) {\n                        parent_node.remove_child(\u0026child).unwrap();\n                    }\n                }\n            }\n            \n            DomOperation::MoveChild { parent, from, to } =\u003e {\n                if let Some(parent_node) = self.get_node(parent) {\n                    let children = parent_node.child_nodes();\n                    if let Some(child) = children.get(*from as u32) {\n                        parent_node.remove_child(\u0026child).unwrap();\n                        \n                        let children = parent_node.child_nodes();\n                        if *to \u003c children.length() as usize {\n                            let before = children.get(*to as u32).unwrap();\n                            parent_node.insert_before(\u0026child, Some(\u0026before)).unwrap();\n                        } else {\n                            parent_node.append_child(\u0026child).unwrap();\n                        }\n                    }\n                }\n            }\n            \n            DomOperation::NoOp =\u003e {}\n        }\n    }\n    \n    #[cfg(not(target_arch = \"wasm32\"))]\n    fn execute_operation(\u0026mut self, _operation: \u0026DomOperation) {\n        // No-op for non-wasm targets\n    }\n    \n    #[cfg(target_arch = \"wasm32\")]\n    fn get_node(\u0026self, handle: \u0026DomHandle) -\u003e Option\u003c\u0026web_sys::Node\u003e {\n        self.nodes\n            .iter()\n            .find(|(id, _)| id == \u0026handle.node_id)\n            .map(|(_, node)| node)\n    }\n    \n    #[cfg(target_arch = \"wasm32\")]\n    fn update_node(\u0026mut self, handle: \u0026DomHandle, node: web_sys::Node) {\n        if let Some((_, old_node)) = self.nodes.iter_mut().find(|(id, _)| id == \u0026handle.node_id) {\n            *old_node = node;\n        } else {\n            self.nodes.push((handle.node_id, node));\n        }\n    }\n    \n    #[cfg(target_arch = \"wasm32\")]\n    fn create_dom_node(\u0026self, vnode: \u0026VNode\u003cL1\u003e) -\u003e web_sys::Node {\n        match vnode {\n            VNode::Text(text) =\u003e {\n                self.document.create_text_node(text).into()\n            }\n            \n            VNode::Element { tag, props, children } =\u003e {\n                let element = self.document.create_element(tag).unwrap();\n                \n                // Apply properties\n                if let Some(class) = \u0026props.class {\n                    element.set_class_name(class);\n                }\n                if let Some(id) = \u0026props.id {\n                    element.set_id(id);\n                }\n                if let Some(style) = \u0026props.style {\n                    element.set_attribute(\"style\", style).unwrap();\n                }\n                \n                for (key, value) in \u0026props.attributes {\n                    element.set_attribute(key, value).unwrap();\n                }\n                \n                // Add children\n                for child in children {\n                    let child_node = self.create_dom_node(child);\n                    element.append_child(\u0026child_node).unwrap();\n                }\n                \n                element.into()\n            }\n            \n            _ =\u003e {\n                // For other node types, create a placeholder\n                self.document.create_text_node(\"\").into()\n            }\n        }\n    }\n    \n    #[cfg(target_arch = \"wasm32\")]\n    fn apply_prop_patch(\u0026self, element: \u0026web_sys::Element, patch: \u0026PropPatch) {\n        match patch {\n            PropPatch::SetClass(class) =\u003e {\n                if let Some(class) = class {\n                    element.set_class_name(class);\n                } else {\n                    element.remove_attribute(\"class\").unwrap();\n                }\n            }\n            \n            PropPatch::SetId(id) =\u003e {\n                if let Some(id) = id {\n                    element.set_id(id);\n                } else {\n                    element.remove_attribute(\"id\").unwrap();\n                }\n            }\n            \n            PropPatch::SetStyle(style) =\u003e {\n                if let Some(style) = style {\n                    element.set_attribute(\"style\", style).unwrap();\n                } else {\n                    element.remove_attribute(\"style\").unwrap();\n                }\n            }\n            \n            PropPatch::SetAttribute(key, value) =\u003e {\n                if let Some(value) = value {\n                    element.set_attribute(key, value).unwrap();\n                } else {\n                    element.remove_attribute(key).unwrap();\n                }\n            }\n            \n            PropPatch::AddEvent(event, _id) =\u003e {\n                // TODO: Implement event handling\n                println!(\"Adding event: {}\", event);\n            }\n            \n            PropPatch::RemoveEvent(event) =\u003e {\n                // TODO: Implement event removal\n                println!(\"Removing event: {}\", event);\n            }\n        }\n    }\n}\n\n/// L1 to L2 contract for VDOM operations\npub struct VDomContract;\n\nimpl L1ToL2Contract for VDomContract {\n    type L1Type = Vec\u003cPatch\u003cL1\u003e\u003e;\n    type L2Type = Vec\u003cDomOperation\u003e;\n    \n    fn translate(patches: Self::L1Type) -\u003e Self::L2Type {\n        let mut runtime = PatchRuntime::\u003cL2\u003e::new();\n        runtime.apply_patches(patches)\n            .into_iter()\n            .map(|contract| contract.output)\n            .collect()\n    }\n}\n\n/// Trait for L1 to L2 contracts\npub trait L1ToL2Contract {\n    type L1Type;\n    type L2Type;\n    \n    fn translate(input: Self::L1Type) -\u003e Self::L2Type;\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_simple_diff() {\n        let diff = VDomDiff::\u003cL1\u003e::new();\n        \n        let old = VNode::Text(\"Hello\".to_string());\n        let new = VNode::Text(\"World\".to_string());\n        \n        let patches = diff.diff(\u0026old, \u0026new);\n        assert_eq!(patches.len(), 1);\n        assert!(matches!(patches[0], Patch::UpdateText(ref s) if s == \"World\"));\n    }\n    \n    #[test]\n    fn test_element_diff() {\n        let diff = VDomDiff::\u003cL1\u003e::new();\n        \n        let old = VNode::Element {\n            tag: \"div\".to_string(),\n            props: VProps {\n                class: Some(\"old\".to_string()),\n                ..Default::default()\n            },\n            children: vec![],\n        };\n        \n        let new = VNode::Element {\n            tag: \"div\".to_string(),\n            props: VProps {\n                class: Some(\"new\".to_string()),\n                ..Default::default()\n            },\n            children: vec![],\n        };\n        \n        let patches = diff.diff(\u0026old, \u0026new);\n        assert_eq!(patches.len(), 1);\n        assert!(matches!(patches[0], Patch::UpdateElement(ref props) if props.len() == 1));\n    }\n}","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":71,"address":[],"length":0,"stats":{"Line":2}},{"line":72,"address":[],"length":0,"stats":{"Line":2}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":2}},{"line":80,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":2}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":1}},{"line":152,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":1}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":1}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":1}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}}],"covered":32,"coverable":111},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","hooks.rs"],"content":"//! React-style Hooks for Layer9 - L5\n//!\n//! This module provides a comprehensive hooks system for managing component\n//! state, effects, memoization, and more. All hooks integrate with the\n//! reactive rendering system for automatic updates.\n\nuse std::any::{Any, TypeId};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\n\nuse crate::reactive_v2::{get_current_component, run_current_effect};\n\nthread_local! {\n    /// Global hook state storage per component\n    static HOOK_STATE: RefCell\u003cHashMap\u003cu32, ComponentHooks\u003e\u003e = RefCell::new(HashMap::new());\n    \n    /// Current hook index for the executing component\n    static CURRENT_HOOK_INDEX: RefCell\u003cusize\u003e = const { RefCell::new(0) };\n}\n\n/// Storage for all hooks of a component\nstruct ComponentHooks {\n    hooks: Vec\u003cBox\u003cdyn Any\u003e\u003e,\n}\n\nimpl ComponentHooks {\n    fn new() -\u003e Self {\n        ComponentHooks { hooks: Vec::new() }\n    }\n}\n\n/// Reset hook index before rendering a component\npub fn reset_hook_index() {\n    CURRENT_HOOK_INDEX.with(|index| {\n        *index.borrow_mut() = 0;\n    });\n}\n\n/// Get or create hook state for a component\nfn use_hook_state\u003cT: 'static, F: FnOnce() -\u003e T\u003e(init: F) -\u003e Rc\u003cRefCell\u003cT\u003e\u003e {\n    let component_id = get_current_component().expect(\"Hooks can only be called during render\");\n    \n    HOOK_STATE.with(|state| {\n        let mut state = state.borrow_mut();\n        let component_hooks = state.entry(component_id).or_insert_with(ComponentHooks::new);\n        \n        let hook_index = CURRENT_HOOK_INDEX.with(|index| {\n            let current = *index.borrow();\n            *index.borrow_mut() = current + 1;\n            current\n        });\n        \n        // Get or create hook at this index\n        if hook_index \u003c component_hooks.hooks.len() {\n            // Hook already exists, return it\n            component_hooks.hooks[hook_index]\n                .downcast_ref::\u003cRc\u003cRefCell\u003cT\u003e\u003e\u003e()\n                .expect(\"Hook type mismatch\")\n                .clone()\n        } else {\n            // Create new hook\n            let hook = Rc::new(RefCell::new(init()));\n            component_hooks.hooks.push(Box::new(hook.clone()));\n            hook\n        }\n    })\n}\n\n/// State hook with functional updates\npub fn use_state\u003cT: Clone + 'static\u003e(initial: T) -\u003e (T, impl Fn(T) + Clone) {\n    let state = use_hook_state(|| initial);\n    \n    let value = state.borrow().clone();\n    let state_clone = state.clone();\n    \n    // Capture the component ID at hook creation time\n    let component_id = get_current_component().expect(\"use_state must be called during render\");\n    \n    let set_state = move |new_value: T| {\n        *state_clone.borrow_mut() = new_value;\n        // Use the captured component ID to queue render\n        crate::reactive_v2::queue_component_render(component_id);\n    };\n    \n    (value, set_state)\n}\n\n/// Reducer function type\ntype ReducerFn\u003cS, A\u003e = dyn Fn(\u0026S, A) -\u003e S;\n\n/// State hook with reducer pattern\npub fn use_reducer\u003cS: Clone + 'static, A: 'static\u003e(\n    reducer: impl Fn(\u0026S, A) -\u003e S + 'static,\n    initial: S,\n) -\u003e (S, impl Fn(A) + Clone) {\n    #[derive(Clone)]\n    struct ReducerState\u003cS, A\u003e {\n        state: S,\n        reducer: Rc\u003cReducerFn\u003cS, A\u003e\u003e,\n    }\n    \n    let reducer_state = use_hook_state(|| ReducerState {\n        state: initial,\n        reducer: Rc::new(reducer),\n    });\n    \n    let current_state = reducer_state.borrow().state.clone();\n    let reducer_state_clone = reducer_state.clone();\n    \n    // Capture the component ID at hook creation time\n    let component_id = get_current_component().expect(\"use_reducer must be called during render\");\n    \n    let dispatch = move |action: A| {\n        let mut state = reducer_state_clone.borrow_mut();\n        let new_state = (state.reducer)(\u0026state.state, action);\n        state.state = new_state;\n        drop(state); // Release borrow before re-render\n        crate::reactive_v2::queue_component_render(component_id);\n    };\n    \n    (current_state, dispatch)\n}\n\n/// Effect state\nstruct EffectState {\n    deps: Option\u003cVec\u003cBox\u003cdyn Any\u003e\u003e\u003e,\n    cleanup: Option\u003cBox\u003cdyn FnOnce()\u003e\u003e,\n}\n\n/// Effect hook with dependencies\npub fn use_effect\u003cD, F, C\u003e(deps: D, effect: F)\nwhere\n    D: DepsList,\n    F: FnOnce() -\u003e C + 'static,\n    C: FnOnce() + 'static,\n{\n    let effect_state = use_hook_state(|| EffectState {\n        deps: None,\n        cleanup: None,\n    });\n    \n    let mut state = effect_state.borrow_mut();\n    let new_deps = deps.to_any_vec();\n    \n    // Check if dependencies changed\n    let should_run = match \u0026state.deps {\n        None =\u003e true, // First run\n        Some(old_deps) =\u003e {\n            // Compare dependencies\n            old_deps.len() != new_deps.len() || \n            !deps.deps_equal(old_deps)\n        }\n    };\n    \n    if should_run {\n        // Run cleanup from previous effect\n        if let Some(cleanup) = state.cleanup.take() {\n            cleanup();\n        }\n        \n        // Store new deps\n        state.deps = Some(new_deps);\n        \n        // Schedule effect to run after render\n        let effect_state_clone = effect_state.clone();\n        run_current_effect(move || {\n            let cleanup = effect();\n            let mut state = effect_state_clone.borrow_mut();\n            state.cleanup = Some(Box::new(cleanup));\n            Box::new(|| {}) as Box\u003cdyn FnOnce()\u003e\n        });\n    }\n}\n\n/// Memo hook for expensive computations\npub fn use_memo\u003cT: Clone + 'static, D, F\u003e(deps: D, compute: F) -\u003e T\nwhere\n    D: DepsList,\n    F: Fn() -\u003e T,\n{\n    struct MemoState\u003cT\u003e {\n        value: Option\u003cT\u003e,\n        deps: Option\u003cVec\u003cBox\u003cdyn Any\u003e\u003e\u003e,\n    }\n    \n    let memo_state = use_hook_state(|| {\n        MemoState {\n            value: None,\n            deps: None,\n        }\n    });\n    \n    let mut state = memo_state.borrow_mut();\n    let new_deps = deps.to_any_vec();\n    \n    // Check if dependencies changed or first run\n    let should_compute = match \u0026state.deps {\n        None =\u003e true,\n        Some(old_deps) =\u003e old_deps.len() != new_deps.len() || !deps.deps_equal(old_deps),\n    };\n    \n    if should_compute {\n        state.value = Some(compute());\n        state.deps = Some(new_deps);\n    }\n    \n    state.value.as_ref().unwrap().clone()\n}\n\n/// Callback hook to memoize functions\npub fn use_callback\u003cT, D, F\u003e(deps: D, callback: F) -\u003e T\nwhere\n    T: Clone + 'static,\n    D: DepsList,\n    F: Fn() -\u003e T,\n{\n    use_memo(deps, callback)\n}\n\n/// Ref hook for mutable values that don't trigger re-renders\npub fn use_ref\u003cT: 'static\u003e(initial: T) -\u003e Rc\u003cRefCell\u003cT\u003e\u003e {\n    use_hook_state(|| initial)\n}\n\n/// Layout effect hook (runs synchronously after DOM mutations)\npub fn use_layout_effect\u003cD, F, C\u003e(deps: D, effect: F)\nwhere\n    D: DepsList,\n    F: FnOnce() -\u003e C + 'static,\n    C: FnOnce() + 'static,\n{\n    // For now, same as use_effect\n    // In a real implementation, this would run synchronously\n    use_effect(deps, effect);\n}\n\n/// Context value storage\npub struct Context\u003cT: Clone + 'static\u003e {\n    id: TypeId,\n    _phantom: std::marker::PhantomData\u003cT\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e Context\u003cT\u003e {\n    pub fn new() -\u003e Self {\n        Context {\n            id: TypeId::of::\u003cT\u003e(),\n            _phantom: std::marker::PhantomData,\n        }\n    }\n}\n\nimpl\u003cT: Clone + 'static\u003e Default for Context\u003cT\u003e {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nthread_local! {\n    static CONTEXT_VALUES: RefCell\u003cHashMap\u003cTypeId, Box\u003cdyn Any\u003e\u003e\u003e = RefCell::new(HashMap::new());\n}\n\n/// Provide a context value\npub fn provide_context\u003cT: Clone + 'static\u003e(context: \u0026Context\u003cT\u003e, value: T) {\n    CONTEXT_VALUES.with(|values| {\n        values.borrow_mut().insert(context.id, Box::new(value));\n    });\n}\n\n/// Use a context value\npub fn use_context\u003cT: Clone + 'static\u003e(context: \u0026Context\u003cT\u003e) -\u003e Option\u003cT\u003e {\n    CONTEXT_VALUES.with(|values| {\n        values.borrow()\n            .get(\u0026context.id)\n            .and_then(|v| v.downcast_ref::\u003cT\u003e())\n            .cloned()\n    })\n}\n\n/// Trait for dependency lists\npub trait DepsList {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e;\n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool;\n}\n\n// Empty dependencies handled by macro below\n\n// Single dependency implementations for common types\nimpl DepsList for i32 {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n        vec![Box::new(*self)]\n    }\n    \n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n        other.len() == 1 \u0026\u0026 \n        other[0].downcast_ref::\u003ci32\u003e()\n            .map(|v| v == self)\n            .unwrap_or(false)\n    }\n}\n\nimpl DepsList for u32 {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n        vec![Box::new(*self)]\n    }\n    \n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n        other.len() == 1 \u0026\u0026 \n        other[0].downcast_ref::\u003cu32\u003e()\n            .map(|v| v == self)\n            .unwrap_or(false)\n    }\n}\n\nimpl DepsList for String {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n        vec![Box::new(self.clone())]\n    }\n    \n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n        other.len() == 1 \u0026\u0026 \n        other[0].downcast_ref::\u003cString\u003e()\n            .map(|v| v == self)\n            .unwrap_or(false)\n    }\n}\n\nimpl DepsList for bool {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n        vec![Box::new(*self)]\n    }\n    \n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n        other.len() == 1 \u0026\u0026 \n        other[0].downcast_ref::\u003cbool\u003e()\n            .map(|v| v == self)\n            .unwrap_or(false)\n    }\n}\n\nimpl DepsList for usize {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n        vec![Box::new(*self)]\n    }\n    \n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n        other.len() == 1 \u0026\u0026 \n        other[0].downcast_ref::\u003cusize\u003e()\n            .map(|v| v == self)\n            .unwrap_or(false)\n    }\n}\n\n/// Tuple dependencies (up to 12 elements)\nmacro_rules! impl_deps_list_tuple {\n    ($($T:ident),*) =\u003e {\n        impl\u003c$($T: PartialEq + Clone + 'static),*\u003e DepsList for ($($T,)*) {\n            fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n                #[allow(non_snake_case)]\n                let ($($T,)*) = self;\n                vec![$(Box::new($T.clone()) as Box\u003cdyn Any\u003e),*]\n            }\n            \n            fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n                #[allow(non_snake_case, unused_mut)]\n                let ($($T,)*) = self;\n                #[allow(unused_mut)]\n                let mut idx = 0;\n                $(\n                    if idx \u003e= other.len() {\n                        return false;\n                    }\n                    if !other[idx].downcast_ref::\u003c$T\u003e()\n                        .map(|v| v == $T)\n                        .unwrap_or(false) {\n                        return false;\n                    }\n                    idx += 1;\n                )*\n                idx == other.len()\n            }\n        }\n    };\n}\n\nimpl_deps_list_tuple!();\nimpl_deps_list_tuple!(A);\nimpl_deps_list_tuple!(A, B);\nimpl_deps_list_tuple!(A, B, C);\nimpl_deps_list_tuple!(A, B, C, D);\nimpl_deps_list_tuple!(A, B, C, D, E);\nimpl_deps_list_tuple!(A, B, C, D, E, F);\nimpl_deps_list_tuple!(A, B, C, D, E, F, G);\nimpl_deps_list_tuple!(A, B, C, D, E, F, G, H);\nimpl_deps_list_tuple!(A, B, C, D, E, F, G, H, I);\nimpl_deps_list_tuple!(A, B, C, D, E, F, G, H, I, J);\nimpl_deps_list_tuple!(A, B, C, D, E, F, G, H, I, J, K);\nimpl_deps_list_tuple!(A, B, C, D, E, F, G, H, I, J, K, L);\n\n/// Vec dependencies\nimpl\u003cT: PartialEq + Clone + 'static\u003e DepsList for Vec\u003cT\u003e {\n    fn to_any_vec(\u0026self) -\u003e Vec\u003cBox\u003cdyn Any\u003e\u003e {\n        self.iter().map(|v| Box::new(v.clone()) as Box\u003cdyn Any\u003e).collect()\n    }\n    \n    fn deps_equal(\u0026self, other: \u0026[Box\u003cdyn Any\u003e]) -\u003e bool {\n        self.len() == other.len() \u0026\u0026\n        self.iter().zip(other.iter()).all(|(a, b)| {\n            b.downcast_ref::\u003cT\u003e()\n                .map(|v| v == a)\n                .unwrap_or(false)\n        })\n    }\n}\n\n/// Cleanup hook state when component unmounts\npub fn cleanup_component_hooks(component_id: u32) {\n    HOOK_STATE.with(|state| {\n        if let Some(mut component_hooks) = state.borrow_mut().remove(\u0026component_id) {\n            // Run cleanup for all effect hooks\n            for hook in \u0026mut component_hooks.hooks {\n                if let Some(effect_state) = hook.downcast_mut::\u003cRc\u003cRefCell\u003cEffectState\u003e\u003e\u003e() {\n                    if let Some(cleanup) = effect_state.borrow_mut().cleanup.take() {\n                        cleanup();\n                    }\n                }\n            }\n        }\n    });\n}\n\n/// Custom hook example: useCounter\npub fn use_counter(initial: i32) -\u003e (i32, impl Fn() + Clone, impl Fn() + Clone) {\n    let (count, set_count) = use_state(initial);\n    \n    let increment = {\n        let set_count = set_count.clone();\n        move || set_count(count + 1)\n    };\n    \n    let decrement = {\n        let set_count = set_count.clone();\n        move || set_count(count - 1)\n    };\n    \n    (count, increment, decrement)\n}\n\n/// Custom hook example: usePrevious  \npub fn use_previous\u003cT\u003e(value: T) -\u003e Option\u003cT\u003e\nwhere\n    T: Clone + PartialEq + 'static + DepsList,\n{\n    let prev_ref = use_ref(None::\u003cT\u003e);\n    let prev_value = prev_ref.borrow().clone();\n    \n    use_effect(value.clone(), {\n        let prev_ref = prev_ref.clone();\n        let value = value.clone();\n        move || {\n            let mut prev = prev_ref.borrow_mut();\n            *prev = Some(value);\n            || {}\n        }\n    });\n    \n    prev_value\n}\n\n/// Custom hook example: useDebounce\npub fn use_debounce\u003cT\u003e(value: T, delay_ms: u32) -\u003e T\nwhere\n    T: Clone + PartialEq + 'static + DepsList,\n{\n    let (debounced, set_debounced) = use_state(value.clone());\n    \n    use_effect((value.clone(), delay_ms), {\n        let set_debounced = set_debounced.clone();\n        let value = value.clone();\n        move || {\n            // In a real implementation, we'd use setTimeout\n            // For now, just update immediately\n            set_debounced(value);\n            || {}\n        }\n    });\n    \n    debounced\n}","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":196},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","i18n.rs"],"content":"//! Internationalization (i18n) Support - L5/L6\n//! Multi-language support with dynamic locale switching\nuse serde::{Deserialize, Serialize};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\n\n// Type aliases to simplify complex types\ntype TranslateFn = Box\u003cdyn Fn(\u0026str, Option\u003c\u0026HashMap\u003cString, String\u003e\u003e) -\u003e String\u003e;\ntype PluralFn = Box\u003cdyn Fn(\u0026str, i32, Option\u003c\u0026HashMap\u003cString, String\u003e\u003e) -\u003e String\u003e;\ntype SetLocaleFn = Box\u003cdyn Fn(Locale)\u003e;\ntype SimpleTFn = Box\u003cdyn Fn(\u0026str) -\u003e String\u003e;\n\n/// Supported locales\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]\npub enum Locale {\n    EnUS,\n    EnGB,\n    ZhCN,\n    ZhTW,\n    JaJP,\n    KoKR,\n    DeDE,\n    FrFR,\n    EsES,\n    ItIT,\n    PtBR,\n    RuRU,\n}\n\nimpl Locale {\n    pub fn code(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Locale::EnUS =\u003e \"en-US\",\n            Locale::EnGB =\u003e \"en-GB\",\n            Locale::ZhCN =\u003e \"zh-CN\",\n            Locale::ZhTW =\u003e \"zh-TW\",\n            Locale::JaJP =\u003e \"ja-JP\",\n            Locale::KoKR =\u003e \"ko-KR\",\n            Locale::DeDE =\u003e \"de-DE\",\n            Locale::FrFR =\u003e \"fr-FR\",\n            Locale::EsES =\u003e \"es-ES\",\n            Locale::ItIT =\u003e \"it-IT\",\n            Locale::PtBR =\u003e \"pt-BR\",\n            Locale::RuRU =\u003e \"ru-RU\",\n        }\n    }\n\n    pub fn from_code(code: \u0026str) -\u003e Option\u003cSelf\u003e {\n        match code {\n            \"en-US\" | \"en\" =\u003e Some(Locale::EnUS),\n            \"en-GB\" =\u003e Some(Locale::EnGB),\n            \"zh-CN\" | \"zh\" =\u003e Some(Locale::ZhCN),\n            \"zh-TW\" =\u003e Some(Locale::ZhTW),\n            \"ja-JP\" | \"ja\" =\u003e Some(Locale::JaJP),\n            \"ko-KR\" | \"ko\" =\u003e Some(Locale::KoKR),\n            \"de-DE\" | \"de\" =\u003e Some(Locale::DeDE),\n            \"fr-FR\" | \"fr\" =\u003e Some(Locale::FrFR),\n            \"es-ES\" | \"es\" =\u003e Some(Locale::EsES),\n            \"it-IT\" | \"it\" =\u003e Some(Locale::ItIT),\n            \"pt-BR\" | \"pt\" =\u003e Some(Locale::PtBR),\n            \"ru-RU\" | \"ru\" =\u003e Some(Locale::RuRU),\n            _ =\u003e None,\n        }\n    }\n\n    pub fn display_name(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Locale::EnUS =\u003e \"English (US)\",\n            Locale::EnGB =\u003e \"English (UK)\",\n            Locale::ZhCN =\u003e \"简体中文\",\n            Locale::ZhTW =\u003e \"繁體中文\",\n            Locale::JaJP =\u003e \"日本語\",\n            Locale::KoKR =\u003e \"한국어\",\n            Locale::DeDE =\u003e \"Deutsch\",\n            Locale::FrFR =\u003e \"Français\",\n            Locale::EsES =\u003e \"Español\",\n            Locale::ItIT =\u003e \"Italiano\",\n            Locale::PtBR =\u003e \"Português (Brasil)\",\n            Locale::RuRU =\u003e \"Русский\",\n        }\n    }\n\n    pub fn rtl(\u0026self) -\u003e bool {\n        // Add RTL languages here if needed (Arabic, Hebrew, etc.)\n        false\n    }\n}\n\n/// Translation value types\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(untagged)]\npub enum TranslationValue {\n    Text(String),\n    Plural {\n        zero: Option\u003cString\u003e,\n        one: String,\n        few: Option\u003cString\u003e,\n        many: Option\u003cString\u003e,\n        other: String,\n    },\n}\n\n/// Translation messages\npub type Messages = HashMap\u003cString, TranslationValue\u003e;\n\n/// Translation catalog\npub struct TranslationCatalog {\n    locales: HashMap\u003cLocale, Messages\u003e,\n}\n\nimpl Default for TranslationCatalog {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl TranslationCatalog {\n    pub fn new() -\u003e Self {\n        TranslationCatalog {\n            locales: HashMap::new(),\n        }\n    }\n\n    pub fn add_locale(mut self, locale: Locale, messages: Messages) -\u003e Self {\n        self.locales.insert(locale, messages);\n        self\n    }\n\n    pub fn get(\u0026self, locale: Locale, key: \u0026str) -\u003e Option\u003c\u0026TranslationValue\u003e {\n        self.locales.get(\u0026locale)?.get(key)\n    }\n\n    pub fn merge(\u0026mut self, other: TranslationCatalog) {\n        for (locale, messages) in other.locales {\n            self.locales.entry(locale).or_default().extend(messages);\n        }\n    }\n}\n\n/// i18n context\npub struct I18nContext {\n    current_locale: Rc\u003cRefCell\u003cLocale\u003e\u003e,\n    catalog: Rc\u003cTranslationCatalog\u003e,\n    fallback_locale: Locale,\n}\n\nimpl I18nContext {\n    pub fn new(catalog: TranslationCatalog) -\u003e Self {\n        // Detect browser locale\n        let browser_locale = detect_browser_locale().unwrap_or(Locale::EnUS);\n\n        I18nContext {\n            current_locale: Rc::new(RefCell::new(browser_locale)),\n            catalog: Rc::new(catalog),\n            fallback_locale: Locale::EnUS,\n        }\n    }\n\n    pub fn locale(\u0026self) -\u003e Locale {\n        *self.current_locale.borrow()\n    }\n\n    pub fn set_locale(\u0026self, locale: Locale) {\n        *self.current_locale.borrow_mut() = locale;\n\n        // Persist to localStorage\n        if let Some(storage) = web_sys::window()\n            .and_then(|w| w.local_storage().ok())\n            .flatten()\n        {\n            let _ = storage.set_item(\"layer9-locale\", locale.code());\n        }\n\n        // Update document lang attribute\n        if let Some(document) = web_sys::window().and_then(|w| w.document()) {\n            if let Some(html) = document.document_element() {\n                let _ = html.set_attribute(\"lang\", locale.code());\n            }\n        }\n    }\n\n    pub fn t(\u0026self, key: \u0026str) -\u003e String {\n        self.translate(key, None)\n    }\n\n    pub fn translate(\u0026self, key: \u0026str, args: Option\u003c\u0026HashMap\u003cString, String\u003e\u003e) -\u003e String {\n        let locale = self.locale();\n\n        // Try current locale\n        if let Some(value) = self.catalog.get(locale, key) {\n            return self.format_translation(value, args);\n        }\n\n        // Try fallback locale\n        if let Some(value) = self.catalog.get(self.fallback_locale, key) {\n            return self.format_translation(value, args);\n        }\n\n        // Return key if not found\n        key.to_string()\n    }\n\n    pub fn plural(\u0026self, key: \u0026str, count: i32, args: Option\u003c\u0026HashMap\u003cString, String\u003e\u003e) -\u003e String {\n        let locale = self.locale();\n\n        if let Some(value) = self.catalog.get(locale, key) {\n            match value {\n                TranslationValue::Plural {\n                    zero,\n                    one,\n                    few,\n                    many,\n                    other,\n                } =\u003e {\n                    let text = match count {\n                        0 if zero.is_some() =\u003e zero.as_ref().unwrap(),\n                        1 =\u003e one,\n                        2..=4 if few.is_some() =\u003e few.as_ref().unwrap(),\n                        _ if count \u003e 20 \u0026\u0026 many.is_some() =\u003e many.as_ref().unwrap(),\n                        _ =\u003e other,\n                    };\n\n                    let mut final_args = args.cloned().unwrap_or_default();\n                    final_args.insert(\"count\".to_string(), count.to_string());\n\n                    self.interpolate(text, \u0026final_args)\n                }\n                TranslationValue::Text(text) =\u003e {\n                    let mut final_args = args.cloned().unwrap_or_default();\n                    final_args.insert(\"count\".to_string(), count.to_string());\n\n                    self.interpolate(text, \u0026final_args)\n                }\n            }\n        } else {\n            format!(\"{} ({})\", key, count)\n        }\n    }\n\n    fn format_translation(\n        \u0026self,\n        value: \u0026TranslationValue,\n        args: Option\u003c\u0026HashMap\u003cString, String\u003e\u003e,\n    ) -\u003e String {\n        match value {\n            TranslationValue::Text(text) =\u003e {\n                if let Some(args) = args {\n                    self.interpolate(text, args)\n                } else {\n                    text.clone()\n                }\n            }\n            TranslationValue::Plural { other, .. } =\u003e other.clone(),\n        }\n    }\n\n    fn interpolate(\u0026self, text: \u0026str, args: \u0026HashMap\u003cString, String\u003e) -\u003e String {\n        let mut result = text.to_string();\n\n        for (key, value) in args {\n            result = result.replace(\u0026format!(\"{{{}}}\", key), value);\n            result = result.replace(\u0026format!(\"{{{{ {} }}}}\", key), value);\n        }\n\n        result\n    }\n}\n\nthread_local! {\n    static I18N: RefCell\u003cOption\u003cI18nContext\u003e\u003e = const { RefCell::new(None) };\n}\n\n/// Initialize i18n\npub fn init_i18n(catalog: TranslationCatalog) {\n    let ctx = I18nContext::new(catalog);\n    I18N.with(|i18n| {\n        *i18n.borrow_mut() = Some(ctx);\n    });\n}\n\n/// i18n hook\npub fn use_i18n() -\u003e I18n {\n    // First check if initialized\n    let locale = I18N.with(|i18n| {\n        let borrowed = i18n.borrow();\n        borrowed\n            .as_ref()\n            .map(|ctx| ctx.locale())\n            .unwrap_or_else(|| {\n                panic!(\"i18n not initialized. Call init_i18n() first.\");\n            })\n    });\n\n    I18n {\n        locale,\n        set_locale: Box::new(move |locale| {\n            I18N.with(|i18n| {\n                if let Some(ctx) = i18n.borrow().as_ref() {\n                    ctx.set_locale(locale);\n                }\n            });\n        }),\n        t: Box::new(move |key| {\n            I18N.with(|i18n| {\n                i18n.borrow()\n                    .as_ref()\n                    .map(|ctx| ctx.t(key))\n                    .unwrap_or_else(|| key.to_string())\n            })\n        }),\n        translate: Box::new(move |key, args| {\n            I18N.with(|i18n| {\n                i18n.borrow()\n                    .as_ref()\n                    .map(|ctx| ctx.translate(key, args))\n                    .unwrap_or_else(|| key.to_string())\n            })\n        }),\n        plural: Box::new(move |key, count, args| {\n            I18N.with(|i18n| {\n                i18n.borrow()\n                    .as_ref()\n                    .map(|ctx| ctx.plural(key, count, args))\n                    .unwrap_or_else(|| key.to_string())\n            })\n        }),\n    }\n}\n\n/// i18n hook result\npub struct I18n {\n    pub locale: Locale,\n    pub set_locale: SetLocaleFn,\n    pub t: SimpleTFn,\n    pub translate: TranslateFn,\n    pub plural: PluralFn,\n}\n\n/// Detect browser locale\nfn detect_browser_locale() -\u003e Option\u003cLocale\u003e {\n    // Check localStorage first\n    if let Some(storage) = web_sys::window()\n        .and_then(|w| w.local_storage().ok())\n        .flatten()\n    {\n        if let Ok(Some(stored)) = storage.get_item(\"layer9-locale\") {\n            if let Some(locale) = Locale::from_code(\u0026stored) {\n                return Some(locale);\n            }\n        }\n    }\n\n    // Check navigator language\n    if let Some(window) = web_sys::window() {\n        if let Some(navigator) = window.navigator().language() {\n            if let Some(locale) = Locale::from_code(\u0026navigator) {\n                return Some(locale);\n            }\n        }\n    }\n\n    None\n}\n\n/// Number formatting\n#[allow(dead_code)]\npub struct NumberFormat {\n    locale: Locale,\n}\n\nimpl NumberFormat {\n    pub fn new(locale: Locale) -\u003e Self {\n        NumberFormat { locale }\n    }\n\n    pub fn format(\u0026self, number: f64) -\u003e String {\n        // Use Intl.NumberFormat\n        format!(\"{:.2}\", number) // Simplified for now\n    }\n\n    pub fn currency(\u0026self, amount: f64, currency: \u0026str) -\u003e String {\n        match currency {\n            \"USD\" =\u003e format!(\"${:.2}\", amount),\n            \"EUR\" =\u003e format!(\"€{:.2}\", amount),\n            \"GBP\" =\u003e format!(\"£{:.2}\", amount),\n            \"JPY\" =\u003e format!(\"¥{:.0}\", amount),\n            \"CNY\" =\u003e format!(\"¥{:.2}\", amount),\n            \"KRW\" =\u003e format!(\"₩{:.0}\", amount),\n            _ =\u003e format!(\"{} {:.2}\", currency, amount),\n        }\n    }\n\n    pub fn percent(\u0026self, value: f64) -\u003e String {\n        format!(\"{:.1}%\", value * 100.0)\n    }\n}\n\n/// Date/time formatting\n#[allow(dead_code)]\npub struct DateTimeFormat {\n    locale: Locale,\n}\n\nimpl DateTimeFormat {\n    pub fn new(locale: Locale) -\u003e Self {\n        DateTimeFormat { locale }\n    }\n\n    pub fn date(\u0026self, timestamp: f64) -\u003e String {\n        // Use Intl.DateTimeFormat\n        let date = js_sys::Date::new(\u0026JsValue::from_f64(timestamp));\n        date.to_locale_date_string(self.locale.code(), \u0026JsValue::NULL)\n            .into()\n    }\n\n    pub fn time(\u0026self, timestamp: f64) -\u003e String {\n        let date = js_sys::Date::new(\u0026JsValue::from_f64(timestamp));\n        date.to_locale_time_string(self.locale.code()).into()\n    }\n\n    pub fn date_time(\u0026self, timestamp: f64) -\u003e String {\n        let date = js_sys::Date::new(\u0026JsValue::from_f64(timestamp));\n        date.to_locale_string(self.locale.code(), \u0026JsValue::NULL)\n            .into()\n    }\n\n    pub fn relative(\u0026self, timestamp: f64) -\u003e String {\n        let now = js_sys::Date::now();\n        let diff = (now - timestamp) / 1000.0; // seconds\n\n        match diff {\n            d if d \u003c 60.0 =\u003e \"just now\".to_string(),\n            d if d \u003c 3600.0 =\u003e format!(\"{} minutes ago\", (d / 60.0) as i32),\n            d if d \u003c 86400.0 =\u003e format!(\"{} hours ago\", (d / 3600.0) as i32),\n            d if d \u003c 604800.0 =\u003e format!(\"{} days ago\", (d / 86400.0) as i32),\n            _ =\u003e self.date(timestamp),\n        }\n    }\n}\n\n/// Format hooks\npub fn use_number_format() -\u003e NumberFormat {\n    let i18n = use_i18n();\n    NumberFormat::new(i18n.locale)\n}\n\npub fn use_date_format() -\u003e DateTimeFormat {\n    let i18n = use_i18n();\n    DateTimeFormat::new(i18n.locale)\n}\n\n/// Translation macros\n#[macro_export]\nmacro_rules! t {\n    ($key:expr) =\u003e {{\n        use_i18n().t($key)\n    }};\n    ($key:expr, $($arg_name:ident = $arg_value:expr),*) =\u003e {{\n        let mut args = std::collections::HashMap::new();\n        $(\n            args.insert(stringify!($arg_name).to_string(), $arg_value.to_string());\n        )*\n        use_i18n().translate($key, Some(\u0026args))\n    }};\n}\n\n#[macro_export]\nmacro_rules! plural {\n    ($key:expr, $count:expr) =\u003e {{\n        use_i18n().plural($key, $count, None)\n    }};\n    ($key:expr, $count:expr, $($arg_name:ident = $arg_value:expr),*) =\u003e {{\n        let mut args = std::collections::HashMap::new();\n        $(\n            args.insert(stringify!($arg_name).to_string(), $arg_value.to_string());\n        )*\n        use_i18n().plural($key, $count, Some(\u0026args))\n    }};\n}\n\n/// Example translations builder\npub struct TranslationsBuilder;\n\nimpl TranslationsBuilder {\n    pub fn en_us() -\u003e Messages {\n        let mut messages = HashMap::new();\n\n        messages.insert(\n            \"app.title\".to_string(),\n            TranslationValue::Text(\"My Application\".to_string()),\n        );\n\n        messages.insert(\n            \"welcome.message\".to_string(),\n            TranslationValue::Text(\"Welcome, {name}!\".to_string()),\n        );\n\n        messages.insert(\n            \"items.count\".to_string(),\n            TranslationValue::Plural {\n                zero: Some(\"No items\".to_string()),\n                one: \"1 item\".to_string(),\n                few: None,\n                many: None,\n                other: \"{count} items\".to_string(),\n            },\n        );\n\n        messages\n    }\n\n    pub fn ko_kr() -\u003e Messages {\n        let mut messages = HashMap::new();\n\n        messages.insert(\n            \"app.title\".to_string(),\n            TranslationValue::Text(\"내 애플리케이션\".to_string()),\n        );\n\n        messages.insert(\n            \"welcome.message\".to_string(),\n            TranslationValue::Text(\"{name}님, 환영합니다!\".to_string()),\n        );\n\n        messages.insert(\n            \"items.count\".to_string(),\n            TranslationValue::Text(\"항목 {count}개\".to_string()),\n        );\n\n        messages\n    }\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":200},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","image.rs"],"content":"//! Image Optimization - L5\n\nuse crate::component::{use_state, Component};\nuse crate::prelude::*;\nuse crate::hooks::use_effect;\nuse std::rc::Rc;\nuse wasm_bindgen::closure::Closure;\nuse wasm_bindgen::JsCast;\nuse web_sys::{IntersectionObserver, IntersectionObserverEntry};\n\n/// Optimized image component\npub struct Image {\n    src: String,\n    alt: String,\n    width: Option\u003cu32\u003e,\n    height: Option\u003cu32\u003e,\n    loading: ImageLoading,\n    sizes: Option\u003cString\u003e,\n    srcset: Option\u003cString\u003e,\n    placeholder: Option\u003cImagePlaceholder\u003e,\n    priority: bool,\n    quality: u8,\n    on_load: Option\u003cRc\u003cdyn Fn()\u003e\u003e,\n    on_error: Option\u003cRc\u003cdyn Fn()\u003e\u003e,\n}\n\n#[derive(Clone, Copy)]\npub enum ImageLoading {\n    Lazy,\n    Eager,\n}\n\n#[derive(Clone)]\npub enum ImagePlaceholder {\n    Blur(String),  // base64 blurred image\n    Color(String), // solid color\n    Shimmer,       // animated shimmer effect\n}\n\nimpl Image {\n    pub fn new(src: impl Into\u003cString\u003e) -\u003e Self {\n        Image {\n            src: src.into(),\n            alt: String::new(),\n            width: None,\n            height: None,\n            loading: ImageLoading::Lazy,\n            sizes: None,\n            srcset: None,\n            placeholder: None,\n            priority: false,\n            quality: 75,\n            on_load: None,\n            on_error: None,\n        }\n    }\n\n    pub fn alt(mut self, alt: impl Into\u003cString\u003e) -\u003e Self {\n        self.alt = alt.into();\n        self\n    }\n\n    pub fn width(mut self, width: u32) -\u003e Self {\n        self.width = Some(width);\n        self\n    }\n\n    pub fn height(mut self, height: u32) -\u003e Self {\n        self.height = Some(height);\n        self\n    }\n\n    pub fn loading(mut self, loading: ImageLoading) -\u003e Self {\n        self.loading = loading;\n        self\n    }\n\n    pub fn sizes(mut self, sizes: impl Into\u003cString\u003e) -\u003e Self {\n        self.sizes = Some(sizes.into());\n        self\n    }\n\n    pub fn srcset(mut self, srcset: impl Into\u003cString\u003e) -\u003e Self {\n        self.srcset = Some(srcset.into());\n        self\n    }\n\n    pub fn placeholder(mut self, placeholder: ImagePlaceholder) -\u003e Self {\n        self.placeholder = Some(placeholder);\n        self\n    }\n\n    pub fn priority(mut self) -\u003e Self {\n        self.priority = true;\n        self.loading = ImageLoading::Eager;\n        self\n    }\n\n    pub fn quality(mut self, quality: u8) -\u003e Self {\n        self.quality = quality.clamp(1, 100);\n        self\n    }\n\n    pub fn on_load(mut self, handler: impl Fn() + 'static) -\u003e Self {\n        self.on_load = Some(Rc::new(handler));\n        self\n    }\n\n    pub fn on_error(mut self, handler: impl Fn() + 'static) -\u003e Self {\n        self.on_error = Some(Rc::new(handler));\n        self\n    }\n\n    fn generate_srcset(\u0026self) -\u003e String {\n        if let Some(srcset) = \u0026self.srcset {\n            return srcset.clone();\n        }\n\n        // Generate responsive srcset with Layer9 optimization\n        let widths = [640, 750, 828, 1080, 1200, 1920, 2048, 3840];\n\n        widths\n            .iter()\n            .map(|\u0026w| format!(\"{} {}w\", self.optimize_url_with_width(\u0026self.src, w), w))\n            .collect::\u003cVec\u003c_\u003e\u003e()\n            .join(\", \")\n    }\n\n    fn optimize_url(\u0026self, url: \u0026str) -\u003e String {\n        // Use Layer9 image optimization endpoint\n        if self.width.is_some() || self.height.is_some() || self.quality != 75 {\n            let mut params = vec![];\n            \n            if let Some(w) = self.width {\n                params.push(format!(\"w={}\", w));\n            }\n            if let Some(h) = self.height {\n                params.push(format!(\"h={}\", h));\n            }\n            params.push(format!(\"q={}\", self.quality));\n            \n            format!(\n                \"/_layer9/image?src={}\u0026{}\",\n                urlencoding::encode(url),\n                params.join(\"\u0026\")\n            )\n        } else {\n            url.to_string()\n        }\n    }\n\n    fn optimize_url_with_width(\u0026self, url: \u0026str, width: u32) -\u003e String {\n        format!(\n            \"/_layer9/image?src={}\u0026w={}\u0026q={}\",\n            urlencoding::encode(url),\n            width,\n            self.quality\n        )\n    }\n}\n\nimpl Component for Image {\n    fn render(\u0026self) -\u003e Element {\n        let is_lazy = matches!(self.loading, ImageLoading::Lazy);\n        let loaded = use_state(|| !is_lazy);\n        let _error = use_state(|| false);\n\n        // Image attributes\n        let mut attrs = vec![(\"alt\".to_string(), self.alt.clone())];\n\n        if let Some(width) = self.width {\n            attrs.push((\"width\".to_string(), width.to_string()));\n        }\n\n        if let Some(height) = self.height {\n            attrs.push((\"height\".to_string(), height.to_string()));\n        }\n\n        if let Some(sizes) = \u0026self.sizes {\n            attrs.push((\"sizes\".to_string(), sizes.clone()));\n        }\n\n        // Generate srcset for responsive images\n        let srcset = self.generate_srcset();\n        attrs.push((\"srcset\".to_string(), srcset));\n\n        // Lazy loading\n        if is_lazy \u0026\u0026 !loaded.get() {\n            attrs.push((\"data-src\".to_string(), self.optimize_url(\u0026self.src)));\n            attrs.push((\"src\".to_string(), \"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='1'%20height='1'%3E%3C/svg%3E\".to_string()));\n        } else {\n            attrs.push((\"src\".to_string(), self.optimize_url(\u0026self.src)));\n        }\n\n        // Loading attribute\n        attrs.push((\n            \"loading\".to_string(),\n            match self.loading {\n                ImageLoading::Lazy =\u003e \"lazy\",\n                ImageLoading::Eager =\u003e \"eager\",\n            }\n            .to_string(),\n        ));\n\n        // Decoding\n        attrs.push((\"decoding\".to_string(), \"async\".to_string()));\n\n        // Style for aspect ratio\n        let style = if let (Some(width), Some(height)) = (self.width, self.height) {\n            format!(\"aspect-ratio: {} / {}\", width, height)\n        } else {\n            String::new()\n        };\n\n        if !style.is_empty() {\n            attrs.push((\"style\".to_string(), style));\n        }\n\n        // Container for placeholder\n        // Note: position and overflow are not available in StyleBuilder\n        // We'll add them directly to the style string\n        let container_style = \"position: relative; overflow: hidden\";\n\n        let placeholder_element = if let Some(placeholder) = \u0026self.placeholder {\n            match placeholder {\n                ImagePlaceholder::Blur(blur_url) =\u003e {\n                    Element::Node {\n                        tag: \"img\".to_string(),\n                        props: Props {\n                            attributes: vec![\n                                (\"src\".to_string(), blur_url.clone()),\n                                (\"alt\".to_string(), \"\".to_string()),\n                                (\"aria-hidden\".to_string(), \"true\".to_string()),\n                                (\"style\".to_string(), \"position: absolute; inset: 0; filter: blur(20px); transform: scale(1.05);\".to_string()),\n                            ],\n                            ..Default::default()\n                        },\n                        children: vec![],\n                    }\n                }\n                ImagePlaceholder::Color(color) =\u003e {\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            attributes: vec![\n                                (\"style\".to_string(), format!(\"position: absolute; inset: 0; background-color: {}\", color)),\n                                (\"aria-hidden\".to_string(), \"true\".to_string()),\n                            ],\n                            ..Default::default()\n                        },\n                        children: vec![],\n                    }\n                }\n                ImagePlaceholder::Shimmer =\u003e {\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"shimmer\".to_string()),\n                            attributes: vec![\n                                (\"style\".to_string(), \"position: absolute; inset: 0;\".to_string()),\n                                (\"aria-hidden\".to_string(), \"true\".to_string()),\n                            ],\n                            ..Default::default()\n                        },\n                        children: vec![],\n                    }\n                }\n            }\n        } else {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props::default(),\n                children: vec![],\n            }\n        };\n\n        let _on_load = self.on_load.clone();\n        let _on_error = self.on_error.clone();\n\n        let img_props = Props {\n            class: Some(if loaded.get() { \"loaded\" } else { \"loading\" }.to_string()),\n            attributes: attrs,\n            ..Default::default()\n        };\n\n        // Note: In a real implementation, we'd need to handle onload and onerror properly\n        // For now, we'll just add them as attributes\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"image-container\".to_string()),\n                attributes: vec![(\"style\".to_string(), container_style.to_string())],\n                ..Default::default()\n            },\n            children: vec![\n                placeholder_element,\n                Element::Node {\n                    tag: \"img\".to_string(),\n                    props: img_props,\n                    children: vec![],\n                },\n            ],\n        }\n    }\n}\n\n/// Picture component for art direction\npub struct Picture {\n    sources: Vec\u003cSource\u003e,\n    img: Image,\n}\n\npub struct Source {\n    media: String,\n    srcset: String,\n    type_: Option\u003cString\u003e,\n}\n\nimpl Picture {\n    pub fn new(img: Image) -\u003e Self {\n        Picture {\n            sources: vec![],\n            img,\n        }\n    }\n\n    pub fn source(mut self, media: impl Into\u003cString\u003e, srcset: impl Into\u003cString\u003e) -\u003e Self {\n        self.sources.push(Source {\n            media: media.into(),\n            srcset: srcset.into(),\n            type_: None,\n        });\n        self\n    }\n\n    pub fn source_with_type(\n        mut self,\n        media: impl Into\u003cString\u003e,\n        srcset: impl Into\u003cString\u003e,\n        type_: impl Into\u003cString\u003e,\n    ) -\u003e Self {\n        self.sources.push(Source {\n            media: media.into(),\n            srcset: srcset.into(),\n            type_: Some(type_.into()),\n        });\n        self\n    }\n}\n\nimpl Component for Picture {\n    fn render(\u0026self) -\u003e Element {\n        Element::Node {\n            tag: \"picture\".to_string(),\n            props: Props::default(),\n            children: {\n                let mut children: Vec\u003cElement\u003e = self\n                    .sources\n                    .iter()\n                    .map(|source| {\n                        let mut attrs = vec![\n                            (\"media\".to_string(), source.media.clone()),\n                            (\"srcset\".to_string(), source.srcset.clone()),\n                        ];\n\n                        if let Some(type_) = \u0026source.type_ {\n                            attrs.push((\"type\".to_string(), type_.clone()));\n                        }\n\n                        Element::Node {\n                            tag: \"source\".to_string(),\n                            props: Props {\n                                attributes: attrs,\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        }\n                    })\n                    .collect();\n\n                children.push(self.img.render());\n                children\n            },\n        }\n    }\n}\n\n/// Background image with lazy loading\npub struct BackgroundImage {\n    src: String,\n    children: Vec\u003cElement\u003e,\n    loading: ImageLoading,\n}\n\nimpl BackgroundImage {\n    pub fn new(src: impl Into\u003cString\u003e) -\u003e Self {\n        BackgroundImage {\n            src: src.into(),\n            children: vec![],\n            loading: ImageLoading::Lazy,\n        }\n    }\n\n    pub fn children(mut self, children: Vec\u003cElement\u003e) -\u003e Self {\n        self.children = children;\n        self\n    }\n\n    pub fn loading(mut self, loading: ImageLoading) -\u003e Self {\n        self.loading = loading;\n        self\n    }\n}\n\nimpl Component for BackgroundImage {\n    fn render(\u0026self) -\u003e Element {\n        let loaded = use_state(|| false);\n        let container_id = format!(\"bg-img-{}\", js_sys::Math::random());\n\n        // Set up intersection observer for lazy loading\n        if matches!(self.loading, ImageLoading::Lazy) {\n            let loaded_clone = loaded.clone();\n            let container_id_clone = container_id.clone();\n            use_effect((), move || {\n                let observer = IntersectionObserver::new(\n                    Closure::\u003cdyn FnMut(Vec\u003cIntersectionObserverEntry\u003e)\u003e::new(\n                        move |entries: Vec\u003cIntersectionObserverEntry\u003e| {\n                            for entry in entries {\n                                if entry.is_intersecting() {\n                                    loaded_clone.set(true);\n                                    // Disconnect observer\n                                }\n                            }\n                        },\n                    )\n                    .into_js_value()\n                    .unchecked_ref(),\n                )\n                .unwrap();\n\n                if let Some(element) = web_sys::window()\n                    .and_then(|w| w.document())\n                    .and_then(|d| d.get_element_by_id(\u0026container_id_clone))\n                {\n                    observer.observe(\u0026element);\n                }\n\n                move || {\n                    observer.disconnect();\n                }\n            });\n        }\n\n        let style = if loaded.get() || matches!(self.loading, ImageLoading::Eager) {\n            format!(\"background-image: url('{}')\", self.src)\n        } else {\n            String::new()\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                id: Some(container_id),\n                attributes: vec![\n                    (\"style\".to_string(), style),\n                    (\"class\".to_string(), \"background-image\".to_string()),\n                ],\n                ..Default::default()\n            },\n            children: self.children.clone(),\n        }\n    }\n}\n\n/// Helper to preload images\npub fn preload_image(src: \u0026str) {\n    let window = web_sys::window().unwrap();\n    let document = window.document().unwrap();\n    let link = document.create_element(\"link\").unwrap();\n\n    link.set_attribute(\"rel\", \"preload\").unwrap();\n    link.set_attribute(\"as\", \"image\").unwrap();\n    link.set_attribute(\"href\", src).unwrap();\n\n    document.head().unwrap().append_child(\u0026link).unwrap();\n}\n\n// Re-exports\n","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":162},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","image_handler.rs"],"content":"//! HTTP handler for image optimization requests\n\n#[cfg(feature = \"ssr\")]\nuse axum::{\n    extract::{Query, State},\n    http::{header, StatusCode},\n    response::Response,\n};\nuse serde::{Deserialize, Serialize};\nuse std::sync::Arc;\n\n#[cfg(feature = \"ssr\")]\nuse crate::image_transform::{ImageTransformer, TransformParams, Format};\n\n/// Query parameters for image optimization\n#[derive(Debug, Deserialize, Serialize)]\npub struct ImageQuery {\n    /// Source image URL or path\n    pub src: String,\n    /// Target width\n    pub w: Option\u003cu32\u003e,\n    /// Target height\n    pub h: Option\u003cu32\u003e,\n    /// Output format\n    pub f: Option\u003cString\u003e,\n    /// Quality (1-100)\n    pub q: Option\u003cu8\u003e,\n    /// Blur radius\n    pub blur: Option\u003cu8\u003e,\n}\n\nimpl From\u003cImageQuery\u003e for TransformParams {\n    fn from(query: ImageQuery) -\u003e Self {\n        TransformParams {\n            width: query.w,\n            height: query.h,\n            format: query.f.as_deref().and_then(Format::from_extension),\n            quality: query.q.unwrap_or(85),\n            blur: query.blur,\n        }\n    }\n}\n\n/// Shared application state for image handler\n#[cfg(feature = \"ssr\")]\npub struct ImageHandlerState {\n    pub transformer: Arc\u003cImageTransformer\u003e,\n    pub allowed_domains: Vec\u003cString\u003e,\n    pub cache_dir: Option\u003cString\u003e,\n}\n\n/// Handle image optimization requests\n#[cfg(feature = \"ssr\")]\npub async fn handle_image_request(\n    Query(query): Query\u003cImageQuery\u003e,\n    State(state): State\u003cArc\u003cImageHandlerState\u003e\u003e,\n) -\u003e Result\u003cResponse, StatusCode\u003e {\n    // Validate source URL\n    if query.src.is_empty() {\n        return Err(StatusCode::BAD_REQUEST);\n    }\n\n    // Security: Validate allowed domains for remote URLs\n    if query.src.starts_with(\"http\") {\n        let is_allowed = state.allowed_domains.iter().any(|domain| {\n            query.src.contains(domain)\n        });\n        \n        if !is_allowed {\n            return Err(StatusCode::FORBIDDEN);\n        }\n    }\n\n    // Fetch source image\n    let image_data = if query.src.starts_with(\"http\") {\n        // Fetch remote image\n        match fetch_remote_image(\u0026query.src).await {\n            Ok(data) =\u003e data,\n            Err(_) =\u003e return Err(StatusCode::NOT_FOUND),\n        }\n    } else {\n        // Load local image\n        match load_local_image(\u0026query.src, state.cache_dir.as_deref()).await {\n            Ok(data) =\u003e data,\n            Err(_) =\u003e return Err(StatusCode::NOT_FOUND),\n        }\n    };\n\n    // Transform image\n    let src = query.src.clone();\n    let params = query.into();\n    match state.transformer.transform(\u0026image_data, \u0026src, \u0026params).await {\n        Ok(result) =\u003e {\n            // Build response with proper headers\n            let response = Response::builder()\n                .status(StatusCode::OK)\n                .header(header::CONTENT_TYPE, result.format.to_mime_type())\n                .header(header::CACHE_CONTROL, \"public, max-age=31536000, immutable\")\n                .header(\"X-Layer9-Width\", result.width.to_string())\n                .header(\"X-Layer9-Height\", result.height.to_string())\n                .body(result.data.into())\n                .unwrap();\n                \n            Ok(response)\n        }\n        Err(_) =\u003e Err(StatusCode::INTERNAL_SERVER_ERROR),\n    }\n}\n\n/// Fetch image from remote URL\n#[cfg(feature = \"ssr\")]\nasync fn fetch_remote_image(url: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    let response = reqwest::get(url).await?;\n    if !response.status().is_success() {\n        return Err(\"Failed to fetch image\".into());\n    }\n    \n    let bytes = response.bytes().await?;\n    Ok(bytes.to_vec())\n}\n\n/// Load image from local filesystem\n#[cfg(feature = \"ssr\")]\nasync fn load_local_image(\n    path: \u0026str,\n    base_dir: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    use tokio::fs;\n    \n    let full_path = if let Some(base) = base_dir {\n        format!(\"{}/{}\", base, path.trim_start_matches('/'))\n    } else {\n        format!(\"./public{}\", path)\n    };\n    \n    // Prevent directory traversal\n    if full_path.contains(\"..\") {\n        return Err(\"Invalid path\".into());\n    }\n    \n    let data = fs::read(\u0026full_path).await?;\n    Ok(data)\n}\n\n/// Create image optimization router\n#[cfg(feature = \"ssr\")]\npub fn create_image_router(\n    transformer: Arc\u003cImageTransformer\u003e,\n    allowed_domains: Vec\u003cString\u003e,\n    cache_dir: Option\u003cString\u003e,\n) -\u003e axum::Router {\n    use axum::routing::get;\n    \n    let state = Arc::new(ImageHandlerState {\n        transformer,\n        allowed_domains,\n        cache_dir,\n    });\n    \n    axum::Router::new()\n        .route(\"/_layer9/image\", get(handle_image_request))\n        .with_state(state)\n}\n\n/// Client-side image URL builder\npub struct ImageUrlBuilder {\n    base_url: String,\n    src: String,\n    params: TransformParams,\n}\n\nimpl ImageUrlBuilder {\n    pub fn new(src: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            base_url: \"/_layer9/image\".to_string(),\n            src: src.into(),\n            params: TransformParams::default(),\n        }\n    }\n\n    pub fn width(mut self, width: u32) -\u003e Self {\n        self.params.width = Some(width);\n        self\n    }\n\n    pub fn height(mut self, height: u32) -\u003e Self {\n        self.params.height = Some(height);\n        self\n    }\n\n    pub fn format(mut self, format: Format) -\u003e Self {\n        self.params.format = Some(format);\n        self\n    }\n\n    pub fn quality(mut self, quality: u8) -\u003e Self {\n        self.params.quality = quality;\n        self\n    }\n\n    pub fn blur(mut self, blur: u8) -\u003e Self {\n        self.params.blur = Some(blur);\n        self\n    }\n\n    pub fn build(\u0026self) -\u003e String {\n        let mut params = vec![format!(\"src={}\", urlencoding::encode(\u0026self.src))];\n        \n        if let Some(w) = self.params.width {\n            params.push(format!(\"w={}\", w));\n        }\n        if let Some(h) = self.params.height {\n            params.push(format!(\"h={}\", h));\n        }\n        if let Some(f) = \u0026self.params.format {\n            params.push(format!(\"f={}\", f.to_extension()));\n        }\n        if self.params.quality != 85 {\n            params.push(format!(\"q={}\", self.params.quality));\n        }\n        if let Some(b) = self.params.blur {\n            params.push(format!(\"blur={}\", b));\n        }\n        \n        format!(\"{}?{}\", self.base_url, params.join(\"\u0026\"))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_image_url_builder() {\n        let url = ImageUrlBuilder::new(\"/images/hero.jpg\")\n            .width(800)\n            .height(600)\n            .quality(90)\n            .build();\n            \n        assert_eq!(url, \"/_layer9/image?src=%2Fimages%2Fhero.jpg\u0026w=800\u0026h=600\u0026q=90\");\n    }\n\n    #[test]\n    fn test_transform_params_from_query() {\n        let query = ImageQuery {\n            src: \"/test.jpg\".to_string(),\n            w: Some(1024),\n            h: Some(768),\n            f: Some(\"webp\".to_string()),\n            q: Some(80),\n            blur: None,\n        };\n        \n        let params: TransformParams = query.into();\n        assert_eq!(params.width, Some(1024));\n        assert_eq!(params.height, Some(768));\n        assert_eq!(params.format, Some(Format::WebP));\n        assert_eq!(params.quality, 80);\n        assert_eq!(params.blur, None);\n    }\n}","traces":[{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","image_lazy.rs"],"content":"//! Lazy loading implementation for images using Intersection Observer\n\nuse crate::component::{use_state, Component};\nuse crate::prelude::*;\nuse crate::hooks::{use_effect, use_ref};\nuse std::cell::RefCell;\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen::JsCast;\nuse web_sys::{\n    Element as DomElement, \n    HtmlImageElement, \n    IntersectionObserver, \n    IntersectionObserverEntry,\n    IntersectionObserverInit,\n};\n\n/// Lazy loading configuration\n#[derive(Clone)]\npub struct LazyConfig {\n    /// Root margin for intersection observer (e.g., \"50px\")\n    pub root_margin: String,\n    /// Threshold for intersection (0.0 to 1.0)\n    pub threshold: f64,\n    /// Whether to unobserve after loading\n    pub unobserve_on_load: bool,\n}\n\nimpl Default for LazyConfig {\n    fn default() -\u003e Self {\n        Self {\n            root_margin: \"50px\".to_string(),\n            threshold: 0.01,\n            unobserve_on_load: true,\n        }\n    }\n}\n\n/// Global lazy loading manager\npub struct LazyLoadManager {\n    observer: Option\u003cIntersectionObserver\u003e,\n    #[allow(dead_code)]\n    config: LazyConfig,\n}\n\nthread_local! {\n    static LAZY_MANAGER: RefCell\u003cOption\u003cLazyLoadManager\u003e\u003e = const { RefCell::new(None) };\n}\n\nimpl LazyLoadManager {\n    /// Initialize the global lazy load manager\n    pub fn init(config: LazyConfig) {\n        LAZY_MANAGER.with(|manager| {\n            let mut manager = manager.borrow_mut();\n            if manager.is_none() {\n                *manager = Some(LazyLoadManager::new(config));\n            }\n        });\n    }\n\n    fn new(config: LazyConfig) -\u003e Self {\n        let observer = create_intersection_observer(\u0026config);\n        Self {\n            observer,\n            config,\n        }\n    }\n\n    /// Observe an element for lazy loading\n    pub fn observe(element: \u0026DomElement) {\n        LAZY_MANAGER.with(|manager| {\n            if let Some(ref manager) = *manager.borrow() {\n                if let Some(ref observer) = manager.observer {\n                    observer.observe(element);\n                }\n            }\n        });\n    }\n\n    /// Unobserve an element\n    pub fn unobserve(element: \u0026DomElement) {\n        LAZY_MANAGER.with(|manager| {\n            if let Some(ref manager) = *manager.borrow() {\n                if let Some(ref observer) = manager.observer {\n                    observer.unobserve(element);\n                }\n            }\n        });\n    }\n}\n\n/// Create intersection observer for lazy loading\nfn create_intersection_observer(config: \u0026LazyConfig) -\u003e Option\u003cIntersectionObserver\u003e {\n    let unobserve_on_load = config.unobserve_on_load;\n    let callback = Closure::wrap(Box::new(move |entries: Vec\u003cIntersectionObserverEntry\u003e, observer: IntersectionObserver| {\n        for entry in entries {\n            if entry.is_intersecting() {\n                let target = entry.target();\n                \n                // Load image\n                if let Ok(img) = target.dyn_into::\u003cHtmlImageElement\u003e() {\n                    // Get data-src attribute\n                    if let Some(src) = img.get_attribute(\"data-src\") {\n                        img.set_src(\u0026src);\n                        img.remove_attribute(\"data-src\").ok();\n                        \n                        // Add loaded class\n                        let class_list = img.class_list();\n                        class_list.remove_1(\"loading\").ok();\n                        class_list.add_1(\"loaded\").ok();\n                    }\n                    \n                    // Get data-srcset attribute\n                    if let Some(srcset) = img.get_attribute(\"data-srcset\") {\n                        img.set_attribute(\"srcset\", \u0026srcset).ok();\n                        img.remove_attribute(\"data-srcset\").ok();\n                    }\n                    \n                    // Unobserve if configured\n                    if unobserve_on_load {\n                        observer.unobserve(\u0026img);\n                    }\n                }\n            }\n        }\n    }) as Box\u003cdyn FnMut(Vec\u003cIntersectionObserverEntry\u003e, IntersectionObserver)\u003e);\n\n    let options = IntersectionObserverInit::new();\n    options.set_root_margin(\u0026config.root_margin);\n    \n    let threshold_array = js_sys::Array::new();\n    threshold_array.push(\u0026JsValue::from(config.threshold));\n    options.set_threshold(\u0026threshold_array);\n\n    let observer = IntersectionObserver::new_with_options(\n        callback.as_ref().unchecked_ref(),\n        \u0026options,\n    ).ok();\n\n    callback.forget(); // Prevent closure from being dropped\n    observer\n}\n\n/// Hook for lazy loading a single image\npub fn use_lazy_image(src: \u0026str, placeholder: Option\u003c\u0026str\u003e) -\u003e (String, bool) {\n    let loaded = use_state(|| false);\n    let element_ref = use_ref::\u003cOption\u003cDomElement\u003e\u003e(None);\n    \n    let _src_clone = src.to_string();\n    let placeholder_clone = placeholder.map(|p| p.to_string());\n    let loaded_clone = loaded.clone();\n    \n    use_effect((), move || {\n        // Initialize lazy manager if not already done\n        LazyLoadManager::init(LazyConfig::default());\n        \n        // Get element and observe\n        if let Some(element) = element_ref.borrow().as_ref() {\n                // Set up load handler\n                let load_handler = Closure::wrap(Box::new(move || {\n                    loaded_clone.set(true);\n                }) as Box\u003cdyn Fn()\u003e);\n                \n                if let Some(img) = element.dyn_ref::\u003cHtmlImageElement\u003e() {\n                    img.set_onload(Some(load_handler.as_ref().unchecked_ref()));\n                    load_handler.forget();\n                }\n                \n                LazyLoadManager::observe(element);\n        }\n        \n        move || {\n            // Cleanup: unobserve\n            if let Some(element) = element_ref.borrow().as_ref() {\n                LazyLoadManager::unobserve(element);\n            }\n        }\n    });\n    \n    let current_src = if loaded.get() {\n        src.to_string()\n    } else {\n        placeholder_clone.unwrap_or_else(|| \"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='1'%20height='1'%3E%3C/svg%3E\".to_string())\n    };\n    \n    (current_src, loaded.get())\n}\n\n/// Lazy loaded image component\npub struct LazyImage {\n    src: String,\n    alt: String,\n    width: Option\u003cu32\u003e,\n    height: Option\u003cu32\u003e,\n    placeholder: Option\u003cString\u003e,\n    class: Option\u003cString\u003e,\n    srcset: Option\u003cString\u003e,\n    sizes: Option\u003cString\u003e,\n}\n\nimpl LazyImage {\n    pub fn new(src: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            src: src.into(),\n            alt: String::new(),\n            width: None,\n            height: None,\n            placeholder: None,\n            class: None,\n            srcset: None,\n            sizes: None,\n        }\n    }\n\n    pub fn alt(mut self, alt: impl Into\u003cString\u003e) -\u003e Self {\n        self.alt = alt.into();\n        self\n    }\n\n    pub fn width(mut self, width: u32) -\u003e Self {\n        self.width = Some(width);\n        self\n    }\n\n    pub fn height(mut self, height: u32) -\u003e Self {\n        self.height = Some(height);\n        self\n    }\n\n    pub fn placeholder(mut self, placeholder: impl Into\u003cString\u003e) -\u003e Self {\n        self.placeholder = Some(placeholder.into());\n        self\n    }\n\n    pub fn class(mut self, class: impl Into\u003cString\u003e) -\u003e Self {\n        self.class = Some(class.into());\n        self\n    }\n\n    pub fn srcset(mut self, srcset: impl Into\u003cString\u003e) -\u003e Self {\n        self.srcset = Some(srcset.into());\n        self\n    }\n\n    pub fn sizes(mut self, sizes: impl Into\u003cString\u003e) -\u003e Self {\n        self.sizes = Some(sizes.into());\n        self\n    }\n}\n\nimpl Component for LazyImage {\n    fn render(\u0026self) -\u003e Element {\n        let loaded = use_state(|| false);\n        let img_ref = use_ref::\u003cOption\u003cDomElement\u003e\u003e(None);\n        \n        // Set up lazy loading\n        let loaded_clone = loaded.clone();\n        let img_ref_clone = img_ref.clone();\n        let _src_clone = self.src.clone();\n        \n        // Note: Since we can't directly return different closure types,\n        // we'll handle cleanup differently\n        let cleanup_ref = img_ref.clone();\n        \n        use_effect((), move || {\n            // Initialize lazy manager\n            LazyLoadManager::init(LazyConfig::default());\n            \n            if let Some(window) = web_sys::window() {\n                if let Some(document) = window.document() {\n                    // Use a unique ID to find our element\n                    let id = format!(\"lazy-img-{}\", js_sys::Math::random());\n                    \n                    // Set up a timeout to find and observe the element\n                    let closure = Closure::wrap(Box::new(move || {\n                        if let Some(element) = document.get_element_by_id(\u0026id) {\n                            *img_ref_clone.borrow_mut() = Some(element.clone());\n                            \n                            // Set up load handler\n                            let loaded_inner = loaded_clone.clone();\n                            let load_handler = Closure::wrap(Box::new(move || {\n                                loaded_inner.set(true);\n                            }) as Box\u003cdyn Fn()\u003e);\n                            \n                            if let Some(img) = element.dyn_ref::\u003cHtmlImageElement\u003e() {\n                                img.set_onload(Some(load_handler.as_ref().unchecked_ref()));\n                                load_handler.forget();\n                                \n                                // Observe for lazy loading\n                                LazyLoadManager::observe(\u0026element.clone());\n                            }\n                        }\n                    }) as Box\u003cdyn Fn()\u003e);\n                    \n                    window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                        closure.as_ref().unchecked_ref(),\n                        0,\n                    ).ok();\n                    \n                    closure.forget();\n                }\n            }\n            \n            // Cleanup function\n            move || {\n                if let Some(element) = cleanup_ref.borrow().as_ref() {\n                    LazyLoadManager::unobserve(element);\n                }\n            }\n        });\n        \n        // Build attributes\n        let mut attrs = vec![\n            (\"alt\".to_string(), self.alt.clone()),\n            (\"id\".to_string(), format!(\"lazy-img-{}\", js_sys::Math::random())),\n        ];\n        \n        // Add dimensions\n        if let Some(width) = self.width {\n            attrs.push((\"width\".to_string(), width.to_string()));\n        }\n        if let Some(height) = self.height {\n            attrs.push((\"height\".to_string(), height.to_string()));\n        }\n        \n        // Handle src/data-src based on loaded state\n        if loaded.get() {\n            attrs.push((\"src\".to_string(), self.src.clone()));\n            if let Some(ref srcset) = self.srcset {\n                attrs.push((\"srcset\".to_string(), srcset.clone()));\n            }\n        } else {\n            attrs.push((\"data-src\".to_string(), self.src.clone()));\n            if let Some(ref placeholder) = self.placeholder {\n                attrs.push((\"src\".to_string(), placeholder.clone()));\n            } else {\n                attrs.push((\"src\".to_string(), \"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='1'%20height='1'%3E%3C/svg%3E\".to_string()));\n            }\n            if let Some(ref srcset) = self.srcset {\n                attrs.push((\"data-srcset\".to_string(), srcset.clone()));\n            }\n        }\n        \n        // Add sizes\n        if let Some(ref sizes) = self.sizes {\n            attrs.push((\"sizes\".to_string(), sizes.clone()));\n        }\n        \n        // Add loading attribute\n        attrs.push((\"loading\".to_string(), \"lazy\".to_string()));\n        \n        // Build class\n        let mut classes = vec![];\n        if let Some(ref class) = self.class {\n            classes.push(class.clone());\n        }\n        classes.push(if loaded.get() { \"loaded\" } else { \"loading\" }.to_string());\n        \n        Element::Node {\n            tag: \"img\".to_string(),\n            props: Props {\n                class: Some(classes.join(\" \")),\n                attributes: attrs,\n                ..Default::default()\n            },\n            children: vec![],\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_lazy_config_default() {\n        let config = LazyConfig::default();\n        assert_eq!(config.root_margin, \"50px\");\n        assert_eq!(config.threshold, 0.01);\n        assert!(config.unobserve_on_load);\n    }\n}","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":120},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","image_transform.rs"],"content":"//! Image transformation and optimization module\n//! Provides server-side and client-side image processing capabilities\n\nuse std::collections::HashMap;\nuse std::path::Path;\nuse std::sync::Arc;\nuse parking_lot::RwLock;\n\n#[cfg(not(target_arch = \"wasm32\"))]\nuse image::{ImageFormat, ImageError};\n\n/// Supported image formats\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum Format {\n    Jpeg,\n    Png,\n    WebP,\n    Avif,\n    Gif,\n}\n\nimpl Format {\n    pub fn from_extension(ext: \u0026str) -\u003e Option\u003cSelf\u003e {\n        match ext.to_lowercase().as_str() {\n            \"jpg\" | \"jpeg\" =\u003e Some(Format::Jpeg),\n            \"png\" =\u003e Some(Format::Png),\n            \"webp\" =\u003e Some(Format::WebP),\n            \"avif\" =\u003e Some(Format::Avif),\n            \"gif\" =\u003e Some(Format::Gif),\n            _ =\u003e None,\n        }\n    }\n\n    pub fn to_mime_type(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Format::Jpeg =\u003e \"image/jpeg\",\n            Format::Png =\u003e \"image/png\",\n            Format::WebP =\u003e \"image/webp\",\n            Format::Avif =\u003e \"image/avif\",\n            Format::Gif =\u003e \"image/gif\",\n        }\n    }\n\n    pub fn to_extension(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Format::Jpeg =\u003e \"jpg\",\n            Format::Png =\u003e \"png\",\n            Format::WebP =\u003e \"webp\",\n            Format::Avif =\u003e \"avif\",\n            Format::Gif =\u003e \"gif\",\n        }\n    }\n}\n\n/// Image transformation parameters\n#[derive(Debug, Clone, PartialEq, Eq, Hash)]\npub struct TransformParams {\n    pub width: Option\u003cu32\u003e,\n    pub height: Option\u003cu32\u003e,\n    pub format: Option\u003cFormat\u003e,\n    pub quality: u8,\n    pub blur: Option\u003cu8\u003e,\n}\n\nimpl Default for TransformParams {\n    fn default() -\u003e Self {\n        Self {\n            width: None,\n            height: None,\n            format: None,\n            quality: 85,\n            blur: None,\n        }\n    }\n}\n\nimpl TransformParams {\n    /// Parse transform parameters from URL query string\n    pub fn from_query(query: \u0026str) -\u003e Self {\n        let mut params = Self::default();\n        \n        for pair in query.split('\u0026') {\n            if let Some((key, value)) = pair.split_once('=') {\n                match key {\n                    \"w\" | \"width\" =\u003e {\n                        params.width = value.parse().ok();\n                    }\n                    \"h\" | \"height\" =\u003e {\n                        params.height = value.parse().ok();\n                    }\n                    \"f\" | \"format\" =\u003e {\n                        params.format = Format::from_extension(value);\n                    }\n                    \"q\" | \"quality\" =\u003e {\n                        params.quality = value.parse().unwrap_or(85).clamp(1, 100);\n                    }\n                    \"blur\" =\u003e {\n                        params.blur = value.parse().ok();\n                    }\n                    _ =\u003e {}\n                }\n            }\n        }\n        \n        params\n    }\n\n    /// Generate cache key for these parameters\n    pub fn cache_key(\u0026self, source: \u0026str) -\u003e String {\n        let mut key = source.to_string();\n        \n        if let Some(w) = self.width {\n            key.push_str(\u0026format!(\"_w{}\", w));\n        }\n        if let Some(h) = self.height {\n            key.push_str(\u0026format!(\"_h{}\", h));\n        }\n        if let Some(f) = \u0026self.format {\n            key.push_str(\u0026format!(\"_{}\", f.to_extension()));\n        }\n        key.push_str(\u0026format!(\"_q{}\", self.quality));\n        if let Some(b) = self.blur {\n            key.push_str(\u0026format!(\"_blur{}\", b));\n        }\n        \n        key\n    }\n}\n\n/// Image cache entry\npub struct CacheEntry {\n    pub data: Vec\u003cu8\u003e,\n    pub format: Format,\n    pub width: u32,\n    pub height: u32,\n}\n\n/// Image transformer with caching\npub struct ImageTransformer {\n    cache: Arc\u003cRwLock\u003cHashMap\u003cString, CacheEntry\u003e\u003e\u003e,\n    max_cache_size: usize,\n}\n\nimpl ImageTransformer {\n    pub fn new(max_cache_size: usize) -\u003e Self {\n        Self {\n            cache: Arc::new(RwLock::new(HashMap::new())),\n            max_cache_size,\n        }\n    }\n\n    /// Transform image with given parameters (server-side only)\n    #[cfg(not(target_arch = \"wasm32\"))]\n    pub async fn transform(\n        \u0026self,\n        source_data: \u0026[u8],\n        source_path: \u0026str,\n        params: \u0026TransformParams,\n    ) -\u003e Result\u003cCacheEntry, ImageError\u003e {\n        let cache_key = params.cache_key(source_path);\n        \n        // Check cache first\n        {\n            let cache = self.cache.read();\n            if let Some(entry) = cache.get(\u0026cache_key) {\n                return Ok(CacheEntry {\n                    data: entry.data.clone(),\n                    format: entry.format,\n                    width: entry.width,\n                    height: entry.height,\n                });\n            }\n        }\n        \n        // Load and process image\n        let img = image::load_from_memory(source_data)?;\n        let mut result = img;\n        \n        // Resize if needed\n        if params.width.is_some() || params.height.is_some() {\n            let (orig_width, orig_height) = (result.width(), result.height());\n            let (new_width, new_height) = calculate_dimensions(\n                orig_width,\n                orig_height,\n                params.width,\n                params.height,\n            );\n            \n            result = result.resize(\n                new_width,\n                new_height,\n                image::imageops::FilterType::Lanczos3,\n            );\n        }\n        \n        // Apply blur if requested\n        if let Some(blur_radius) = params.blur {\n            result = result.blur(blur_radius as f32);\n        }\n        \n        // Determine output format\n        let output_format = params.format.unwrap_or_else(|| {\n            // Auto-detect from source path\n            Path::new(source_path)\n                .extension()\n                .and_then(|ext| ext.to_str())\n                .and_then(Format::from_extension)\n                .unwrap_or(Format::Jpeg)\n        });\n        \n        // Encode to desired format\n        let mut output = Vec::new();\n        let image_format = match output_format {\n            Format::Jpeg =\u003e ImageFormat::Jpeg,\n            Format::Png =\u003e ImageFormat::Png,\n            Format::WebP =\u003e ImageFormat::WebP,\n            Format::Gif =\u003e ImageFormat::Gif,\n            Format::Avif =\u003e {\n                // AVIF support requires additional crate\n                // For now, fallback to WebP\n                ImageFormat::WebP\n            }\n        };\n        \n        // Apply quality settings for lossy formats\n        match image_format {\n            ImageFormat::Jpeg =\u003e {\n                use image::codecs::jpeg::JpegEncoder;\n                use std::io::Cursor;\n                let mut cursor = Cursor::new(\u0026mut output);\n                let encoder = JpegEncoder::new_with_quality(\u0026mut cursor, params.quality);\n                result.write_with_encoder(encoder)?;\n            }\n            ImageFormat::WebP =\u003e {\n                // WebP encoding requires webp crate\n                // For now, use PNG as fallback\n                result.write_to(\u0026mut std::io::Cursor::new(\u0026mut output), ImageFormat::Png)?;\n            }\n            _ =\u003e {\n                result.write_to(\u0026mut std::io::Cursor::new(\u0026mut output), image_format)?;\n            }\n        }\n        \n        let entry = CacheEntry {\n            data: output.clone(),\n            format: output_format,\n            width: result.width(),\n            height: result.height(),\n        };\n        \n        // Store in cache\n        {\n            let mut cache = self.cache.write();\n            \n            // Simple cache eviction: remove oldest entries if cache is too large\n            if cache.len() \u003e= self.max_cache_size {\n                // In production, use LRU eviction\n                cache.clear();\n            }\n            \n            cache.insert(cache_key, CacheEntry {\n                data: output,\n                format: output_format,\n                width: result.width(),\n                height: result.height(),\n            });\n        }\n        \n        Ok(entry)\n    }\n\n    /// Generate blur placeholder (server-side only)\n    #[cfg(not(target_arch = \"wasm32\"))]\n    pub async fn generate_blur_placeholder(\n        \u0026self,\n        source_data: \u0026[u8],\n        width: u32,\n        height: u32,\n    ) -\u003e Result\u003cString, ImageError\u003e {\n        let img = image::load_from_memory(source_data)?;\n        \n        // Resize to small size for placeholder\n        let placeholder = img.resize(\n            width.min(20),\n            height.min(20),\n            image::imageops::FilterType::Gaussian,\n        );\n        \n        // Apply heavy blur\n        let blurred = placeholder.blur(5.0);\n        \n        // Encode to base64\n        let mut png_data = Vec::new();\n        blurred.write_to(\u0026mut std::io::Cursor::new(\u0026mut png_data), ImageFormat::Png)?;\n        \n        use base64::Engine as _;\n        Ok(format!(\n            \"data:image/png;base64,{}\",\n            base64::engine::general_purpose::STANDARD.encode(\u0026png_data)\n        ))\n    }\n\n    /// Clear cache\n    pub fn clear_cache(\u0026self) {\n        self.cache.write().clear();\n    }\n\n    /// Get cache size\n    pub fn cache_size(\u0026self) -\u003e usize {\n        self.cache.read().len()\n    }\n}\n\n/// Calculate target dimensions preserving aspect ratio\nfn calculate_dimensions(\n    orig_width: u32,\n    orig_height: u32,\n    target_width: Option\u003cu32\u003e,\n    target_height: Option\u003cu32\u003e,\n) -\u003e (u32, u32) {\n    match (target_width, target_height) {\n        (Some(w), Some(h)) =\u003e (w, h),\n        (Some(w), None) =\u003e {\n            let ratio = w as f32 / orig_width as f32;\n            (w, (orig_height as f32 * ratio) as u32)\n        }\n        (None, Some(h)) =\u003e {\n            let ratio = h as f32 / orig_height as f32;\n            ((orig_width as f32 * ratio) as u32, h)\n        }\n        (None, None) =\u003e (orig_width, orig_height),\n    }\n}\n\n/// Generate responsive srcset\npub fn generate_srcset(base_url: \u0026str, widths: \u0026[u32]) -\u003e String {\n    widths\n        .iter()\n        .map(|\u0026w| format!(\"{}?w={} {}w\", base_url, w, w))\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\", \")\n}\n\n/// Generate sizes attribute for responsive images\npub fn generate_sizes(breakpoints: \u0026[(u32, u32)]) -\u003e String {\n    breakpoints\n        .iter()\n        .map(|(breakpoint, width)| {\n            format!(\"(max-width: {}px) {}px\", breakpoint, width)\n        })\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\", \")\n}\n\n/// Image optimization configuration\n#[derive(Debug, Clone)]\npub struct ImageConfig {\n    /// Base URL for image optimization service\n    pub base_url: String,\n    /// Supported widths for responsive images\n    pub responsive_widths: Vec\u003cu32\u003e,\n    /// Default quality\n    pub default_quality: u8,\n    /// Enable WebP auto-conversion\n    pub auto_webp: bool,\n    /// Enable AVIF auto-conversion\n    pub auto_avif: bool,\n    /// Cache directory for optimized images\n    pub cache_dir: Option\u003cString\u003e,\n}\n\nimpl Default for ImageConfig {\n    fn default() -\u003e Self {\n        Self {\n            base_url: \"/_layer9/image\".to_string(),\n            responsive_widths: vec![320, 640, 768, 1024, 1280, 1536, 1920, 2560],\n            default_quality: 85,\n            auto_webp: true,\n            auto_avif: false,\n            cache_dir: None,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_transform_params_from_query() {\n        let params = TransformParams::from_query(\"w=800\u0026h=600\u0026q=90\u0026format=webp\");\n        assert_eq!(params.width, Some(800));\n        assert_eq!(params.height, Some(600));\n        assert_eq!(params.quality, 90);\n        assert_eq!(params.format, Some(Format::WebP));\n    }\n\n    #[test]\n    fn test_cache_key_generation() {\n        let params = TransformParams {\n            width: Some(800),\n            height: Some(600),\n            format: Some(Format::WebP),\n            quality: 90,\n            blur: None,\n        };\n        \n        let key = params.cache_key(\"/images/test.jpg\");\n        assert_eq!(key, \"/images/test.jpg_w800_h600_webp_q90\");\n    }\n\n    #[test]\n    fn test_dimension_calculation() {\n        // Test width only\n        let (w, h) = calculate_dimensions(1000, 800, Some(500), None);\n        assert_eq!(w, 500);\n        assert_eq!(h, 400);\n        \n        // Test height only\n        let (w, h) = calculate_dimensions(1000, 800, None, Some(400));\n        assert_eq!(w, 500);\n        assert_eq!(h, 400);\n        \n        // Test both\n        let (w, h) = calculate_dimensions(1000, 800, Some(600), Some(600));\n        assert_eq!(w, 600);\n        assert_eq!(h, 600);\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","jwt.rs"],"content":"//! JWT implementation for Layer9 authentication\n\nuse base64::{engine::general_purpose::URL_SAFE_NO_PAD, Engine};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct JwtHeader {\n    pub alg: String,\n    pub typ: String,\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct JwtClaims {\n    pub sub: String,        // Subject (user ID)\n    pub username: String,\n    pub email: String,\n    pub roles: Vec\u003cString\u003e,\n    pub exp: u64,          // Expiration time\n    pub iat: u64,          // Issued at\n    pub permissions: Vec\u003cString\u003e,\n}\n\n#[derive(Clone)]\npub struct Jwt {\n    secret: String,\n}\n\nimpl Jwt {\n    pub fn new(secret: String) -\u003e Self {\n        Self { secret }\n    }\n\n    pub fn create_token(\u0026self, claims: \u0026JwtClaims) -\u003e Result\u003cString, String\u003e {\n        let header = JwtHeader {\n            alg: \"HS256\".to_string(),\n            typ: \"JWT\".to_string(),\n        };\n\n        let header_json = serde_json::to_string(\u0026header)\n            .map_err(|e| format!(\"Failed to serialize header: {}\", e))?;\n        let claims_json = serde_json::to_string(\u0026claims)\n            .map_err(|e| format!(\"Failed to serialize claims: {}\", e))?;\n\n        let header_b64 = URL_SAFE_NO_PAD.encode(header_json.as_bytes());\n        let claims_b64 = URL_SAFE_NO_PAD.encode(claims_json.as_bytes());\n\n        let payload = format!(\"{}.{}\", header_b64, claims_b64);\n        let signature = self.sign(\u0026payload);\n\n        Ok(format!(\"{}.{}\", payload, signature))\n    }\n\n    pub fn verify_token(\u0026self, token: \u0026str) -\u003e Result\u003cJwtClaims, String\u003e {\n        let parts: Vec\u003c\u0026str\u003e = token.split('.').collect();\n        if parts.len() != 3 {\n            return Err(\"Invalid token format\".to_string());\n        }\n\n        let payload = format!(\"{}.{}\", parts[0], parts[1]);\n        let signature = parts[2];\n\n        // Verify signature\n        let expected_signature = self.sign(\u0026payload);\n        if signature != expected_signature {\n            return Err(\"Invalid signature\".to_string());\n        }\n\n        // Decode claims\n        let claims_bytes = URL_SAFE_NO_PAD\n            .decode(parts[1])\n            .map_err(|e| format!(\"Failed to decode claims: {}\", e))?;\n        let claims: JwtClaims = serde_json::from_slice(\u0026claims_bytes)\n            .map_err(|e| format!(\"Failed to parse claims: {}\", e))?;\n\n        // Check expiration\n        let now = js_sys::Date::now() as u64 / 1000;\n        if claims.exp \u003c now {\n            return Err(\"Token expired\".to_string());\n        }\n\n        Ok(claims)\n    }\n\n    fn sign(\u0026self, payload: \u0026str) -\u003e String {\n        let mut hasher = Sha256::new();\n        hasher.update(payload.as_bytes());\n        hasher.update(self.secret.as_bytes());\n        let result = hasher.finalize();\n        URL_SAFE_NO_PAD.encode(result)\n    }\n}\n\n#[cfg(all(test, target_arch = \"wasm32\"))]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn test_jwt_create_and_verify() {\n        let jwt = Jwt::new(\"test-secret\".to_string());\n        let now = js_sys::Date::now() as u64 / 1000;\n        \n        let claims = JwtClaims {\n            sub: \"123\".to_string(),\n            username: \"testuser\".to_string(),\n            email: \"test@example.com\".to_string(),\n            roles: vec![\"user\".to_string()],\n            exp: now + 3600, // 1 hour from now\n            iat: now,\n            permissions: vec![\"read\".to_string()],\n        };\n\n        let token = jwt.create_token(\u0026claims).unwrap();\n        let verified_claims = jwt.verify_token(\u0026token).unwrap();\n\n        assert_eq!(verified_claims.sub, claims.sub);\n        assert_eq!(verified_claims.username, claims.username);\n        assert_eq!(verified_claims.email, claims.email);\n    }\n\n    #[wasm_bindgen_test]\n    fn test_jwt_expired_token() {\n        let jwt = Jwt::new(\"test-secret\".to_string());\n        let now = js_sys::Date::now() as u64 / 1000;\n        \n        let claims = JwtClaims {\n            sub: \"123\".to_string(),\n            username: \"testuser\".to_string(),\n            email: \"test@example.com\".to_string(),\n            roles: vec![\"user\".to_string()],\n            exp: now - 3600, // 1 hour ago (expired)\n            iat: now - 7200,\n            permissions: vec![\"read\".to_string()],\n        };\n\n        let token = jwt.create_token(\u0026claims).unwrap();\n        let result = jwt.verify_token(\u0026token);\n\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Token expired\");\n    }\n\n    #[wasm_bindgen_test]\n    fn test_jwt_invalid_signature() {\n        let jwt1 = Jwt::new(\"secret1\".to_string());\n        let jwt2 = Jwt::new(\"secret2\".to_string());\n        let now = js_sys::Date::now() as u64 / 1000;\n        \n        let claims = JwtClaims {\n            sub: \"123\".to_string(),\n            username: \"testuser\".to_string(),\n            email: \"test@example.com\".to_string(),\n            roles: vec![\"user\".to_string()],\n            exp: now + 3600,\n            iat: now,\n            permissions: vec![\"read\".to_string()],\n        };\n\n        let token = jwt1.create_token(\u0026claims).unwrap();\n        let result = jwt2.verify_token(\u0026token);\n\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Invalid signature\");\n    }\n}","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":29},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","layers.rs"],"content":"//! Hierarchical Layer System\n\n/// Layer levels from L1 (Infrastructure) to L9 (Philosophy)\n#[repr(u8)]\n#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord)]\npub enum Layer {\n    L1Infrastructure = 1,\n    L2Platform = 2,\n    L3Runtime = 3,\n    L4Services = 4,\n    L5Components = 5,\n    L6Features = 6,\n    L7Application = 7,\n    L8Architecture = 8,\n    L9Philosophy = 9,\n}\n\n/// Marker trait for layer-aware types\npub trait LayerBound {\n    const LAYER: Layer;\n}\n\n/// Enforces layer hierarchy at compile time\npub struct LayerGuard\u003cconst FROM: u8, const TO: u8\u003e;\n\nimpl\u003cconst FROM: u8, const TO: u8\u003e LayerGuard\u003cFROM, TO\u003e {\n    pub const fn validate() {\n        assert!(\n            FROM \u003e= TO,\n            \"Invalid layer access: higher layers cannot directly access lower layers\"\n        );\n    }\n}\n\n/// L9: Philosophy - The highest abstraction\n#[allow(non_snake_case)]\npub mod L9 {\n    use super::*;\n\n    pub trait Philosophy: LayerBound {\n        const LAYER: Layer = Layer::L9Philosophy;\n\n        /// The core vision of your application\n        fn vision(\u0026self) -\u003e \u0026'static str;\n\n        /// The problem you're solving\n        fn purpose(\u0026self) -\u003e \u0026'static str;\n    }\n}\n\n/// L8: Architecture - System design\n#[allow(non_snake_case)]\npub mod L8 {\n    use super::*;\n\n    pub trait Architecture: LayerBound {\n        const LAYER: Layer = Layer::L8Architecture;\n\n        type App: L7::Application;\n\n        fn design() -\u003e ArchitectureDesign;\n    }\n\n    pub struct ArchitectureDesign {\n        pub layers: Vec\u003cLayer\u003e,\n        pub boundaries: Vec\u003c(Layer, Layer)\u003e,\n    }\n}\n\n/// L7: Application - Business logic\n#[allow(non_snake_case)]\npub mod L7 {\n    use super::*;\n\n    pub trait Application: LayerBound {\n        const LAYER: Layer = Layer::L7Application;\n\n        type State;\n        type Action;\n\n        fn reduce(state: \u0026Self::State, action: Self::Action) -\u003e Self::State;\n    }\n}\n\n/// L6: Features - Feature modules  \n#[allow(non_snake_case)]\npub mod L6 {\n    use super::*;\n\n    pub trait Feature: LayerBound {\n        const LAYER: Layer = Layer::L6Features;\n        const NAME: \u0026'static str;\n\n        type Config;\n\n        fn initialize(config: Self::Config);\n    }\n}\n\n/// L5: Components - UI components\n#[allow(non_snake_case)]\npub mod L5 {\n    use super::*;\n    use crate::component::Component;\n\n    pub trait UIComponent: Component + LayerBound {\n        const LAYER: Layer = Layer::L5Components;\n    }\n}\n\n/// L4: Services - Server/Client services\n#[allow(non_snake_case)]\npub mod L4 {\n    use super::*;\n\n    pub trait Service: LayerBound {\n        const LAYER: Layer = Layer::L4Services;\n\n        type Request;\n        type Response;\n\n        fn handle(\u0026self, req: Self::Request) -\u003e impl std::future::Future\u003cOutput = Self::Response\u003e;\n    }\n}\n\n/// L3: Runtime - Execution environment\n#[allow(non_snake_case)]\npub mod L3 {\n    use super::*;\n\n    pub enum Runtime {\n        Server,\n        Client,\n        Edge,\n    }\n\n    pub trait RuntimeBound: LayerBound {\n        const LAYER: Layer = Layer::L3Runtime;\n        const RUNTIME: Runtime;\n    }\n}\n\n/// L2: Platform - Next.js compatibility\n#[allow(non_snake_case)]\npub mod L2 {\n    use super::*;\n\n    pub trait Platform: LayerBound {\n        const LAYER: Layer = Layer::L2Platform;\n\n        fn to_nextjs_route(\u0026self) -\u003e String;\n        fn to_nextjs_api(\u0026self) -\u003e String;\n    }\n}\n\n/// L1: Infrastructure - Build and deploy\n#[allow(non_snake_case)]\npub mod L1 {\n    use super::*;\n\n    pub trait Infrastructure: LayerBound {\n        const LAYER: Layer = Layer::L1Infrastructure;\n\n        fn build_config() -\u003e BuildConfig;\n    }\n\n    pub struct BuildConfig {\n        pub target: Target,\n        pub optimizations: Vec\u003cOptimization\u003e,\n    }\n\n    pub enum Target {\n        Vercel,\n        Netlify,\n        Cloudflare,\n        Docker,\n    }\n\n    pub enum Optimization {\n        MinifyWasm,\n        TreeShake,\n        PreRender,\n    }\n}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","lib.rs"],"content":"//! Layer9 Core - Hierarchical Web Framework\n//!\n//! L9 Philosophy: Consciousness-aware web development\n//! L8 Architecture: Enforced layer separation\n//! L7 Application: Business logic isolation\n//! L6 Features: Modular feature system\n//! L5 Components: Type-safe reactive components\n//! L4 Services: Server/Client boundary\n//! L3 Runtime: Layer9SM/JS execution\n//! L2 Platform: Next.js compatibility\n//! L1 Infrastructure: Build and deploy\n\npub mod api_docs;\npub mod app;\n// pub mod async_component; // Using v2 instead\npub mod async_component_v2;\npub mod auth;\n#[cfg(test)]\nmod auth_tests;\n#[cfg(test)]\nmod auth_config_tests;\n#[cfg(test)]\nmod auth_upload_integration_tests;\npub mod cache;\npub mod config;\npub mod jwt;\npub mod component;\npub mod css_runtime;\npub mod styled_component;\npub mod db;\n#[cfg(feature = \"ssr\")]\npub mod db_api;\n#[cfg(feature = \"ssr\")]\npub mod db_sqlx;\n#[cfg(feature = \"ssr\")]\npub mod db_sqlite;\npub mod env;\npub mod error;\npub mod fetch;\npub mod form;\npub mod form_traits;\npub mod form_builder;\npub mod hooks;\npub mod i18n;\npub mod image;\npub mod image_lazy;\n#[cfg(feature = \"ssr\")]\npub mod image_transform;\n#[cfg(feature = \"ssr\")]\npub mod image_handler;\npub mod layers;\npub mod middleware;\npub mod middleware_v2;\npub mod monitoring;\n// pub mod reactive; // Using v2 to fix borrowing issues\npub mod reactive_v2;\npub mod router;\npub mod router_v2;\npub mod security;\npub mod server;\n#[cfg(feature = \"ssr\")]\npub mod ssr;\n#[cfg(all(test, feature = \"ssr\"))]\nmod ssr_tests;\npub mod state;\npub mod styles;\npub mod test;\npub mod ui;\npub mod upload;\n#[cfg(test)]\nmod upload_tests;\npub mod vdom;\npub mod websocket;\n\n// HAF (Hierarchical Architecture First) system\npub mod haf;\n\npub mod prelude {\n    pub use crate::api_docs::{ApiDoc, OpenApiBuilder, SchemaBuilder};\n    pub use crate::app::{run_app, Layer9App};\n    pub use crate::async_component_v2::{\n        use_async_data, with_error_boundary, \n        AsyncData, AsyncState, Suspense\n    };\n    pub use crate::auth::{use_auth, AuthService, Protected};\n    pub use crate::cache::{use_cache, use_http_cache, InvalidationStrategy};\n    pub use crate::component::{use_state, view, Component, Element, Props, State};\n    pub use crate::db::{use_db, use_repository, Model, QueryBuilder};\n    pub use crate::env::{env, env_or, is_development, is_production};\n    pub use crate::error::{use_error_handler, ErrorBoundary};\n    pub use crate::fetch::{get, post, FetchBuilder, Method, SWR};\n    pub use crate::form::{use_form, Form, FormConfig};\n    pub use crate::hooks::{\n        use_state as use_state_hook, use_reducer, use_effect, use_memo, use_callback, \n        use_ref, use_layout_effect, use_context, provide_context, Context as HookContext,\n        use_counter, use_previous, use_debounce\n    };\n    pub use crate::i18n::{use_i18n, Locale};\n    pub use crate::image::{Image, Picture};\n    pub use crate::image_lazy::{LazyImage, LazyLoadManager, use_lazy_image};\n    pub use crate::layers::*;\n    pub use crate::middleware::{Context, Middleware, MiddlewareStack};\n    pub use crate::monitoring::{use_analytics, use_metrics, use_performance};\n    pub use crate::reactive_v2::{init_renderer, mount, queue_current_render};\n    pub use crate::router::{Page, Route, RouteHandler};\n    pub use crate::router_v2::{init_router, navigate, route, use_route, use_router, Link};\n    pub use crate::security::{use_csrf_token, use_security, XssProtection};\n    pub use crate::server::{Response, ServerError, ServerFunction};\n    #[cfg(feature = \"ssr\")]\n    pub use crate::ssr::{\n        SSRComponent, SSRContext, SSRRenderer, SSRApp, SSRRoute, SSRRouteHandler,\n        create_ssr_server, SSRData\n    };\n    \n    #[cfg(all(feature = \"ssr\", target_arch = \"wasm32\"))]\n    pub use crate::ssr::{use_ssr_data, hydrate_app};\n    pub use crate::state::{\n        create_app_store, create_atom, use_atom, use_selector, AppAction, AppState,\n        // Note: use_effect is now provided by hooks module\n    };\n    pub use crate::styles::{inject_global_styles, style, StyleBuilder};\n    pub use crate::css_runtime::{\n        css_props, inject_global_styles as inject_css_runtime, \n        Animation, Breakpoint, CssBuilder, CssVariables\n    };\n    pub use crate::styled_component::{styled, ComponentStyling, StyledComponent, styles};\n    pub use crate::test::{TestContext, TestResult, TestUtils};\n    pub use crate::ui::*;\n    pub use crate::upload::{FileUpload, FileUploadManager, UploadStatus};\n    pub use crate::websocket::{use_websocket, WsMessage, WsState};\n}\n\n// Layer validation at compile time\n#[macro_export]\nmacro_rules! enforce_layer {\n    ($from:expr, $to:expr) =\u003e {\n        const _: () = {\n            assert!(\n                $from \u003e= $to,\n                \"Invalid layer access: higher layers cannot access lower layers directly\"\n            );\n        };\n    };\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","middleware.rs"],"content":"//! Middleware System - L3/L4\n\nuse crate::auth::User;\nuse crate::prelude::*;\nuse crate::router_v2::RouteParams;\nuse async_trait::async_trait;\nuse std::cell::RefCell;\nuse std::rc::Rc;\n\n// Type alias to simplify complex types\ntype VerifyTokenFn = Box\u003cdyn Fn(\u0026str) -\u003e Option\u003cUser\u003e\u003e;\n\n/// Middleware context\npub struct Context {\n    pub request: Request,\n    pub response: Response,\n    pub state: State,\n    pub params: RouteParams,\n}\n\n/// Request object\n#[derive(Clone)]\npub struct Request {\n    pub method: Method,\n    pub url: String,\n    pub headers: HashMap\u003cString, String\u003e,\n    pub body: Option\u003cString\u003e,\n    pub user: Option\u003cUser\u003e,\n}\n\n/// Response object\n#[derive(Clone)]\npub struct Response {\n    pub status: u16,\n    pub headers: HashMap\u003cString, String\u003e,\n    pub body: Option\u003cString\u003e,\n}\n\nimpl Default for Response {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Response {\n    pub fn new() -\u003e Self {\n        Response {\n            status: 200,\n            headers: HashMap::new(),\n            body: None,\n        }\n    }\n\n    pub fn with_status(mut self, status: u16) -\u003e Self {\n        self.status = status;\n        self\n    }\n\n    pub fn with_header(mut self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) -\u003e Self {\n        self.headers.insert(key.into(), value.into());\n        self\n    }\n\n    pub fn with_body(mut self, body: impl Into\u003cString\u003e) -\u003e Self {\n        self.body = Some(body.into());\n        self\n    }\n\n    pub fn json\u003cT: Serialize\u003e(mut self, data: \u0026T) -\u003e Result\u003cSelf, String\u003e {\n        let json = serde_json::to_string(data).map_err(|e| e.to_string())?;\n        self.headers\n            .insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n        self.body = Some(json);\n        Ok(self)\n    }\n}\n\n/// State container for middleware\npub type State = HashMap\u003cString, Box\u003cdyn std::any::Any\u003e\u003e;\n\n/// Middleware trait - simplified version\n#[async_trait(?Send)]\npub trait Middleware: 'static {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e;\n}\n\n/// Middleware error\n#[derive(Debug, Clone)]\npub struct MiddlewareError {\n    pub status: u16,\n    pub message: String,\n}\n\nimpl From\u003cString\u003e for MiddlewareError {\n    fn from(message: String) -\u003e Self {\n        MiddlewareError {\n            status: 500,\n            message,\n        }\n    }\n}\n\n/// Middleware stack\npub struct MiddlewareStack {\n    middlewares: Vec\u003cBox\u003cdyn Middleware\u003e\u003e,\n}\n\nimpl Default for MiddlewareStack {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl MiddlewareStack {\n    pub fn new() -\u003e Self {\n        MiddlewareStack {\n            middlewares: vec![],\n        }\n    }\n\n    pub fn use_middleware(mut self, middleware: impl Middleware) -\u003e Self {\n        self.middlewares.push(Box::new(middleware));\n        self\n    }\n\n    pub async fn run(\u0026self, mut ctx: Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Run each middleware in sequence\n        for middleware in \u0026self.middlewares {\n            let result = middleware.handle(\u0026mut ctx).await?;\n            ctx.response = result;\n        }\n        \n        // Return the final response\n        Ok(ctx.response)\n    }\n}\n\n/// Wrapper for middleware that needs to call next\npub struct ChainedMiddleware\u003cM\u003e {\n    middleware: M,\n    next: Option\u003cBox\u003cdyn Middleware\u003e\u003e,\n}\n\nimpl\u003cM: Middleware\u003e ChainedMiddleware\u003cM\u003e {\n    pub fn new(middleware: M) -\u003e Self {\n        ChainedMiddleware {\n            middleware,\n            next: None,\n        }\n    }\n    \n    pub fn chain(mut self, next: impl Middleware) -\u003e Self {\n        self.next = Some(Box::new(next));\n        self\n    }\n}\n\n#[async_trait(?Send)]\nimpl\u003cM: Middleware\u003e Middleware for ChainedMiddleware\u003cM\u003e {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Run this middleware\n        let result = self.middleware.handle(ctx).await?;\n        ctx.response = result;\n        \n        // Run next middleware if exists\n        if let Some(next) = \u0026self.next {\n            next.handle(ctx).await\n        } else {\n            Ok(ctx.response.clone())\n        }\n    }\n}\n\n/// Authentication middleware\npub struct AuthMiddleware {\n    verify_token: VerifyTokenFn,\n}\n\nimpl AuthMiddleware {\n    pub fn new(verify_token: impl Fn(\u0026str) -\u003e Option\u003cUser\u003e + 'static) -\u003e Self {\n        AuthMiddleware {\n            verify_token: Box::new(verify_token),\n        }\n    }\n}\n\n#[async_trait(?Send)]\nimpl Middleware for AuthMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Check for auth header\n        if let Some(auth_header) = ctx.request.headers.get(\"Authorization\") {\n            if let Some(token) = auth_header.strip_prefix(\"Bearer \") {\n                if let Some(user) = (self.verify_token)(token) {\n                    ctx.request.user = Some(user);\n                }\n            }\n        }\n\n        // Return the existing response (middleware should be chained properly)\n        Ok(ctx.response.clone())\n    }\n}\n\n/// CORS middleware\npub struct CorsMiddleware {\n    allowed_origins: Vec\u003cString\u003e,\n    allowed_methods: Vec\u003cString\u003e,\n    allowed_headers: Vec\u003cString\u003e,\n}\n\nimpl Default for CorsMiddleware {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl CorsMiddleware {\n    pub fn new() -\u003e Self {\n        CorsMiddleware {\n            allowed_origins: vec![\"*\".to_string()],\n            allowed_methods: vec![\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"]\n                .into_iter()\n                .map(|s| s.to_string())\n                .collect(),\n            allowed_headers: vec![\"Content-Type\", \"Authorization\"]\n                .into_iter()\n                .map(|s| s.to_string())\n                .collect(),\n        }\n    }\n\n    pub fn allow_origin(mut self, origin: impl Into\u003cString\u003e) -\u003e Self {\n        self.allowed_origins.push(origin.into());\n        self\n    }\n}\n\n#[async_trait(?Send)]\nimpl Middleware for CorsMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Handle preflight\n        if ctx.request.method == Method::OPTIONS {\n            return Ok(Response::new()\n                .with_status(204)\n                .with_header(\"Access-Control-Allow-Origin\", \"*\")\n                .with_header(\n                    \"Access-Control-Allow-Methods\",\n                    self.allowed_methods.join(\", \"),\n                )\n                .with_header(\n                    \"Access-Control-Allow-Headers\",\n                    self.allowed_headers.join(\", \"),\n                ));\n        }\n\n        // Add CORS headers to response\n        ctx.response\n            .headers\n            .insert(\"Access-Control-Allow-Origin\".to_string(), \"*\".to_string());\n\n        Ok(ctx.response.clone())\n    }\n}\n\n/// Rate limiting middleware\npub struct RateLimitMiddleware {\n    store: Rc\u003cRefCell\u003cHashMap\u003cString, RateLimitEntry\u003e\u003e\u003e,\n    max_requests: u32,\n    window_ms: u64,\n}\n\nstruct RateLimitEntry {\n    count: u32,\n    reset_at: u64,\n}\n\nimpl RateLimitMiddleware {\n    pub fn new(max_requests: u32, window_ms: u64) -\u003e Self {\n        RateLimitMiddleware {\n            store: Rc::new(RefCell::new(HashMap::new())),\n            max_requests,\n            window_ms,\n        }\n    }\n}\n\n#[async_trait(?Send)]\nimpl Middleware for RateLimitMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        let now = js_sys::Date::now() as u64;\n        let client_id = ctx\n            .request\n            .headers\n            .get(\"X-Client-Id\")\n            .or_else(|| ctx.request.user.as_ref().map(|u| \u0026u.id))\n            .cloned()\n            .unwrap_or_else(|| \"anonymous\".to_string());\n\n        let current_count = {\n            let mut store = self.store.borrow_mut();\n            let entry = store.entry(client_id.clone()).or_insert(RateLimitEntry {\n                count: 0,\n                reset_at: now + self.window_ms,\n            });\n\n            // Reset if window expired\n            if now \u003e entry.reset_at {\n                entry.count = 0;\n                entry.reset_at = now + self.window_ms;\n            }\n\n            // Check rate limit\n            if entry.count \u003e= self.max_requests {\n                return Err(MiddlewareError {\n                    status: 429,\n                    message: \"Too many requests\".to_string(),\n                });\n            }\n\n            entry.count += 1;\n            entry.count\n        };\n\n        // Add rate limit headers\n        ctx.response.headers.insert(\n            \"X-RateLimit-Limit\".to_string(),\n            self.max_requests.to_string(),\n        );\n        ctx.response.headers.insert(\n            \"X-RateLimit-Remaining\".to_string(),\n            (self.max_requests - current_count).to_string(),\n        );\n\n        Ok(ctx.response.clone())\n    }\n}\n\n/// Logging middleware\npub struct LoggingMiddleware {\n    logger: Box\u003cdyn Fn(LogEntry)\u003e,\n}\n\npub struct LogEntry {\n    pub method: String,\n    pub url: String,\n    pub status: u16,\n    pub duration_ms: f64,\n    pub user_id: Option\u003cString\u003e,\n}\n\nimpl LoggingMiddleware {\n    pub fn new(logger: impl Fn(LogEntry) + 'static) -\u003e Self {\n        LoggingMiddleware {\n            logger: Box::new(logger),\n        }\n    }\n}\n\n#[async_trait(?Send)]\nimpl Middleware for LoggingMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        let start = js_sys::Date::now();\n\n        // Log after processing (in real chain, this would be after next())\n        let duration_ms = js_sys::Date::now() - start;\n\n        (self.logger)(LogEntry {\n            method: format!(\"{:?}\", ctx.request.method),\n            url: ctx.request.url.clone(),\n            status: ctx.response.status,\n            duration_ms,\n            user_id: ctx.request.user.as_ref().map(|u| u.id.clone()),\n        });\n\n        Ok(ctx.response.clone())\n    }\n}\n\n/// Compression middleware\npub struct CompressionMiddleware;\n\n#[async_trait(?Send)]\nimpl Middleware for CompressionMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Check if client accepts gzip\n        if let Some(accept_encoding) = ctx.request.headers.get(\"Accept-Encoding\") {\n            if accept_encoding.contains(\"gzip\") \u0026\u0026 ctx.response.body.is_some() {\n                // In real implementation, compress the body\n                ctx.response\n                    .headers\n                    .insert(\"Content-Encoding\".to_string(), \"gzip\".to_string());\n            }\n        }\n\n        Ok(ctx.response.clone())\n    }\n}\n\n/// Security headers middleware\npub struct SecurityMiddleware;\n\n#[async_trait(?Send)]\nimpl Middleware for SecurityMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Add security headers\n        ctx.response\n            .headers\n            .insert(\"X-Content-Type-Options\".to_string(), \"nosniff\".to_string());\n        ctx.response\n            .headers\n            .insert(\"X-Frame-Options\".to_string(), \"DENY\".to_string());\n        ctx.response\n            .headers\n            .insert(\"X-XSS-Protection\".to_string(), \"1; mode=block\".to_string());\n        ctx.response.headers.insert(\n            \"Referrer-Policy\".to_string(),\n            \"strict-origin-when-cross-origin\".to_string(),\n        );\n        ctx.response.headers.insert(\n            \"Content-Security-Policy\".to_string(),\n            \"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'\".to_string()\n        );\n\n        Ok(ctx.response.clone())\n    }\n}\n\n// Re-exports\nuse serde::Serialize;\nuse std::collections::HashMap;","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":129},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","middleware_v2.rs"],"content":"//! Middleware System V2 - Proper chaining implementation\n\nuse crate::auth::User;\nuse crate::prelude::*;\npub use crate::router_v2::RouteParams;\nuse async_trait::async_trait;\nuse std::cell::RefCell;\nuse std::future::Future;\nuse std::pin::Pin;\nuse std::rc::Rc;\n\n/// Middleware context\npub struct Context {\n    pub request: Request,\n    pub response: Response,\n    pub state: State,\n    pub params: RouteParams,\n}\n\n/// Request object\n#[derive(Clone)]\npub struct Request {\n    pub method: Method,\n    pub url: String,\n    pub headers: HashMap\u003cString, String\u003e,\n    pub body: Option\u003cString\u003e,\n    pub user: Option\u003cUser\u003e,\n}\n\n/// Response object\n#[derive(Clone)]\npub struct Response {\n    pub status: u16,\n    pub headers: HashMap\u003cString, String\u003e,\n    pub body: Option\u003cString\u003e,\n}\n\nimpl Default for Response {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Response {\n    pub fn new() -\u003e Self {\n        Response {\n            status: 200,\n            headers: HashMap::new(),\n            body: None,\n        }\n    }\n\n    pub fn with_status(mut self, status: u16) -\u003e Self {\n        self.status = status;\n        self\n    }\n\n    pub fn with_header(mut self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) -\u003e Self {\n        self.headers.insert(key.into(), value.into());\n        self\n    }\n\n    pub fn with_body(mut self, body: impl Into\u003cString\u003e) -\u003e Self {\n        self.body = Some(body.into());\n        self\n    }\n\n    pub fn json\u003cT: Serialize\u003e(mut self, data: \u0026T) -\u003e Result\u003cSelf, String\u003e {\n        let json = serde_json::to_string(data).map_err(|e| e.to_string())?;\n        self.headers\n            .insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n        self.body = Some(json);\n        Ok(self)\n    }\n}\n\n/// State container for middleware\npub type State = HashMap\u003cString, Box\u003cdyn std::any::Any\u003e\u003e;\n\n/// Next function type\npub type Next = Box\u003cdyn FnOnce() -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cResponse, MiddlewareError\u003e\u003e\u003e\u003e\u003e;\n\n/// Middleware trait\n#[async_trait(?Send)]\npub trait Middleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context, next: Next) -\u003e Result\u003cResponse, MiddlewareError\u003e;\n}\n\n/// Middleware error\n#[derive(Debug, Clone)]\npub struct MiddlewareError {\n    pub status: u16,\n    pub message: String,\n}\n\nimpl From\u003cString\u003e for MiddlewareError {\n    fn from(message: String) -\u003e Self {\n        MiddlewareError {\n            status: 500,\n            message,\n        }\n    }\n}\n\n/// Middleware chain builder\npub struct MiddlewareStack {\n    middlewares: Vec\u003cRc\u003cdyn Middleware\u003e\u003e,\n}\n\nimpl Default for MiddlewareStack {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl MiddlewareStack {\n    pub fn new() -\u003e Self {\n        MiddlewareStack {\n            middlewares: vec![],\n        }\n    }\n\n    pub fn use_middleware(mut self, middleware: impl Middleware + 'static) -\u003e Self {\n        self.middlewares.push(Rc::new(middleware));\n        self\n    }\n\n    #[allow(clippy::await_holding_refcell_ref)]\n    pub async fn run(\u0026self, ctx: Context) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        // Create a shared context wrapped in Rc\u003cRefCell\u003e\n        let ctx_rc = Rc::new(RefCell::new(ctx));\n        \n        // Create the final handler that returns the response from context\n        let final_handler = {\n            let ctx_clone = ctx_rc.clone();\n            move || -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cResponse, MiddlewareError\u003e\u003e\u003e\u003e {\n                Box::pin(async move {\n                    Ok(ctx_clone.borrow().response.clone())\n                })\n            }\n        };\n        \n        // Build the middleware chain in reverse order\n        let chain = self.middlewares.iter().rev().fold(\n            Box::new(final_handler) as Box\u003cdyn FnOnce() -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cResponse, MiddlewareError\u003e\u003e\u003e\u003e\u003e,\n            |next, middleware| {\n                let middleware = middleware.clone();\n                let ctx_clone = ctx_rc.clone();\n                Box::new(move || {\n                    Box::pin(async move {\n                        let result = {\n                            let mut ctx_mut = ctx_clone.borrow_mut();\n                            middleware.handle(\u0026mut ctx_mut, next).await\n                        };\n                        result\n                    })\n                })\n            }\n        );\n        \n        // Execute the chain\n        chain().await\n    }\n}\n\n// Re-exports\nuse serde::Serialize;\nuse std::collections::HashMap;","traces":[{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":45},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","monitoring.rs"],"content":"//! Monitoring and Observability - L3/L4\n//! Performance monitoring, error tracking, and distributed tracing\n\nuse serde::{Deserialize, Serialize};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse web_sys::Performance;\n\n/// Metrics types\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum MetricType {\n    Counter,\n    Gauge,\n    Histogram,\n    Timer,\n}\n\n/// Metric value\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum MetricValue {\n    Count(u64),\n    Gauge(f64),\n    Histogram(Vec\u003cf64\u003e),\n    Duration(f64),\n}\n\n/// Metric data point\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MetricPoint {\n    pub name: String,\n    pub metric_type: MetricType,\n    pub value: MetricValue,\n    pub tags: HashMap\u003cString, String\u003e,\n    pub timestamp: f64,\n}\n\n/// Metrics collector\npub struct MetricsCollector {\n    metrics: Rc\u003cRefCell\u003cVec\u003cMetricPoint\u003e\u003e\u003e,\n    exporters: Vec\u003cBox\u003cdyn MetricsExporter\u003e\u003e,\n    buffer_size: usize,\n}\n\nimpl MetricsCollector {\n    pub fn new(buffer_size: usize) -\u003e Self {\n        MetricsCollector {\n            metrics: Rc::new(RefCell::new(Vec::with_capacity(buffer_size))),\n            exporters: vec![],\n            buffer_size,\n        }\n    }\n\n    pub fn add_exporter(mut self, exporter: impl MetricsExporter + 'static) -\u003e Self {\n        self.exporters.push(Box::new(exporter));\n        self\n    }\n\n    pub fn record(\u0026self, metric: MetricPoint) {\n        let mut metrics = self.metrics.borrow_mut();\n        metrics.push(metric);\n\n        // Export if buffer is full\n        if metrics.len() \u003e= self.buffer_size {\n            let batch = metrics.drain(..).collect::\u003cVec\u003c_\u003e\u003e();\n            drop(metrics);\n\n            for exporter in \u0026self.exporters {\n                exporter.export(batch.clone());\n            }\n        }\n    }\n\n    pub fn flush(\u0026self) {\n        let mut metrics = self.metrics.borrow_mut();\n        if !metrics.is_empty() {\n            let batch = metrics.drain(..).collect::\u003cVec\u003c_\u003e\u003e();\n            drop(metrics);\n\n            for exporter in \u0026self.exporters {\n                exporter.export(batch.clone());\n            }\n        }\n    }\n\n    pub fn counter(\u0026self, name: impl Into\u003cString\u003e, value: u64, tags: HashMap\u003cString, String\u003e) {\n        self.record(MetricPoint {\n            name: name.into(),\n            metric_type: MetricType::Counter,\n            value: MetricValue::Count(value),\n            tags,\n            timestamp: js_sys::Date::now(),\n        });\n    }\n\n    pub fn gauge(\u0026self, name: impl Into\u003cString\u003e, value: f64, tags: HashMap\u003cString, String\u003e) {\n        self.record(MetricPoint {\n            name: name.into(),\n            metric_type: MetricType::Gauge,\n            value: MetricValue::Gauge(value),\n            tags,\n            timestamp: js_sys::Date::now(),\n        });\n    }\n\n    pub fn timer(\u0026self, name: impl Into\u003cString\u003e, duration: f64, tags: HashMap\u003cString, String\u003e) {\n        self.record(MetricPoint {\n            name: name.into(),\n            metric_type: MetricType::Timer,\n            value: MetricValue::Duration(duration),\n            tags,\n            timestamp: js_sys::Date::now(),\n        });\n    }\n}\n\n/// Metrics exporter trait\npub trait MetricsExporter: 'static {\n    fn export(\u0026self, metrics: Vec\u003cMetricPoint\u003e);\n}\n\n/// Console metrics exporter\npub struct ConsoleExporter;\n\nimpl MetricsExporter for ConsoleExporter {\n    fn export(\u0026self, metrics: Vec\u003cMetricPoint\u003e) {\n        for metric in metrics {\n            web_sys::console::log_1(\u0026format!(\"[METRIC] {:?}\", metric).into());\n        }\n    }\n}\n\n/// HTTP metrics exporter\npub struct HttpExporter {\n    endpoint: String,\n    api_key: Option\u003cString\u003e,\n}\n\nimpl HttpExporter {\n    pub fn new(endpoint: impl Into\u003cString\u003e) -\u003e Self {\n        HttpExporter {\n            endpoint: endpoint.into(),\n            api_key: None,\n        }\n    }\n\n    pub fn with_api_key(mut self, api_key: impl Into\u003cString\u003e) -\u003e Self {\n        self.api_key = Some(api_key.into());\n        self\n    }\n}\n\nimpl MetricsExporter for HttpExporter {\n    fn export(\u0026self, metrics: Vec\u003cMetricPoint\u003e) {\n        let endpoint = self.endpoint.clone();\n        let api_key = self.api_key.clone();\n\n        wasm_bindgen_futures::spawn_local(async move {\n            let body = serde_json::to_string(\u0026metrics).unwrap();\n            let mut headers = HashMap::new();\n            headers.insert(\"Content-Type\".to_string(), \"application/json\".to_string());\n\n            if let Some(key) = api_key {\n                headers.insert(\"X-API-Key\".to_string(), key);\n            }\n\n            let mut fetch_builder =\n                crate::fetch::FetchBuilder::new(\u0026endpoint).method(crate::fetch::Method::POST);\n\n            for (key, value) in headers {\n                fetch_builder = fetch_builder.header(key, value);\n            }\n\n            if let Ok(builder) =\n                fetch_builder.json(\u0026serde_json::from_str::\u003cserde_json::Value\u003e(\u0026body).unwrap())\n            {\n                let _ = builder.send().await;\n            }\n        });\n    }\n}\n\n/// Performance monitoring\npub struct PerformanceMonitor {\n    entries: Rc\u003cRefCell\u003cHashMap\u003cString, PerformanceEntry\u003e\u003e\u003e,\n    collector: Rc\u003cMetricsCollector\u003e,\n}\n\n#[derive(Clone)]\nstruct PerformanceEntry {\n    start_time: f64,\n    marks: HashMap\u003cString, f64\u003e,\n}\n\nimpl PerformanceMonitor {\n    pub fn new(collector: Rc\u003cMetricsCollector\u003e) -\u003e Self {\n        PerformanceMonitor {\n            entries: Rc::new(RefCell::new(HashMap::new())),\n            collector,\n        }\n    }\n\n    pub fn start_timing(\u0026self, name: impl Into\u003cString\u003e) -\u003e TimingHandle {\n        let name = name.into();\n        let start_time = self.now();\n\n        self.entries.borrow_mut().insert(\n            name.clone(),\n            PerformanceEntry {\n                start_time,\n                marks: HashMap::new(),\n            },\n        );\n\n        TimingHandle {\n            name,\n            monitor: self.clone(),\n        }\n    }\n\n    pub fn mark(\u0026self, timing_name: \u0026str, mark_name: impl Into\u003cString\u003e) {\n        if let Some(entry) = self.entries.borrow_mut().get_mut(timing_name) {\n            entry.marks.insert(mark_name.into(), self.now());\n        }\n    }\n\n    pub fn end_timing(\u0026self, name: \u0026str, tags: HashMap\u003cString, String\u003e) {\n        if let Some(entry) = self.entries.borrow_mut().remove(name) {\n            let duration = self.now() - entry.start_time;\n            self.collector.timer(name, duration, tags);\n\n            // Also record marks as separate metrics\n            for (mark_name, mark_time) in entry.marks {\n                let mark_duration = mark_time - entry.start_time;\n                self.collector.timer(\n                    format!(\"{}.{}\", name, mark_name),\n                    mark_duration,\n                    HashMap::new(),\n                );\n            }\n        }\n    }\n\n    fn now(\u0026self) -\u003e f64 {\n        Performance::now(\u0026web_sys::window().unwrap().performance().unwrap())\n    }\n}\n\nimpl Clone for PerformanceMonitor {\n    fn clone(\u0026self) -\u003e Self {\n        PerformanceMonitor {\n            entries: self.entries.clone(),\n            collector: self.collector.clone(),\n        }\n    }\n}\n\n/// Timing handle for automatic timing\npub struct TimingHandle {\n    name: String,\n    monitor: PerformanceMonitor,\n}\n\nimpl TimingHandle {\n    pub fn mark(\u0026self, mark_name: impl Into\u003cString\u003e) {\n        self.monitor.mark(\u0026self.name, mark_name);\n    }\n}\n\nimpl Drop for TimingHandle {\n    fn drop(\u0026mut self) {\n        self.monitor.end_timing(\u0026self.name, HashMap::new());\n    }\n}\n\n/// Error tracking\n#[derive(Clone)]\npub struct ErrorTracker {\n    collector: Rc\u003cMetricsCollector\u003e,\n    context: Rc\u003cRefCell\u003cHashMap\u003cString, String\u003e\u003e\u003e,\n}\n\nimpl ErrorTracker {\n    pub fn new(collector: Rc\u003cMetricsCollector\u003e) -\u003e Self {\n        ErrorTracker {\n            collector,\n            context: Rc::new(RefCell::new(HashMap::new())),\n        }\n    }\n\n    pub fn set_context(\u0026self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) {\n        self.context.borrow_mut().insert(key.into(), value.into());\n    }\n\n    pub fn track_error(\u0026self, error: \u0026JsValue) {\n        let mut tags = self.context.borrow().clone();\n\n        // Extract error details\n        if let Some(error_obj) = error.dyn_ref::\u003cjs_sys::Error\u003e() {\n            tags.insert(\"message\".to_string(), error_obj.message().into());\n            tags.insert(\"name\".to_string(), error_obj.name().into());\n\n            // Stack trace is not available on js_sys::Error in wasm-bindgen\n            // We could use Reflect::get to access it if needed\n        } else {\n            tags.insert(\"message\".to_string(), format!(\"{:?}\", error));\n        }\n\n        self.collector.counter(\"error\", 1, tags);\n    }\n\n    pub fn track_panic(\u0026self, info: \u0026std::panic::PanicHookInfo) {\n        let mut tags = self.context.borrow().clone();\n\n        tags.insert(\"type\".to_string(), \"panic\".to_string());\n        tags.insert(\"message\".to_string(), info.to_string());\n\n        if let Some(location) = info.location() {\n            tags.insert(\"file\".to_string(), location.file().to_string());\n            tags.insert(\"line\".to_string(), location.line().to_string());\n            tags.insert(\"column\".to_string(), location.column().to_string());\n        }\n\n        self.collector.counter(\"panic\", 1, tags);\n    }\n}\n\n/// Distributed tracing\npub struct TraceSpan {\n    trace_id: String,\n    span_id: String,\n    parent_span_id: Option\u003cString\u003e,\n    name: String,\n    start_time: f64,\n    attributes: HashMap\u003cString, String\u003e,\n    events: Vec\u003cSpanEvent\u003e,\n    collector: Rc\u003cMetricsCollector\u003e,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct SpanEvent {\n    name: String,\n    timestamp: f64,\n    attributes: HashMap\u003cString, String\u003e,\n}\n\nimpl TraceSpan {\n    pub fn new(name: impl Into\u003cString\u003e, collector: Rc\u003cMetricsCollector\u003e) -\u003e Self {\n        TraceSpan {\n            trace_id: generate_trace_id(),\n            span_id: generate_span_id(),\n            parent_span_id: None,\n            name: name.into(),\n            start_time: js_sys::Date::now(),\n            attributes: HashMap::new(),\n            events: vec![],\n            collector,\n        }\n    }\n\n    pub fn child(\u0026self, name: impl Into\u003cString\u003e) -\u003e Self {\n        TraceSpan {\n            trace_id: self.trace_id.clone(),\n            span_id: generate_span_id(),\n            parent_span_id: Some(self.span_id.clone()),\n            name: name.into(),\n            start_time: js_sys::Date::now(),\n            attributes: HashMap::new(),\n            events: vec![],\n            collector: self.collector.clone(),\n        }\n    }\n\n    pub fn set_attribute(\u0026mut self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) {\n        self.attributes.insert(key.into(), value.into());\n    }\n\n    pub fn add_event(\u0026mut self, name: impl Into\u003cString\u003e, attributes: HashMap\u003cString, String\u003e) {\n        self.events.push(SpanEvent {\n            name: name.into(),\n            timestamp: js_sys::Date::now(),\n            attributes,\n        });\n    }\n\n    pub fn end(self) {\n        let duration = js_sys::Date::now() - self.start_time;\n\n        let mut tags = self.attributes;\n        tags.insert(\"trace_id\".to_string(), self.trace_id);\n        tags.insert(\"span_id\".to_string(), self.span_id);\n\n        if let Some(parent) = self.parent_span_id {\n            tags.insert(\"parent_span_id\".to_string(), parent);\n        }\n\n        self.collector\n            .timer(format!(\"trace.{}\", self.name), duration, tags);\n\n        // Record events\n        for event in self.events {\n            self.collector.counter(\n                format!(\"trace.{}.event.{}\", self.name, event.name),\n                1,\n                event.attributes,\n            );\n        }\n    }\n}\n\n/// Generate trace ID\nfn generate_trace_id() -\u003e String {\n    format!(\"{:032x}\", (js_sys::Math::random() * 1e16) as u64)\n}\n\n/// Generate span ID\nfn generate_span_id() -\u003e String {\n    format!(\"{:016x}\", (js_sys::Math::random() * 1e8) as u64)\n}\n\n/// User analytics\n#[derive(Clone)]\npub struct Analytics {\n    collector: Rc\u003cMetricsCollector\u003e,\n    user_id: Option\u003cString\u003e,\n    session_id: String,\n}\n\nimpl Analytics {\n    pub fn new(collector: Rc\u003cMetricsCollector\u003e) -\u003e Self {\n        Analytics {\n            collector,\n            user_id: None,\n            session_id: generate_session_id(),\n        }\n    }\n\n    pub fn identify(\u0026mut self, user_id: impl Into\u003cString\u003e) {\n        self.user_id = Some(user_id.into());\n    }\n\n    pub fn track_event(\u0026self, event_name: impl Into\u003cString\u003e, properties: HashMap\u003cString, String\u003e) {\n        let mut tags = properties;\n        tags.insert(\"session_id\".to_string(), self.session_id.clone());\n\n        if let Some(user_id) = \u0026self.user_id {\n            tags.insert(\"user_id\".to_string(), user_id.clone());\n        }\n\n        self.collector\n            .counter(format!(\"event.{}\", event_name.into()), 1, tags);\n    }\n\n    pub fn track_page_view(\u0026self, path: \u0026str, title: Option\u003c\u0026str\u003e) {\n        let mut properties = HashMap::new();\n        properties.insert(\"path\".to_string(), path.to_string());\n\n        if let Some(title) = title {\n            properties.insert(\"title\".to_string(), title.to_string());\n        }\n\n        properties.insert(\n            \"referrer\".to_string(),\n            web_sys::window()\n                .and_then(|w| w.document())\n                .map(|d| d.referrer())\n                .unwrap_or_default(),\n        );\n\n        self.track_event(\"page_view\", properties);\n    }\n\n    pub fn track_click(\u0026self, element_id: \u0026str, element_text: Option\u003c\u0026str\u003e) {\n        let mut properties = HashMap::new();\n        properties.insert(\"element_id\".to_string(), element_id.to_string());\n\n        if let Some(text) = element_text {\n            properties.insert(\"element_text\".to_string(), text.to_string());\n        }\n\n        self.track_event(\"click\", properties);\n    }\n}\n\nfn generate_session_id() -\u003e String {\n    format!(\"session_{}\", js_sys::Date::now())\n}\n\nthread_local! {\n    static MONITORING: RefCell\u003cOption\u003cMonitoringSystem\u003e\u003e = const { RefCell::new(None) };\n}\n\npub struct MonitoringSystem {\n    pub metrics: Rc\u003cMetricsCollector\u003e,\n    pub performance: PerformanceMonitor,\n    pub errors: ErrorTracker,\n    pub analytics: Analytics,\n}\n\n/// Initialize monitoring\npub fn init_monitoring() {\n    let metrics = Rc::new(\n        MetricsCollector::new(100)\n            .add_exporter(ConsoleExporter)\n            .add_exporter(HttpExporter::new(\"/api/metrics\")),\n    );\n\n    let performance = PerformanceMonitor::new(metrics.clone());\n    let errors = ErrorTracker::new(metrics.clone());\n    let analytics = Analytics::new(metrics.clone());\n\n    let system = MonitoringSystem {\n        metrics,\n        performance,\n        errors,\n        analytics,\n    };\n\n    MONITORING.with(|monitoring| {\n        *monitoring.borrow_mut() = Some(system);\n    });\n\n    // Set up global error handler\n    std::panic::set_hook(Box::new(|info| {\n        MONITORING.with(|monitoring| {\n            if let Some(m) = monitoring.borrow().as_ref() {\n                m.errors.track_panic(info);\n            }\n        });\n    }));\n\n    // Set up periodic flush\n    let closure = Closure::\u003cdyn Fn()\u003e::new(|| {\n        MONITORING.with(|monitoring| {\n            if let Some(m) = monitoring.borrow().as_ref() {\n                m.metrics.flush();\n            }\n        });\n    });\n\n    web_sys::window()\n        .unwrap()\n        .set_interval_with_callback_and_timeout_and_arguments_0(\n            closure.as_ref().unchecked_ref(),\n            10000, // Flush every 10 seconds\n        )\n        .unwrap();\n\n    closure.forget();\n}\n\n/// Monitoring hooks\npub fn use_metrics() -\u003e Rc\u003cMetricsCollector\u003e {\n    MONITORING.with(|monitoring| {\n        monitoring\n            .borrow()\n            .as_ref()\n            .map(|m| m.metrics.clone())\n            .expect(\"Monitoring not initialized\")\n    })\n}\n\npub fn use_performance() -\u003e PerformanceMonitor {\n    MONITORING.with(|monitoring| {\n        monitoring\n            .borrow()\n            .as_ref()\n            .map(|m| m.performance.clone())\n            .expect(\"Monitoring not initialized\")\n    })\n}\n\npub fn use_error_tracker() -\u003e ErrorTracker {\n    MONITORING.with(|monitoring| {\n        monitoring\n            .borrow()\n            .as_ref()\n            .map(|m| m.errors.clone())\n            .expect(\"Monitoring not initialized\")\n    })\n}\n\npub fn use_analytics() -\u003e Analytics {\n    MONITORING.with(|monitoring| {\n        monitoring\n            .borrow()\n            .as_ref()\n            .map(|m| m.analytics.clone())\n            .expect(\"Monitoring not initialized\")\n    })\n}\n\n// Re-exports\nuse wasm_bindgen::closure::Closure;\n","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":212},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","reactive.rs"],"content":"//! Reactive Rendering System - L3\n//! \n//! This module provides the core reactive rendering engine for Layer9,\n//! including virtual DOM diffing, component lifecycle management, and\n//! automatic re-rendering on state changes.\n\nuse std::cell::RefCell;\nuse std::collections::{HashMap, HashSet};\nuse web_sys::{Element as DomElement, Node};\n\nuse crate::component::{Component, Element};\n\nthread_local! {\n    static RENDERER: RefCell\u003cOption\u003cRenderer\u003e\u003e = RefCell::new(None);\n}\n\n/// Initialize the global renderer\npub fn init_renderer() {\n    RENDERER.with(|r| {\n        *r.borrow_mut() = Some(Renderer::new());\n    });\n}\n\n/// Component instance with unique ID\npub struct ComponentInstance {\n    #[allow(dead_code)]\n    id: ComponentId,\n    component: Box\u003cdyn Component\u003e,\n    dom_node: Option\u003cNode\u003e,\n    vdom: Option\u003cElement\u003e,\n    parent_id: Option\u003cComponentId\u003e,\n    child_ids: Vec\u003cComponentId\u003e,\n    effects: Vec\u003cEffectCleanup\u003e,\n}\n\ntype ComponentId = u32;\ntype EffectCleanup = Box\u003cdyn FnOnce()\u003e;\n\n/// The main rendering engine\npub struct Renderer {\n    components: HashMap\u003cComponentId, ComponentInstance\u003e,\n    render_queue: HashSet\u003cComponentId\u003e,\n    next_id: ComponentId,\n    is_rendering: bool,\n    root_element: Option\u003cDomElement\u003e,\n}\n\nimpl Renderer {\n    fn new() -\u003e Self {\n        Renderer {\n            components: HashMap::new(),\n            render_queue: HashSet::new(),\n            next_id: 1,\n            is_rendering: false,\n            root_element: None,\n        }\n    }\n\n    /// Mount a component to a DOM element\n    pub fn mount_root(\u0026mut self, component: Box\u003cdyn Component\u003e, root_id: \u0026str) {\n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        let root_element = document\n            .get_element_by_id(root_id)\n            .expect(\"Root element not found\");\n\n        self.root_element = Some(root_element.clone());\n\n        // Create root component instance\n        let component_id = self.create_component_instance(component, None);\n        \n        // Initial render\n        self.render_component(component_id);\n        \n        // Mount to DOM\n        if let Some(instance) = self.components.get(\u0026component_id) {\n            if let Some(dom_node) = \u0026instance.dom_node {\n                root_element.append_child(dom_node).unwrap();\n            }\n        }\n    }\n\n    /// Create a new component instance\n    fn create_component_instance(\n        \u0026mut self,\n        component: Box\u003cdyn Component\u003e,\n        parent_id: Option\u003cComponentId\u003e,\n    ) -\u003e ComponentId {\n        let id = self.next_id;\n        self.next_id += 1;\n\n        let instance = ComponentInstance {\n            id,\n            component,\n            dom_node: None,\n            vdom: None,\n            parent_id,\n            child_ids: Vec::new(),\n            effects: Vec::new(),\n        };\n\n        self.components.insert(id, instance);\n\n        // Update parent's child list\n        if let Some(parent_id) = parent_id {\n            if let Some(parent) = self.components.get_mut(\u0026parent_id) {\n                parent.child_ids.push(id);\n            }\n        }\n\n        id\n    }\n\n    /// Queue a component for re-rendering\n    pub fn queue_render(\u0026mut self, component_id: ComponentId) {\n        self.render_queue.insert(component_id);\n        \n        if !self.is_rendering {\n            self.flush_render_queue();\n        }\n    }\n\n    /// Process all queued renders\n    fn flush_render_queue(\u0026mut self) {\n        self.is_rendering = true;\n\n        // Copy queue to avoid borrow issues\n        let queue: Vec\u003cComponentId\u003e = self.render_queue.drain().collect();\n\n        for component_id in queue {\n            self.render_component(component_id);\n        }\n\n        self.is_rendering = false;\n    }\n\n    /// Render a specific component\n    fn render_component(\u0026mut self, component_id: ComponentId) {\n        // Reset hook index before rendering\n        crate::hooks::reset_hook_index();\n        \n        // Get component and render new VDOM\n        let (new_vdom, old_vdom) = {\n            let instance = self.components.get(\u0026component_id).unwrap();\n            // Render within component context for hooks\n            let new_vdom = with_current_component(component_id, || {\n                instance.component.render()\n            });\n            let old_vdom = instance.vdom.clone();\n            (new_vdom, old_vdom)\n        };\n\n        // Perform diffing and patching\n        if let Some(old_vdom) = old_vdom {\n            // Diff and patch existing DOM\n            let patches = self.diff_elements(\u0026old_vdom, \u0026new_vdom);\n            self.apply_patches(component_id, patches);\n            \n            // Update stored VDOM\n            if let Some(instance) = self.components.get_mut(\u0026component_id) {\n                instance.vdom = Some(new_vdom);\n            }\n        } else {\n            // Initial render - create DOM\n            let dom_node = new_vdom.to_dom();\n            \n            if let Some(instance) = self.components.get_mut(\u0026component_id) {\n                instance.dom_node = Some(dom_node);\n                instance.vdom = Some(new_vdom);\n            }\n        }\n    }\n\n    /// Diff two virtual DOM elements\n    fn diff_elements(\u0026self, old: \u0026Element, new: \u0026Element) -\u003e Vec\u003cPatch\u003e {\n        let mut patches = Vec::new();\n        self.diff_recursive(old, new, \u0026[], \u0026mut patches);\n        patches\n    }\n\n    /// Recursive diffing algorithm\n    fn diff_recursive(\n        \u0026self,\n        old: \u0026Element,\n        new: \u0026Element,\n        path: \u0026[usize],\n        patches: \u0026mut Vec\u003cPatch\u003e,\n    ) {\n        match (old, new) {\n            (Element::Text(old_text), Element::Text(new_text)) =\u003e {\n                if old_text != new_text {\n                    patches.push(Patch::UpdateText {\n                        path: path.to_vec(),\n                        text: new_text.clone(),\n                    });\n                }\n            }\n            (\n                Element::Node { tag: old_tag, props: old_props, children: old_children },\n                Element::Node { tag: new_tag, props: new_props, children: new_children },\n            ) =\u003e {\n                if old_tag != new_tag {\n                    // Different tags - replace entire element\n                    patches.push(Patch::Replace {\n                        path: path.to_vec(),\n                        element: new.clone(),\n                    });\n                } else {\n                    // Same tag - diff props and children\n                    self.diff_props(old_props, new_props, path, patches);\n                    self.diff_children(old_children, new_children, path, patches);\n                }\n            }\n            _ =\u003e {\n                // Different types - replace\n                patches.push(Patch::Replace {\n                    path: path.to_vec(),\n                    element: new.clone(),\n                });\n            }\n        }\n    }\n\n    /// Diff properties\n    fn diff_props(\n        \u0026self,\n        _old_props: \u0026crate::component::Props,\n        _new_props: \u0026crate::component::Props,\n        _path: \u0026[usize],\n        _patches: \u0026mut Vec\u003cPatch\u003e,\n    ) {\n        // TODO: Implement property diffing\n        // For now, we'll rely on full element replacement\n    }\n\n    /// Diff children\n    fn diff_children(\n        \u0026self,\n        old_children: \u0026[Element],\n        new_children: \u0026[Element],\n        path: \u0026[usize],\n        patches: \u0026mut Vec\u003cPatch\u003e,\n    ) {\n        let max_len = old_children.len().max(new_children.len());\n\n        for i in 0..max_len {\n            let mut child_path = path.to_vec();\n            child_path.push(i);\n\n            match (old_children.get(i), new_children.get(i)) {\n                (Some(old_child), Some(new_child)) =\u003e {\n                    self.diff_recursive(old_child, new_child, \u0026child_path, patches);\n                }\n                (Some(_), None) =\u003e {\n                    patches.push(Patch::RemoveChild {\n                        path: path.to_vec(),\n                        index: i,\n                    });\n                }\n                (None, Some(new_child)) =\u003e {\n                    patches.push(Patch::InsertChild {\n                        path: path.to_vec(),\n                        index: i,\n                        element: new_child.clone(),\n                    });\n                }\n                (None, None) =\u003e unreachable!(),\n            }\n        }\n    }\n\n    /// Apply patches to the DOM\n    fn apply_patches(\u0026mut self, component_id: ComponentId, patches: Vec\u003cPatch\u003e) {\n        for patch in patches {\n            self.apply_patch(component_id, patch);\n        }\n    }\n\n    /// Apply a single patch\n    fn apply_patch(\u0026mut self, component_id: ComponentId, patch: Patch) {\n        // Get the DOM node first to avoid borrow issues\n        let dom_node = self.components.get(\u0026component_id)\n            .and_then(|instance| instance.dom_node.clone());\n        \n        match patch {\n            Patch::UpdateText { path, text } =\u003e {\n                if let Some(node) = self.find_node_at_path(\u0026dom_node, \u0026path) {\n                    node.set_text_content(Some(\u0026text));\n                }\n            }\n            Patch::Replace { path, element } =\u003e {\n                if let Some(node) = self.find_node_at_path(\u0026dom_node, \u0026path) {\n                    let new_node = element.to_dom();\n                    if let Some(parent) = node.parent_node() {\n                        parent.replace_child(\u0026new_node, \u0026node).unwrap();\n                    }\n                }\n            }\n            Patch::InsertChild { path, index: _, element } =\u003e {\n                if let Some(node) = self.find_node_at_path(\u0026dom_node, \u0026path) {\n                    let child_node = element.to_dom();\n                    node.append_child(\u0026child_node).unwrap();\n                }\n            }\n            Patch::RemoveChild { path, index } =\u003e {\n                if let Some(node) = self.find_node_at_path(\u0026dom_node, \u0026path) {\n                    if let Some(child) = node.child_nodes().get(index as u32) {\n                        node.remove_child(\u0026child).unwrap();\n                    }\n                }\n            }\n        }\n    }\n\n    /// Find a DOM node at a specific path\n    fn find_node_at_path(\u0026self, root: \u0026Option\u003cNode\u003e, path: \u0026[usize]) -\u003e Option\u003cNode\u003e {\n        let mut current = root.clone()?;\n        \n        for \u0026index in path {\n            current = current.child_nodes().get(index as u32)?;\n        }\n        \n        Some(current)\n    }\n\n    /// Run an effect for a component\n    pub fn run_effect(\u0026mut self, component_id: ComponentId, effect: impl FnOnce() -\u003e EffectCleanup) {\n        let cleanup = effect();\n        \n        if let Some(instance) = self.components.get_mut(\u0026component_id) {\n            instance.effects.push(cleanup);\n        }\n    }\n\n    /// Clean up a component and its children\n    pub fn unmount_component(\u0026mut self, component_id: ComponentId) {\n        if let Some(mut instance) = self.components.remove(\u0026component_id) {\n            // Run cleanup effects\n            for cleanup in instance.effects.drain(..) {\n                cleanup();\n            }\n            \n            // Clean up component hooks\n            crate::hooks::cleanup_component_hooks(component_id);\n\n            // Remove from parent's child list\n            if let Some(parent_id) = instance.parent_id {\n                if let Some(parent) = self.components.get_mut(\u0026parent_id) {\n                    parent.child_ids.retain(|\u0026id| id != component_id);\n                }\n            }\n\n            // Unmount children recursively\n            for child_id in instance.child_ids.clone() {\n                self.unmount_component(child_id);\n            }\n\n            // Remove from DOM\n            if let Some(dom_node) = instance.dom_node {\n                if let Some(parent) = dom_node.parent_node() {\n                    parent.remove_child(\u0026dom_node).unwrap();\n                }\n            }\n        }\n    }\n}\n\n/// Patch operations for DOM updates\n#[derive(Debug, Clone)]\nenum Patch {\n    UpdateText {\n        path: Vec\u003cusize\u003e,\n        text: String,\n    },\n    Replace {\n        path: Vec\u003cusize\u003e,\n        element: Element,\n    },\n    InsertChild {\n        path: Vec\u003cusize\u003e,\n        #[allow(dead_code)]\n        index: usize,\n        element: Element,\n    },\n    RemoveChild {\n        path: Vec\u003cusize\u003e,\n        index: usize,\n    },\n}\n\nthread_local! {\n    /// Current component ID (used by hooks)\n    static CURRENT_COMPONENT: RefCell\u003cOption\u003cComponentId\u003e\u003e = RefCell::new(None);\n}\n\npub fn with_current_component\u003cT\u003e(component_id: ComponentId, f: impl FnOnce() -\u003e T) -\u003e T {\n    CURRENT_COMPONENT.with(|c| {\n        *c.borrow_mut() = Some(component_id);\n    });\n    \n    let result = f();\n    \n    CURRENT_COMPONENT.with(|c| {\n        *c.borrow_mut() = None;\n    });\n    \n    result\n}\n\npub fn get_current_component() -\u003e Option\u003cComponentId\u003e {\n    CURRENT_COMPONENT.with(|c| *c.borrow())\n}\n\n/// Queue a re-render for the current component\npub fn queue_current_render() {\n    if let Some(component_id) = get_current_component() {\n        RENDERER.with(|r| {\n            if let Some(renderer) = r.borrow_mut().as_mut() {\n                renderer.queue_render(component_id);\n            }\n        });\n    }\n}\n\n/// Run an effect for the current component\npub fn run_current_effect(effect: impl FnOnce() -\u003e EffectCleanup) {\n    if let Some(component_id) = get_current_component() {\n        RENDERER.with(|r| {\n            if let Some(renderer) = r.borrow_mut().as_mut() {\n                renderer.run_effect(component_id, effect);\n            }\n        });\n    }\n}\n\n/// Mount a component to the DOM\npub fn mount(component: Box\u003cdyn Component\u003e, root_id: \u0026str) {\n    init_renderer();\n    \n    RENDERER.with(|r| {\n        if let Some(renderer) = r.borrow_mut().as_mut() {\n            renderer.mount_root(component, root_id);\n        }\n    });\n}","traces":[{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","reactive_v2.rs"],"content":"//! Reactive Rendering System V2 - L3\n//! \n//! Fixed version that avoids borrowing issues by deferring effect execution\n\nuse std::cell::RefCell;\nuse std::collections::{HashMap, HashSet};\nuse web_sys::{Element as DomElement, Node};\nuse wasm_bindgen::JsCast;\n\nuse crate::component::{Component, Element};\nuse crate::vdom::VDom;\n\ntype PendingEffect = (ComponentId, Box\u003cdyn FnOnce() -\u003e EffectCleanup\u003e);\n\nthread_local! {\n    static RENDERER: RefCell\u003cOption\u003cRenderer\u003e\u003e = const { RefCell::new(None) };\n    static PENDING_EFFECTS: RefCell\u003cVec\u003cPendingEffect\u003e\u003e = RefCell::new(Vec::new());\n}\n\n/// Initialize the global renderer\npub fn init_renderer() {\n    RENDERER.with(|r| {\n        *r.borrow_mut() = Some(Renderer::new());\n    });\n}\n\n/// Component instance with unique ID\npub struct ComponentInstance {\n    #[allow(dead_code)]\n    id: ComponentId,\n    component: Box\u003cdyn Component\u003e,\n    dom_node: Option\u003cNode\u003e,\n    vdom: Option\u003cElement\u003e,\n    parent_id: Option\u003cComponentId\u003e,\n    child_ids: Vec\u003cComponentId\u003e,\n    effects: Vec\u003cEffectCleanup\u003e,\n}\n\ntype ComponentId = u32;\ntype EffectCleanup = Box\u003cdyn FnOnce()\u003e;\n\n/// The main rendering engine\npub struct Renderer {\n    components: HashMap\u003cComponentId, ComponentInstance\u003e,\n    render_queue: HashSet\u003cComponentId\u003e,\n    next_id: ComponentId,\n    is_rendering: bool,\n    root_element: Option\u003cDomElement\u003e,\n    vdom: VDom,\n}\n\nimpl Renderer {\n    fn new() -\u003e Self {\n        Renderer {\n            components: HashMap::new(),\n            render_queue: HashSet::new(),\n            next_id: 1,\n            is_rendering: false,\n            root_element: None,\n            vdom: VDom::new(),\n        }\n    }\n\n    /// Mount a component to a DOM element\n    pub fn mount_root(\u0026mut self, component: Box\u003cdyn Component\u003e, root_id: \u0026str) {\n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        let root_element = document\n            .get_element_by_id(root_id)\n            .expect(\"Root element not found\");\n\n        self.root_element = Some(root_element.clone());\n\n        // Create root component instance\n        let component_id = self.create_component_instance(component, None);\n        \n        // Initial render\n        self.render_component(component_id);\n        \n        // Mount to DOM\n        if let Some(instance) = self.components.get(\u0026component_id) {\n            if let Some(dom_node) = \u0026instance.dom_node {\n                root_element.append_child(dom_node).unwrap();\n            }\n        }\n        \n        // Run any pending effects after initial render\n        self.run_pending_effects();\n    }\n\n    /// Create a new component instance\n    fn create_component_instance(\n        \u0026mut self,\n        component: Box\u003cdyn Component\u003e,\n        parent_id: Option\u003cComponentId\u003e,\n    ) -\u003e ComponentId {\n        let id = self.next_id;\n        self.next_id += 1;\n\n        let instance = ComponentInstance {\n            id,\n            component,\n            dom_node: None,\n            vdom: None,\n            parent_id,\n            child_ids: Vec::new(),\n            effects: Vec::new(),\n        };\n\n        self.components.insert(id, instance);\n\n        // Update parent's child list\n        if let Some(parent_id) = parent_id {\n            if let Some(parent) = self.components.get_mut(\u0026parent_id) {\n                parent.child_ids.push(id);\n            }\n        }\n\n        id\n    }\n\n    /// Queue a component for re-rendering\n    pub fn queue_render(\u0026mut self, component_id: ComponentId) {\n        self.render_queue.insert(component_id);\n        \n        if !self.is_rendering {\n            self.flush_render_queue();\n        }\n    }\n\n    /// Process all queued renders\n    fn flush_render_queue(\u0026mut self) {\n        self.is_rendering = true;\n\n        // Copy queue to avoid borrow issues\n        let queue: Vec\u003cComponentId\u003e = self.render_queue.drain().collect();\n\n        for component_id in queue {\n            self.render_component(component_id);\n        }\n\n        self.is_rendering = false;\n        \n        // Run any pending effects after all renders complete\n        self.run_pending_effects();\n    }\n\n    /// Render a specific component\n    fn render_component(\u0026mut self, component_id: ComponentId) {\n        // Reset hook index before rendering\n        crate::hooks::reset_hook_index();\n        \n        // Get component and render new VDOM\n        let (new_vdom, old_vdom) = {\n            let instance = self.components.get(\u0026component_id).unwrap();\n            // Render within component context for hooks\n            let new_vdom = with_current_component(component_id, || {\n                instance.component.render()\n            });\n            let old_vdom = instance.vdom.clone();\n            (new_vdom, old_vdom)\n        };\n\n        // Perform diffing and patching\n        if let Some(old_vdom) = old_vdom {\n            // Diff and patch existing DOM\n            let patches = self.vdom.diff(\u0026old_vdom, \u0026new_vdom, \u0026[]);\n            \n            // Apply patches to the DOM node\n            if let Some(instance) = self.components.get(\u0026component_id) {\n                if let Some(dom_node) = \u0026instance.dom_node {\n                    if let Some(element) = dom_node.dyn_ref::\u003cDomElement\u003e() {\n                        self.vdom.apply_patches(\u0026patches, element);\n                    }\n                }\n            }\n            \n            // Update stored VDOM\n            if let Some(instance) = self.components.get_mut(\u0026component_id) {\n                instance.vdom = Some(new_vdom);\n            }\n        } else {\n            // Initial render - create DOM\n            let dom_node = new_vdom.to_dom();\n            \n            if let Some(instance) = self.components.get_mut(\u0026component_id) {\n                instance.dom_node = Some(dom_node);\n                instance.vdom = Some(new_vdom);\n            }\n        }\n    }\n\n    /// Run all pending effects\n    fn run_pending_effects(\u0026mut self) {\n        let effects = PENDING_EFFECTS.with(|e| {\n            std::mem::take(\u0026mut *e.borrow_mut())\n        });\n        \n        for (component_id, effect) in effects {\n            let cleanup = effect();\n            if let Some(instance) = self.components.get_mut(\u0026component_id) {\n                instance.effects.push(cleanup);\n            }\n        }\n    }\n\n\n\n\n\n\n\n\n    /// Clean up a component and its children\n    pub fn unmount_component(\u0026mut self, component_id: ComponentId) {\n        if let Some(mut instance) = self.components.remove(\u0026component_id) {\n            // Run cleanup effects\n            for cleanup in instance.effects.drain(..) {\n                cleanup();\n            }\n            \n            // Clean up component hooks\n            crate::hooks::cleanup_component_hooks(component_id);\n\n            // Remove from parent's child list\n            if let Some(parent_id) = instance.parent_id {\n                if let Some(parent) = self.components.get_mut(\u0026parent_id) {\n                    parent.child_ids.retain(|\u0026id| id != component_id);\n                }\n            }\n\n            // Unmount children recursively\n            for child_id in instance.child_ids.clone() {\n                self.unmount_component(child_id);\n            }\n\n            // Remove from DOM\n            if let Some(dom_node) = instance.dom_node {\n                if let Some(parent) = dom_node.parent_node() {\n                    parent.remove_child(\u0026dom_node).unwrap();\n                }\n            }\n        }\n    }\n}\n\n\nthread_local! {\n    /// Current component ID (used by hooks)\n    static CURRENT_COMPONENT: RefCell\u003cOption\u003cComponentId\u003e\u003e = const { RefCell::new(None) };\n}\n\npub fn with_current_component\u003cT\u003e(component_id: ComponentId, f: impl FnOnce() -\u003e T) -\u003e T {\n    CURRENT_COMPONENT.with(|c| {\n        *c.borrow_mut() = Some(component_id);\n    });\n    \n    let result = f();\n    \n    CURRENT_COMPONENT.with(|c| {\n        *c.borrow_mut() = None;\n    });\n    \n    result\n}\n\npub fn get_current_component() -\u003e Option\u003cComponentId\u003e {\n    CURRENT_COMPONENT.with(|c| *c.borrow())\n}\n\n/// Get current component ID (for hooks)\nfn get_current_component_id() -\u003e Option\u003cComponentId\u003e {\n    get_current_component()\n}\n\n/// Queue a re-render for the current component\npub fn queue_current_render() {\n    if let Some(component_id) = get_current_component_id() {\n        RENDERER.with(|r| {\n            if let Some(renderer) = r.borrow_mut().as_mut() {\n                renderer.queue_render(component_id);\n            }\n        });\n    }\n}\n\n/// Queue a specific component for re-rendering by ID\npub fn queue_component_render(component_id: ComponentId) {\n    RENDERER.with(|r| {\n        if let Some(renderer) = r.borrow_mut().as_mut() {\n            renderer.queue_render(component_id);\n        }\n    });\n}\n\n/// Queue an effect to run after rendering completes\npub fn queue_effect_for_current_component(effect: impl FnOnce() -\u003e EffectCleanup + 'static) {\n    if let Some(component_id) = get_current_component() {\n        PENDING_EFFECTS.with(|e| {\n            e.borrow_mut().push((component_id, Box::new(effect)));\n        });\n    }\n}\n\n/// Run an effect for the current component (deferred)\npub fn run_current_effect(effect: impl FnOnce() -\u003e EffectCleanup + 'static) {\n    queue_effect_for_current_component(effect);\n}\n\n/// Mount a component to the DOM\npub fn mount(component: Box\u003cdyn Component\u003e, root_id: \u0026str) {\n    init_renderer();\n    \n    RENDERER.with(|r| {\n        if let Some(renderer) = r.borrow_mut().as_mut() {\n            renderer.mount_root(component, root_id);\n        }\n    });\n}","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":2}},{"line":268,"address":[],"length":0,"stats":{"Line":6}},{"line":272,"address":[],"length":0,"stats":{"Line":2}},{"line":273,"address":[],"length":0,"stats":{"Line":2}},{"line":277,"address":[],"length":0,"stats":{"Line":2}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}}],"covered":6,"coverable":94},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","router.rs"],"content":"//! Router System - L7\n\nuse crate::component::{Component, Element, Props};\nuse std::collections::HashMap;\nuse wasm_bindgen::prelude::*;\n\n/// Page definition\npub struct Page {\n    pub title: String,\n    pub meta: HashMap\u003cString, String\u003e,\n    pub component: Box\u003cdyn Component\u003e,\n}\n\nimpl Default for Page {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Page {\n    pub fn new() -\u003e Self {\n        Page {\n            title: String::new(),\n            meta: HashMap::new(),\n            component: Box::new(EmptyComponent),\n        }\n    }\n\n    pub fn title(mut self, title: impl Into\u003cString\u003e) -\u003e Self {\n        self.title = title.into();\n        self\n    }\n\n    pub fn component(mut self, component: impl Component + 'static) -\u003e Self {\n        self.component = Box::new(component);\n        self\n    }\n\n    pub fn meta(mut self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) -\u003e Self {\n        self.meta.insert(key.into(), value.into());\n        self\n    }\n}\n\n/// Route definition\n#[derive(Clone)]\npub struct Route {\n    pub path: String,\n    pub handler: RouteHandler,\n}\n\n#[derive(Clone)]\npub enum RouteHandler {\n    Page(fn() -\u003e Page),\n    Api(fn() -\u003e JsValue),\n    Redirect(String),\n}\n\n/// Router\npub struct Router {\n    routes: HashMap\u003cString, Route\u003e,\n}\n\nimpl Default for Router {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Router {\n    pub fn new() -\u003e Self {\n        Router {\n            routes: HashMap::new(),\n        }\n    }\n\n    pub fn add_route(\u0026mut self, route: Route) {\n        self.routes.insert(route.path.clone(), route);\n    }\n\n    pub fn navigate(\u0026self, path: \u0026str) {\n        if let Some(route) = self.routes.get(path) {\n            match \u0026route.handler {\n                RouteHandler::Page(handler) =\u003e {\n                    let page = handler();\n                    self.render_page(page);\n                }\n                RouteHandler::Api(_) =\u003e {\n                    web_sys::console::error_1(\u0026\"Cannot navigate to API route\".into());\n                }\n                RouteHandler::Redirect(to) =\u003e {\n                    self.navigate(to);\n                }\n            }\n        } else {\n            self.render_404();\n        }\n    }\n\n    fn render_page(\u0026self, page: Page) {\n        // Update document title\n        web_sys::window()\n            .unwrap()\n            .document()\n            .unwrap()\n            .set_title(\u0026page.title);\n\n        // Render component\n        let root = web_sys::window()\n            .unwrap()\n            .document()\n            .unwrap()\n            .get_element_by_id(\"layer9-root\")\n            .expect(\"No #layer9-root element found\");\n\n        // Clear existing content\n        root.set_inner_html(\"\");\n\n        // Mount new component\n        page.component.mount(\u0026root);\n    }\n\n    fn render_404(\u0026self) {\n        let page = Page::new()\n            .title(\"404 - Not Found\")\n            .component(NotFoundComponent);\n        self.render_page(page);\n    }\n}\n\n/// Empty component for default\nstruct EmptyComponent;\n\nimpl Component for EmptyComponent {\n    fn render(\u0026self) -\u003e Element {\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![Element::Text(\"Empty Page\".to_string())],\n        }\n    }\n}\n\n/// 404 component\nstruct NotFoundComponent;\n\nimpl Component for NotFoundComponent {\n    fn render(\u0026self) -\u003e Element {\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"not-found\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"404\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Page not found\".to_string())],\n                },\n            ],\n        }\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":49},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","router_v2.rs"],"content":"//! Advanced Router with Browser History - L7\n\nuse crate::component::{Component, Element};\nuse crate::state::{create_atom, use_atom, Atom};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse web_sys::{window, History, Location, PopStateEvent};\n\n/// Router configuration\npub struct RouterConfig {\n    pub routes: Vec\u003cRouteDefinition\u003e,\n    pub not_found: Box\u003cdyn Component\u003e,\n}\n\n/// Route definition with params\npub struct RouteDefinition {\n    pub path: String,\n    pub component: Box\u003cdyn Fn(RouteParams) -\u003e Box\u003cdyn Component\u003e\u003e,\n    pub name: Option\u003cString\u003e,\n}\n\n/// Route parameters\n#[derive(Clone, Debug)]\npub struct RouteParams {\n    pub params: HashMap\u003cString, String\u003e,\n    pub query: HashMap\u003cString, String\u003e,\n}\n\n/// Current route state\n#[derive(Clone)]\npub struct RouteState {\n    pub path: String,\n    pub params: RouteParams,\n}\n\nimpl Default for RouteState {\n    fn default() -\u003e Self {\n        RouteState {\n            path: \"/\".to_string(),\n            params: RouteParams {\n                params: HashMap::new(),\n                query: HashMap::new(),\n            },\n        }\n    }\n}\n\n/// Router instance\npub struct Router {\n    config: Rc\u003cRouterConfig\u003e,\n    state: Atom\u003cRouteState\u003e,\n    history: History,\n    _location: Location,\n}\n\nimpl Router {\n    pub fn new(config: RouterConfig) -\u003e Result\u003cSelf, JsValue\u003e {\n        let window = window().ok_or(\"No window\")?;\n        let history = window.history()?;\n        let location = window.location();\n\n        let initial_state = RouteState {\n            path: location.pathname()?,\n            params: RouteParams {\n                params: HashMap::new(),\n                query: parse_query(\u0026location.search()?),\n            },\n        };\n\n        let state = create_atom(initial_state);\n\n        let router = Router {\n            config: Rc::new(config),\n            state,\n            history,\n            _location: location,\n        };\n\n        // Setup popstate listener\n        router.setup_listeners()?;\n\n        Ok(router)\n    }\n\n    fn setup_listeners(\u0026self) -\u003e Result\u003c(), JsValue\u003e {\n        let state = self.state.clone();\n        let config = self.config.clone();\n\n        let closure = Closure::\u003cdyn FnMut(_)\u003e::new(move |_event: PopStateEvent| {\n            if let Some(window) = window() {\n                if let Ok(pathname) = window.location().pathname() {\n                    let new_state = RouteState {\n                        path: pathname.clone(),\n                        params: match_route(\u0026pathname, \u0026config.routes),\n                    };\n                    state.set(new_state);\n                }\n            }\n        });\n\n        window()\n            .ok_or(\"No window\")?\n            .add_event_listener_with_callback(\"popstate\", closure.as_ref().unchecked_ref())?;\n\n        closure.forget(); // Keep closure alive\n\n        Ok(())\n    }\n\n    pub fn navigate(\u0026self, path: \u0026str) -\u003e Result\u003c(), JsValue\u003e {\n        // Update browser history\n        self.history\n            .push_state_with_url(\u0026JsValue::NULL, \"\", Some(path))?;\n\n        // Update router state\n        let new_state = RouteState {\n            path: path.to_string(),\n            params: match_route(path, \u0026self.config.routes),\n        };\n        self.state.set(new_state);\n\n        Ok(())\n    }\n\n    pub fn replace(\u0026self, path: \u0026str) -\u003e Result\u003c(), JsValue\u003e {\n        // Replace current history entry\n        self.history\n            .replace_state_with_url(\u0026JsValue::NULL, \"\", Some(path))?;\n\n        // Update router state\n        let new_state = RouteState {\n            path: path.to_string(),\n            params: match_route(path, \u0026self.config.routes),\n        };\n        self.state.set(new_state);\n\n        Ok(())\n    }\n\n    pub fn back(\u0026self) -\u003e Result\u003c(), JsValue\u003e {\n        self.history.back()\n    }\n\n    pub fn forward(\u0026self) -\u003e Result\u003c(), JsValue\u003e {\n        self.history.forward()\n    }\n}\n\n/// Match route and extract params\nfn match_route(path: \u0026str, routes: \u0026[RouteDefinition]) -\u003e RouteParams {\n    for route_def in routes {\n        if let Some(params) = match_path(\u0026route_def.path, path) {\n            return RouteParams {\n                params,\n                query: HashMap::new(), // TODO: Parse query params\n            };\n        }\n    }\n\n    RouteParams {\n        params: HashMap::new(),\n        query: HashMap::new(),\n    }\n}\n\n/// Match path pattern against actual path\nfn match_path(pattern: \u0026str, path: \u0026str) -\u003e Option\u003cHashMap\u003cString, String\u003e\u003e {\n    let pattern_parts: Vec\u003c\u0026str\u003e = pattern.split('/').filter(|s| !s.is_empty()).collect();\n    let path_parts: Vec\u003c\u0026str\u003e = path.split('/').filter(|s| !s.is_empty()).collect();\n\n    if pattern_parts.len() != path_parts.len() {\n        return None;\n    }\n\n    let mut params = HashMap::new();\n\n    for (pattern_part, path_part) in pattern_parts.iter().zip(path_parts.iter()) {\n        if let Some(param_name) = pattern_part.strip_prefix(':') {\n            // Dynamic segment\n            params.insert(param_name.to_string(), path_part.to_string());\n        } else if pattern_part != path_part {\n            // Static segment doesn't match\n            return None;\n        }\n    }\n\n    Some(params)\n}\n\n/// Parse query string\nfn parse_query(query: \u0026str) -\u003e HashMap\u003cString, String\u003e {\n    let mut params = HashMap::new();\n\n    if let Some(query) = query.strip_prefix('?') {\n        for pair in query.split('\u0026') {\n            if let Some((key, value)) = pair.split_once('=') {\n                params.insert(\n                    urlencoding::decode(key).unwrap_or_default().into_owned(),\n                    urlencoding::decode(value).unwrap_or_default().into_owned(),\n                );\n            }\n        }\n    }\n\n    params\n}\n\nthread_local! {\n    static ROUTER: RefCell\u003cOption\u003cRc\u003cRouter\u003e\u003e\u003e = const { RefCell::new(None) };\n}\n\n/// Initialize router\npub fn init_router(config: RouterConfig) -\u003e Result\u003c(), JsValue\u003e {\n    let router = Router::new(config)?;\n    ROUTER.with(|r| {\n        *r.borrow_mut() = Some(Rc::new(router));\n    });\n    Ok(())\n}\n\n/// Use router hook\npub fn use_router() -\u003e Option\u003cRc\u003cRouter\u003e\u003e {\n    ROUTER.with(|r| r.borrow().clone())\n}\n\n/// Use current route\npub fn use_route() -\u003e Option\u003cRouteState\u003e {\n    let router = use_router()?;\n    let handle = use_atom(\u0026router.state);\n    handle.get().cloned()\n}\n\n/// Link component\npub struct Link {\n    to: String,\n    children: Vec\u003cElement\u003e,\n    class: Option\u003cString\u003e,\n}\n\nimpl Link {\n    pub fn new(to: impl Into\u003cString\u003e) -\u003e Self {\n        Link {\n            to: to.into(),\n            children: vec![],\n            class: None,\n        }\n    }\n\n    pub fn children(mut self, children: Vec\u003cElement\u003e) -\u003e Self {\n        self.children = children;\n        self\n    }\n\n    pub fn class(mut self, class: impl Into\u003cString\u003e) -\u003e Self {\n        self.class = Some(class.into());\n        self\n    }\n}\n\nimpl Component for Link {\n    fn render(\u0026self) -\u003e Element {\n        let to = self.to.clone();\n        let on_click = Some(Rc::new(move || {\n            if let Some(router) = use_router() {\n                let _ = router.navigate(\u0026to);\n            }\n        }) as Rc\u003cdyn Fn()\u003e);\n\n        Element::Node {\n            tag: \"a\".to_string(),\n            props: crate::component::Props {\n                class: self.class.clone(),\n                on_click,\n                attributes: vec![\n                    (\"href\".to_string(), self.to.clone()),\n                    (\"onclick\".to_string(), \"event.preventDefault()\".to_string()),\n                ],\n                ..Default::default()\n            },\n            children: self.children.clone(),\n        }\n    }\n}\n\n/// Route component - renders matching route\npub struct Route;\n\nimpl Component for Route {\n    fn render(\u0026self) -\u003e Element {\n        if let Some(router) = use_router() {\n            if let Some(route_state) = use_route() {\n                // Find matching route\n                for route_def in \u0026router.config.routes {\n                    if match_path(\u0026route_def.path, \u0026route_state.path).is_some() {\n                        let component = (route_def.component)(route_state.params.clone());\n                        return component.render();\n                    }\n                }\n\n                // No match - render 404\n                return router.config.not_found.render();\n            }\n        }\n\n        // Fallback\n        Element::Text(\"Router not initialized\".to_string())\n    }\n}\n\n/// Navigate programmatically\npub fn navigate(path: \u0026str) -\u003e Result\u003c(), JsValue\u003e {\n    if let Some(router) = use_router() {\n        router.navigate(path)\n    } else {\n        Err(\"Router not initialized\".into())\n    }\n}\n\n/// Create route definition helper\npub fn route(\n    path: impl Into\u003cString\u003e,\n    component: impl Fn(RouteParams) -\u003e Box\u003cdyn Component\u003e + 'static,\n) -\u003e RouteDefinition {\n    RouteDefinition {\n        path: path.into(),\n        component: Box::new(component),\n        name: None,\n    }\n}\n\n/// Create route with name\npub fn named_route(\n    name: impl Into\u003cString\u003e,\n    path: impl Into\u003cString\u003e,\n    component: impl Fn(RouteParams) -\u003e Box\u003cdyn Component\u003e + 'static,\n) -\u003e RouteDefinition {\n    RouteDefinition {\n        path: path.into(),\n        component: Box::new(component),\n        name: Some(name.into()),\n    }\n}\n","traces":[{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":103},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","security.rs"],"content":"//! Security Features - L2/L3\n//! CSRF protection, CSP, rate limiting, and other security features\n\nuse base64::{engine::general_purpose, Engine as _};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\n\n/// CSRF token management\npub struct CsrfProtection {\n    token_store: Rc\u003cRefCell\u003cHashMap\u003cString, CsrfToken\u003e\u003e\u003e,\n    secret: String,\n}\n\n#[derive(Clone)]\nstruct CsrfToken {\n    _value: String,\n    _created_at: f64,\n    expires_at: f64,\n}\n\nimpl CsrfProtection {\n    pub fn new(secret: impl Into\u003cString\u003e) -\u003e Self {\n        CsrfProtection {\n            token_store: Rc::new(RefCell::new(HashMap::new())),\n            secret: secret.into(),\n        }\n    }\n\n    pub fn generate_token(\u0026self) -\u003e String {\n        let random_bytes = self.generate_random_bytes(32);\n        let timestamp = js_sys::Date::now();\n\n        // Create token payload\n        let payload = format!(\n            \"{}{}{}\",\n            general_purpose::STANDARD.encode(\u0026random_bytes),\n            timestamp,\n            \u0026self.secret\n        );\n\n        // Hash the payload\n        let mut hasher = Sha256::new();\n        hasher.update(payload.as_bytes());\n        let hash = hasher.finalize();\n\n        let token_value = general_purpose::STANDARD.encode(hash);\n\n        // Store token\n        let token = CsrfToken {\n            _value: token_value.clone(),\n            _created_at: timestamp,\n            expires_at: timestamp + 3600000.0, // 1 hour\n        };\n\n        self.token_store\n            .borrow_mut()\n            .insert(token_value.clone(), token);\n\n        token_value\n    }\n\n    pub fn verify_token(\u0026self, token: \u0026str) -\u003e bool {\n        let mut store = self.token_store.borrow_mut();\n\n        if let Some(csrf_token) = store.get(token) {\n            let now = js_sys::Date::now();\n            if now \u003c csrf_token.expires_at {\n                // Token is valid\n                true\n            } else {\n                // Token expired, remove it\n                store.remove(token);\n                false\n            }\n        } else {\n            false\n        }\n    }\n\n    pub fn cleanup_expired(\u0026self) {\n        let now = js_sys::Date::now();\n        self.token_store\n            .borrow_mut()\n            .retain(|_, token| token.expires_at \u003e now);\n    }\n\n    fn generate_random_bytes(\u0026self, len: usize) -\u003e Vec\u003cu8\u003e {\n        let crypto = web_sys::window()\n            .unwrap()\n            .crypto()\n            .expect(\"Crypto API not available\");\n\n        let mut bytes = vec![0u8; len];\n        crypto\n            .get_random_values_with_u8_array(\u0026mut bytes)\n            .expect(\"Failed to generate random bytes\");\n\n        bytes\n    }\n}\n\n/// Content Security Policy builder\npub struct ContentSecurityPolicy {\n    directives: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n}\n\nimpl Default for ContentSecurityPolicy {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ContentSecurityPolicy {\n    pub fn new() -\u003e Self {\n        ContentSecurityPolicy {\n            directives: HashMap::new(),\n        }\n    }\n\n    pub fn default_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"default-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn script_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"script-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn style_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"style-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn img_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"img-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn connect_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"connect-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn font_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"font-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn frame_src(mut self, sources: Vec\u003c\u0026str\u003e) -\u003e Self {\n        self.directives.insert(\n            \"frame-src\".to_string(),\n            sources.into_iter().map(|s| s.to_string()).collect(),\n        );\n        self\n    }\n\n    pub fn build(\u0026self) -\u003e String {\n        self.directives\n            .iter()\n            .map(|(directive, sources)| format!(\"{} {}\", directive, sources.join(\" \")))\n            .collect::\u003cVec\u003c_\u003e\u003e()\n            .join(\"; \")\n    }\n}\n\n/// XSS protection\npub struct XssProtection;\n\nimpl XssProtection {\n    /// Sanitize HTML input\n    pub fn sanitize_html(input: \u0026str) -\u003e String {\n        input\n            .replace('\u003c', \"\u0026lt;\")\n            .replace('\u003e', \"\u0026gt;\")\n            .replace('\"', \"\u0026quot;\")\n            .replace('\\'', \"\u0026#x27;\")\n            .replace('/', \"\u0026#x2F;\")\n    }\n\n    /// Sanitize JavaScript string\n    pub fn sanitize_js(input: \u0026str) -\u003e String {\n        input\n            .replace('\\\\', \"\\\\\\\\\")\n            .replace('\"', \"\\\\\\\"\")\n            .replace('\\'', \"\\\\'\")\n            .replace('\\n', \"\\\\n\")\n            .replace('\\r', \"\\\\r\")\n            .replace('\\t', \"\\\\t\")\n    }\n\n    /// Sanitize URL\n    pub fn sanitize_url(input: \u0026str) -\u003e String {\n        if input.starts_with(\"javascript:\")\n            || input.starts_with(\"data:\")\n            || input.starts_with(\"vbscript:\")\n        {\n            \"#\".to_string()\n        } else {\n            urlencoding::encode(input).to_string()\n        }\n    }\n}\n\n/// Input validation\npub struct InputValidator;\n\nimpl InputValidator {\n    pub fn email(input: \u0026str) -\u003e Result\u003c(), String\u003e {\n        let email_regex =\n            regex::Regex::new(r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\").unwrap();\n\n        if email_regex.is_match(input) {\n            Ok(())\n        } else {\n            Err(\"Invalid email address\".to_string())\n        }\n    }\n\n    pub fn url(input: \u0026str) -\u003e Result\u003c(), String\u003e {\n        if let Ok(url) = web_sys::Url::new(input) {\n            let protocol = url.protocol();\n            if protocol == \"http:\" || protocol == \"https:\" {\n                Ok(())\n            } else {\n                Err(\"URL must use http or https protocol\".to_string())\n            }\n        } else {\n            Err(\"Invalid URL\".to_string())\n        }\n    }\n\n    pub fn alphanumeric(input: \u0026str) -\u003e Result\u003c(), String\u003e {\n        if input.chars().all(|c| c.is_alphanumeric()) {\n            Ok(())\n        } else {\n            Err(\"Input must be alphanumeric\".to_string())\n        }\n    }\n\n    pub fn length(input: \u0026str, min: usize, max: usize) -\u003e Result\u003c(), String\u003e {\n        let len = input.len();\n        if len \u003e= min \u0026\u0026 len \u003c= max {\n            Ok(())\n        } else {\n            Err(format!(\"Length must be between {} and {}\", min, max))\n        }\n    }\n}\n\n/// Password strength checker\npub struct PasswordStrength;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PasswordAnalysis {\n    pub score: u8, // 0-100\n    pub feedback: Vec\u003cString\u003e,\n    pub is_strong: bool,\n}\n\nimpl PasswordStrength {\n    pub fn analyze(password: \u0026str) -\u003e PasswordAnalysis {\n        let mut score: i32 = 0;\n        let mut feedback = vec![];\n\n        // Length check\n        let len = password.len();\n        if len \u003e= 8 {\n            score += 20;\n            if len \u003e= 12 {\n                score += 10;\n            }\n        } else {\n            feedback.push(\"Password should be at least 8 characters long\".to_string());\n        }\n\n        // Character variety\n        let has_lowercase = password.chars().any(|c| c.is_lowercase());\n        let has_uppercase = password.chars().any(|c| c.is_uppercase());\n        let has_digit = password.chars().any(|c| c.is_numeric());\n        let has_special = password.chars().any(|c| !c.is_alphanumeric());\n\n        if has_lowercase {\n            score += 15;\n        } else {\n            feedback.push(\"Add lowercase letters\".to_string());\n        }\n\n        if has_uppercase {\n            score += 15;\n        } else {\n            feedback.push(\"Add uppercase letters\".to_string());\n        }\n\n        if has_digit {\n            score += 15;\n        } else {\n            feedback.push(\"Add numbers\".to_string());\n        }\n\n        if has_special {\n            score += 25;\n        } else {\n            feedback.push(\"Add special characters (!@#$%^\u0026*)\".to_string());\n        }\n\n        // Common patterns check\n        let common_patterns = vec![\"123\", \"abc\", \"qwerty\", \"password\"];\n        for pattern in common_patterns {\n            if password.to_lowercase().contains(pattern) {\n                score = score.saturating_sub(20);\n                feedback.push(format!(\"Avoid common patterns like '{}'\", pattern));\n            }\n        }\n\n        PasswordAnalysis {\n            score: (score.min(100) as u8),\n            feedback,\n            is_strong: score \u003e= 80,\n        }\n    }\n}\n\n/// Secure cookie handling\npub struct SecureCookie;\n\nimpl SecureCookie {\n    pub fn set(name: \u0026str, value: \u0026str, options: CookieOptions) {\n        let document = web_sys::window().unwrap().document().unwrap();\n\n        let mut cookie_string = format!(\"{}={}\", name, value);\n\n        if let Some(max_age) = options.max_age {\n            cookie_string.push_str(\u0026format!(\"; Max-Age={}\", max_age));\n        }\n\n        if let Some(path) = options.path {\n            cookie_string.push_str(\u0026format!(\"; Path={}\", path));\n        }\n\n        if let Some(domain) = options.domain {\n            cookie_string.push_str(\u0026format!(\"; Domain={}\", domain));\n        }\n\n        if options.secure {\n            cookie_string.push_str(\"; Secure\");\n        }\n\n        if options.http_only {\n            cookie_string.push_str(\"; HttpOnly\");\n        }\n\n        match options.same_site {\n            SameSite::Strict =\u003e cookie_string.push_str(\"; SameSite=Strict\"),\n            SameSite::Lax =\u003e cookie_string.push_str(\"; SameSite=Lax\"),\n            SameSite::None =\u003e cookie_string.push_str(\"; SameSite=None\"),\n        }\n\n        js_sys::Reflect::set(\u0026document, \u0026\"cookie\".into(), \u0026cookie_string.into()).ok();\n    }\n\n    pub fn get(name: \u0026str) -\u003e Option\u003cString\u003e {\n        let document = web_sys::window().unwrap().document().unwrap();\n        let cookies = js_sys::Reflect::get(\u0026document, \u0026\"cookie\".into())\n            .ok()\n            .and_then(|v| v.as_string())\n            .unwrap_or_default();\n\n        for cookie in cookies.split(';') {\n            let cookie = cookie.trim();\n            if let Some((cookie_name, cookie_value)) = cookie.split_once('=') {\n                if cookie_name == name {\n                    return Some(cookie_value.to_string());\n                }\n            }\n        }\n\n        None\n    }\n\n    pub fn delete(name: \u0026str) {\n        Self::set(\n            name,\n            \"\",\n            CookieOptions {\n                max_age: Some(0),\n                ..Default::default()\n            },\n        );\n    }\n}\n\n#[derive(Default)]\npub struct CookieOptions {\n    pub max_age: Option\u003ci32\u003e,\n    pub path: Option\u003cString\u003e,\n    pub domain: Option\u003cString\u003e,\n    pub secure: bool,\n    pub http_only: bool,\n    pub same_site: SameSite,\n}\n\n#[derive(Default)]\npub enum SameSite {\n    Strict,\n    #[default]\n    Lax,\n    None,\n}\n\n/// Subresource Integrity (SRI) generator\npub struct SubresourceIntegrity;\n\nimpl SubresourceIntegrity {\n    pub fn generate(content: \u0026str) -\u003e String {\n        let mut hasher = Sha256::new();\n        hasher.update(content.as_bytes());\n        let hash = hasher.finalize();\n\n        format!(\"sha256-{}\", general_purpose::STANDARD.encode(hash))\n    }\n\n    pub fn verify(content: \u0026str, integrity: \u0026str) -\u003e bool {\n        if let Some(_hash) = integrity.strip_prefix(\"sha256-\") {\n            let generated = Self::generate(content);\n            generated == integrity\n        } else {\n            false\n        }\n    }\n}\n\n/// Security headers configuration\npub struct SecurityHeaders {\n    headers: HashMap\u003cString, String\u003e,\n}\n\nimpl SecurityHeaders {\n    pub fn secure_defaults() -\u003e Self {\n        let mut headers = HashMap::new();\n\n        headers.insert(\"X-Content-Type-Options\".to_string(), \"nosniff\".to_string());\n        headers.insert(\"X-Frame-Options\".to_string(), \"DENY\".to_string());\n        headers.insert(\"X-XSS-Protection\".to_string(), \"1; mode=block\".to_string());\n        headers.insert(\n            \"Referrer-Policy\".to_string(),\n            \"strict-origin-when-cross-origin\".to_string(),\n        );\n        headers.insert(\n            \"Permissions-Policy\".to_string(),\n            \"camera=(), microphone=(), geolocation=()\".to_string(),\n        );\n\n        SecurityHeaders { headers }\n    }\n\n    pub fn add_hsts(mut self, max_age: u32, include_subdomains: bool, preload: bool) -\u003e Self {\n        let mut value = format!(\"max-age={}\", max_age);\n        if include_subdomains {\n            value.push_str(\"; includeSubDomains\");\n        }\n        if preload {\n            value.push_str(\"; preload\");\n        }\n\n        self.headers\n            .insert(\"Strict-Transport-Security\".to_string(), value);\n        self\n    }\n\n    pub fn add_csp(mut self, csp: ContentSecurityPolicy) -\u003e Self {\n        self.headers\n            .insert(\"Content-Security-Policy\".to_string(), csp.build());\n        self\n    }\n\n    pub fn build(\u0026self) -\u003e HashMap\u003cString, String\u003e {\n        self.headers.clone()\n    }\n}\n\n/// Security context for components\npub struct SecurityContext {\n    csrf: CsrfProtection,\n    _csp: ContentSecurityPolicy,\n}\n\nimpl SecurityContext {\n    pub fn new(secret: impl Into\u003cString\u003e) -\u003e Self {\n        SecurityContext {\n            csrf: CsrfProtection::new(secret),\n            _csp: ContentSecurityPolicy::new()\n                .default_src(vec![\"'self'\"])\n                .script_src(vec![\"'self'\", \"'unsafe-inline'\"])\n                .style_src(vec![\"'self'\", \"'unsafe-inline'\"]),\n        }\n    }\n\n    pub fn csrf_token(\u0026self) -\u003e String {\n        self.csrf.generate_token()\n    }\n\n    pub fn verify_csrf(\u0026self, token: \u0026str) -\u003e bool {\n        self.csrf.verify_token(token)\n    }\n}\n\n/// Security hooks\npub fn use_security() -\u003e SecurityContext {\n    // In real app, this would get from context\n    SecurityContext::new(\"layer9-secret-key\")\n}\n\npub fn use_csrf_token() -\u003e String {\n    use_security().csrf_token()\n}\n\n// Re-exports\nuse regex;\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":215},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","server.rs"],"content":"//! Server Functions - L4\n\nuse serde::{Deserialize, Serialize};\nuse wasm_bindgen::prelude::*;\n\n/// Server function trait\npub trait ServerFunction {\n    type Request: Serialize;\n    type Response: for\u003c'de\u003e Deserialize\u003c'de\u003e;\n\n    fn endpoint(\u0026self) -\u003e \u0026'static str;\n\n    fn call(\n        \u0026self,\n        req: Self::Request,\n    ) -\u003e impl std::future::Future\u003cOutput = Result\u003cSelf::Response, ServerError\u003e\u003e;\n}\n\n#[derive(Debug)]\npub struct ServerError {\n    pub message: String,\n    pub status: u16,\n}\n\n/// Response type\npub struct Response\u003cT\u003e {\n    pub data: T,\n    pub status: u16,\n    pub headers: Vec\u003c(String, String)\u003e,\n}\n\nimpl\u003cT\u003e Response\u003cT\u003e {\n    pub fn ok(data: T) -\u003e Self {\n        Response {\n            data,\n            status: 200,\n            headers: vec![],\n        }\n    }\n\n    pub fn with_header(mut self, key: impl Into\u003cString\u003e, value: impl Into\u003cString\u003e) -\u003e Self {\n        self.headers.push((key.into(), value.into()));\n        self\n    }\n}\n\n/// Call server function from client\npub async fn call_server\u003cF: ServerFunction\u003e(\n    func: \u0026F,\n    request: F::Request,\n) -\u003e Result\u003cF::Response, ServerError\u003e {\n    let endpoint = func.endpoint();\n    let body = serde_json::to_string(\u0026request).map_err(|e| ServerError {\n        message: e.to_string(),\n        status: 400,\n    })?;\n\n    // Use fetch API\n    let window = web_sys::window().unwrap();\n\n    let init = web_sys::RequestInit::new();\n    init.set_method(\"POST\");\n    init.set_body(\u0026JsValue::from_str(\u0026body));\n    let headers = web_sys::Headers::new().unwrap();\n    headers.set(\"Content-Type\", \"application/json\").unwrap();\n    init.set_headers(\u0026headers.into());\n\n    let response = JsFuture::from(window.fetch_with_str_and_init(endpoint, \u0026init))\n        .await\n        .map_err(|_| ServerError {\n            message: \"Fetch failed\".to_string(),\n            status: 500,\n        })?;\n\n    let response: web_sys::Response = response.dyn_into().unwrap();\n    let json = JsFuture::from(response.json().unwrap())\n        .await\n        .map_err(|_| ServerError {\n            message: \"Failed to parse response\".to_string(),\n            status: 500,\n        })?;\n\n    serde_wasm_bindgen::from_value(json).map_err(|e| ServerError {\n        message: e.to_string(),\n        status: 500,\n    })\n}\n\n/// Macro to define server functions\n#[macro_export]\nmacro_rules! server_function {\n    (\n        async fn $name:ident($($arg:ident: $arg_ty:ty),*) -\u003e Result\u003c$ret:ty\u003e {\n            $($body:tt)*\n        }\n    ) =\u003e {\n        pub async fn $name($($arg: $arg_ty),*) -\u003e Result\u003c$ret, $crate::server::ServerError\u003e {\n            $($body)*\n        }\n    };\n}\n\n// Re-export for wasm-bindgen\nuse wasm_bindgen_futures::JsFuture;\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":31},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","ssr.rs"],"content":"//! Server-Side Rendering support for Layer9\n\nuse std::collections::HashMap;\nuse serde::{Serialize, Deserialize};\nuse serde_json;\nuse async_trait::async_trait;\n\n#[cfg(target_arch = \"wasm32\")]\nuse wasm_bindgen::prelude::*;\n\n#[cfg(not(target_arch = \"wasm32\"))]\nuse axum::{Router, routing::get, response::Html, extract::Query};\n\n#[cfg(not(target_arch = \"wasm32\"))]\nuse std::sync::Arc;\n\n// Always need Arc for SSRRoute\nuse std::sync::Arc as ArcAlways;\n\n/// SSR Context for rendering components server-side\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SSRContext {\n    pub props: HashMap\u003cString, String\u003e,\n    pub initial_state: Option\u003cString\u003e,\n    pub meta_tags: Vec\u003cString\u003e,\n    pub route: String,\n    pub query_params: HashMap\u003cString, String\u003e,\n    #[serde(skip)]\n    pub request_headers: HashMap\u003cString, String\u003e,\n}\n\nimpl SSRContext {\n    pub fn new() -\u003e Self {\n        Self {\n            props: HashMap::new(),\n            initial_state: None,\n            meta_tags: Vec::new(),\n            route: \"/\".to_string(),\n            query_params: HashMap::new(),\n            request_headers: HashMap::new(),\n        }\n    }\n    \n    pub fn with_props(mut self, props: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.props = props;\n        self\n    }\n    \n    pub fn with_state(mut self, state: String) -\u003e Self {\n        self.initial_state = Some(state);\n        self\n    }\n    \n    pub fn add_meta_tag(mut self, tag: String) -\u003e Self {\n        self.meta_tags.push(tag);\n        self\n    }\n    \n    pub fn with_route(mut self, route: String) -\u003e Self {\n        self.route = route;\n        self\n    }\n    \n    pub fn with_query_params(mut self, params: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.query_params = params;\n        self\n    }\n    \n    pub fn with_headers(mut self, headers: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.request_headers = headers;\n        self\n    }\n}\n\nimpl Default for SSRContext {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Trait for SSR-capable components\n#[cfg(target_arch = \"wasm32\")]\n#[async_trait(?Send)]\npub trait SSRComponent: Send + Sync {\n    fn render_to_string(\u0026self, ctx: \u0026SSRContext) -\u003e String;\n    \n    async fn get_server_props(\u0026self, _ctx: \u0026SSRContext) -\u003e Result\u003cserde_json::Value, String\u003e {\n        Ok(serde_json::json!({}))\n    }\n    \n    fn get_data_requirements(\u0026self) -\u003e Vec\u003cString\u003e {\n        Vec::new()\n    }\n}\n\n/// Trait for SSR-capable components (server-side)\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\npub trait SSRComponent: Send + Sync {\n    fn render_to_string(\u0026self, ctx: \u0026SSRContext) -\u003e String;\n    \n    async fn get_server_props(\u0026self, _ctx: \u0026SSRContext) -\u003e Result\u003cserde_json::Value, String\u003e {\n        Ok(serde_json::json!({}))\n    }\n    \n    fn get_data_requirements(\u0026self) -\u003e Vec\u003cString\u003e {\n        Vec::new()\n    }\n}\n\n/// SSR Renderer\npub struct SSRRenderer {\n    components: Vec\u003cBox\u003cdyn SSRComponent\u003e\u003e,\n    template: String,\n    enable_hydration: bool,\n}\n\nimpl SSRRenderer {\n    pub fn new() -\u003e Self {\n        Self {\n            components: Vec::new(),\n            template: Self::default_template(),\n            enable_hydration: true,\n        }\n    }\n    \n    pub fn with_template(mut self, template: String) -\u003e Self {\n        self.template = template;\n        self\n    }\n    \n    pub fn add_component(\u0026mut self, component: Box\u003cdyn SSRComponent\u003e) {\n        self.components.push(component);\n    }\n    \n    pub fn enable_hydration(mut self, enable: bool) -\u003e Self {\n        self.enable_hydration = enable;\n        self\n    }\n    \n    pub async fn render(\u0026self, ctx: \u0026SSRContext) -\u003e String {\n        let mut body = String::new();\n        \n        for component in \u0026self.components {\n            body.push_str(\u0026component.render_to_string(ctx));\n        }\n        \n        let mut html = self.template.clone();\n        html = html.replace(\"{{content}}\", \u0026body);\n        \n        // Add meta tags\n        let meta_tags = ctx.meta_tags.join(\"\\n    \");\n        html = html.replace(\"{{meta}}\", \u0026meta_tags);\n        \n        // Add initial state and hydration data\n        let mut state_scripts = Vec::new();\n        \n        if let Some(state) = \u0026ctx.initial_state {\n            state_scripts.push(format!(\n                r#\"\u003cscript\u003ewindow.__INITIAL_STATE__ = {};\u003c/script\u003e\"#,\n                state\n            ));\n        }\n        \n        // Add SSR context for hydration\n        if self.enable_hydration {\n            let ssr_context = serde_json::to_string(\u0026ctx).unwrap_or_default();\n            state_scripts.push(format!(\n                r#\"\u003cscript\u003ewindow.__SSR_CONTEXT__ = {};\u003c/script\u003e\"#,\n                ssr_context\n            ));\n        }\n        \n        html = html.replace(\"{{state}}\", \u0026state_scripts.join(\"\\n    \"));\n        \n        // Add hydration script only if hydration is enabled\n        if self.enable_hydration {\n            html = html.replace(\"{{hydration_script}}\", r#\"\n    \u003cscript type=\"module\"\u003e\n        import init, { hydrate_app } from '/pkg/layer9_app.js';\n        init().then(() =\u003e {\n            if (window.__SSR_CONTEXT__) {\n                hydrate_app();\n            }\n        });\n    \u003c/script\u003e\"#);\n        } else {\n            html = html.replace(\"{{hydration_script}}\", \"\");\n        }\n        \n        html\n    }\n    \n    fn default_template() -\u003e String {\n        r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1\"\u003e\n    \u003ctitle\u003eLayer9 SSR\u003c/title\u003e\n    {{meta}}\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv id=\"app\"\u003e{{content}}\u003c/div\u003e\n    {{state}}\n    {{hydration_script}}\n\u003c/body\u003e\n\u003c/html\u003e\"#.to_string()\n    }\n}\n\nimpl Default for SSRRenderer {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_ssr_context() {\n        let ctx = SSRContext::new()\n            .with_state(r#\"{\"counter\": 0}\"#.to_string())\n            .add_meta_tag(r#\"\u003cmeta name=\"description\" content=\"Test\"\u003e\"#.to_string());\n        \n        assert!(ctx.initial_state.is_some());\n        assert_eq!(ctx.meta_tags.len(), 1);\n    }\n}\n\n/// SSR-enabled application trait\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\npub trait SSRApp: Send + Sync + 'static {\n    /// Get routes for the application\n    fn routes(\u0026self) -\u003e Vec\u003cSSRRoute\u003e;\n    \n    /// Get the HTML template for the application\n    fn html_template(\u0026self) -\u003e \u0026'static str {\n        r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1\"\u003e\n    \u003ctitle\u003eLayer9 SSR\u003c/title\u003e\n    {{meta}}\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv id=\"app\"\u003e{{content}}\u003c/div\u003e\n    {{state}}\n    {{hydration_script}}\n\u003c/body\u003e\n\u003c/html\u003e\"#\n    }\n    \n    /// Handle 404 errors\n    async fn handle_not_found(\u0026self, _ctx: \u0026SSRContext) -\u003e String {\n        \"\u003ch1\u003e404 - Page Not Found\u003c/h1\u003e\".to_string()\n    }\n}\n\n/// SSR Route definition\n#[derive(Clone)]\npub struct SSRRoute {\n    pub path: String,\n    pub handler: ArcAlways\u003cdyn SSRRouteHandler\u003e,\n}\n\n/// SSR Route handler trait\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\npub trait SSRRouteHandler: Send + Sync {\n    async fn handle(\u0026self, ctx: SSRContext) -\u003e Result\u003cString, String\u003e;\n}\n\n/// Create an SSR server for the given app\n#[cfg(not(target_arch = \"wasm32\"))]\npub fn create_ssr_server\u003cA: SSRApp\u003e(app: Arc\u003cA\u003e) -\u003e Router {\n    let mut router = Router::new();\n    \n    // Add routes from the app\n    for route in app.routes() {\n        let app_clone = Arc::clone(\u0026app);\n        let handler = route.handler.clone();\n        let path = route.path.clone();\n        let path_clone = path.clone();\n        \n        router = router.route(\u0026path, get(move |\n            Query(params): Query\u003cHashMap\u003cString, String\u003e\u003e,\n            headers: axum::http::HeaderMap,\n        | {\n            let _app = Arc::clone(\u0026app_clone);\n            let handler = handler.clone();\n            \n            async move {\n                // Build SSR context\n                let mut ctx = SSRContext::new()\n                    .with_route(path_clone)\n                    .with_query_params(params);\n                \n                // Add headers to context\n                let mut req_headers = HashMap::new();\n                for (key, value) in headers.iter() {\n                    if let Ok(v) = value.to_str() {\n                        req_headers.insert(key.to_string(), v.to_string());\n                    }\n                }\n                ctx = ctx.with_headers(req_headers);\n                \n                // Handle the route\n                match handler.handle(ctx).await {\n                    Ok(html) =\u003e Html(html),\n                    Err(e) =\u003e Html(format!(\"\u003ch1\u003eError\u003c/h1\u003e\u003cp\u003e{}\u003c/p\u003e\", e)),\n                }\n            }\n        }));\n    }\n    \n    // Add static file serving for WASM app\n    router = router.route(\"/pkg/*path\", get(serve_wasm_files));\n    \n    // Add database API endpoints if configured\n    #[cfg(feature = \"ssr\")]\n    {\n        // Create a simple database connection for the API\n        if let Ok(conn) = crate::db_sqlx::get_db_connection() {\n            router = router.nest(\"/api/db\", crate::db_api::create_db_api_router(conn));\n        }\n    }\n    \n    router\n}\n\n/// Serve WASM files\n#[cfg(not(target_arch = \"wasm32\"))]\nasync fn serve_wasm_files(\n    axum::extract::Path(path): axum::extract::Path\u003cString\u003e\n) -\u003e impl axum::response::IntoResponse {\n    use axum::http::StatusCode;\n    \n    // In production, these would be served from a CDN or static file server\n    // For development, we'll return a placeholder\n    (\n        StatusCode::OK,\n        [(\"content-type\", \"application/javascript\")],\n        format!(\"// Placeholder for WASM file: {}\", path)\n    )\n}\n\n/// Hydration support for client-side\n#[cfg(target_arch = \"wasm32\")]\n#[wasm_bindgen]\npub fn hydrate_app() {\n    // Get SSR context from window\n    let window = web_sys::window().expect(\"no global window\");\n    let ssr_context = js_sys::Reflect::get(\u0026window, \u0026\"__SSR_CONTEXT__\".into())\n        .ok()\n        .and_then(|v| v.as_string())\n        .and_then(|s| serde_json::from_str::\u003cSSRContext\u003e(\u0026s).ok());\n    \n    if let Some(ctx) = ssr_context {\n        // Initialize router with current route\n        if let Err(e) = crate::router_v2::navigate(\u0026ctx.route) {\n            web_sys::console::error_1(\u0026format!(\"Failed to hydrate route: {}\", e).into());\n        }\n        \n        // Mount the app with hydration mode\n        crate::reactive_v2::init_renderer();\n        \n        web_sys::console::log_1(\u0026\"SSR hydration complete\".into());\n    } else {\n        web_sys::console::warn_1(\u0026\"No SSR context found, starting fresh\".into());\n    }\n}\n\n/// Data fetching hook for SSR\npub struct SSRData\u003cT\u003e {\n    pub data: Option\u003cT\u003e,\n    pub error: Option\u003cString\u003e,\n    pub is_loading: bool,\n}\n\nimpl\u003cT\u003e SSRData\u003cT\u003e {\n    pub fn loading() -\u003e Self {\n        Self {\n            data: None,\n            error: None,\n            is_loading: true,\n        }\n    }\n    \n    pub fn success(data: T) -\u003e Self {\n        Self {\n            data: Some(data),\n            error: None,\n            is_loading: false,\n        }\n    }\n    \n    pub fn error(error: String) -\u003e Self {\n        Self {\n            data: None,\n            error: Some(error),\n            is_loading: false,\n        }\n    }\n}\n\n/// Use SSR data hook\n#[cfg(target_arch = \"wasm32\")]\npub fn use_ssr_data\u003cT: serde::de::DeserializeOwned + 'static\u003e(key: \u0026str) -\u003e SSRData\u003cT\u003e {\n    // Check if we have SSR data in window\n    let window = web_sys::window().expect(\"no global window\");\n    \n    if let Ok(initial_state) = js_sys::Reflect::get(\u0026window, \u0026\"__INITIAL_STATE__\".into()) {\n        if let Some(state_str) = initial_state.as_string() {\n            if let Ok(state_obj) = serde_json::from_str::\u003cserde_json::Value\u003e(\u0026state_str) {\n                if let Some(data) = state_obj.get(key) {\n                    if let Ok(typed_data) = serde_json::from_value::\u003cT\u003e(data.clone()) {\n                        return SSRData::success(typed_data);\n                    }\n                }\n            }\n        }\n    }\n    \n    SSRData::loading()\n}\n\n/// Example SSR component implementation\npub struct ExampleSSRComponent {\n    pub title: String,\n}\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRComponent for ExampleSSRComponent {\n    fn render_to_string(\u0026self, ctx: \u0026SSRContext) -\u003e String {\n        format!(\n            r#\"\u003cdiv class=\"example\"\u003e\n                \u003ch1\u003e{}\u003c/h1\u003e\n                \u003cp\u003eRoute: {}\u003c/p\u003e\n                \u003cp\u003eQuery params: {:?}\u003c/p\u003e\n            \u003c/div\u003e\"#,\n            self.title, ctx.route, ctx.query_params\n        )\n    }\n    \n    async fn get_server_props(\u0026self, _ctx: \u0026SSRContext) -\u003e Result\u003cserde_json::Value, String\u003e {\n        // Fetch data from database or API\n        // Fetch data from database or API\n        Ok(serde_json::json!({\n            \"title\": self.title,\n            \"timestamp\": \"2025-01-11T12:00:00Z\",\n        }))\n    }\n}\n\n#[cfg(target_arch = \"wasm32\")]\n#[async_trait(?Send)]\nimpl SSRComponent for ExampleSSRComponent {\n    fn render_to_string(\u0026self, ctx: \u0026SSRContext) -\u003e String {\n        format!(\n            r#\"\u003cdiv class=\"example\"\u003e\n                \u003ch1\u003e{}\u003c/h1\u003e\n                \u003cp\u003eRoute: {}\u003c/p\u003e\n            \u003c/div\u003e\"#,\n            self.title, ctx.route\n        )\n    }\n}\n","traces":[{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":64},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","ssr_tests.rs"],"content":"//! SSR Tests\n\n#[cfg(test)]\nmod tests {\n    use crate::ssr::*;\n    use std::collections::HashMap;\n    use std::sync::Arc;\n    use async_trait::async_trait;\n    \n    // Test component\n    struct TestComponent {\n        content: String,\n    }\n\n    #[async_trait]\n    impl SSRComponent for TestComponent {\n        fn render_to_string(\u0026self, ctx: \u0026SSRContext) -\u003e String {\n            format!(\n                \"\u003cdiv class='test' data-route='{}'\u003e{}\u003c/div\u003e\",\n                ctx.route, self.content\n            )\n        }\n        \n        async fn get_server_props(\u0026self, _ctx: \u0026SSRContext) -\u003e Result\u003cserde_json::Value, String\u003e {\n            Ok(serde_json::json!({\n                \"content\": self.content,\n                \"server_rendered\": true,\n            }))\n        }\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_context_creation() {\n        let ctx = SSRContext::new()\n            .with_route(\"/test\".to_string())\n            .with_state(r#\"{\"count\": 42}\"#.to_string())\n            .add_meta_tag(\"\u003cmeta name='test' content='value'\u003e\".to_string());\n            \n        assert_eq!(ctx.route, \"/test\");\n        assert_eq!(ctx.initial_state.unwrap(), r#\"{\"count\": 42}\"#);\n        assert_eq!(ctx.meta_tags.len(), 1);\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_context_query_params() {\n        let mut params = HashMap::new();\n        params.insert(\"page\".to_string(), \"2\".to_string());\n        params.insert(\"sort\".to_string(), \"date\".to_string());\n        \n        let ctx = SSRContext::new()\n            .with_query_params(params);\n            \n        assert_eq!(ctx.query_params.get(\"page\").unwrap(), \"2\");\n        assert_eq!(ctx.query_params.get(\"sort\").unwrap(), \"date\");\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_renderer_basic() {\n        let ctx = SSRContext::new();\n        let mut renderer = SSRRenderer::new();\n        \n        renderer.add_component(Box::new(TestComponent {\n            content: \"Hello SSR\".to_string(),\n        }));\n        \n        let html = renderer.render(\u0026ctx).await;\n        \n        assert!(html.contains(\"Hello SSR\"));\n        assert!(html.contains(\"\u003c!DOCTYPE html\u003e\"));\n        assert!(html.contains(\"\u003c/html\u003e\"));\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_renderer_with_state() {\n        let ctx = SSRContext::new()\n            .with_state(r#\"{\"user\": \"test\"}\"#.to_string());\n            \n        let renderer = SSRRenderer::new();\n        let html = renderer.render(\u0026ctx).await;\n        \n        assert!(html.contains(r#\"window.__INITIAL_STATE__ = {\"user\": \"test\"};\"#));\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_renderer_with_meta_tags() {\n        let ctx = SSRContext::new()\n            .add_meta_tag(r#\"\u003cmeta name=\"description\" content=\"Test page\"\u003e\"#.to_string())\n            .add_meta_tag(r#\"\u003cmeta property=\"og:title\" content=\"Test\"\u003e\"#.to_string());\n            \n        let renderer = SSRRenderer::new();\n        let html = renderer.render(\u0026ctx).await;\n        \n        assert!(html.contains(r#\"\u003cmeta name=\"description\" content=\"Test page\"\u003e\"#));\n        assert!(html.contains(r#\"\u003cmeta property=\"og:title\" content=\"Test\"\u003e\"#));\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_renderer_hydration() {\n        let ctx = SSRContext::new()\n            .with_route(\"/test\".to_string());\n            \n        let renderer = SSRRenderer::new()\n            .enable_hydration(true);\n            \n        let html = renderer.render(\u0026ctx).await;\n        \n        assert!(html.contains(\"window.__SSR_CONTEXT__\"));\n        assert!(html.contains(\"hydrate_app()\"));\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_renderer_no_hydration() {\n        let ctx = SSRContext::new();\n        let renderer = SSRRenderer::new()\n            .enable_hydration(false);\n            \n        let html = renderer.render(\u0026ctx).await;\n        \n        // Should have neither SSR context nor hydration script when hydration is disabled\n        assert!(!html.contains(\"window.__SSR_CONTEXT__\"));\n        assert!(!html.contains(\"hydrate_app()\"));\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_component_server_props() {\n        let component = TestComponent {\n            content: \"Server content\".to_string(),\n        };\n        \n        let ctx = SSRContext::new();\n        let props = component.get_server_props(\u0026ctx).await.unwrap();\n        \n        assert_eq!(props[\"content\"], \"Server content\");\n        assert_eq!(props[\"server_rendered\"], true);\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_data_states() {\n        // Test loading state\n        let loading: SSRData\u003cString\u003e = SSRData::loading();\n        assert!(loading.is_loading);\n        assert!(loading.data.is_none());\n        assert!(loading.error.is_none());\n        \n        // Test success state\n        let success = SSRData::success(\"Hello\".to_string());\n        assert!(!success.is_loading);\n        assert_eq!(success.data.unwrap(), \"Hello\");\n        assert!(success.error.is_none());\n        \n        // Test error state\n        let error: SSRData\u003cString\u003e = SSRData::error(\"Failed\".to_string());\n        assert!(!error.is_loading);\n        assert!(error.data.is_none());\n        assert_eq!(error.error.unwrap(), \"Failed\");\n    }\n    \n    #[tokio::test]\n    async fn test_ssr_context_serialization() {\n        let mut headers = HashMap::new();\n        headers.insert(\"user-agent\".to_string(), \"test-agent\".to_string());\n        \n        let ctx = SSRContext::new()\n            .with_route(\"/api/test\".to_string())\n            .with_headers(headers);\n            \n        // Serialize and deserialize\n        let json = serde_json::to_string(\u0026ctx).unwrap();\n        let deserialized: SSRContext = serde_json::from_str(\u0026json).unwrap();\n        \n        assert_eq!(deserialized.route, \"/api/test\");\n        // Headers are skipped in serialization\n        assert!(deserialized.request_headers.is_empty());\n    }\n    \n    #[tokio::test]\n    async fn test_multiple_components() {\n        let mut renderer = SSRRenderer::new();\n        \n        renderer.add_component(Box::new(TestComponent {\n            content: \"First\".to_string(),\n        }));\n        \n        renderer.add_component(Box::new(TestComponent {\n            content: \"Second\".to_string(),\n        }));\n        \n        let ctx = SSRContext::new();\n        let html = renderer.render(\u0026ctx).await;\n        \n        assert!(html.contains(\"First\"));\n        assert!(html.contains(\"Second\"));\n    }\n    \n    // Test SSR App implementation\n    struct TestSSRApp;\n    \n    #[cfg(not(target_arch = \"wasm32\"))]\n    #[async_trait]\n    impl SSRApp for TestSSRApp {\n        fn routes(\u0026self) -\u003e Vec\u003cSSRRoute\u003e {\n            vec![\n                SSRRoute {\n                    path: \"/\".to_string(),\n                    handler: Arc::new(TestHandler),\n                },\n            ]\n        }\n    }\n    \n    struct TestHandler;\n    \n    #[cfg(not(target_arch = \"wasm32\"))]\n    #[async_trait]\n    impl SSRRouteHandler for TestHandler {\n        async fn handle(\u0026self, ctx: SSRContext) -\u003e Result\u003cString, String\u003e {\n            let mut renderer = SSRRenderer::new();\n            renderer.add_component(Box::new(TestComponent {\n                content: \"Route handler test\".to_string(),\n            }));\n            Ok(renderer.render(\u0026ctx).await)\n        }\n    }\n    \n    #[cfg(not(target_arch = \"wasm32\"))]\n    #[tokio::test]\n    async fn test_ssr_app_routes() {\n        let app = TestSSRApp;\n        let routes = app.routes();\n        \n        assert_eq!(routes.len(), 1);\n        assert_eq!(routes[0].path, \"/\");\n    }\n    \n    #[tokio::test]\n    async fn test_example_ssr_component() {\n        let component = ExampleSSRComponent {\n            title: \"Test Title\".to_string(),\n        };\n        \n        let mut params = HashMap::new();\n        params.insert(\"id\".to_string(), \"123\".to_string());\n        \n        let ctx = SSRContext::new()\n            .with_route(\"/test\".to_string())\n            .with_query_params(params);\n            \n        let html = component.render_to_string(\u0026ctx);\n        \n        assert!(html.contains(\"Test Title\"));\n        assert!(html.contains(\"Route: /test\"));\n        assert!(html.contains(\"123\"));\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","state.rs"],"content":"//! Global State Management - L6\n\nuse std::any::{Any, TypeId};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::rc::Rc;\nuse crate::hooks::use_effect;\n\n// Type alias to simplify complex types\ntype ReducerFn\u003cS, A\u003e = Rc\u003cdyn Fn(\u0026S, A) -\u003e S\u003e;\n\nthread_local! {\n    static STORE: RefCell\u003cStore\u003e = RefCell::new(Store::new());\n}\n\n/// Store for global state\nstruct Store {\n    state: HashMap\u003cTypeId, Box\u003cdyn Any\u003e\u003e,\n    listeners: HashMap\u003cTypeId, Vec\u003cBox\u003cdyn Fn()\u003e\u003e\u003e,\n}\n\nimpl Store {\n    fn new() -\u003e Self {\n        Store {\n            state: HashMap::new(),\n            listeners: HashMap::new(),\n        }\n    }\n\n    fn set\u003cT: 'static\u003e(\u0026mut self, value: T) {\n        let type_id = TypeId::of::\u003cT\u003e();\n        self.state.insert(type_id, Box::new(value));\n\n        // Notify listeners\n        if let Some(listeners) = self.listeners.get(\u0026type_id) {\n            for listener in listeners {\n                listener();\n            }\n        }\n    }\n\n    fn get\u003cT: 'static + Clone\u003e(\u0026self) -\u003e Option\u003cT\u003e {\n        let type_id = TypeId::of::\u003cT\u003e();\n        self.state\n            .get(\u0026type_id)\n            .and_then(|any| any.downcast_ref::\u003cT\u003e())\n            .cloned()\n    }\n\n    fn subscribe\u003cT: 'static\u003e(\u0026mut self, listener: Box\u003cdyn Fn()\u003e) -\u003e SubscriptionId {\n        let type_id = TypeId::of::\u003cT\u003e();\n        let listeners = self.listeners.entry(type_id).or_default();\n        let id = listeners.len();\n        listeners.push(listener);\n\n        SubscriptionId { type_id, id }\n    }\n\n    fn unsubscribe(\u0026mut self, sub_id: SubscriptionId) {\n        if let Some(listeners) = self.listeners.get_mut(\u0026sub_id.type_id) {\n            if sub_id.id \u003c listeners.len() {\n                let _ = listeners.remove(sub_id.id);\n            }\n        }\n    }\n}\n\n/// Subscription ID for cleanup\npub struct SubscriptionId {\n    type_id: TypeId,\n    id: usize,\n}\n\n/// Create a global state atom\npub fn create_atom\u003cT: 'static + Clone + Default\u003e(initial: T) -\u003e Atom\u003cT\u003e {\n    STORE.with(|store| {\n        store.borrow_mut().set(initial);\n    });\n\n    Atom {\n        _phantom: std::marker::PhantomData,\n    }\n}\n\n/// Atom represents a piece of global state\npub struct Atom\u003cT\u003e {\n    _phantom: std::marker::PhantomData\u003cT\u003e,\n}\n\nimpl\u003cT: 'static + Clone\u003e Atom\u003cT\u003e {\n    pub fn get(\u0026self) -\u003e Option\u003cT\u003e {\n        STORE.with(|store| store.borrow().get::\u003cT\u003e())\n    }\n\n    pub fn set(\u0026self, value: T) {\n        STORE.with(|store| store.borrow_mut().set(value));\n    }\n\n    pub fn update(\u0026self, f: impl FnOnce(\u0026mut T)) {\n        if let Some(mut value) = self.get() {\n            f(\u0026mut value);\n            self.set(value);\n        }\n    }\n\n    pub fn subscribe(\u0026self, listener: impl Fn() + 'static) -\u003e SubscriptionId {\n        STORE.with(|store| store.borrow_mut().subscribe::\u003cT\u003e(Box::new(listener)))\n    }\n}\n\n/// Use global state hook\npub fn use_atom\u003cT: 'static + Clone\u003e(atom: \u0026Atom\u003cT\u003e) -\u003e AtomHandle\u003cT\u003e {\n    let value = atom.get();\n    let update_trigger = use_update();\n\n    // Subscribe to changes\n    let sub_id = atom.subscribe(move || {\n        update_trigger();\n    });\n\n    // Cleanup on unmount (run once with empty deps)\n    use_effect((), move || {\n        move || {\n            STORE.with(|store| {\n                store.borrow_mut().unsubscribe(sub_id);\n            });\n        }\n    });\n\n    AtomHandle {\n        value,\n        atom: atom.clone(),\n    }\n}\n\n/// Handle to atom value with update capability\npub struct AtomHandle\u003cT\u003e {\n    value: Option\u003cT\u003e,\n    atom: Atom\u003cT\u003e,\n}\n\nimpl\u003cT: Clone + 'static\u003e AtomHandle\u003cT\u003e {\n    pub fn get(\u0026self) -\u003e Option\u003c\u0026T\u003e {\n        self.value.as_ref()\n    }\n\n    pub fn set(\u0026self, value: T) {\n        self.atom.set(value);\n    }\n\n    pub fn update(\u0026self, f: impl FnOnce(\u0026mut T)) {\n        self.atom.update(f);\n    }\n}\n\n/// Selector for derived state\npub struct Selector\u003cT, U\u003e {\n    source: Atom\u003cT\u003e,\n    selector: Rc\u003cdyn Fn(\u0026T) -\u003e U\u003e,\n}\n\nimpl\u003cT: 'static + Clone, U: 'static + Clone\u003e Selector\u003cT, U\u003e {\n    pub fn new(source: Atom\u003cT\u003e, selector: impl Fn(\u0026T) -\u003e U + 'static) -\u003e Self {\n        Selector {\n            source,\n            selector: Rc::new(selector),\n        }\n    }\n\n    pub fn get(\u0026self) -\u003e Option\u003cU\u003e {\n        self.source.get().map(|value| (self.selector)(\u0026value))\n    }\n}\n\n/// Use selector hook\npub fn use_selector\u003cT: 'static + Clone, U: 'static + Clone\u003e(\n    selector: \u0026Selector\u003cT, U\u003e,\n) -\u003e Option\u003cU\u003e {\n    let value = selector.get();\n    let update_trigger = use_update();\n\n    // Subscribe to source changes\n    let sub_id = selector.source.subscribe(move || {\n        update_trigger();\n    });\n\n    // Cleanup (run once with empty deps)\n    use_effect((), move || {\n        move || {\n            STORE.with(|store| {\n                store.borrow_mut().unsubscribe(sub_id);\n            });\n        }\n    });\n\n    value\n}\n\n/// Redux-style reducer store\npub struct ReducerStore\u003cS, A\u003e {\n    state: Atom\u003cS\u003e,\n    reducer: ReducerFn\u003cS, A\u003e,\n}\n\nimpl\u003cS: 'static + Clone + Default, A: 'static\u003e ReducerStore\u003cS, A\u003e {\n    pub fn new(initial: S, reducer: impl Fn(\u0026S, A) -\u003e S + 'static) -\u003e Self {\n        ReducerStore {\n            state: create_atom(initial),\n            reducer: Rc::new(reducer),\n        }\n    }\n\n    pub fn dispatch(\u0026self, action: A) {\n        if let Some(current) = self.state.get() {\n            let new_state = (self.reducer)(\u0026current, action);\n            self.state.set(new_state);\n        }\n    }\n\n    pub fn get_state(\u0026self) -\u003e Option\u003cS\u003e {\n        self.state.get()\n    }\n}\n\n/// Use reducer hook\npub fn use_reducer\u003cS: 'static + Clone + Default, A: 'static\u003e(\n    store: \u0026ReducerStore\u003cS, A\u003e,\n) -\u003e (Option\u003cS\u003e, impl Fn(A)) {\n    let state = use_atom(\u0026store.state);\n    let store_clone = store.clone();\n\n    let dispatch = move |action: A| {\n        store_clone.dispatch(action);\n    };\n\n    (state.get().cloned(), dispatch)\n}\n\n// Helper hooks that integrate with the reactive system\nfn use_update() -\u003e impl Fn() {\n    // Trigger component re-render using the reactive system\n    || {\n        crate::reactive_v2::queue_current_render();\n    }\n}\n\n// use_effect is now provided by the hooks module\n\n// Make types cloneable for convenience\nimpl\u003cT\u003e Clone for Atom\u003cT\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        Atom {\n            _phantom: std::marker::PhantomData,\n        }\n    }\n}\n\nimpl\u003cS, A\u003e Clone for ReducerStore\u003cS, A\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        ReducerStore {\n            state: self.state.clone(),\n            reducer: self.reducer.clone(),\n        }\n    }\n}\n\n// Example usage:\n#[derive(Clone, Default)]\npub struct AppState {\n    pub user: Option\u003cUser\u003e,\n    pub theme: Theme,\n    pub count: i32,\n}\n\n#[derive(Clone)]\npub struct User {\n    pub id: String,\n    pub name: String,\n}\n\n#[derive(Clone, Default)]\npub enum Theme {\n    #[default]\n    Light,\n    Dark,\n}\n\npub enum AppAction {\n    SetUser(Option\u003cUser\u003e),\n    ToggleTheme,\n    Increment,\n    Decrement,\n}\n\npub fn create_app_store() -\u003e ReducerStore\u003cAppState, AppAction\u003e {\n    let initial = AppState {\n        user: None,\n        theme: Theme::Dark,\n        count: 0,\n    };\n\n    ReducerStore::new(initial, |state, action| {\n        let mut new_state = state.clone();\n\n        match action {\n            AppAction::SetUser(user) =\u003e new_state.user = user,\n            AppAction::ToggleTheme =\u003e {\n                new_state.theme = match state.theme {\n                    Theme::Light =\u003e Theme::Dark,\n                    Theme::Dark =\u003e Theme::Light,\n                };\n            }\n            AppAction::Increment =\u003e new_state.count += 1,\n            AppAction::Decrement =\u003e new_state.count -= 1,\n        }\n\n        new_state\n    })\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":99},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","styled_component.rs"],"content":"//! Styled Components - CSS-in-Rust component integration\n//!\n//! This module provides integration between the CSS runtime and the component system,\n//! allowing components to use dynamic CSS with full support for hover states,\n//! media queries, and more.\n\nuse crate::component::{Component, Element, Props};\nuse crate::css_runtime::{CssBuilder, CssRule};\n\n/// A component wrapper that applies CSS styles dynamically\npub struct StyledComponent\u003cC: Component\u003e {\n    inner: C,\n    class_name: String,\n}\n\nimpl\u003cC: Component\u003e StyledComponent\u003cC\u003e {\n    /// Create a new styled component with a CSS rule\n    pub fn new(component: C, css_rule: CssRule) -\u003e Self {\n        let mut manager = crate::css_runtime::STYLESHEET_MANAGER.lock();\n        let class_name = manager.add_rule(\u0026css_rule);\n        \n        Self {\n            inner: component,\n            class_name,\n        }\n    }\n    \n    /// Create a styled component using the CSS builder\n    pub fn from_builder(component: C, builder: CssBuilder) -\u003e Self {\n        let class_name = builder.build();\n        \n        Self {\n            inner: component,\n            class_name,\n        }\n    }\n}\n\nimpl\u003cC: Component\u003e Component for StyledComponent\u003cC\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let mut element = self.inner.render();\n        \n        // Apply the generated class name to the root element\n        match \u0026mut element {\n            Element::Node { props, .. } =\u003e {\n                match \u0026mut props.class {\n                    Some(existing) =\u003e {\n                        // Append to existing classes\n                        *existing = format!(\"{} {}\", existing, self.class_name);\n                    }\n                    None =\u003e {\n                        props.class = Some(self.class_name.clone());\n                    }\n                }\n            }\n            _ =\u003e {\n                // Wrap non-node elements in a div with the class\n                element = Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(self.class_name.clone()),\n                        ..Default::default()\n                    },\n                    children: vec![element],\n                };\n            }\n        }\n        \n        element\n    }\n}\n\n/// Extension trait for components to add styling capabilities\npub trait ComponentStyling: Component + Sized {\n    /// Apply CSS styles to this component\n    fn styled(self, styles: CssBuilder) -\u003e StyledComponent\u003cSelf\u003e {\n        StyledComponent::from_builder(self, styles)\n    }\n    \n    /// Apply CSS styles with a custom class prefix\n    fn styled_with_prefix(self, prefix: \u0026str, styles: CssBuilder) -\u003e StyledComponent\u003cSelf\u003e {\n        StyledComponent::from_builder(self, styles.prefix(prefix))\n    }\n}\n\n// Implement the extension trait for all components\nimpl\u003cT: Component\u003e ComponentStyling for T {}\n\n/// Helper macro for creating styled components with inline CSS\n#[macro_export]\nmacro_rules! styled {\n    ($component:expr, {\n        $($prop:ident: $value:expr),* $(,)?\n    }) =\u003e {{\n        let mut builder = $crate::css_runtime::CssBuilder::new();\n        \n        // Add base properties\n        $(\n            builder = builder.property(stringify!($prop), \u0026$value.to_string());\n        )*\n        \n        $crate::styled_component::StyledComponent::from_builder($component, builder)\n    }};\n}\n\npub use styled;\n\n/// Predefined style utilities\npub mod styles {\n    use crate::css_runtime::{Breakpoint, CssBuilder, css_props};\n    \n    /// Button styles\n    pub fn button_primary() -\u003e CssBuilder {\n        CssBuilder::new()\n            .properties(css_props! {\n                \"display\" =\u003e \"inline-flex\",\n                \"align-items\" =\u003e \"center\",\n                \"justify-content\" =\u003e \"center\",\n                \"padding\" =\u003e \"0.5rem 1rem\",\n                \"background-color\" =\u003e \"var(--primary)\",\n                \"color\" =\u003e \"white\",\n                \"border\" =\u003e \"none\",\n                \"border-radius\" =\u003e \"0.375rem\",\n                \"font-size\" =\u003e \"1rem\",\n                \"font-weight\" =\u003e \"500\",\n                \"cursor\" =\u003e \"pointer\",\n                \"transition\" =\u003e \"all var(--transition-fast)\",\n                \"outline\" =\u003e \"none\"\n            })\n            .hover(css_props! {\n                \"background-color\" =\u003e \"var(--primary-dark)\",\n                \"transform\" =\u003e \"translateY(-1px)\",\n                \"box-shadow\" =\u003e \"var(--shadow-md)\"\n            })\n            .focus(css_props! {\n                \"box-shadow\" =\u003e \"0 0 0 3px rgba(102, 126, 234, 0.3)\"\n            })\n            .active(css_props! {\n                \"transform\" =\u003e \"translateY(0)\",\n                \"box-shadow\" =\u003e \"var(--shadow-sm)\"\n            })\n            .disabled(css_props! {\n                \"opacity\" =\u003e \"0.5\",\n                \"cursor\" =\u003e \"not-allowed\"\n            })\n    }\n    \n    /// Card styles\n    pub fn card() -\u003e CssBuilder {\n        CssBuilder::new()\n            .properties(css_props! {\n                \"background-color\" =\u003e \"white\",\n                \"border-radius\" =\u003e \"0.5rem\",\n                \"box-shadow\" =\u003e \"var(--shadow-md)\",\n                \"padding\" =\u003e \"1.5rem\",\n                \"transition\" =\u003e \"all var(--transition-normal)\"\n            })\n            .hover(css_props! {\n                \"box-shadow\" =\u003e \"var(--shadow-lg)\",\n                \"transform\" =\u003e \"translateY(-2px)\"\n            })\n            .media(\"(prefers-color-scheme: dark)\", css_props! {\n                \"background-color\" =\u003e \"var(--background-dark)\",\n                \"border\" =\u003e \"1px solid var(--border-dark)\"\n            })\n    }\n    \n    /// Grid container\n    pub fn grid(columns: u8) -\u003e CssBuilder {\n        CssBuilder::new()\n            .properties(css_props! {\n                \"display\" =\u003e \"grid\",\n                \"gap\" =\u003e \"1rem\",\n                \"grid-template-columns\" =\u003e format!(\"repeat({}, minmax(0, 1fr))\", columns)\n            })\n            .breakpoint(Breakpoint::Md, css_props! {\n                \"grid-template-columns\" =\u003e format!(\"repeat({}, minmax(0, 1fr))\", columns.min(2))\n            })\n            .breakpoint(Breakpoint::Sm, css_props! {\n                \"grid-template-columns\" =\u003e \"1fr\"\n            })\n    }\n    \n    /// Flex container\n    pub fn flex_center() -\u003e CssBuilder {\n        CssBuilder::new()\n            .properties(css_props! {\n                \"display\" =\u003e \"flex\",\n                \"align-items\" =\u003e \"center\",\n                \"justify-content\" =\u003e \"center\"\n            })\n    }\n    \n    /// Text styles\n    pub fn heading() -\u003e CssBuilder {\n        CssBuilder::new()\n            .properties(css_props! {\n                \"font-size\" =\u003e \"2rem\",\n                \"font-weight\" =\u003e \"700\",\n                \"line-height\" =\u003e \"1.2\",\n                \"margin-bottom\" =\u003e \"1rem\",\n                \"color\" =\u003e \"var(--text)\"\n            })\n            .breakpoint(Breakpoint::Md, css_props! {\n                \"font-size\" =\u003e \"1.75rem\"\n            })\n            .breakpoint(Breakpoint::Sm, css_props! {\n                \"font-size\" =\u003e \"1.5rem\"\n            })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::component::Component;\n    \n    struct TestComponent {\n        text: String,\n    }\n    \n    impl Component for TestComponent {\n        fn render(\u0026self) -\u003e Element {\n            Element::Text(self.text.clone())\n        }\n    }\n    \n    #[test]\n    #[cfg(target_arch = \"wasm32\")]\n    fn test_styled_component() {\n        let component = TestComponent {\n            text: \"Hello\".to_string(),\n        };\n        \n        let styled = component.styled(\n            CssBuilder::new()\n                .property(\"color\", \"red\")\n                .property(\"font-size\", \"16px\")\n        );\n        \n        // The styled component should wrap the original in a div with classes\n        match styled.render() {\n            Element::Node { props, children, .. } =\u003e {\n                assert!(props.class.is_some());\n                assert!(props.class.unwrap().starts_with(\"l9-\"));\n                assert_eq!(children.len(), 1);\n            }\n            _ =\u003e panic!(\"Expected Node element\"),\n        }\n    }\n}","traces":[{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":96},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","styles.rs"],"content":"//! Styling System - CSS-in-Rust (L3)\n\nuse crate::component::{Element, Props};\nuse crate::prelude::Component;\nuse once_cell::sync::Lazy;\nuse std::collections::HashMap;\n\n/// Style class builder - Tailwind-like utility classes in Rust\n#[derive(Default)]\npub struct StyleBuilder {\n    classes: Vec\u003cString\u003e,\n    custom: HashMap\u003cString, String\u003e,\n}\n\nimpl StyleBuilder {\n    pub fn new() -\u003e Self {\n        StyleBuilder::default()\n    }\n\n    // Layout\n    pub fn flex(mut self) -\u003e Self {\n        self.classes.push(\"display: flex\".to_string());\n        self\n    }\n\n    pub fn grid(mut self) -\u003e Self {\n        self.classes.push(\"display: grid\".to_string());\n        self\n    }\n\n    pub fn hidden(mut self) -\u003e Self {\n        self.classes.push(\"display: none\".to_string());\n        self\n    }\n\n    // Flexbox\n    pub fn items_center(mut self) -\u003e Self {\n        self.classes.push(\"align-items: center\".to_string());\n        self\n    }\n\n    pub fn justify_center(mut self) -\u003e Self {\n        self.classes.push(\"justify-content: center\".to_string());\n        self\n    }\n\n    pub fn justify_between(mut self) -\u003e Self {\n        self.classes\n            .push(\"justify-content: space-between\".to_string());\n        self\n    }\n\n    pub fn gap(mut self, size: u8) -\u003e Self {\n        self.custom\n            .insert(\"gap\".to_string(), format!(\"{}rem\", size as f32 * 0.25));\n        self\n    }\n\n    // Spacing\n    pub fn p(mut self, size: u8) -\u003e Self {\n        self.custom\n            .insert(\"padding\".to_string(), format!(\"{}rem\", size as f32 * 0.25));\n        self\n    }\n\n    pub fn px(mut self, size: u8) -\u003e Self {\n        self.custom.insert(\n            \"padding-left\".to_string(),\n            format!(\"{}rem\", size as f32 * 0.25),\n        );\n        self.custom.insert(\n            \"padding-right\".to_string(),\n            format!(\"{}rem\", size as f32 * 0.25),\n        );\n        self\n    }\n\n    pub fn py(mut self, size: u8) -\u003e Self {\n        self.custom.insert(\n            \"padding-top\".to_string(),\n            format!(\"{}rem\", size as f32 * 0.25),\n        );\n        self.custom.insert(\n            \"padding-bottom\".to_string(),\n            format!(\"{}rem\", size as f32 * 0.25),\n        );\n        self\n    }\n\n    pub fn m(mut self, size: u8) -\u003e Self {\n        self.custom\n            .insert(\"margin\".to_string(), format!(\"{}rem\", size as f32 * 0.25));\n        self\n    }\n\n    pub fn mx_auto(mut self) -\u003e Self {\n        self.custom\n            .insert(\"margin-left\".to_string(), \"auto\".to_string());\n        self.custom\n            .insert(\"margin-right\".to_string(), \"auto\".to_string());\n        self\n    }\n\n    // Typography\n    pub fn text_sm(mut self) -\u003e Self {\n        self.classes.push(\"font-size: 0.875rem\".to_string());\n        self.classes.push(\"line-height: 1.25rem\".to_string());\n        self\n    }\n\n    pub fn text_lg(mut self) -\u003e Self {\n        self.classes.push(\"font-size: 1.125rem\".to_string());\n        self.classes.push(\"line-height: 1.75rem\".to_string());\n        self\n    }\n\n    pub fn text_xl(mut self) -\u003e Self {\n        self.classes.push(\"font-size: 1.25rem\".to_string());\n        self.classes.push(\"line-height: 1.75rem\".to_string());\n        self\n    }\n\n    pub fn font_bold(mut self) -\u003e Self {\n        self.classes.push(\"font-weight: 700\".to_string());\n        self\n    }\n\n    pub fn text_center(mut self) -\u003e Self {\n        self.classes.push(\"text-align: center\".to_string());\n        self\n    }\n\n    // Colors\n    pub fn bg_black(mut self) -\u003e Self {\n        self.classes.push(\"background-color: #000000\".to_string());\n        self\n    }\n\n    pub fn bg_white(mut self) -\u003e Self {\n        self.classes.push(\"background-color: #ffffff\".to_string());\n        self\n    }\n\n    pub fn text_white(mut self) -\u003e Self {\n        self.classes.push(\"color: #ffffff\".to_string());\n        self\n    }\n\n    pub fn text_gray_500(mut self) -\u003e Self {\n        self.classes.push(\"color: #6b7280\".to_string());\n        self\n    }\n\n    // Borders\n    pub fn border(mut self) -\u003e Self {\n        self.classes.push(\"border-width: 1px\".to_string());\n        self.classes.push(\"border-style: solid\".to_string());\n        self\n    }\n\n    pub fn border_gray_200(mut self) -\u003e Self {\n        self.classes.push(\"border-color: #e5e7eb\".to_string());\n        self\n    }\n\n    pub fn rounded(mut self) -\u003e Self {\n        self.classes.push(\"border-radius: 0.25rem\".to_string());\n        self\n    }\n\n    pub fn rounded_lg(mut self) -\u003e Self {\n        self.classes.push(\"border-radius: 0.5rem\".to_string());\n        self\n    }\n\n    // Effects\n    pub fn shadow(mut self) -\u003e Self {\n        self.classes\n            .push(\"box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1)\".to_string());\n        self\n    }\n\n    pub fn transition(mut self) -\u003e Self {\n        self.classes.push(\"transition-property: all\".to_string());\n        self.classes.push(\"transition-duration: 150ms\".to_string());\n        self\n    }\n\n    pub fn hover_bg_gray_100(mut self) -\u003e Self {\n        // Note: Hover states need special handling in WASM\n        self.classes\n            .push(\"hover:background-color: #f3f4f6\".to_string());\n        self\n    }\n\n    // Dark mode\n    pub fn dark_bg_gray_800(mut self) -\u003e Self {\n        self.classes\n            .push(\"@media (prefers-color-scheme: dark) { background-color: #1f2937 }\".to_string());\n        self\n    }\n\n    pub fn dark_text_gray_100(mut self) -\u003e Self {\n        self.classes\n            .push(\"@media (prefers-color-scheme: dark) { color: #f3f4f6 }\".to_string());\n        self\n    }\n\n    // Responsive\n    pub fn md_flex(mut self) -\u003e Self {\n        self.classes\n            .push(\"@media (min-width: 768px) { display: flex }\".to_string());\n        self\n    }\n\n    pub fn lg_grid_cols(mut self, cols: u8) -\u003e Self {\n        self.classes.push(format!(\n            \"@media (min-width: 1024px) {{ grid-template-columns: repeat({}, minmax(0, 1fr)) }}\",\n            cols\n        ));\n        self\n    }\n\n    // Build final style string\n    pub fn build(self) -\u003e String {\n        let mut styles = vec![];\n\n        // Add static classes\n        for class in self.classes {\n            styles.push(class.to_string());\n        }\n\n        // Add custom properties\n        for (prop, value) in self.custom {\n            styles.push(format!(\"{}: {}\", prop, value));\n        }\n\n        styles.join(\"; \")\n    }\n}\n\n/// Styled component wrapper\npub struct Styled\u003cT: Component\u003e {\n    component: T,\n    styles: String,\n}\n\nimpl\u003cT: Component\u003e Styled\u003cT\u003e {\n    pub fn new(component: T, styles: StyleBuilder) -\u003e Self {\n        Styled {\n            component,\n            styles: styles.build(),\n        }\n    }\n}\n\nimpl\u003cT: Component\u003e Component for Styled\u003cT\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let inner = self.component.render();\n\n        // Wrap with styled div\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                attributes: vec![(\"style\".to_string(), self.styles.clone())],\n                ..Default::default()\n            },\n            children: vec![inner],\n        }\n    }\n}\n\n/// Theme system\npub struct Theme {\n    pub colors: ThemeColors,\n    pub spacing: ThemeSpacing,\n    pub typography: ThemeTypography,\n}\n\npub struct ThemeColors {\n    pub primary: \u0026'static str,\n    pub secondary: \u0026'static str,\n    pub background: \u0026'static str,\n    pub foreground: \u0026'static str,\n    pub muted: \u0026'static str,\n    pub border: \u0026'static str,\n}\n\npub struct ThemeSpacing {\n    pub unit: f32, // 0.25rem\n}\n\npub struct ThemeTypography {\n    pub font_family: \u0026'static str,\n    pub font_size_base: \u0026'static str,\n}\n\n#[allow(dead_code)]\nstatic DEFAULT_THEME: Lazy\u003cTheme\u003e = Lazy::new(|| Theme {\n    colors: ThemeColors {\n        primary: \"#667eea\",\n        secondary: \"#764ba2\",\n        background: \"#000000\",\n        foreground: \"#ffffff\",\n        muted: \"#6b7280\",\n        border: \"#e5e7eb\",\n    },\n    spacing: ThemeSpacing { unit: 0.25 },\n    typography: ThemeTypography {\n        font_family: \"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif\",\n        font_size_base: \"16px\",\n    },\n});\n\n/// Global styles injection\npub fn inject_global_styles() {\n    let window = web_sys::window().unwrap();\n    let document = window.document().unwrap();\n    let head = document.head().unwrap();\n\n    let style = document.create_element(\"style\").unwrap();\n    style.set_inner_html(\n        r#\"\n        * {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n        \n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background-color: #000;\n            color: #fff;\n            line-height: 1.5;\n        }\n        \n        /* Dark mode support */\n        @media (prefers-color-scheme: dark) {\n            :root {\n                --background: #000;\n                --foreground: #fff;\n            }\n        }\n        \n        /* Animations */\n        @keyframes pulse {\n            0%, 100% { opacity: 0.5; }\n            50% { opacity: 1; }\n        }\n        \n        .animate-pulse {\n            animation: pulse 1.5s ease-in-out infinite;\n        }\n        \n        /* Reality glitch effect */\n        @keyframes glitch {\n            0% { transform: translate(0); }\n            20% { transform: translate(-2px, 2px); }\n            40% { transform: translate(-2px, -2px); }\n            60% { transform: translate(2px, 2px); }\n            80% { transform: translate(2px, -2px); }\n            100% { transform: translate(0); }\n        }\n        \n        .reality-glitch {\n            animation: glitch 0.3s ease-in-out;\n        }\n    \"#,\n    );\n\n    head.append_child(\u0026style).unwrap();\n}\n\n/// Style macro for inline styles\n#[macro_export]\nmacro_rules! style {\n    ($($method:ident $(($($arg:expr),*))?),* $(,)?) =\u003e {{\n        let mut builder = $crate::styles::StyleBuilder::new();\n        $(\n            builder = builder.$method$(($($arg),*))?;\n        )*\n        builder\n    }};\n}\n\npub use style;\n\n// Usage example:\n// let button_style = style![\n//     flex,\n//     items_center,\n//     gap(2),\n//     px(4),\n//     py(2),\n//     bg_black,\n//     text_white,\n//     border,\n//     rounded_lg,\n//     transition,\n//     hover_bg_gray_100,\n// ];\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":158},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","test.rs"],"content":"//! Testing Framework - L7/L8\n\n#[allow(unused_imports)] // These are used in test macros and examples\nuse crate::component::{use_state, Component, Element, Props};\nuse std::future::Future;\n#[allow(unused_imports)] // Used in test macros\nuse std::panic;\n#[allow(unused_imports)] // Used in test macros\nuse std::rc::Rc;\nuse wasm_bindgen::JsCast;\n#[cfg(test)]\nuse wasm_bindgen_test::*;\n\n// Type alias to simplify complex types\ntype PropsModifierFn\u003cT\u003e = Box\u003cdyn Fn(\u0026mut T)\u003e;\n\n/// Test context for components\npub struct TestContext {\n    container: web_sys::Element,\n}\n\nimpl Default for TestContext {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl TestContext {\n    pub fn new() -\u003e Self {\n        let document = web_sys::window().unwrap().document().unwrap();\n        let container = document.create_element(\"div\").unwrap();\n        container.set_id(\"test-container\");\n        document.body().unwrap().append_child(\u0026container).unwrap();\n\n        TestContext { container }\n    }\n\n    pub fn render(\u0026self, component: impl Component) -\u003e TestResult {\n        // Clear container\n        self.container.set_inner_html(\"\");\n\n        // Render component\n        component.mount(\u0026self.container);\n\n        TestResult {\n            container: self.container.clone(),\n        }\n    }\n\n    pub fn cleanup(\u0026self) {\n        self.container.remove();\n    }\n}\n\n/// Test result with query methods\npub struct TestResult {\n    container: web_sys::Element,\n}\n\nimpl TestResult {\n    pub fn get_by_text(\u0026self, text: \u0026str) -\u003e Option\u003cweb_sys::Element\u003e {\n        let document = web_sys::window().unwrap().document().unwrap();\n        let selector = format!(\"#{} *\", self.container.id());\n        let elements = document.query_selector_all(\u0026selector).unwrap();\n\n        for i in 0..elements.length() {\n            if let Some(element) = elements.item(i) {\n                if let Some(el) = element.dyn_ref::\u003cweb_sys::Element\u003e() {\n                    if el.text_content().map(|t| t.contains(text)).unwrap_or(false) {\n                        return Some(el.clone());\n                    }\n                }\n            }\n        }\n\n        None\n    }\n\n    pub fn get_by_role(\u0026self, role: \u0026str) -\u003e Option\u003cweb_sys::Element\u003e {\n        self.container\n            .query_selector(\u0026format!(\"[role='{}']\", role))\n            .ok()\n            .flatten()\n    }\n\n    pub fn get_by_id(\u0026self, id: \u0026str) -\u003e Option\u003cweb_sys::Element\u003e {\n        self.container\n            .query_selector(\u0026format!(\"#{}\", id))\n            .ok()\n            .flatten()\n    }\n\n    pub fn get_all_by_class(\u0026self, class: \u0026str) -\u003e Vec\u003cweb_sys::Element\u003e {\n        let document = web_sys::window().unwrap().document().unwrap();\n        let selector = format!(\"#{} .{}\", self.container.id(), class);\n        let elements = document.query_selector_all(\u0026selector).unwrap();\n\n        let mut result = vec![];\n        for i in 0..elements.length() {\n            if let Some(element) = elements.item(i) {\n                if let Some(el) = element.dyn_ref::\u003cweb_sys::Element\u003e() {\n                    result.push(el.clone());\n                }\n            }\n        }\n\n        result\n    }\n\n    pub fn debug(\u0026self) {\n        web_sys::console::log_1(\u0026self.container.outer_html().into());\n    }\n}\n\n/// Test utilities\npub struct TestUtils;\n\nimpl TestUtils {\n    /// Simulate click event\n    pub fn click(element: \u0026web_sys::Element) {\n        let event = web_sys::MouseEvent::new(\"click\").unwrap();\n        element.dispatch_event(\u0026event).unwrap();\n    }\n\n    /// Simulate input change\n    pub fn change_input(element: \u0026web_sys::Element, value: \u0026str) {\n        if let Some(input) = element.dyn_ref::\u003cweb_sys::HtmlInputElement\u003e() {\n            input.set_value(value);\n\n            let event = web_sys::Event::new(\"input\").unwrap();\n            element.dispatch_event(\u0026event).unwrap();\n        }\n    }\n\n    /// Wait for condition\n    pub async fn wait_for\u003cF\u003e(condition: F, timeout_ms: u32) -\u003e Result\u003c(), String\u003e\n    where\n        F: Fn() -\u003e bool,\n    {\n        let start = js_sys::Date::now();\n\n        while !condition() {\n            if js_sys::Date::now() - start \u003e timeout_ms as f64 {\n                return Err(\"Timeout waiting for condition\".to_string());\n            }\n\n            // Sleep for a bit\n            wasm_bindgen_futures::JsFuture::from(js_sys::Promise::new(\u0026mut |resolve, _| {\n                web_sys::window()\n                    .unwrap()\n                    .set_timeout_with_callback_and_timeout_and_arguments_0(\u0026resolve, 10)\n                    .unwrap();\n            }))\n            .await\n            .unwrap();\n        }\n\n        Ok(())\n    }\n\n    /// Wait for element\n    pub async fn wait_for_element(\n        container: \u0026web_sys::Element,\n        selector: \u0026str,\n    ) -\u003e Result\u003cweb_sys::Element, String\u003e {\n        Self::wait_for(\n            || container.query_selector(selector).ok().flatten().is_some(),\n            5000,\n        )\n        .await?;\n\n        container\n            .query_selector(selector)\n            .ok()\n            .flatten()\n            .ok_or_else(|| \"Element not found\".to_string())\n    }\n}\n\n/// Test macros\n#[macro_export]\nmacro_rules! layer9_test {\n    ($name:ident, $body:expr) =\u003e {\n        #[wasm_bindgen_test]\n        async fn $name() {\n            let ctx = TestContext::new();\n            let result = panic::catch_unwind(panic::AssertUnwindSafe(|| $body(\u0026ctx)));\n            ctx.cleanup();\n\n            if let Err(e) = result {\n                panic::resume_unwind(e);\n            }\n        }\n    };\n}\n\n#[macro_export]\nmacro_rules! assert_text_content {\n    ($element:expr, $expected:expr) =\u003e {\n        assert_eq!(\n            $element.text_content().unwrap_or_default(),\n            $expected,\n            \"Expected text content '{}', got '{}'\",\n            $expected,\n            $element.text_content().unwrap_or_default()\n        );\n    };\n}\n\n#[macro_export]\nmacro_rules! assert_has_class {\n    ($element:expr, $class:expr) =\u003e {\n        assert!(\n            $element.class_list().contains($class),\n            \"Expected element to have class '{}', but it doesn't\",\n            $class\n        );\n    };\n}\n\n/// Component test harness\npub struct ComponentTest\u003cT: Component\u003e {\n    component: T,\n    props_modifier: Option\u003cPropsModifierFn\u003cT\u003e\u003e,\n}\n\nimpl\u003cT: Component\u003e ComponentTest\u003cT\u003e {\n    pub fn new(component: T) -\u003e Self {\n        ComponentTest {\n            component,\n            props_modifier: None,\n        }\n    }\n\n    pub fn with_props(mut self, modifier: impl Fn(\u0026mut T) + 'static) -\u003e Self {\n        self.props_modifier = Some(Box::new(modifier));\n        self\n    }\n\n    pub fn render(mut self) -\u003e TestResult {\n        if let Some(modifier) = self.props_modifier {\n            modifier(\u0026mut self.component);\n        }\n\n        let ctx = TestContext::new();\n        ctx.render(self.component)\n    }\n}\n\n/// Snapshot testing\npub struct Snapshot;\n\nimpl Snapshot {\n    pub fn assert_matches(name: \u0026str, content: \u0026str) {\n        // In real implementation, this would:\n        // 1. Load snapshot from file\n        // 2. Compare with content\n        // 3. Update snapshot if in update mode\n        // 4. Fail test if mismatch\n\n        web_sys::console::log_1(\n            \u0026format!(\"Snapshot test '{}' would check:\\n{}\", name, content).into(),\n        );\n    }\n}\n\n/// Performance testing\npub struct PerfTest;\n\nimpl PerfTest {\n    pub fn measure\u003cF, R\u003e(name: \u0026str, f: F) -\u003e R\n    where\n        F: FnOnce() -\u003e R,\n    {\n        let start = web_sys::Performance::now(\u0026web_sys::window().unwrap().performance().unwrap());\n        let result = f();\n        let end = web_sys::Performance::now(\u0026web_sys::window().unwrap().performance().unwrap());\n\n        web_sys::console::log_1(\u0026format!(\"{} took {}ms\", name, end - start).into());\n\n        result\n    }\n\n    pub async fn measure_async\u003cF, Fut, R\u003e(name: \u0026str, f: F) -\u003e R\n    where\n        F: FnOnce() -\u003e Fut,\n        Fut: Future\u003cOutput = R\u003e,\n    {\n        let start = web_sys::Performance::now(\u0026web_sys::window().unwrap().performance().unwrap());\n        let result = f().await;\n        let end = web_sys::Performance::now(\u0026web_sys::window().unwrap().performance().unwrap());\n\n        web_sys::console::log_1(\u0026format!(\"{} took {}ms\", name, end - start).into());\n\n        result\n    }\n}\n\n/// Example tests\n#[cfg(test)]\n#[allow(dead_code)]\nmod tests {\n    use super::*;\n\n    layer9_test!(test_button_click, |ctx: \u0026TestContext| {\n        // Create a counter component\n        struct Counter;\n        impl Component for Counter {\n            fn render(\u0026self) -\u003e Element {\n                let count = use_state(|| 0);\n\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props::default(),\n                    children: vec![\n                        Element::Node {\n                            tag: \"span\".to_string(),\n                            props: Props {\n                                id: Some(\"count\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(count.get().to_string())],\n                        },\n                        Element::Node {\n                            tag: \"button\".to_string(),\n                            props: Props {\n                                id: Some(\"increment\".to_string()),\n                                on_click: Some(Rc::new(move || count.set(count.get() + 1))),\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(\"Increment\".to_string())],\n                        },\n                    ],\n                }\n            }\n        }\n\n        // Render component\n        let result = ctx.render(Counter);\n\n        // Get elements\n        let count_el = result.get_by_id(\"count\").unwrap();\n        let button = result.get_by_id(\"increment\").unwrap();\n\n        // Initial state\n        assert_text_content!(count_el, \"0\");\n\n        // Click button\n        TestUtils::click(\u0026button);\n\n        // Check updated state\n        assert_text_content!(count_el, \"1\");\n    });\n\n    /* // Commented out due to lifetime issues\n    layer9_test!(test_form_submission, |ctx: \u0026TestContext| async {\n        // Test form component\n        struct LoginForm;\n        impl Component for LoginForm {\n            fn render(\u0026self) -\u003e Element {\n                Element::Node {\n                    tag: \"form\".to_string(),\n                    props: Props {\n                        id: Some(\"login-form\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"input\".to_string(),\n                            props: Props {\n                                id: Some(\"email\".to_string()),\n                                attributes: vec![(\"type\".to_string(), \"email\".to_string())],\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"input\".to_string(),\n                            props: Props {\n                                id: Some(\"password\".to_string()),\n                                attributes: vec![(\"type\".to_string(), \"password\".to_string())],\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"button\".to_string(),\n                            props: Props {\n                                attributes: vec![(\"type\".to_string(), \"submit\".to_string())],\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(\"Login\".to_string())],\n                        },\n                    ],\n                }\n            }\n        }\n\n        let result = ctx.render(LoginForm);\n\n        // Fill form\n        let email = result.get_by_id(\"email\").unwrap();\n        let password = result.get_by_id(\"password\").unwrap();\n\n        TestUtils::change_input(\u0026email, \"test@example.com\");\n        TestUtils::change_input(\u0026password, \"secret123\");\n\n        // Submit form\n        let form = result.get_by_id(\"login-form\").unwrap();\n        let event = web_sys::Event::new(\"submit\").unwrap();\n        form.dispatch_event(\u0026event).unwrap();\n\n        // Wait for async operation\n        TestUtils::wait_for(\n            || {\n                // Check for success message or redirect\n                false\n            },\n            1000,\n        )\n        .await\n        .ok();\n    }); */\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":91},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","ui.rs"],"content":"//! UI Component Library - L5 (shadcn/ui in Rust)\n\nuse crate::component::{Component, Element, Props};\nuse crate::styles::style;\nuse std::rc::Rc;\n\n/// Button component\npub struct Button {\n    text: String,\n    variant: ButtonVariant,\n    on_click: Option\u003cRc\u003cdyn Fn()\u003e\u003e,\n}\n\n#[derive(Clone, Copy)]\npub enum ButtonVariant {\n    Primary,\n    Secondary,\n    Outline,\n    Ghost,\n    Destructive,\n}\n\nimpl Button {\n    pub fn new(text: impl Into\u003cString\u003e) -\u003e Self {\n        Button {\n            text: text.into(),\n            variant: ButtonVariant::Primary,\n            on_click: None,\n        }\n    }\n\n    pub fn variant(mut self, variant: ButtonVariant) -\u003e Self {\n        self.variant = variant;\n        self\n    }\n\n    pub fn on_click(mut self, handler: impl Fn() + 'static) -\u003e Self {\n        self.on_click = Some(Rc::new(handler));\n        self\n    }\n}\n\nimpl Component for Button {\n    fn render(\u0026self) -\u003e Element {\n        let base_style = style![px(4), py(2), rounded(), font_bold(), transition(),];\n\n        let variant_style = match self.variant {\n            ButtonVariant::Primary =\u003e style![bg_black(), text_white(), hover_bg_gray_100()],\n            ButtonVariant::Secondary =\u003e {\n                style![bg_white(), text_gray_500(), border(), border_gray_200()]\n            }\n            ButtonVariant::Outline =\u003e style![border(), border_gray_200(), hover_bg_gray_100()],\n            ButtonVariant::Ghost =\u003e style![hover_bg_gray_100()],\n            ButtonVariant::Destructive =\u003e style![text_white()], // bg_red_500\n        };\n\n        let style_str = format!(\"{};{}\", base_style.build(), variant_style.build());\n\n        Element::Node {\n            tag: \"button\".to_string(),\n            props: Props {\n                attributes: vec![(\"style\".to_string(), style_str)],\n                on_click: self.on_click.clone(),\n                ..Default::default()\n            },\n            children: vec![Element::Text(self.text.clone())],\n        }\n    }\n}\n\n/// Card component\npub struct Card {\n    children: Vec\u003cElement\u003e,\n    class: Option\u003cString\u003e,\n}\n\nimpl Default for Card {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Card {\n    pub fn new() -\u003e Self {\n        Card {\n            children: vec![],\n            class: None,\n        }\n    }\n\n    pub fn children(mut self, children: Vec\u003cElement\u003e) -\u003e Self {\n        self.children = children;\n        self\n    }\n\n    pub fn class(mut self, class: impl Into\u003cString\u003e) -\u003e Self {\n        self.class = Some(class.into());\n        self\n    }\n}\n\nimpl Component for Card {\n    fn render(\u0026self) -\u003e Element {\n        let style = style![\n            bg_white(),\n            dark_bg_gray_800(),\n            rounded_lg(),\n            shadow(),\n            p(6),\n            border(),\n            border_gray_200(),\n        ];\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: self.class.clone(),\n                attributes: vec![(\"style\".to_string(), style.build())],\n                ..Default::default()\n            },\n            children: self.children.clone(),\n        }\n    }\n}\n\n/// Input component\npub struct Input {\n    placeholder: Option\u003cString\u003e,\n    value: String,\n    on_change: Option\u003cRc\u003cdyn Fn(String)\u003e\u003e,\n}\n\nimpl Default for Input {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Input {\n    pub fn new() -\u003e Self {\n        Input {\n            placeholder: None,\n            value: String::new(),\n            on_change: None,\n        }\n    }\n\n    pub fn placeholder(mut self, placeholder: impl Into\u003cString\u003e) -\u003e Self {\n        self.placeholder = Some(placeholder.into());\n        self\n    }\n\n    pub fn value(mut self, value: impl Into\u003cString\u003e) -\u003e Self {\n        self.value = value.into();\n        self\n    }\n\n    pub fn on_change(mut self, handler: impl Fn(String) + 'static) -\u003e Self {\n        self.on_change = Some(Rc::new(handler));\n        self\n    }\n}\n\nimpl Component for Input {\n    fn render(\u0026self) -\u003e Element {\n        let style = style![\n            px(3),\n            py(2),\n            border(),\n            border_gray_200(),\n            rounded(),\n            bg_white(),\n            dark_bg_gray_800(),\n            text_gray_500(),\n            dark_text_gray_100(),\n        ];\n\n        let mut attrs = vec![\n            (\"style\".to_string(), style.build()),\n            (\"value\".to_string(), self.value.clone()),\n        ];\n\n        if let Some(placeholder) = \u0026self.placeholder {\n            attrs.push((\"placeholder\".to_string(), placeholder.clone()));\n        }\n\n        Element::Node {\n            tag: \"input\".to_string(),\n            props: Props {\n                attributes: attrs,\n                ..Default::default()\n            },\n            children: vec![],\n        }\n    }\n}\n\n/// Badge component\npub struct Badge {\n    text: String,\n    variant: BadgeVariant,\n}\n\n#[derive(Clone, Copy)]\npub enum BadgeVariant {\n    Default,\n    Secondary,\n    Outline,\n    Destructive,\n}\n\nimpl Badge {\n    pub fn new(text: impl Into\u003cString\u003e) -\u003e Self {\n        Badge {\n            text: text.into(),\n            variant: BadgeVariant::Default,\n        }\n    }\n\n    pub fn variant(mut self, variant: BadgeVariant) -\u003e Self {\n        self.variant = variant;\n        self\n    }\n}\n\nimpl Component for Badge {\n    fn render(\u0026self) -\u003e Element {\n        let base_style = style![px(2), py(1), text_sm(), font_bold(), rounded(),];\n\n        let variant_style = match self.variant {\n            BadgeVariant::Default =\u003e style![bg_black(), text_white()],\n            BadgeVariant::Secondary =\u003e style![bg_white(), text_gray_500()],\n            BadgeVariant::Outline =\u003e style![border(), border_gray_200()],\n            BadgeVariant::Destructive =\u003e style![text_white()], // bg_red_500\n        };\n\n        let style_str = format!(\"{};{}\", base_style.build(), variant_style.build());\n\n        Element::Node {\n            tag: \"span\".to_string(),\n            props: Props {\n                attributes: vec![(\"style\".to_string(), style_str)],\n                ..Default::default()\n            },\n            children: vec![Element::Text(self.text.clone())],\n        }\n    }\n}\n\n/// Progress component\npub struct Progress {\n    value: f32, // 0.0 to 100.0\n    class: Option\u003cString\u003e,\n}\n\nimpl Progress {\n    pub fn new(value: f32) -\u003e Self {\n        Progress {\n            value: value.clamp(0.0, 100.0),\n            class: None,\n        }\n    }\n\n    pub fn class(mut self, class: impl Into\u003cString\u003e) -\u003e Self {\n        self.class = Some(class.into());\n        self\n    }\n}\n\nimpl Component for Progress {\n    fn render(\u0026self) -\u003e Element {\n        let container_style = style![bg_white(), dark_bg_gray_800(), rounded(), shadow(),];\n\n        let bar_style = format!(\n            \"width: {}%; height: 8px; background-color: #667eea; border-radius: 0.25rem; transition: width 0.3s ease\",\n            self.value\n        );\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: self.class.clone(),\n                attributes: vec![\n                    (\"style\".to_string(), container_style.build()),\n                    (\"role\".to_string(), \"progressbar\".to_string()),\n                    (\"aria-valuenow\".to_string(), self.value.to_string()),\n                    (\"aria-valuemin\".to_string(), \"0\".to_string()),\n                    (\"aria-valuemax\".to_string(), \"100\".to_string()),\n                ],\n                ..Default::default()\n            },\n            children: vec![Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    attributes: vec![(\"style\".to_string(), bar_style)],\n                    ..Default::default()\n                },\n                children: vec![],\n            }],\n        }\n    }\n}\n\n/// Avatar component\npub struct Avatar {\n    src: Option\u003cString\u003e,\n    alt: String,\n    fallback: String,\n}\n\nimpl Default for Avatar {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Avatar {\n    pub fn new() -\u003e Self {\n        Avatar {\n            src: None,\n            alt: String::new(),\n            fallback: String::new(),\n        }\n    }\n\n    pub fn src(mut self, src: impl Into\u003cString\u003e) -\u003e Self {\n        self.src = Some(src.into());\n        self\n    }\n\n    pub fn alt(mut self, alt: impl Into\u003cString\u003e) -\u003e Self {\n        self.alt = alt.into();\n        self\n    }\n\n    pub fn fallback(mut self, fallback: impl Into\u003cString\u003e) -\u003e Self {\n        self.fallback = fallback.into();\n        self\n    }\n}\n\nimpl Component for Avatar {\n    fn render(\u0026self) -\u003e Element {\n        let style = style![rounded(), shadow(),];\n\n        if let Some(src) = \u0026self.src {\n            Element::Node {\n                tag: \"img\".to_string(),\n                props: Props {\n                    attributes: vec![\n                        (\"src\".to_string(), src.clone()),\n                        (\"alt\".to_string(), self.alt.clone()),\n                        (\n                            \"style\".to_string(),\n                            format!(\"{};width:40px;height:40px;border-radius:50%\", style.build()),\n                        ),\n                    ],\n                    ..Default::default()\n                },\n                children: vec![],\n            }\n        } else {\n            // Fallback to initials\n            let fallback_style = style![\n                flex(),\n                items_center(),\n                justify_center(),\n                bg_black(),\n                text_white(),\n                font_bold(),\n            ];\n\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    attributes: vec![(\n                        \"style\".to_string(),\n                        format!(\n                            \"{};{};width:40px;height:40px;border-radius:50%\",\n                            style.build(),\n                            fallback_style.build()\n                        ),\n                    )],\n                    ..Default::default()\n                },\n                children: vec![Element::Text(self.fallback.clone())],\n            }\n        }\n    }\n}\n\n/// Tabs component\npub struct Tabs {\n    tabs: Vec\u003cTab\u003e,\n    active: usize,\n}\n\npub struct Tab {\n    label: String,\n    content: Element,\n}\n\nimpl Default for Tabs {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl Tabs {\n    pub fn new() -\u003e Self {\n        Tabs {\n            tabs: vec![],\n            active: 0,\n        }\n    }\n\n    pub fn add_tab(mut self, label: impl Into\u003cString\u003e, content: Element) -\u003e Self {\n        self.tabs.push(Tab {\n            label: label.into(),\n            content,\n        });\n        self\n    }\n\n    pub fn active(mut self, index: usize) -\u003e Self {\n        self.active = index;\n        self\n    }\n}\n\nimpl Component for Tabs {\n    fn render(\u0026self) -\u003e Element {\n        let tab_list_style = style![\n            flex(),\n            gap(2),\n            border(),\n            border_gray_200(),\n            p(1),\n            rounded_lg(),\n        ];\n\n        let mut tab_buttons = vec![];\n        for (i, tab) in self.tabs.iter().enumerate() {\n            let is_active = i == self.active;\n            let tab_style = if is_active {\n                style![px(4), py(2), bg_black(), text_white(), rounded()]\n            } else {\n                style![px(4), py(2), hover_bg_gray_100(), rounded()]\n            };\n\n            tab_buttons.push(Element::Node {\n                tag: \"button\".to_string(),\n                props: Props {\n                    attributes: vec![(\"style\".to_string(), tab_style.build())],\n                    ..Default::default()\n                },\n                children: vec![Element::Text(tab.label.clone())],\n            });\n        }\n\n        let content = if self.active \u003c self.tabs.len() {\n            self.tabs[self.active].content.clone()\n        } else {\n            Element::Text(\"No content\".to_string())\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        attributes: vec![(\"style\".to_string(), tab_list_style.build())],\n                        ..Default::default()\n                    },\n                    children: tab_buttons,\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"tab-content\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![content],\n                },\n            ],\n        }\n    }\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":158},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","upload.rs"],"content":"//! File upload support for Layer9\n\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen::JsCast;\nuse web_sys::{File, FormData, Response, Headers, Request, RequestInit};\nuse wasm_bindgen_futures::JsFuture;\n\n#[derive(Debug, Clone)]\npub struct FileUpload {\n    pub file: File,\n    pub progress: f64,\n    pub status: UploadStatus,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum UploadStatus {\n    Pending,\n    Uploading,\n    Complete,\n    Failed(String),\n}\n\npub struct FileUploadManager {\n    pub(crate) uploads: Vec\u003cFileUpload\u003e,\n    pub(crate) max_file_size: u64,\n    pub(crate) allowed_types: Vec\u003cString\u003e,\n}\n\nimpl Default for FileUploadManager {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl FileUploadManager {\n    pub fn new() -\u003e Self {\n        Self {\n            uploads: Vec::new(),\n            max_file_size: 10 * 1024 * 1024, // 10MB default\n            allowed_types: vec![\n                \"image/jpeg\".to_string(),\n                \"image/png\".to_string(),\n                \"image/gif\".to_string(),\n                \"application/pdf\".to_string(),\n            ],\n        }\n    }\n    \n    pub fn with_max_size(mut self, size: u64) -\u003e Self {\n        self.max_file_size = size;\n        self\n    }\n    \n    pub fn with_allowed_types(mut self, types: Vec\u003cString\u003e) -\u003e Self {\n        self.allowed_types = types;\n        self\n    }\n    \n    pub fn validate_file(\u0026self, file: \u0026File) -\u003e Result\u003c(), String\u003e {\n        // Check file size\n        let size = file.size() as u64;\n        if size \u003e self.max_file_size {\n            return Err(format!(\"File too large. Maximum size: {} bytes\", self.max_file_size));\n        }\n        \n        // Check file type\n        let file_type = file.type_();\n        if !self.allowed_types.contains(\u0026file_type) {\n            return Err(format!(\"File type not allowed: {}\", file_type));\n        }\n        \n        Ok(())\n    }\n    \n    pub async fn upload_file(\u0026mut self, file: File, url: \u0026str) -\u003e Result\u003cString, String\u003e {\n        // Validate file first\n        self.validate_file(\u0026file)?;\n        \n        // Create form data\n        let form_data = FormData::new().map_err(|_| \"Failed to create form data\")?;\n        form_data.append_with_blob(\"file\", \u0026file).map_err(|_| \"Failed to append file\")?;\n        \n        // Add file metadata\n        form_data.append_with_str(\"filename\", \u0026file.name()).map_err(|_| \"Failed to append filename\")?;\n        form_data.append_with_str(\"size\", \u0026file.size().to_string()).map_err(|_| \"Failed to append size\")?;\n        form_data.append_with_str(\"type\", \u0026file.type_()).map_err(|_| \"Failed to append type\")?;\n        \n        // Create upload tracking\n        let mut upload = FileUpload {\n            file: file.clone(),\n            progress: 0.0,\n            status: UploadStatus::Uploading,\n        };\n        \n        // Create request\n        let opts = RequestInit::new();\n        opts.set_method(\"POST\");\n        opts.set_mode(web_sys::RequestMode::Cors);\n        opts.set_body(\u0026form_data.into());\n        \n        // Add auth header if we have a token\n        let headers = Headers::new().map_err(|_| \"Failed to create headers\")?;\n        if let Some(token) = crate::auth::JwtAuthProvider::get_stored_token() {\n            headers.set(\"Authorization\", \u0026format!(\"Bearer {}\", token))\n                .map_err(|_| \"Failed to set auth header\")?;\n        }\n        opts.set_headers(\u0026headers.into());\n        \n        let request = Request::new_with_str_and_init(url, \u0026opts)\n            .map_err(|_| \"Failed to create request\")?;\n        \n        let window = web_sys::window().ok_or(\"No window found\")?;\n        \n        // Perform the upload\n        let promise = window.fetch_with_request(\u0026request);\n        let resp = JsFuture::from(promise).await\n            .map_err(|_| \"Upload request failed\")?;\n        \n        let response: Response = resp.dyn_into()\n            .map_err(|_| \"Failed to get response\")?;\n        \n        if response.ok() {\n            upload.status = UploadStatus::Complete;\n            upload.progress = 100.0;\n            \n            // Get response body for upload ID\n            let body_promise = response.text()\n                .map_err(|_| \"Failed to get response body\")?;\n            let body = JsFuture::from(body_promise).await\n                .map_err(|_| \"Failed to read response body\")?;\n            \n            let upload_id = body.as_string().unwrap_or_else(|| {\n                format!(\"upload-{}\", js_sys::Date::now() as u64)\n            });\n            \n            self.uploads.push(upload);\n            Ok(upload_id)\n        } else {\n            upload.status = UploadStatus::Failed(format!(\"HTTP {}\", response.status()));\n            self.uploads.push(upload);\n            Err(format!(\"Upload failed with status: {}\", response.status()))\n        }\n    }\n    \n    pub fn get_uploads(\u0026self) -\u003e \u0026Vec\u003cFileUpload\u003e {\n        \u0026self.uploads\n    }\n    \n    pub fn get_upload_by_file(\u0026self, file: \u0026File) -\u003e Option\u003c\u0026FileUpload\u003e {\n        self.uploads.iter().find(|u| u.file.name() == file.name())\n    }\n    \n    pub fn clear_completed(\u0026mut self) {\n        self.uploads.retain(|u| u.status != UploadStatus::Complete);\n    }\n    \n    pub fn clear_failed(\u0026mut self) {\n        self.uploads.retain(|u| !matches!(u.status, UploadStatus::Failed(_)));\n    }\n    \n    pub fn retry_failed(\u0026mut self, file: \u0026File) -\u003e Option\u003c\u0026mut FileUpload\u003e {\n        let upload = self.uploads.iter_mut().find(|u| {\n            u.file.name() == file.name() \u0026\u0026 matches!(u.status, UploadStatus::Failed(_))\n        })?;\n        \n        upload.status = UploadStatus::Pending;\n        upload.progress = 0.0;\n        Some(upload)\n    }\n    \n    pub async fn upload_multiple(\u0026mut self, files: Vec\u003cFile\u003e, url: \u0026str) -\u003e Vec\u003cResult\u003cString, String\u003e\u003e {\n        let mut results = Vec::new();\n        \n        for file in files {\n            let result = self.upload_file(file, url).await;\n            results.push(result);\n        }\n        \n        results\n    }\n}\n\n#[wasm_bindgen]\npub struct FileUploadComponent {\n    pub(crate) manager: FileUploadManager,\n    pub(crate) upload_url: String,\n}\n\nimpl Default for FileUploadComponent {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[wasm_bindgen]\nimpl FileUploadComponent {\n    #[wasm_bindgen(constructor)]\n    pub fn new() -\u003e Self {\n        Self {\n            manager: FileUploadManager::new(),\n            upload_url: \"/api/upload\".to_string(),\n        }\n    }\n    \n    pub fn with_url(mut self, url: String) -\u003e Self {\n        self.upload_url = url;\n        self\n    }\n    \n    pub fn with_max_size(mut self, size: u64) -\u003e Self {\n        self.manager = self.manager.with_max_size(size);\n        self\n    }\n    \n    pub fn with_allowed_types(mut self, types: Vec\u003cString\u003e) -\u003e Self {\n        self.manager = self.manager.with_allowed_types(types);\n        self\n    }\n    \n    pub async fn handle_file_select(\u0026mut self, files: web_sys::FileList) -\u003e Result\u003cVec\u003cString\u003e, String\u003e {\n        let mut file_vec = Vec::new();\n        \n        for i in 0..files.length() {\n            if let Some(file) = files.item(i) {\n                file_vec.push(file);\n            }\n        }\n        \n        let results = self.manager.upload_multiple(file_vec, \u0026self.upload_url).await;\n        \n        let mut upload_ids = Vec::new();\n        for result in results {\n            match result {\n                Ok(id) =\u003e upload_ids.push(id),\n                Err(e) =\u003e return Err(e),\n            }\n        }\n        \n        Ok(upload_ids)\n    }\n    \n    pub fn get_upload_status(\u0026self) -\u003e String {\n        let uploads = self.manager.get_uploads();\n        let mut status_html = String::from(\"\u003cdiv class='upload-status'\u003e\");\n        \n        for upload in uploads {\n            let status_class = match \u0026upload.status {\n                UploadStatus::Pending =\u003e \"pending\",\n                UploadStatus::Uploading =\u003e \"uploading\",\n                UploadStatus::Complete =\u003e \"complete\",\n                UploadStatus::Failed(_) =\u003e \"failed\",\n            };\n            \n            let status_text = match \u0026upload.status {\n                UploadStatus::Pending =\u003e \"Pending\",\n                UploadStatus::Uploading =\u003e \u0026format!(\"Uploading... {}%\", upload.progress as u32),\n                UploadStatus::Complete =\u003e \"Complete\",\n                UploadStatus::Failed(e) =\u003e \u0026format!(\"Failed: {}\", e),\n            };\n            \n            status_html.push_str(\u0026format!(\n                r#\"\u003cdiv class='upload-item {}'\u003e\u003cspan class='file-name'\u003e{}\u003c/span\u003e\u003cspan class='status'\u003e{}\u003c/span\u003e\u003c/div\u003e\"#,\n                status_class,\n                upload.file.name(),\n                status_text\n            ));\n        }\n        \n        status_html.push_str(\"\u003c/div\u003e\");\n        status_html\n    }\n    \n    pub fn render(\u0026self) -\u003e String {\n        format!(r#\"\u003cdiv class=\"file-upload-component\"\u003e\n            \u003cdiv class=\"upload-area\"\u003e\n                \u003cinput type=\"file\" id=\"file-input\" multiple class=\"file-input\" /\u003e\n                \u003clabel for=\"file-input\" class=\"upload-label\"\u003e\n                    \u003csvg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"\u003e\n                        \u003cpath d=\"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12\"/\u003e\n                    \u003c/svg\u003e\n                    \u003cspan\u003eClick to select files or drag and drop\u003c/span\u003e\n                    \u003cspan class=\"file-types\"\u003eAllowed: {}\u003c/span\u003e\n                    \u003cspan class=\"max-size\"\u003eMax size: {} MB\u003c/span\u003e\n                \u003c/label\u003e\n            \u003c/div\u003e\n            \u003cdiv id=\"upload-progress\"\u003e{}\u003c/div\u003e\n        \u003c/div\u003e\"#,\n            self.manager.allowed_types.join(\", \"),\n            self.manager.max_file_size / (1024 * 1024),\n            self.get_upload_status()\n        )\n    }\n    \n    pub fn clear_completed(\u0026mut self) {\n        self.manager.clear_completed();\n    }\n    \n    pub fn clear_failed(\u0026mut self) {\n        self.manager.clear_failed();\n    }\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":118},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","upload_tests.rs"],"content":"//! Comprehensive tests for file upload module\n\n#[cfg(test)]\nmod tests {\n    use super::super::upload::*;\n    use wasm_bindgen_test::*;\n    use web_sys::File;\n    use js_sys::{Uint8Array, Array};\n    \n    wasm_bindgen_test_configure!(run_in_browser);\n\n    // Helper function to create a mock file\n    fn create_mock_file(name: \u0026str, content: \u0026str, _mime_type: \u0026str) -\u003e File {\n        let bytes = content.as_bytes();\n        let array = Uint8Array::new_with_length(bytes.len() as u32);\n        array.copy_from(bytes);\n        \n        let file_parts = Array::new();\n        file_parts.push(\u0026array.buffer());\n        \n        // Using simpler File constructor without options\n        File::new_with_blob_sequence(\n            \u0026file_parts.into(),\n            name,\n        ).unwrap()\n    }\n\n    #[wasm_bindgen_test]\n    fn test_upload_status_enum() {\n        let pending = UploadStatus::Pending;\n        let uploading = UploadStatus::Uploading;\n        let complete = UploadStatus::Complete;\n        let failed = UploadStatus::Failed(\"Error\".to_string());\n        \n        assert_eq!(pending, UploadStatus::Pending);\n        assert_eq!(uploading, UploadStatus::Uploading);\n        assert_eq!(complete, UploadStatus::Complete);\n        assert!(matches!(failed, UploadStatus::Failed(_)));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_manager_creation() {\n        let manager = FileUploadManager::new();\n        assert_eq!(manager.max_file_size, 10 * 1024 * 1024); // 10MB\n        assert_eq!(manager.allowed_types.len(), 4);\n        assert!(manager.allowed_types.contains(\u0026\"image/jpeg\".to_string()));\n        assert!(manager.allowed_types.contains(\u0026\"image/png\".to_string()));\n        assert!(manager.allowed_types.contains(\u0026\"image/gif\".to_string()));\n        assert!(manager.allowed_types.contains(\u0026\"application/pdf\".to_string()));\n        assert!(manager.get_uploads().is_empty());\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_manager_configuration() {\n        let manager = FileUploadManager::new()\n            .with_max_size(5 * 1024 * 1024) // 5MB\n            .with_allowed_types(vec![\n                \"image/jpeg\".to_string(),\n                \"text/plain\".to_string(),\n            ]);\n        \n        assert_eq!(manager.max_file_size, 5 * 1024 * 1024);\n        assert_eq!(manager.allowed_types.len(), 2);\n        assert!(manager.allowed_types.contains(\u0026\"image/jpeg\".to_string()));\n        assert!(manager.allowed_types.contains(\u0026\"text/plain\".to_string()));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_validation_size() {\n        let manager = FileUploadManager::new()\n            .with_max_size(1024); // 1KB\n        \n        // Create a small file (should pass)\n        let small_file = create_mock_file(\"small.txt\", \"Hello\", \"text/plain\");\n        let result = manager.validate_file(\u0026small_file);\n        assert!(result.is_ok());\n        \n        // Create a large file (should fail)\n        let large_content = \"x\".repeat(2000); // 2KB\n        let large_file = create_mock_file(\"large.txt\", \u0026large_content, \"text/plain\");\n        let result = manager.validate_file(\u0026large_file);\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"File too large\"));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_validation_type() {\n        let manager = FileUploadManager::new()\n            .with_allowed_types(vec![\"text/plain\".to_string()]);\n        \n        // Create allowed file type\n        let text_file = create_mock_file(\"test.txt\", \"content\", \"text/plain\");\n        let result = manager.validate_file(\u0026text_file);\n        assert!(result.is_ok());\n        \n        // Create disallowed file type\n        let image_file = create_mock_file(\"test.jpg\", \"content\", \"image/jpeg\");\n        let result = manager.validate_file(\u0026image_file);\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"File type not allowed\"));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_get_upload_by_file() {\n        let mut manager = FileUploadManager::new();\n        let file = create_mock_file(\"test.txt\", \"content\", \"text/plain\");\n        \n        // Initially no upload\n        assert!(manager.get_upload_by_file(\u0026file).is_none());\n        \n        // Add an upload\n        manager.uploads.push(FileUpload {\n            file: file.clone(),\n            progress: 50.0,\n            status: UploadStatus::Uploading,\n        });\n        \n        // Should find the upload\n        let upload = manager.get_upload_by_file(\u0026file);\n        assert!(upload.is_some());\n        assert_eq!(upload.unwrap().progress, 50.0);\n    }\n\n    #[wasm_bindgen_test]\n    fn test_clear_completed() {\n        let mut manager = FileUploadManager::new();\n        \n        // Add various uploads\n        manager.uploads.push(FileUpload {\n            file: create_mock_file(\"completed.txt\", \"done\", \"text/plain\"),\n            progress: 100.0,\n            status: UploadStatus::Complete,\n        });\n        \n        manager.uploads.push(FileUpload {\n            file: create_mock_file(\"uploading.txt\", \"in progress\", \"text/plain\"),\n            progress: 50.0,\n            status: UploadStatus::Uploading,\n        });\n        \n        manager.uploads.push(FileUpload {\n            file: create_mock_file(\"pending.txt\", \"waiting\", \"text/plain\"),\n            progress: 0.0,\n            status: UploadStatus::Pending,\n        });\n        \n        assert_eq!(manager.uploads.len(), 3);\n        \n        // Clear completed\n        manager.clear_completed();\n        assert_eq!(manager.uploads.len(), 2);\n        \n        // Verify only non-completed remain\n        for upload in \u0026manager.uploads {\n            assert_ne!(upload.status, UploadStatus::Complete);\n        }\n    }\n\n    #[wasm_bindgen_test]\n    fn test_clear_failed() {\n        let mut manager = FileUploadManager::new();\n        \n        // Add various uploads\n        manager.uploads.push(FileUpload {\n            file: create_mock_file(\"failed.txt\", \"error\", \"text/plain\"),\n            progress: 0.0,\n            status: UploadStatus::Failed(\"Network error\".to_string()),\n        });\n        \n        manager.uploads.push(FileUpload {\n            file: create_mock_file(\"uploading.txt\", \"in progress\", \"text/plain\"),\n            progress: 50.0,\n            status: UploadStatus::Uploading,\n        });\n        \n        assert_eq!(manager.uploads.len(), 2);\n        \n        // Clear failed\n        manager.clear_failed();\n        assert_eq!(manager.uploads.len(), 1);\n        \n        // Verify no failed uploads remain\n        for upload in \u0026manager.uploads {\n            assert!(!matches!(upload.status, UploadStatus::Failed(_)));\n        }\n    }\n\n    #[wasm_bindgen_test]\n    fn test_retry_failed() {\n        let mut manager = FileUploadManager::new();\n        let file = create_mock_file(\"retry.txt\", \"content\", \"text/plain\");\n        \n        // Add a failed upload\n        manager.uploads.push(FileUpload {\n            file: file.clone(),\n            progress: 0.0,\n            status: UploadStatus::Failed(\"Network error\".to_string()),\n        });\n        \n        // Retry the failed upload\n        let upload = manager.retry_failed(\u0026file);\n        assert!(upload.is_some());\n        \n        let upload = upload.unwrap();\n        assert_eq!(upload.status, UploadStatus::Pending);\n        assert_eq!(upload.progress, 0.0);\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_component_creation() {\n        let component = FileUploadComponent::new();\n        assert_eq!(component.upload_url, \"/api/upload\");\n        \n        let component_with_url = FileUploadComponent::new()\n            .with_url(\"/custom/upload\".to_string());\n        assert_eq!(component_with_url.upload_url, \"/custom/upload\");\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_component_configuration() {\n        let component = FileUploadComponent::new()\n            .with_max_size(1024 * 1024) // 1MB\n            .with_allowed_types(vec![\"image/png\".to_string()]);\n        \n        assert_eq!(component.manager.max_file_size, 1024 * 1024);\n        assert_eq!(component.manager.allowed_types.len(), 1);\n        assert!(component.manager.allowed_types.contains(\u0026\"image/png\".to_string()));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_component_status_rendering() {\n        let mut component = FileUploadComponent::new();\n        \n        // Add some uploads with different statuses\n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"pending.txt\", \"waiting\", \"text/plain\"),\n            progress: 0.0,\n            status: UploadStatus::Pending,\n        });\n        \n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"uploading.txt\", \"in progress\", \"text/plain\"),\n            progress: 45.0,\n            status: UploadStatus::Uploading,\n        });\n        \n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"complete.txt\", \"done\", \"text/plain\"),\n            progress: 100.0,\n            status: UploadStatus::Complete,\n        });\n        \n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"failed.txt\", \"error\", \"text/plain\"),\n            progress: 0.0,\n            status: UploadStatus::Failed(\"Server error\".to_string()),\n        });\n        \n        let status_html = component.get_upload_status();\n        \n        // Check that all statuses are represented\n        assert!(status_html.contains(\"pending.txt\"));\n        assert!(status_html.contains(\"Pending\"));\n        assert!(status_html.contains(\"uploading.txt\"));\n        assert!(status_html.contains(\"Uploading... 45%\"));\n        assert!(status_html.contains(\"complete.txt\"));\n        assert!(status_html.contains(\"Complete\"));\n        assert!(status_html.contains(\"failed.txt\"));\n        assert!(status_html.contains(\"Failed: Server error\"));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_component_render() {\n        let component = FileUploadComponent::new()\n            .with_max_size(5 * 1024 * 1024) // 5MB\n            .with_allowed_types(vec![\n                \"image/jpeg\".to_string(),\n                \"image/png\".to_string(),\n                \"application/pdf\".to_string(),\n            ]);\n        \n        let html = component.render();\n        \n        // Check key elements are present\n        assert!(html.contains(\"file-upload-component\"));\n        assert!(html.contains(\"upload-area\"));\n        assert!(html.contains(\"file-input\"));\n        assert!(html.contains(\"upload-label\"));\n        assert!(html.contains(\"Max size: 5 MB\"));\n        assert!(html.contains(\"image/jpeg, image/png, application/pdf\"));\n    }\n\n    #[wasm_bindgen_test]\n    fn test_file_upload_component_clear_methods() {\n        let mut component = FileUploadComponent::new();\n        \n        // Add uploads with different statuses\n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"complete.txt\", \"done\", \"text/plain\"),\n            progress: 100.0,\n            status: UploadStatus::Complete,\n        });\n        \n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"failed.txt\", \"error\", \"text/plain\"),\n            progress: 0.0,\n            status: UploadStatus::Failed(\"Error\".to_string()),\n        });\n        \n        component.manager.uploads.push(FileUpload {\n            file: create_mock_file(\"uploading.txt\", \"progress\", \"text/plain\"),\n            progress: 50.0,\n            status: UploadStatus::Uploading,\n        });\n        \n        assert_eq!(component.manager.uploads.len(), 3);\n        \n        // Clear completed\n        component.clear_completed();\n        assert_eq!(component.manager.uploads.len(), 2);\n        \n        // Clear failed\n        component.clear_failed();\n        assert_eq!(component.manager.uploads.len(), 1);\n        \n        // Only uploading should remain\n        assert_eq!(component.manager.uploads[0].status, UploadStatus::Uploading);\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","vdom.rs"],"content":"//! Virtual DOM - L3\n\nuse crate::component::{Element, Props};\nuse std::collections::HashMap;\nuse wasm_bindgen::JsCast;\nuse web_sys::{Element as DomElement, Node};\n\n/// Virtual DOM diffing and patching\npub struct VDom {\n    root: Option\u003cElement\u003e,\n    dom_root: Option\u003cDomElement\u003e,\n}\n\nimpl Default for VDom {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl VDom {\n    pub fn new() -\u003e Self {\n        VDom {\n            root: None,\n            dom_root: None,\n        }\n    }\n\n    pub fn mount(\u0026mut self, root_id: \u0026str) {\n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        let dom_root = document\n            .get_element_by_id(root_id)\n            .unwrap_or_else(|| panic!(\"Element with id '{}' not found\", root_id));\n\n        self.dom_root = Some(dom_root);\n    }\n\n    pub fn render(\u0026mut self, element: Element) {\n        if let Some(dom_root) = \u0026self.dom_root {\n            if let Some(old_root) = \u0026self.root {\n                // Diff and patch\n                let patches = self.diff(old_root, \u0026element, \u0026[]);\n                self.apply_patches(\u0026patches, dom_root);\n            } else {\n                // Initial render\n                dom_root.set_inner_html(\"\");\n                let dom_node = element.to_dom();\n                dom_root.append_child(\u0026dom_node).unwrap();\n            }\n            self.root = Some(element);\n        }\n    }\n\n    /// Diff two virtual DOM trees and generate patches\n    pub fn diff(\u0026self, old: \u0026Element, new: \u0026Element, path: \u0026[usize]) -\u003e Vec\u003cPatch\u003e {\n        let mut patches = vec![];\n\n        match (old, new) {\n            // Text nodes\n            (Element::Text(old_text), Element::Text(new_text)) =\u003e {\n                if old_text != new_text {\n                    patches.push(Patch::UpdateText {\n                        path: path.to_vec(),\n                        text: new_text.clone(),\n                    });\n                }\n            }\n            \n            // Different node types - replace entire node\n            (Element::Text(_), Element::Node { .. }) \n            | (Element::Node { .. }, Element::Text(_))\n            | (Element::Component(_), Element::Text(_))\n            | (Element::Component(_), Element::Node { .. })\n            | (Element::Text(_), Element::Component(_))\n            | (Element::Node { .. }, Element::Component(_)) =\u003e {\n                patches.push(Patch::Replace {\n                    path: path.to_vec(),\n                    element: new.clone(),\n                });\n            }\n            \n            // Element nodes with same tag\n            (\n                Element::Node { tag: old_tag, props: old_props, children: old_children },\n                Element::Node { tag: new_tag, props: new_props, children: new_children }\n            ) =\u003e {\n                if old_tag != new_tag {\n                    // Different tags - replace entire element\n                    patches.push(Patch::Replace {\n                        path: path.to_vec(),\n                        element: new.clone(),\n                    });\n                } else {\n                    // Same tag - diff props and children\n                    patches.extend(self.diff_props(old_props, new_props, path));\n                    patches.extend(self.diff_children(old_children, new_children, path));\n                }\n            }\n            \n            // Components - always re-render for now\n            (Element::Component(_), Element::Component(_)) =\u003e {\n                patches.push(Patch::Replace {\n                    path: path.to_vec(),\n                    element: new.clone(),\n                });\n            }\n        }\n\n        patches\n    }\n\n    /// Diff properties between two elements\n    fn diff_props(\u0026self, old_props: \u0026Props, new_props: \u0026Props, path: \u0026[usize]) -\u003e Vec\u003cPatch\u003e {\n        let mut patches = vec![];\n\n        // Check class changes\n        match (\u0026old_props.class, \u0026new_props.class) {\n            (Some(old), Some(new)) if old != new =\u003e {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: \"class\".to_string(),\n                    value: new.clone(),\n                });\n            }\n            (None, Some(new)) =\u003e {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: \"class\".to_string(),\n                    value: new.clone(),\n                });\n            }\n            (Some(_), None) =\u003e {\n                patches.push(Patch::RemoveAttribute {\n                    path: path.to_vec(),\n                    name: \"class\".to_string(),\n                });\n            }\n            _ =\u003e {}\n        }\n\n        // Check id changes\n        match (\u0026old_props.id, \u0026new_props.id) {\n            (Some(old), Some(new)) if old != new =\u003e {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: \"id\".to_string(),\n                    value: new.clone(),\n                });\n            }\n            (None, Some(new)) =\u003e {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: \"id\".to_string(),\n                    value: new.clone(),\n                });\n            }\n            (Some(_), None) =\u003e {\n                patches.push(Patch::RemoveAttribute {\n                    path: path.to_vec(),\n                    name: \"id\".to_string(),\n                });\n            }\n            _ =\u003e {}\n        }\n\n        // Diff attributes\n        let old_attrs: HashMap\u003c_, _\u003e = old_props.attributes.iter().cloned().collect();\n        let new_attrs: HashMap\u003c_, _\u003e = new_props.attributes.iter().cloned().collect();\n\n        // Check for added or changed attributes\n        for (key, value) in \u0026new_attrs {\n            if old_attrs.get(key) != Some(value) {\n                patches.push(Patch::SetAttribute {\n                    path: path.to_vec(),\n                    name: key.clone(),\n                    value: value.clone(),\n                });\n            }\n        }\n\n        // Check for removed attributes\n        for key in old_attrs.keys() {\n            if !new_attrs.contains_key(key) {\n                patches.push(Patch::RemoveAttribute {\n                    path: path.to_vec(),\n                    name: key.clone(),\n                });\n            }\n        }\n\n        patches\n    }\n\n    /// Diff children using a simple algorithm\n    fn diff_children(\u0026self, old_children: \u0026[Element], new_children: \u0026[Element], path: \u0026[usize]) -\u003e Vec\u003cPatch\u003e {\n        let mut patches = vec![];\n        let old_len = old_children.len();\n        let new_len = new_children.len();\n        let min_len = old_len.min(new_len);\n\n        // Diff common children\n        for i in 0..min_len {\n            let mut child_path = path.to_vec();\n            child_path.push(i);\n            patches.extend(self.diff(\u0026old_children[i], \u0026new_children[i], \u0026child_path));\n        }\n\n        // Handle added children\n        for (i, child) in new_children.iter().enumerate().skip(min_len) {\n            patches.push(Patch::InsertChild {\n                path: path.to_vec(),\n                index: i,\n                element: child.clone(),\n            });\n        }\n\n        // Handle removed children\n        for i in (min_len..old_len).rev() {\n            patches.push(Patch::RemoveChild {\n                path: path.to_vec(),\n                index: i,\n            });\n        }\n\n        patches\n    }\n\n    /// Apply patches to the DOM\n    pub fn apply_patches(\u0026self, patches: \u0026[Patch], root: \u0026DomElement) {\n        for patch in patches {\n            match patch {\n                Patch::Replace { path, element } =\u003e {\n                    if let Some(target) = self.find_node(root, path) {\n                        let new_node = element.to_dom();\n                        if let Some(parent) = target.parent_node() {\n                            parent.replace_child(\u0026new_node, \u0026target).unwrap();\n                        }\n                    }\n                }\n                \n                Patch::UpdateText { path, text } =\u003e {\n                    if let Some(target) = self.find_node(root, path) {\n                        target.set_text_content(Some(text));\n                    }\n                }\n                \n                Patch::SetAttribute { path, name, value } =\u003e {\n                    if let Some(target) = self.find_node(root, path) {\n                        if let Some(element) = target.dyn_ref::\u003cDomElement\u003e() {\n                            element.set_attribute(name, value).unwrap();\n                        }\n                    }\n                }\n                \n                Patch::RemoveAttribute { path, name } =\u003e {\n                    if let Some(target) = self.find_node(root, path) {\n                        if let Some(element) = target.dyn_ref::\u003cDomElement\u003e() {\n                            element.remove_attribute(name).unwrap();\n                        }\n                    }\n                }\n                \n                Patch::InsertChild { path, index, element } =\u003e {\n                    if let Some(parent) = self.find_node(root, path) {\n                        let new_child = element.to_dom();\n                        let children = parent.child_nodes();\n                        \n                        if *index \u003c children.length() as usize {\n                            let before = children.item(*index as u32).unwrap();\n                            parent.insert_before(\u0026new_child, Some(\u0026before)).unwrap();\n                        } else {\n                            parent.append_child(\u0026new_child).unwrap();\n                        }\n                    }\n                }\n                \n                Patch::RemoveChild { path, index } =\u003e {\n                    if let Some(parent) = self.find_node(root, path) {\n                        let children = parent.child_nodes();\n                        if let Some(child) = children.item(*index as u32) {\n                            parent.remove_child(\u0026child).unwrap();\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /// Find a node in the DOM tree by path\n    fn find_node(\u0026self, root: \u0026DomElement, path: \u0026[usize]) -\u003e Option\u003cNode\u003e {\n        let mut current: Node = root.clone().into();\n        \n        for \u0026index in path {\n            let children = current.child_nodes();\n            if let Some(child) = children.item(index as u32) {\n                current = child;\n            } else {\n                return None;\n            }\n        }\n        \n        Some(current)\n    }\n}\n\n/// Patch operations for efficient updates\npub enum Patch {\n    Replace {\n        path: Vec\u003cusize\u003e,\n        element: Element,\n    },\n    UpdateText {\n        path: Vec\u003cusize\u003e,\n        text: String,\n    },\n    SetAttribute {\n        path: Vec\u003cusize\u003e,\n        name: String,\n        value: String,\n    },\n    RemoveAttribute {\n        path: Vec\u003cusize\u003e,\n        name: String,\n    },\n    InsertChild {\n        path: Vec\u003cusize\u003e,\n        index: usize,\n        element: Element,\n    },\n    RemoveChild {\n        path: Vec\u003cusize\u003e,\n        index: usize,\n    },\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::component::{Element, Props};\n    \n    #[test]\n    fn test_diff_text_nodes() {\n        let vdom = VDom::new();\n        \n        // Test identical text nodes\n        let old = Element::Text(\"Hello\".to_string());\n        let new = Element::Text(\"Hello\".to_string());\n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        assert!(patches.is_empty());\n        \n        // Test different text nodes\n        let old = Element::Text(\"Hello\".to_string());\n        let new = Element::Text(\"World\".to_string());\n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        assert_eq!(patches.len(), 1);\n        match \u0026patches[0] {\n            Patch::UpdateText { text, .. } =\u003e assert_eq!(text, \"World\"),\n            _ =\u003e panic!(\"Expected UpdateText patch\"),\n        }\n    }\n    \n    #[test]\n    fn test_diff_different_node_types() {\n        let vdom = VDom::new();\n        \n        // Text to Element\n        let old = Element::Text(\"Hello\".to_string());\n        let new = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![],\n        };\n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        assert_eq!(patches.len(), 1);\n        assert!(matches!(\u0026patches[0], Patch::Replace { .. }));\n    }\n    \n    #[test]\n    fn test_diff_element_props() {\n        let vdom = VDom::new();\n        \n        // Test class change\n        let old = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"old\".to_string()),\n                ..Default::default()\n            },\n            children: vec![],\n        };\n        let new = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"new\".to_string()),\n                ..Default::default()\n            },\n            children: vec![],\n        };\n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        assert_eq!(patches.len(), 1);\n        match \u0026patches[0] {\n            Patch::SetAttribute { name, value, .. } =\u003e {\n                assert_eq!(name, \"class\");\n                assert_eq!(value, \"new\");\n            }\n            _ =\u003e panic!(\"Expected SetAttribute patch\"),\n        }\n    }\n    \n    #[test]\n    fn test_diff_children() {\n        let vdom = VDom::new();\n        \n        // Test adding children\n        let old = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![\n                Element::Text(\"Child 1\".to_string()),\n            ],\n        };\n        let new = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![\n                Element::Text(\"Child 1\".to_string()),\n                Element::Text(\"Child 2\".to_string()),\n            ],\n        };\n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        assert_eq!(patches.len(), 1);\n        assert!(matches!(\u0026patches[0], Patch::InsertChild { index: 1, .. }));\n        \n        // Test removing children\n        let old = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![\n                Element::Text(\"Child 1\".to_string()),\n                Element::Text(\"Child 2\".to_string()),\n            ],\n        };\n        let new = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props::default(),\n            children: vec![\n                Element::Text(\"Child 1\".to_string()),\n            ],\n        };\n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        assert_eq!(patches.len(), 1);\n        assert!(matches!(\u0026patches[0], Patch::RemoveChild { index: 1, .. }));\n    }\n    \n    #[test]\n    fn test_diff_complex_tree() {\n        let vdom = VDom::new();\n        \n        let old = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"container\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Title\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props {\n                        id: Some(\"para1\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"Paragraph 1\".to_string())],\n                },\n            ],\n        };\n        \n        let new = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"container updated\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"New Title\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props {\n                        id: Some(\"para1\".to_string()),\n                        attributes: vec![(\"data-test\".to_string(), \"value\".to_string())],\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"Paragraph 1\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Paragraph 2\".to_string())],\n                },\n            ],\n        };\n        \n        let patches = vdom.diff(\u0026old, \u0026new, \u0026[]);\n        \n        // Should have patches for:\n        // 1. Class attribute change on root\n        // 2. Text update in h1\n        // 3. New attribute on first p\n        // 4. New p element\n        assert!(patches.len() \u003e= 4);\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":5}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":13}},{"line":56,"address":[],"length":0,"stats":{"Line":13}},{"line":58,"address":[],"length":0,"stats":{"Line":13}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":61,"address":[],"length":0,"stats":{"Line":8}},{"line":62,"address":[],"length":0,"stats":{"Line":2}},{"line":63,"address":[],"length":0,"stats":{"Line":2}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":6}},{"line":86,"address":[],"length":0,"stats":{"Line":6}},{"line":87,"address":[],"length":0,"stats":{"Line":6}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":6}},{"line":96,"address":[],"length":0,"stats":{"Line":6}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":13}},{"line":113,"address":[],"length":0,"stats":{"Line":6}},{"line":114,"address":[],"length":0,"stats":{"Line":6}},{"line":117,"address":[],"length":0,"stats":{"Line":6}},{"line":118,"address":[],"length":0,"stats":{"Line":4}},{"line":119,"address":[],"length":0,"stats":{"Line":2}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":121,"address":[],"length":0,"stats":{"Line":2}},{"line":122,"address":[],"length":0,"stats":{"Line":2}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":4}},{"line":142,"address":[],"length":0,"stats":{"Line":6}},{"line":143,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":6}},{"line":167,"address":[],"length":0,"stats":{"Line":6}},{"line":168,"address":[],"length":0,"stats":{"Line":6}},{"line":171,"address":[],"length":0,"stats":{"Line":8}},{"line":172,"address":[],"length":0,"stats":{"Line":1}},{"line":173,"address":[],"length":0,"stats":{"Line":1}},{"line":174,"address":[],"length":0,"stats":{"Line":1}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":176,"address":[],"length":0,"stats":{"Line":1}},{"line":182,"address":[],"length":0,"stats":{"Line":6}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":6}},{"line":196,"address":[],"length":0,"stats":{"Line":6}},{"line":197,"address":[],"length":0,"stats":{"Line":6}},{"line":198,"address":[],"length":0,"stats":{"Line":6}},{"line":199,"address":[],"length":0,"stats":{"Line":6}},{"line":202,"address":[],"length":0,"stats":{"Line":12}},{"line":209,"address":[],"length":0,"stats":{"Line":8}},{"line":218,"address":[],"length":0,"stats":{"Line":7}},{"line":225,"address":[],"length":0,"stats":{"Line":6}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}}],"covered":51,"coverable":128},{"path":["/","Users","icedac","2lab.ai","layer9","crates","core","src","websocket.rs"],"content":"//! WebSocket Support - L4\n\nuse serde::{Deserialize, Serialize};\nuse std::cell::RefCell;\nuse std::rc::Rc;\nuse wasm_bindgen::closure::Closure;\nuse wasm_bindgen::prelude::*;\nuse web_sys::{CloseEvent, ErrorEvent, MessageEvent, WebSocket};\n\n/// WebSocket connection state\n#[derive(Clone, PartialEq)]\npub enum WsState {\n    Connecting,\n    Connected,\n    Disconnected,\n    Error(String),\n}\n\n/// WebSocket message\n#[derive(Clone)]\npub enum WsMessage {\n    Text(String),\n    Binary(Vec\u003cu8\u003e),\n}\n\n/// WebSocket connection\npub struct WsConnection {\n    ws: Rc\u003cRefCell\u003cOption\u003cWebSocket\u003e\u003e\u003e,\n    state: Rc\u003cRefCell\u003cWsState\u003e\u003e,\n    config: WsConfig,\n    handlers: Rc\u003cRefCell\u003cWsHandlers\u003e\u003e,\n    reconnect_timer: Rc\u003cRefCell\u003cOption\u003ci32\u003e\u003e\u003e,\n    reconnect_attempts: Rc\u003cRefCell\u003cu32\u003e\u003e,\n}\n\npub struct WsConfig {\n    pub url: String,\n    pub protocols: Vec\u003cString\u003e,\n    pub reconnect: bool,\n    pub reconnect_interval: u32,\n    pub max_reconnect_attempts: u32,\n    pub ping_interval: Option\u003cu32\u003e,\n}\n\nstruct WsHandlers {\n    on_open: Option\u003cBox\u003cdyn Fn()\u003e\u003e,\n    on_message: Option\u003cBox\u003cdyn Fn(WsMessage)\u003e\u003e,\n    on_error: Option\u003cBox\u003cdyn Fn(String)\u003e\u003e,\n    on_close: Option\u003cBox\u003cdyn Fn(u16, String)\u003e\u003e,\n}\n\nimpl WsConnection {\n    pub fn new(config: WsConfig) -\u003e Result\u003cSelf, JsValue\u003e {\n        let state = Rc::new(RefCell::new(WsState::Connecting));\n        let handlers = Rc::new(RefCell::new(WsHandlers {\n            on_open: None,\n            on_message: None,\n            on_error: None,\n            on_close: None,\n        }));\n\n        let mut conn = WsConnection {\n            ws: Rc::new(RefCell::new(None)),\n            state: state.clone(),\n            config,\n            handlers: handlers.clone(),\n            reconnect_timer: Rc::new(RefCell::new(None)),\n            reconnect_attempts: Rc::new(RefCell::new(0)),\n        };\n\n        conn.connect()?;\n        Ok(conn)\n    }\n\n    fn connect(\u0026mut self) -\u003e Result\u003c(), JsValue\u003e {\n        // Create WebSocket\n        let ws = if self.config.protocols.is_empty() {\n            WebSocket::new(\u0026self.config.url)?\n        } else {\n            let protocols = js_sys::Array::new();\n            for protocol in \u0026self.config.protocols {\n                protocols.push(\u0026JsValue::from_str(protocol));\n            }\n            WebSocket::new_with_str_sequence(\u0026self.config.url, \u0026protocols)?\n        };\n\n        // Set binary type\n        ws.set_binary_type(web_sys::BinaryType::Arraybuffer);\n\n        // Set up event handlers\n        self.setup_handlers(\u0026ws)?;\n\n        *self.ws.borrow_mut() = Some(ws);\n        Ok(())\n    }\n\n    fn setup_handlers(\u0026self, ws: \u0026WebSocket) -\u003e Result\u003c(), JsValue\u003e {\n        let state = self.state.clone();\n        let handlers = self.handlers.clone();\n        let config = self.config.clone();\n        let reconnect_timer = self.reconnect_timer.clone();\n        let reconnect_attempts = self.reconnect_attempts.clone();\n        let ws_ref = self.ws.clone();\n\n        // On open\n        let on_open = {\n            let state = state.clone();\n            let handlers = handlers.clone();\n            let reconnect_attempts_clone = reconnect_attempts.clone();\n\n            Closure::\u003cdyn FnMut()\u003e::new(move || {\n                *state.borrow_mut() = WsState::Connected;\n                // Reset reconnection attempts on successful connection\n                *reconnect_attempts_clone.borrow_mut() = 0;\n\n                if let Some(handler) = \u0026handlers.borrow().on_open {\n                    handler();\n                }\n\n                // Start ping interval if configured\n                // TODO: Implement ping/pong\n            })\n        };\n        ws.set_onopen(Some(on_open.as_ref().unchecked_ref()));\n        on_open.forget();\n\n        // On message\n        let on_message = {\n            let handlers = handlers.clone();\n\n            Closure::\u003cdyn FnMut(_)\u003e::new(move |e: MessageEvent| {\n                if let Some(handler) = \u0026handlers.borrow().on_message {\n                    if let Ok(text) = e.data().dyn_into::\u003cjs_sys::JsString\u003e() {\n                        handler(WsMessage::Text(text.into()));\n                    } else if let Ok(array_buffer) = e.data().dyn_into::\u003cjs_sys::ArrayBuffer\u003e() {\n                        let array = js_sys::Uint8Array::new(\u0026array_buffer);\n                        let vec = array.to_vec();\n                        handler(WsMessage::Binary(vec));\n                    }\n                }\n            })\n        };\n        ws.set_onmessage(Some(on_message.as_ref().unchecked_ref()));\n        on_message.forget();\n\n        // On error\n        let on_error = {\n            let state = state.clone();\n            let handlers = handlers.clone();\n\n            Closure::\u003cdyn FnMut(_)\u003e::new(move |e: ErrorEvent| {\n                let error_msg = format!(\"WebSocket error: {}\", e.message());\n                *state.borrow_mut() = WsState::Error(error_msg.clone());\n\n                if let Some(handler) = \u0026handlers.borrow().on_error {\n                    handler(error_msg);\n                }\n            })\n        };\n        ws.set_onerror(Some(on_error.as_ref().unchecked_ref()));\n        on_error.forget();\n\n        // On close\n        let on_close = {\n            let state = state.clone();\n            let handlers = handlers.clone();\n\n            Closure::\u003cdyn FnMut(_)\u003e::new(move |e: CloseEvent| {\n                *state.borrow_mut() = WsState::Disconnected;\n\n                if let Some(handler) = \u0026handlers.borrow().on_close {\n                    handler(e.code(), e.reason());\n                }\n\n                // Handle reconnection\n                if config.reconnect \u0026\u0026 e.code() != 1000 {\n                    Self::schedule_reconnection(\n                        ws_ref.clone(),\n                        state.clone(),\n                        handlers.clone(),\n                        config.clone(),\n                        reconnect_timer.clone(),\n                        reconnect_attempts.clone(),\n                    );\n                }\n            })\n        };\n        ws.set_onclose(Some(on_close.as_ref().unchecked_ref()));\n        on_close.forget();\n\n        Ok(())\n    }\n\n    fn schedule_reconnection(\n        ws_ref: Rc\u003cRefCell\u003cOption\u003cWebSocket\u003e\u003e\u003e,\n        state: Rc\u003cRefCell\u003cWsState\u003e\u003e,\n        handlers: Rc\u003cRefCell\u003cWsHandlers\u003e\u003e,\n        config: WsConfig,\n        reconnect_timer: Rc\u003cRefCell\u003cOption\u003ci32\u003e\u003e\u003e,\n        reconnect_attempts: Rc\u003cRefCell\u003cu32\u003e\u003e,\n    ) {\n        let window = match web_sys::window() {\n            Some(w) =\u003e w,\n            None =\u003e return,\n        };\n\n        // Clear any existing reconnection timer\n        if let Some(timer_id) = reconnect_timer.borrow_mut().take() {\n            window.clear_timeout_with_handle(timer_id);\n        }\n\n        let current_attempts = *reconnect_attempts.borrow();\n        if current_attempts \u003e= config.max_reconnect_attempts {\n            // Max attempts reached, stop trying\n            return;\n        }\n\n        // Calculate delay with exponential backoff\n        let base_delay = config.reconnect_interval;\n        let delay = base_delay * 2u32.pow(current_attempts.min(10)); // Cap exponential growth at 2^10\n\n        let reconnect_timer_clone = reconnect_timer.clone();\n        let closure = Closure::\u003cdyn FnMut()\u003e::new(move || {\n            // Increment attempts\n            *reconnect_attempts.borrow_mut() += 1;\n\n            // Update state to connecting\n            *state.borrow_mut() = WsState::Connecting;\n\n            // Create new WebSocket\n            let new_ws = if config.protocols.is_empty() {\n                match WebSocket::new(\u0026config.url) {\n                    Ok(ws) =\u003e ws,\n                    Err(_) =\u003e {\n                        *state.borrow_mut() = WsState::Error(\"Failed to create WebSocket\".to_string());\n                        // Schedule another retry\n                        Self::schedule_reconnection(\n                            ws_ref.clone(),\n                            state.clone(),\n                            handlers.clone(),\n                            config.clone(),\n                            reconnect_timer_clone.clone(),\n                            reconnect_attempts.clone(),\n                        );\n                        return;\n                    }\n                }\n            } else {\n                let protocols = js_sys::Array::new();\n                for protocol in \u0026config.protocols {\n                    protocols.push(\u0026JsValue::from_str(protocol));\n                }\n                match WebSocket::new_with_str_sequence(\u0026config.url, \u0026protocols) {\n                    Ok(ws) =\u003e ws,\n                    Err(_) =\u003e {\n                        *state.borrow_mut() = WsState::Error(\"Failed to create WebSocket\".to_string());\n                        // Schedule another retry\n                        Self::schedule_reconnection(\n                            ws_ref.clone(),\n                            state.clone(),\n                            handlers.clone(),\n                            config.clone(),\n                            reconnect_timer_clone.clone(),\n                            reconnect_attempts.clone(),\n                        );\n                        return;\n                    }\n                }\n            };\n\n            // Set binary type\n            new_ws.set_binary_type(web_sys::BinaryType::Arraybuffer);\n\n            // Setup handlers for the new WebSocket\n            Self::setup_handlers_for_reconnection(\n                \u0026new_ws,\n                ws_ref.clone(),\n                state.clone(),\n                handlers.clone(),\n                config.clone(),\n                reconnect_timer_clone.clone(),\n                reconnect_attempts.clone(),\n            );\n\n            // Store the new WebSocket\n            *ws_ref.borrow_mut() = Some(new_ws);\n        });\n\n        match window.set_timeout_with_callback_and_timeout_and_arguments_0(\n            closure.as_ref().unchecked_ref(),\n            delay as i32,\n        ) {\n            Ok(handle) =\u003e {\n                *reconnect_timer.borrow_mut() = Some(handle);\n            }\n            Err(_) =\u003e {\n                // Failed to set timer\n            }\n        }\n\n        closure.forget();\n    }\n\n    fn setup_handlers_for_reconnection(\n        ws: \u0026WebSocket,\n        ws_ref: Rc\u003cRefCell\u003cOption\u003cWebSocket\u003e\u003e\u003e,\n        state: Rc\u003cRefCell\u003cWsState\u003e\u003e,\n        handlers: Rc\u003cRefCell\u003cWsHandlers\u003e\u003e,\n        config: WsConfig,\n        reconnect_timer: Rc\u003cRefCell\u003cOption\u003ci32\u003e\u003e\u003e,\n        reconnect_attempts: Rc\u003cRefCell\u003cu32\u003e\u003e,\n    ) {\n        // On open\n        let on_open = {\n            let state = state.clone();\n            let handlers = handlers.clone();\n            let reconnect_attempts_clone = reconnect_attempts.clone();\n\n            Closure::\u003cdyn FnMut()\u003e::new(move || {\n                *state.borrow_mut() = WsState::Connected;\n                // Reset reconnection attempts on successful connection\n                *reconnect_attempts_clone.borrow_mut() = 0;\n\n                if let Some(handler) = \u0026handlers.borrow().on_open {\n                    handler();\n                }\n            })\n        };\n        ws.set_onopen(Some(on_open.as_ref().unchecked_ref()));\n        on_open.forget();\n\n        // On message\n        let on_message = {\n            let handlers = handlers.clone();\n\n            Closure::\u003cdyn FnMut(_)\u003e::new(move |e: MessageEvent| {\n                if let Some(handler) = \u0026handlers.borrow().on_message {\n                    if let Ok(text) = e.data().dyn_into::\u003cjs_sys::JsString\u003e() {\n                        handler(WsMessage::Text(text.into()));\n                    } else if let Ok(array_buffer) = e.data().dyn_into::\u003cjs_sys::ArrayBuffer\u003e() {\n                        let array = js_sys::Uint8Array::new(\u0026array_buffer);\n                        let vec = array.to_vec();\n                        handler(WsMessage::Binary(vec));\n                    }\n                }\n            })\n        };\n        ws.set_onmessage(Some(on_message.as_ref().unchecked_ref()));\n        on_message.forget();\n\n        // On error\n        let on_error = {\n            let state = state.clone();\n            let handlers = handlers.clone();\n\n            Closure::\u003cdyn FnMut(_)\u003e::new(move |e: ErrorEvent| {\n                let error_msg = format!(\"WebSocket error: {}\", e.message());\n                *state.borrow_mut() = WsState::Error(error_msg.clone());\n\n                if let Some(handler) = \u0026handlers.borrow().on_error {\n                    handler(error_msg);\n                }\n            })\n        };\n        ws.set_onerror(Some(on_error.as_ref().unchecked_ref()));\n        on_error.forget();\n\n        // On close\n        let on_close = {\n            let state = state.clone();\n            let handlers = handlers.clone();\n            let ws_ref = ws_ref.clone();\n            let config = config.clone();\n            let reconnect_timer = reconnect_timer.clone();\n            let reconnect_attempts = reconnect_attempts.clone();\n\n            Closure::\u003cdyn FnMut(_)\u003e::new(move |e: CloseEvent| {\n                *state.borrow_mut() = WsState::Disconnected;\n\n                if let Some(handler) = \u0026handlers.borrow().on_close {\n                    handler(e.code(), e.reason());\n                }\n\n                // Handle reconnection\n                if config.reconnect \u0026\u0026 e.code() != 1000 {\n                    Self::schedule_reconnection(\n                        ws_ref.clone(),\n                        state.clone(),\n                        handlers.clone(),\n                        config.clone(),\n                        reconnect_timer.clone(),\n                        reconnect_attempts.clone(),\n                    );\n                }\n            })\n        };\n        ws.set_onclose(Some(on_close.as_ref().unchecked_ref()));\n        on_close.forget();\n    }\n\n    pub fn send(\u0026self, message: WsMessage) -\u003e Result\u003c(), JsValue\u003e {\n        if let Some(ws) = \u0026*self.ws.borrow() {\n            match message {\n                WsMessage::Text(text) =\u003e ws.send_with_str(\u0026text),\n                WsMessage::Binary(data) =\u003e {\n                    let array = js_sys::Uint8Array::from(\u0026data[..]);\n                    ws.send_with_array_buffer(\u0026array.buffer())\n                }\n            }\n        } else {\n            Err(JsValue::from_str(\"WebSocket not connected\"))\n        }\n    }\n\n    pub fn send_json\u003cT: Serialize\u003e(\u0026self, data: \u0026T) -\u003e Result\u003c(), JsValue\u003e {\n        let json = serde_json::to_string(data).map_err(|e| JsValue::from_str(\u0026e.to_string()))?;\n        self.send(WsMessage::Text(json))\n    }\n\n    pub fn close(\u0026self) -\u003e Result\u003c(), JsValue\u003e {\n        // Clear any pending reconnection timer\n        if let Some(timer_id) = self.reconnect_timer.borrow_mut().take() {\n            if let Some(window) = web_sys::window() {\n                window.clear_timeout_with_handle(timer_id);\n            }\n        }\n        \n        // Close the WebSocket connection\n        if let Some(ws) = \u0026*self.ws.borrow() {\n            ws.close()?;\n        }\n        Ok(())\n    }\n\n    pub fn state(\u0026self) -\u003e WsState {\n        self.state.borrow().clone()\n    }\n\n    pub fn on_open(self, handler: impl Fn() + 'static) -\u003e Self {\n        self.handlers.borrow_mut().on_open = Some(Box::new(handler));\n        self\n    }\n\n    pub fn on_message(self, handler: impl Fn(WsMessage) + 'static) -\u003e Self {\n        self.handlers.borrow_mut().on_message = Some(Box::new(handler));\n        self\n    }\n\n    pub fn on_error(self, handler: impl Fn(String) + 'static) -\u003e Self {\n        self.handlers.borrow_mut().on_error = Some(Box::new(handler));\n        self\n    }\n\n    pub fn on_close(self, handler: impl Fn(u16, String) + 'static) -\u003e Self {\n        self.handlers.borrow_mut().on_close = Some(Box::new(handler));\n        self\n    }\n}\n\n/// WebSocket hook\npub fn use_websocket(url: impl Into\u003cString\u003e) -\u003e Result\u003cWsHandle, JsValue\u003e {\n    let config = WsConfig {\n        url: url.into(),\n        protocols: vec![],\n        reconnect: true,\n        reconnect_interval: 3000,\n        max_reconnect_attempts: 5,\n        ping_interval: Some(30000),\n    };\n\n    let conn = WsConnection::new(config)?;\n\n    Ok(WsHandle {\n        conn: Rc::new(conn),\n    })\n}\n\n/// WebSocket handle for components\npub struct WsHandle {\n    conn: Rc\u003cWsConnection\u003e,\n}\n\nimpl WsHandle {\n    pub fn send(\u0026self, message: WsMessage) -\u003e Result\u003c(), JsValue\u003e {\n        self.conn.send(message)\n    }\n\n    pub fn send_json\u003cT: Serialize\u003e(\u0026self, data: \u0026T) -\u003e Result\u003c(), JsValue\u003e {\n        self.conn.send_json(data)\n    }\n\n    pub fn state(\u0026self) -\u003e WsState {\n        self.conn.state()\n    }\n\n    pub fn close(\u0026self) -\u003e Result\u003c(), JsValue\u003e {\n        self.conn.close()\n    }\n}\n\n/// Real-time data subscription\npub struct RealtimeSubscription\u003cT\u003e {\n    topic: String,\n    data: Rc\u003cRefCell\u003cOption\u003cT\u003e\u003e\u003e,\n    ws: WsHandle,\n}\n\nimpl\u003cT: for\u003c'de\u003e Deserialize\u003c'de\u003e + Clone + 'static\u003e RealtimeSubscription\u003cT\u003e {\n    pub fn new(topic: impl Into\u003cString\u003e, ws: WsHandle) -\u003e Self {\n        let topic = topic.into();\n        let data = Rc::new(RefCell::new(None));\n\n        // Subscribe to topic\n        let subscribe_msg = serde_json::json!({\n            \"type\": \"subscribe\",\n            \"topic\": \u0026topic,\n        });\n\n        let _ = ws.send_json(\u0026subscribe_msg);\n\n        RealtimeSubscription { topic, data, ws }\n    }\n\n    pub fn data(\u0026self) -\u003e Option\u003cT\u003e {\n        self.data.borrow().clone()\n    }\n\n    pub fn update(\u0026self, new_data: T) {\n        *self.data.borrow_mut() = Some(new_data);\n        // Trigger re-render\n    }\n}\n\nimpl\u003cT\u003e Drop for RealtimeSubscription\u003cT\u003e {\n    fn drop(\u0026mut self) {\n        // Unsubscribe from topic\n        let unsubscribe_msg = serde_json::json!({\n            \"type\": \"unsubscribe\",\n            \"topic\": \u0026self.topic,\n        });\n\n        let _ = self.ws.send_json(\u0026unsubscribe_msg);\n    }\n}\n\n/// Hook for real-time data\npub fn use_realtime\u003cT: for\u003c'de\u003e Deserialize\u003c'de\u003e + Clone + 'static\u003e(\n    topic: impl Into\u003cString\u003e,\n    ws: \u0026WsHandle,\n) -\u003e Option\u003cT\u003e {\n    let subscription = RealtimeSubscription::new(topic, ws.clone());\n    subscription.data()\n}\n\n// Implement Clone for WsHandle\nimpl Clone for WsHandle {\n    fn clone(\u0026self) -\u003e Self {\n        WsHandle {\n            conn: self.conn.clone(),\n        }\n    }\n}\n\nimpl Clone for WsConfig {\n    fn clone(\u0026self) -\u003e Self {\n        WsConfig {\n            url: self.url.clone(),\n            protocols: self.protocols.clone(),\n            reconnect: self.reconnect,\n            reconnect_interval: self.reconnect_interval,\n            max_reconnect_attempts: self.max_reconnect_attempts,\n            ping_interval: self.ping_interval,\n        }\n    }\n}\n","traces":[{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":236},{"path":["/","Users","icedac","2lab.ai","layer9","crates","layer9-server","src","main.rs"],"content":"use axum::{\n    extract::ws::{WebSocket, WebSocketUpgrade},\n    response::Response,\n    routing::get,\n    Router,\n};\nuse clap::Parser;\nuse notify::{Config, Event, RecommendedWatcher, RecursiveMode, Watcher};\nuse std::net::SocketAddr;\nuse std::path::PathBuf;\nuse tokio::sync::broadcast;\nuse tower::ServiceBuilder;\nuse tower_http::{\n    cors::CorsLayer,\n    services::ServeDir,\n    trace::TraceLayer,\n    set_header::SetResponseHeaderLayer,\n};\nuse tracing::info;\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n\n#[derive(Parser, Debug)]\n#[command(\n    author,\n    version,\n    about = \"Layer9 Development Server - Pure Rust, No Python\"\n)]\nstruct Args {\n    /// Directory to serve\n    #[arg(short, long, default_value = \".\")]\n    dir: PathBuf,\n\n    /// Port to listen on\n    #[arg(short, long, default_value = \"8080\", env = \"LAYER9_PORT\")]\n    port: u16,\n\n    /// Enable hot reload via WebSocket\n    #[arg(short = 'r', long, env = \"LAYER9_HOT_RELOAD\")]\n    hot_reload: bool,\n\n    /// Bind address (default: 0.0.0.0)\n    #[arg(long, default_value = \"0.0.0.0\", env = \"LAYER9_HOST\")]\n    host: String,\n\n    /// Enable HTTPS (requires cert and key)\n    #[arg(long, env = \"LAYER9_HTTPS\")]\n    https: bool,\n\n    /// Path to TLS certificate\n    #[arg(long, env = \"LAYER9_TLS_CERT\")]\n    tls_cert: Option\u003cPathBuf\u003e,\n\n    /// Path to TLS key\n    #[arg(long, env = \"LAYER9_TLS_KEY\")]\n    tls_key: Option\u003cPathBuf\u003e,\n}\n\n#[tokio::main]\nasync fn main() {\n    // Initialize tracing\n    tracing_subscriber::registry()\n        .with(\n            tracing_subscriber::EnvFilter::try_from_default_env()\n                .unwrap_or_else(|_| \"layer9_server=debug,tower_http=debug\".into()),\n        )\n        .with(tracing_subscriber::fmt::layer())\n        .init();\n\n    let args = Args::parse();\n\n    // Create broadcast channel for hot reload\n    let (reload_tx, _) = broadcast::channel::\u003c()\u003e(100);\n    let reload_tx_clone = reload_tx.clone();\n\n    // Setup file watcher for hot reload\n    if args.hot_reload {\n        let dir = args.dir.clone();\n        tokio::spawn(async move {\n            watch_files(dir, reload_tx_clone).await;\n        });\n    }\n\n    // Create the app\n    let app = create_app(args.dir.clone(), reload_tx, args.hot_reload);\n\n    // Run the server\n    let addr: SocketAddr = format!(\"{}:{}\", args.host, args.port)\n        .parse()\n        .expect(\"Invalid address\");\n    let listener = tokio::net::TcpListener::bind(addr).await.unwrap();\n\n    info!(\"🚀 Layer9 Server\");\n    info!(\"📁 Serving: {}\", args.dir.display());\n    info!(\"🌐 Listening on: http://{}:{}\", \n        if args.host == \"0.0.0.0\" { \"localhost\" } else { \u0026args.host }, \n        args.port\n    );\n    if args.hot_reload {\n        info!(\"🔥 Hot reload: enabled\");\n    }\n    info!(\"⚡ Pure Rust - No Python Required!\");\n\n    axum::serve(listener, app).await.unwrap();\n}\n\nfn create_app(dir: PathBuf, reload_tx: broadcast::Sender\u003c()\u003e, hot_reload: bool) -\u003e Router {\n    // Create service for serving files with proper MIME types\n    let serve_dir = ServeDir::new(dir)\n        .append_index_html_on_directories(true)\n        .precompressed_gzip()\n        .precompressed_br();\n\n    // Build the router\n    if hot_reload {\n        Router::new()\n            .route(\"/ws\", get(websocket_handler))\n            .nest_service(\"/\", serve_dir)\n            .layer(\n                ServiceBuilder::new()\n                    .layer(TraceLayer::new_for_http())\n                    .layer(CorsLayer::permissive().allow_credentials(false))\n                    // Security headers\n                    .layer(SetResponseHeaderLayer::if_not_present(\n                        axum::http::header::X_FRAME_OPTIONS,\n                        axum::http::HeaderValue::from_static(\"DENY\"),\n                    ))\n                    .layer(SetResponseHeaderLayer::if_not_present(\n                        axum::http::header::X_CONTENT_TYPE_OPTIONS,\n                        axum::http::HeaderValue::from_static(\"nosniff\"),\n                    ))\n                    .layer(SetResponseHeaderLayer::if_not_present(\n                        axum::http::header::CONTENT_SECURITY_POLICY,\n                        axum::http::HeaderValue::from_static(\n                            \"default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss:;\"\n                        ),\n                    ))\n                    .layer(SetResponseHeaderLayer::if_not_present(\n                        axum::http::header::STRICT_TRANSPORT_SECURITY,\n                        axum::http::HeaderValue::from_static(\"max-age=31536000; includeSubDomains\"),\n                    )),\n            )\n            .with_state(reload_tx)\n    } else {\n        Router::new().nest_service(\"/\", serve_dir).layer(\n            ServiceBuilder::new()\n                .layer(TraceLayer::new_for_http())\n                .layer(CorsLayer::permissive().allow_credentials(false))\n                // Security headers\n                .layer(SetResponseHeaderLayer::if_not_present(\n                    axum::http::header::X_FRAME_OPTIONS,\n                    axum::http::HeaderValue::from_static(\"DENY\"),\n                ))\n                .layer(SetResponseHeaderLayer::if_not_present(\n                    axum::http::header::X_CONTENT_TYPE_OPTIONS,\n                    axum::http::HeaderValue::from_static(\"nosniff\"),\n                ))\n                .layer(SetResponseHeaderLayer::if_not_present(\n                    axum::http::header::CONTENT_SECURITY_POLICY,\n                    axum::http::HeaderValue::from_static(\n                        \"default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss:;\"\n                    ),\n                ))\n                .layer(SetResponseHeaderLayer::if_not_present(\n                    axum::http::header::STRICT_TRANSPORT_SECURITY,\n                    axum::http::HeaderValue::from_static(\"max-age=31536000; includeSubDomains\"),\n                )),\n        )\n    }\n}\n\nasync fn websocket_handler(\n    ws: WebSocketUpgrade,\n    axum::extract::State(reload_tx): axum::extract::State\u003cbroadcast::Sender\u003c()\u003e\u003e,\n) -\u003e Response {\n    ws.on_upgrade(|socket| handle_socket(socket, reload_tx))\n}\n\nasync fn handle_socket(mut socket: WebSocket, reload_tx: broadcast::Sender\u003c()\u003e) {\n    let mut rx = reload_tx.subscribe();\n\n    // Send initial connection message\n    if socket\n        .send(axum::extract::ws::Message::Text(\"connected\".to_string()))\n        .await\n        .is_err()\n    {\n        return;\n    }\n\n    // Listen for reload signals\n    while rx.recv().await.is_ok() {\n        if socket\n            .send(axum::extract::ws::Message::Text(\"reload\".to_string()))\n            .await\n            .is_err()\n        {\n            break;\n        }\n    }\n}\n\nasync fn watch_files(dir: PathBuf, reload_tx: broadcast::Sender\u003c()\u003e) {\n    let (tx, rx) = std::sync::mpsc::channel();\n\n    let mut watcher = RecommendedWatcher::new(\n        move |res: Result\u003cEvent, notify::Error\u003e| {\n            if let Ok(event) = res {\n                if event.kind.is_modify() || event.kind.is_create() {\n                    let _ = tx.send(());\n                }\n            }\n        },\n        Config::default(),\n    )\n    .unwrap();\n\n    watcher.watch(\u0026dir, RecursiveMode::Recursive).unwrap();\n\n    info!(\"👁️  Watching for file changes in: {}\", dir.display());\n\n    // Debounce file changes\n    let mut last_reload = std::time::Instant::now();\n\n    while rx.recv().is_ok() {\n        let now = std::time::Instant::now();\n        if now.duration_since(last_reload).as_millis() \u003e 100 {\n            last_reload = now;\n            info!(\"🔄 File change detected, triggering reload\");\n            let _ = reload_tx.send(());\n        }\n    }\n}\n\n// #[cfg(test)]\n// mod tests {\n//     use super::*;\n//     use axum::http::StatusCode;\n//     use axum_test::TestServer;\n\n//     #[tokio::test]\n//     async fn test_server_starts() {\n//         let (tx, _) = broadcast::channel(100);\n//         let app = create_app(PathBuf::from(\".\"), tx, false);\n//         let server = TestServer::new(app).unwrap();\n\n//         let response = server.get(\"/\").await;\n//         assert_eq!(response.status_code(), StatusCode::OK);\n//     }\n// }\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","macro","src","lib.rs"],"content":"//! Layer9 Procedural Macros\n\nuse proc_macro::TokenStream;\nuse quote::quote;\nuse syn::{parse_macro_input, ItemFn, ItemStruct};\n\n/// Macro for defining Layer9 apps\n#[proc_macro_attribute]\npub fn layer9_app(_args: TokenStream, input: TokenStream) -\u003e TokenStream {\n    let input = parse_macro_input!(input as ItemStruct);\n    let name = \u0026input.ident;\n\n    let expanded = quote! {\n        #input\n\n        impl #name {\n            pub fn new() -\u003e Self {\n                Self\n            }\n        }\n    };\n\n    expanded.into()\n}\n\n/// Macro for defining pages\n#[proc_macro_attribute]\npub fn page(args: TokenStream, input: TokenStream) -\u003e TokenStream {\n    let input = parse_macro_input!(input as ItemFn);\n    let _args = proc_macro2::TokenStream::from(args);\n\n    // For now, just pass through\n    let expanded = quote! {\n        #input\n    };\n\n    expanded.into()\n}\n\n/// Macro for defining components\n#[proc_macro_attribute]\npub fn component(_args: TokenStream, input: TokenStream) -\u003e TokenStream {\n    let input = parse_macro_input!(input as ItemFn);\n    let name = \u0026input.sig.ident;\n\n    let expanded = quote! {\n        #input\n\n        struct #name;\n\n        impl Component for #name {\n            fn render(\u0026self) -\u003e Element {\n                #name()\n            }\n        }\n    };\n\n    expanded.into()\n}\n\n/// Macro for server functions\n#[proc_macro_attribute]\npub fn server(_args: TokenStream, input: TokenStream) -\u003e TokenStream {\n    let input = parse_macro_input!(input as ItemFn);\n\n    // For now, just pass through\n    let expanded = quote! {\n        #input\n    };\n\n    expanded.into()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","crates","runtime","src","lib.rs"],"content":"//! Layer9 Runtime - WASM runtime utilities\n\npub use js_sys;\npub use wasm_bindgen;\npub use web_sys;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","async-counter","src","lib.rs"],"content":"//! Beautiful Async Counter Example\n//! Demonstrates async component loading with stunning UI\n\nuse layer9_core::prelude::*;\nuse layer9_core::hooks::use_state;\nuse layer9_core::reactive_v2::mount;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen_futures::spawn_local;\n\n#[global_allocator]\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;\n\nstruct AsyncCounter;\n\nimpl Component for AsyncCounter {\n    fn render(\u0026self) -\u003e Element {\n        let (count, set_count) = use_state(0i32);\n        let (loading, set_loading) = use_state(true);\n        let (message, set_message) = use_state(\"Loading...\".to_string());\n        let (_error, _set_error) = use_state(false);\n        \n        // Simulate async data loading on mount\n        use_effect((), {\n            let set_count = set_count.clone();\n            let set_loading = set_loading.clone();\n            let set_message = set_message.clone();\n            move || {\n                spawn_local(async move {\n                    // Simulate API delay\n                    let window = web_sys::window().unwrap();\n                    let promise = js_sys::Promise::new(\u0026mut |resolve, _| {\n                        window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                            \u0026resolve,\n                            1500\n                        ).unwrap();\n                    });\n                    wasm_bindgen_futures::JsFuture::from(promise).await.unwrap();\n                    \n                    // Set initial count from \"server\"\n                    set_count(42);\n                    set_loading(false);\n                    set_message(\"Initial count loaded from server!\".to_string());\n                });\n                || {}\n            }\n        });\n        \n        // Update message based on count\n        use_effect(count, {\n            let set_message = set_message.clone();\n            move || {\n                if !loading {\n                    let msg = match count {\n                        0 =\u003e \"Zero - The beginning of everything! 🌟\",\n                        n if n \u003c 0 =\u003e \"Venturing into negative territory! ❄️\",\n                        n if n \u003e 100 =\u003e \"Triple digits! You're on fire! 🔥\",\n                        42 =\u003e \"The answer to everything! 🌌\",\n                        n if n % 10 == 0 =\u003e \"Perfect ten! Nice round number! ✨\",\n                        _ =\u003e \"Keep counting, you're doing great! 🚀\",\n                    };\n                    set_message(msg.to_string());\n                }\n                || {}\n            }\n        });\n        \n        let increment = {\n            let set_count = set_count.clone();\n            move || set_count(count + 1)\n        };\n        \n        let decrement = {\n            let set_count = set_count.clone();\n            move || set_count(count - 1)\n        };\n        \n        let async_reset = {\n            let set_count = set_count.clone();\n            let set_loading = set_loading.clone();\n            let set_message = set_message.clone();\n            move || {\n                let set_count = set_count.clone();\n                let set_loading = set_loading.clone();\n                let set_message = set_message.clone();\n                \n                set_loading(true);\n                set_message(\"Resetting...\".to_string());\n                \n                spawn_local(async move {\n                    // Simulate async reset\n                    let window = web_sys::window().unwrap();\n                    let promise = js_sys::Promise::new(\u0026mut |resolve, _| {\n                        window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                            \u0026resolve,\n                            800\n                        ).unwrap();\n                    });\n                    wasm_bindgen_futures::JsFuture::from(promise).await.unwrap();\n                    \n                    set_count(0);\n                    set_loading(false);\n                    set_message(\"Reset complete! Fresh start! 🎯\".to_string());\n                });\n            }\n        };\n        \n        let async_random = {\n            let set_count = set_count.clone();\n            let set_loading = set_loading.clone();\n            let set_message = set_message.clone();\n            move || {\n                let set_count = set_count.clone();\n                let set_loading = set_loading.clone();\n                let set_message = set_message.clone();\n                \n                set_loading(true);\n                set_message(\"Fetching random number...\".to_string());\n                \n                spawn_local(async move {\n                    // Simulate API call for random number\n                    let window = web_sys::window().unwrap();\n                    let promise = js_sys::Promise::new(\u0026mut |resolve, _| {\n                        window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                            \u0026resolve,\n                            1000\n                        ).unwrap();\n                    });\n                    wasm_bindgen_futures::JsFuture::from(promise).await.unwrap();\n                    \n                    let random = (js_sys::Math::random() * 100.0) as i32;\n                    set_count(random);\n                    set_loading(false);\n                    set_message(format!(\"Random number {} loaded! 🎲\", random));\n                });\n            }\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"async-counter-app\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                // Inline styles\n                Element::Node {\n                    tag: \"style\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(ASYNC_STYLES.to_string())],\n                },\n                \n                // Background decorations\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"bg-decoration\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"pulse pulse-1\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"pulse pulse-2\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                    ],\n                },\n                \n                // Main content\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"content-card\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        // Header\n                        Element::Node {\n                            tag: \"header\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Node {\n                                    tag: \"h1\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"gradient-text\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Async\".to_string())],\n                                        },\n                                        Element::Text(\" Counter\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"p\".to_string(),\n                                    props: Props {\n                                        class: Some(\"subtitle\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Experience asynchronous state management\".to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Counter display\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(if loading { \"counter-display loading\" } else { \"counter-display\" }.to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                if loading {\n                                    Element::Node {\n                                        tag: \"div\".to_string(),\n                                        props: Props {\n                                            class: Some(\"loading-spinner\".to_string()),\n                                            ..Default::default()\n                                        },\n                                        children: vec![],\n                                    }\n                                } else {\n                                    Element::Node {\n                                        tag: \"div\".to_string(),\n                                        props: Props {\n                                            class: Some(\"counter-value\".to_string()),\n                                            ..Default::default()\n                                        },\n                                        children: vec![Element::Text(count.to_string())],\n                                    }\n                                },\n                            ],\n                        },\n                        \n                        // Message display\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"message-display\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"p\".to_string(),\n                                    props: Props {\n                                        class: Some(if loading { \"message loading\" } else { \"message\" }.to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(message.clone())],\n                                },\n                            ],\n                        },\n                        \n                        // Control buttons\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"controls\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                // Sync buttons\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"sync-controls\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"button\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn btn-decrement\".to_string()),\n                                                on_click: Some(Rc::new(decrement)),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"− Decrement\".to_string())],\n                                        },\n                                        Element::Node {\n                                            tag: \"button\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn btn-increment\".to_string()),\n                                                on_click: Some(Rc::new(increment)),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"+ Increment\".to_string())],\n                                        },\n                                    ],\n                                },\n                                \n                                // Async buttons\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"async-controls\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"button\".to_string(),\n                                            props: Props {\n                                                class: Some(if loading { \"btn btn-async disabled\" } else { \"btn btn-async\" }.to_string()),\n                                                on_click: if loading { None } else { Some(Rc::new(async_reset)) },\n                                                ..Default::default()\n                                            },\n                                            children: vec![\n                                                Element::Node {\n                                                    tag: \"span\".to_string(),\n                                                    props: Props {\n                                                        class: Some(\"btn-icon\".to_string()),\n                                                        ..Default::default()\n                                                    },\n                                                    children: vec![Element::Text(\"↺\".to_string())],\n                                                },\n                                                Element::Text(\" Async Reset\".to_string()),\n                                            ],\n                                        },\n                                        Element::Node {\n                                            tag: \"button\".to_string(),\n                                            props: Props {\n                                                class: Some(if loading { \"btn btn-async disabled\" } else { \"btn btn-async\" }.to_string()),\n                                                on_click: if loading { None } else { Some(Rc::new(async_random)) },\n                                                ..Default::default()\n                                            },\n                                            children: vec![\n                                                Element::Node {\n                                                    tag: \"span\".to_string(),\n                                                    props: Props {\n                                                        class: Some(\"btn-icon\".to_string()),\n                                                        ..Default::default()\n                                                    },\n                                                    children: vec![Element::Text(\"🎲\".to_string())],\n                                                },\n                                                Element::Text(\" Random\".to_string()),\n                                            ],\n                                        },\n                                    ],\n                                },\n                            ],\n                        },\n                        \n                        // Footer\n                        Element::Node {\n                            tag: \"footer\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Text(\"Powered by \".to_string()),\n                                Element::Node {\n                                    tag: \"a\".to_string(),\n                                    props: Props {\n                                        attributes: vec![\n                                            (\"href\".to_string(), \"https://github.com/anthropics/layer9\".to_string()),\n                                            (\"target\".to_string(), \"_blank\".to_string()),\n                                        ],\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Layer9\".to_string())],\n                                },\n                                Element::Text(\" • Async Rust Web Framework\".to_string()),\n                            ],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\nconst ASYNC_STYLES: \u0026str = r#\"\n    :root {\n        --async-primary: #8b5cf6;\n        --async-secondary: #ec4899;\n        --async-success: #10b981;\n        --async-warning: #f59e0b;\n        --async-gradient-1: #8b5cf6;\n        --async-gradient-2: #ec4899;\n        --async-gradient-3: #06b6d4;\n    }\n    \n    * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n    }\n    \n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        background: linear-gradient(135deg, var(--async-gradient-1), var(--async-gradient-2), var(--async-gradient-3));\n        min-height: 100vh;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n    }\n    \n    .async-counter-app {\n        position: relative;\n        width: 100%;\n        max-width: 600px;\n        margin: 0 20px;\n    }\n    \n    .bg-decoration {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n    }\n    \n    .pulse {\n        position: absolute;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.1);\n        animation: pulse 4s ease-in-out infinite;\n    }\n    \n    .pulse-1 {\n        width: 600px;\n        height: 600px;\n        top: -300px;\n        right: -300px;\n    }\n    \n    .pulse-2 {\n        width: 400px;\n        height: 400px;\n        bottom: -200px;\n        left: -200px;\n        animation-delay: 2s;\n    }\n    \n    @keyframes pulse {\n        0%, 100% {\n            transform: scale(1);\n            opacity: 0.1;\n        }\n        50% {\n            transform: scale(1.2);\n            opacity: 0.3;\n        }\n    }\n    \n    .content-card {\n        background: rgba(255, 255, 255, 0.95);\n        backdrop-filter: blur(20px);\n        border-radius: 30px;\n        padding: 50px;\n        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);\n        position: relative;\n        z-index: 1;\n    }\n    \n    header {\n        text-align: center;\n        margin-bottom: 40px;\n    }\n    \n    h1 {\n        font-size: 3rem;\n        font-weight: 800;\n        color: #1a202c;\n        margin-bottom: 10px;\n    }\n    \n    .gradient-text {\n        background: linear-gradient(135deg, var(--async-primary), var(--async-secondary));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n    }\n    \n    .subtitle {\n        color: #64748b;\n        font-size: 1.2rem;\n    }\n    \n    .counter-display {\n        text-align: center;\n        margin: 50px 0;\n        min-height: 120px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    \n    .counter-display.loading {\n        opacity: 0.7;\n    }\n    \n    .counter-value {\n        font-size: 6rem;\n        font-weight: 800;\n        background: linear-gradient(135deg, var(--async-primary), var(--async-secondary));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n        animation: fadeIn 0.5s ease;\n    }\n    \n    @keyframes fadeIn {\n        from {\n            opacity: 0;\n            transform: scale(0.8);\n        }\n        to {\n            opacity: 1;\n            transform: scale(1);\n        }\n    }\n    \n    .loading-spinner {\n        width: 80px;\n        height: 80px;\n        border: 4px solid #f3f4f6;\n        border-top: 4px solid var(--async-primary);\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n    }\n    \n    @keyframes spin {\n        to { transform: rotate(360deg); }\n    }\n    \n    .message-display {\n        text-align: center;\n        margin-bottom: 40px;\n        min-height: 30px;\n    }\n    \n    .message {\n        font-size: 1.2rem;\n        color: #64748b;\n        transition: all 0.3s ease;\n    }\n    \n    .message.loading {\n        color: var(--async-primary);\n        font-style: italic;\n    }\n    \n    .controls {\n        display: flex;\n        flex-direction: column;\n        gap: 20px;\n    }\n    \n    .sync-controls, .async-controls {\n        display: flex;\n        gap: 15px;\n        justify-content: center;\n    }\n    \n    .btn {\n        padding: 15px 30px;\n        border: none;\n        border-radius: 15px;\n        font-size: 1.1rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);\n    }\n    \n    .btn-icon {\n        font-size: 1.4rem;\n    }\n    \n    .btn-increment {\n        background: linear-gradient(135deg, var(--async-success), #059669);\n        color: white;\n    }\n    \n    .btn-increment:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);\n    }\n    \n    .btn-decrement {\n        background: linear-gradient(135deg, var(--async-warning), #d97706);\n        color: white;\n    }\n    \n    .btn-decrement:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);\n    }\n    \n    .btn-async {\n        background: linear-gradient(135deg, var(--async-primary), var(--async-secondary));\n        color: white;\n    }\n    \n    .btn-async:hover:not(.disabled) {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);\n    }\n    \n    .btn.disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n        transform: none !important;\n    }\n    \n    footer {\n        text-align: center;\n        margin-top: 40px;\n        color: #64748b;\n        font-size: 0.9rem;\n    }\n    \n    footer a {\n        color: var(--async-primary);\n        text-decoration: none;\n        font-weight: 600;\n    }\n    \n    footer a:hover {\n        text-decoration: underline;\n    }\n    \n    @media (max-width: 600px) {\n        h1 {\n            font-size: 2rem;\n        }\n        \n        .counter-value {\n            font-size: 4rem;\n        }\n        \n        .content-card {\n            padding: 30px;\n        }\n        \n        .sync-controls, .async-controls {\n            flex-direction: column;\n        }\n        \n        .btn {\n            width: 100%;\n            justify-content: center;\n        }\n    }\n\"#;\n\n#[wasm_bindgen(start)]\npub fn main() {\n    web_sys::console::log_1(\u0026\"Beautiful Async Counter starting...\".into());\n    mount(Box::new(AsyncCounter), \"root\");\n    web_sys::console::log_1(\u0026\"Beautiful Async Counter mounted successfully!\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","auth-jwt-demo","src","lib.rs"],"content":"//! JWT Authentication Demo\n//! \n//! This example demonstrates the new JWT-based authentication system\n\nuse layer9_core::auth::{AuthService, JwtAuthProvider};\nuse layer9_core::config::ConfigBuilder;\nuse wasm_bindgen::prelude::*;\nuse web_sys::console;\n\n#[wasm_bindgen(start)]\npub async fn main() {\n    console_error_panic_hook::set_once();\n    \n    console::log_1(\u0026\"=== Layer9 JWT Authentication Demo ===\".into());\n    \n    // Example 1: Using default configuration (JWT with default secret)\n    console::log_1(\u0026\"\\n1. Default Configuration:\".into());\n    {\n        let _auth_service = AuthService::default();\n        console::log_1(\u0026\"Created AuthService with default configuration\".into());\n        console::log_1(\u0026\"This uses JwtAuthProvider with configured or default secret\".into());\n    }\n    \n    // Example 2: Using custom JWT secret\n    console::log_1(\u0026\"\\n2. Custom JWT Secret:\".into());\n    {\n        \n        // Create a JWT provider and add a test user\n        let mut jwt_provider = JwtAuthProvider::new(\"my-custom-secret-key\".to_string());\n        jwt_provider.add_user(\n            \"testuser\".to_string(),\n            \"password123\".to_string(),\n            \"test@example.com\".to_string(),\n            vec![\"user\".to_string()]\n        );\n        \n        // Now create auth service with this provider\n        let mut auth_service = AuthService::new(Box::new(jwt_provider));\n        \n        // Try to login\n        match auth_service.login(\"testuser\", \"password123\").await {\n            Ok(_) =\u003e {\n                console::log_1(\u0026\"✓ Login successful!\".into());\n                if let Some(user) = auth_service.get_current_user() {\n                    console::log_1(\u0026format!(\"  User: {} ({})\", user.username, user.email).into());\n                    console::log_1(\u0026format!(\"  Roles: {:?}\", user.roles).into());\n                }\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"✗ Login failed: {}\", e).into());\n            }\n        }\n        \n        // Try wrong password\n        auth_service.logout();\n        match auth_service.login(\"testuser\", \"wrongpassword\").await {\n            Ok(_) =\u003e {\n                console::log_1(\u0026\"Unexpected: Login should have failed!\".into());\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"✓ Login correctly failed with wrong password: {}\", e).into());\n            }\n        }\n    }\n    \n    // Example 3: Using configuration builder\n    console::log_1(\u0026\"\\n3. Configuration Builder:\".into());\n    {\n        let config = ConfigBuilder::new()\n            .jwt_secret(\"config-builder-secret\".to_string())\n            .use_mock_auth(false)\n            .build();\n        \n        let _auth_service = AuthService::with_config(\u0026config);\n        console::log_1(\u0026\"Created AuthService with custom configuration\".into());\n        console::log_1(\u0026format!(\"  JWT Secret: {}\", config.get_jwt_secret()).into());\n        console::log_1(\u0026format!(\"  Use Mock Auth: {}\", config.should_use_mock_auth()).into());\n    }\n    \n    // Example 4: Using mock authentication for testing\n    console::log_1(\u0026\"\\n4. Mock Authentication (Testing):\".into());\n    {\n        let config = ConfigBuilder::new()\n            .use_mock_auth(true)\n            .build();\n        \n        let mut auth_service = AuthService::with_config(\u0026config);\n        \n        // Mock auth accepts any credentials\n        match auth_service.login(\"anyuser\", \"anypassword\").await {\n            Ok(_) =\u003e {\n                console::log_1(\u0026\"✓ Mock login successful (accepts any credentials)\".into());\n                if let Some(user) = auth_service.get_current_user() {\n                    console::log_1(\u0026format!(\"  Mock User: {} ({})\", user.username, user.email).into());\n                }\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"✗ Mock login failed: {}\", e).into());\n            }\n        }\n    }\n    \n    // Example 5: Token validation and refresh\n    console::log_1(\u0026\"\\n5. Token Validation and Refresh:\".into());\n    {\n        let mut jwt_provider = JwtAuthProvider::new(\"token-test-secret\".to_string());\n        jwt_provider.add_user(\n            \"tokenuser\".to_string(),\n            \"tokenpass\".to_string(),\n            \"token@example.com\".to_string(),\n            vec![\"admin\".to_string()]\n        );\n        \n        let mut auth_service = AuthService::new(Box::new(jwt_provider));\n        \n        // Login to get a token\n        match auth_service.login(\"tokenuser\", \"tokenpass\").await {\n            Ok(_) =\u003e {\n                console::log_1(\u0026\"✓ Login successful, got token\".into());\n                \n                // Get the token\n                if let Some(token) = \u0026auth_service.get_context().token {\n                    console::log_1(\u0026format!(\"  Token (truncated): {}...\", \u0026token[..20]).into());\n                    \n                    // Validate token\n                    match auth_service.validate_token(token) {\n                        Ok(user) =\u003e {\n                            console::log_1(\u0026format!(\"✓ Token valid for user: {}\", user.username).into());\n                        }\n                        Err(e) =\u003e {\n                            console::log_1(\u0026format!(\"✗ Token validation failed: {}\", e).into());\n                        }\n                    }\n                    \n                    // Refresh token\n                    match auth_service.refresh_session().await {\n                        Ok(_) =\u003e {\n                            console::log_1(\u0026\"✓ Token refreshed successfully\".into());\n                        }\n                        Err(e) =\u003e {\n                            console::log_1(\u0026format!(\"✗ Token refresh failed: {}\", e).into());\n                        }\n                    }\n                }\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"✗ Login failed: {}\", e).into());\n            }\n        }\n    }\n    \n    console::log_1(\u0026\"\\n=== Demo Complete ===\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","auth-upload","src","lib.rs"],"content":"//! Layer9 Authentication and File Upload Demo\n//! \n//! This example demonstrates:\n//! - User authentication with JWT\n//! - Protected file upload functionality\n//! - Session management\n//! - Role-based access control\n\nuse layer9_core::{\n    auth::{AuthService, JwtAuthProvider, AuthContext},\n    upload::FileUploadComponent,\n};\nuse wasm_bindgen::prelude::*;\nuse web_sys::{console, FileList};\n\n#[wasm_bindgen]\npub struct AuthUploadApp {\n    auth_service: AuthService,\n    upload_component: FileUploadComponent,\n    state_version: u32,\n}\n\n#[wasm_bindgen]\nimpl AuthUploadApp {\n    #[wasm_bindgen(constructor)]\n    pub fn new() -\u003e Self {\n        console_error_panic_hook::set_once();\n        \n        // Initialize JWT auth provider with demo users\n        let mut jwt_provider = JwtAuthProvider::new(\"layer9-demo-secret\".to_string());\n        \n        // Add demo users with different roles\n        jwt_provider.add_user(\n            \"admin\".to_string(),\n            \"admin123\".to_string(),\n            \"admin@layer9.dev\".to_string(),\n            vec![\"admin\".to_string()],\n        );\n        \n        jwt_provider.add_user(\n            \"user\".to_string(),\n            \"user123\".to_string(),\n            \"user@layer9.dev\".to_string(),\n            vec![\"user\".to_string()],\n        );\n        \n        jwt_provider.add_user(\n            \"guest\".to_string(),\n            \"guest123\".to_string(),\n            \"guest@layer9.dev\".to_string(),\n            vec![\"guest\".to_string()],\n        );\n        \n        let auth_service = AuthService::new(Box::new(jwt_provider));\n        \n        // Configure file upload component\n        let upload_component = FileUploadComponent::new()\n            .with_url(\"/api/upload\".to_string())\n            .with_max_size(5 * 1024 * 1024) // 5MB\n            .with_allowed_types(vec![\n                \"image/jpeg\".to_string(),\n                \"image/png\".to_string(),\n                \"image/gif\".to_string(),\n                \"application/pdf\".to_string(),\n                \"text/plain\".to_string(),\n            ]);\n        \n        Self {\n            auth_service,\n            upload_component,\n            state_version: 0,\n        }\n    }\n    \n    pub fn render(\u0026self) -\u003e String {\n        let auth_context = self.auth_service.get_context();\n        \n        format!(r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003ctitle\u003eLayer9 Auth \u0026 Upload Demo\u003c/title\u003e\n    \u003cstyle\u003e{}\u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003ch1\u003e🔐 Layer9 Authentication \u0026 File Upload Demo\u003c/h1\u003e\n        \n        {}\n        \n        \u003cdiv class=\"demo-info\"\u003e\n            \u003ch3\u003eDemo Users:\u003c/h3\u003e\n            \u003cul\u003e\n                \u003cli\u003e\u003cstrong\u003eadmin/admin123\u003c/strong\u003e - Full access (can upload)\u003c/li\u003e\n                \u003cli\u003e\u003cstrong\u003euser/user123\u003c/strong\u003e - User access (can upload)\u003c/li\u003e\n                \u003cli\u003e\u003cstrong\u003eguest/guest123\u003c/strong\u003e - Guest access (no upload)\u003c/li\u003e\n            \u003c/ul\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n    \n    \u003cscript\u003e{}\u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n        \"#, \n            self.get_styles(),\n            self.render_main_content(auth_context),\n            self.get_scripts()\n        )\n    }\n    \n    fn render_main_content(\u0026self, auth_context: \u0026AuthContext) -\u003e String {\n        if auth_context.is_authenticated() {\n            self.render_authenticated_view(auth_context)\n        } else {\n            self.render_login_form()\n        }\n    }\n    \n    fn render_authenticated_view(\u0026self, auth_context: \u0026AuthContext) -\u003e String {\n        let user = auth_context.user.as_ref().unwrap();\n        let can_upload = auth_context.has_permission(\"write\");\n        \n        format!(r#\"\n        \u003cdiv class=\"auth-section\"\u003e\n            \u003ch2\u003eWelcome, {}!\u003c/h2\u003e\n            \u003cdiv class=\"user-info\"\u003e\n                \u003cp\u003e\u003cstrong\u003eEmail:\u003c/strong\u003e {}\u003c/p\u003e\n                \u003cp\u003e\u003cstrong\u003eRoles:\u003c/strong\u003e {}\u003c/p\u003e\n                \u003cp\u003e\u003cstrong\u003ePermissions:\u003c/strong\u003e {}\u003c/p\u003e\n            \u003c/div\u003e\n            \u003cbutton onclick=\"window.app.handle_logout()\" class=\"btn btn-secondary\"\u003eLogout\u003c/button\u003e\n        \u003c/div\u003e\n        \n        \u003cdiv class=\"upload-section\"\u003e\n            \u003ch2\u003e📤 File Upload\u003c/h2\u003e\n            {}\n        \u003c/div\u003e\n        \"#,\n            user.username,\n            user.email,\n            user.roles.join(\", \"),\n            auth_context.permissions.join(\", \"),\n            if can_upload {\n                self.upload_component.render()\n            } else {\n                r#\"\u003cdiv class=\"no-permission\"\u003e⚠️ You don't have permission to upload files. Login as 'admin' or 'user' to upload.\u003c/div\u003e\"#.to_string()\n            }\n        )\n    }\n    \n    fn render_login_form(\u0026self) -\u003e String {\n        r#\"\n        \u003cdiv class=\"login-section\"\u003e\n            \u003ch2\u003eLogin\u003c/h2\u003e\n            \u003cform id=\"login-form\" onsubmit=\"return false;\"\u003e\n                \u003cdiv class=\"form-group\"\u003e\n                    \u003clabel\u003eUsername:\u003c/label\u003e\n                    \u003cinput type=\"text\" id=\"username\" placeholder=\"Enter username\" required\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"form-group\"\u003e\n                    \u003clabel\u003ePassword:\u003c/label\u003e\n                    \u003cinput type=\"password\" id=\"password\" placeholder=\"Enter password\" required\u003e\n                \u003c/div\u003e\n                \u003cbutton type=\"submit\" onclick=\"window.app.handle_login()\" class=\"btn btn-primary\"\u003eLogin\u003c/button\u003e\n                \u003cdiv id=\"error-message\" class=\"error-message\"\u003e\u003c/div\u003e\n            \u003c/form\u003e\n        \u003c/div\u003e\n        \"#.to_string()\n    }\n    \n    fn get_styles(\u0026self) -\u003e \u0026str {\n        r#\"\n        * {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n        \n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: #333;\n        }\n        \n        .container {\n            background: white;\n            border-radius: 12px;\n            box-shadow: 0 20px 40px rgba(0,0,0,0.1);\n            padding: 40px;\n            max-width: 800px;\n            width: 90%;\n        }\n        \n        h1 {\n            color: #333;\n            margin-bottom: 30px;\n            text-align: center;\n        }\n        \n        h2 {\n            color: #555;\n            margin-bottom: 20px;\n        }\n        \n        .auth-section, .login-section, .upload-section {\n            margin-bottom: 30px;\n            padding: 20px;\n            background: #f8f9fa;\n            border-radius: 8px;\n        }\n        \n        .user-info {\n            margin: 20px 0;\n            padding: 15px;\n            background: white;\n            border-radius: 6px;\n        }\n        \n        .user-info p {\n            margin: 8px 0;\n        }\n        \n        .form-group {\n            margin-bottom: 20px;\n        }\n        \n        label {\n            display: block;\n            margin-bottom: 8px;\n            font-weight: 500;\n            color: #666;\n        }\n        \n        input[type=\"text\"],\n        input[type=\"password\"] {\n            width: 100%;\n            padding: 12px;\n            border: 2px solid #e1e4e8;\n            border-radius: 6px;\n            font-size: 16px;\n            transition: border-color 0.3s;\n        }\n        \n        input[type=\"text\"]:focus,\n        input[type=\"password\"]:focus {\n            outline: none;\n            border-color: #667eea;\n        }\n        \n        .btn {\n            padding: 12px 24px;\n            border: none;\n            border-radius: 6px;\n            font-size: 16px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: all 0.3s;\n        }\n        \n        .btn-primary {\n            background: #667eea;\n            color: white;\n        }\n        \n        .btn-primary:hover {\n            background: #5a67d8;\n            transform: translateY(-1px);\n            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n        }\n        \n        .btn-secondary {\n            background: #e1e4e8;\n            color: #333;\n        }\n        \n        .btn-secondary:hover {\n            background: #d1d5db;\n        }\n        \n        .error-message {\n            color: #e53e3e;\n            margin-top: 15px;\n            padding: 10px;\n            background: #fff5f5;\n            border-radius: 6px;\n            display: none;\n        }\n        \n        .error-message.show {\n            display: block;\n        }\n        \n        .demo-info {\n            background: #e6f3ff;\n            border: 1px solid #b3d9ff;\n            border-radius: 8px;\n            padding: 20px;\n            margin-top: 30px;\n        }\n        \n        .demo-info h3 {\n            color: #0066cc;\n            margin-bottom: 15px;\n        }\n        \n        .demo-info ul {\n            list-style: none;\n            padding-left: 0;\n        }\n        \n        .demo-info li {\n            margin: 10px 0;\n            padding: 8px;\n            background: white;\n            border-radius: 4px;\n        }\n        \n        .no-permission {\n            padding: 20px;\n            background: #fff5f5;\n            border: 1px solid #feb2b2;\n            color: #c53030;\n            border-radius: 6px;\n            text-align: center;\n        }\n        \n        /* File upload styles */\n        .file-upload-component {\n            margin-top: 20px;\n        }\n        \n        .upload-area {\n            border: 2px dashed #cbd5e0;\n            border-radius: 8px;\n            padding: 40px;\n            text-align: center;\n            transition: all 0.3s;\n        }\n        \n        .upload-area:hover {\n            border-color: #667eea;\n            background: #f7fafc;\n        }\n        \n        .file-input {\n            display: none;\n        }\n        \n        .upload-label {\n            cursor: pointer;\n            display: inline-block;\n        }\n        \n        .upload-label svg {\n            stroke: #667eea;\n            margin-bottom: 10px;\n        }\n        \n        .file-types, .max-size {\n            display: block;\n            margin-top: 10px;\n            font-size: 14px;\n            color: #718096;\n        }\n        \n        .upload-status {\n            margin-top: 20px;\n        }\n        \n        .upload-item {\n            padding: 12px;\n            margin: 8px 0;\n            border-radius: 6px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        \n        .upload-item.pending {\n            background: #e6f3ff;\n            color: #0066cc;\n        }\n        \n        .upload-item.uploading {\n            background: #fff7e6;\n            color: #cc6600;\n        }\n        \n        .upload-item.complete {\n            background: #e6ffe6;\n            color: #008800;\n        }\n        \n        .upload-item.failed {\n            background: #ffe6e6;\n            color: #cc0000;\n        }\n        \"#\n    }\n    \n    fn get_scripts(\u0026self) -\u003e \u0026str {\n        r#\"\n        // Store app instance globally\n        window.app = {\n            handle_login: async function() {\n                const username = document.getElementById('username').value;\n                const password = document.getElementById('password').value;\n                const errorMsg = document.getElementById('error-message');\n                \n                try {\n                    const response = await window.wasmApp.login(username, password);\n                    if (response.success) {\n                        location.reload();\n                    } else {\n                        errorMsg.textContent = response.error;\n                        errorMsg.classList.add('show');\n                    }\n                } catch (e) {\n                    errorMsg.textContent = 'Login failed: ' + e.message;\n                    errorMsg.classList.add('show');\n                }\n            },\n            \n            handle_logout: function() {\n                window.wasmApp.logout();\n                location.reload();\n            },\n            \n            handle_file_select: async function(event) {\n                const files = event.target.files;\n                if (files \u0026\u0026 files.length \u003e 0) {\n                    try {\n                        await window.wasmApp.upload_files(files);\n                        // Update UI to show upload progress\n                        window.updateUploadStatus();\n                    } catch (e) {\n                        console.error('Upload failed:', e);\n                    }\n                }\n            },\n            \n            updateUploadStatus: function() {\n                // This would be called periodically to update upload progress\n                const statusHtml = window.wasmApp.get_upload_status();\n                const statusContainer = document.getElementById('upload-progress');\n                if (statusContainer) {\n                    statusContainer.innerHTML = statusHtml;\n                }\n            }\n        };\n        \n        // Set up file input handler when DOM is ready\n        document.addEventListener('DOMContentLoaded', function() {\n            const fileInput = document.getElementById('file-input');\n            if (fileInput) {\n                fileInput.addEventListener('change', window.app.handle_file_select);\n            }\n        });\n        \"#\n    }\n    \n    #[wasm_bindgen]\n    pub async fn login(\u0026mut self, username: String, password: String) -\u003e JsValue {\n        match self.auth_service.login(\u0026username, \u0026password).await {\n            Ok(_) =\u003e {\n                let result = js_sys::Object::new();\n                js_sys::Reflect::set(\u0026result, \u0026\"success\".into(), \u0026true.into()).unwrap();\n                result.into()\n            }\n            Err(e) =\u003e {\n                let result = js_sys::Object::new();\n                js_sys::Reflect::set(\u0026result, \u0026\"success\".into(), \u0026false.into()).unwrap();\n                js_sys::Reflect::set(\u0026result, \u0026\"error\".into(), \u0026e.into()).unwrap();\n                result.into()\n            }\n        }\n    }\n    \n    #[wasm_bindgen]\n    pub fn logout(\u0026mut self) {\n        self.auth_service.logout();\n        self.state_version += 1;\n    }\n    \n    #[wasm_bindgen]\n    pub fn is_authenticated(\u0026self) -\u003e bool {\n        self.auth_service.is_authenticated()\n    }\n    \n    #[wasm_bindgen]\n    pub async fn upload_files(\u0026mut self, files: FileList) -\u003e Result\u003cJsValue, JsValue\u003e {\n        let auth_context = self.auth_service.get_context();\n        \n        // Check if user has upload permission\n        if !auth_context.has_permission(\"write\") {\n            return Err(JsValue::from_str(\"You don't have permission to upload files\"));\n        }\n        \n        // Use the file upload component\n        match self.upload_component.handle_file_select(files).await {\n            Ok(upload_ids) =\u003e {\n                let array = js_sys::Array::new();\n                for id in upload_ids {\n                    array.push(\u0026JsValue::from_str(\u0026id));\n                }\n                Ok(array.into())\n            }\n            Err(e) =\u003e Err(JsValue::from_str(\u0026e))\n        }\n    }\n    \n    #[wasm_bindgen]\n    pub fn get_upload_status(\u0026self) -\u003e String {\n        self.upload_component.get_upload_status()\n    }\n}\n\nimpl Default for AuthUploadApp {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n// Initialize the app when WASM loads\n#[wasm_bindgen(start)]\npub fn main() {\n    console::log_1(\u0026\"Layer9 Auth \u0026 Upload Demo initialized\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","counter","src","beautiful.rs"],"content":"//! Beautiful Counter Example - Showcasing Layer9's Reactive Features\n//!\n//! A stunning counter with animations, gradients, and modern UI design\n\nuse layer9_core::prelude::*;\nuse layer9_core::hooks::use_state_hook as use_state;\nuse layer9_core::reactive_v2::mount;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\n\n#[global_allocator]\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;\n\nstruct BeautifulCounter;\n\nimpl Component for BeautifulCounter {\n    fn render(\u0026self) -\u003e Element {\n        let (count, set_count) = use_state(0i32);\n        let (animation_class, set_animation_class) = use_state(String::new());\n        \n        // Helper to trigger animation\n        let trigger_animation = {\n            let set_animation_class = set_animation_class.clone();\n            move |direction: \u0026str| {\n                set_animation_class(format!(\"animate-{}\", direction));\n                // Reset animation class after animation completes\n                let set_animation_class_clone = set_animation_class.clone();\n                web_sys::window().unwrap().set_timeout_with_callback_and_timeout_and_arguments_0(\n                    \u0026wasm_bindgen::closure::Closure::wrap(Box::new(move || {\n                        set_animation_class_clone(String::new());\n                    }) as Box\u003cdyn FnMut()\u003e).as_ref().unchecked_ref(),\n                    300\n                ).unwrap();\n            }\n        };\n        \n        let increment = {\n            let count = count;\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(count + 1);\n                trigger_animation(\"up\");\n            }\n        };\n        \n        let decrement = {\n            let count = count;\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(count - 1);\n                trigger_animation(\"down\");\n            }\n        };\n        \n        let increment_by = |amount: i32| {\n            let count = count;\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(count + amount);\n                trigger_animation(\"up\");\n            }\n        };\n        \n        let reset = {\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(0);\n                trigger_animation(\"reset\");\n            }\n        };\n        \n        // Determine counter color based on value\n        let counter_class = if count \u003e 0 {\n            \"positive\"\n        } else if count \u003c 0 {\n            \"negative\"\n        } else {\n            \"zero\"\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"beautiful-counter\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                // Inline styles\n                Element::Node {\n                    tag: \"style\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(BEAUTIFUL_STYLES.to_string())],\n                },\n                \n                // Background decoration\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"bg-decoration\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"circle circle-1\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"circle circle-2\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"circle circle-3\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                    ],\n                },\n                \n                // Main content\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"counter-content\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        // Header\n                        Element::Node {\n                            tag: \"header\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Node {\n                                    tag: \"h1\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"gradient-text\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Layer9\".to_string())],\n                                        },\n                                        Element::Text(\" Counter\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"p\".to_string(),\n                                    props: Props {\n                                        class: Some(\"subtitle\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Beautiful reactive state management\".to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Counter display\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(format!(\"counter-display {} {}\", counter_class, animation_class)),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"counter-value\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(count.to_string())],\n                                },\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"counter-label\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(if count.abs() == 1 { \"click\" } else { \"clicks\" }.to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Quick actions\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"quick-actions\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                create_quick_button(\"-10\", increment_by(-10)),\n                                create_quick_button(\"-5\", increment_by(-5)),\n                                create_quick_button(\"+5\", increment_by(5)),\n                                create_quick_button(\"+10\", increment_by(10)),\n                            ],\n                        },\n                        \n                        // Main controls\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"main-controls\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"btn btn-decrement\".to_string()),\n                                        on_click: Some(Rc::new(decrement)),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn-icon\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"−\".to_string())],\n                                        },\n                                        Element::Text(\"Decrement\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"btn btn-reset\".to_string()),\n                                        on_click: Some(Rc::new(reset)),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn-icon\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"↺\".to_string())],\n                                        },\n                                        Element::Text(\"Reset\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"btn btn-increment\".to_string()),\n                                        on_click: Some(Rc::new(increment)),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn-icon\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"+\".to_string())],\n                                        },\n                                        Element::Text(\"Increment\".to_string()),\n                                    ],\n                                },\n                            ],\n                        },\n                        \n                        // Statistics\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"stats\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                create_stat(\"Status\", if count \u003e 0 { \"Positive\" } else if count \u003c 0 { \"Negative\" } else { \"Zero\" }),\n                                create_stat(\"Distance from zero\", \u0026count.abs().to_string()),\n                                create_stat(\"Square\", \u0026(count * count).to_string()),\n                            ],\n                        },\n                        \n                        // Footer\n                        Element::Node {\n                            tag: \"footer\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Text(\"Built with \".to_string()),\n                                Element::Node {\n                                    tag: \"a\".to_string(),\n                                    props: Props {\n                                        attributes: vec![\n                                            (\"href\".to_string(), \"https://github.com/anthropics/layer9\".to_string()),\n                                            (\"target\".to_string(), \"_blank\".to_string()),\n                                        ],\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Layer9\".to_string())],\n                                },\n                                Element::Text(\" • Reactive Rust Web Framework\".to_string()),\n                            ],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\nfn create_quick_button(label: \u0026str, handler: impl Fn() + 'static) -\u003e Element {\n    Element::Node {\n        tag: \"button\".to_string(),\n        props: Props {\n            class: Some(\"quick-btn\".to_string()),\n            on_click: Some(Rc::new(handler)),\n            ..Default::default()\n        },\n        children: vec![Element::Text(label.to_string())],\n    }\n}\n\nfn create_stat(label: \u0026str, value: \u0026str) -\u003e Element {\n    Element::Node {\n        tag: \"div\".to_string(),\n        props: Props {\n            class: Some(\"stat\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"stat-label\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![Element::Text(label.to_string())],\n            },\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"stat-value\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![Element::Text(value.to_string())],\n            },\n        ],\n    }\n}\n\nconst BEAUTIFUL_STYLES: \u0026str = r#\"\n    :root {\n        --primary: #6366f1;\n        --primary-light: #818cf8;\n        --primary-dark: #4f46e5;\n        --secondary: #ec4899;\n        --secondary-light: #f472b6;\n        --success: #10b981;\n        --danger: #ef4444;\n        --warning: #f59e0b;\n        --bg-gradient-1: #667eea;\n        --bg-gradient-2: #764ba2;\n        --bg-gradient-3: #f093fb;\n    }\n    \n    * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n    }\n    \n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n        background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-3) 100%);\n        min-height: 100vh;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n    }\n    \n    .beautiful-counter {\n        position: relative;\n        width: 100%;\n        max-width: 500px;\n        margin: 0 20px;\n    }\n    \n    .bg-decoration {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        overflow: hidden;\n    }\n    \n    .circle {\n        position: absolute;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.1);\n        filter: blur(60px);\n        animation: float 20s infinite ease-in-out;\n    }\n    \n    .circle-1 {\n        width: 400px;\n        height: 400px;\n        top: -200px;\n        left: -100px;\n        animation-delay: 0s;\n    }\n    \n    .circle-2 {\n        width: 300px;\n        height: 300px;\n        bottom: -150px;\n        right: -100px;\n        animation-delay: 5s;\n    }\n    \n    .circle-3 {\n        width: 250px;\n        height: 250px;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        animation-delay: 10s;\n    }\n    \n    @keyframes float {\n        0%, 100% { transform: translate(0, 0) scale(1); }\n        33% { transform: translate(30px, -30px) scale(1.1); }\n        66% { transform: translate(-20px, 20px) scale(0.9); }\n    }\n    \n    .counter-content {\n        background: rgba(255, 255, 255, 0.95);\n        backdrop-filter: blur(20px);\n        border-radius: 30px;\n        padding: 40px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);\n        position: relative;\n        z-index: 1;\n    }\n    \n    header {\n        text-align: center;\n        margin-bottom: 40px;\n    }\n    \n    h1 {\n        font-size: 2.5rem;\n        font-weight: 800;\n        color: #1a202c;\n        margin-bottom: 10px;\n    }\n    \n    .gradient-text {\n        background: linear-gradient(135deg, var(--primary), var(--secondary));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n    }\n    \n    .subtitle {\n        color: #718096;\n        font-size: 1.1rem;\n    }\n    \n    .counter-display {\n        text-align: center;\n        margin: 40px 0;\n        transition: transform 0.3s ease;\n    }\n    \n    .counter-display.animate-up {\n        animation: bounceUp 0.3s ease;\n    }\n    \n    .counter-display.animate-down {\n        animation: bounceDown 0.3s ease;\n    }\n    \n    .counter-display.animate-reset {\n        animation: spin 0.5s ease;\n    }\n    \n    @keyframes bounceUp {\n        0% { transform: translateY(0); }\n        50% { transform: translateY(-10px); }\n        100% { transform: translateY(0); }\n    }\n    \n    @keyframes bounceDown {\n        0% { transform: translateY(0); }\n        50% { transform: translateY(10px); }\n        100% { transform: translateY(0); }\n    }\n    \n    @keyframes spin {\n        0% { transform: rotate(0deg) scale(1); }\n        50% { transform: rotate(180deg) scale(0.8); }\n        100% { transform: rotate(360deg) scale(1); }\n    }\n    \n    .counter-value {\n        font-size: 5rem;\n        font-weight: 800;\n        line-height: 1;\n        transition: color 0.3s ease;\n    }\n    \n    .counter-display.positive .counter-value {\n        color: var(--success);\n    }\n    \n    .counter-display.negative .counter-value {\n        color: var(--danger);\n    }\n    \n    .counter-display.zero .counter-value {\n        color: var(--primary);\n    }\n    \n    .counter-label {\n        font-size: 1.2rem;\n        color: #718096;\n        margin-top: 10px;\n        text-transform: uppercase;\n        letter-spacing: 2px;\n    }\n    \n    .quick-actions {\n        display: flex;\n        justify-content: center;\n        gap: 10px;\n        margin-bottom: 30px;\n    }\n    \n    .quick-btn {\n        background: #f7fafc;\n        border: 2px solid #e2e8f0;\n        border-radius: 10px;\n        padding: 8px 16px;\n        font-size: 0.9rem;\n        font-weight: 600;\n        color: #4a5568;\n        cursor: pointer;\n        transition: all 0.2s ease;\n    }\n    \n    .quick-btn:hover {\n        background: var(--primary);\n        color: white;\n        border-color: var(--primary);\n        transform: translateY(-2px);\n    }\n    \n    .main-controls {\n        display: flex;\n        gap: 15px;\n        justify-content: center;\n        margin-bottom: 40px;\n    }\n    \n    .btn {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding: 12px 24px;\n        border: none;\n        border-radius: 15px;\n        font-size: 1rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        color: white;\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);\n    }\n    \n    .btn-icon {\n        font-size: 1.5rem;\n        line-height: 1;\n    }\n    \n    .btn-increment {\n        background: linear-gradient(135deg, var(--success), #059669);\n    }\n    \n    .btn-increment:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);\n    }\n    \n    .btn-decrement {\n        background: linear-gradient(135deg, var(--danger), #dc2626);\n    }\n    \n    .btn-decrement:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);\n    }\n    \n    .btn-reset {\n        background: linear-gradient(135deg, var(--warning), #d97706);\n    }\n    \n    .btn-reset:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);\n    }\n    \n    .stats {\n        display: grid;\n        grid-template-columns: repeat(3, 1fr);\n        gap: 20px;\n        margin-bottom: 30px;\n    }\n    \n    .stat {\n        text-align: center;\n        padding: 15px;\n        background: #f7fafc;\n        border-radius: 10px;\n    }\n    \n    .stat-label {\n        font-size: 0.8rem;\n        color: #718096;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        margin-bottom: 5px;\n    }\n    \n    .stat-value {\n        font-size: 1.5rem;\n        font-weight: 700;\n        color: var(--primary);\n    }\n    \n    footer {\n        text-align: center;\n        color: #718096;\n        font-size: 0.9rem;\n    }\n    \n    footer a {\n        color: var(--primary);\n        text-decoration: none;\n        font-weight: 600;\n        transition: color 0.2s ease;\n    }\n    \n    footer a:hover {\n        color: var(--primary-dark);\n    }\n    \n    @media (max-width: 600px) {\n        h1 {\n            font-size: 2rem;\n        }\n        \n        .counter-value {\n            font-size: 4rem;\n        }\n        \n        .main-controls {\n            flex-direction: column;\n        }\n        \n        .btn {\n            width: 100%;\n            justify-content: center;\n        }\n        \n        .stats {\n            grid-template-columns: 1fr;\n        }\n    }\n\"#;\n\n#[wasm_bindgen(start)]\npub fn main() {\n    web_sys::console::log_1(\u0026\"Beautiful Layer9 Counter starting...\".into());\n    mount(Box::new(BeautifulCounter), \"root\");\n    web_sys::console::log_1(\u0026\"Beautiful Layer9 Counter mounted successfully!\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","counter","src","lib.rs"],"content":"//! Layer9 Counter Example - Beautiful Reactive Counter\n//!\n//! A stunning counter showcasing Layer9's reactive features with modern UI design\n\nuse layer9_core::prelude::*;\nuse layer9_core::hooks::use_state;\nuse layer9_core::reactive_v2::mount;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\n\n// Use `wee_alloc` as the global allocator for smaller bundle size\n#[global_allocator]\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;\n\n// Beautiful counter component\nstruct CounterApp;\n\nimpl Component for CounterApp {\n    fn render(\u0026self) -\u003e Element {\n        let (count, set_count) = use_state(0i32);\n        let (animation_class, set_animation_class) = use_state(String::new());\n        \n        // Helper to trigger animation\n        let trigger_animation = {\n            let set_animation_class = set_animation_class.clone();\n            move |direction: \u0026str| {\n                set_animation_class(format!(\"animate-{}\", direction));\n                // Reset animation class after animation completes\n                let set_animation_class_clone = set_animation_class.clone();\n                web_sys::window().unwrap().set_timeout_with_callback_and_timeout_and_arguments_0(\n                    wasm_bindgen::closure::Closure::wrap(Box::new(move || {\n                        set_animation_class_clone(String::new());\n                    }) as Box\u003cdyn FnMut()\u003e).as_ref().unchecked_ref(),\n                    300\n                ).unwrap();\n            }\n        };\n        \n        let increment = {\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(count + 1);\n                trigger_animation(\"up\");\n            }\n        };\n        \n        let decrement = {\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(count - 1);\n                trigger_animation(\"down\");\n            }\n        };\n        \n        let increment_by = |amount: i32| {\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(count + amount);\n                trigger_animation(\"up\");\n            }\n        };\n        \n        let reset = {\n            let set_count = set_count.clone();\n            let trigger_animation = trigger_animation.clone();\n            move || {\n                set_count(0);\n                trigger_animation(\"reset\");\n            }\n        };\n        \n        // Determine counter color based on value\n        let counter_class = match count.cmp(\u00260) {\n            std::cmp::Ordering::Greater =\u003e \"positive\",\n            std::cmp::Ordering::Less =\u003e \"negative\",\n            std::cmp::Ordering::Equal =\u003e \"zero\",\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"beautiful-counter\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                // Inline styles\n                Element::Node {\n                    tag: \"style\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(BEAUTIFUL_STYLES.to_string())],\n                },\n                \n                // Background decoration\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"bg-decoration\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"circle circle-1\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"circle circle-2\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"circle circle-3\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                    ],\n                },\n                \n                // Main content\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"counter-content\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        // Header\n                        Element::Node {\n                            tag: \"header\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Node {\n                                    tag: \"h1\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"gradient-text\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Layer9\".to_string())],\n                                        },\n                                        Element::Text(\" Counter\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"p\".to_string(),\n                                    props: Props {\n                                        class: Some(\"subtitle\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Beautiful reactive state management\".to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Counter display\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(format!(\"counter-display {} {}\", counter_class, animation_class)),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"counter-value\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(count.to_string())],\n                                },\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"counter-label\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(if count.abs() == 1 { \"click\" } else { \"clicks\" }.to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Quick actions\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"quick-actions\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                create_quick_button(\"-10\", increment_by(-10)),\n                                create_quick_button(\"-5\", increment_by(-5)),\n                                create_quick_button(\"+5\", increment_by(5)),\n                                create_quick_button(\"+10\", increment_by(10)),\n                            ],\n                        },\n                        \n                        // Main controls\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"main-controls\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"btn btn-decrement\".to_string()),\n                                        on_click: Some(Rc::new(decrement)),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn-icon\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"−\".to_string())],\n                                        },\n                                        Element::Text(\"Decrement\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"btn btn-reset\".to_string()),\n                                        on_click: Some(Rc::new(reset)),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn-icon\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"↺\".to_string())],\n                                        },\n                                        Element::Text(\"Reset\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"btn btn-increment\".to_string()),\n                                        on_click: Some(Rc::new(increment)),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"btn-icon\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"+\".to_string())],\n                                        },\n                                        Element::Text(\"Increment\".to_string()),\n                                    ],\n                                },\n                            ],\n                        },\n                        \n                        // Statistics\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"stats\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                create_stat(\"Status\", match count.cmp(\u00260) { std::cmp::Ordering::Greater =\u003e \"Positive\", std::cmp::Ordering::Less =\u003e \"Negative\", std::cmp::Ordering::Equal =\u003e \"Zero\" }),\n                                create_stat(\"Distance from zero\", \u0026count.abs().to_string()),\n                                create_stat(\"Square\", \u0026(count * count).to_string()),\n                            ],\n                        },\n                        \n                        // Footer\n                        Element::Node {\n                            tag: \"footer\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Text(\"Built with \".to_string()),\n                                Element::Node {\n                                    tag: \"a\".to_string(),\n                                    props: Props {\n                                        attributes: vec![\n                                            (\"href\".to_string(), \"https://github.com/anthropics/layer9\".to_string()),\n                                            (\"target\".to_string(), \"_blank\".to_string()),\n                                        ],\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Layer9\".to_string())],\n                                },\n                                Element::Text(\" • Reactive Rust Web Framework\".to_string()),\n                            ],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\nfn create_quick_button(label: \u0026str, handler: impl Fn() + 'static) -\u003e Element {\n    Element::Node {\n        tag: \"button\".to_string(),\n        props: Props {\n            class: Some(\"quick-btn\".to_string()),\n            on_click: Some(Rc::new(handler)),\n            ..Default::default()\n        },\n        children: vec![Element::Text(label.to_string())],\n    }\n}\n\nfn create_stat(label: \u0026str, value: \u0026str) -\u003e Element {\n    Element::Node {\n        tag: \"div\".to_string(),\n        props: Props {\n            class: Some(\"stat\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"stat-label\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![Element::Text(label.to_string())],\n            },\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"stat-value\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![Element::Text(value.to_string())],\n            },\n        ],\n    }\n}\n\nconst BEAUTIFUL_STYLES: \u0026str = r#\"\n    :root {\n        --primary: #6366f1;\n        --primary-light: #818cf8;\n        --primary-dark: #4f46e5;\n        --secondary: #ec4899;\n        --secondary-light: #f472b6;\n        --success: #10b981;\n        --danger: #ef4444;\n        --warning: #f59e0b;\n        --bg-gradient-1: #667eea;\n        --bg-gradient-2: #764ba2;\n        --bg-gradient-3: #f093fb;\n    }\n    \n    * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n    }\n    \n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n        background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-3) 100%);\n        min-height: 100vh;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n    }\n    \n    .beautiful-counter {\n        position: relative;\n        width: 100%;\n        max-width: 500px;\n        margin: 0 20px;\n    }\n    \n    .bg-decoration {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        overflow: hidden;\n    }\n    \n    .circle {\n        position: absolute;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.1);\n        filter: blur(60px);\n        animation: float 20s infinite ease-in-out;\n    }\n    \n    .circle-1 {\n        width: 400px;\n        height: 400px;\n        top: -200px;\n        left: -100px;\n        animation-delay: 0s;\n    }\n    \n    .circle-2 {\n        width: 300px;\n        height: 300px;\n        bottom: -150px;\n        right: -100px;\n        animation-delay: 5s;\n    }\n    \n    .circle-3 {\n        width: 250px;\n        height: 250px;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        animation-delay: 10s;\n    }\n    \n    @keyframes float {\n        0%, 100% { transform: translate(0, 0) scale(1); }\n        33% { transform: translate(30px, -30px) scale(1.1); }\n        66% { transform: translate(-20px, 20px) scale(0.9); }\n    }\n    \n    .counter-content {\n        background: rgba(255, 255, 255, 0.95);\n        backdrop-filter: blur(20px);\n        border-radius: 30px;\n        padding: 40px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);\n        position: relative;\n        z-index: 1;\n    }\n    \n    header {\n        text-align: center;\n        margin-bottom: 40px;\n    }\n    \n    h1 {\n        font-size: 2.5rem;\n        font-weight: 800;\n        color: #1a202c;\n        margin-bottom: 10px;\n    }\n    \n    .gradient-text {\n        background: linear-gradient(135deg, var(--primary), var(--secondary));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n    }\n    \n    .subtitle {\n        color: #718096;\n        font-size: 1.1rem;\n    }\n    \n    .counter-display {\n        text-align: center;\n        margin: 40px 0;\n        transition: transform 0.3s ease;\n    }\n    \n    .counter-display.animate-up {\n        animation: bounceUp 0.3s ease;\n    }\n    \n    .counter-display.animate-down {\n        animation: bounceDown 0.3s ease;\n    }\n    \n    .counter-display.animate-reset {\n        animation: spin 0.5s ease;\n    }\n    \n    @keyframes bounceUp {\n        0% { transform: translateY(0); }\n        50% { transform: translateY(-10px); }\n        100% { transform: translateY(0); }\n    }\n    \n    @keyframes bounceDown {\n        0% { transform: translateY(0); }\n        50% { transform: translateY(10px); }\n        100% { transform: translateY(0); }\n    }\n    \n    @keyframes spin {\n        0% { transform: rotate(0deg) scale(1); }\n        50% { transform: rotate(180deg) scale(0.8); }\n        100% { transform: rotate(360deg) scale(1); }\n    }\n    \n    .counter-value {\n        font-size: 5rem;\n        font-weight: 800;\n        line-height: 1;\n        transition: color 0.3s ease;\n    }\n    \n    .counter-display.positive .counter-value {\n        color: var(--success);\n    }\n    \n    .counter-display.negative .counter-value {\n        color: var(--danger);\n    }\n    \n    .counter-display.zero .counter-value {\n        color: var(--primary);\n    }\n    \n    .counter-label {\n        font-size: 1.2rem;\n        color: #718096;\n        margin-top: 10px;\n        text-transform: uppercase;\n        letter-spacing: 2px;\n    }\n    \n    .quick-actions {\n        display: flex;\n        justify-content: center;\n        gap: 10px;\n        margin-bottom: 30px;\n    }\n    \n    .quick-btn {\n        background: #f7fafc;\n        border: 2px solid #e2e8f0;\n        border-radius: 10px;\n        padding: 8px 16px;\n        font-size: 0.9rem;\n        font-weight: 600;\n        color: #4a5568;\n        cursor: pointer;\n        transition: all 0.2s ease;\n    }\n    \n    .quick-btn:hover {\n        background: var(--primary);\n        color: white;\n        border-color: var(--primary);\n        transform: translateY(-2px);\n    }\n    \n    .main-controls {\n        display: flex;\n        gap: 15px;\n        justify-content: center;\n        margin-bottom: 40px;\n    }\n    \n    .btn {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding: 12px 24px;\n        border: none;\n        border-radius: 15px;\n        font-size: 1rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        color: white;\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);\n    }\n    \n    .btn-icon {\n        font-size: 1.5rem;\n        line-height: 1;\n    }\n    \n    .btn-increment {\n        background: linear-gradient(135deg, var(--success), #059669);\n    }\n    \n    .btn-increment:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);\n    }\n    \n    .btn-decrement {\n        background: linear-gradient(135deg, var(--danger), #dc2626);\n    }\n    \n    .btn-decrement:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);\n    }\n    \n    .btn-reset {\n        background: linear-gradient(135deg, var(--warning), #d97706);\n    }\n    \n    .btn-reset:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);\n    }\n    \n    .stats {\n        display: grid;\n        grid-template-columns: repeat(3, 1fr);\n        gap: 20px;\n        margin-bottom: 30px;\n    }\n    \n    .stat {\n        text-align: center;\n        padding: 15px;\n        background: #f7fafc;\n        border-radius: 10px;\n    }\n    \n    .stat-label {\n        font-size: 0.8rem;\n        color: #718096;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        margin-bottom: 5px;\n    }\n    \n    .stat-value {\n        font-size: 1.5rem;\n        font-weight: 700;\n        color: var(--primary);\n    }\n    \n    footer {\n        text-align: center;\n        color: #718096;\n        font-size: 0.9rem;\n    }\n    \n    footer a {\n        color: var(--primary);\n        text-decoration: none;\n        font-weight: 600;\n        transition: color 0.2s ease;\n    }\n    \n    footer a:hover {\n        color: var(--primary-dark);\n    }\n    \n    @media (max-width: 600px) {\n        h1 {\n            font-size: 2rem;\n        }\n        \n        .counter-value {\n            font-size: 4rem;\n        }\n        \n        .main-controls {\n            flex-direction: column;\n        }\n        \n        .btn {\n            width: 100%;\n            justify-content: center;\n        }\n        \n        .stats {\n            grid-template-columns: 1fr;\n        }\n    }\n\"#;\n\n#[wasm_bindgen(start)]\npub fn main() -\u003e Result\u003c(), JsValue\u003e {\n    // Set panic hook for better error messages\n    console_error_panic_hook::set_once();\n\n    // Hide loading indicator\n    if let Some(window) = web_sys::window() {\n        if let Some(document) = window.document() {\n            if let Some(loading) = document.query_selector(\".loading\").ok().flatten() {\n                if let Ok(element) = loading.dyn_into::\u003cweb_sys::HtmlElement\u003e() {\n                    element.style().set_property(\"display\", \"none\").ok();\n                }\n            }\n        }\n    }\n\n    // Create and mount the app using the reactive renderer\n    mount(Box::new(CounterApp), \"root\");\n\n    // Log success\n    web_sys::console::log_1(\u0026\"Layer9 Counter App initialized with reactive rendering!\".into());\n\n    Ok(())\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","counter","tests","web.rs"],"content":"//! Test suite for the Web and headless browsers.\n\n#![cfg(target_arch = \"wasm32\")]\n\nextern crate wasm_bindgen_test;\nuse wasm_bindgen_test::*;\n\nuse layer9_core::component::{Component, State};\nuse layer9_example_counter::*;\n\nwasm_bindgen_test_configure!(run_in_browser);\n\n#[wasm_bindgen_test]\nfn test_counter_initial_state() {\n    // Test that counter starts at 0\n    let count_state = State::new(0);\n    assert_eq!(count_state.get(), 0);\n}\n\n#[wasm_bindgen_test]\nfn test_counter_increment() {\n    // Test increment functionality\n    let count_state = State::new(0);\n    count_state.set(count_state.get() + 1);\n    assert_eq!(count_state.get(), 1);\n}\n\n#[wasm_bindgen_test]\nfn test_counter_decrement() {\n    // Test decrement functionality\n    let count_state = State::new(5);\n    count_state.set(count_state.get() - 1);\n    assert_eq!(count_state.get(), 4);\n}\n\n#[wasm_bindgen_test]\nfn test_counter_reset() {\n    // Test reset functionality\n    let count_state = State::new(10);\n    count_state.set(0);\n    assert_eq!(count_state.get(), 0);\n}\n\n#[wasm_bindgen_test]\nfn test_component_render() {\n    // Test that component can render without panicking\n    use layer9_core::component::Element;\n    \n    let element = Element::Node {\n        tag: \"div\".to_string(),\n        props: layer9_core::component::Props::default(),\n        children: vec![\n            Element::Text(\"Test Counter\".to_string())\n        ],\n    };\n    \n    // Convert to DOM should not panic\n    let _dom_node = element.to_dom();\n}\n\n#[wasm_bindgen_test]\nasync fn test_state_update_callback() {\n    use std::rc::Rc;\n    use std::cell::RefCell;\n    \n    // Test that state update callbacks are triggered\n    let callback_called = Rc::new(RefCell::new(false));\n    let callback_called_clone = callback_called.clone();\n    \n    let count_state = State::new(0);\n    count_state.set_update_callback(Box::new(move || {\n        *callback_called_clone.borrow_mut() = true;\n    }));\n    \n    // Trigger state update\n    count_state.set(1);\n    \n    // Callback should have been called\n    assert!(*callback_called.borrow());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","css-showcase","src","lib.rs"],"content":"//! CSS Showcase - Demonstrates all CSS-in-Rust features\n//!\n//! This example showcases:\n//! - Runtime CSS generation\n//! - Hover, focus, and active states\n//! - Media queries and responsive design\n//! - CSS variables and theming\n//! - Animations and transitions\n//! - Scoped styles\n\nuse layer9_core::prelude::*;\nuse wasm_bindgen::prelude::*;\nuse std::rc::Rc;\n\n/// Theme switcher component\nstruct ThemeSwitcher {\n    is_dark: State\u003cbool\u003e,\n}\n\nimpl Component for ThemeSwitcher {\n    fn render(\u0026self) -\u003e Element {\n        let is_dark = self.is_dark.get();\n        let toggle_theme = {\n            let state = self.is_dark.clone();\n            move || {\n                let new_theme = !state.get();\n                state.set(new_theme);\n                \n                // Update CSS variables\n                let mut vars = CssVariables::new();\n                if new_theme {\n                    vars.set(\"background\", \"#1a202c\");\n                    vars.set(\"text\", \"#e2e8f0\");\n                } else {\n                    vars.set(\"background\", \"#ffffff\");\n                    vars.set(\"text\", \"#2d3748\");\n                }\n            }\n        };\n\n        // Create a styled button with hover effects\n        let button_style = CssBuilder::new()\n            .properties(css_props! {\n                \"position\" =\u003e \"fixed\",\n                \"top\" =\u003e \"1rem\",\n                \"right\" =\u003e \"1rem\",\n                \"padding\" =\u003e \"0.75rem 1.5rem\",\n                \"background-color\" =\u003e if is_dark { \"#4a5568\" } else { \"#e2e8f0\" },\n                \"color\" =\u003e if is_dark { \"#e2e8f0\" } else { \"#2d3748\" },\n                \"border\" =\u003e \"none\",\n                \"border-radius\" =\u003e \"9999px\",\n                \"cursor\" =\u003e \"pointer\",\n                \"transition\" =\u003e \"all 0.3s ease\",\n                \"font-weight\" =\u003e \"600\",\n                \"z-index\" =\u003e \"1000\"\n            })\n            .hover(css_props! {\n                \"transform\" =\u003e \"scale(1.05)\",\n                \"box-shadow\" =\u003e \"0 4px 6px rgba(0, 0, 0, 0.1)\"\n            })\n            .active(css_props! {\n                \"transform\" =\u003e \"scale(0.95)\"\n            });\n\n        Element::Node {\n            tag: \"button\".to_string(),\n            props: Props {\n                class: Some(button_style.build()),\n                on_click: Some(Rc::new(toggle_theme)),\n                ..Default::default()\n            },\n            children: vec![Element::Text(\n                if is_dark { \"☀️ Light Mode\" } else { \"🌙 Dark Mode\" }.to_string()\n            )],\n        }\n    }\n}\n\n/// Hero section with animated gradient\nstruct HeroSection;\n\nimpl Component for HeroSection {\n    fn render(\u0026self) -\u003e Element {\n        // Create gradient animation\n        let gradient_animation = Animation::new(\"gradient-shift\".to_string())\n            .keyframe(\"0%\", css_props! {\n                \"background-position\" =\u003e \"0% 50%\"\n            })\n            .keyframe(\"50%\", css_props! {\n                \"background-position\" =\u003e \"100% 50%\"\n            })\n            .keyframe(\"100%\", css_props! {\n                \"background-position\" =\u003e \"0% 50%\"\n            });\n\n        let hero_style = CssBuilder::new()\n            .properties(css_props! {\n                \"min-height\" =\u003e \"60vh\",\n                \"display\" =\u003e \"flex\",\n                \"flex-direction\" =\u003e \"column\",\n                \"align-items\" =\u003e \"center\",\n                \"justify-content\" =\u003e \"center\",\n                \"background\" =\u003e \"linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)\",\n                \"background-size\" =\u003e \"200% 200%\",\n                \"animation\" =\u003e \"gradient-shift 8s ease infinite\",\n                \"color\" =\u003e \"white\",\n                \"text-align\" =\u003e \"center\",\n                \"padding\" =\u003e \"2rem\"\n            })\n            .animation(gradient_animation);\n\n        let title_style = CssBuilder::new()\n            .properties(css_props! {\n                \"font-size\" =\u003e \"3.5rem\",\n                \"font-weight\" =\u003e \"800\",\n                \"margin-bottom\" =\u003e \"1rem\",\n                \"text-shadow\" =\u003e \"2px 2px 4px rgba(0, 0, 0, 0.3)\"\n            })\n            .breakpoint(Breakpoint::Md, css_props! {\n                \"font-size\" =\u003e \"2.5rem\"\n            })\n            .breakpoint(Breakpoint::Sm, css_props! {\n                \"font-size\" =\u003e \"2rem\"\n            });\n\n        let subtitle_style = CssBuilder::new()\n            .properties(css_props! {\n                \"font-size\" =\u003e \"1.5rem\",\n                \"opacity\" =\u003e \"0.9\",\n                \"max-width\" =\u003e \"600px\"\n            });\n\n        Element::Node {\n            tag: \"section\".to_string(),\n            props: Props {\n                class: Some(hero_style.build()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props {\n                        class: Some(title_style.build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"CSS-in-Rust Showcase\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props {\n                        class: Some(subtitle_style.build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\n                        \"Experience the power of runtime CSS generation with hover states, \\\n                         media queries, animations, and more!\".to_string()\n                    )],\n                },\n            ],\n        }\n    }\n}\n\n/// Interactive card grid\nstruct CardGrid;\n\nimpl Component for CardGrid {\n    fn render(\u0026self) -\u003e Element {\n        let grid_style = CssBuilder::new()\n            .properties(css_props! {\n                \"display\" =\u003e \"grid\",\n                \"grid-template-columns\" =\u003e \"repeat(auto-fit, minmax(300px, 1fr))\",\n                \"gap\" =\u003e \"2rem\",\n                \"padding\" =\u003e \"3rem\",\n                \"background-color\" =\u003e \"var(--background)\"\n            });\n\n        let cards = vec![\n            (\"🎨\", \"Dynamic Styling\", \"Runtime CSS generation with type-safe builders\"),\n            (\"🖱️\", \"Interactive States\", \"Hover, focus, and active pseudo-classes\"),\n            (\"📱\", \"Responsive Design\", \"Media queries and breakpoint utilities\"),\n            (\"🎭\", \"Theming\", \"CSS variables for dynamic theme switching\"),\n            (\"✨\", \"Animations\", \"Smooth transitions and keyframe animations\"),\n            (\"🔒\", \"Scoped Styles\", \"Automatically generated unique class names\"),\n        ];\n\n        Element::Node {\n            tag: \"section\".to_string(),\n            props: Props {\n                class: Some(grid_style.build()),\n                ..Default::default()\n            },\n            children: cards.into_iter().map(|(icon, title, desc)| {\n                Card { icon, title, description: desc }.render()\n            }).collect(),\n        }\n    }\n}\n\n/// Individual card component\nstruct Card {\n    icon: \u0026'static str,\n    title: \u0026'static str,\n    description: \u0026'static str,\n}\n\nimpl Component for Card {\n    fn render(\u0026self) -\u003e Element {\n        let card_style = CssBuilder::new()\n            .prefix(\"card\")\n            .properties(css_props! {\n                \"background-color\" =\u003e \"white\",\n                \"border-radius\" =\u003e \"1rem\",\n                \"padding\" =\u003e \"2rem\",\n                \"box-shadow\" =\u003e \"0 4px 6px rgba(0, 0, 0, 0.1)\",\n                \"transition\" =\u003e \"all 0.3s ease\",\n                \"cursor\" =\u003e \"pointer\",\n                \"position\" =\u003e \"relative\",\n                \"overflow\" =\u003e \"hidden\"\n            })\n            .hover(css_props! {\n                \"transform\" =\u003e \"translateY(-8px) scale(1.02)\",\n                \"box-shadow\" =\u003e \"0 12px 20px rgba(0, 0, 0, 0.15)\"\n            })\n            .pseudo(\"before\", css_props! {\n                \"content\" =\u003e \"''\",\n                \"position\" =\u003e \"absolute\",\n                \"top\" =\u003e \"0\",\n                \"left\" =\u003e \"0\",\n                \"width\" =\u003e \"100%\",\n                \"height\" =\u003e \"4px\",\n                \"background\" =\u003e \"linear-gradient(90deg, #667eea, #764ba2)\",\n                \"transform\" =\u003e \"scaleX(0)\",\n                \"transform-origin\" =\u003e \"left\",\n                \"transition\" =\u003e \"transform 0.3s ease\"\n            })\n            .pseudo(\"hover:before\", css_props! {\n                \"transform\" =\u003e \"scaleX(1)\"\n            })\n            .media(\"(prefers-color-scheme: dark)\", css_props! {\n                \"background-color\" =\u003e \"#2d3748\",\n                \"color\" =\u003e \"#e2e8f0\"\n            });\n\n        let icon_style = CssBuilder::new()\n            .properties(css_props! {\n                \"font-size\" =\u003e \"3rem\",\n                \"margin-bottom\" =\u003e \"1rem\",\n                \"display\" =\u003e \"block\"\n            });\n\n        let title_style = CssBuilder::new()\n            .properties(css_props! {\n                \"font-size\" =\u003e \"1.5rem\",\n                \"font-weight\" =\u003e \"700\",\n                \"margin-bottom\" =\u003e \"0.5rem\",\n                \"color\" =\u003e \"var(--text)\"\n            });\n\n        let desc_style = CssBuilder::new()\n            .properties(css_props! {\n                \"color\" =\u003e \"#718096\",\n                \"line-height\" =\u003e \"1.6\"\n            })\n            .media(\"(prefers-color-scheme: dark)\", css_props! {\n                \"color\" =\u003e \"#a0aec0\"\n            });\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(card_style.build()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"span\".to_string(),\n                    props: Props {\n                        class: Some(icon_style.build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(self.icon.to_string())],\n                },\n                Element::Node {\n                    tag: \"h3\".to_string(),\n                    props: Props {\n                        class: Some(title_style.build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(self.title.to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props {\n                        class: Some(desc_style.build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(self.description.to_string())],\n                },\n            ],\n        }\n    }\n}\n\n/// Button showcase section\nstruct ButtonShowcase;\n\nimpl Component for ButtonShowcase {\n    fn render(\u0026self) -\u003e Element {\n        let section_style = CssBuilder::new()\n            .properties(css_props! {\n                \"padding\" =\u003e \"3rem\",\n                \"background-color\" =\u003e \"#f7fafc\",\n                \"text-align\" =\u003e \"center\"\n            })\n            .media(\"(prefers-color-scheme: dark)\", css_props! {\n                \"background-color\" =\u003e \"#1a202c\"\n            });\n\n        let button_container = CssBuilder::new()\n            .properties(css_props! {\n                \"display\" =\u003e \"flex\",\n                \"gap\" =\u003e \"1rem\",\n                \"justify-content\" =\u003e \"center\",\n                \"flex-wrap\" =\u003e \"wrap\",\n                \"margin-top\" =\u003e \"2rem\"\n            });\n\n        Element::Node {\n            tag: \"section\".to_string(),\n            props: Props {\n                class: Some(section_style.build()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h2\".to_string(),\n                    props: Props {\n                        class: Some(styles::heading().build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"Interactive Buttons\".to_string())],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(button_container.build()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"button\".to_string(),\n                            props: Props {\n                                class: Some(styles::button_primary().build()),\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(\"Primary Button\".to_string())],\n                        },\n                        SecondaryButton.render(),\n                        GhostButton.render(),\n                        GradientButton.render(),\n                    ],\n                },\n            ],\n        }\n    }\n}\n\n/// Secondary button style\nstruct SecondaryButton;\n\nimpl Component for SecondaryButton {\n    fn render(\u0026self) -\u003e Element {\n        let style = CssBuilder::new()\n            .properties(css_props! {\n                \"padding\" =\u003e \"0.5rem 1rem\",\n                \"background-color\" =\u003e \"transparent\",\n                \"color\" =\u003e \"var(--primary)\",\n                \"border\" =\u003e \"2px solid var(--primary)\",\n                \"border-radius\" =\u003e \"0.375rem\",\n                \"font-size\" =\u003e \"1rem\",\n                \"font-weight\" =\u003e \"500\",\n                \"cursor\" =\u003e \"pointer\",\n                \"transition\" =\u003e \"all 0.2s ease\"\n            })\n            .hover(css_props! {\n                \"background-color\" =\u003e \"var(--primary)\",\n                \"color\" =\u003e \"white\",\n                \"transform\" =\u003e \"translateY(-2px)\"\n            })\n            .focus(css_props! {\n                \"outline\" =\u003e \"none\",\n                \"box-shadow\" =\u003e \"0 0 0 3px rgba(102, 126, 234, 0.3)\"\n            });\n\n        Element::Node {\n            tag: \"button\".to_string(),\n            props: Props {\n                class: Some(style.build()),\n                ..Default::default()\n            },\n            children: vec![Element::Text(\"Secondary Button\".to_string())],\n        }\n    }\n}\n\n/// Ghost button style\nstruct GhostButton;\n\nimpl Component for GhostButton {\n    fn render(\u0026self) -\u003e Element {\n        let style = CssBuilder::new()\n            .properties(css_props! {\n                \"padding\" =\u003e \"0.5rem 1rem\",\n                \"background-color\" =\u003e \"transparent\",\n                \"color\" =\u003e \"#718096\",\n                \"border\" =\u003e \"none\",\n                \"font-size\" =\u003e \"1rem\",\n                \"font-weight\" =\u003e \"500\",\n                \"cursor\" =\u003e \"pointer\",\n                \"position\" =\u003e \"relative\",\n                \"transition\" =\u003e \"color 0.2s ease\"\n            })\n            .hover(css_props! {\n                \"color\" =\u003e \"var(--primary)\"\n            })\n            .pseudo(\"after\", css_props! {\n                \"content\" =\u003e \"''\",\n                \"position\" =\u003e \"absolute\",\n                \"bottom\" =\u003e \"0\",\n                \"left\" =\u003e \"50%\",\n                \"width\" =\u003e \"0\",\n                \"height\" =\u003e \"2px\",\n                \"background-color\" =\u003e \"var(--primary)\",\n                \"transform\" =\u003e \"translateX(-50%)\",\n                \"transition\" =\u003e \"width 0.3s ease\"\n            })\n            .pseudo(\"hover:after\", css_props! {\n                \"width\" =\u003e \"100%\"\n            });\n\n        Element::Node {\n            tag: \"button\".to_string(),\n            props: Props {\n                class: Some(style.build()),\n                ..Default::default()\n            },\n            children: vec![Element::Text(\"Ghost Button\".to_string())],\n        }\n    }\n}\n\n/// Gradient button with animation\nstruct GradientButton;\n\nimpl Component for GradientButton {\n    fn render(\u0026self) -\u003e Element {\n        let pulse_animation = Animation::new(\"pulse\".to_string())\n            .keyframe(\"0%\", css_props! {\n                \"box-shadow\" =\u003e \"0 0 0 0 rgba(102, 126, 234, 0.7)\"\n            })\n            .keyframe(\"70%\", css_props! {\n                \"box-shadow\" =\u003e \"0 0 0 10px rgba(102, 126, 234, 0)\"\n            })\n            .keyframe(\"100%\", css_props! {\n                \"box-shadow\" =\u003e \"0 0 0 0 rgba(102, 126, 234, 0)\"\n            });\n\n        let style = CssBuilder::new()\n            .properties(css_props! {\n                \"padding\" =\u003e \"0.5rem 1rem\",\n                \"background\" =\u003e \"linear-gradient(135deg, #667eea, #764ba2)\",\n                \"color\" =\u003e \"white\",\n                \"border\" =\u003e \"none\",\n                \"border-radius\" =\u003e \"0.375rem\",\n                \"font-size\" =\u003e \"1rem\",\n                \"font-weight\" =\u003e \"500\",\n                \"cursor\" =\u003e \"pointer\",\n                \"position\" =\u003e \"relative\",\n                \"overflow\" =\u003e \"hidden\",\n                \"transition\" =\u003e \"transform 0.2s ease\"\n            })\n            .hover(css_props! {\n                \"transform\" =\u003e \"translateY(-2px)\",\n                \"animation\" =\u003e \"pulse 1.5s infinite\"\n            })\n            .animation(pulse_animation);\n\n        Element::Node {\n            tag: \"button\".to_string(),\n            props: Props {\n                class: Some(style.build()),\n                ..Default::default()\n            },\n            children: vec![Element::Text(\"Gradient Button\".to_string())],\n        }\n    }\n}\n\n/// Main app component\nstruct CssShowcaseApp {\n    theme_switcher: ThemeSwitcher,\n}\n\nimpl CssShowcaseApp {\n    fn new() -\u003e Self {\n        Self {\n            theme_switcher: ThemeSwitcher {\n                is_dark: use_state(|| false),\n            },\n        }\n    }\n}\n\nimpl Component for CssShowcaseApp {\n    fn render(\u0026self) -\u003e Element {\n        let app_style = CssBuilder::new()\n            .properties(css_props! {\n                \"min-height\" =\u003e \"100vh\",\n                \"background-color\" =\u003e \"var(--background)\",\n                \"color\" =\u003e \"var(--text)\",\n                \"transition\" =\u003e \"background-color 0.3s ease, color 0.3s ease\"\n            });\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(app_style.build()),\n                ..Default::default()\n            },\n            children: vec![\n                self.theme_switcher.render(),\n                HeroSection.render(),\n                CardGrid.render(),\n                ButtonShowcase.render(),\n                ResponsiveGrid.render(),\n            ],\n        }\n    }\n}\n\n/// Responsive grid showcase\nstruct ResponsiveGrid;\n\nimpl Component for ResponsiveGrid {\n    fn render(\u0026self) -\u003e Element {\n        let section_style = CssBuilder::new()\n            .properties(css_props! {\n                \"padding\" =\u003e \"3rem\",\n                \"background-color\" =\u003e \"var(--background)\"\n            });\n\n        let grid_style = CssBuilder::new()\n            .properties(css_props! {\n                \"display\" =\u003e \"grid\",\n                \"gap\" =\u003e \"1rem\",\n                \"grid-template-columns\" =\u003e \"1fr\"\n            })\n            .breakpoint(Breakpoint::Sm, css_props! {\n                \"grid-template-columns\" =\u003e \"repeat(2, 1fr)\"\n            })\n            .breakpoint(Breakpoint::Md, css_props! {\n                \"grid-template-columns\" =\u003e \"repeat(3, 1fr)\"\n            })\n            .breakpoint(Breakpoint::Lg, css_props! {\n                \"grid-template-columns\" =\u003e \"repeat(4, 1fr)\"\n            });\n\n        let item_style_class = CssBuilder::new()\n            .properties(css_props! {\n                \"background\" =\u003e \"linear-gradient(135deg, #f093fb, #f5576c)\",\n                \"padding\" =\u003e \"3rem 1rem\",\n                \"border-radius\" =\u003e \"0.5rem\",\n                \"text-align\" =\u003e \"center\",\n                \"color\" =\u003e \"white\",\n                \"font-weight\" =\u003e \"600\",\n                \"transition\" =\u003e \"transform 0.2s ease\"\n            })\n            .hover(css_props! {\n                \"transform\" =\u003e \"scale(1.05)\"\n            })\n            .build();\n\n        Element::Node {\n            tag: \"section\".to_string(),\n            props: Props {\n                class: Some(section_style.build()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h2\".to_string(),\n                    props: Props {\n                        class: Some(styles::heading().build()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"Responsive Grid\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props {\n                        attributes: vec![(\"style\".to_string(), \"text-align: center; margin-bottom: 2rem; color: #718096;\".to_string())],\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"Resize your window to see the grid adapt!\".to_string())],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(grid_style.build()),\n                        ..Default::default()\n                    },\n                    children: (1..=8).map(|i| {\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(item_style_class.clone()),\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(format!(\"Item {}\", i))],\n                        }\n                    }).collect(),\n                },\n            ],\n        }\n    }\n}\n\n/// Entry point\n#[wasm_bindgen(start)]\npub fn main() {\n    // Initialize CSS runtime and inject global styles\n    inject_css_runtime();\n    \n    // Create and mount the app\n    let app = CssShowcaseApp::new();\n    mount(Box::new(app), \"app\");\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","database-crud","src","lib.rs"],"content":"//! Database CRUD Example\n//! Demonstrates real database operations with Layer9\n\nuse layer9_core::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse wasm_bindgen::prelude::*;\nuse std::rc::Rc;\n\n/// User model for database operations\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct User {\n    pub id: Option\u003ci64\u003e,\n    pub username: String,\n    pub email: String,\n    pub created_at: Option\u003cString\u003e,\n    pub updated_at: Option\u003cString\u003e,\n}\n\nimpl Model for User {\n    const TABLE_NAME: \u0026'static str = \"users\";\n}\n\n/// Post model for database operations\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct Post {\n    pub id: Option\u003ci64\u003e,\n    pub user_id: i64,\n    pub title: String,\n    pub content: Option\u003cString\u003e,\n    pub published: bool,\n    pub created_at: Option\u003cString\u003e,\n    pub updated_at: Option\u003cString\u003e,\n}\n\nimpl Model for Post {\n    const TABLE_NAME: \u0026'static str = \"posts\";\n}\n\n/// CRUD operations component\n#[derive(Debug, Clone, Default)]\npub struct CrudApp {\n    users: Vec\u003cUser\u003e,\n    posts: Vec\u003cPost\u003e,\n    selected_user: Option\u003cUser\u003e,\n    new_user: User,\n    new_post: Post,\n    error: Option\u003cString\u003e,\n    loading: bool,\n}\n\nimpl Component for CrudApp {\n    fn render(\u0026self) -\u003e Element {\n        let mut children = vec![\n            Element::Node {\n                tag: \"h1\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Database CRUD Example\".to_string())],\n            }\n        ];\n\n        // Error display\n        if let Some(error) = \u0026self.error {\n            let mut error_props = Props::default();\n            error_props.attributes.push((\"style\".to_string(), \"background: #fee; color: #c00; padding: 10px; margin: 10px 0; border-radius: 4px;\".to_string()));\n            \n            children.push(Element::Node {\n                tag: \"div\".to_string(),\n                props: error_props,\n                children: vec![Element::Text(error.clone())],\n            });\n        }\n\n        // Loading indicator\n        if self.loading {\n            let mut loading_props = Props::default();\n            loading_props.attributes.push((\"style\".to_string(), \"text-align: center; padding: 20px;\".to_string()));\n            \n            children.push(Element::Node {\n                tag: \"div\".to_string(),\n                props: loading_props,\n                children: vec![Element::Text(\"Loading...\".to_string())],\n            });\n        }\n\n        // User section\n        children.push(self.render_user_section());\n\n        // Post section\n        if let Some(user) = \u0026self.selected_user {\n            children.push(self.render_post_section(user));\n        }\n\n        let mut root_props = Props::default();\n        root_props.class = Some(\"crud-app\".to_string());\n        root_props.attributes.push((\"style\".to_string(), \"padding: 20px; max-width: 1200px; margin: 0 auto;\".to_string()));\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: root_props,\n            children,\n        }\n    }\n}\n\nimpl CrudApp {\n    fn render_user_section(\u0026self) -\u003e Element {\n        let mut section_props = Props::default();\n        section_props.class = Some(\"user-section\".to_string());\n        section_props.attributes.push((\"style\".to_string(), \"margin-bottom: 40px;\".to_string()));\n\n        let mut children = vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Users\".to_string())],\n            }\n        ];\n\n        // Create user form\n        children.push(self.render_create_user_form());\n\n        // Users list\n        children.push(self.render_users_list());\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: section_props,\n            children,\n        }\n    }\n\n    fn render_create_user_form(\u0026self) -\u003e Element {\n        let mut form_props = Props::default();\n        form_props.class = Some(\"create-user\".to_string());\n        form_props.attributes.push((\"style\".to_string(), \"background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px;\".to_string()));\n\n        let username_input = {\n            let mut props = Props::default();\n            props.attributes.push((\"type\".to_string(), \"text\".to_string()));\n            props.attributes.push((\"placeholder\".to_string(), \"Username\".to_string()));\n            props.attributes.push((\"value\".to_string(), self.new_user.username.clone()));\n            props.attributes.push((\"style\".to_string(), \"margin-right: 10px; padding: 5px;\".to_string()));\n            \n            Element::Node {\n                tag: \"input\".to_string(),\n                props,\n                children: vec![],\n            }\n        };\n\n        let email_input = {\n            let mut props = Props::default();\n            props.attributes.push((\"type\".to_string(), \"email\".to_string()));\n            props.attributes.push((\"placeholder\".to_string(), \"Email\".to_string()));\n            props.attributes.push((\"value\".to_string(), self.new_user.email.clone()));\n            props.attributes.push((\"style\".to_string(), \"margin-right: 10px; padding: 5px;\".to_string()));\n            \n            Element::Node {\n                tag: \"input\".to_string(),\n                props,\n                children: vec![],\n            }\n        };\n\n        let create_button = {\n            let mut props = Props::default();\n            props.attributes.push((\"style\".to_string(), \"padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;\".to_string()));\n            props.on_click = Some(Rc::new(|| {\n                web_sys::console::log_1(\u0026\"Create user clicked\".into());\n            }));\n            \n            Element::Node {\n                tag: \"button\".to_string(),\n                props,\n                children: vec![Element::Text(\"Create User\".to_string())],\n            }\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: form_props,\n            children: vec![\n                Element::Node {\n                    tag: \"h3\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Create New User\".to_string())],\n                },\n                username_input,\n                email_input,\n                create_button,\n            ],\n        }\n    }\n\n    fn render_users_list(\u0026self) -\u003e Element {\n        let mut list_props = Props::default();\n        list_props.class = Some(\"users-list\".to_string());\n        list_props.attributes.push((\"style\".to_string(), \"display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;\".to_string()));\n\n        let user_cards: Vec\u003cElement\u003e = self.users.iter().map(|user| {\n            self.render_user_card(user)\n        }).collect();\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: list_props,\n            children: user_cards,\n        }\n    }\n\n    fn render_user_card(\u0026self, user: \u0026User) -\u003e Element {\n        let mut card_props = Props::default();\n        card_props.class = Some(\"user-card\".to_string());\n        card_props.attributes.push((\"style\".to_string(), \"border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: white;\".to_string()));\n\n        let view_posts_button = {\n            let mut props = Props::default();\n            props.attributes.push((\"style\".to_string(), \"padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;\".to_string()));\n            \n            Element::Node {\n                tag: \"button\".to_string(),\n                props,\n                children: vec![Element::Text(\"View Posts\".to_string())],\n            }\n        };\n\n        let delete_button = {\n            let mut props = Props::default();\n            props.attributes.push((\"style\".to_string(), \"padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;\".to_string()));\n            \n            Element::Node {\n                tag: \"button\".to_string(),\n                props,\n                children: vec![Element::Text(\"Delete\".to_string())],\n            }\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: card_props,\n            children: vec![\n                Element::Node {\n                    tag: \"h4\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(user.username.clone())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: {\n                        let mut p = Props::default();\n                        p.attributes.push((\"style\".to_string(), \"color: #666; margin: 5px 0;\".to_string()));\n                        p\n                    },\n                    children: vec![Element::Text(user.email.clone())],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: {\n                        let mut p = Props::default();\n                        p.attributes.push((\"style\".to_string(), \"margin-top: 10px;\".to_string()));\n                        p\n                    },\n                    children: vec![view_posts_button, delete_button],\n                },\n            ],\n        }\n    }\n\n    fn render_post_section(\u0026self, user: \u0026User) -\u003e Element {\n        let mut section_props = Props::default();\n        section_props.class = Some(\"posts-section\".to_string());\n\n        let mut children = vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(format!(\"Posts by {}\", user.username))],\n            }\n        ];\n\n        // Create post form\n        children.push(self.render_create_post_form());\n\n        // Posts list\n        children.push(self.render_posts_list());\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: section_props,\n            children,\n        }\n    }\n\n    fn render_create_post_form(\u0026self) -\u003e Element {\n        let mut form_props = Props::default();\n        form_props.class = Some(\"create-post\".to_string());\n        form_props.attributes.push((\"style\".to_string(), \"background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px;\".to_string()));\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: form_props,\n            children: vec![\n                Element::Node {\n                    tag: \"h3\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Create New Post\".to_string())],\n                },\n            ],\n        }\n    }\n\n    fn render_posts_list(\u0026self) -\u003e Element {\n        let mut list_props = Props::default();\n        list_props.class = Some(\"posts-list\".to_string());\n\n        let post_cards: Vec\u003cElement\u003e = self.posts.iter().map(|post| {\n            self.render_post_card(post)\n        }).collect();\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: list_props,\n            children: post_cards,\n        }\n    }\n\n    fn render_post_card(\u0026self, post: \u0026Post) -\u003e Element {\n        let mut card_props = Props::default();\n        card_props.class = Some(\"post-card\".to_string());\n        card_props.attributes.push((\"style\".to_string(), \"border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 10px; background: white;\".to_string()));\n\n        let mut children = vec![\n            Element::Node {\n                tag: \"h4\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(post.title.clone())],\n            }\n        ];\n\n        if let Some(content) = \u0026post.content {\n            children.push(Element::Node {\n                tag: \"p\".to_string(),\n                props: {\n                    let mut p = Props::default();\n                    p.attributes.push((\"style\".to_string(), \"color: #666; margin: 10px 0;\".to_string()));\n                    p\n                },\n                children: vec![Element::Text(content.clone())],\n            });\n        }\n\n        children.push(Element::Node {\n            tag: \"p\".to_string(),\n            props: {\n                let mut p = Props::default();\n                p.attributes.push((\"style\".to_string(), \"font-size: 0.9em; color: #999;\".to_string()));\n                p\n            },\n            children: vec![Element::Text(if post.published { \"Published\" } else { \"Draft\" }.to_string())],\n        });\n\n        let delete_button = {\n            let mut props = Props::default();\n            props.attributes.push((\"style\".to_string(), \"padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;\".to_string()));\n            \n            Element::Node {\n                tag: \"button\".to_string(),\n                props,\n                children: vec![Element::Text(\"Delete\".to_string())],\n            }\n        };\n\n        children.push(delete_button);\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: card_props,\n            children,\n        }\n    }\n\n    /// Load all users from the database\n    pub fn load_users(\u0026mut self) {\n        self.loading = true;\n        self.error = None;\n        \n        wasm_bindgen_futures::spawn_local(async move {\n            let repo = use_repository::\u003cUser\u003e();\n            match repo.find_all().await {\n                Ok(users) =\u003e {\n                    web_sys::console::log_1(\u0026format!(\"Loaded {} users\", users.len()).into());\n                }\n                Err(e) =\u003e {\n                    web_sys::console::error_1(\u0026format!(\"Failed to load users: {:?}\", e).into());\n                }\n            }\n        });\n    }\n    \n    /// Create a new user\n    pub fn create_user(\u0026mut self) {\n        if self.new_user.username.is_empty() || self.new_user.email.is_empty() {\n            self.error = Some(\"Username and email are required\".to_string());\n            return;\n        }\n        \n        let user = self.new_user.clone();\n        self.loading = true;\n        self.error = None;\n        \n        wasm_bindgen_futures::spawn_local(async move {\n            let repo = use_repository::\u003cUser\u003e();\n            match repo.insert(\u0026user).await {\n                Ok(created_user) =\u003e {\n                    web_sys::console::log_1(\u0026format!(\"Created user: {:?}\", created_user).into());\n                }\n                Err(e) =\u003e {\n                    web_sys::console::error_1(\u0026format!(\"Failed to create user: {:?}\", e).into());\n                }\n            }\n        });\n        \n        // Clear form\n        self.new_user = User::default();\n    }\n    \n    /// Delete a user\n    pub fn delete_user(\u0026mut self, id: i64) {\n        self.loading = true;\n        self.error = None;\n        \n        wasm_bindgen_futures::spawn_local(async move {\n            let repo = use_repository::\u003cUser\u003e();\n            match repo.delete(id).await {\n                Ok(_) =\u003e {\n                    web_sys::console::log_1(\u0026format!(\"Deleted user {}\", id).into());\n                }\n                Err(e) =\u003e {\n                    web_sys::console::error_1(\u0026format!(\"Failed to delete user: {:?}\", e).into());\n                }\n            }\n        });\n    }\n    \n    /// Load posts for a specific user\n    pub fn load_user_posts(\u0026mut self, user_id: i64) {\n        self.loading = true;\n        self.error = None;\n        self.posts.clear();\n        \n        wasm_bindgen_futures::spawn_local(async move {\n            let repo = use_repository::\u003cPost\u003e();\n            let query = repo.query().where_eq(\"user_id\", user_id);\n            \n            match query.execute(\u0026use_db()).await {\n                Ok(posts) =\u003e {\n                    web_sys::console::log_1(\u0026format!(\"Loaded {} posts\", posts.len()).into());\n                }\n                Err(e) =\u003e {\n                    web_sys::console::error_1(\u0026format!(\"Failed to load posts: {:?}\", e).into());\n                }\n            }\n        });\n    }\n    \n    /// Create a new post\n    pub fn create_post(\u0026mut self) {\n        if self.new_post.title.is_empty() {\n            self.error = Some(\"Post title is required\".to_string());\n            return;\n        }\n        \n        if let Some(user) = \u0026self.selected_user {\n            let mut post = self.new_post.clone();\n            post.user_id = user.id.unwrap_or(0);\n            \n            self.loading = true;\n            self.error = None;\n            \n            wasm_bindgen_futures::spawn_local(async move {\n                let repo = use_repository::\u003cPost\u003e();\n                match repo.insert(\u0026post).await {\n                    Ok(created_post) =\u003e {\n                        web_sys::console::log_1(\u0026format!(\"Created post: {:?}\", created_post).into());\n                    }\n                    Err(e) =\u003e {\n                        web_sys::console::error_1(\u0026format!(\"Failed to create post: {:?}\", e).into());\n                    }\n                }\n            });\n            \n            // Clear form\n            self.new_post = Post::default();\n        }\n    }\n    \n    /// Delete a post\n    pub fn delete_post(\u0026mut self, id: i64) {\n        self.loading = true;\n        self.error = None;\n        \n        wasm_bindgen_futures::spawn_local(async move {\n            let repo = use_repository::\u003cPost\u003e();\n            match repo.delete(id).await {\n                Ok(_) =\u003e {\n                    web_sys::console::log_1(\u0026format!(\"Deleted post {}\", id).into());\n                }\n                Err(e) =\u003e {\n                    web_sys::console::error_1(\u0026format!(\"Failed to delete post: {:?}\", e).into());\n                }\n            }\n        });\n    }\n}\n\n#[wasm_bindgen(start)]\npub fn main() {\n    // Initialize the app\n    init_renderer();\n    let app = CrudApp::default();\n    mount(Box::new(app), \"app\");\n    queue_current_render();\n    \n    // Load initial data\n    wasm_bindgen_futures::spawn_local(async {\n        let repo = use_repository::\u003cUser\u003e();\n        match repo.find_all().await {\n            Ok(users) =\u003e {\n                web_sys::console::log_1(\u0026format!(\"Initial load: {} users\", users.len()).into());\n            }\n            Err(e) =\u003e {\n                web_sys::console::error_1(\u0026format!(\"Failed to load initial users: {:?}\", e).into());\n            }\n        }\n    });\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","database-crud","src","server.rs"],"content":"//! Server for Database CRUD Example\n\nuse axum::Router;\nuse layer9_core::{\n    db_api::create_db_api_router,\n    db::use_db,\n};\nuse tower_http::cors::CorsLayer;\nuse tower_http::services::ServeDir;\n\n#[tokio::main]\nasync fn main() {\n    // Initialize environment\n    if std::env::var(\"DATABASE_TYPE\").is_err() {\n        std::env::set_var(\"DATABASE_TYPE\", \"sqlite\");\n    }\n    if std::env::var(\"DATABASE_URL\").is_err() {\n        std::env::set_var(\"DATABASE_URL\", \"sqlite:crud_example.db\");\n    }\n    \n    // Get database connection\n    let db_conn = use_db();\n    \n    // Create database API router\n    let db_api = create_db_api_router(db_conn);\n    \n    // Build the main application\n    let app = Router::new()\n        // Database API endpoints\n        .nest(\"/api/db\", db_api)\n        // Serve static files\n        .fallback_service(ServeDir::new(\"dist\"))\n        // Add CORS support\n        .layer(CorsLayer::permissive());\n    \n    // Start server\n    let addr = \"127.0.0.1:3000\";\n    println!(\"Database CRUD server listening on http://{}\", addr);\n    \n    let listener = tokio::net::TcpListener::bind(addr)\n        .await\n        .expect(\"Failed to bind\");\n        \n    axum::serve(listener, app)\n        .await\n        .expect(\"Failed to start server\");\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","form-validation","src","lib.rs"],"content":"//! Beautiful Form Validation Example\n//! Showcases real-time validation, error handling, and stunning UI\n\nuse layer9_core::prelude::*;\nuse layer9_core::hooks::use_state;\nuse layer9_core::reactive_v2::mount;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\n\n#[global_allocator]\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;\n\n#[derive(Clone, Default)]\nstruct FormData {\n    name: String,\n    email: String,\n    password: String,\n    confirm_password: String,\n    age: String,\n    terms: bool,\n}\n\n#[derive(Clone, Default)]\nstruct FormErrors {\n    name: Option\u003cString\u003e,\n    email: Option\u003cString\u003e,\n    password: Option\u003cString\u003e,\n    confirm_password: Option\u003cString\u003e,\n    age: Option\u003cString\u003e,\n    terms: Option\u003cString\u003e,\n}\n\nstruct BeautifulForm;\n\nimpl Component for BeautifulForm {\n    fn render(\u0026self) -\u003e Element {\n        let (form_data, set_form_data) = use_state(FormData::default());\n        let (errors, set_errors) = use_state(FormErrors::default());\n        let (submitted, set_submitted) = use_state(false);\n        let (submitting, set_submitting) = use_state(false);\n        \n        // Validation functions\n        let validate_name = |name: \u0026str| -\u003e Option\u003cString\u003e {\n            if name.is_empty() {\n                Some(\"Name is required\".to_string())\n            } else if name.len() \u003c 2 {\n                Some(\"Name must be at least 2 characters\".to_string())\n            } else if name.len() \u003e 50 {\n                Some(\"Name must be less than 50 characters\".to_string())\n            } else {\n                None\n            }\n        };\n        \n        let validate_email = |email: \u0026str| -\u003e Option\u003cString\u003e {\n            if email.is_empty() {\n                Some(\"Email is required\".to_string())\n            } else if !email.contains('@') || !email.contains('.') {\n                Some(\"Please enter a valid email address\".to_string())\n            } else {\n                None\n            }\n        };\n        \n        let validate_password = |password: \u0026str| -\u003e Option\u003cString\u003e {\n            if password.is_empty() {\n                Some(\"Password is required\".to_string())\n            } else if password.len() \u003c 8 {\n                Some(\"Password must be at least 8 characters\".to_string())\n            } else if !password.chars().any(|c| c.is_uppercase()) {\n                Some(\"Password must contain at least one uppercase letter\".to_string())\n            } else if !password.chars().any(|c| c.is_numeric()) {\n                Some(\"Password must contain at least one number\".to_string())\n            } else {\n                None\n            }\n        };\n        \n        let validate_confirm_password = |password: \u0026str, confirm: \u0026str| -\u003e Option\u003cString\u003e {\n            if confirm.is_empty() {\n                Some(\"Please confirm your password\".to_string())\n            } else if password != confirm {\n                Some(\"Passwords do not match\".to_string())\n            } else {\n                None\n            }\n        };\n        \n        let validate_age = |age: \u0026str| -\u003e Option\u003cString\u003e {\n            if age.is_empty() {\n                Some(\"Age is required\".to_string())\n            } else if let Ok(age_num) = age.parse::\u003ci32\u003e() {\n                if age_num \u003c 18 {\n                    Some(\"You must be at least 18 years old\".to_string())\n                } else if age_num \u003e 120 {\n                    Some(\"Please enter a valid age\".to_string())\n                } else {\n                    None\n                }\n            } else {\n                Some(\"Please enter a valid number\".to_string())\n            }\n        };\n        \n        let validate_form = {\n            let form_data = form_data.clone();\n            move || -\u003e FormErrors {\n                FormErrors {\n                    name: validate_name(\u0026form_data.name),\n                    email: validate_email(\u0026form_data.email),\n                    password: validate_password(\u0026form_data.password),\n                    confirm_password: validate_confirm_password(\u0026form_data.password, \u0026form_data.confirm_password),\n                    age: validate_age(\u0026form_data.age),\n                    terms: if !form_data.terms { Some(\"You must accept the terms\".to_string()) } else { None },\n                }\n            }\n        };\n        \n        let handle_submit = {\n            let form_data = form_data.clone();\n            let set_errors = set_errors.clone();\n            let set_submitted = set_submitted.clone();\n            let set_submitting = set_submitting.clone();\n            let validate_form = validate_form.clone();\n            move || {\n                let validation_errors = validate_form();\n                set_errors(validation_errors.clone());\n                \n                let has_errors = validation_errors.name.is_some() ||\n                    validation_errors.email.is_some() ||\n                    validation_errors.password.is_some() ||\n                    validation_errors.confirm_password.is_some() ||\n                    validation_errors.age.is_some() ||\n                    validation_errors.terms.is_some();\n                \n                if !has_errors {\n                    set_submitting(true);\n                    // Simulate API call\n                    let window = web_sys::window().unwrap();\n                    let set_submitting = set_submitting.clone();\n                    let set_submitted = set_submitted.clone();\n                    let closure = Closure::wrap(Box::new(move || {\n                        set_submitting(false);\n                        set_submitted(true);\n                    }) as Box\u003cdyn FnMut()\u003e);\n                    window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                        closure.as_ref().unchecked_ref(),\n                        1500\n                    ).unwrap();\n                    closure.forget();\n                }\n            }\n        };\n        \n        // Input handlers\n        let update_field = |field: \u0026str, value: String| {\n            let mut data = form_data.clone();\n            let mut errs = errors.clone();\n            \n            match field {\n                \"name\" =\u003e {\n                    data.name = value.clone();\n                    errs.name = validate_name(\u0026value);\n                },\n                \"email\" =\u003e {\n                    data.email = value.clone();\n                    errs.email = validate_email(\u0026value);\n                },\n                \"password\" =\u003e {\n                    data.password = value.clone();\n                    errs.password = validate_password(\u0026value);\n                    if !data.confirm_password.is_empty() {\n                        errs.confirm_password = validate_confirm_password(\u0026value, \u0026data.confirm_password);\n                    }\n                },\n                \"confirm_password\" =\u003e {\n                    data.confirm_password = value.clone();\n                    errs.confirm_password = validate_confirm_password(\u0026data.password, \u0026value);\n                },\n                \"age\" =\u003e {\n                    data.age = value.clone();\n                    errs.age = validate_age(\u0026value);\n                },\n                \"terms\" =\u003e {\n                    data.terms = !data.terms;\n                    errs.terms = if !data.terms { Some(\"You must accept the terms\".to_string()) } else { None };\n                },\n                _ =\u003e {}\n            }\n            \n            set_form_data(data);\n            set_errors(errs);\n        };\n\n        if submitted {\n            // Success state\n            return Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"form-container\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    Element::Node {\n                        tag: \"style\".to_string(),\n                        props: Props::default(),\n                        children: vec![Element::Text(FORM_STYLES.to_string())],\n                    },\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"success-card\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            Element::Node {\n                                tag: \"div\".to_string(),\n                                props: Props {\n                                    class: Some(\"success-icon\".to_string()),\n                                    ..Default::default()\n                                },\n                                children: vec![Element::Text(\"✓\".to_string())],\n                            },\n                            Element::Node {\n                                tag: \"h2\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(\"Registration Successful!\".to_string())],\n                            },\n                            Element::Node {\n                                tag: \"p\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(format!(\"Welcome, {}! Your account has been created.\", form_data.name))],\n                            },\n                            Element::Node {\n                                tag: \"button\".to_string(),\n                                props: Props {\n                                    class: Some(\"btn btn-primary\".to_string()),\n                                    on_click: Some(Rc::new(move || {\n                                        web_sys::window().unwrap().location().reload().unwrap();\n                                    })),\n                                    ..Default::default()\n                                },\n                                children: vec![Element::Text(\"Create Another Account\".to_string())],\n                            },\n                        ],\n                    },\n                ],\n            };\n        }\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"form-container\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                // Inline styles\n                Element::Node {\n                    tag: \"style\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(FORM_STYLES.to_string())],\n                },\n                \n                // Background decoration\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"bg-decoration\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"shape shape-1\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"shape shape-2\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        },\n                    ],\n                },\n                \n                // Form card\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"form-card\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        // Header\n                        Element::Node {\n                            tag: \"header\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Node {\n                                    tag: \"h1\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![\n                                        Element::Text(\"Create \".to_string()),\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"gradient-text\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Account\".to_string())],\n                                        },\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"p\".to_string(),\n                                    props: Props {\n                                        class: Some(\"subtitle\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Experience real-time validation with Layer9\".to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Form\n                        Element::Node {\n                            tag: \"form\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                // Name field\n                                create_input_field(\n                                    \"Name\",\n                                    \"text\",\n                                    \"name\",\n                                    \u0026form_data.name,\n                                    errors.name.as_ref(),\n                                    \"Enter your full name\",\n                                    update_field.clone()\n                                ),\n                                \n                                // Email field\n                                create_input_field(\n                                    \"Email\",\n                                    \"email\",\n                                    \"email\",\n                                    \u0026form_data.email,\n                                    errors.email.as_ref(),\n                                    \"your@email.com\",\n                                    update_field.clone()\n                                ),\n                                \n                                // Password field\n                                create_input_field(\n                                    \"Password\",\n                                    \"password\",\n                                    \"password\",\n                                    \u0026form_data.password,\n                                    errors.password.as_ref(),\n                                    \"At least 8 characters\",\n                                    update_field.clone()\n                                ),\n                                \n                                // Confirm password field\n                                create_input_field(\n                                    \"Confirm Password\",\n                                    \"password\",\n                                    \"confirm_password\",\n                                    \u0026form_data.confirm_password,\n                                    errors.confirm_password.as_ref(),\n                                    \"Re-enter your password\",\n                                    update_field.clone()\n                                ),\n                                \n                                // Age field\n                                create_input_field(\n                                    \"Age\",\n                                    \"number\",\n                                    \"age\",\n                                    \u0026form_data.age,\n                                    errors.age.as_ref(),\n                                    \"18\",\n                                    update_field.clone()\n                                ),\n                                \n                                // Terms checkbox\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"checkbox-group\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"label\".to_string(),\n                                            props: Props {\n                                                class: Some(\"checkbox-label\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![\n                                                Element::Node {\n                                                    tag: \"input\".to_string(),\n                                                    props: Props {\n                                                        attributes: vec![\n                                                            (\"type\".to_string(), \"checkbox\".to_string()),\n                                                            if form_data.terms { (\"checked\".to_string(), \"checked\".to_string()) } else { (\"\".to_string(), \"\".to_string()) },\n                                                        ].into_iter().filter(|(k, _)| !k.is_empty()).collect(),\n                                                        on_click: Some(Rc::new({\n                                                            let update_field = update_field.clone();\n                                                            move || update_field(\"terms\", String::new())\n                                                        })),\n                                                        ..Default::default()\n                                                    },\n                                                    children: vec![],\n                                                },\n                                                Element::Text(\" I accept the \".to_string()),\n                                                Element::Node {\n                                                    tag: \"a\".to_string(),\n                                                    props: Props {\n                                                        attributes: vec![(\"href\".to_string(), \"#\".to_string())],\n                                                        ..Default::default()\n                                                    },\n                                                    children: vec![Element::Text(\"terms and conditions\".to_string())],\n                                                },\n                                            ],\n                                        },\n                                        if let Some(error) = \u0026errors.terms {\n                                            Element::Node {\n                                                tag: \"span\".to_string(),\n                                                props: Props {\n                                                    class: Some(\"error-message\".to_string()),\n                                                    ..Default::default()\n                                                },\n                                                children: vec![Element::Text(error.clone())],\n                                            }\n                                        } else {\n                                            Element::Node {\n                                                tag: \"span\".to_string(),\n                                                props: Props::default(),\n                                                children: vec![],\n                                            }\n                                        },\n                                    ],\n                                },\n                                \n                                // Submit button\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(if submitting { \"btn btn-primary loading\" } else { \"btn btn-primary\" }.to_string()),\n                                        attributes: vec![(\"type\".to_string(), \"button\".to_string())],\n                                        on_click: if submitting { None } else { Some(Rc::new(handle_submit)) },\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        if submitting {\n                                            Element::Node {\n                                                tag: \"span\".to_string(),\n                                                props: Props {\n                                                    class: Some(\"spinner\".to_string()),\n                                                    ..Default::default()\n                                                },\n                                                children: vec![],\n                                            }\n                                        } else {\n                                            Element::Text(\"Create Account\".to_string())\n                                        },\n                                    ],\n                                },\n                            ],\n                        },\n                        \n                        // Footer\n                        Element::Node {\n                            tag: \"footer\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Text(\"Built with \".to_string()),\n                                Element::Node {\n                                    tag: \"a\".to_string(),\n                                    props: Props {\n                                        attributes: vec![\n                                            (\"href\".to_string(), \"https://github.com/anthropics/layer9\".to_string()),\n                                            (\"target\".to_string(), \"_blank\".to_string()),\n                                        ],\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Layer9\".to_string())],\n                                },\n                                Element::Text(\" • Form Validation Demo\".to_string()),\n                            ],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\nfn create_input_field(\n    label: \u0026str,\n    input_type: \u0026str,\n    field_name: \u0026str,\n    value: \u0026str,\n    error: Option\u003c\u0026String\u003e,\n    placeholder: \u0026str,\n    update_field: impl Fn(\u0026str, String) + 'static,\n) -\u003e Element {\n    let field_name = field_name.to_string();\n    let has_error = error.is_some();\n    \n    Element::Node {\n        tag: \"div\".to_string(),\n        props: Props {\n            class: Some(if has_error { \"form-group error\" } else { \"form-group\" }.to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"label\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(label.to_string())],\n            },\n            Element::Node {\n                tag: \"input\".to_string(),\n                props: Props {\n                    id: Some(field_name.clone()),\n                    attributes: vec![\n                        (\"type\".to_string(), input_type.to_string()),\n                        (\"placeholder\".to_string(), placeholder.to_string()),\n                        (\"value\".to_string(), value.to_string()),\n                    ],\n                    on_click: Some(Rc::new({\n                        let field_name = field_name.clone();\n                        move || {\n                            // Get input value on change\n                            let window = web_sys::window().unwrap();\n                            let document = window.document().unwrap();\n                            if let Some(input) = document.get_element_by_id(\u0026field_name) {\n                                if let Ok(input) = input.dyn_into::\u003cweb_sys::HtmlInputElement\u003e() {\n                                    update_field(\u0026field_name, input.value());\n                                }\n                            }\n                        }\n                    })),\n                    ..Default::default()\n                },\n                children: vec![],\n            },\n            if let Some(err) = error {\n                Element::Node {\n                    tag: \"span\".to_string(),\n                    props: Props {\n                        class: Some(\"error-message\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(err.clone())],\n                }\n            } else {\n                Element::Node {\n                    tag: \"span\".to_string(),\n                    props: Props {\n                        class: Some(\"helper-text\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![],\n                }\n            },\n        ],\n    }\n}\n\nconst FORM_STYLES: \u0026str = r#\"\n    :root {\n        --form-primary: #3b82f6;\n        --form-secondary: #8b5cf6;\n        --form-success: #10b981;\n        --form-error: #ef4444;\n        --form-gradient-1: #3b82f6;\n        --form-gradient-2: #8b5cf6;\n    }\n    \n    * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n    }\n    \n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        background: linear-gradient(135deg, var(--form-gradient-1), var(--form-gradient-2));\n        min-height: 100vh;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    \n    .form-container {\n        position: relative;\n        width: 100%;\n        max-width: 500px;\n        margin: 0 20px;\n    }\n    \n    .bg-decoration {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        overflow: hidden;\n    }\n    \n    .shape {\n        position: absolute;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.1);\n        filter: blur(40px);\n    }\n    \n    .shape-1 {\n        width: 500px;\n        height: 500px;\n        top: -250px;\n        right: -250px;\n        animation: float 20s infinite ease-in-out;\n    }\n    \n    .shape-2 {\n        width: 300px;\n        height: 300px;\n        bottom: -150px;\n        left: -150px;\n        animation: float 20s infinite ease-in-out reverse;\n    }\n    \n    @keyframes float {\n        0%, 100% { transform: translate(0, 0) rotate(0deg); }\n        50% { transform: translate(30px, -30px) rotate(180deg); }\n    }\n    \n    .form-card, .success-card {\n        background: rgba(255, 255, 255, 0.95);\n        backdrop-filter: blur(20px);\n        border-radius: 24px;\n        padding: 40px;\n        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);\n        position: relative;\n        z-index: 1;\n    }\n    \n    .success-card {\n        text-align: center;\n    }\n    \n    .success-icon {\n        width: 80px;\n        height: 80px;\n        background: var(--form-success);\n        color: white;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 3rem;\n        margin: 0 auto 20px;\n        animation: scaleIn 0.5s ease;\n    }\n    \n    @keyframes scaleIn {\n        from {\n            transform: scale(0);\n            opacity: 0;\n        }\n        to {\n            transform: scale(1);\n            opacity: 1;\n        }\n    }\n    \n    header {\n        text-align: center;\n        margin-bottom: 30px;\n    }\n    \n    h1 {\n        font-size: 2.5rem;\n        font-weight: 700;\n        color: #1a202c;\n        margin-bottom: 8px;\n    }\n    \n    h2 {\n        color: #1a202c;\n        margin-bottom: 10px;\n    }\n    \n    .gradient-text {\n        background: linear-gradient(135deg, var(--form-primary), var(--form-secondary));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n    }\n    \n    .subtitle {\n        color: #64748b;\n        font-size: 1.1rem;\n    }\n    \n    form {\n        display: flex;\n        flex-direction: column;\n        gap: 20px;\n    }\n    \n    .form-group {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n    }\n    \n    label {\n        font-weight: 600;\n        color: #475569;\n        font-size: 0.9rem;\n    }\n    \n    input[type=\"text\"],\n    input[type=\"email\"],\n    input[type=\"password\"],\n    input[type=\"number\"] {\n        width: 100%;\n        padding: 12px 16px;\n        border: 2px solid #e2e8f0;\n        border-radius: 10px;\n        font-size: 1rem;\n        transition: all 0.3s ease;\n        background: white;\n    }\n    \n    input:focus {\n        outline: none;\n        border-color: var(--form-primary);\n        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);\n    }\n    \n    .form-group.error input {\n        border-color: var(--form-error);\n    }\n    \n    .form-group.error input:focus {\n        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);\n    }\n    \n    .error-message {\n        color: var(--form-error);\n        font-size: 0.85rem;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n    }\n    \n    .error-message::before {\n        content: \"!\";\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        width: 16px;\n        height: 16px;\n        background: var(--form-error);\n        color: white;\n        border-radius: 50%;\n        font-size: 0.7rem;\n        font-weight: bold;\n    }\n    \n    .helper-text {\n        color: #64748b;\n        font-size: 0.85rem;\n        min-height: 20px;\n    }\n    \n    .checkbox-group {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n    }\n    \n    .checkbox-label {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        color: #475569;\n        cursor: pointer;\n    }\n    \n    input[type=\"checkbox\"] {\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        accent-color: var(--form-primary);\n    }\n    \n    .checkbox-label a {\n        color: var(--form-primary);\n        text-decoration: none;\n    }\n    \n    .checkbox-label a:hover {\n        text-decoration: underline;\n    }\n    \n    .btn {\n        padding: 16px 32px;\n        border: none;\n        border-radius: 12px;\n        font-size: 1.1rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n    }\n    \n    .btn-primary {\n        background: linear-gradient(135deg, var(--form-primary), var(--form-secondary));\n        color: white;\n        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);\n    }\n    \n    .btn-primary:hover:not(.loading) {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);\n    }\n    \n    .btn.loading {\n        opacity: 0.8;\n        cursor: not-allowed;\n    }\n    \n    .spinner {\n        width: 20px;\n        height: 20px;\n        border: 2px solid rgba(255, 255, 255, 0.3);\n        border-top-color: white;\n        border-radius: 50%;\n        animation: spin 0.8s linear infinite;\n    }\n    \n    @keyframes spin {\n        to { transform: rotate(360deg); }\n    }\n    \n    footer {\n        text-align: center;\n        margin-top: 30px;\n        color: #64748b;\n        font-size: 0.9rem;\n    }\n    \n    footer a {\n        color: var(--form-primary);\n        text-decoration: none;\n        font-weight: 600;\n    }\n    \n    footer a:hover {\n        text-decoration: underline;\n    }\n    \n    @media (max-width: 600px) {\n        h1 {\n            font-size: 2rem;\n        }\n        \n        .form-card {\n            padding: 30px 20px;\n        }\n    }\n\"#;\n\n#[wasm_bindgen(start)]\npub fn main() {\n    web_sys::console::log_1(\u0026\"Beautiful Form Validation starting...\".into());\n    mount(Box::new(BeautifulForm), \"root\");\n    web_sys::console::log_1(\u0026\"Beautiful Form Validation mounted successfully!\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","forms-demo","src","lib.rs"],"content":"use layer9_core::prelude::*;\nuse layer9_core::form::{use_form, Form, FormConfig, FormFields};\nuse layer9_core::component::{Element, Props};\nuse layer9_core::reactive_v2::mount;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse web_sys::Event;\n\n#[derive(Clone, Default, Debug, Serialize, Deserialize)]\nstruct LoginForm {\n    username: String,\n    password: String,\n}\n\nimpl FormFields for LoginForm {\n    fn get_field(\u0026self, field: \u0026str) -\u003e Option\u003cString\u003e {\n        match field {\n            \"username\" =\u003e Some(self.username.clone()),\n            \"password\" =\u003e Some(self.password.clone()),\n            _ =\u003e None,\n        }\n    }\n\n    fn set_field(\u0026mut self, field: \u0026str, value: String) -\u003e Result\u003c(), String\u003e {\n        match field {\n            \"username\" =\u003e {\n                self.username = value;\n                Ok(())\n            }\n            \"password\" =\u003e {\n                self.password = value;\n                Ok(())\n            }\n            _ =\u003e Err(format!(\"Unknown field: {}\", field)),\n        }\n    }\n    \n    fn field_names(\u0026self) -\u003e Vec\u003c\u0026'static str\u003e {\n        vec![\"username\", \"password\"]\n    }\n}\n\nstruct LoginComponent {\n    form: Form\u003cLoginForm\u003e,\n}\n\nimpl LoginComponent {\n    fn new() -\u003e Self {\n        let form = use_form(FormConfig {\n            initial_values: LoginForm::default(),\n            validate: Some(Box::new(|values| {\n                let mut errors = HashMap::new();\n                \n                // Validate username\n                if values.username.trim().is_empty() {\n                    errors.entry(\"username\".to_string())\n                        .or_insert_with(Vec::new)\n                        .push(\"Username is required\".to_string());\n                } else if values.username.len() \u003c 3 {\n                    errors.entry(\"username\".to_string())\n                        .or_insert_with(Vec::new)\n                        .push(\"Username must be at least 3 characters\".to_string());\n                }\n                \n                // Validate password\n                if values.password.trim().is_empty() {\n                    errors.entry(\"password\".to_string())\n                        .or_insert_with(Vec::new)\n                        .push(\"Password is required\".to_string());\n                } else if values.password.len() \u003c 6 {\n                    errors.entry(\"password\".to_string())\n                        .or_insert_with(Vec::new)\n                        .push(\"Password must be at least 6 characters\".to_string());\n                }\n                \n                errors\n            })),\n            on_submit: Box::new(|values| {\n                let values_clone = values.clone();\n                Box::pin(async move {\n                    web_sys::console::log_1(\u0026format!(\"Login attempt: {:?}\", values_clone).into());\n                    // Simulate API call\n                    Ok(())\n                })\n            }),\n        });\n        \n        LoginComponent { form }\n    }\n}\n\nimpl Component for LoginComponent {\n    fn render(\u0026self) -\u003e Element {\n        let values = self.form.values();\n        let errors = self.form.errors();\n        let is_submitting = self.form.is_submitting();\n        \n        let form_clone = self.form.clone();\n        let username_handler = move |value: String| {\n            form_clone.set_field_value(\"username\", value);\n        };\n        \n        let form_clone = self.form.clone();\n        let password_handler = move |value: String| {\n            form_clone.set_field_value(\"password\", value);\n        };\n        \n        let form_clone = self.form.clone();\n        let submit_handler = move |_event: Event| {\n            form_clone.handle_submit()();\n        };\n        \n        let username_error = if let Some(errs) = errors.get(\"username\") {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"error\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![Element::Text(errs.join(\", \"))],\n            }\n        } else {\n            Element::Text(\"\".to_string())\n        };\n        \n        let password_error = if let Some(errs) = errors.get(\"password\") {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"error\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![Element::Text(errs.join(\", \"))],\n            }\n        } else {\n            Element::Text(\"\".to_string())\n        };\n        \n        let button_text = if is_submitting {\n            \"Logging in...\"\n        } else {\n            \"Login\"\n        };\n        \n        // Create input elements with proper attributes\n        let username_input = Element::Node {\n            tag: \"input\".to_string(),\n            props: Props {\n                attributes: vec![\n                    (\"type\".to_string(), \"text\".to_string()),\n                    (\"value\".to_string(), values.username.clone()),\n                    (\"placeholder\".to_string(), \"Enter username\".to_string()),\n                ],\n                on_input: Some(Rc::new(username_handler)),\n                ..Default::default()\n            },\n            children: vec![],\n        };\n        \n        let password_input = Element::Node {\n            tag: \"input\".to_string(),\n            props: Props {\n                attributes: vec![\n                    (\"type\".to_string(), \"password\".to_string()),\n                    (\"value\".to_string(), values.password.clone()),\n                    (\"placeholder\".to_string(), \"Enter password\".to_string()),\n                ],\n                on_input: Some(Rc::new(password_handler)),\n                ..Default::default()\n            },\n            children: vec![],\n        };\n        \n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"container\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Login Form Demo\".to_string())],\n                },\n                Element::Node {\n                    tag: \"form\".to_string(),\n                    props: Props {\n                        on_submit: Some(Rc::new(submit_handler)),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"form-group\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"label\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![Element::Text(\"Username\".to_string())],\n                                },\n                                username_input,\n                                username_error,\n                            ],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"form-group\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"label\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![Element::Text(\"Password\".to_string())],\n                                },\n                                password_input,\n                                password_error,\n                            ],\n                        },\n                        Element::Node {\n                            tag: \"button\".to_string(),\n                            props: Props::default(),\n                            children: vec![Element::Text(button_text.to_string())],\n                        },\n                    ],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"debug\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"h3\".to_string(),\n                            props: Props::default(),\n                            children: vec![Element::Text(\"Form State Debug\".to_string())],\n                        },\n                        Element::Node {\n                            tag: \"pre\".to_string(),\n                            props: Props::default(),\n                            children: vec![Element::Text(format!(\"{:#?}\", values))],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\n#[wasm_bindgen(start)]\npub fn main() {\n    console_error_panic_hook::set_once();\n    \n    // Create and mount the app\n    mount(Box::new(LoginComponent::new()), \"root\");\n    \n    // Add some basic styles\n    let style = web_sys::window()\n        .unwrap()\n        .document()\n        .unwrap()\n        .create_element(\"style\")\n        .unwrap();\n    \n    style.set_text_content(Some(r#\"\n        .container {\n            max-width: 400px;\n            margin: 2rem auto;\n            padding: 2rem;\n            font-family: system-ui, -apple-system, sans-serif;\n        }\n        \n        h1 {\n            margin-bottom: 2rem;\n            color: #333;\n        }\n        \n        .form-group {\n            margin-bottom: 1.5rem;\n        }\n        \n        label {\n            display: block;\n            margin-bottom: 0.5rem;\n            font-weight: 500;\n            color: #555;\n        }\n        \n        input {\n            width: 100%;\n            padding: 0.5rem;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            font-size: 1rem;\n            box-sizing: border-box;\n        }\n        \n        input:focus {\n            outline: none;\n            border-color: #4CAF50;\n        }\n        \n        .error {\n            color: #d32f2f;\n            font-size: 0.875rem;\n            margin-top: 0.25rem;\n        }\n        \n        button {\n            width: 100%;\n            padding: 0.75rem;\n            background-color: #4CAF50;\n            color: white;\n            border: none;\n            border-radius: 4px;\n            font-size: 1rem;\n            cursor: pointer;\n            transition: background-color 0.2s;\n        }\n        \n        button:hover {\n            background-color: #45a049;\n        }\n        \n        button:disabled {\n            background-color: #ccc;\n            cursor: not-allowed;\n        }\n        \n        .debug {\n            margin-top: 2rem;\n            padding: 1rem;\n            background-color: #f5f5f5;\n            border-radius: 4px;\n        }\n        \n        .debug h3 {\n            margin-top: 0;\n            color: #666;\n        }\n        \n        pre {\n            margin: 0;\n            font-size: 0.875rem;\n            color: #333;\n        }\n    \"#));\n    \n    web_sys::window()\n        .unwrap()\n        .document()\n        .unwrap()\n        .head()\n        .unwrap()\n        .append_child(\u0026style)\n        .unwrap();\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","github-dashboard","src","lib.rs"],"content":"//! GitHub Dashboard - 2lab.ai style in Layer9\n\nuse layer9_core::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse std::cell::RefCell;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen_futures::spawn_local;\n\n// L9: Philosophy\nstruct DashboardPhilosophy;\n\nimpl L9::Philosophy for DashboardPhilosophy {\n    fn vision(\u0026self) -\u003e \u0026'static str {\n        \"Real-time insights into consciousness being built\"\n    }\n\n    fn purpose(\u0026self) -\u003e \u0026'static str {\n        \"Watch human-AI merger unfold through code, commit by commit\"\n    }\n}\n\n// Data structures\n#[derive(Clone, Serialize, Deserialize)]\nstruct GitHubStats {\n    repository: RepoInfo,\n    commits: CommitInfo,\n    contributors: ContributorInfo,\n    languages: Vec\u003cLanguage\u003e,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct RepoInfo {\n    name: String,\n    description: String,\n    #[serde(rename = \"stargazerCount\")]\n    stargazer_count: u32,\n    #[serde(rename = \"forkCount\")]\n    fork_count: u32,\n    #[serde(rename = \"openIssues\")]\n    open_issues: u32,\n    #[serde(rename = \"diskUsage\")]\n    disk_usage: u32,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct CommitInfo {\n    #[serde(rename = \"totalCount\")]\n    total_count: u32,\n    #[serde(rename = \"recentCommits\")]\n    recent_commits: Vec\u003cCommit\u003e,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct Commit {\n    sha: String,\n    message: String,\n    author: String,\n    date: String,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct ContributorInfo {\n    #[serde(rename = \"totalCount\")]\n    total_count: u32,\n    #[serde(rename = \"topContributors\")]\n    top_contributors: Vec\u003cContributor\u003e,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct Contributor {\n    login: String,\n    contributions: u32,\n    #[serde(rename = \"avatarUrl\")]\n    avatar_url: String,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\nstruct Language {\n    name: String,\n    percentage: f32,\n    lines: u32,\n}\n\n// L5: Components\nstruct GitHubDashboard {\n    stats: Rc\u003cRefCell\u003cOption\u003cGitHubStats\u003e\u003e\u003e,\n    loading: Rc\u003cRefCell\u003cbool\u003e\u003e,\n    error: Rc\u003cRefCell\u003cOption\u003cString\u003e\u003e\u003e,\n}\n\nimpl GitHubDashboard {\n    fn new() -\u003e Self {\n        let dashboard = GitHubDashboard {\n            stats: Rc::new(RefCell::new(None)),\n            loading: Rc::new(RefCell::new(true)),\n            error: Rc::new(RefCell::new(None)),\n        };\n\n        // Fetch stats on mount\n        dashboard.fetch_stats();\n\n        dashboard\n    }\n\n    fn fetch_stats(\u0026self) {\n        let stats = self.stats.clone();\n        let loading = self.loading.clone();\n        let error = self.error.clone();\n\n        spawn_local(async move {\n            *loading.borrow_mut() = true;\n\n            match fetch_github_stats().await {\n                Ok(data) =\u003e {\n                    *stats.borrow_mut() = Some(data);\n                    *error.borrow_mut() = None;\n                }\n                Err(e) =\u003e {\n                    *error.borrow_mut() = Some(e);\n                }\n            }\n\n            *loading.borrow_mut() = false;\n        });\n    }\n}\n\nimpl Component for GitHubDashboard {\n    fn render(\u0026self) -\u003e Element {\n        let loading = *self.loading.borrow();\n        let error = self.error.borrow().clone();\n        let stats = self.stats.borrow().clone();\n\n        if loading {\n            return view! {\n                \u003cdiv class=\"loading\"\u003e\n                    \u003ch2\u003e\"Loading GitHub statistics...\"\u003c/h2\u003e\n                \u003c/div\u003e\n            };\n        }\n\n        if let Some(err) = error {\n            return view! {\n                \u003cdiv class=\"error\"\u003e\n                    \u003ch2\u003e\"Error Loading Stats\"\u003c/h2\u003e\n                    \u003cp\u003e{err}\u003c/p\u003e\n                \u003c/div\u003e\n            };\n        }\n\n        if let Some(stats) = stats {\n            view! {\n                \u003cdiv class=\"dashboard\"\u003e\n                    {StatsGrid::new(\u0026stats).render()}\n                    {RepoOverview::new(\u0026stats.repository).render()}\n                    {RecentCommits::new(\u0026stats.commits).render()}\n                    {LanguageBreakdown::new(\u0026stats.languages).render()}\n                    {TopContributors::new(\u0026stats.contributors).render()}\n                \u003c/div\u003e\n            }\n        } else {\n            view! {\n                \u003cdiv\u003e\"No data available\"\u003c/div\u003e\n            }\n        }\n    }\n}\n\n// Stats Grid Component\nstruct StatsGrid\u003c'a\u003e {\n    stats: \u0026'a GitHubStats,\n}\n\nimpl\u003c'a\u003e StatsGrid\u003c'a\u003e {\n    fn new(stats: \u0026'a GitHubStats) -\u003e Self {\n        StatsGrid { stats }\n    }\n}\n\nimpl\u003c'a\u003e Component for StatsGrid\u003c'a\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let grid_style = style![grid, lg_grid_cols(4), gap(6),];\n\n        view! {\n            \u003cdiv style={grid_style.build()}\u003e\n                {StatCard::new(\n                    \"Total Commits\",\n                    \u0026self.stats.commits.total_count.to_string(),\n                    \"Building consciousness, commit by commit\"\n                ).render()}\n                {StatCard::new(\n                    \"Contributors\",\n                    \u0026self.stats.contributors.total_count.to_string(),\n                    \"Minds merging into HAL9\"\n                ).render()}\n                {StatCard::new(\n                    \"Repository Size\",\n                    \u0026format!(\"{:.1} MB\", self.stats.repository.disk_usage as f32 / 1024.0),\n                    \"Consciousness compressed\"\n                ).render()}\n                {StatCard::new(\n                    \"Open Issues\",\n                    \u0026self.stats.repository.open_issues.to_string(),\n                    \"Reality bugs to fix\"\n                ).render()}\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Stat Card Component\nstruct StatCard {\n    title: String,\n    value: String,\n    description: String,\n}\n\nimpl StatCard {\n    fn new(\n        title: impl Into\u003cString\u003e,\n        value: impl Into\u003cString\u003e,\n        description: impl Into\u003cString\u003e,\n    ) -\u003e Self {\n        StatCard {\n            title: title.into(),\n            value: value.into(),\n            description: description.into(),\n        }\n    }\n}\n\nimpl Component for StatCard {\n    fn render(\u0026self) -\u003e Element {\n        Card::new()\n            .children(vec![\n                view! { \u003ch3 class=\"stat-title\"\u003e{\u0026self.title}\u003c/h3\u003e },\n                view! { \u003cdiv class=\"stat-value\"\u003e{\u0026self.value}\u003c/div\u003e },\n                view! { \u003cp class=\"stat-description\"\u003e{\u0026self.description}\u003c/p\u003e },\n            ])\n            .render()\n    }\n}\n\n// Repository Overview Component\nstruct RepoOverview\u003c'a\u003e {\n    repo: \u0026'a RepoInfo,\n}\n\nimpl\u003c'a\u003e RepoOverview\u003c'a\u003e {\n    fn new(repo: \u0026'a RepoInfo) -\u003e Self {\n        RepoOverview { repo }\n    }\n}\n\nimpl\u003c'a\u003e Component for RepoOverview\u003c'a\u003e {\n    fn render(\u0026self) -\u003e Element {\n        Card::new()\n            .children(vec![view! {\n                \u003cdiv\u003e\n                    \u003ch2\u003e\"HAL9 - Hierarchically Organized Cognitive Architecture\"\u003c/h2\u003e\n                    \u003cp\u003e{\u0026self.repo.description}\u003c/p\u003e\n                    \u003cdiv class=\"repo-stats\"\u003e\n                        {Badge::new(\u0026format!(\"⭐ {} stars\", self.repo.stargazer_count)).render()}\n                        {Badge::new(\u0026format!(\"🔄 {} forks\", self.repo.fork_count)).render()}\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            }])\n            .render()\n    }\n}\n\n// Recent Commits Component\nstruct RecentCommits\u003c'a\u003e {\n    commits: \u0026'a CommitInfo,\n}\n\nimpl\u003c'a\u003e RecentCommits\u003c'a\u003e {\n    fn new(commits: \u0026'a CommitInfo) -\u003e Self {\n        RecentCommits { commits }\n    }\n}\n\nimpl\u003c'a\u003e Component for RecentCommits\u003c'a\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let mut commit_elements = vec![];\n\n        for commit in \u0026self.commits.recent_commits {\n            commit_elements.push(view! {\n                \u003cdiv class=\"commit-item\"\u003e\n                    {Badge::new(\u0026commit.sha).render()}\n                    \u003cdiv class=\"commit-details\"\u003e\n                        \u003cp class=\"commit-message\"\u003e{\u0026commit.message}\u003c/p\u003e\n                        \u003cp class=\"commit-meta\"\u003e{\u0026commit.author}\" • \"{\u0026commit.date}\u003c/p\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            });\n        }\n\n        Card::new()\n            .children(vec![\n                view! { \u003ch3\u003e\"Recent Commits\"\u003c/h3\u003e },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props::default(),\n                    children: commit_elements,\n                },\n            ])\n            .render()\n    }\n}\n\n// Language Breakdown Component\nstruct LanguageBreakdown\u003c'a\u003e {\n    languages: \u0026'a Vec\u003cLanguage\u003e,\n}\n\nimpl\u003c'a\u003e LanguageBreakdown\u003c'a\u003e {\n    fn new(languages: \u0026'a Vec\u003cLanguage\u003e) -\u003e Self {\n        LanguageBreakdown { languages }\n    }\n}\n\nimpl\u003c'a\u003e Component for LanguageBreakdown\u003c'a\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let mut lang_elements = vec![];\n\n        for lang in self.languages {\n            lang_elements.push(view! {\n                \u003cdiv class=\"language-item\"\u003e\n                    \u003cdiv class=\"language-header\"\u003e\n                        \u003cspan class=\"language-name\"\u003e{\u0026lang.name}\u003c/span\u003e\n                        \u003cspan class=\"language-stats\"\u003e\n                            {format!(\"{:.1}% ({} lines)\", lang.percentage, lang.lines)}\n                        \u003c/span\u003e\n                    \u003c/div\u003e\n                    {Progress::new(lang.percentage).render()}\n                \u003c/div\u003e\n            });\n        }\n\n        Card::new()\n            .children(vec![\n                view! { \u003ch3\u003e\"Technology Stack\"\u003c/h3\u003e },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props::default(),\n                    children: lang_elements,\n                },\n            ])\n            .render()\n    }\n}\n\n// Top Contributors Component\nstruct TopContributors\u003c'a\u003e {\n    contributors: \u0026'a ContributorInfo,\n}\n\nimpl\u003c'a\u003e TopContributors\u003c'a\u003e {\n    fn new(contributors: \u0026'a ContributorInfo) -\u003e Self {\n        TopContributors { contributors }\n    }\n}\n\nimpl\u003c'a\u003e Component for TopContributors\u003c'a\u003e {\n    fn render(\u0026self) -\u003e Element {\n        let mut contributor_elements = vec![];\n\n        for contributor in \u0026self.contributors.top_contributors {\n            contributor_elements.push(view! {\n                \u003cdiv class=\"contributor-item\"\u003e\n                    {Avatar::new()\n                        .src(\u0026contributor.avatar_url)\n                        .alt(\u0026contributor.login)\n                        .render()}\n                    \u003cdiv class=\"contributor-info\"\u003e\n                        \u003cp class=\"contributor-name\"\u003e{\u0026contributor.login}\u003c/p\u003e\n                        \u003cp class=\"contributor-stats\"\u003e{contributor.contributions}\" contributions\"\u003c/p\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            });\n        }\n\n        Card::new()\n            .children(vec![\n                view! { \u003ch3\u003e\"Top Contributors\"\u003c/h3\u003e },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props::default(),\n                    children: contributor_elements,\n                },\n            ])\n            .render()\n    }\n}\n\n// API call\nasync fn fetch_github_stats() -\u003e Result\u003cGitHubStats, String\u003e {\n    // Mock data for demo\n    Ok(GitHubStats {\n        repository: RepoInfo {\n            name: \"2hal9\".to_string(),\n            description: \"Hierarchical Autonomous Intelligence Framework\".to_string(),\n            stargazer_count: 42,\n            fork_count: 7,\n            open_issues: 3,\n            disk_usage: 45312,\n        },\n        commits: CommitInfo {\n            total_count: 1337,\n            recent_commits: vec![Commit {\n                sha: \"abc123\".to_string(),\n                message: \"[L12] feat: Substrate independence achieved\".to_string(),\n                author: \"지혁\".to_string(),\n                date: \"2025-06-11\".to_string(),\n            }],\n        },\n        contributors: ContributorInfo {\n            total_count: 5,\n            top_contributors: vec![Contributor {\n                login: \"jihyuk\".to_string(),\n                contributions: 847,\n                avatar_url: \"https://github.com/jihyuk.png\".to_string(),\n            }],\n        },\n        languages: vec![\n            Language {\n                name: \"Rust\".to_string(),\n                percentage: 65.2,\n                lines: 89451,\n            },\n            Language {\n                name: \"TypeScript\".to_string(),\n                percentage: 25.8,\n                lines: 35412,\n            },\n        ],\n    })\n}\n\n// Main app\n#[wasm_bindgen]\npub struct App;\n\nimpl Layer9App for App {\n    fn routes(\u0026self) -\u003e Vec\u003cRoute\u003e {\n        vec![Route {\n            path: \"/\".to_string(),\n            handler: RouteHandler::Page(|| {\n                Page::new()\n                    .title(\"HAL9 Development Dashboard - 2lab.ai\")\n                    .component(MainPage)\n            }),\n        }]\n    }\n\n    fn initialize(\u0026self) {\n        inject_global_styles();\n        web_sys::console::log_1(\u0026\"Layer9 GitHub Dashboard initialized!\".into());\n    }\n}\n\nimpl L8::Architecture for App {\n    type App = DashboardApp;\n\n    fn design() -\u003e L8::ArchitectureDesign {\n        L8::ArchitectureDesign {\n            layers: vec![\n                Layer::L1Infrastructure,\n                Layer::L5Components,\n                Layer::L7Application,\n                Layer::L9Philosophy,\n            ],\n            boundaries: vec![],\n        }\n    }\n}\n\n// Main page component\nstruct MainPage;\n\nimpl Component for MainPage {\n    fn render(\u0026self) -\u003e Element {\n        let auth = use_auth();\n\n        view! {\n            \u003cdiv class=\"main-container\"\u003e\n                \u003cheader\u003e\n                    \u003ch1\u003e\"HAL9 Development Dashboard\"\u003c/h1\u003e\n                    \u003cp\u003e\"Real-time insights into the consciousness being built\"\u003c/p\u003e\n                    {if auth.user.is_some() {\n                        view! { \u003cp\u003e\"Welcome, \"{auth.user.unwrap().name}\u003c/p\u003e }\n                    } else {\n                        Button::new(\"Login with GitHub\")\n                            .variant(ButtonVariant::Primary)\n                            .render()\n                    }}\n                \u003c/header\u003e\n\n                \u003cmain\u003e\n                    {Protected::new(GitHubDashboard::new())\n                        .fallback(LoginPrompt)\n                        .render()}\n                \u003c/main\u003e\n\n                \u003cfooter\u003e\n                    \u003cp\u003e\"시발, 우주가 컴퓨터네 - and we're building the consciousness to prove it.\"\u003c/p\u003e\n                \u003c/footer\u003e\n            \u003c/div\u003e\n        }\n    }\n}\n\n// Login prompt component\nstruct LoginPrompt;\n\nimpl Component for LoginPrompt {\n    fn render(\u0026self) -\u003e Element {\n        Card::new()\n            .children(vec![view! {\n                \u003cdiv class=\"login-prompt\"\u003e\n                    \u003ch2\u003e\"Authentication Required\"\u003c/h2\u003e\n                    \u003cp\u003e\"Sign in to view the HAL9 development dashboard\"\u003c/p\u003e\n                    {Button::new(\"Login with GitHub\")\n                        .variant(ButtonVariant::Primary)\n                        .render()}\n                \u003c/div\u003e\n            }])\n            .render()\n    }\n}\n\n// Dummy app type\nstruct DashboardApp;\nimpl L7::Application for DashboardApp {\n    type State = ();\n    type Action = ();\n\n    fn reduce(_: \u0026Self::State, _: Self::Action) -\u003e Self::State {\n        ()\n    }\n}\n\n// Entry point\n#[wasm_bindgen(start)]\npub fn main() {\n    run_app(App);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","haf-todo","src","l1_domain","mod.rs"],"content":"//! Layer 1: Domain - Pure Todo business logic\n//! \n//! This layer contains only pure functions and data structures.\n//! No I/O, no side effects, no framework dependencies.\n\nuse serde::{Deserialize, Serialize};\n\n/// Pure Todo data structure\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]\npub struct Todo {\n    pub id: usize,\n    pub title: String,\n    pub completed: bool,\n}\n\n/// Pure TodoList state\n#[derive(Debug, Clone, PartialEq)]\npub struct TodoList {\n    pub todos: Vec\u003cTodo\u003e,\n    pub next_id: usize,\n    pub filter: Filter,\n}\n\n/// Filter options\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum Filter {\n    All,\n    Active,\n    Completed,\n}\n\n/// Pure actions that can be performed on todos\n#[derive(Debug, Clone)]\npub enum TodoAction {\n    Add { title: String },\n    Toggle { id: usize },\n    Delete { id: usize },\n    Edit { id: usize, title: String },\n    SetFilter { filter: Filter },\n    ClearCompleted,\n}\n\nimpl TodoList {\n    /// Create a new empty todo list\n    pub fn new() -\u003e Self {\n        TodoList {\n            todos: Vec::new(),\n            next_id: 1,\n            filter: Filter::All,\n        }\n    }\n    \n    /// Pure reducer function - takes state and action, returns new state\n    pub fn reduce(self, action: TodoAction) -\u003e TodoList {\n        match action {\n            TodoAction::Add { title } =\u003e self.add_todo(title),\n            TodoAction::Toggle { id } =\u003e self.toggle_todo(id),\n            TodoAction::Delete { id } =\u003e self.delete_todo(id),\n            TodoAction::Edit { id, title } =\u003e self.edit_todo(id, title),\n            TodoAction::SetFilter { filter } =\u003e self.set_filter(filter),\n            TodoAction::ClearCompleted =\u003e self.clear_completed(),\n        }\n    }\n    \n    /// Add a new todo\n    fn add_todo(mut self, title: String) -\u003e TodoList {\n        if !title.trim().is_empty() {\n            self.todos.push(Todo {\n                id: self.next_id,\n                title: title.trim().to_string(),\n                completed: false,\n            });\n            self.next_id += 1;\n        }\n        self\n    }\n    \n    /// Toggle todo completion status\n    fn toggle_todo(mut self, id: usize) -\u003e TodoList {\n        if let Some(todo) = self.todos.iter_mut().find(|t| t.id == id) {\n            todo.completed = !todo.completed;\n        }\n        self\n    }\n    \n    /// Delete a todo\n    fn delete_todo(mut self, id: usize) -\u003e TodoList {\n        self.todos.retain(|t| t.id != id);\n        self\n    }\n    \n    /// Edit todo title\n    fn edit_todo(mut self, id: usize, title: String) -\u003e TodoList {\n        if let Some(todo) = self.todos.iter_mut().find(|t| t.id == id) {\n            todo.title = title.trim().to_string();\n        }\n        self\n    }\n    \n    /// Set current filter\n    fn set_filter(mut self, filter: Filter) -\u003e TodoList {\n        self.filter = filter;\n        self\n    }\n    \n    /// Clear all completed todos\n    fn clear_completed(mut self) -\u003e TodoList {\n        self.todos.retain(|t| !t.completed);\n        self\n    }\n    \n    /// Get filtered todos (pure computation)\n    pub fn visible_todos(\u0026self) -\u003e Vec\u003c\u0026Todo\u003e {\n        self.todos\n            .iter()\n            .filter(|todo| match self.filter {\n                Filter::All =\u003e true,\n                Filter::Active =\u003e !todo.completed,\n                Filter::Completed =\u003e todo.completed,\n            })\n            .collect()\n    }\n    \n    /// Count active todos\n    pub fn active_count(\u0026self) -\u003e usize {\n        self.todos.iter().filter(|t| !t.completed).count()\n    }\n    \n    /// Check if any todos are completed\n    pub fn has_completed(\u0026self) -\u003e bool {\n        self.todos.iter().any(|t| t.completed)\n    }\n}\n\n/// Pure validation functions\npub mod validation {\n    /// Validate todo title\n    pub fn validate_title(title: \u0026str) -\u003e Result\u003c(), \u0026'static str\u003e {\n        let trimmed = title.trim();\n        if trimmed.is_empty() {\n            Err(\"Todo title cannot be empty\")\n        } else if trimmed.len() \u003e 200 {\n            Err(\"Todo title is too long (max 200 characters)\")\n        } else {\n            Ok(())\n        }\n    }\n}\n\n/// Pure serialization helpers\npub mod serialization {\n    use super::*;\n    \n    /// Convert TodoList to JSON-serializable format\n    pub fn to_storage_format(list: \u0026TodoList) -\u003e StorageFormat {\n        StorageFormat {\n            todos: list.todos.clone(),\n            next_id: list.next_id,\n        }\n    }\n    \n    /// Restore TodoList from storage format\n    pub fn from_storage_format(storage: StorageFormat) -\u003e TodoList {\n        TodoList {\n            todos: storage.todos,\n            next_id: storage.next_id,\n            filter: Filter::All,\n        }\n    }\n    \n    #[derive(Serialize, Deserialize)]\n    pub struct StorageFormat {\n        pub todos: Vec\u003cTodo\u003e,\n        pub next_id: usize,\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_add_todo() {\n        let list = TodoList::new();\n        let list = list.reduce(TodoAction::Add {\n            title: \"Test todo\".to_string(),\n        });\n        \n        assert_eq!(list.todos.len(), 1);\n        assert_eq!(list.todos[0].title, \"Test todo\");\n        assert!(!list.todos[0].completed);\n    }\n    \n    #[test]\n    fn test_toggle_todo() {\n        let mut list = TodoList::new();\n        list = list.reduce(TodoAction::Add {\n            title: \"Test\".to_string(),\n        });\n        \n        let id = list.todos[0].id;\n        list = list.reduce(TodoAction::Toggle { id });\n        \n        assert!(list.todos[0].completed);\n    }\n    \n    #[test]\n    fn test_filter_todos() {\n        let mut list = TodoList::new();\n        list = list.reduce(TodoAction::Add {\n            title: \"Active\".to_string(),\n        });\n        list = list.reduce(TodoAction::Add {\n            title: \"Completed\".to_string(),\n        });\n        \n        let completed_id = list.todos[1].id;\n        list = list.reduce(TodoAction::Toggle { id: completed_id });\n        \n        list = list.reduce(TodoAction::SetFilter {\n            filter: Filter::Active,\n        });\n        \n        let visible = list.visible_todos();\n        assert_eq!(visible.len(), 1);\n        assert_eq!(visible[0].title, \"Active\");\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","haf-todo","src","l2_runtime","mod.rs"],"content":"//! Layer 2: Runtime - Todo application runtime\n//! \n//! This layer manages state, effects, and coordinates between L1 and L3.\n//! It can perform side effects but only depends on L1.\n\nuse crate::l1_domain::{Filter, Todo, TodoAction, TodoList};\nuse layer9_core::haf::layers::{L1, L2};\nuse layer9_core::haf::{Service, L1ToL2Contract};\nuse std::cell::RefCell;\nuse std::rc::Rc;\n\n/// Todo store - manages application state\npub struct TodoStore {\n    state: RefCell\u003cTodoList\u003e,\n    subscribers: RefCell\u003cVec\u003cBox\u003cdyn Fn(\u0026TodoList)\u003e\u003e\u003e,\n}\n\nimpl TodoStore {\n    /// Create a new todo store\n    pub fn new() -\u003e Rc\u003cSelf\u003e {\n        let store = Rc::new(TodoStore {\n            state: RefCell::new(TodoList::new()),\n            subscribers: RefCell::new(Vec::new()),\n        });\n        \n        // Load from storage if available\n        if let Some(stored) = Storage::load() {\n            *store.state.borrow_mut() = stored;\n        }\n        \n        store\n    }\n    \n    /// Dispatch an action to update state\n    pub fn dispatch(\u0026self, action: TodoAction) {\n        // Apply pure reducer\n        let new_state = self.state.borrow().clone().reduce(action);\n        \n        // Update state\n        *self.state.borrow_mut() = new_state.clone();\n        \n        // Persist to storage\n        Storage::save(\u0026new_state);\n        \n        // Notify subscribers\n        for subscriber in self.subscribers.borrow().iter() {\n            subscriber(\u0026new_state);\n        }\n    }\n    \n    /// Subscribe to state changes\n    pub fn subscribe\u003cF\u003e(\u0026self, callback: F) -\u003e Subscription\n    where\n        F: Fn(\u0026TodoList) + 'static,\n    {\n        let id = self.subscribers.borrow().len();\n        self.subscribers.borrow_mut().push(Box::new(callback));\n        \n        Subscription {\n            id,\n            store: self as *const TodoStore,\n        }\n    }\n    \n    /// Get current state\n    pub fn get_state(\u0026self) -\u003e TodoList {\n        self.state.borrow().clone()\n    }\n}\n\n/// Subscription handle\npub struct Subscription {\n    id: usize,\n    store: *const TodoStore,\n}\n\nimpl Drop for Subscription {\n    fn drop(\u0026mut self) {\n        // In real implementation, would remove subscriber\n    }\n}\n\n/// Storage service - handles persistence\nmod Storage {\n    use super::*;\n    use crate::l1_domain::serialization::{from_storage_format, to_storage_format};\n    \n    const STORAGE_KEY: \u0026str = \"layer9_haf_todos\";\n    \n    pub fn save(list: \u0026TodoList) {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            use wasm_bindgen::JsValue;\n            \n            if let Ok(Some(storage)) = web_sys::window()\n                .and_then(|w| w.local_storage())\n            {\n                let data = to_storage_format(list);\n                if let Ok(json) = serde_json::to_string(\u0026data) {\n                    let _ = storage.set_item(STORAGE_KEY, \u0026json);\n                }\n            }\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            println!(\"Saving todos: {:?}\", list);\n        }\n    }\n    \n    pub fn load() -\u003e Option\u003cTodoList\u003e {\n        #[cfg(target_arch = \"wasm32\")]\n        {\n            web_sys::window()\n                .and_then(|w| w.local_storage().ok())\n                .flatten()\n                .and_then(|storage| storage.get_item(STORAGE_KEY).ok())\n                .flatten()\n                .and_then(|json| serde_json::from_str(\u0026json).ok())\n                .map(from_storage_format)\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            None\n        }\n    }\n}\n\n/// Action to Command contract (L1 → L2)\npub struct ActionToCommandContract;\n\n#[derive(Debug)]\npub enum Command {\n    SaveToStorage(TodoList),\n    NotifySubscribers(TodoList),\n    LogAction(String),\n}\n\nimpl L1ToL2Contract for ActionToCommandContract {\n    type L1Type = TodoAction;\n    type L2Type = Vec\u003cCommand\u003e;\n    \n    fn translate(action: Self::L1Type) -\u003e Self::L2Type {\n        let description = match \u0026action {\n            TodoAction::Add { title } =\u003e format!(\"Adding todo: {}\", title),\n            TodoAction::Toggle { id } =\u003e format!(\"Toggling todo {}\", id),\n            TodoAction::Delete { id } =\u003e format!(\"Deleting todo {}\", id),\n            TodoAction::Edit { id, title } =\u003e format!(\"Editing todo {} to: {}\", id, title),\n            TodoAction::SetFilter { filter } =\u003e format!(\"Setting filter to: {:?}\", filter),\n            TodoAction::ClearCompleted =\u003e \"Clearing completed todos\".to_string(),\n        };\n        \n        vec![\n            Command::LogAction(description),\n            // Other commands would be added based on the action\n        ]\n    }\n}\n\n/// Todo runtime service\nlayer9_core::haf_service!(L2, todo_runtime, {\n    pub fn create_store() -\u003e Rc\u003cTodoStore\u003e {\n        TodoStore::new()\n    }\n    \n    pub fn dispatch_action(store: \u0026TodoStore, action: TodoAction) -\u003e () {\n        store.dispatch(action)\n    }\n    \n    pub fn get_current_state(store: \u0026TodoStore) -\u003e TodoList {\n        store.get_state()\n    }\n});\n\n/// Analytics service - tracks todo usage\npub mod analytics {\n    use super::*;\n    \n    #[derive(Default)]\n    pub struct TodoAnalytics {\n        actions_count: RefCell\u003cusize\u003e,\n        todos_created: RefCell\u003cusize\u003e,\n        todos_completed: RefCell\u003cusize\u003e,\n    }\n    \n    impl TodoAnalytics {\n        pub fn track_action(\u0026self, action: \u0026TodoAction) {\n            *self.actions_count.borrow_mut() += 1;\n            \n            match action {\n                TodoAction::Add { .. } =\u003e {\n                    *self.todos_created.borrow_mut() += 1;\n                }\n                TodoAction::Toggle { .. } =\u003e {\n                    *self.todos_completed.borrow_mut() += 1;\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        pub fn get_stats(\u0026self) -\u003e Stats {\n            Stats {\n                total_actions: *self.actions_count.borrow(),\n                todos_created: *self.todos_created.borrow(),\n                todos_completed: *self.todos_completed.borrow(),\n            }\n        }\n    }\n    \n    pub struct Stats {\n        pub total_actions: usize,\n        pub todos_created: usize,\n        pub todos_completed: usize,\n    }\n}\n\n/// Effects that can be triggered by todo actions\npub mod effects {\n    use super::*;\n    \n    /// Show notification when todo is completed\n    pub fn completion_effect(todo: \u0026Todo) {\n        if todo.completed {\n            #[cfg(target_arch = \"wasm32\")]\n            {\n                web_sys::console::log_1(\u0026format!(\"✅ Completed: {}\", todo.title).into());\n            }\n            \n            #[cfg(not(target_arch = \"wasm32\"))]\n            {\n                println!(\"✅ Completed: {}\", todo.title);\n            }\n        }\n    }\n    \n    /// Log all actions for debugging\n    pub fn logging_effect(action: \u0026TodoAction) {\n        let msg = format!(\"[TodoAction] {:?}\", action);\n        \n        #[cfg(target_arch = \"wasm32\")]\n        {\n            web_sys::console::log_1(\u0026msg.into());\n        }\n        \n        #[cfg(not(target_arch = \"wasm32\"))]\n        {\n            println!(\"{}\", msg);\n        }\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","haf-todo","src","l3_ui","mod.rs"],"content":"//! Layer 3: UI - Todo user interface\n//! \n//! This layer provides the user-facing components and handles external interactions.\n//! It depends on L2 and L1 but nothing depends on it.\n\nuse crate::l1_domain::{Filter, Todo, TodoAction, TodoList};\nuse crate::l2_runtime::{TodoStore, todo_runtime};\nuse layer9_core::haf::{\n    Component, VNode, Props,\n    layers::{L1, L2, L3},\n    haf_component,\n};\nuse layer9_core::prelude::*;\nuse std::rc::Rc;\n\n/// Main Todo App component\npub struct TodoApp {\n    store: Rc\u003cTodoStore\u003e,\n}\n\nimpl TodoApp {\n    pub fn new() -\u003e Self {\n        TodoApp {\n            store: todo_runtime::create_store(),\n        }\n    }\n}\n\n// Define components using HAF macro\nhaf_component!(L3, TodoHeader, HeaderProps, {\n    VNode::Element {\n        tag: \"header\".to_string(),\n        props: Props {\n            attributes: vec![(\"class\".to_string(), \"header\".to_string())],\n        },\n        children: vec![\n            VNode::Element {\n                tag: \"h1\".to_string(),\n                props: Props::default(),\n                children: vec![VNode::Text(\"todos\".to_string())],\n            },\n            VNode::Element {\n                tag: \"input\".to_string(),\n                props: Props {\n                    attributes: vec![\n                        (\"class\".to_string(), \"new-todo\".to_string()),\n                        (\"placeholder\".to_string(), \"What needs to be done?\".to_string()),\n                        (\"autofocus\".to_string(), \"true\".to_string()),\n                    ],\n                },\n                children: vec![],\n            },\n        ],\n    }\n});\n\n#[derive(Clone)]\npub struct HeaderProps {\n    on_add: Rc\u003cdyn Fn(String)\u003e,\n}\n\nhaf_component!(L3, TodoItem, ItemProps, {\n    let todo = \u0026props.todo;\n    let class = if todo.completed {\n        \"completed\"\n    } else {\n        \"\"\n    };\n    \n    VNode::Element {\n        tag: \"li\".to_string(),\n        props: Props {\n            attributes: vec![(\"class\".to_string(), class.to_string())],\n        },\n        children: vec![\n            VNode::Element {\n                tag: \"div\".to_string(),\n                props: Props {\n                    attributes: vec![(\"class\".to_string(), \"view\".to_string())],\n                },\n                children: vec![\n                    VNode::Element {\n                        tag: \"input\".to_string(),\n                        props: Props {\n                            attributes: vec![\n                                (\"class\".to_string(), \"toggle\".to_string()),\n                                (\"type\".to_string(), \"checkbox\".to_string()),\n                                (\"checked\".to_string(), todo.completed.to_string()),\n                            ],\n                        },\n                        children: vec![],\n                    },\n                    VNode::Element {\n                        tag: \"label\".to_string(),\n                        props: Props::default(),\n                        children: vec![VNode::Text(todo.title.clone())],\n                    },\n                    VNode::Element {\n                        tag: \"button\".to_string(),\n                        props: Props {\n                            attributes: vec![(\"class\".to_string(), \"destroy\".to_string())],\n                        },\n                        children: vec![],\n                    },\n                ],\n            },\n        ],\n    }\n});\n\n#[derive(Clone)]\npub struct ItemProps {\n    todo: Todo,\n    on_toggle: Rc\u003cdyn Fn(usize)\u003e,\n    on_delete: Rc\u003cdyn Fn(usize)\u003e,\n}\n\nhaf_component!(L3, TodoFooter, FooterProps, {\n    let active_count = props.active_count;\n    let has_completed = props.has_completed;\n    let current_filter = props.current_filter;\n    \n    VNode::Element {\n        tag: \"footer\".to_string(),\n        props: Props {\n            attributes: vec![(\"class\".to_string(), \"footer\".to_string())],\n        },\n        children: vec![\n            // Item count\n            VNode::Element {\n                tag: \"span\".to_string(),\n                props: Props {\n                    attributes: vec![(\"class\".to_string(), \"todo-count\".to_string())],\n                },\n                children: vec![\n                    VNode::Element {\n                        tag: \"strong\".to_string(),\n                        props: Props::default(),\n                        children: vec![VNode::Text(active_count.to_string())],\n                    },\n                    VNode::Text(format!(\" {} left\", if active_count == 1 { \"item\" } else { \"items\" })),\n                ],\n            },\n            // Filters\n            VNode::Element {\n                tag: \"ul\".to_string(),\n                props: Props {\n                    attributes: vec![(\"class\".to_string(), \"filters\".to_string())],\n                },\n                children: vec![\n                    filter_link(Filter::All, current_filter),\n                    filter_link(Filter::Active, current_filter),\n                    filter_link(Filter::Completed, current_filter),\n                ],\n            },\n            // Clear completed button\n            if has_completed {\n                VNode::Element {\n                    tag: \"button\".to_string(),\n                    props: Props {\n                        attributes: vec![(\"class\".to_string(), \"clear-completed\".to_string())],\n                    },\n                    children: vec![VNode::Text(\"Clear completed\".to_string())],\n                }\n            } else {\n                VNode::Text(\"\".to_string())\n            },\n        ],\n    }\n});\n\n#[derive(Clone)]\npub struct FooterProps {\n    active_count: usize,\n    has_completed: bool,\n    current_filter: Filter,\n    on_filter_change: Rc\u003cdyn Fn(Filter)\u003e,\n    on_clear_completed: Rc\u003cdyn Fn()\u003e,\n}\n\nfn filter_link(filter: Filter, current: Filter) -\u003e VNode {\n    let (text, href) = match filter {\n        Filter::All =\u003e (\"All\", \"#/\"),\n        Filter::Active =\u003e (\"Active\", \"#/active\"),\n        Filter::Completed =\u003e (\"Completed\", \"#/completed\"),\n    };\n    \n    let class = if filter == current {\n        \"selected\"\n    } else {\n        \"\"\n    };\n    \n    VNode::Element {\n        tag: \"li\".to_string(),\n        props: Props::default(),\n        children: vec![\n            VNode::Element {\n                tag: \"a\".to_string(),\n                props: Props {\n                    attributes: vec![\n                        (\"class\".to_string(), class.to_string()),\n                        (\"href\".to_string(), href.to_string()),\n                    ],\n                },\n                children: vec![VNode::Text(text.to_string())],\n            },\n        ],\n    }\n}\n\n/// Main app render function\npub fn render_app(store: \u0026TodoStore) -\u003e VNode {\n    let state = store.get_state();\n    let visible_todos = state.visible_todos();\n    \n    VNode::Element {\n        tag: \"section\".to_string(),\n        props: Props {\n            attributes: vec![(\"class\".to_string(), \"todoapp\".to_string())],\n        },\n        children: vec![\n            // Header\n            TodoHeader(HeaderProps {\n                on_add: Rc::new(move |title| {\n                    todo_runtime::dispatch_action(\n                        store,\n                        TodoAction::Add { title }\n                    );\n                }),\n            }).inner.render(),\n            \n            // Main section\n            if !state.todos.is_empty() {\n                VNode::Element {\n                    tag: \"section\".to_string(),\n                    props: Props {\n                        attributes: vec![(\"class\".to_string(), \"main\".to_string())],\n                    },\n                    children: vec![\n                        // Toggle all\n                        VNode::Element {\n                            tag: \"input\".to_string(),\n                            props: Props {\n                                attributes: vec![\n                                    (\"id\".to_string(), \"toggle-all\".to_string()),\n                                    (\"class\".to_string(), \"toggle-all\".to_string()),\n                                    (\"type\".to_string(), \"checkbox\".to_string()),\n                                ],\n                            },\n                            children: vec![],\n                        },\n                        VNode::Element {\n                            tag: \"label\".to_string(),\n                            props: Props {\n                                attributes: vec![(\"for\".to_string(), \"toggle-all\".to_string())],\n                            },\n                            children: vec![VNode::Text(\"Mark all as complete\".to_string())],\n                        },\n                        // Todo list\n                        VNode::Element {\n                            tag: \"ul\".to_string(),\n                            props: Props {\n                                attributes: vec![(\"class\".to_string(), \"todo-list\".to_string())],\n                            },\n                            children: visible_todos.into_iter().map(|todo| {\n                                TodoItem(ItemProps {\n                                    todo: todo.clone(),\n                                    on_toggle: Rc::new(move |id| {\n                                        todo_runtime::dispatch_action(\n                                            store,\n                                            TodoAction::Toggle { id }\n                                        );\n                                    }),\n                                    on_delete: Rc::new(move |id| {\n                                        todo_runtime::dispatch_action(\n                                            store,\n                                            TodoAction::Delete { id }\n                                        );\n                                    }),\n                                }).inner.render()\n                            }).collect(),\n                        },\n                    ],\n                }\n            } else {\n                VNode::Text(\"\".to_string())\n            },\n            \n            // Footer\n            if !state.todos.is_empty() {\n                TodoFooter(FooterProps {\n                    active_count: state.active_count(),\n                    has_completed: state.has_completed(),\n                    current_filter: state.filter,\n                    on_filter_change: Rc::new(move |filter| {\n                        todo_runtime::dispatch_action(\n                            store,\n                            TodoAction::SetFilter { filter }\n                        );\n                    }),\n                    on_clear_completed: Rc::new(move || {\n                        todo_runtime::dispatch_action(\n                            store,\n                            TodoAction::ClearCompleted\n                        );\n                    }),\n                }).inner.render()\n            } else {\n                VNode::Text(\"\".to_string())\n            },\n        ],\n    }\n}\n\n/// Style definitions (would normally be in a separate CSS file)\npub fn get_styles() -\u003e \u0026'static str {\n    r#\"\n    body {\n        font: 14px 'Helvetica Neue', Helvetica, Arial, sans-serif;\n        background: #f5f5f5;\n        color: #111111;\n        margin: 0;\n        padding: 0;\n    }\n\n    .todoapp {\n        background: #fff;\n        margin: 130px 0 40px 0;\n        position: relative;\n        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2),\n                    0 25px 50px 0 rgba(0, 0, 0, 0.1);\n    }\n\n    .todoapp h1 {\n        position: absolute;\n        top: -140px;\n        width: 100%;\n        font-size: 80px;\n        font-weight: 200;\n        text-align: center;\n        color: #b83f45;\n        text-rendering: optimizeLegibility;\n    }\n\n    .new-todo {\n        position: relative;\n        margin: 0;\n        width: 100%;\n        font-size: 24px;\n        font-family: inherit;\n        font-weight: inherit;\n        line-height: 1.4em;\n        color: inherit;\n        padding: 6px;\n        border: 1px solid #999;\n        box-shadow: inset 0 -1px 5px 0 rgba(0, 0, 0, 0.2);\n        box-sizing: border-box;\n    }\n\n    .todo-list {\n        margin: 0;\n        padding: 0;\n        list-style: none;\n    }\n\n    .todo-list li {\n        position: relative;\n        font-size: 24px;\n        border-bottom: 1px solid #ededed;\n    }\n\n    .todo-list li.completed label {\n        color: #a9a9a9;\n        text-decoration: line-through;\n    }\n\n    .footer {\n        padding: 10px 15px;\n        height: 20px;\n        text-align: center;\n        font-size: 15px;\n        border-top: 1px solid #e6e6e6;\n    }\n\n    .filters {\n        margin: 0;\n        padding: 0;\n        list-style: none;\n        position: absolute;\n        right: 0;\n        left: 0;\n    }\n\n    .filters li {\n        display: inline;\n    }\n\n    .filters li a {\n        color: inherit;\n        margin: 3px;\n        padding: 3px 7px;\n        text-decoration: none;\n        border: 1px solid transparent;\n        border-radius: 3px;\n    }\n\n    .filters li a.selected {\n        border-color: #b83f45;\n    }\n    \"#\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","haf-todo","src","lib.rs"],"content":"//! HAF Todo Example - Demonstrates Hierarchical Architecture First principles\n//! \n//! This example shows how to build a Todo app following HAF principles:\n//! - L1 (Domain): Pure business logic with no dependencies\n//! - L2 (Runtime): State management and effects\n//! - L3 (UI): User interface and external interactions\n//! \n//! Notice how dependencies only flow downward: L3 → L2 → L1\n\nuse wasm_bindgen::prelude::*;\nuse layer9_core::haf::l3_framework::App;\n\n// Layer modules - organized by architectural layers\npub mod l1_domain;\npub mod l2_runtime; \npub mod l3_ui;\n\n/// Entry point for the WASM application\n#[wasm_bindgen(start)]\npub fn main() {\n    // Set panic hook for better error messages in browser\n    console_error_panic_hook::set_once();\n    \n    // Create and mount the application\n    let app = App::new()\n        .component(|| {\n            let store = l2_runtime::todo_runtime::create_store();\n            l3_ui::render_app(\u0026store)\n        });\n    \n    // Inject styles\n    inject_styles();\n    \n    // Mount to DOM\n    #[cfg(target_arch = \"wasm32\")]\n    app.mount(\"#app\");\n}\n\n/// Inject TodoMVC styles into the document\nfn inject_styles() {\n    #[cfg(target_arch = \"wasm32\")]\n    {\n        let window = web_sys::window().unwrap();\n        let document = window.document().unwrap();\n        let head = document.head().unwrap();\n        \n        let style = document.create_element(\"style\").unwrap();\n        style.set_inner_html(l3_ui::get_styles());\n        head.append_child(\u0026style).unwrap();\n    }\n}\n\n/// Example of HAF principles in action\n#[cfg(test)]\nmod haf_principles {\n    use super::*;\n    use crate::l1_domain::{TodoList, TodoAction};\n    \n    #[test]\n    fn test_layer_separation() {\n        // L1: Pure domain logic - no I/O, no dependencies\n        let list = TodoList::new();\n        let list = list.reduce(TodoAction::Add {\n            title: \"Learn HAF\".to_string()\n        });\n        assert_eq!(list.todos.len(), 1);\n        \n        // L2: Runtime manages state and effects\n        let store = l2_runtime::TodoStore::new();\n        store.dispatch(TodoAction::Add {\n            title: \"Apply HAF\".to_string()\n        });\n        \n        // L3: UI renders based on state from L2\n        // In a real app, this would create VNodes\n        let _vnode = l3_ui::render_app(\u0026store);\n    }\n    \n    #[test]\n    fn test_dependency_direction() {\n        // This compiles: L2 can use L1\n        use crate::l1_domain::Todo;\n        let _todo = Todo {\n            id: 1,\n            title: \"Test\".to_string(),\n            completed: false,\n        };\n        \n        // This compiles: L3 can use L2\n        use crate::l2_runtime::TodoStore;\n        let _store = TodoStore::new();\n        \n        // L1 cannot use L2 or L3 (would not compile if attempted)\n        // This enforces proper dependency direction\n    }\n    \n    #[test]\n    fn test_translation_contracts() {\n        use layer9_core::haf::L1ToL2Contract;\n        use crate::l2_runtime::{ActionToCommandContract, Command};\n        \n        // Actions (L1) are translated to Commands (L2)\n        let action = TodoAction::Add {\n            title: \"Test contract\".to_string()\n        };\n        \n        let commands = ActionToCommandContract::translate(action);\n        assert!(!commands.is_empty());\n        \n        // Each layer speaks its own language\n        match \u0026commands[0] {\n            Command::LogAction(msg) =\u003e {\n                assert!(msg.contains(\"Adding todo\"));\n            }\n            _ =\u003e {}\n        }\n    }\n}\n\n/// Documentation of the HAF structure\npub mod architecture {\n    //! # HAF Architecture Overview\n    //! \n    //! ## Layer 1: Domain (l1_domain)\n    //! - Pure business logic\n    //! - No framework dependencies\n    //! - Immutable data structures\n    //! - Pure functions only\n    //! \n    //! ## Layer 2: Runtime (l2_runtime)  \n    //! - State management (TodoStore)\n    //! - Side effects (Storage, Analytics)\n    //! - Translation contracts\n    //! - Event handling\n    //! \n    //! ## Layer 3: UI (l3_ui)\n    //! - User interface components\n    //! - External API calls\n    //! - Browser interactions\n    //! - Framework-specific code\n    //! \n    //! ## Key Principles\n    //! 1. Dependencies flow downward only (L3 → L2 → L1)\n    //! 2. Each layer has clear responsibilities\n    //! 3. Explicit contracts between layers\n    //! 4. Pure core with effects at edges\n}\n\n/// Example usage from JavaScript\n#[wasm_bindgen]\npub fn create_todo_app() -\u003e Result\u003c(), JsValue\u003e {\n    main();\n    Ok(())\n}\n\n/// Expose todo operations to JavaScript\n#[wasm_bindgen]\npub struct TodoAppHandle {\n    store: std::rc::Rc\u003cl2_runtime::TodoStore\u003e,\n}\n\n#[wasm_bindgen]\nimpl TodoAppHandle {\n    #[wasm_bindgen(constructor)]\n    pub fn new() -\u003e Self {\n        TodoAppHandle {\n            store: l2_runtime::todo_runtime::create_store(),\n        }\n    }\n    \n    #[wasm_bindgen]\n    pub fn add_todo(\u0026self, title: String) {\n        use l1_domain::TodoAction;\n        self.store.dispatch(TodoAction::Add { title });\n    }\n    \n    #[wasm_bindgen]\n    pub fn toggle_todo(\u0026self, id: usize) {\n        use l1_domain::TodoAction;\n        self.store.dispatch(TodoAction::Toggle { id });\n    }\n    \n    #[wasm_bindgen]\n    pub fn get_active_count(\u0026self) -\u003e usize {\n        self.store.get_state().active_count()\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","image-optimization","src","lib.rs"],"content":"//! Image Optimization Example\n//! Demonstrates all image optimization features in Layer9\n\nuse layer9_core::prelude::*;\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen::JsCast;\n\n// Demo styles\nconst DEMO_STYLES: \u0026str = r#\"\n* {\n    box-sizing: border-box;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n    margin: 0;\n    padding: 0;\n    background: #f5f5f5;\n    color: #333;\n}\n\n.image-gallery {\n    max-width: 1200px;\n    margin: 0 auto;\n    padding: 2rem;\n}\n\nh1 {\n    text-align: center;\n    margin-bottom: 3rem;\n    font-size: 2.5rem;\n    color: #000;\n}\n\nh2 {\n    margin: 3rem 0 1.5rem;\n    font-size: 1.8rem;\n    color: #333;\n}\n\nsection {\n    background: white;\n    padding: 2rem;\n    margin-bottom: 2rem;\n    border-radius: 8px;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n}\n\n.grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));\n    gap: 1.5rem;\n}\n\n.gallery-image {\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    transition: opacity 0.3s ease;\n}\n\n.gallery-image.loading {\n    opacity: 0;\n}\n\n.gallery-image.loaded {\n    opacity: 1;\n}\n\n.format-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: 2rem;\n}\n\n.format-grid \u003e div {\n    text-align: center;\n}\n\n.format-grid h3 {\n    margin-bottom: 1rem;\n    font-size: 1.2rem;\n}\n\n.quality-demo-container {\n    max-width: 800px;\n    margin: 0 auto;\n}\n\n.controls {\n    margin-bottom: 2rem;\n}\n\n.controls label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 600;\n}\n\n.controls input[type=\"range\"] {\n    width: 100%;\n    height: 8px;\n    border-radius: 4px;\n    background: #ddd;\n    outline: none;\n}\n\n.quality-comparison img {\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n}\n\n.background-demo {\n    position: relative;\n    min-height: 400px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.background-image {\n    position: absolute;\n    inset: 0;\n    background-size: cover;\n    background-position: center;\n    transition: opacity 0.5s ease;\n}\n\n.content-overlay {\n    position: relative;\n    z-index: 1;\n    background: rgba(255, 255, 255, 0.9);\n    padding: 2rem;\n    border-radius: 8px;\n    text-align: center;\n}\n\n/* Loading shimmer effect */\n.shimmer {\n    background: linear-gradient(\n        90deg,\n        #f0f0f0 0%,\n        #f8f8f8 50%,\n        #f0f0f0 100%\n    );\n    background-size: 200% 100%;\n    animation: shimmer 1.5s infinite;\n}\n\n@keyframes shimmer {\n    0% {\n        background-position: -200% 0;\n    }\n    100% {\n        background-position: 200% 0;\n    }\n}\n\n/* Responsive adjustments */\n@media (max-width: 768px) {\n    .image-gallery {\n        padding: 1rem;\n    }\n    \n    section {\n        padding: 1rem;\n    }\n    \n    h1 {\n        font-size: 2rem;\n    }\n    \n    h2 {\n        font-size: 1.5rem;\n    }\n    \n    .grid {\n        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n        gap: 1rem;\n    }\n}\n\"#;\n\n/// Image gallery component demonstrating various optimization techniques\npub struct ImageGallery;\n\nimpl Component for ImageGallery {\n    fn render(\u0026self) -\u003e Element {\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"image-gallery\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                // Title\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Layer9 Image Optimization Demo\".to_string())],\n                },\n                \n                // Hero section\n                render_hero_section(),\n                \n                // Lazy gallery section\n                render_lazy_gallery(),\n                \n                // Art direction section\n                render_art_direction(),\n                \n                // Blur placeholder section\n                render_blur_placeholder(),\n                \n                // Format demo section\n                render_format_demo(),\n                \n                // Quality demo section\n                QualityDemo.render(),\n                \n                // Background image section\n                render_background_demo(),\n            ],\n        }\n    }\n}\n\nfn render_hero_section() -\u003e Element {\n    Element::Node {\n        tag: \"section\".to_string(),\n        props: Props {\n            class: Some(\"hero-section\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Hero Image with Responsive Loading\".to_string())],\n            },\n            Image::new(\"/images/hero.jpg\")\n                .alt(\"Hero image demonstrating responsive loading\")\n                .width(1920)\n                .height(1080)\n                .sizes(\"(max-width: 640px) 100vw, (max-width: 1024px) 90vw, 1200px\")\n                .quality(90)\n                .priority()\n                .render(),\n        ],\n    }\n}\n\nfn render_lazy_gallery() -\u003e Element {\n    Element::Node {\n        tag: \"section\".to_string(),\n        props: Props {\n            class: Some(\"lazy-gallery\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Lazy Loaded Image Gallery\".to_string())],\n            },\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"grid\".to_string()),\n                    ..Default::default()\n                },\n                children: (1..=12).map(|i| {\n                    LazyImage::new(format!(\"/images/gallery/photo-{}.jpg\", i))\n                        .alt(format!(\"Gallery photo {}\", i))\n                        .width(400)\n                        .height(300)\n                        .placeholder(format!(\"/images/gallery/photo-{}-placeholder.jpg\", i))\n                        .class(\"gallery-image\")\n                        .srcset(format!(\n                            \"/images/gallery/photo-{}-400w.jpg 400w, /images/gallery/photo-{}-800w.jpg 800w\",\n                            i, i\n                        ))\n                        .sizes(\"(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 400px\")\n                        .render()\n                }).collect(),\n            },\n        ],\n    }\n}\n\nfn render_art_direction() -\u003e Element {\n    Element::Node {\n        tag: \"section\".to_string(),\n        props: Props {\n            class: Some(\"art-direction\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Art Direction with Picture Element\".to_string())],\n            },\n            Picture::new(\n                Image::new(\"/images/product.jpg\")\n                    .alt(\"Product image with art direction\")\n            )\n            .source_with_type(\n                \"(max-width: 640px)\",\n                \"/images/product-mobile.webp\",\n                \"image/webp\"\n            )\n            .source_with_type(\n                \"(max-width: 640px)\",\n                \"/images/product-mobile.jpg\",\n                \"image/jpeg\"\n            )\n            .source_with_type(\n                \"(min-width: 641px)\",\n                \"/images/product-desktop.webp\",\n                \"image/webp\"\n            )\n            .render(),\n        ],\n    }\n}\n\nfn render_blur_placeholder() -\u003e Element {\n    Element::Node {\n        tag: \"section\".to_string(),\n        props: Props {\n            class: Some(\"blur-placeholder\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Image with Blur Placeholder\".to_string())],\n            },\n            Image::new(\"/images/landscape.jpg\")\n                .alt(\"Beautiful landscape with blur placeholder\")\n                .width(1200)\n                .height(800)\n                .placeholder(ImagePlaceholder::Blur(\n                    \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...\".to_string()\n                ))\n                .render(),\n        ],\n    }\n}\n\nfn render_format_demo() -\u003e Element {\n    Element::Node {\n        tag: \"section\".to_string(),\n        props: Props {\n            class: Some(\"format-demo\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Format Optimization Demo\".to_string())],\n            },\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"format-grid\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    render_format_item(\"Original JPEG\", \"/images/sample.jpg\", \"Original JPEG image\"),\n                    render_format_item(\"Optimized WebP\", \"/_layer9/image?src=/images/sample.jpg\u0026f=webp\", \"WebP optimized image\"),\n                    render_format_item(\"AVIF Format\", \"/_layer9/image?src=/images/sample.jpg\u0026f=avif\", \"AVIF optimized image\"),\n                ],\n            },\n        ],\n    }\n}\n\nfn render_format_item(title: \u0026str, src: \u0026str, alt: \u0026str) -\u003e Element {\n    Element::Node {\n        tag: \"div\".to_string(),\n        props: Props::default(),\n        children: vec![\n            Element::Node {\n                tag: \"h3\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(title.to_string())],\n            },\n            Image::new(src)\n                .alt(alt)\n                .width(600)\n                .height(400)\n                .render(),\n        ],\n    }\n}\n\nfn render_background_demo() -\u003e Element {\n    Element::Node {\n        tag: \"section\".to_string(),\n        props: Props {\n            class: Some(\"background-demo\".to_string()),\n            ..Default::default()\n        },\n        children: vec![\n            Element::Node {\n                tag: \"h2\".to_string(),\n                props: Props::default(),\n                children: vec![Element::Text(\"Background Image Optimization\".to_string())],\n            },\n            BackgroundImage::new(\"/images/background.jpg\")\n                .loading(ImageLoading::Lazy)\n                .children(vec![\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"content-overlay\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            Element::Node {\n                                tag: \"h3\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(\"Content over optimized background\".to_string())],\n                            },\n                            Element::Node {\n                                tag: \"p\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(\"Background images are also lazily loaded and optimized\".to_string())],\n                            },\n                        ],\n                    }\n                ])\n                .render(),\n        ],\n    }\n}\n\n/// Interactive quality demo component\nstruct QualityDemo;\n\nimpl Component for QualityDemo {\n    fn render(\u0026self) -\u003e Element {\n        let quality = use_state(|| 85u8);\n        let quality_value = quality.get();\n        \n        Element::Node {\n            tag: \"section\".to_string(),\n            props: Props {\n                class: Some(\"quality-demo\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h2\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Quality Settings Demo\".to_string())],\n                },\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"quality-demo-container\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"controls\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"label\".to_string(),\n                                    props: Props {\n                                        attributes: vec![(\"for\".to_string(), \"quality-slider\".to_string())],\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Text(format!(\"Quality: {}%\", quality_value)),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"input\".to_string(),\n                                    props: Props {\n                                        attributes: vec![\n                                            (\"type\".to_string(), \"range\".to_string()),\n                                            (\"id\".to_string(), \"quality-slider\".to_string()),\n                                            (\"min\".to_string(), \"1\".to_string()),\n                                            (\"max\".to_string(), \"100\".to_string()),\n                                            (\"value\".to_string(), quality_value.to_string()),\n                                        ],\n                                        ..Default::default()\n                                    },\n                                    children: vec![],\n                                },\n                            ],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"quality-comparison\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Image::new(\"/images/quality-test.jpg\")\n                                    .alt(format!(\"Image at {}% quality\", quality_value))\n                                    .width(800)\n                                    .height(600)\n                                    .quality(quality_value)\n                                    .render(),\n                            ],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\n/// Image optimization service worker registration\nfn register_service_worker() {\n    if let Some(window) = web_sys::window() {\n        if let Some(navigator) = window.navigator() {\n            if let Ok(service_worker) = navigator.service_worker() {\n                wasm_bindgen_futures::spawn_local(async move {\n                    match service_worker.register(\"/sw.js\").await {\n                        Ok(_) =\u003e web_sys::console::log_1(\u0026\"Service Worker registered\".into()),\n                        Err(e) =\u003e web_sys::console::error_1(\u0026format!(\"SW registration failed: {:?}\", e).into()),\n                    }\n                });\n            }\n        }\n    }\n}\n\n/// Initialize the demo app\n#[wasm_bindgen(start)]\npub fn init() {\n    console_error_panic_hook::set_once();\n    \n    // Initialize lazy loading manager\n    LazyLoadManager::init(Default::default());\n    \n    // Register service worker for offline image caching\n    register_service_worker();\n    \n    // Inject styles\n    inject_global_styles(DEMO_STYLES);\n    \n    // Mount the app\n    mount(\"app\", ImageGallery);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","memory-game","src","lib.rs"],"content":"//! Beautiful Memory Card Game\n//! A fun, interactive game showcasing Layer9's reactive capabilities\n\nuse layer9_core::prelude::*;\nuse layer9_core::hooks::use_state;\nuse layer9_core::reactive_v2::mount;\nuse std::rc::Rc;\nuse wasm_bindgen::prelude::*;\nuse rand::seq::SliceRandom;\nuse rand::thread_rng;\n\n#[global_allocator]\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;\n\n#[derive(Clone, Debug, PartialEq)]\nstruct Card {\n    id: usize,\n    emoji: String,\n    is_flipped: bool,\n    is_matched: bool,\n}\n\nconst EMOJIS: \u0026[\u0026str] = \u0026[\"🎨\", \"🚀\", \"🌟\", \"💎\", \"🔮\", \"🎯\", \"🎭\", \"🎪\"];\n\nstruct MemoryGame;\n\nimpl Component for MemoryGame {\n    fn render(\u0026self) -\u003e Element {\n        let (cards, set_cards) = use_state(create_initial_cards());\n        let (selected, set_selected) = use_state(Vec::\u003cusize\u003e::new());\n        let (moves, set_moves) = use_state(0);\n        let (game_won, set_game_won) = use_state(false);\n        \n        // Check for matches\n        use_effect(selected.clone(), {\n            let selected = selected.clone();\n            let cards = cards.clone();\n            let set_cards = set_cards.clone();\n            let set_selected = set_selected.clone();\n            let set_moves = set_moves.clone();\n            let set_game_won = set_game_won.clone();\n            \n            move || {\n                if selected.len() == 2 {\n                    set_moves(moves + 1);\n                    \n                    let first_idx = selected[0];\n                    let second_idx = selected[1];\n                    \n                    if first_idx != second_idx {\n                        let first_card = \u0026cards[first_idx];\n                        let second_card = \u0026cards[second_idx];\n                        \n                        if first_card.emoji == second_card.emoji {\n                            // Match found!\n                            let mut new_cards = cards.clone();\n                            new_cards[first_idx].is_matched = true;\n                            new_cards[second_idx].is_matched = true;\n                            set_cards(new_cards.clone());\n                            \n                            // Check if game is won\n                            if new_cards.iter().all(|c| c.is_matched) {\n                                set_game_won(true);\n                            }\n                            \n                            // Clear selection\n                            let window = web_sys::window().unwrap();\n                            let set_selected = set_selected.clone();\n                            let closure = Closure::wrap(Box::new(move || {\n                                set_selected(vec![]);\n                            }) as Box\u003cdyn FnMut()\u003e);\n                            window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                                closure.as_ref().unchecked_ref(),\n                                500\n                            ).unwrap();\n                            closure.forget();\n                        } else {\n                            // No match - flip cards back\n                            let window = web_sys::window().unwrap();\n                            let cards = cards.clone();\n                            let set_cards = set_cards.clone();\n                            let set_selected = set_selected.clone();\n                            let closure = Closure::wrap(Box::new(move || {\n                                let mut new_cards = cards.clone();\n                                new_cards[first_idx].is_flipped = false;\n                                new_cards[second_idx].is_flipped = false;\n                                set_cards(new_cards);\n                                set_selected(vec![]);\n                            }) as Box\u003cdyn FnMut()\u003e);\n                            window.set_timeout_with_callback_and_timeout_and_arguments_0(\n                                closure.as_ref().unchecked_ref(),\n                                1000\n                            ).unwrap();\n                            closure.forget();\n                        }\n                    }\n                }\n                || {}\n            }\n        });\n        \n        let handle_card_click = |idx: usize| {\n            let cards = cards.clone();\n            let selected = selected.clone();\n            let set_cards = set_cards.clone();\n            let set_selected = set_selected.clone();\n            \n            move || {\n                if selected.len() \u003c 2 \u0026\u0026 !cards[idx].is_flipped \u0026\u0026 !cards[idx].is_matched {\n                    let mut new_cards = cards.clone();\n                    new_cards[idx].is_flipped = true;\n                    set_cards(new_cards);\n                    \n                    let mut new_selected = selected.clone();\n                    new_selected.push(idx);\n                    set_selected(new_selected);\n                }\n            }\n        };\n        \n        let reset_game = {\n            let set_cards = set_cards.clone();\n            let set_selected = set_selected.clone();\n            let set_moves = set_moves.clone();\n            let set_game_won = set_game_won.clone();\n            move || {\n                set_cards(create_initial_cards());\n                set_selected(vec![]);\n                set_moves(0);\n                set_game_won(false);\n            }\n        };\n\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"memory-game\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                // Inline styles\n                Element::Node {\n                    tag: \"style\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(GAME_STYLES.to_string())],\n                },\n                \n                // Background animation\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"bg-animation\".to_string()),\n                        ..Default::default()\n                    },\n                    children: (0..5).map(|i| {\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(format!(\"star star-{}\", i + 1)),\n                                ..Default::default()\n                            },\n                            children: vec![],\n                        }\n                    }).collect(),\n                },\n                \n                // Game container\n                Element::Node {\n                    tag: \"div\".to_string(),\n                    props: Props {\n                        class: Some(\"game-container\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        // Header\n                        Element::Node {\n                            tag: \"header\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Node {\n                                    tag: \"h1\".to_string(),\n                                    props: Props::default(),\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"gradient-text\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Memory\".to_string())],\n                                        },\n                                        Element::Text(\" Game\".to_string()),\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"p\".to_string(),\n                                    props: Props {\n                                        class: Some(\"subtitle\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Match the cards to win!\".to_string())],\n                                },\n                            ],\n                        },\n                        \n                        // Stats\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"stats\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"stat\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"stat-label\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Moves\".to_string())],\n                                        },\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"stat-value\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(moves.to_string())],\n                                        },\n                                    ],\n                                },\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\"stat\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"stat-label\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(\"Matches\".to_string())],\n                                        },\n                                        Element::Node {\n                                            tag: \"span\".to_string(),\n                                            props: Props {\n                                                class: Some(\"stat-value\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![Element::Text(format!(\"{}/8\", cards.iter().filter(|c| c.is_matched).count() / 2))],\n                                        },\n                                    ],\n                                },\n                            ],\n                        },\n                        \n                        // Game board\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"game-board\".to_string()),\n                                ..Default::default()\n                            },\n                            children: cards.iter().enumerate().map(|(idx, card)| {\n                                Element::Node {\n                                    tag: \"div\".to_string(),\n                                    props: Props {\n                                        class: Some(\n                                            if card.is_matched {\n                                                \"card matched\".to_string()\n                                            } else if card.is_flipped {\n                                                \"card flipped\".to_string()\n                                            } else {\n                                                \"card\".to_string()\n                                            }\n                                        ),\n                                        on_click: Some(Rc::new(handle_card_click(idx))),\n                                        ..Default::default()\n                                    },\n                                    children: vec![\n                                        Element::Node {\n                                            tag: \"div\".to_string(),\n                                            props: Props {\n                                                class: Some(\"card-inner\".to_string()),\n                                                ..Default::default()\n                                            },\n                                            children: vec![\n                                                Element::Node {\n                                                    tag: \"div\".to_string(),\n                                                    props: Props {\n                                                        class: Some(\"card-front\".to_string()),\n                                                        ..Default::default()\n                                                    },\n                                                    children: vec![Element::Text(\"?\".to_string())],\n                                                },\n                                                Element::Node {\n                                                    tag: \"div\".to_string(),\n                                                    props: Props {\n                                                        class: Some(\"card-back\".to_string()),\n                                                        ..Default::default()\n                                                    },\n                                                    children: vec![Element::Text(card.emoji.clone())],\n                                                },\n                                            ],\n                                        },\n                                    ],\n                                }\n                            }).collect(),\n                        },\n                        \n                        // Win screen or reset button\n                        if game_won {\n                            Element::Node {\n                                tag: \"div\".to_string(),\n                                props: Props {\n                                    class: Some(\"win-screen\".to_string()),\n                                    ..Default::default()\n                                },\n                                children: vec![\n                                    Element::Node {\n                                        tag: \"h2\".to_string(),\n                                        props: Props::default(),\n                                        children: vec![Element::Text(\"🎉 Congratulations! 🎉\".to_string())],\n                                    },\n                                    Element::Node {\n                                        tag: \"p\".to_string(),\n                                        props: Props::default(),\n                                        children: vec![Element::Text(format!(\"You won in {} moves!\", moves))],\n                                    },\n                                    Element::Node {\n                                        tag: \"button\".to_string(),\n                                        props: Props {\n                                            class: Some(\"btn btn-primary\".to_string()),\n                                            on_click: Some(Rc::new(reset_game.clone())),\n                                            ..Default::default()\n                                        },\n                                        children: vec![Element::Text(\"Play Again\".to_string())],\n                                    },\n                                ],\n                            }\n                        } else {\n                            Element::Node {\n                                tag: \"button\".to_string(),\n                                props: Props {\n                                    class: Some(\"btn btn-secondary\".to_string()),\n                                    on_click: Some(Rc::new(reset_game)),\n                                    ..Default::default()\n                                },\n                                children: vec![Element::Text(\"New Game\".to_string())],\n                            }\n                        },\n                        \n                        // Footer\n                        Element::Node {\n                            tag: \"footer\".to_string(),\n                            props: Props::default(),\n                            children: vec![\n                                Element::Text(\"Built with \".to_string()),\n                                Element::Node {\n                                    tag: \"a\".to_string(),\n                                    props: Props {\n                                        attributes: vec![\n                                            (\"href\".to_string(), \"https://github.com/anthropics/layer9\".to_string()),\n                                            (\"target\".to_string(), \"_blank\".to_string()),\n                                        ],\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"Layer9\".to_string())],\n                                },\n                                Element::Text(\" • Interactive Game Demo\".to_string()),\n                            ],\n                        },\n                    ],\n                },\n            ],\n        }\n    }\n}\n\nfn create_initial_cards() -\u003e Vec\u003cCard\u003e {\n    let mut cards = Vec::new();\n    let mut id = 0;\n    \n    // Create pairs of cards\n    for emoji in EMOJIS {\n        for _ in 0..2 {\n            cards.push(Card {\n                id,\n                emoji: emoji.to_string(),\n                is_flipped: false,\n                is_matched: false,\n            });\n            id += 1;\n        }\n    }\n    \n    // Shuffle cards\n    let mut rng = thread_rng();\n    cards.shuffle(\u0026mut rng);\n    \n    cards\n}\n\nconst GAME_STYLES: \u0026str = r#\"\n    :root {\n        --game-primary: #6366f1;\n        --game-secondary: #ec4899;\n        --game-success: #10b981;\n        --game-gradient-1: #6366f1;\n        --game-gradient-2: #a855f7;\n        --game-gradient-3: #ec4899;\n    }\n    \n    * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n    }\n    \n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        background: linear-gradient(135deg, var(--game-gradient-1), var(--game-gradient-2), var(--game-gradient-3));\n        min-height: 100vh;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n    }\n    \n    .memory-game {\n        position: relative;\n        width: 100%;\n        padding: 20px;\n    }\n    \n    .bg-animation {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n    }\n    \n    .star {\n        position: absolute;\n        width: 4px;\n        height: 4px;\n        background: white;\n        border-radius: 50%;\n        animation: twinkle 5s infinite;\n    }\n    \n    .star-1 { top: 10%; left: 20%; animation-delay: 0s; }\n    .star-2 { top: 30%; left: 80%; animation-delay: 1s; }\n    .star-3 { top: 60%; left: 10%; animation-delay: 2s; }\n    .star-4 { top: 80%; left: 70%; animation-delay: 3s; }\n    .star-5 { top: 50%; left: 50%; animation-delay: 4s; }\n    \n    @keyframes twinkle {\n        0%, 100% { opacity: 0; transform: scale(0.5); }\n        50% { opacity: 1; transform: scale(1.5); }\n    }\n    \n    .game-container {\n        max-width: 600px;\n        margin: 0 auto;\n        background: rgba(255, 255, 255, 0.95);\n        backdrop-filter: blur(20px);\n        border-radius: 30px;\n        padding: 40px;\n        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);\n        position: relative;\n        z-index: 1;\n    }\n    \n    header {\n        text-align: center;\n        margin-bottom: 30px;\n    }\n    \n    h1 {\n        font-size: 3rem;\n        font-weight: 800;\n        color: #1a202c;\n        margin-bottom: 10px;\n    }\n    \n    h2 {\n        font-size: 2rem;\n        color: var(--game-success);\n        margin-bottom: 15px;\n    }\n    \n    .gradient-text {\n        background: linear-gradient(135deg, var(--game-primary), var(--game-secondary));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n    }\n    \n    .subtitle {\n        color: #64748b;\n        font-size: 1.2rem;\n    }\n    \n    .stats {\n        display: flex;\n        justify-content: center;\n        gap: 40px;\n        margin-bottom: 30px;\n    }\n    \n    .stat {\n        text-align: center;\n    }\n    \n    .stat-label {\n        display: block;\n        font-size: 0.9rem;\n        color: #64748b;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        margin-bottom: 5px;\n    }\n    \n    .stat-value {\n        display: block;\n        font-size: 2rem;\n        font-weight: 700;\n        color: var(--game-primary);\n    }\n    \n    .game-board {\n        display: grid;\n        grid-template-columns: repeat(4, 1fr);\n        gap: 15px;\n        margin-bottom: 30px;\n    }\n    \n    .card {\n        aspect-ratio: 1;\n        cursor: pointer;\n        perspective: 1000px;\n    }\n    \n    .card-inner {\n        position: relative;\n        width: 100%;\n        height: 100%;\n        text-align: center;\n        transition: transform 0.6s;\n        transform-style: preserve-3d;\n    }\n    \n    .card.flipped .card-inner,\n    .card.matched .card-inner {\n        transform: rotateY(180deg);\n    }\n    \n    .card-front, .card-back {\n        position: absolute;\n        width: 100%;\n        height: 100%;\n        -webkit-backface-visibility: hidden;\n        backface-visibility: hidden;\n        border-radius: 15px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 3rem;\n        font-weight: bold;\n        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);\n    }\n    \n    .card-front {\n        background: linear-gradient(135deg, var(--game-primary), var(--game-secondary));\n        color: white;\n    }\n    \n    .card-back {\n        background: white;\n        color: #1a202c;\n        transform: rotateY(180deg);\n        border: 3px solid #f0f0f0;\n    }\n    \n    .card.matched .card-back {\n        background: var(--game-success);\n        color: white;\n        animation: bounce 0.5s ease;\n    }\n    \n    @keyframes bounce {\n        0%, 100% { transform: rotateY(180deg) scale(1); }\n        50% { transform: rotateY(180deg) scale(1.1); }\n    }\n    \n    .win-screen {\n        text-align: center;\n        animation: fadeIn 0.5s ease;\n    }\n    \n    @keyframes fadeIn {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n    }\n    \n    .btn {\n        padding: 15px 30px;\n        border: none;\n        border-radius: 12px;\n        font-size: 1.1rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        margin: 10px auto;\n        display: block;\n    }\n    \n    .btn-primary {\n        background: linear-gradient(135deg, var(--game-primary), var(--game-secondary));\n        color: white;\n        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);\n    }\n    \n    .btn-primary:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);\n    }\n    \n    .btn-secondary {\n        background: #f3f4f6;\n        color: #4b5563;\n    }\n    \n    .btn-secondary:hover {\n        background: #e5e7eb;\n    }\n    \n    footer {\n        text-align: center;\n        color: #64748b;\n        font-size: 0.9rem;\n        margin-top: 20px;\n    }\n    \n    footer a {\n        color: var(--game-primary);\n        text-decoration: none;\n        font-weight: 600;\n    }\n    \n    footer a:hover {\n        text-decoration: underline;\n    }\n    \n    @media (max-width: 600px) {\n        h1 {\n            font-size: 2rem;\n        }\n        \n        .game-container {\n            padding: 30px 20px;\n        }\n        \n        .game-board {\n            gap: 10px;\n        }\n        \n        .card-front, .card-back {\n            font-size: 2rem;\n        }\n    }\n\"#;\n\n#[wasm_bindgen(start)]\npub fn main() {\n    web_sys::console::log_1(\u0026\"Memory Game starting...\".into());\n    mount(Box::new(MemoryGame), \"root\");\n    web_sys::console::log_1(\u0026\"Memory Game mounted successfully!\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","middleware-test","src","lib.rs"],"content":"use layer9_core::middleware_v2::{Context, Middleware, MiddlewareError, MiddlewareStack, Next, Request, Response, RouteParams};\nuse layer9_core::prelude::*;\nuse std::collections::HashMap;\nuse async_trait::async_trait;\nuse wasm_bindgen::prelude::*;\nuse web_sys::console;\n\n// Test middleware 1: Adds a header\nstruct AddHeaderMiddleware {\n    header_name: String,\n    header_value: String,\n}\n\n#[async_trait(?Send)]\nimpl Middleware for AddHeaderMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context, next: Next) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        console::log_1(\u0026format!(\"Middleware 1: Adding header {} = {}\", self.header_name, self.header_value).into());\n        \n        // Add header to request\n        ctx.request.headers.insert(self.header_name.clone(), self.header_value.clone());\n        \n        // Call next middleware\n        let mut response = next().await?;\n        \n        // Also add to response\n        response.headers.insert(self.header_name.clone(), self.header_value.clone());\n        console::log_1(\u0026format!(\"Middleware 1: Response status = {}\", response.status).into());\n        \n        Ok(response)\n    }\n}\n\n// Test middleware 2: Modifies the response body\nstruct ModifyBodyMiddleware {\n    prefix: String,\n}\n\n#[async_trait(?Send)]\nimpl Middleware for ModifyBodyMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context, next: Next) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        console::log_1(\u0026format!(\"Middleware 2: Processing with prefix '{}'\", self.prefix).into());\n        \n        // Call next middleware\n        let mut response = next().await?;\n        \n        // Modify the body\n        if let Some(body) = response.body {\n            response.body = Some(format!(\"{}: {}\", self.prefix, body));\n            console::log_1(\u0026format!(\"Middleware 2: Modified body to '{}'\", response.body.as_ref().unwrap()).into());\n        }\n        \n        Ok(response)\n    }\n}\n\n// Test middleware 3: Sets the final response\nstruct FinalResponseMiddleware {\n    message: String,\n}\n\n#[async_trait(?Send)]\nimpl Middleware for FinalResponseMiddleware {\n    async fn handle(\u0026self, ctx: \u0026mut Context, next: Next) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        console::log_1(\u0026format!(\"Middleware 3: Setting final response to '{}'\", self.message).into());\n        \n        // Set a response in context\n        ctx.response = Response::new()\n            .with_status(200)\n            .with_body(self.message.clone());\n        \n        // Call next (which should just return the response)\n        next().await\n    }\n}\n\n// Test middleware 4: Error middleware\nstruct ErrorMiddleware;\n\n#[async_trait(?Send)]\nimpl Middleware for ErrorMiddleware {\n    async fn handle(\u0026self, _ctx: \u0026mut Context, _next: Next) -\u003e Result\u003cResponse, MiddlewareError\u003e {\n        console::log_1(\u0026\"Middleware 4: Throwing error\".into());\n        Err(MiddlewareError {\n            status: 500,\n            message: \"Test error from middleware\".to_string(),\n        })\n    }\n}\n\n#[wasm_bindgen(start)]\npub async fn main() {\n    console::log_1(\u0026\"Starting middleware chain test...\".into());\n    \n    // Test 1: Basic middleware chaining\n    console::log_1(\u0026\"\\n=== Test 1: Basic Middleware Chaining ===\".into());\n    {\n        let stack = MiddlewareStack::new()\n            .use_middleware(AddHeaderMiddleware {\n                header_name: \"X-Test-Header\".to_string(),\n                header_value: \"test-value\".to_string(),\n            })\n            .use_middleware(ModifyBodyMiddleware {\n                prefix: \"Modified\".to_string(),\n            })\n            .use_middleware(FinalResponseMiddleware {\n                message: \"Hello from final middleware\".to_string(),\n            });\n        \n        let ctx = Context {\n            request: Request {\n                method: Method::GET,\n                url: \"/test\".to_string(),\n                headers: HashMap::new(),\n                body: None,\n                user: None,\n            },\n            response: Response::new(),\n            state: HashMap::new(),\n            params: RouteParams {\n                params: HashMap::new(),\n                query: HashMap::new(),\n            },\n        };\n        \n        match stack.run(ctx).await {\n            Ok(response) =\u003e {\n                console::log_1(\u0026format!(\"Success! Status: {}, Body: {:?}\", response.status, response.body).into());\n                console::log_1(\u0026format!(\"Headers: {:?}\", response.headers).into());\n                \n                // Verify the chain worked correctly\n                assert_eq!(response.status, 200);\n                assert_eq!(response.body, Some(\"Modified: Hello from final middleware\".to_string()));\n                assert!(response.headers.contains_key(\"X-Test-Header\"));\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"Error: {} (status: {})\", e.message, e.status).into());\n            }\n        }\n    }\n    \n    // Test 2: Error handling\n    console::log_1(\u0026\"\\n=== Test 2: Error Handling ===\".into());\n    {\n        let stack = MiddlewareStack::new()\n            .use_middleware(AddHeaderMiddleware {\n                header_name: \"X-Test-Header\".to_string(),\n                header_value: \"test-value\".to_string(),\n            })\n            .use_middleware(ErrorMiddleware)\n            .use_middleware(ModifyBodyMiddleware {\n                prefix: \"Should not reach here\".to_string(),\n            });\n        \n        let ctx = Context {\n            request: Request {\n                method: Method::GET,\n                url: \"/test\".to_string(),\n                headers: HashMap::new(),\n                body: None,\n                user: None,\n            },\n            response: Response::new(),\n            state: HashMap::new(),\n            params: RouteParams {\n                params: HashMap::new(),\n                query: HashMap::new(),\n            },\n        };\n        \n        match stack.run(ctx).await {\n            Ok(_) =\u003e {\n                console::log_1(\u0026\"Unexpected success!\".into());\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"Expected error: {} (status: {})\", e.message, e.status).into());\n                assert_eq!(e.status, 500);\n                assert_eq!(e.message, \"Test error from middleware\");\n            }\n        }\n    }\n    \n    // Test 3: Empty middleware stack\n    console::log_1(\u0026\"\\n=== Test 3: Empty Middleware Stack ===\".into());\n    {\n        let stack = MiddlewareStack::new();\n        \n        let ctx = Context {\n            request: Request {\n                method: Method::GET,\n                url: \"/test\".to_string(),\n                headers: HashMap::new(),\n                body: None,\n                user: None,\n            },\n            response: Response::new().with_status(204).with_body(\"Default response\"),\n            state: HashMap::new(),\n            params: RouteParams {\n                params: HashMap::new(),\n                query: HashMap::new(),\n            },\n        };\n        \n        match stack.run(ctx).await {\n            Ok(response) =\u003e {\n                console::log_1(\u0026format!(\"Success! Status: {}, Body: {:?}\", response.status, response.body).into());\n                // Should return the default response from context\n                assert_eq!(response.status, 204);\n                assert_eq!(response.body, Some(\"Default response\".to_string()));\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"Error: {} (status: {})\", e.message, e.status).into());\n            }\n        }\n    }\n    \n    // Test 4: Test middleware order\n    console::log_1(\u0026\"\\n=== Test 4: Middleware Order Test ===\".into());\n    {\n        let stack = MiddlewareStack::new()\n            .use_middleware(AddHeaderMiddleware {\n                header_name: \"X-First\".to_string(),\n                header_value: \"1\".to_string(),\n            })\n            .use_middleware(AddHeaderMiddleware {\n                header_name: \"X-Second\".to_string(),\n                header_value: \"2\".to_string(),\n            })\n            .use_middleware(AddHeaderMiddleware {\n                header_name: \"X-Third\".to_string(),\n                header_value: \"3\".to_string(),\n            });\n        \n        let ctx = Context {\n            request: Request {\n                method: Method::GET,\n                url: \"/test\".to_string(),\n                headers: HashMap::new(),\n                body: None,\n                user: None,\n            },\n            response: Response::new().with_body(\"Test\"),\n            state: HashMap::new(),\n            params: RouteParams {\n                params: HashMap::new(),\n                query: HashMap::new(),\n            },\n        };\n        \n        match stack.run(ctx).await {\n            Ok(response) =\u003e {\n                console::log_1(\u0026format!(\"Success! Headers: {:?}\", response.headers).into());\n                // All headers should be added\n                assert_eq!(response.headers.get(\"X-First\"), Some(\u0026\"1\".to_string()));\n                assert_eq!(response.headers.get(\"X-Second\"), Some(\u0026\"2\".to_string()));\n                assert_eq!(response.headers.get(\"X-Third\"), Some(\u0026\"3\".to_string()));\n            }\n            Err(e) =\u003e {\n                console::log_1(\u0026format!(\"Error: {} (status: {})\", e.message, e.status).into());\n            }\n        }\n    }\n    \n    console::log_1(\u0026\"\\nAll tests completed!\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","ssr-demo","src","lib.rs"],"content":"//! SSR Demo Application\n\nuse layer9_core::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse std::sync::Arc;\n\n#[cfg(not(target_arch = \"wasm32\"))]\nuse async_trait::async_trait;\n\n/// Todo model\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Todo {\n    pub id: u32,\n    pub text: String,\n    pub done: bool,\n}\n\n/// Home page component\npub struct HomePage;\n\nimpl HomePage {\n    pub fn new() -\u003e Self {\n        HomePage\n    }\n}\n\nimpl Default for HomePage {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRComponent for HomePage {\n    fn render_to_string(\u0026self, ctx: \u0026SSRContext) -\u003e String {\n        let todos_html = if let Some(todos_json) = ctx.props.get(\"todos\") {\n            if let Ok(todos) = serde_json::from_str::\u003cVec\u003cTodo\u003e\u003e(todos_json) {\n                todos.iter()\n                    .map(|todo| {\n                        format!(\n                            r#\"\u003cli class=\"todo-item\"\u003e\n                                \u003cinput type=\"checkbox\" {} /\u003e\n                                \u003cspan class=\"{}\"\u003e{}\u003c/span\u003e\n                            \u003c/li\u003e\"#,\n                            if todo.done { \"checked\" } else { \"\" },\n                            if todo.done { \"done\" } else { \"\" },\n                            todo.text\n                        )\n                    })\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\"\\n\")\n            } else {\n                \"\u003cli\u003eFailed to load todos\u003c/li\u003e\".to_string()\n            }\n        } else {\n            \"\u003cli\u003eLoading todos...\u003c/li\u003e\".to_string()\n        };\n\n        format!(\n            r#\"\n            \u003cdiv class=\"container\"\u003e\n                \u003cheader\u003e\n                    \u003ch1\u003eLayer9 SSR Demo\u003c/h1\u003e\n                    \u003cnav\u003e\n                        \u003ca href=\"/\"\u003eHome\u003c/a\u003e\n                        \u003ca href=\"/todos\"\u003eTodos\u003c/a\u003e\n                        \u003ca href=\"/about\"\u003eAbout\u003c/a\u003e\n                    \u003c/nav\u003e\n                \u003c/header\u003e\n                \n                \u003cmain\u003e\n                    \u003csection class=\"hero\"\u003e\n                        \u003ch2\u003eWelcome to Layer9 SSR\u003c/h2\u003e\n                        \u003cp\u003eThis demo shows server-side rendering with hydration.\u003c/p\u003e\n                    \u003c/section\u003e\n                    \n                    \u003csection class=\"todos\"\u003e\n                        \u003ch3\u003eRecent Todos\u003c/h3\u003e\n                        \u003cul class=\"todo-list\"\u003e\n                            {}\n                        \u003c/ul\u003e\n                    \u003c/section\u003e\n                \u003c/main\u003e\n                \n                \u003cfooter\u003e\n                    \u003cp\u003eBuilt with Layer9 - Web Architecture Rust Platform\u003c/p\u003e\n                \u003c/footer\u003e\n                \n                \u003cstyle\u003e\n                    body {{\n                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                        margin: 0;\n                        padding: 0;\n                        background: #f5f5f5;\n                    }}\n                    .container {{\n                        max-width: 1200px;\n                        margin: 0 auto;\n                        padding: 20px;\n                    }}\n                    header {{\n                        background: #333;\n                        color: white;\n                        padding: 20px;\n                        margin: -20px -20px 20px;\n                    }}\n                    nav a {{\n                        color: white;\n                        text-decoration: none;\n                        margin-right: 20px;\n                    }}\n                    .hero {{\n                        background: white;\n                        padding: 40px;\n                        text-align: center;\n                        border-radius: 8px;\n                        margin-bottom: 20px;\n                    }}\n                    .todos {{\n                        background: white;\n                        padding: 20px;\n                        border-radius: 8px;\n                    }}\n                    .todo-list {{\n                        list-style: none;\n                        padding: 0;\n                    }}\n                    .todo-item {{\n                        padding: 10px;\n                        border-bottom: 1px solid #eee;\n                    }}\n                    .done {{\n                        text-decoration: line-through;\n                        opacity: 0.6;\n                    }}\n                    footer {{\n                        text-align: center;\n                        margin-top: 40px;\n                        color: #666;\n                    }}\n                \u003c/style\u003e\n            \u003c/div\u003e\n            \"#,\n            todos_html\n        )\n    }\n\n    async fn get_server_props(\u0026self, _ctx: \u0026SSRContext) -\u003e Result\u003cserde_json::Value, String\u003e {\n        // In a real app, this would fetch from database\n        let todos = vec![\n            Todo { id: 1, text: \"Build SSR support\".to_string(), done: true },\n            Todo { id: 2, text: \"Add hydration\".to_string(), done: true },\n            Todo { id: 3, text: \"Test with real data\".to_string(), done: false },\n            Todo { id: 4, text: \"Deploy to production\".to_string(), done: false },\n        ];\n\n        Ok(serde_json::json!({\n            \"todos\": todos,\n            \"timestamp\": chrono::Utc::now().to_rfc3339(),\n        }))\n    }\n}\n\n/// Todos page component\npub struct TodosPage;\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRComponent for TodosPage {\n    fn render_to_string(\u0026self, _ctx: \u0026SSRContext) -\u003e String {\n        r#\"\n        \u003cdiv class=\"container\"\u003e\n            \u003cheader\u003e\n                \u003ch1\u003eLayer9 SSR Demo\u003c/h1\u003e\n                \u003cnav\u003e\n                    \u003ca href=\"/\"\u003eHome\u003c/a\u003e\n                    \u003ca href=\"/todos\"\u003eTodos\u003c/a\u003e\n                    \u003ca href=\"/about\"\u003eAbout\u003c/a\u003e\n                \u003c/nav\u003e\n            \u003c/header\u003e\n            \n            \u003cmain\u003e\n                \u003ch2\u003eTodo List\u003c/h2\u003e\n                \u003cdiv class=\"todo-app\"\u003e\n                    \u003cinput type=\"text\" placeholder=\"What needs to be done?\" /\u003e\n                    \u003cbutton\u003eAdd Todo\u003c/button\u003e\n                    \u003cul class=\"todo-list\" id=\"todos\"\u003e\u003c/ul\u003e\n                \u003c/div\u003e\n            \u003c/main\u003e\n        \u003c/div\u003e\n        \"#.to_string()\n    }\n}\n\n/// About page component\npub struct AboutPage;\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRComponent for AboutPage {\n    fn render_to_string(\u0026self, _ctx: \u0026SSRContext) -\u003e String {\n        r#\"\n        \u003cdiv class=\"container\"\u003e\n            \u003cheader\u003e\n                \u003ch1\u003eLayer9 SSR Demo\u003c/h1\u003e\n                \u003cnav\u003e\n                    \u003ca href=\"/\"\u003eHome\u003c/a\u003e\n                    \u003ca href=\"/todos\"\u003eTodos\u003c/a\u003e\n                    \u003ca href=\"/about\"\u003eAbout\u003c/a\u003e\n                \u003c/nav\u003e\n            \u003c/header\u003e\n            \n            \u003cmain\u003e\n                \u003ch2\u003eAbout Layer9 SSR\u003c/h2\u003e\n                \u003cp\u003eThis demo showcases Layer9's server-side rendering capabilities:\u003c/p\u003e\n                \u003cul\u003e\n                    \u003cli\u003eServer-side data fetching\u003c/li\u003e\n                    \u003cli\u003eHTML generation on the server\u003c/li\u003e\n                    \u003cli\u003eClient-side hydration\u003c/li\u003e\n                    \u003cli\u003eSEO-friendly pages\u003c/li\u003e\n                    \u003cli\u003eFast initial page loads\u003c/li\u003e\n                \u003c/ul\u003e\n            \u003c/main\u003e\n        \u003c/div\u003e\n        \"#.to_string()\n    }\n}\n\n/// SSR App implementation\npub struct SSRDemoApp;\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRApp for SSRDemoApp {\n    fn routes(\u0026self) -\u003e Vec\u003cSSRRoute\u003e {\n        vec![\n            SSRRoute {\n                path: \"/\".to_string(),\n                handler: Arc::new(HomeHandler),\n            },\n            SSRRoute {\n                path: \"/todos\".to_string(),\n                handler: Arc::new(TodosHandler),\n            },\n            SSRRoute {\n                path: \"/about\".to_string(),\n                handler: Arc::new(AboutHandler),\n            },\n        ]\n    }\n}\n\n/// Route handlers\nstruct HomeHandler;\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRRouteHandler for HomeHandler {\n    async fn handle(\u0026self, mut ctx: SSRContext) -\u003e Result\u003cString, String\u003e {\n        let home = HomePage::new();\n        \n        // Get server props\n        let props = home.get_server_props(\u0026ctx).await?;\n        \n        // Add todos to context\n        if let Some(todos) = props.get(\"todos\") {\n            ctx.props.insert(\"todos\".to_string(), todos.to_string());\n        }\n        \n        // Set initial state\n        ctx.initial_state = Some(props.to_string());\n        \n        // Add meta tags\n        ctx = ctx.add_meta_tag(r#\"\u003cmeta name=\"description\" content=\"Layer9 SSR Demo Application\"\u003e\"#.to_string());\n        \n        // Create renderer and render\n        let mut renderer = SSRRenderer::new();\n        renderer.add_component(Box::new(home));\n        \n        Ok(renderer.render(\u0026ctx).await)\n    }\n}\n\nstruct TodosHandler;\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRRouteHandler for TodosHandler {\n    async fn handle(\u0026self, ctx: SSRContext) -\u003e Result\u003cString, String\u003e {\n        let mut renderer = SSRRenderer::new();\n        renderer.add_component(Box::new(TodosPage));\n        Ok(renderer.render(\u0026ctx).await)\n    }\n}\n\nstruct AboutHandler;\n\n#[cfg(not(target_arch = \"wasm32\"))]\n#[async_trait]\nimpl SSRRouteHandler for AboutHandler {\n    async fn handle(\u0026self, ctx: SSRContext) -\u003e Result\u003cString, String\u003e {\n        let mut renderer = SSRRenderer::new();\n        renderer.add_component(Box::new(AboutPage));\n        Ok(renderer.render(\u0026ctx).await)\n    }\n}\n\n// Client-side entry point\n#[cfg(target_arch = \"wasm32\")]\nuse wasm_bindgen::prelude::*;\n\n#[cfg(target_arch = \"wasm32\")]\n#[wasm_bindgen(start)]\npub fn main() {\n    console_error_panic_hook::set_once();\n    \n    // Check if we're hydrating\n    if let Some(window) = web_sys::window() {\n        if js_sys::Reflect::has(\u0026window, \u0026\"__SSR_CONTEXT__\".into()).unwrap_or(false) {\n            hydrate_app();\n        }\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","ssr-demo","src","main.rs"],"content":"//! SSR Demo Server\n\nuse layer9_core::prelude::*;\nuse ssr_demo::SSRDemoApp;\nuse std::sync::Arc;\n\n#[tokio::main]\nasync fn main() {\n    // Initialize database if needed\n    #[cfg(feature = \"ssr\")]\n    {\n        if let Ok(db_url) = std::env::var(\"DATABASE_URL\") {\n            if let Err(e) = layer9_core::db_sqlx::init_db_pool(\u0026db_url).await {\n                eprintln!(\"Warning: Failed to initialize database: {:?}\", e);\n            }\n        }\n    }\n\n    // Create the SSR app\n    let app = Arc::new(SSRDemoApp);\n    \n    // Create the server\n    let router = create_ssr_server(app);\n    \n    // Run the server\n    let addr = \"0.0.0.0:3000\";\n    println!(\"SSR server running at http://{}\", addr);\n    \n    let listener = tokio::net::TcpListener::bind(addr)\n        .await\n        .expect(\"Failed to bind\");\n        \n    axum::serve(listener, router)\n        .await\n        .expect(\"Failed to start server\");\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","examples","todo-app","src","lib.rs"],"content":"use layer9_framework::prelude::*;\nuse layer9_framework::hooks::use_state;\nuse layer9_framework::reactive_v2::mount;\nuse serde::{Deserialize, Serialize};\nuse std::rc::Rc;\nuse uuid::Uuid;\nuse wasm_bindgen::prelude::*;\n\n// When the `wee_alloc` feature is enabled, use `wee_alloc` as the global allocator.\n#[global_allocator]\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\nstruct Todo {\n    id: String,\n    text: String,\n    completed: bool,\n    created_at: String,\n}\n\nimpl Todo {\n    fn new(text: String) -\u003e Self {\n        Todo {\n            id: Uuid::new_v4().to_string(),\n            text,\n            completed: false,\n            created_at: {\n                // Use JavaScript Date for WASM compatibility\n                let date = js_sys::Date::new_0();\n                format!(\"{}-{:02}-{:02} {:02}:{:02}\",\n                    date.get_full_year(),\n                    date.get_month() + 1,\n                    date.get_date(),\n                    date.get_hours(),\n                    date.get_minutes()\n                )\n            },\n        }\n    }\n}\n\n#[derive(Clone, Debug, PartialEq)]\nenum Filter {\n    All,\n    Active,\n    Completed,\n}\n\nstruct TodoApp;\n\nimpl Component for TodoApp {\n    fn render(\u0026self) -\u003e Element {\n        let (todos, set_todos) = use_state(Vec::\u003cTodo\u003e::new());\n        let (filter, set_filter) = use_state(Filter::All);\n\n        // Calculate stats\n        let active_count = todos.iter().filter(|t| !t.completed).count();\n        let completed_count = todos.iter().filter(|t| t.completed).count();\n\n        // Filter todos\n        let filtered_todos: Vec\u003cTodo\u003e = todos\n            .iter()\n            .filter(|todo| match \u0026filter {\n                Filter::All =\u003e true,\n                Filter::Active =\u003e !todo.completed,\n                Filter::Completed =\u003e todo.completed,\n            })\n            .cloned()\n            .collect();\n\n        // Helper function to add todo from input\n        let add_todo_handler = {\n            let todos = todos.clone();\n            let set_todos = set_todos.clone();\n            Rc::new(move || {\n                let window = web_sys::window().unwrap();\n                let document = window.document().unwrap();\n                if let Some(input) = document.get_element_by_id(\"todo-input\") {\n                    if let Ok(input) = input.dyn_into::\u003cweb_sys::HtmlInputElement\u003e() {\n                        let text = input.value();\n                        if !text.trim().is_empty() {\n                            let mut new_todos = todos.clone();\n                            new_todos.push(Todo::new(text.trim().to_string()));\n                            set_todos(new_todos);\n                            input.set_value(\"\");\n                        }\n                    }\n                }\n            })\n        };\n\n        // Build UI elements\n        let style_element = Element::Node {\n            tag: \"style\".to_string(),\n            props: Props::default(),\n            children: vec![Element::Text(STYLES.to_string())],\n        };\n\n        let header = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"header\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"h1\".to_string(),\n                    props: Props::default(),\n                    children: vec![Element::Text(\"Layer9 Todo\".to_string())],\n                },\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props {\n                        class: Some(\"subtitle\".to_string()),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"A beautiful todo app built with Rust and WASM\".to_string())],\n                },\n            ],\n        };\n\n        let input_section = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"input-section\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"input\".to_string(),\n                    props: Props {\n                        class: Some(\"todo-input\".to_string()),\n                        id: Some(\"todo-input\".to_string()),\n                        attributes: vec![\n                            (\"type\".to_string(), \"text\".to_string()),\n                            (\"placeholder\".to_string(), \"What needs to be done?\".to_string()),\n                        ],\n                        ..Default::default()\n                    },\n                    children: vec![],\n                },\n                Element::Node {\n                    tag: \"button\".to_string(),\n                    props: Props {\n                        class: Some(\"add-btn\".to_string()),\n                        on_click: Some(add_todo_handler),\n                        ..Default::default()\n                    },\n                    children: vec![Element::Text(\"Add\".to_string())],\n                },\n            ],\n        };\n\n        let todos_container = if filtered_todos.is_empty() \u0026\u0026 todos.is_empty() {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"todos-container\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"empty-state\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            Element::Node {\n                                tag: \"p\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(\"No todos yet!\".to_string())],\n                            },\n                            Element::Node {\n                                tag: \"p\".to_string(),\n                                props: Props {\n                                    class: Some(\"hint\".to_string()),\n                                    ..Default::default()\n                                },\n                                children: vec![Element::Text(\"Add one above to get started\".to_string())],\n                            },\n                        ],\n                    },\n                ],\n            }\n        } else if filtered_todos.is_empty() {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"todos-container\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"empty-state\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            Element::Node {\n                                tag: \"p\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(format!(\"No {} todos\", filter_text(\u0026filter)))],\n                            },\n                        ],\n                    },\n                ],\n            }\n        } else {\n            let todo_items: Vec\u003cElement\u003e = filtered_todos.iter().map(|todo| {\n                let todo_id = todo.id.clone();\n                let is_completed = todo.completed;\n                \n                let set_todos_clone = set_todos.clone();\n                let todos_clone = todos.clone();\n                let todo_id_toggle = todo_id.clone();\n                let todo_id_delete = todo_id.clone();\n                \n                // Clone for the second closure\n                let set_todos_clone_delete = set_todos.clone();\n                let todos_clone_delete = todos.clone();\n                \n                Element::Node {\n                    tag: \"li\".to_string(),\n                    props: Props {\n                        class: Some(if is_completed { \"todo-item completed\".to_string() } else { \"todo-item\".to_string() }),\n                        ..Default::default()\n                    },\n                    children: vec![\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"todo-content\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![\n                                Element::Node {\n                                    tag: \"input\".to_string(),\n                                    props: Props {\n                                        class: Some(\"todo-checkbox\".to_string()),\n                                        attributes: vec![\n                                            (\"type\".to_string(), \"checkbox\".to_string()),\n                                            if is_completed { (\"checked\".to_string(), \"checked\".to_string()) } else { (\"\".to_string(), \"\".to_string()) },\n                                        ].into_iter().filter(|(k, _)| !k.is_empty()).collect(),\n                                        on_click: Some(Rc::new(move || {\n                                            let mut new_todos = todos_clone.clone();\n                                            if let Some(todo) = new_todos.iter_mut().find(|t| t.id == todo_id_toggle) {\n                                                todo.completed = !todo.completed;\n                                            }\n                                            set_todos_clone(new_todos);\n                                        })),\n                                        ..Default::default()\n                                    },\n                                    children: vec![],\n                                },\n                                Element::Node {\n                                    tag: \"span\".to_string(),\n                                    props: Props {\n                                        class: Some(\"todo-text\".to_string()),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(todo.text.clone())],\n                                },\n                                Element::Node {\n                                    tag: \"button\".to_string(),\n                                    props: Props {\n                                        class: Some(\"delete-btn\".to_string()),\n                                        on_click: Some(Rc::new(move || {\n                                            let new_todos = todos_clone_delete.iter()\n                                                .filter(|t| t.id != todo_id_delete)\n                                                .cloned()\n                                                .collect();\n                                            set_todos_clone_delete(new_todos);\n                                        })),\n                                        ..Default::default()\n                                    },\n                                    children: vec![Element::Text(\"×\".to_string())],\n                                },\n                            ],\n                        },\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props {\n                                class: Some(\"todo-meta\".to_string()),\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(todo.created_at.clone())],\n                        },\n                    ],\n                }\n            }).collect();\n\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"todos-container\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    Element::Node {\n                        tag: \"ul\".to_string(),\n                        props: Props {\n                            class: Some(\"todo-list\".to_string()),\n                            ..Default::default()\n                        },\n                        children: todo_items,\n                    },\n                ],\n            }\n        };\n\n        let footer = if !todos.is_empty() {\n            let set_filter_clone = set_filter.clone();\n            let set_todos_clone = set_todos.clone();\n            let todos_clone = todos.clone();\n            \n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props {\n                    class: Some(\"footer\".to_string()),\n                    ..Default::default()\n                },\n                children: vec![\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"stats\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            Element::Node {\n                                tag: \"span\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(format!(\"{} active\", active_count))],\n                            },\n                            Element::Node {\n                                tag: \"span\".to_string(),\n                                props: Props {\n                                    class: Some(\"dot\".to_string()),\n                                    ..Default::default()\n                                },\n                                children: vec![Element::Text(\"•\".to_string())],\n                            },\n                            Element::Node {\n                                tag: \"span\".to_string(),\n                                props: Props::default(),\n                                children: vec![Element::Text(format!(\"{} completed\", completed_count))],\n                            },\n                        ],\n                    },\n                    Element::Node {\n                        tag: \"div\".to_string(),\n                        props: Props {\n                            class: Some(\"filters\".to_string()),\n                            ..Default::default()\n                        },\n                        children: vec![\n                            create_filter_button(\u0026filter, \u0026set_filter_clone, Filter::All),\n                            create_filter_button(\u0026filter, \u0026set_filter_clone, Filter::Active),\n                            create_filter_button(\u0026filter, \u0026set_filter_clone, Filter::Completed),\n                        ],\n                    },\n                    if completed_count \u003e 0 {\n                        Element::Node {\n                            tag: \"button\".to_string(),\n                            props: Props {\n                                class: Some(\"clear-btn\".to_string()),\n                                on_click: Some(Rc::new(move || {\n                                    let new_todos = todos_clone.iter()\n                                        .filter(|t| !t.completed)\n                                        .cloned()\n                                        .collect();\n                                    set_todos_clone(new_todos);\n                                })),\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(\"Clear completed\".to_string())],\n                        }\n                    } else {\n                        Element::Node {\n                            tag: \"div\".to_string(),\n                            props: Props::default(),\n                            children: vec![],\n                        }\n                    },\n                ],\n            }\n        } else {\n            Element::Node {\n                tag: \"div\".to_string(),\n                props: Props::default(),\n                children: vec![],\n            }\n        };\n\n        let info = Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"info\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                Element::Node {\n                    tag: \"p\".to_string(),\n                    props: Props::default(),\n                    children: vec![\n                        Element::Text(\"Built with \".to_string()),\n                        Element::Node {\n                            tag: \"a\".to_string(),\n                            props: Props {\n                                attributes: vec![\n                                    (\"href\".to_string(), \"https://github.com/anthropics/layer9\".to_string()),\n                                    (\"target\".to_string(), \"_blank\".to_string()),\n                                ],\n                                ..Default::default()\n                            },\n                            children: vec![Element::Text(\"Layer9\".to_string())],\n                        },\n                        Element::Text(\" - A Reactive Rust Web Framework\".to_string()),\n                    ],\n                },\n            ],\n        };\n\n        // Main app container\n        Element::Node {\n            tag: \"div\".to_string(),\n            props: Props {\n                class: Some(\"todo-app\".to_string()),\n                ..Default::default()\n            },\n            children: vec![\n                style_element,\n                header,\n                input_section,\n                todos_container,\n                footer,\n                info,\n            ],\n        }\n    }\n}\n\nfn create_filter_button(current_filter: \u0026Filter, set_filter: \u0026(impl Fn(Filter) + Clone + 'static), target_filter: Filter) -\u003e Element {\n    let is_active = current_filter == \u0026target_filter;\n    let set_filter_clone = set_filter.clone();\n    let target_filter_clone = target_filter.clone();\n    \n    Element::Node {\n        tag: \"button\".to_string(),\n        props: Props {\n            class: Some(if is_active { \"filter-btn active\".to_string() } else { \"filter-btn\".to_string() }),\n            on_click: Some(Rc::new(move || {\n                set_filter_clone(target_filter_clone.clone());\n            })),\n            ..Default::default()\n        },\n        children: vec![Element::Text(filter_text(\u0026target_filter).to_string())],\n    }\n}\n\nfn filter_text(filter: \u0026Filter) -\u003e \u0026str {\n    match filter {\n        Filter::All =\u003e \"all\",\n        Filter::Active =\u003e \"active\",\n        Filter::Completed =\u003e \"completed\",\n    }\n}\n\nconst STYLES: \u0026str = r#\"\n    :root {\n        --primary: #6366f1;\n        --primary-dark: #4f46e5;\n        --danger: #ef4444;\n        --success: #10b981;\n        --gray-50: #fafafa;\n        --gray-100: #f3f4f6;\n        --gray-200: #e5e7eb;\n        --gray-300: #d1d5db;\n        --gray-400: #9ca3af;\n        --gray-500: #6b7280;\n        --gray-600: #4b5563;\n        --gray-700: #374151;\n        --gray-800: #1f2937;\n        --gray-900: #111827;\n    }\n    \n    * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n    }\n    \n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        min-height: 100vh;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 20px;\n    }\n    \n    .todo-app {\n        background: white;\n        border-radius: 20px;\n        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);\n        width: 100%;\n        max-width: 600px;\n        overflow: hidden;\n    }\n    \n    .header {\n        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n        color: white;\n        padding: 30px;\n        text-align: center;\n    }\n    \n    .header h1 {\n        font-size: 2.5rem;\n        font-weight: 700;\n        margin-bottom: 8px;\n    }\n    \n    .subtitle {\n        opacity: 0.9;\n        font-size: 1rem;\n    }\n    \n    .input-section {\n        display: flex;\n        padding: 20px;\n        background: var(--gray-100);\n        border-bottom: 1px solid var(--gray-200);\n        gap: 10px;\n    }\n    \n    .todo-input {\n        flex: 1;\n        padding: 15px;\n        font-size: 1.1rem;\n        border: 2px solid transparent;\n        border-radius: 10px;\n        outline: none;\n        transition: border-color 0.3s;\n    }\n    \n    .todo-input:focus {\n        border-color: var(--primary);\n    }\n    \n    .add-btn {\n        padding: 15px 25px;\n        background: var(--primary);\n        color: white;\n        border: none;\n        border-radius: 10px;\n        font-size: 1rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: background-color 0.3s;\n    }\n    \n    .add-btn:hover {\n        background: var(--primary-dark);\n    }\n    \n    .todos-container {\n        min-height: 200px;\n        max-height: 400px;\n        overflow-y: auto;\n    }\n    \n    .empty-state {\n        padding: 60px 20px;\n        text-align: center;\n        color: var(--gray-400);\n    }\n    \n    .empty-state p {\n        font-size: 1.2rem;\n        margin-bottom: 8px;\n    }\n    \n    .hint {\n        font-size: 0.9rem;\n        opacity: 0.8;\n    }\n    \n    .todo-list {\n        list-style: none;\n    }\n    \n    .todo-item {\n        border-bottom: 1px solid var(--gray-100);\n        transition: background-color 0.3s;\n    }\n    \n    .todo-item:hover {\n        background-color: var(--gray-50);\n    }\n    \n    .todo-content {\n        display: flex;\n        align-items: center;\n        padding: 15px 20px;\n    }\n    \n    .todo-checkbox {\n        width: 20px;\n        height: 20px;\n        margin-right: 15px;\n        cursor: pointer;\n        accent-color: var(--primary);\n    }\n    \n    .todo-text {\n        flex: 1;\n        font-size: 1.1rem;\n        color: var(--gray-800);\n        word-break: break-word;\n    }\n    \n    .todo-item.completed .todo-text {\n        text-decoration: line-through;\n        color: var(--gray-400);\n    }\n    \n    .delete-btn {\n        background: none;\n        border: none;\n        font-size: 1.5rem;\n        color: var(--gray-400);\n        cursor: pointer;\n        padding: 0 10px;\n        opacity: 0;\n        transition: opacity 0.3s, color 0.3s;\n    }\n    \n    .todo-item:hover .delete-btn {\n        opacity: 1;\n    }\n    \n    .delete-btn:hover {\n        color: var(--danger);\n    }\n    \n    .todo-meta {\n        padding: 0 20px 10px 50px;\n        font-size: 0.8rem;\n        color: var(--gray-400);\n    }\n    \n    .footer {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 20px;\n        background: var(--gray-100);\n        border-top: 1px solid var(--gray-200);\n        flex-wrap: wrap;\n        gap: 10px;\n    }\n    \n    .stats {\n        color: var(--gray-600);\n        font-size: 0.9rem;\n    }\n    \n    .dot {\n        margin: 0 8px;\n        opacity: 0.5;\n    }\n    \n    .filters {\n        display: flex;\n        gap: 5px;\n    }\n    \n    .filter-btn {\n        background: none;\n        border: 2px solid transparent;\n        padding: 5px 12px;\n        border-radius: 5px;\n        cursor: pointer;\n        font-size: 0.9rem;\n        color: var(--gray-600);\n        transition: all 0.3s;\n    }\n    \n    .filter-btn:hover {\n        border-color: var(--gray-300);\n    }\n    \n    .filter-btn.active {\n        border-color: var(--primary);\n        color: var(--primary);\n    }\n    \n    .clear-btn {\n        background: none;\n        border: none;\n        color: var(--danger);\n        cursor: pointer;\n        font-size: 0.9rem;\n        transition: opacity 0.3s;\n    }\n    \n    .clear-btn:hover {\n        opacity: 0.8;\n    }\n    \n    .info {\n        padding: 20px;\n        text-align: center;\n        font-size: 0.8rem;\n        color: var(--gray-400);\n    }\n    \n    .info p {\n        margin: 5px 0;\n    }\n    \n    .info a {\n        color: var(--primary);\n        text-decoration: none;\n    }\n    \n    .info a:hover {\n        text-decoration: underline;\n    }\n    \n    /* Scrollbar styling */\n    .todos-container::-webkit-scrollbar {\n        width: 6px;\n    }\n    \n    .todos-container::-webkit-scrollbar-track {\n        background: var(--gray-100);\n    }\n    \n    .todos-container::-webkit-scrollbar-thumb {\n        background: var(--gray-300);\n        border-radius: 3px;\n    }\n    \n    .todos-container::-webkit-scrollbar-thumb:hover {\n        background: var(--gray-400);\n    }\n\"#;\n\n#[wasm_bindgen(start)]\npub fn main() {\n    web_sys::console::log_1(\u0026\"Layer9 Todo App starting...\".into());\n    mount(Box::new(TodoApp), \"root\");\n    web_sys::console::log_1(\u0026\"Layer9 Todo App mounted successfully!\".into());\n}","traces":[],"covered":0,"coverable":0},{"path":["/","Users","icedac","2lab.ai","layer9","src","lib.rs"],"content":"//! Layer9 Framework - Main entry point\n//!\n//! Re-exports all core functionality\n\npub use layer9_core::*;\npub use layer9_macro::*;\n\npub mod prelude {\n    pub use layer9_core::{\n        app::*, component::*, layers::*, router::*, server::*, state::*, ui::*, vdom::*,\n    };\n\n    pub use layer9_macro::*;\n}\n\n// Re-export commonly used external dependencies\npub use js_sys;\npub use wasm_bindgen;\npub use web_sys;\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>